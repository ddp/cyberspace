#!/usr/bin/env csi -s
;;; metrics - Display code metrics for Cyberspace
;;;
;;; Usage: metrics
;;;
;;; Shows line counts, symbol counts, and TCB ratios.

(import (chicken process)
        (chicken process-context)
        (chicken file)
        (chicken io)
        (chicken format)
        (chicken string)
        srfi-13)

(define *cyberspace-root*
  (or (get-environment-variable "CYBERSPACE_ROOT")
      (current-directory)))

(define (count-lines-symbols path pattern)
  "Count lines and symbols for files matching pattern in path"
  (let ((cmd (sprintf "find ~a/~a -name '~a' -exec cat {} + 2>/dev/null | wc -lw"
                      *cyberspace-root* path pattern)))
    (call-with-input-pipe cmd
      (lambda (port)
        (let ((line (read-line port)))
          (if (eof-object? line)
              (cons 0 0)
              (let ((parts (string-split (string-trim-both line))))
                (if (>= (length parts) 2)
                    (cons (string->number (car parts))
                          (string->number (cadr parts)))
                    (cons 0 0)))))))))

(define (count-assets)
  "Count total assets in cyberspace"
  (let ((cmd (sprintf "find ~a -type f -not -path '*/.git/*' | wc -l"
                      *cyberspace-root*)))
    (call-with-input-pipe cmd
      (lambda (port)
        (let ((line (read-line port)))
          (if (eof-object? line)
              0
              (string->number (string-trim-both line))))))))

(define (display-metrics)
  (let* ((rfc-stats (count-lines-symbols "spki/scheme/docs/rfc" "*.txt"))
         (rfc-lines (car rfc-stats))
         (rfc-words (cdr rfc-stats))
         (ocaml-stats (let ((ml (count-lines-symbols "spki" "*.ml"))
                           (mli (count-lines-symbols "spki" "*.mli")))
                       (cons (+ (car ml) (car mli))
                             (+ (cdr ml) (cdr mli)))))
         (ocaml-lines (car ocaml-stats))
         (ocaml-symbols (cdr ocaml-stats))
         (scheme-stats (count-lines-symbols "spki/scheme" "*.scm"))
         (scheme-lines (car scheme-stats))
         (scheme-symbols (cdr scheme-stats))
         (assets (count-assets))
         (ratio-lines (if (> ocaml-lines 0)
                         (/ (exact->inexact scheme-lines) ocaml-lines)
                         0))
         (ratio-symbols (if (> ocaml-symbols 0)
                           (/ (exact->inexact scheme-symbols) ocaml-symbols)
                           0)))
    (printf "RFCs: ~a lines, ~a words~%" rfc-lines rfc-words)
    (printf "OCaml (TCB): ~a lines, ~a symbols~%" ocaml-lines ocaml-symbols)
    (printf "Scheme: ~a lines, ~a symbols~%" scheme-lines scheme-symbols)
    (printf "TCB is ~ax smaller by lines, ~ax smaller by symbols~%"
            (/ (round (* 10 ratio-lines)) 10)
            (/ (round (* 10 ratio-symbols)) 10))
    (printf "~a assets comprise cyberspace~%" assets)))

(display-metrics)
