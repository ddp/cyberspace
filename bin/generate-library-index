#!/bin/bash
# Generate clickable permuted index for ~/cyberspace/library
# Usage: ~/cyberspace/bin/generate-library-index
#
# Creates a LaTeX-style permuted index with cross-references and no duplicates

set -e

LIBRARY_DIR="$HOME/cyberspace/library"
OUTPUT_FILE="$LIBRARY_DIR/index.html"

cd "$LIBRARY_DIR" || exit 1

echo "Generating library permuted index..."

cat > "$OUTPUT_FILE" <<'HEADER'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library of Cyberspace — Permuted Index</title>

    <!-- Fonts: Source Serif for body, JetBrains Mono for code -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /*
         * Typography System
         * Base: 18px / 1.618 (golden ratio line-height)
         * Scale: 1.25 (major third)
         * Measure: ~66 characters
         */

        :root {
            /* Light theme - warm paper tones */
            --bg: #fffcf7;
            --bg-nav: #f7f3ed;
            --text: #2d2a26;
            --text-secondary: #5c5650;
            --text-tertiary: #8a847c;
            --accent: #1a5f7a;
            --accent-hover: #2980a8;
            --keyword: #9e4a2f;
            --rule: #e5dfd6;
            --letter-bg: #2d2a26;
            --letter-text: #fffcf7;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1a1a18;
                --bg-nav: #252422;
                --text: #e8e4dc;
                --text-secondary: #b5b0a6;
                --text-tertiary: #7a756c;
                --accent: #7cb8cf;
                --accent-hover: #a3d0e4;
                --keyword: #e8a87c;
                --rule: #3d3a36;
                --letter-bg: #e8e4dc;
                --letter-text: #1a1a18;
            }
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            font-size: 18px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Source Serif 4', 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif;
            font-size: 1rem;
            line-height: 1.618;
            color: var(--text);
            background: var(--bg);
            max-width: 38rem; /* ~66ch at 18px */
            margin: 0 auto;
            padding: 3rem 1.5rem 6rem;
        }

        /* Header */
        header {
            margin-bottom: 2.618rem;
            padding-bottom: 1.618rem;
            border-bottom: 1px solid var(--rule);
        }

        h1 {
            font-size: 1.953rem; /* 18 × 1.25³ */
            font-weight: 600;
            line-height: 1.2;
            letter-spacing: -0.02em;
            margin: 0 0 0.25rem 0;
            color: var(--text);
        }

        .subtitle {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--text-secondary);
            margin: 0;
            letter-spacing: 0.01em;
        }

        /* Navigation */
        nav {
            margin: 1.618rem 0;
            padding: 1rem 1.25rem;
            background: var(--bg-nav);
            border-radius: 3px;
        }

        .nav-label {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin: 0 0 0.5rem 0;
        }

        .nav-letters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.125rem;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .nav-letters a {
            display: block;
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.833rem;
            font-weight: 400;
            padding: 0.25rem 0.5rem;
            color: var(--accent);
            text-decoration: none;
            border-radius: 2px;
            transition: background-color 0.1s ease;
        }

        .nav-letters a:hover {
            background: var(--rule);
        }

        /* Stats line */
        .stats {
            font-size: 0.833rem;
            color: var(--text-secondary);
            margin: 1rem 0 2rem;
        }

        .stats a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.1s;
        }

        .stats a:hover {
            border-bottom-color: var(--accent);
        }

        /* Letter sections */
        .letter-section {
            margin-top: 3.236rem;
        }

        h2 {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 1rem;
            font-weight: 500;
            display: inline-block;
            background: var(--letter-bg);
            color: var(--letter-text);
            padding: 0.2rem 0.6rem;
            margin: 0 0 1rem 0;
            letter-spacing: 0.05em;
        }

        /* Keyword groups */
        .keyword-group {
            margin: 1.25rem 0;
            padding-left: 1rem;
            border-left: 2px solid var(--rule);
        }

        h3 {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.833rem;
            font-weight: 500;
            color: var(--keyword);
            margin: 0 0 0.382rem 0;
            letter-spacing: 0.02em;
        }

        /* Index entries */
        .index-entry {
            margin: 0.236rem 0;
            line-height: 1.5;
        }

        .index-entry a {
            color: var(--text);
            text-decoration: none;
            transition: color 0.1s;
        }

        .index-entry a:hover {
            color: var(--accent);
        }

        .index-entry a:hover .context {
            color: var(--accent);
        }

        .context {
            transition: color 0.1s;
        }

        .keyword {
            color: var(--keyword);
            font-weight: 600;
        }

        .path {
            font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.722rem;
            color: var(--text-tertiary);
            margin-left: 0.5em;
        }

        .path::before { content: '‹'; margin-right: 0.15em; }
        .path::after { content: '›'; margin-left: 0.15em; }

        /* Footer */
        footer {
            margin-top: 4.236rem;
            padding-top: 1.618rem;
            border-top: 1px solid var(--rule);
            font-size: 0.833rem;
            color: var(--text-tertiary);
        }

        footer p {
            margin: 0.5rem 0;
        }

        footer a {
            color: var(--text-secondary);
            text-decoration: none;
            border-bottom: 1px solid var(--rule);
            transition: color 0.1s, border-color 0.1s;
        }

        footer a:hover {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Print styles */
        @media print {
            body {
                max-width: none;
                padding: 0;
                font-size: 10pt;
            }
            nav, footer { display: none; }
            .letter-section { page-break-before: auto; }
            h2 { background: none; color: black; border: 1px solid black; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Library of Cyberspace</h1>
        <p class="subtitle">Permuted Index — KeyWord in Context</p>
    </header>

    <nav>
        <p class="nav-label">Jump to letter</p>
        <div class="nav-letters">
            <a href="#letter-0">0–9</a>
            <a href="#letter-A">A</a>
            <a href="#letter-B">B</a>
            <a href="#letter-C">C</a>
            <a href="#letter-D">D</a>
            <a href="#letter-E">E</a>
            <a href="#letter-F">F</a>
            <a href="#letter-G">G</a>
            <a href="#letter-H">H</a>
            <a href="#letter-I">I</a>
            <a href="#letter-J">J</a>
            <a href="#letter-K">K</a>
            <a href="#letter-L">L</a>
            <a href="#letter-M">M</a>
            <a href="#letter-N">N</a>
            <a href="#letter-O">O</a>
            <a href="#letter-P">P</a>
            <a href="#letter-Q">Q</a>
            <a href="#letter-R">R</a>
            <a href="#letter-S">S</a>
            <a href="#letter-T">T</a>
            <a href="#letter-U">U</a>
            <a href="#letter-V">V</a>
            <a href="#letter-W">W</a>
            <a href="#letter-X">X</a>
            <a href="#letter-Y">Y</a>
            <a href="#letter-Z">Z</a>
        </div>
    </nav>

    <p class="stats">
        421 documents · cross-referenced · deduplicated ·
        <a href="../cyberspace-directory.html">directory</a>
    </p>

HEADER

# Generate ALL permuted entries (every word gets indexed)
echo "Extracting entries..."
find . \( -name "*.pdf" -o -name "*.md" -o -name "*.txt" \) | while IFS= read -r file; do
    filename=$(basename "$file")
    title="${filename%.*}"
    dirpath=$(dirname "$file" | sed 's|^\./||')

    # URL-encode the path
    urlpath=$(echo "$file" | sed 's/ /%20/g')

    # Split title into words
    echo "$title" | tr ' ' '\n' | grep -v '^$' | while IFS= read -r word; do
        # Skip common stop words
        case "$word" in
            a|an|the|of|in|on|for|to|and|with|or|is|are|as|at|be|by|it|from|that|this|was|were|has|have|had|will|would|could|should|A|An|The|Of|In|On|For|To|And|With|Or|Is|Are|As|At|Be|By|It|From|That|This|Was|Were|Has|Have|Had|Will|Would|Could|Should)
                continue
                ;;
            # Skip very short words
            ??|?)
                continue
                ;;
        esac

        # Normalize keyword (lowercase for grouping)
        keyword_lower=$(echo "$word" | tr '[:upper:]' '[:lower:]')

        # Output: keyword_lower|original_word|title|filepath|dirpath
        echo "$keyword_lower|$word|$title|$urlpath|$dirpath"
    done
done | sort -t'|' -k1,1 -k3,3 -u > /tmp/permuted_entries_$$.txt

echo "Building HTML index..."

# Generate HTML by keyword
current_letter=""
current_keyword=""

while IFS='|' read -r kw_lower orig_word title filepath dirpath; do
    first_letter=$(echo "$kw_lower" | cut -c1 | tr '[:lower:]' '[:upper:]')

    # Skip non-alphanumeric
    if ! echo "$first_letter" | grep -q '[A-Z0-9]'; then
        continue
    fi

    # New letter section
    if [ "$first_letter" != "$current_letter" ]; then
        if [ -n "$current_letter" ]; then
            echo "</div>"
        fi
        echo "<div class='letter-section'>"
        echo "<h2 id='letter-$first_letter'>$first_letter</h2>"
        current_letter="$first_letter"
        current_keyword=""
    fi

    # New keyword subsection
    if [ "$kw_lower" != "$current_keyword" ]; then
        if [ -n "$current_keyword" ]; then
            echo "</div>"
        fi
        echo "<div class='keyword-group'>"
        echo "<h3 id='kw-$kw_lower'>$orig_word</h3>"
        current_keyword="$kw_lower"
    fi

    # Highlight keyword in title
    highlighted_title=$(echo "$title" | sed "s/\($orig_word\)/<span class='keyword'>\1<\/span>/ig")

    # Show directory context if not root
    dir_context=""
    if [ "$dirpath" != "." ] && [ -n "$dirpath" ]; then
        dir_context=" <span class='path'>$dirpath</span>"
    fi

    echo "<div class='index-entry'>"
    echo "  <a href=\"$filepath\"><span class='context'>$highlighted_title</span></a>$dir_context"
    echo "</div>"

done < /tmp/permuted_entries_$$.txt >> "$OUTPUT_FILE"

# Close last group
echo "</div>" >> "$OUTPUT_FILE"
echo "</div>" >> "$OUTPUT_FILE"

cat >> "$OUTPUT_FILE" <<'FOOTER'

    <footer>
        <p>
            <a href="../cyberspace-directory.html">Directory</a> ·
            <a href="../DESIGN-SPECIFICATIONS.html">Design</a> ·
            <a href="../spki/scheme/docs/rfc/">RFCs</a>
        </p>
        <p>Library of Cyberspace</p>
    </footer>

</body>
</html>
FOOTER

rm -f /tmp/permuted_entries_$$.txt

echo "✓ Generated: $OUTPUT_FILE"
echo "  $(wc -l < "$OUTPUT_FILE" | tr -d ' ') lines"
echo "  $(find "$LIBRARY_DIR" -name "*.pdf" | wc -l | tr -d ' ') PDFs indexed"
