#!/bin/bash
# Generate clickable permuted index for ~/cyberspace/library
# Usage: ~/cyberspace/bin/generate-library-index
#
# Creates a LaTeX-style permuted index with cross-references and no duplicates

set -e

LIBRARY_DIR="$HOME/cyberspace/library"
OUTPUT_FILE="$LIBRARY_DIR/index.html"

cd "$LIBRARY_DIR" || exit 1

echo "Generating library permuted index..."

cat > "$OUTPUT_FILE" <<'HEADER'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library of Cyberspace - Permuted Index</title>
    <style>
        :root {
            --bg: #fafaf9;
            --bg-alt: #f5f5f4;
            --text: #1c1917;
            --text-muted: #78716c;
            --accent: #0369a1;
            --accent-hover: #0284c7;
            --keyword: #b91c1c;
            --border: #e7e5e4;
            --letter-bg: #0369a1;
            --letter-text: #fff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1c1917;
                --bg-alt: #292524;
                --text: #fafaf9;
                --text-muted: #a8a29e;
                --accent: #38bdf8;
                --accent-hover: #7dd3fc;
                --keyword: #fbbf24;
                --border: #44403c;
                --letter-bg: #38bdf8;
                --letter-text: #1c1917;
            }
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.025em;
        }
        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin: 0;
        }
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--bg-alt);
            border-radius: 6px;
        }
        .nav a {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-family: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent);
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .nav a:hover {
            background: var(--border);
        }
        .stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 1rem 0;
        }
        .stats strong { color: var(--text); }
        .letter-section {
            margin-top: 3rem;
        }
        h2 {
            display: inline-block;
            font-family: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--letter-bg);
            color: var(--letter-text);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            margin: 0 0 1rem 0;
        }
        .keyword-group {
            margin: 1.25rem 0;
            padding-left: 0.5rem;
            border-left: 2px solid var(--border);
        }
        h3 {
            font-family: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--keyword);
            margin: 0 0 0.5rem 0;
            text-transform: lowercase;
        }
        .index-entry {
            margin: 0.35rem 0;
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }
        .context {
            color: var(--text);
        }
        .keyword {
            color: var(--keyword);
            font-weight: 600;
        }
        .path {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        .path::before { content: '['; }
        .path::after { content: ']'; }
        a {
            color: var(--accent);
            text-decoration: none;
        }
        a:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }
        .entry-link {
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }
        footer {
            margin-top: 4rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        footer a { color: var(--accent); }
    </style>
</head>
<body>
    <header>
        <h1>Library of Cyberspace</h1>
        <p class="subtitle">Permuted Index &mdash; KeyWord In Context</p>
    </header>

    <nav class="nav">
        <a href="#letter-A">A</a><a href="#letter-B">B</a><a href="#letter-C">C</a>
        <a href="#letter-D">D</a><a href="#letter-E">E</a><a href="#letter-F">F</a>
        <a href="#letter-G">G</a><a href="#letter-H">H</a><a href="#letter-I">I</a>
        <a href="#letter-J">J</a><a href="#letter-K">K</a><a href="#letter-L">L</a>
        <a href="#letter-M">M</a><a href="#letter-N">N</a><a href="#letter-O">O</a>
        <a href="#letter-P">P</a><a href="#letter-Q">Q</a><a href="#letter-R">R</a>
        <a href="#letter-S">S</a><a href="#letter-T">T</a><a href="#letter-U">U</a>
        <a href="#letter-V">V</a><a href="#letter-W">W</a><a href="#letter-X">X</a>
        <a href="#letter-Y">Y</a><a href="#letter-Z">Z</a><a href="#letter-0">0-9</a>
    </nav>

    <p class="stats">
        <strong>421 documents</strong> indexed &bull;
        Cross-referenced, deduplicated, hierarchical &bull;
        <a href="../cyberspace-directory.html">Directory</a>
    </p>

HEADER

# Generate ALL permuted entries (every word gets indexed)
echo "Extracting entries..."
find . \( -name "*.pdf" -o -name "*.md" -o -name "*.txt" \) | while IFS= read -r file; do
    filename=$(basename "$file")
    title="${filename%.*}"
    dirpath=$(dirname "$file" | sed 's|^\./||')

    # URL-encode the path
    urlpath=$(echo "$file" | sed 's/ /%20/g')

    # Split title into words
    echo "$title" | tr ' ' '\n' | grep -v '^$' | while IFS= read -r word; do
        # Skip common stop words
        case "$word" in
            a|an|the|of|in|on|for|to|and|with|or|is|are|as|at|be|by|it|from|that|this|was|were|has|have|had|will|would|could|should|A|An|The|Of|In|On|For|To|And|With|Or|Is|Are|As|At|Be|By|It|From|That|This|Was|Were|Has|Have|Had|Will|Would|Could|Should)
                continue
                ;;
            # Skip very short words
            ??|?)
                continue
                ;;
        esac

        # Normalize keyword (lowercase for grouping)
        keyword_lower=$(echo "$word" | tr '[:upper:]' '[:lower:]')

        # Output: keyword_lower|original_word|title|filepath|dirpath
        echo "$keyword_lower|$word|$title|$urlpath|$dirpath"
    done
done | sort -t'|' -k1,1 -k3,3 -u > /tmp/permuted_entries_$$.txt

echo "Building HTML index..."

# Generate HTML by keyword
current_letter=""
current_keyword=""

while IFS='|' read -r kw_lower orig_word title filepath dirpath; do
    first_letter=$(echo "$kw_lower" | cut -c1 | tr '[:lower:]' '[:upper:]')

    # Skip non-alphanumeric
    if ! echo "$first_letter" | grep -q '[A-Z0-9]'; then
        continue
    fi

    # New letter section
    if [ "$first_letter" != "$current_letter" ]; then
        if [ -n "$current_letter" ]; then
            echo "</div>"
        fi
        echo "<div class='letter-section'>"
        echo "<h2 id='letter-$first_letter'>$first_letter</h2>"
        current_letter="$first_letter"
        current_keyword=""
    fi

    # New keyword subsection
    if [ "$kw_lower" != "$current_keyword" ]; then
        if [ -n "$current_keyword" ]; then
            echo "</div>"
        fi
        echo "<div class='keyword-group'>"
        echo "<h3 id='kw-$kw_lower'>$orig_word</h3>"
        current_keyword="$kw_lower"
    fi

    # Highlight keyword in title
    highlighted_title=$(echo "$title" | sed "s/\($orig_word\)/<span class='keyword'>\1<\/span>/ig")

    # Show directory context if not root
    dir_context=""
    if [ "$dirpath" != "." ] && [ -n "$dirpath" ]; then
        dir_context=" <span class='path'>$dirpath</span>"
    fi

    echo "<div class='index-entry'>"
    echo "  <a href=\"$filepath\"><span class='context'>$highlighted_title</span></a>$dir_context"
    echo "</div>"

done < /tmp/permuted_entries_$$.txt >> "$OUTPUT_FILE"

# Close last group
echo "</div>" >> "$OUTPUT_FILE"
echo "</div>" >> "$OUTPUT_FILE"

cat >> "$OUTPUT_FILE" <<'FOOTER'

    <footer>
        <p>
            <a href="../cyberspace-directory.html">Directory</a> &bull;
            <a href="../DESIGN-SPECIFICATIONS.html">Design Specifications</a> &bull;
            <a href="../spki/scheme/docs/rfc/">RFCs</a>
        </p>
        <p>Library of Cyberspace &mdash; Permuted KWIC Index</p>
    </footer>

</body>
</html>
FOOTER

rm -f /tmp/permuted_entries_$$.txt

echo "âœ“ Generated: $OUTPUT_FILE"
echo "  $(wc -l < "$OUTPUT_FILE" | tr -d ' ') lines"
echo "  $(find "$LIBRARY_DIR" -name "*.pdf" | wc -l | tr -d ' ') PDFs indexed"
