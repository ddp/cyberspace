<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>rfc-020-content-addressed-storage</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="rfc.css" />
</head>
<body>
<h1 id="rfc-020-content-addressed-storage">RFC-020: Content-Addressed
Storage</h1>
<p><strong>Status:</strong> Draft <strong>Date:</strong> January 2026
<strong>Author:</strong> Derrell Piper <a href="mailto:ddp@eludom.net"
class="email">ddp@eludom.net</a> <strong>Implementation:</strong>
Proposed</p>
<hr />
<h2 id="abstract">Abstract</h2>
<p>This RFC specifies content-addressed storage (CAS) for the Library of
Cyberspace: a storage model where data is addressed by its cryptographic
hash rather than by location. Content addressing provides immutability
guarantees, automatic deduplication, and tamper-evident storage.</p>
<hr />
<h2 id="motivation">Motivation</h2>
<p>Traditional storage systems use location-based addressing:</p>
<ul>
<li><strong>DECtape</strong>: Physical position on magnetic tape</li>
<li><strong>Filesystems</strong>: Path names
(<code>/home/ddp/file.txt</code>)</li>
<li><strong>Databases</strong>: Row IDs, primary keys</li>
<li><strong>URLs</strong>: Server + path
(<code>https://example.com/doc.ps</code>)</li>
</ul>
<p>Location-based addressing has fundamental problems:</p>
<ol type="1">
<li><strong>Mutability</strong> - Same address can point to different
content over time</li>
<li><strong>Link rot</strong> - Addresses become invalid when content
moves</li>
<li><strong>Duplication</strong> - Identical content stored multiple
times</li>
<li><strong>No verification</strong> - Address doesn’t prove content
integrity</li>
</ol>
<p>Content-addressed storage inverts this:</p>
<pre><code>Location-based:  address → content (many-to-one, mutable)
Content-based:   content → address (one-to-one, immutable)</code></pre>
<p>The address IS the content’s cryptographic fingerprint. If the
content changes, the address changes. If two files have the same
address, they are byte-for-byte identical.</p>
<hr />
<h2 id="content-addressing-model">Content Addressing Model</h2>
<h3 id="hash-as-address">Hash as Address</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Content determines address</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">content-address </span>data)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  (sha256 data))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; Store by hash</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-store </span>data)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((hash (content-address data)))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    (write-blob (hash-&gt;path hash) data)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    hash))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Retrieve by hash</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-retrieve </span>hash)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((data (read-blob (hash-&gt;path hash))))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">equal?</span> hash (content-address data))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        data</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">error</span> <span class="st">&quot;Content tampered&quot;</span>))))</span></code></pre></div>
<h3 id="properties">Properties</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Location-Based</th>
<th>Content-Addressed</th>
</tr>
</thead>
<tbody>
<tr>
<td>Address stability</td>
<td>Unstable</td>
<td>Permanent</td>
</tr>
<tr>
<td>Content verification</td>
<td>External</td>
<td>Intrinsic</td>
</tr>
<tr>
<td>Deduplication</td>
<td>Manual</td>
<td>Automatic</td>
</tr>
<tr>
<td>Mutability</td>
<td>Mutable</td>
<td>Immutable</td>
</tr>
<tr>
<td>Link rot</td>
<td>Common</td>
<td>Impossible</td>
</tr>
</tbody>
</table>
<h3 id="hash-function-requirements">Hash Function Requirements</h3>
<p>The hash function MUST be:</p>
<ol type="1">
<li><strong>Collision-resistant</strong> - Computationally infeasible to
find two inputs with same hash</li>
<li><strong>Preimage-resistant</strong> - Cannot derive content from
hash</li>
<li><strong>Deterministic</strong> - Same content always produces same
hash</li>
<li><strong>Fast</strong> - Practical for large objects</li>
</ol>
<p><strong>Specified hash</strong>: SHA-256 (32 bytes, 64 hex
characters)</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Example content address</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; This is the SHA-256 of the empty string</span></span></code></pre></div>
<hr />
<h2 id="storage-architecture">Storage Architecture</h2>
<h3 id="object-store">Object Store</h3>
<pre><code>.cas/
├── objects/
│   ├── e3/
│   │   └── b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
│   ├── a7/
│   │   └── ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a
│   └── ...
├── refs/
│   ├── HEAD
│   └── tags/
└── index</code></pre>
<p><strong>Sharding</strong>: First two hex characters of hash form
directory name (256 buckets).</p>
<h3 id="object-types">Object Types</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Blob - raw data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>(cas-blob</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  (hash <span class="st">&quot;sha256:...&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  (size <span class="dv">1024</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  (data #<span class="op">${...}</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Tree - directory structure</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>(cas-tree</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  (hash <span class="st">&quot;sha256:...&quot;</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  (entries</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    ((<span class="st">&quot;README.md&quot;</span> blob <span class="st">&quot;sha256:abc...&quot;</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;src&quot;</span> tree <span class="st">&quot;sha256:def...&quot;</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;lib&quot;</span> tree <span class="st">&quot;sha256:ghi...&quot;</span>))))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Commit - snapshot with metadata</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>(cas-commit</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  (hash <span class="st">&quot;sha256:...&quot;</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  (tree <span class="st">&quot;sha256:...&quot;</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  (parent <span class="st">&quot;sha256:...&quot;</span> | <span class="dv">#f</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  (author <span class="st">&quot;ddp@eludom.net&quot;</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  (timestamp <span class="dv">1767700000</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  (message <span class="st">&quot;Initial commit&quot;</span>))</span></code></pre></div>
<h3 id="merkle-trees">Merkle Trees</h3>
<p>Directories are trees of hashes. The root hash commits to all
content:</p>
<pre><code>                    root: sha256:abc...
                         /          \
              src: sha256:def     lib: sha256:ghi
               /        \              |
        main.scm     test.scm      util.scm
        sha256:111   sha256:222    sha256:333</code></pre>
<p>Changing ANY file changes ALL parent hashes up to root.</p>
<hr />
<h2 id="operations">Operations</h2>
<h3 id="store">Store</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-put </span>content)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Store content, return hash&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((hash (sha256 content))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>         (path (hash-&gt;path hash)))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    (unless (<span class="kw">file-exists?</span> path)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      (write-blob path content))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    hash))</span></code></pre></div>
<p><strong>Deduplication</strong>: If hash already exists, storage is a
no-op.</p>
<h3 id="retrieve">Retrieve</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-get </span>hash)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Retrieve content by hash, verify integrity&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((path (hash-&gt;path hash))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>         (content (read-blob path)))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    (unless (<span class="kw">equal?</span> hash (sha256 content))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;Content integrity failure&quot;</span> hash))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    content))</span></code></pre></div>
<p><strong>Self-verifying</strong>: Every retrieval confirms
integrity.</p>
<h3 id="exists">Exists</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-exists? </span>hash)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Check if content exists&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">file-exists?</span> (hash-&gt;path hash)))</span></code></pre></div>
<h3 id="delete">Delete</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-gc </span>roots)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Garbage collect unreachable objects&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((reachable (trace-reachable roots)))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">for-each</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">lambda</span> (hash)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        (unless (set-member? reachable hash)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">delete-file</span> (hash-&gt;path hash))))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      (all-objects))))</span></code></pre></div>
<p><strong>Note</strong>: Deletion requires garbage collection from
known roots.</p>
<hr />
<h2 id="naming-layer">Naming Layer</h2>
<p>Content addresses are not human-friendly. A naming layer maps names
to hashes:</p>
<h3 id="references">References</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Mutable reference to immutable content</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">ref-set </span>name hash)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  (write-file (ref-path name) hash))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">ref-get </span>name)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  (read-file (ref-path name)))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Example</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>(ref-set <span class="st">&quot;HEAD&quot;</span> <span class="st">&quot;sha256:abc123...&quot;</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>(ref-get <span class="st">&quot;HEAD&quot;</span>) <span class="co">; =&gt; &quot;sha256:abc123...&quot;</span></span></code></pre></div>
<h3 id="tags">Tags</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Immutable named reference</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">tag-create </span>name hash <span class="ex">#!key</span> message signature)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((tag-content</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>         `(tag</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>           (name ,name)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>           (object ,hash)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>           (message ,message)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>           (signature ,signature))))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    (cas-put (serialize tag-content))))</span></code></pre></div>
<h3 id="directory-entries">Directory Entries</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Human name -&gt; content hash</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> library-index</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  &#39;((<span class="st">&quot;RFC-000&quot;</span> <span class="op">.</span> <span class="st">&quot;sha256:e3b0c44...&quot;</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;RFC-001&quot;</span> <span class="op">.</span> <span class="st">&quot;sha256:a7ffc6f...&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;RFC-002&quot;</span> <span class="op">.</span> <span class="st">&quot;sha256:b94d27b...&quot;</span>)))</span></code></pre></div>
<hr />
<h2 id="the-soup-object-directory">The Soup: Object Directory</h2>
<p>Content-addressed storage provides retrieval by hash, but discovery
requires an object directory. The <strong>Soup</strong> (inspired by
NewtonOS) provides a unified view of all objects with rich metadata.</p>
<h3 id="philosophy">Philosophy</h3>
<blockquote>
<p>“The soup is infinite.” - Objects swim in a queryable sea of
metadata.</p>
</blockquote>
<p>The Soup inverts the traditional filesystem model:</p>
<ul>
<li><strong>Filesystem</strong>: Navigate hierarchy to find objects</li>
<li><strong>Soup</strong>: Query attributes to discover objects</li>
</ul>
<h3 id="object-enumeration">Object Enumeration</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">soup</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;List all objects in the vault with metadata&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">append</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (soup-releases)      <span class="co">; Signed releases</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (soup-archives)      <span class="co">; Sealed archives</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    (soup-keys)          <span class="co">; Cryptographic keys</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    (soup-audit-entries) <span class="co">; Audit trail</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    (soup-commits)))     <span class="co">; Recent commits</span></span></code></pre></div>
<h3 id="rich-metadata">Rich Metadata</h3>
<p>Every object carries crypto metadata - the ciphers, hashes, and keys
involved:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Archive object</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;1.0.0&quot;</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  (type archive)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;1.2MB&quot;</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  (crypto (zstd sha256 <span class="st">&quot;fe378a78...&quot;</span>)))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Key object</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;vault-signing&quot;</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  (type key)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;64B&quot;</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  (crypto (ed25519/256 public sign</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;sha256:a1b2c3d4...&quot;</span>    <span class="co">; fingerprint</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;id:ddp@eludom.net&quot;</span>     <span class="co">; identity</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;2026-01-07&quot;</span>)))         <span class="co">; creation date</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Release object</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;0.1.0&quot;</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  (type release)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;313B&quot;</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  (crypto (ed25519 sha512 <span class="st">&quot;abc123...&quot;</span>)))</span></code></pre></div>
<h3 id="querying-the-soup">Querying the Soup</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Find all signed objects</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>(soup-query type: &#39;release)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Find objects using specific algorithm</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>(soup-query crypto: &#39;ed25519)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Find objects by size range</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>(soup-query min-size: <span class="dv">1000</span> max-size: <span class="dv">100000</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Find objects by content hash prefix</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>(soup-query hash-prefix: <span class="st">&quot;fe378&quot;</span>)</span></code></pre></div>
<h3 id="display-format">Display Format</h3>
<p>The soup displays as a compact, human-readable listing:</p>
<pre><code>$ seal-soup
vault-signing, 64B, ed25519/256, public, sign, sha256:a1b2c3d4...
0.1.0, 313B, signed, ed25519, sha512
1.0.0, 1.2MB, zstd, sha256, fe378a78...
audit/1, sealed, 2026-01-07T10:30:00Z</code></pre>
<h3 id="soup-as-index">Soup as Index</h3>
<p>The Soup can be serialized as a content-addressed index:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">soup-snapshot</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Create content-addressed snapshot of current soup&quot;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((entries (soup))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         (serialized (serialize entries))</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>         (hash (cas-put serialized)))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    (ref-set <span class="st">&quot;soup/HEAD&quot;</span> hash)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    hash))</span></code></pre></div>
<p>This enables: - <strong>Time travel</strong>: Load historical soup
snapshots - <strong>Replication</strong>: Sync soup indexes between
vaults - <strong>Verification</strong>: Prove soup state at a point in
time</p>
<hr />
<h2 id="integration-with-library-of-cyberspace">Integration with Library
of Cyberspace</h2>
<h3 id="vault-integration">Vault Integration</h3>
<p>The Vault (RFC-006) uses content addressing internally via Git:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Git objects ARE content-addressed</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">git-hash-object </span>content)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  (sha1 (<span class="kw">string-append</span> <span class="st">&quot;blob &quot;</span> (<span class="kw">number-&gt;string</span> (blob-length content)) <span class="st">&quot;</span><span class="ch">\x</span><span class="st">00&quot;</span> content)))</span></code></pre></div>
<p>CAS extends this with SHA-256 and Library-specific semantics.</p>
<h3 id="archive-storage">Archive Storage</h3>
<p>Sealed archives (RFC-018) can be stored by content address:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">archive-to-cas </span>archive-path)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((content (read-blob archive-path))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>         (hash (cas-put content)))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    (ref-set (<span class="kw">string-append</span> <span class="st">&quot;archives/&quot;</span> (archive-version archive-path)) hash)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    hash))</span></code></pre></div>
<h3 id="replication">Replication</h3>
<p>Content addressing enables efficient replication (RFC-001):</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Only transfer objects receiver doesn&#39;t have</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">replicate-to </span>remote root-hash)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">for-each</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">lambda</span> (hash)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      (unless (remote-has? remote hash)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        (remote-put remote hash (cas-get hash))))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    (trace-reachable root-hash)))</span></code></pre></div>
<h3 id="spki-integration">SPKI Integration</h3>
<p>Content hashes can be authorization subjects (RFC-004):</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Grant permission to specific content</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>(spki-cert</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  (issuer publisher-key)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  (subject (hash sha256 <span class="st">&quot;abc123...&quot;</span>))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  (permission <span class="kw">read</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  (validity (not-after <span class="st">&quot;2027-01-01&quot;</span>)))</span></code></pre></div>
<hr />
<h2 id="chunking-for-large-objects">Chunking for Large Objects</h2>
<p>Large files are split into chunks for:</p>
<ol type="1">
<li><strong>Deduplication</strong> at sub-file granularity</li>
<li><strong>Parallel transfer</strong></li>
<li><strong>Incremental updates</strong></li>
</ol>
<h3 id="fixed-size-chunking">Fixed-Size Chunking</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> chunk-size </span>(<span class="op">*</span> <span class="dv">64</span> <span class="dv">1024</span>))  <span class="co">; 64KB</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">chunk-fixed </span>data)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop ((offset <span class="dv">0</span>) (chunks &#39;()))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="op">&gt;=</span> offset (blob-length data))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">reverse</span> chunks)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        (loop (<span class="op">+</span> offset chunk-size)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">cons</span> (blob-copy data offset (<span class="kw">min</span> chunk-size (<span class="op">-</span> (blob-length data) offset)))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                    chunks)))))</span></code></pre></div>
<h3 id="content-defined-chunking-rabin-fingerprinting">Content-Defined
Chunking (Rabin fingerprinting)</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Chunk boundaries determined by content</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; Survives insertions/deletions better than fixed-size</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">chunk-rabin </span>data)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((window-size <span class="dv">48</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        (min-chunk <span class="dv">2048</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        (max-chunk <span class="dv">65536</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        (mask <span class="sc">#x</span><span class="dv">0fff</span>))  <span class="co">; Average 4KB chunks</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>))</span></code></pre></div>
<h3 id="chunk-tree">Chunk Tree</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(cas-chunked</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  (hash <span class="st">&quot;sha256:...&quot;</span>)      <span class="co">; Root hash</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  (size <span class="dv">10485760</span>)          <span class="co">; 10MB original</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  (chunks</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;sha256:aaa...&quot;</span> <span class="dv">65536</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;sha256:bbb...&quot;</span> <span class="dv">65536</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;sha256:ccc...&quot;</span> <span class="dv">32768</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>))</span></code></pre></div>
<hr />
<h2 id="introspection">Introspection</h2>
<p>The Library is fully introspective: it stores, addresses, and reasons
about itself.</p>
<h3 id="self-hosting">Self-Hosting</h3>
<p>The system contains its own description:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; The RFCs are in the CAS</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>(cas-get (ref-get <span class="st">&quot;rfc/020&quot;</span>))  <span class="co">; =&gt; This document</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; The code is in the CAS</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>(cas-get (ref-get <span class="st">&quot;src/vault.scm&quot;</span>))  <span class="co">; =&gt; Implementation</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; The schema is in the CAS</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>(cas-get (ref-get <span class="st">&quot;schema/soup-object&quot;</span>))  <span class="co">; =&gt; Soup object definition</span></span></code></pre></div>
<h3 id="meta-objects">Meta-Objects</h3>
<p>Objects that describe objects:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Schema for soup objects (itself a soup object)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;schema/soup-object&quot;</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  (type schema)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;412B&quot;</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  (crypto (sha256 <span class="st">&quot;def456...&quot;</span>))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  (describes soup-object))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; The soup can enumerate itself</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>(soup-query type: &#39;schema)  <span class="co">; =&gt; All schemas including this one</span></span></code></pre></div>
<h3 id="reflexive-queries">Reflexive Queries</h3>
<p>The soup answers questions about itself:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; What types exist?</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>(soup-types)  <span class="co">; =&gt; (archive release key audit commit schema ...)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; What crypto algorithms are in use?</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>(soup-algorithms)  <span class="co">; =&gt; (sha256 ed25519 zstd age ...)</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; What is the total size of the vault?</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>(soup-total-size)  <span class="co">; =&gt; 47.3MB</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; How much deduplication?</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>(soup-dedup-ratio)  <span class="co">; =&gt; 0.73 (27% space saved)</span></span></code></pre></div>
<h3 id="provenance">Provenance</h3>
<p>Every object knows its origin:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;rfc-020.ps&quot;</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  (type blob)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;89KB&quot;</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  (crypto (sha256 <span class="st">&quot;abc123...&quot;</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  (provenance</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    (created-by <span class="st">&quot;ddp@eludom.net&quot;</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    (created-at <span class="dv">1767700000</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    (derived-from <span class="st">&quot;sha256:fff888...&quot;</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    (tool <span class="st">&quot;dvips&quot;</span>)))</span></code></pre></div>
<p>Provenance chains are themselves content-addressed:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Trace full history</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">provenance-chain </span>hash)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((obj (soup-get hash)))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (soup-object-derived-from obj)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">cons</span> obj (provenance-chain (soup-object-derived-from obj)))</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> obj))))</span></code></pre></div>
<h3 id="audit-of-audits">Audit of Audits</h3>
<p>The audit trail audits itself:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Audit entry for an audit entry</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>(audit-entry</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  (id <span class="dv">42</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  (actor vault-key)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  (action (audit-append <span class="dv">41</span>))  <span class="co">; Recorded adding entry 41</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  (timestamp <span class="dv">1767700100</span>))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; The audit trail is in the soup</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>(soup-query type: &#39;audit)  <span class="co">; =&gt; All audit entries as soup objects</span></span></code></pre></div>
<h3 id="bootstrapping">Bootstrapping</h3>
<p>The system can describe how to build itself:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Bootstrap manifest - everything needed to reconstruct</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>(bootstrap-manifest</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  (hash <span class="st">&quot;sha256:bootstrap...&quot;</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  (contents</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    ((<span class="st">&quot;src/&quot;</span> tree <span class="st">&quot;sha256:src...&quot;</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;rfcs/&quot;</span> tree <span class="st">&quot;sha256:rfcs...&quot;</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;keys/&quot;</span> tree <span class="st">&quot;sha256:keys...&quot;</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;schema/&quot;</span> tree <span class="st">&quot;sha256:schema...&quot;</span>)))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  (build-instructions</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Load src/boot.scm, call (bootstrap)&quot;</span>))</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Verify bootstrap integrity</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">verify-bootstrap</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((manifest (cas-get (ref-get <span class="st">&quot;bootstrap&quot;</span>))))</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">for-each</span> verify-tree (manifest-contents manifest))))</span></code></pre></div>
<h3 id="the-library-contains-itself">The Library Contains Itself</h3>
<pre><code>╭─────────────────────────────────────────╮
│            LIBRARY OF CYBERSPACE        │
│  ╭───────────────────────────────────╮  │
│  │     Content-Addressed Storage     │  │
│  │  ╭─────────────────────────────╮  │  │
│  │  │    RFC-020 (this document)  │  │  │
│  │  │    describing CAS           │  │  │
│  │  │    stored in CAS            │  │  │
│  │  ╰─────────────────────────────╯  │  │
│  ╰───────────────────────────────────╯  │
╰─────────────────────────────────────────╯</code></pre>
<p>Homoiconic storage: the description is the thing.</p>
<hr />
<h2 id="tombstones">Tombstones</h2>
<p>Objects are never truly deleted - they are marked with
tombstones.</p>
<h3 id="soft-deletion">Soft Deletion</h3>
<div class="sourceCode" id="cb34"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-tombstone </span>hash <span class="ex">#!key</span> reason actor)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Mark object as deleted without removing it&quot;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((tombstone</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>         `(tombstone</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>           (object ,hash)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>           (deleted-at ,(current-seconds))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>           (deleted-by ,actor)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>           (reason ,reason))))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    (audit-append action: `(tombstone ,hash) motivation: reason)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    (cas-put (serialize tombstone))))</span></code></pre></div>
<h3 id="tombstone-properties">Tombstone Properties</h3>
<div class="sourceCode" id="cb35"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;sha256:deadbeef...&quot;</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  (type tombstone)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;0B&quot;</span>)  <span class="co">; Logical size is zero</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  (status deleted)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  (reason <span class="st">&quot;Superseded by sha256:newversion...&quot;</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  (recoverable <span class="dv">#t</span>))</span></code></pre></div>
<h3 id="recovery">Recovery</h3>
<div class="sourceCode" id="cb36"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-resurrect </span>hash)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Remove tombstone, restore object visibility&quot;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((tombstone (find-tombstone hash)))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    (when tombstone</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>      (audit-append action: `(resurrect ,hash))</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>      (cas-delete (tombstone-hash tombstone)))))</span></code></pre></div>
<h3 id="garbage-collection-with-tombstones">Garbage Collection with
Tombstones</h3>
<div class="sourceCode" id="cb37"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-gc </span>roots <span class="ex">#!key</span> preserve-tombstones)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;GC respects tombstones by default&quot;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((reachable (trace-reachable roots))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        (tombstoned (all-tombstoned-hashes)))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">for-each</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">lambda</span> (hash)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        (unless (<span class="kw">or</span> (set-member? reachable hash)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">and</span> preserve-tombstones</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                         (set-member? tombstoned hash)))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">delete-file</span> (hash-&gt;path hash))))</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>      (all-objects))))</span></code></pre></div>
<hr />
<h2 id="pinning">Pinning</h2>
<p>Pinned objects are protected from garbage collection.</p>
<h3 id="pin-operations">Pin Operations</h3>
<div class="sourceCode" id="cb38"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-pin </span>hash <span class="ex">#!key</span> recursive reason)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Pin object (and optionally its references)&quot;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((pin `(pin</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>               (object ,hash)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>               (pinned-at ,(current-seconds))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>               (recursive ,recursive)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>               (reason ,reason))))</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    (write-file (pin-path hash) (serialize pin))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    (when recursive</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">for-each</span> (<span class="kw">lambda</span> (ref) (cas-pin ref recursive: <span class="dv">#t</span>))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>                (object-references hash)))))</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-unpin </span>hash)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Remove pin, allow GC&quot;</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">delete-file</span> (pin-path hash)))</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-pinned? </span>hash)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Check if object is pinned&quot;</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">file-exists?</span> (pin-path hash)))</span></code></pre></div>
<h3 id="pin-manifest">Pin Manifest</h3>
<div class="sourceCode" id="cb39"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; All pins as soup objects</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>(soup-query type: &#39;pin)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Pin statistics</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>(soup-pin-count)      <span class="co">; =&gt; 142 objects pinned</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>(soup-pinned-size)    <span class="co">; =&gt; 23.4MB</span></span></code></pre></div>
<h3 id="root-pins">Root Pins</h3>
<p>Certain objects are implicitly pinned:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> implicit-roots</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="st">&quot;HEAD&quot;</span>           <span class="co">; Current commit</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;refs/tags/*&quot;</span>    <span class="co">; All tags</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bootstrap&quot;</span>      <span class="co">; System bootstrap</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;schema/*&quot;</span>))     <span class="co">; All schemas</span></span></code></pre></div>
<hr />
<h2 id="bloom-filters">Bloom Filters</h2>
<p>Compact probabilistic set membership for efficient replication.</p>
<h3 id="multi-level-existence-check">Multi-Level Existence Check</h3>
<p>For the distributed soup, existence checks dominate replication
overhead. A tiered approach minimizes latency:</p>
<pre><code>┌─────────────────────────────────────────────────────────┐
│ L1: Hot Set Cache (1000 items, O(1), microseconds)     │
├─────────────────────────────────────────────────────────┤
│ L2: Blocked Bloom Filter (100K items, O(k), cache-     │
│     friendly memory layout)                             │
├─────────────────────────────────────────────────────────┤
│ L3: Quotient Filter (1M items, supports deletion)      │
├─────────────────────────────────────────────────────────┤
│ L4: Disk/Network (authoritative, milliseconds)         │
└─────────────────────────────────────────────────────────┘</code></pre>
<h3 id="blocked-bloom-filters">Blocked Bloom Filters</h3>
<p>Cache-line aligned blocks for 10x faster lookups:</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Blocked Bloom: each block fits in CPU cache line (64 bytes = 512 bits)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> *block-bits* </span><span class="dv">512</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> *cache-line* </span><span class="dv">64</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">make-blocked-bloom </span>capacity error-rate)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Cache-friendly blocked Bloom filter&quot;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((bits (bloom-optimal-bits capacity error-rate))</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>         (num-blocks (<span class="kw">ceiling</span> (<span class="op">/</span> bits *block-bits*)))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>         (hashes (bloom-optimal-hashes capacity bits)))</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    (blocked-bloom</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>      (blocks (<span class="kw">make-vector</span> num-blocks (make-u8vector *cache-line* <span class="dv">0</span>)))</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>      (hash-count hashes)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>      (block-selector (<span class="kw">lambda</span> (hash) (<span class="kw">modulo</span> (hash-part-1 hash) num-blocks))))))</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">blocked-bloom-add! </span><span class="kw">filter</span> hash)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Add to block - all bits within same cache line&quot;</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((block-idx (block-select <span class="kw">filter</span> hash))</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>         (block (<span class="kw">vector-ref</span> (bloom-blocks <span class="kw">filter</span>) block-idx)))</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">for-each</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">lambda</span> (i)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let</span> ((bit-idx (<span class="kw">modulo</span> (bloom-hash <span class="kw">filter</span> hash i) *block-bits*)))</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>          (u8vector-bit-set! block bit-idx <span class="dv">1</span>)))</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>      (iota (bloom-hash-count <span class="kw">filter</span>)))))</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">blocked-bloom-contains? </span><span class="kw">filter</span> hash)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Check within single cache line - no cache misses&quot;</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((block-idx (block-select <span class="kw">filter</span> hash))</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>         (block (<span class="kw">vector-ref</span> (bloom-blocks <span class="kw">filter</span>) block-idx)))</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    (every</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">lambda</span> (i)</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let</span> ((bit-idx (<span class="kw">modulo</span> (bloom-hash <span class="kw">filter</span> hash i) *block-bits*)))</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>          (<span class="op">=</span> <span class="dv">1</span> (u8vector-bit-ref block bit-idx))))</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>      (iota (bloom-hash-count <span class="kw">filter</span>)))))</span></code></pre></div>
<h3 id="counting-bloom-filters">Counting Bloom Filters</h3>
<p>For the soup, objects can be tombstoned (soft-deleted). Counting
filters support removal:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Counting Bloom: 4-bit counters instead of single bits</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">make-counting-bloom </span>capacity error-rate)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Counting Bloom filter supporting deletions&quot;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((slots (bloom-optimal-bits capacity error-rate))</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>         (nibbles (make-u8vector (<span class="kw">ceiling</span> (<span class="op">/</span> slots <span class="dv">2</span>)) <span class="dv">0</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>         (hashes (bloom-optimal-hashes capacity slots)))</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    (counting-bloom nibbles hashes slots)))</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">counting-bloom-add! </span><span class="kw">filter</span> hash)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Increment counters (saturate at 15)&quot;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">for-each</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">lambda</span> (i)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> ((slot (bloom-slot <span class="kw">filter</span> hash i)))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        (nibble-increment! (bloom-nibbles <span class="kw">filter</span>) slot)))</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    (iota (bloom-hash-count <span class="kw">filter</span>))))</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">counting-bloom-remove! </span><span class="kw">filter</span> hash)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Decrement counters (only if present)&quot;</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  (when (counting-bloom-contains? <span class="kw">filter</span> hash)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">for-each</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">lambda</span> (i)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let</span> ((slot (bloom-slot <span class="kw">filter</span> hash i)))</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>          (nibble-decrement! (bloom-nibbles <span class="kw">filter</span>) slot)))</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>      (iota (bloom-hash-count <span class="kw">filter</span>)))))</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; Integration with tombstones</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-tombstone/bloom </span>hash reason)</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Tombstone with Bloom filter update&quot;</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  (counting-bloom-remove! existence-filter hash)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  (cas-tombstone hash reason: reason))</span></code></pre></div>
<h3 id="quotient-filters">Quotient Filters</h3>
<p>Better space efficiency than Bloom, supports deletion, and can be
resized:</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Quotient filter: fingerprint stored in quotient/remainder form</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">make-quotient-filter </span>capacity)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Space-efficient filter with deletion support&quot;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((slots (next-power-of-2 capacity))</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>         (q-bits (integer-log2 slots))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>         (r-bits (<span class="op">-</span> <span class="dv">64</span> q-bits)))  <span class="co">; 64-bit fingerprints</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    (quotient-filter</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>      (table (<span class="kw">make-vector</span> slots <span class="dv">#f</span>))</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>      (q-bits q-bits)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>      (r-bits r-bits)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>      (count <span class="dv">0</span>))))</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">qf-fingerprint </span>hash q-bits r-bits)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Split hash into quotient and remainder&quot;</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((fp (hash-&gt;u64 hash)))</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">values</span> (arithmetic-shift fp (<span class="op">-</span> r-bits))  <span class="co">; quotient</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">bitwise-and</span> fp (<span class="op">-</span> (arithmetic-shift <span class="dv">1</span> r-bits) <span class="dv">1</span>)))))  <span class="co">; remainder</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">qf-insert! </span>qf hash)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Insert with Robin Hood linear probing&quot;</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let-values</span> (((q r) (qf-fingerprint hash (qf-q-bits qf) (qf-r-bits qf))))</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    (qf-insert-slot! qf q r)))</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">qf-delete! </span>qf hash)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Delete fingerprint&quot;</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let-values</span> (((q r) (qf-fingerprint hash (qf-q-bits qf) (qf-r-bits qf))))</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    (qf-delete-slot! qf q r)))</span></code></pre></div>
<h3 id="replication-protocol">Replication Protocol</h3>
<div class="sourceCode" id="cb45"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Sender: &quot;Here&#39;s what I have&quot; (compressed Bloom)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">bloom-inventory</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((<span class="kw">filter</span> (make-blocked-bloom <span class="dv">100000</span> <span class="fl">0.01</span>)))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">for-each</span> (<span class="kw">lambda</span> (hash) (blocked-bloom-add! <span class="kw">filter</span> hash))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>              (all-object-hashes))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">filter</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Receiver: &quot;Send me what I&#39;m missing&quot;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">bloom-diff </span>local-filter remote-filter)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">filter</span> (<span class="kw">lambda</span> (hash)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">and</span> (blocked-bloom-contains? remote-filter hash)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">not</span> (cas-exists? hash))))</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>          (all-object-hashes)))</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Exchange is O(bloom-size) not O(object-count)</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co">;; Blocked Bloom: 10-100x faster due to cache locality</span></span></code></pre></div>
<h3 id="hierarchical-existence-check">Hierarchical Existence Check</h3>
<div class="sourceCode" id="cb46"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-exists?/fast </span>hash)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Tiered existence check - fast path for common case&quot;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (lru-get hot-set hash)              <span class="co">; L1: O(1) in-memory</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">and</span> (blocked-bloom-contains? l2-bloom hash)  <span class="co">; L2: O(k) cache-friendly</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">or</span> (qf-contains? l3-qf hash)  <span class="co">; L3: O(1) amortized</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>               (cas-exists? hash)))))      <span class="co">; L4: authoritative</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; 99% of checks hit L1/L2, avoiding disk/network entirely</span></span></code></pre></div>
<h3 id="soup-integration">Soup Integration</h3>
<div class="sourceCode" id="cb47"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Bloom filter itself is a soup object</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;bloom/2026-01-09&quot;</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  (type bloom-filter)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  (variant blocked)           <span class="co">; blocked, counting, or quotient</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  (size <span class="st">&quot;12KB&quot;</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  (crypto (sha256 <span class="st">&quot;bloom-hash...&quot;</span>))</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  (capacity <span class="dv">100000</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  (error-rate <span class="fl">0.01</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  (population <span class="dv">47230</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  (load-factor <span class="fl">0.47</span>))</span></code></pre></div>
<hr />
<h2 id="content-types">Content Types</h2>
<p>Typed objects with schema validation.</p>
<h3 id="type-registry">Type Registry</h3>
<div class="sourceCode" id="cb48"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> content-types</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  &#39;((blob        <span class="op">.</span> <span class="st">&quot;application/octet-stream&quot;</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    (text        <span class="op">.</span> <span class="st">&quot;text/plain&quot;</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    (markdown    <span class="op">.</span> <span class="st">&quot;text/markdown&quot;</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    (scheme      <span class="op">.</span> <span class="st">&quot;text/x-scheme&quot;</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    (sexp        <span class="op">.</span> <span class="st">&quot;application/x-sexp&quot;</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    (json        <span class="op">.</span> <span class="st">&quot;application/json&quot;</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    (pdf         <span class="op">.</span> <span class="st">&quot;application/pdf&quot;</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    (archive     <span class="op">.</span> <span class="st">&quot;application/x-sealed-archive&quot;</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    (key         <span class="op">.</span> <span class="st">&quot;application/x-spki-key&quot;</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    (certificate <span class="op">.</span> <span class="st">&quot;application/x-spki-cert&quot;</span>)))</span></code></pre></div>
<h3 id="typed-storage">Typed Storage</h3>
<div class="sourceCode" id="cb49"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-put/typed </span>content type <span class="ex">#!key</span> schema)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Store with type metadata&quot;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((hash (sha256 content))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>         (meta `(typed-object</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                 (hash ,hash)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                 (type ,type)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                 (size ,(blob-length content))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                 (schema ,schema))))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    (cas-put content)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    (cas-put (serialize meta))</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    hash))</span></code></pre></div>
<h3 id="schema-validation">Schema Validation</h3>
<div class="sourceCode" id="cb50"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-validate </span>hash)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Validate object against its schema&quot;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((meta (cas-get-meta hash))</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>         (schema-hash (typed-object-schema meta))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>         (schema (cas-get schema-hash))</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>         (content (cas-get hash)))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    (schema-validate schema content)))</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Schema is itself content-addressed</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>(soup-object</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  (name <span class="st">&quot;schema/soup-object&quot;</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  (type schema)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  (validates soup-object)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  (crypto (sha256 <span class="st">&quot;schema-hash...&quot;</span>)))</span></code></pre></div>
<h3 id="mime-detection">MIME Detection</h3>
<div class="sourceCode" id="cb51"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-detect-type </span>content)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Detect content type from magic bytes&quot;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    ((pdf-magic? content) &#39;pdf)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    ((gzip-magic? content) &#39;archive)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    ((utf8-text? content)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">cond</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>       ((sexp-syntax? content) &#39;sexp)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>       ((markdown-syntax? content) &#39;markdown)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">else</span> &#39;text)))</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">else</span> &#39;blob)))</span></code></pre></div>
<hr />
<h2 id="object-capabilities">Object Capabilities</h2>
<p>Content addresses as capabilities: if you know the hash, you can
retrieve it.</p>
<h3 id="hash-as-capability">Hash as Capability</h3>
<div class="sourceCode" id="cb52"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Knowledge of hash grants read access</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-get-if-known </span>hash)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Capability-based retrieval&quot;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (valid-hash? hash)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>      (cas-get hash)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;Invalid capability&quot;</span>)))</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Hashes are unguessable (256-bit entropy)</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Sharing a hash = sharing read access</span></span></code></pre></div>
<h3 id="capability-attenuation">Capability Attenuation</h3>
<div class="sourceCode" id="cb53"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; SPKI certificate granting access to specific content</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>(spki-cert</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  (issuer vault-key)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  (subject reader-key)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  (permission (<span class="kw">read</span> (hash sha256 <span class="st">&quot;specific-content...&quot;</span>)))</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  (validity (not-after <span class="st">&quot;2027-01-01&quot;</span>)))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Grant access to a subtree</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>(spki-cert</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  (issuer vault-key)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  (subject reader-key)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  (permission (<span class="kw">read</span> (tree sha256 <span class="st">&quot;subtree-root...&quot;</span>)))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  (propagate <span class="dv">#t</span>))  <span class="co">; Access to all referenced objects</span></span></code></pre></div>
<h3 id="sealed-capabilities">Sealed Capabilities</h3>
<div class="sourceCode" id="cb54"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Encrypted capability - only holder of key can use</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">seal-capability </span>hash recipient-key)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((cap `(capability</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>               (object ,hash)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>               (granted-at ,(current-seconds)))))</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    (age-encrypt (serialize cap) recipient-key)))</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Recipient decrypts to obtain hash</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">unseal-capability </span>sealed-cap identity)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((cap (deserialize (age-decrypt sealed-cap identity))))</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    (capability-object cap)))</span></code></pre></div>
<h3 id="capability-revocation">Capability Revocation</h3>
<div class="sourceCode" id="cb55"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Revocation via tombstone</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">revoke-capability </span>hash)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  (cas-tombstone hash reason: <span class="st">&quot;Capability revoked&quot;</span>))</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; Or via SPKI CRL</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>(spki-crl</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  (issuer vault-key)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  (revoked</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    ((hash sha256 <span class="st">&quot;revoked-content...&quot;</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>     (reason <span class="st">&quot;Superseded&quot;</span>)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>     (revoked-at <span class="dv">1767700000</span>))))</span></code></pre></div>
<hr />
<h2 id="hash-migration">Hash Migration</h2>
<p>When cryptographic algorithms weaken, the system must migrate.</p>
<h3 id="multihash">Multihash</h3>
<div class="sourceCode" id="cb56"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Self-describing hash format</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">multihash </span>algo data)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((hash (<span class="kw">case</span> algo</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                ((sha256) (sha256 data))</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                ((sha384) (sha384 data))</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>                ((sha512) (sha512 data))</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                ((blake3) (blake3 data)))))</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span> algo (blob-length hash) hash)))</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse multihash</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">multihash-algorithm </span>mh) (<span class="kw">car</span> mh))</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">multihash-digest </span>mh) (<span class="kw">caddr</span> mh))</span></code></pre></div>
<h3 id="dual-hash-period">Dual-Hash Period</h3>
<div class="sourceCode" id="cb57"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; During migration, store under both hashes</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-put/migrate </span>content old-algo new-algo)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((old-hash (hash-with old-algo content))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>        (new-hash (hash-with new-algo content)))</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    (cas-put-raw old-hash content)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    (cas-put-raw new-hash content)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Link old to new</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    (ref-set (<span class="kw">string-append</span> <span class="st">&quot;migrate/&quot;</span> old-hash) new-hash)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    new-hash))</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lookup follows migration links</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-get/migrate </span>hash)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((migrated (ref-get (<span class="kw">string-append</span> <span class="st">&quot;migrate/&quot;</span> hash))))</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    (cas-get (<span class="kw">or</span> migrated hash))))</span></code></pre></div>
<h3 id="migration-manifest">Migration Manifest</h3>
<div class="sourceCode" id="cb58"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(migration-manifest</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  (from-algorithm sha256)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  (to-algorithm sha384)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  (started-at <span class="dv">1767700000</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  (status in-progress)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  (migrated <span class="dv">4723</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  (remaining <span class="dv">1892</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  (mappings</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    ((<span class="st">&quot;sha256:abc...&quot;</span> <span class="op">.</span> <span class="st">&quot;sha384:def...&quot;</span>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;sha256:123...&quot;</span> <span class="op">.</span> <span class="st">&quot;sha384:456...&quot;</span>)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>     <span class="op">...</span>)))</span></code></pre></div>
<h3 id="verification-during-migration">Verification During
Migration</h3>
<div class="sourceCode" id="cb59"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">verify-migration </span>hash)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Verify object under both old and new hash&quot;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((content (cas-get hash))</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>         (old-hash (sha256 content))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>         (new-hash (sha384 content)))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">and</span> (<span class="kw">or</span> (<span class="kw">equal?</span> hash old-hash)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">equal?</span> hash new-hash))</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">equal?</span> (ref-get (<span class="kw">string-append</span> <span class="st">&quot;migrate/&quot;</span> old-hash))</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                 new-hash))))</span></code></pre></div>
<hr />
<h2 id="comparison-with-related-systems">Comparison with Related
Systems</h2>
<table>
<thead>
<tr>
<th>System</th>
<th>Hash</th>
<th>Chunking</th>
<th>Naming</th>
</tr>
</thead>
<tbody>
<tr>
<td>Git</td>
<td>SHA-1</td>
<td>Pack files</td>
<td>refs/branches</td>
</tr>
<tr>
<td>IPFS</td>
<td>SHA-256/multihash</td>
<td>Rabin</td>
<td>IPNS, DNSLink</td>
</tr>
<tr>
<td>Perkeep</td>
<td>SHA-224</td>
<td>Rolling hash</td>
<td>Permanodes</td>
</tr>
<tr>
<td>Library CAS</td>
<td>SHA-256</td>
<td>Configurable</td>
<td>Vault refs</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="hash-collision-attacks">Hash Collision Attacks</h3>
<p>SHA-256 provides 128-bit collision resistance. No practical attacks
known.</p>
<p>If SHA-256 is ever broken:</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Multihash for algorithm agility</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">multihash </span>algo data)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> algo</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    ((sha256) (<span class="kw">cons</span> &#39;sha256 (sha256 data)))</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    ((sha384) (<span class="kw">cons</span> &#39;sha384 (sha384 data)))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    ((blake3) (<span class="kw">cons</span> &#39;blake3 (blake3 data)))))</span></code></pre></div>
<h3 id="length-extension-attacks">Length Extension Attacks</h3>
<p>SHA-256 is vulnerable to length extension. For authentication, use
HMAC:</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-mac </span>key hash)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  (hmac-sha256 key hash))</span></code></pre></div>
<h3 id="timing-attacks">Timing Attacks</h3>
<p>Hash comparison MUST be constant-time:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">hash-equal? </span>a b)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((result <span class="dv">0</span>))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">do</span> ((i <span class="dv">0</span> (<span class="op">+</span> i <span class="dv">1</span>)))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        ((<span class="op">=</span> i <span class="dv">32</span>) (<span class="kw">zero?</span> result))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> result (<span class="kw">bitwise-ior</span> result</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">bitwise-xor</span> (blob-ref a i) (blob-ref b i)))))))</span></code></pre></div>
<hr />
<h2 id="performance-considerations">Performance Considerations</h2>
<h3 id="caching">Caching</h3>
<div class="sourceCode" id="cb63"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; LRU cache for hot objects</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> cas-cache </span>(make-lru-cache <span class="dv">1000</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-get/cached </span>hash)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (lru-get cas-cache hash)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> ((content (cas-get hash)))</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        (lru-put! cas-cache hash content)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        content)))</span></code></pre></div>
<h3 id="parallel-hashing">Parallel Hashing</h3>
<p>Large files benefit from parallel hashing of chunks.</p>
<h3 id="ssd-optimization">SSD Optimization</h3>
<p>Random access pattern. Use write-ahead log for durability:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">cas-put/durable </span>content)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((hash (sha256 content)))</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    (wal-append hash content)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    (write-blob (hash-&gt;path hash) content)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    (wal-commit hash)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    hash))</span></code></pre></div>
<hr />
<h2 id="implementation-notes">Implementation Notes</h2>
<h3 id="dependencies">Dependencies</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Library</th>
</tr>
</thead>
<tbody>
<tr>
<td>SHA-256</td>
<td>message-digest, sha2</td>
</tr>
<tr>
<td>Blob I/O</td>
<td>CHICKEN I/O</td>
</tr>
<tr>
<td>Chunking</td>
<td>Custom</td>
</tr>
</tbody>
</table>
<h3 id="error-handling">Error Handling</h3>
<div class="sourceCode" id="cb65"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition-type</span> &amp;cas-error <span class="kw">&amp;error</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  cas-error?</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  (hash cas-error-hash))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition-type</span> &amp;cas-not-found &amp;cas-error</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  cas-not-found?)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define-condition-type</span> &amp;cas-corrupt &amp;cas-error</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  cas-corrupt?)</span></code></pre></div>
<hr />
<h2 id="references-1">References</h2>
<ol type="1">
<li>Merkle, R. (1987), “A Digital Signature Based on a Conventional
Encryption Function”</li>
<li>Git Internals - Git Objects</li>
<li>IPFS Content Addressing</li>
<li>Putze, Sanders, Singler (2007), “Cache-, Hash-, and Space-Efficient
Bloom Filters”</li>
<li>Bender et al. (2012), “Don’t Thrash: How to Cache Your Hash on
Flash”</li>
<li>RFC-006: Vault System Architecture</li>
<li>RFC-018: Sealed Archive Format</li>
</ol>
<hr />
<h2 id="changelog">Changelog</h2>
<ul>
<li><strong>2026-01-09</strong> - Advanced probabilistic data
structures: blocked Bloom filters, counting Bloom filters, quotient
filters, hierarchical existence checking</li>
<li><strong>2026-01-07</strong> - Initial draft</li>
</ul>
<hr />
<p><strong>Implementation Status:</strong> Draft
<strong>Dependencies:</strong> sha2, message-digest
<strong>Integration:</strong> Vault, Replication, SPKI</p>
</body>
</html>
