%!PS-Adobe-3.0
%%BoundingBox: 24 24 571 818
%%Title: Enscript Output
%%For: Derrell Piper
%%Creator: GNU Enscript 1.6.6
%%CreationDate: Fri Jan  9 12:28:50 2026
%%Orientation: Portrait
%%Pages: (atend)
%%DocumentMedia: A4 595 842 0 () ()
%%DocumentNeededResources: (atend)
%%EndComments
%%BeginProlog
%%BeginResource: procset Enscript-Prolog 1.6 6
%
% Procedures.
%

/_S {	% save current state
  /_s save def
} def
/_R {	% restore from saved state
  _s restore
} def

/S {	% showpage protecting gstate
  gsave
  showpage
  grestore
} bind def

/MF {	% fontname newfontname -> -	make a new encoded font
  /newfontname exch def
  /fontname exch def

  /fontdict fontname findfont def
  /newfont fontdict maxlength dict def

  fontdict {
    exch
    dup /FID eq {
      % skip FID pair
      pop pop
    } {
      % copy to the new font dictionary
      exch newfont 3 1 roll put
    } ifelse
  } forall

  newfont /FontName newfontname put

  % insert only valid encoding vectors
  encoding_vector length 256 eq {
    newfont /Encoding encoding_vector put
  } if

  newfontname newfont definefont pop
} def

/MF_PS { % fontname newfontname -> -	make a new font preserving its enc
  /newfontname exch def
  /fontname exch def

  /fontdict fontname findfont def
  /newfont fontdict maxlength dict def

  fontdict {
    exch
    dup /FID eq {
      % skip FID pair
      pop pop
    } {
      % copy to the new font dictionary
      exch newfont 3 1 roll put
    } ifelse
  } forall

  newfont /FontName newfontname put

  newfontname newfont definefont pop
} def

/SF { % fontname width height -> -	set a new font
  /height exch def
  /width exch def

  findfont
  [width 0 0 height 0 0] makefont setfont
} def

/SUF { % fontname width height -> -	set a new user font
  /height exch def
  /width exch def

  /F-gs-user-font MF
  /F-gs-user-font width height SF
} def

/SUF_PS { % fontname width height -> -	set a new user font preserving its enc
  /height exch def
  /width exch def

  /F-gs-user-font MF_PS
  /F-gs-user-font width height SF
} def

/M {moveto} bind def
/s {show} bind def

/Box {	% x y w h -> -			define box path
  /d_h exch def /d_w exch def /d_y exch def /d_x exch def
  d_x d_y  moveto
  d_w 0 rlineto
  0 d_h rlineto
  d_w neg 0 rlineto
  closepath
} def

/bgs {	% x y height blskip gray str -> -	show string with bg color
  /str exch def
  /gray exch def
  /blskip exch def
  /height exch def
  /y exch def
  /x exch def

  gsave
    x y blskip sub str stringwidth pop height Box
    gray setgray
    fill
  grestore
  x y M str s
} def

/bgcs { % x y height blskip red green blue str -> -  show string with bg color
  /str exch def
  /blue exch def
  /green exch def
  /red exch def
  /blskip exch def
  /height exch def
  /y exch def
  /x exch def

  gsave
    x y blskip sub str stringwidth pop height Box
    red green blue setrgbcolor
    fill
  grestore
  x y M str s
} def

% Highlight bars.
/highlight_bars {	% nlines lineheight output_y_margin gray -> -
  gsave
    setgray
    /ymarg exch def
    /lineheight exch def
    /nlines exch def

    % This 2 is just a magic number to sync highlight lines to text.
    0 d_header_y ymarg sub 2 sub translate

    /cw d_output_w cols div def
    /nrows d_output_h ymarg 2 mul sub lineheight div cvi def

    % for each column
    0 1 cols 1 sub {
      cw mul /xp exch def

      % for each rows
      0 1 nrows 1 sub {
        /rn exch def
        rn lineheight mul neg /yp exch def
        rn nlines idiv 2 mod 0 eq {
	  % Draw highlight bar.  4 is just a magic indentation.
	  xp 4 add yp cw 8 sub lineheight neg Box fill
	} if
      } for
    } for

  grestore
} def

% Line highlight bar.
/line_highlight {	% x y width height gray -> -
  gsave
    /gray exch def
    Box gray setgray fill
  grestore
} def

% Column separator lines.
/column_lines {
  gsave
    .1 setlinewidth
    0 d_footer_h translate
    /cw d_output_w cols div def
    1 1 cols 1 sub {
      cw mul 0 moveto
      0 d_output_h rlineto stroke
    } for
  grestore
} def

% Column borders.
/column_borders {
  gsave
    .1 setlinewidth
    0 d_footer_h moveto
    0 d_output_h rlineto
    d_output_w 0 rlineto
    0 d_output_h neg rlineto
    closepath stroke
  grestore
} def

% Do the actual underlay drawing
/draw_underlay {
  ul_style 0 eq {
    ul_str true charpath stroke
  } {
    ul_str show
  } ifelse
} def

% Underlay
/underlay {	% - -> -
  gsave
    0 d_page_h translate
    d_page_h neg d_page_w atan rotate

    ul_gray setgray
    ul_font setfont
    /dw d_page_h dup mul d_page_w dup mul add sqrt def
    ul_str stringwidth pop dw exch sub 2 div ul_h_ptsize -2 div moveto
    draw_underlay
  grestore
} def

/user_underlay {	% - -> -
  gsave
    ul_x ul_y translate
    ul_angle rotate
    ul_gray setgray
    ul_font setfont
    0 0 ul_h_ptsize 2 div sub moveto
    draw_underlay
  grestore
} def

% Page prefeed
/page_prefeed {		% bool -> -
  statusdict /prefeed known {
    statusdict exch /prefeed exch put
  } {
    pop
  } ifelse
} def

% Wrapped line markers
/wrapped_line_mark {	% x y charwith charheight type -> -
  /type exch def
  /h exch def
  /w exch def
  /y exch def
  /x exch def

  type 2 eq {
    % Black boxes (like TeX does)
    gsave
      0 setlinewidth
      x w 4 div add y M
      0 h rlineto w 2 div 0 rlineto 0 h neg rlineto
      closepath fill
    grestore
  } {
    type 3 eq {
      % Small arrows
      gsave
        .2 setlinewidth
        x w 2 div add y h 2 div add M
        w 4 div 0 rlineto
        x w 4 div add y lineto stroke

        x w 4 div add w 8 div add y h 4 div add M
        x w 4 div add y lineto
	w 4 div h 8 div rlineto stroke
      grestore
    } {
      % do nothing
    } ifelse
  } ifelse
} def

% EPSF import.

/BeginEPSF {
  /b4_Inc_state save def    		% Save state for cleanup
  /dict_count countdictstack def	% Count objects on dict stack
  /op_count count 1 sub def		% Count objects on operand stack
  userdict begin
  /showpage { } def
  0 setgray 0 setlinecap
  1 setlinewidth 0 setlinejoin
  10 setmiterlimit [ ] 0 setdash newpath
  /languagelevel where {
    pop languagelevel
    1 ne {
      false setstrokeadjust false setoverprint
    } if
  } if
} bind def

/EndEPSF {
  count op_count sub { pos } repeat	% Clean up stacks
  countdictstack dict_count sub { end } repeat
  b4_Inc_state restore
} bind def

% Check PostScript language level.
/languagelevel where {
  pop /gs_languagelevel languagelevel def
} {
  /gs_languagelevel 1 def
} ifelse
%%EndResource
%%BeginResource: procset Enscript-Encoding-88591 1.6 6
/encoding_vector [
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/space        	/exclam       	/quotedbl     	/numbersign   	
/dollar       	/percent      	/ampersand    	/quoteright   	
/parenleft    	/parenright   	/asterisk     	/plus         	
/comma        	/hyphen       	/period       	/slash        	
/zero         	/one          	/two          	/three        	
/four         	/five         	/six          	/seven        	
/eight        	/nine         	/colon        	/semicolon    	
/less         	/equal        	/greater      	/question     	
/at           	/A            	/B            	/C            	
/D            	/E            	/F            	/G            	
/H            	/I            	/J            	/K            	
/L            	/M            	/N            	/O            	
/P            	/Q            	/R            	/S            	
/T            	/U            	/V            	/W            	
/X            	/Y            	/Z            	/bracketleft  	
/backslash    	/bracketright 	/asciicircum  	/underscore   	
/quoteleft    	/a            	/b            	/c            	
/d            	/e            	/f            	/g            	
/h            	/i            	/j            	/k            	
/l            	/m            	/n            	/o            	
/p            	/q            	/r            	/s            	
/t            	/u            	/v            	/w            	
/x            	/y            	/z            	/braceleft    	
/bar          	/braceright   	/tilde        	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/space        	/exclamdown   	/cent         	/sterling     	
/currency     	/yen          	/brokenbar    	/section      	
/dieresis     	/copyright    	/ordfeminine  	/guillemotleft	
/logicalnot   	/hyphen       	/registered   	/macron       	
/degree       	/plusminus    	/twosuperior  	/threesuperior	
/acute        	/mu           	/paragraph    	/bullet       	
/cedilla      	/onesuperior  	/ordmasculine 	/guillemotright	
/onequarter   	/onehalf      	/threequarters	/questiondown 	
/Agrave       	/Aacute       	/Acircumflex  	/Atilde       	
/Adieresis    	/Aring        	/AE           	/Ccedilla     	
/Egrave       	/Eacute       	/Ecircumflex  	/Edieresis    	
/Igrave       	/Iacute       	/Icircumflex  	/Idieresis    	
/Eth          	/Ntilde       	/Ograve       	/Oacute       	
/Ocircumflex  	/Otilde       	/Odieresis    	/multiply     	
/Oslash       	/Ugrave       	/Uacute       	/Ucircumflex  	
/Udieresis    	/Yacute       	/Thorn        	/germandbls   	
/agrave       	/aacute       	/acircumflex  	/atilde       	
/adieresis    	/aring        	/ae           	/ccedilla     	
/egrave       	/eacute       	/ecircumflex  	/edieresis    	
/igrave       	/iacute       	/icircumflex  	/idieresis    	
/eth          	/ntilde       	/ograve       	/oacute       	
/ocircumflex  	/otilde       	/odieresis    	/divide       	
/oslash       	/ugrave       	/uacute       	/ucircumflex  	
/udieresis    	/yacute       	/thorn        	/ydieresis    	
] def
%%EndResource
%%EndProlog
%%BeginSetup
%%IncludeResource: font Courier-Bold
%%IncludeResource: font Courier
/HFpt_w 10 def
/HFpt_h 10 def
/Courier-Bold /HF-gs-font MF
/HF /HF-gs-font findfont [HFpt_w 0 0 HFpt_h 0 0] makefont def
/Courier /F-gs-font MF
/F-gs-font 10 10 SF
/#copies 1 def
% Pagedevice definitions:
gs_languagelevel 1 gt {
  <<
    /PageSize [595 842] 
  >> setpagedevice
} if
/d_page_w 547 def
/d_page_h 794 def
/d_header_x 0 def
/d_header_y 794 def
/d_header_w 547 def
/d_header_h 0 def
/d_footer_x 0 def
/d_footer_y 0 def
/d_footer_w 547 def
/d_footer_h 0 def
/d_output_w 547 def
/d_output_h 794 def
/cols 1 def
%%EndSetup
%%Page: (1) 1
%%BeginPageSetup
_S
24 24 translate
/pagenum 1 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(RFC-020: Content-Addressed Storage) s
5 759 M
(Status: Draft) s
5 748 M
(Date: January 2026) s
5 737 M
(Author: Derrell Piper <ddp@eludom.net>) s
5 726 M
(Implementation: Proposed) s
5 704 M
(------------------------------------------------------------------------------) s
5 682 M
(Abstract) s
5 660 M
(This RFC specifies content-addressed storage \(CAS\) for the Library of Cyberspace: a stora) s
5 649 M
(ge model where data is addressed by its cryptographic hash rather than by location. Conte) s
5 638 M
(nt addressing provides immutability guarantees, automatic deduplication, and tamper-evide) s
5 627 M
(nt storage.) s
5 605 M
(------------------------------------------------------------------------------) s
5 583 M
(Motivation) s
5 561 M
(Traditional storage systems use location-based addressing:) s
5 539 M
(- DECtape: Physical position on magnetic tape) s
5 528 M
(- Filesystems: Path names \(/home/ddp/file.txt\)) s
5 517 M
(- Databases: Row IDs, primary keys) s
5 506 M
(- URLs: Server + path \(https://example.com/doc.ps\)) s
5 484 M
(Location-based addressing has fundamental problems:) s
5 462 M
(1. Mutability - Same address can point to different content over time) s
5 451 M
(2. Link rot - Addresses become invalid when content moves) s
5 440 M
(3. Duplication - Identical content stored multiple times) s
5 429 M
(4. No verification - Address doesn't prove content integrity) s
5 407 M
(Content-addressed storage inverts this:) s
5 385 M
(Location-based:  address \342\\206\\222 content \(many-to-one, mutable\)) s
5 374 M
(Content-based:   content \342\\206\\222 address \(one-to-one, immutable\)) s
5 352 M
(The address IS the content's cryptographic fingerprint. If the content changes, the addre) s
5 341 M
(ss changes. If two files have the same address, they are byte-for-byte identical.) s
5 319 M
(------------------------------------------------------------------------------) s
5 297 M
(Content Addressing Model) s
5 275 M
(Hash as Address) s
5 253 M
(;; Content determines address) s
5 242 M
(\(define \(content-address data\)) s
5 231 M
(  \(sha256 data\)\)) s
5 209 M
(;; Store by hash) s
5 198 M
(\(define \(cas-store data\)) s
5 187 M
(  \(let \(\(hash \(content-address data\)\)\)) s
5 176 M
(    \(write-blob \(hash->path hash\) data\)) s
5 165 M
(    hash\)\)) s
5 143 M
(;; Retrieve by hash) s
5 132 M
(\(define \(cas-retrieve hash\)) s
5 121 M
(  \(let \(\(data \(read-blob \(hash->path hash\)\)\)\)) s
5 110 M
(    \(if \(equal? hash \(content-address data\)\)) s
5 99 M
(        data) s
5 88 M
(        \(error "Content tampered"\)\)\)\)) s
5 66 M
(Properties) s
5 44 M
(| Property | Location-Based | Content-Addressed |) s
5 33 M
(|----------|---------------|-------------------|) s
5 22 M
(| Address stability | Unstable | Permanent |) s
5 11 M
(| Content verification | External | Intrinsic |) s
_R
S
%%Page: (2) 2
%%BeginPageSetup
_S
24 24 translate
/pagenum 2 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(| Deduplication | Manual | Automatic |) s
5 770 M
(| Mutability | Mutable | Immutable |) s
5 759 M
(| Link rot | Common | Impossible |) s
5 737 M
(Hash Function Requirements) s
5 715 M
(The hash function MUST be:) s
5 693 M
(1. Collision-resistant - Computationally infeasible to find two inputs with same hash) s
5 682 M
(2. Preimage-resistant - Cannot derive content from hash) s
5 671 M
(3. Deterministic - Same content always produces same hash) s
5 660 M
(4. Fast - Practical for large objects) s
5 638 M
(Specified hash: SHA-256 \(32 bytes, 64 hex characters\)) s
5 616 M
(;; Example content address) s
5 605 M
("e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855") s
5 594 M
(;; This is the SHA-256 of the empty string) s
5 572 M
(------------------------------------------------------------------------------) s
5 550 M
(Storage Architecture) s
5 528 M
(Object Store) s
5 506 M
(.cas/) s
5 495 M
(+-- objects/) s
5 484 M
(|   +-- e3/) s
5 473 M
(|   |   +-- b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855) s
5 462 M
(|   +-- a7/) s
5 451 M
(|   |   +-- ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a) s
5 440 M
(|   +-- ...) s
5 429 M
(+-- refs/) s
5 418 M
(|   +-- HEAD) s
5 407 M
(|   +-- tags/) s
5 396 M
(+-- index) s
5 374 M
(Sharding: First two hex characters of hash form directory name \(256 buckets\).) s
5 352 M
(Object Types) s
5 330 M
(;; Blob - raw data) s
5 319 M
(\(cas-blob) s
5 308 M
(  \(hash "sha256:..."\)) s
5 297 M
(  \(size 1024\)) s
5 286 M
(  \(data #${...}\)\)) s
5 264 M
(;; Tree - directory structure) s
5 253 M
(\(cas-tree) s
5 242 M
(  \(hash "sha256:..."\)) s
5 231 M
(  \(entries) s
5 220 M
(    \(\("README.md" blob "sha256:abc..."\)) s
5 209 M
(     \("src" tree "sha256:def..."\)) s
5 198 M
(     \("lib" tree "sha256:ghi..."\)\)\)\)) s
5 176 M
(;; Commit - snapshot with metadata) s
5 165 M
(\(cas-commit) s
5 154 M
(  \(hash "sha256:..."\)) s
5 143 M
(  \(tree "sha256:..."\)) s
5 132 M
(  \(parent "sha256:..." | #f\)) s
5 121 M
(  \(author "ddp@eludom.net"\)) s
5 110 M
(  \(timestamp 1767700000\)) s
5 99 M
(  \(message "Initial commit"\)\)) s
5 77 M
(Merkle Trees) s
5 55 M
(Directories are trees of hashes. The root hash commits to all content:) s
5 33 M
(                    root: sha256:abc...) s
5 22 M
(                         /          \\) s
5 11 M
(              src: sha256:def     lib: sha256:ghi) s
_R
S
%%Page: (3) 3
%%BeginPageSetup
_S
24 24 translate
/pagenum 3 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(               /        \\              |) s
5 770 M
(        main.scm     test.scm      util.scm) s
5 759 M
(        sha256:111   sha256:222    sha256:333) s
5 737 M
(Changing ANY file changes ALL parent hashes up to root.) s
5 715 M
(------------------------------------------------------------------------------) s
5 693 M
(Operations) s
5 671 M
(Store) s
5 649 M
(\(define \(cas-put content\)) s
5 638 M
(  "Store content, return hash") s
5 627 M
(  \(let* \(\(hash \(sha256 content\)\)) s
5 616 M
(         \(path \(hash->path hash\)\)\)) s
5 605 M
(    \(unless \(file-exists? path\)) s
5 594 M
(      \(write-blob path content\)\)) s
5 583 M
(    hash\)\)) s
5 561 M
(Deduplication: If hash already exists, storage is a no-op.) s
5 539 M
(Retrieve) s
5 517 M
(\(define \(cas-get hash\)) s
5 506 M
(  "Retrieve content by hash, verify integrity") s
5 495 M
(  \(let* \(\(path \(hash->path hash\)\)) s
5 484 M
(         \(content \(read-blob path\)\)\)) s
5 473 M
(    \(unless \(equal? hash \(sha256 content\)\)) s
5 462 M
(      \(error "Content integrity failure" hash\)\)) s
5 451 M
(    content\)\)) s
5 429 M
(Self-verifying: Every retrieval confirms integrity.) s
5 407 M
(Exists) s
5 385 M
(\(define \(cas-exists? hash\)) s
5 374 M
(  "Check if content exists") s
5 363 M
(  \(file-exists? \(hash->path hash\)\)\)) s
5 341 M
(Delete) s
5 319 M
(\(define \(cas-gc roots\)) s
5 308 M
(  "Garbage collect unreachable objects") s
5 297 M
(  \(let \(\(reachable \(trace-reachable roots\)\)\)) s
5 286 M
(    \(for-each) s
5 275 M
(      \(lambda \(hash\)) s
5 264 M
(        \(unless \(set-member? reachable hash\)) s
5 253 M
(          \(delete-file \(hash->path hash\)\)\)\)) s
5 242 M
(      \(all-objects\)\)\)\)) s
5 220 M
(Note: Deletion requires garbage collection from known roots.) s
5 198 M
(------------------------------------------------------------------------------) s
5 176 M
(Naming Layer) s
5 154 M
(Content addresses are not human-friendly. A naming layer maps names to hashes:) s
5 132 M
(References) s
5 110 M
(;; Mutable reference to immutable content) s
5 99 M
(\(define \(ref-set name hash\)) s
5 88 M
(  \(write-file \(ref-path name\) hash\)\)) s
5 66 M
(\(define \(ref-get name\)) s
5 55 M
(  \(read-file \(ref-path name\)\)\)) s
5 33 M
(;; Example) s
5 22 M
(\(ref-set "HEAD" "sha256:abc123..."\)) s
5 11 M
(\(ref-get "HEAD"\) ; => "sha256:abc123...") s
_R
S
%%Page: (4) 4
%%BeginPageSetup
_S
24 24 translate
/pagenum 4 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(Tags) s
5 748 M
(;; Immutable named reference) s
5 737 M
(\(define \(tag-create name hash #!key message signature\)) s
5 726 M
(  \(let \(\(tag-content) s
5 715 M
(         `\(tag) s
5 704 M
(           \(name ,name\)) s
5 693 M
(           \(object ,hash\)) s
5 682 M
(           \(message ,message\)) s
5 671 M
(           \(signature ,signature\)\)\)\)) s
5 660 M
(    \(cas-put \(serialize tag-content\)\)\)\)) s
5 638 M
(Directory Entries) s
5 616 M
(;; Human name -> content hash) s
5 605 M
(\(define library-index) s
5 594 M
(  '\(\("RFC-000" . "sha256:e3b0c44..."\)) s
5 583 M
(    \("RFC-001" . "sha256:a7ffc6f..."\)) s
5 572 M
(    \("RFC-002" . "sha256:b94d27b..."\)\)\)) s
5 550 M
(------------------------------------------------------------------------------) s
5 528 M
(The Soup: Object Directory) s
5 506 M
(Content-addressed storage provides retrieval by hash, but discovery requires an object di) s
5 495 M
(rectory. The Soup \(inspired by NewtonOS\) provides a unified view of all objects with rich) s
5 484 M
( metadata.) s
5 462 M
(Philosophy) s
5 440 M
(  "The soup is infinite." - Objects swim in a queryable sea of metadata.) s
5 418 M
(The Soup inverts the traditional filesystem model:) s
5 396 M
(- Filesystem: Navigate hierarchy to find objects) s
5 385 M
(- Soup: Query attributes to discover objects) s
5 363 M
(Object Enumeration) s
5 341 M
(\(define \(soup\)) s
5 330 M
(  "List all objects in the vault with metadata") s
5 319 M
(  \(append) s
5 308 M
(    \(soup-releases\)      ; Signed releases) s
5 297 M
(    \(soup-archives\)      ; Sealed archives) s
5 286 M
(    \(soup-keys\)          ; Cryptographic keys) s
5 275 M
(    \(soup-audit-entries\) ; Audit trail) s
5 264 M
(    \(soup-commits\)\)\)     ; Recent commits) s
5 242 M
(Rich Metadata) s
5 220 M
(Every object carries crypto metadata - the ciphers, hashes, and keys involved:) s
5 198 M
(;; Archive object) s
5 187 M
(\(soup-object) s
5 176 M
(  \(name "1.0.0"\)) s
5 165 M
(  \(type archive\)) s
5 154 M
(  \(size "1.2MB"\)) s
5 143 M
(  \(crypto \(zstd sha256 "fe378a78..."\)\)\)) s
5 121 M
(;; Key object) s
5 110 M
(\(soup-object) s
5 99 M
(  \(name "vault-signing"\)) s
5 88 M
(  \(type key\)) s
5 77 M
(  \(size "64B"\)) s
5 66 M
(  \(crypto \(ed25519/256 public sign) s
5 55 M
(           "sha256:a1b2c3d4..."    ; fingerprint) s
5 44 M
(           "id:ddp@eludom.net"     ; identity) s
5 33 M
(           "2026-01-07"\)\)\)         ; creation date) s
5 11 M
(;; Release object) s
_R
S
%%Page: (5) 5
%%BeginPageSetup
_S
24 24 translate
/pagenum 5 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(\(soup-object) s
5 770 M
(  \(name "0.1.0"\)) s
5 759 M
(  \(type release\)) s
5 748 M
(  \(size "313B"\)) s
5 737 M
(  \(crypto \(ed25519 sha512 "abc123..."\)\)\)) s
5 715 M
(Querying the Soup) s
5 693 M
(;; Find all signed objects) s
5 682 M
(\(soup-query type: 'release\)) s
5 660 M
(;; Find objects using specific algorithm) s
5 649 M
(\(soup-query crypto: 'ed25519\)) s
5 627 M
(;; Find objects by size range) s
5 616 M
(\(soup-query min-size: 1000 max-size: 100000\)) s
5 594 M
(;; Find objects by content hash prefix) s
5 583 M
(\(soup-query hash-prefix: "fe378"\)) s
5 561 M
(Display Format) s
5 539 M
(The soup displays as a compact, human-readable listing:) s
5 517 M
($ seal-soup) s
5 506 M
(vault-signing, 64B, ed25519/256, public, sign, sha256:a1b2c3d4...) s
5 495 M
(0.1.0, 313B, signed, ed25519, sha512) s
5 484 M
(1.0.0, 1.2MB, zstd, sha256, fe378a78...) s
5 473 M
(audit/1, sealed, 2026-01-07T10:30:00Z) s
5 451 M
(Soup as Index) s
5 429 M
(The Soup can be serialized as a content-addressed index:) s
5 407 M
(\(define \(soup-snapshot\)) s
5 396 M
(  "Create content-addressed snapshot of current soup") s
5 385 M
(  \(let* \(\(entries \(soup\)\)) s
5 374 M
(         \(serialized \(serialize entries\)\)) s
5 363 M
(         \(hash \(cas-put serialized\)\)\)) s
5 352 M
(    \(ref-set "soup/HEAD" hash\)) s
5 341 M
(    hash\)\)) s
5 319 M
(This enables:) s
5 308 M
(- Time travel: Load historical soup snapshots) s
5 297 M
(- Replication: Sync soup indexes between vaults) s
5 286 M
(- Verification: Prove soup state at a point in time) s
5 264 M
(------------------------------------------------------------------------------) s
5 242 M
(Integration with Library of Cyberspace) s
5 220 M
(Vault Integration) s
5 198 M
(The Vault \(RFC-006\) uses content addressing internally via Git:) s
5 176 M
(;; Git objects ARE content-addressed) s
5 165 M
(\(define \(git-hash-object content\)) s
5 154 M
(  \(sha1 \(string-append "blob " \(number->string \(blob-length content\)\) "\\x00" content\)\)\)) s
5 132 M
(CAS extends this with SHA-256 and Library-specific semantics.) s
5 110 M
(Archive Storage) s
5 88 M
(Sealed archives \(RFC-018\) can be stored by content address:) s
5 66 M
(\(define \(archive-to-cas archive-path\)) s
5 55 M
(  \(let* \(\(content \(read-blob archive-path\)\)) s
5 44 M
(         \(hash \(cas-put content\)\)\)) s
5 33 M
(    \(ref-set \(string-append "archives/" \(archive-version archive-path\)\) hash\)) s
5 22 M
(    hash\)\)) s
_R
S
%%Page: (6) 6
%%BeginPageSetup
_S
24 24 translate
/pagenum 6 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(Replication) s
5 759 M
(Content addressing enables efficient replication \(RFC-001\):) s
5 737 M
(;; Only transfer objects receiver doesn't have) s
5 726 M
(\(define \(replicate-to remote root-hash\)) s
5 715 M
(  \(for-each) s
5 704 M
(    \(lambda \(hash\)) s
5 693 M
(      \(unless \(remote-has? remote hash\)) s
5 682 M
(        \(remote-put remote hash \(cas-get hash\)\)\)\)) s
5 671 M
(    \(trace-reachable root-hash\)\)\)) s
5 649 M
(SPKI Integration) s
5 627 M
(Content hashes can be authorization subjects \(RFC-004\):) s
5 605 M
(;; Grant permission to specific content) s
5 594 M
(\(spki-cert) s
5 583 M
(  \(issuer publisher-key\)) s
5 572 M
(  \(subject \(hash sha256 "abc123..."\)\)) s
5 561 M
(  \(permission read\)) s
5 550 M
(  \(validity \(not-after "2027-01-01"\)\)\)) s
5 528 M
(------------------------------------------------------------------------------) s
5 506 M
(Chunking for Large Objects) s
5 484 M
(Large files are split into chunks for:) s
5 462 M
(1. Deduplication at sub-file granularity) s
5 451 M
(2. Parallel transfer) s
5 440 M
(3. Incremental updates) s
5 418 M
(Fixed-Size Chunking) s
5 396 M
(\(define chunk-size \(* 64 1024\)\)  ; 64KB) s
5 374 M
(\(define \(chunk-fixed data\)) s
5 363 M
(  \(let loop \(\(offset 0\) \(chunks '\(\)\)\)) s
5 352 M
(    \(if \(>= offset \(blob-length data\)\)) s
5 341 M
(        \(reverse chunks\)) s
5 330 M
(        \(loop \(+ offset chunk-size\)) s
5 319 M
(              \(cons \(blob-copy data offset \(min chunk-size \(- \(blob-length data\) offset\)\)) s
5 308 M
(\)) s
5 297 M
(                    chunks\)\)\)\)\)) s
5 275 M
(Content-Defined Chunking \(Rabin fingerprinting\)) s
5 253 M
(;; Chunk boundaries determined by content) s
5 242 M
(;; Survives insertions/deletions better than fixed-size) s
5 231 M
(\(define \(chunk-rabin data\)) s
5 220 M
(  \(let \(\(window-size 48\)) s
5 209 M
(        \(min-chunk 2048\)) s
5 198 M
(        \(max-chunk 65536\)) s
5 187 M
(        \(mask #x0fff\)\)  ; Average 4KB chunks) s
5 176 M
(    ...\)\)) s
5 154 M
(Chunk Tree) s
5 132 M
(\(cas-chunked) s
5 121 M
(  \(hash "sha256:..."\)      ; Root hash) s
5 110 M
(  \(size 10485760\)          ; 10MB original) s
5 99 M
(  \(chunks) s
5 88 M
(    \("sha256:aaa..." 65536\)) s
5 77 M
(    \("sha256:bbb..." 65536\)) s
5 66 M
(    \("sha256:ccc..." 32768\)) s
5 55 M
(    ...\)\)) s
5 33 M
(------------------------------------------------------------------------------) s
5 11 M
(Introspection) s
_R
S
%%Page: (7) 7
%%BeginPageSetup
_S
24 24 translate
/pagenum 7 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(The Library is fully introspective: it stores, addresses, and reasons about itself.) s
5 748 M
(Self-Hosting) s
5 726 M
(The system contains its own description:) s
5 704 M
(;; The RFCs are in the CAS) s
5 693 M
(\(cas-get \(ref-get "rfc/020"\)\)  ; => This document) s
5 671 M
(;; The code is in the CAS) s
5 660 M
(\(cas-get \(ref-get "src/vault.scm"\)\)  ; => Implementation) s
5 638 M
(;; The schema is in the CAS) s
5 627 M
(\(cas-get \(ref-get "schema/soup-object"\)\)  ; => Soup object definition) s
5 605 M
(Meta-Objects) s
5 583 M
(Objects that describe objects:) s
5 561 M
(;; Schema for soup objects \(itself a soup object\)) s
5 550 M
(\(soup-object) s
5 539 M
(  \(name "schema/soup-object"\)) s
5 528 M
(  \(type schema\)) s
5 517 M
(  \(size "412B"\)) s
5 506 M
(  \(crypto \(sha256 "def456..."\)\)) s
5 495 M
(  \(describes soup-object\)\)) s
5 473 M
(;; The soup can enumerate itself) s
5 462 M
(\(soup-query type: 'schema\)  ; => All schemas including this one) s
5 440 M
(Reflexive Queries) s
5 418 M
(The soup answers questions about itself:) s
5 396 M
(;; What types exist?) s
5 385 M
(\(soup-types\)  ; => \(archive release key audit commit schema ...\)) s
5 363 M
(;; What crypto algorithms are in use?) s
5 352 M
(\(soup-algorithms\)  ; => \(sha256 ed25519 zstd age ...\)) s
5 330 M
(;; What is the total size of the vault?) s
5 319 M
(\(soup-total-size\)  ; => 47.3MB) s
5 297 M
(;; How much deduplication?) s
5 286 M
(\(soup-dedup-ratio\)  ; => 0.73 \(27% space saved\)) s
5 264 M
(Provenance) s
5 242 M
(Every object knows its origin:) s
5 220 M
(\(soup-object) s
5 209 M
(  \(name "rfc-020.ps"\)) s
5 198 M
(  \(type blob\)) s
5 187 M
(  \(size "89KB"\)) s
5 176 M
(  \(crypto \(sha256 "abc123..."\)\)) s
5 165 M
(  \(provenance) s
5 154 M
(    \(created-by "ddp@eludom.net"\)) s
5 143 M
(    \(created-at 1767700000\)) s
5 132 M
(    \(derived-from "sha256:fff888..."\)) s
5 121 M
(    \(tool "dvips"\)\)\)) s
5 99 M
(Provenance chains are themselves content-addressed:) s
5 77 M
(;; Trace full history) s
5 66 M
(\(define \(provenance-chain hash\)) s
5 55 M
(  \(let \(\(obj \(soup-get hash\)\)\)) s
5 44 M
(    \(if \(soup-object-derived-from obj\)) s
5 33 M
(        \(cons obj \(provenance-chain \(soup-object-derived-from obj\)\)\)) s
5 22 M
(        \(list obj\)\)\)\)) s
_R
S
%%Page: (8) 8
%%BeginPageSetup
_S
24 24 translate
/pagenum 8 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(Audit of Audits) s
5 759 M
(The audit trail audits itself:) s
5 737 M
(;; Audit entry for an audit entry) s
5 726 M
(\(audit-entry) s
5 715 M
(  \(id 42\)) s
5 704 M
(  \(actor vault-key\)) s
5 693 M
(  \(action \(audit-append 41\)\)  ; Recorded adding entry 41) s
5 682 M
(  \(timestamp 1767700100\)\)) s
5 660 M
(;; The audit trail is in the soup) s
5 649 M
(\(soup-query type: 'audit\)  ; => All audit entries as soup objects) s
5 627 M
(Bootstrapping) s
5 605 M
(The system can describe how to build itself:) s
5 583 M
(;; Bootstrap manifest - everything needed to reconstruct) s
5 572 M
(\(bootstrap-manifest) s
5 561 M
(  \(hash "sha256:bootstrap..."\)) s
5 550 M
(  \(contents) s
5 539 M
(    \(\("src/" tree "sha256:src..."\)) s
5 528 M
(     \("rfcs/" tree "sha256:rfcs..."\)) s
5 517 M
(     \("keys/" tree "sha256:keys..."\)) s
5 506 M
(     \("schema/" tree "sha256:schema..."\)\)\)) s
5 495 M
(  \(build-instructions) s
5 484 M
(    "Load src/boot.scm, call \(bootstrap\)"\)\)) s
5 462 M
(;; Verify bootstrap integrity) s
5 451 M
(\(define \(verify-bootstrap\)) s
5 440 M
(  \(let \(\(manifest \(cas-get \(ref-get "bootstrap"\)\)\)\)) s
5 429 M
(    \(for-each verify-tree \(manifest-contents manifest\)\)\)\)) s
5 407 M
(The Library Contains Itself) s
5 385 M
(\342\\225\255-----------------------------------------\342\\225\256) s
5 374 M
(|            LIBRARY OF CYBERSPACE        |) s
5 363 M
(|  \342\\225\255-----------------------------------\342\\225\256  |) s
5 352 M
(|  |     Content-Addressed Storage     |  |) s
5 341 M
(|  |  \342\\225\255-----------------------------\342\\225\256  |  |) s
5 330 M
(|  |  |    RFC-020 \(this document\)  |  |  |) s
5 319 M
(|  |  |    describing CAS           |  |  |) s
5 308 M
(|  |  |    stored in CAS            |  |  |) s
5 297 M
(|  |  \342\\225\260-----------------------------\342\\225\257  |  |) s
5 286 M
(|  \342\\225\260-----------------------------------\342\\225\257  |) s
5 275 M
(\342\\225\260-----------------------------------------\342\\225\257) s
5 253 M
(Homoiconic storage: the description is the thing.) s
5 231 M
(------------------------------------------------------------------------------) s
5 209 M
(Tombstones) s
5 187 M
(Objects are never truly deleted - they are marked with tombstones.) s
5 165 M
(Soft Deletion) s
5 143 M
(\(define \(cas-tombstone hash #!key reason actor\)) s
5 132 M
(  "Mark object as deleted without removing it") s
5 121 M
(  \(let \(\(tombstone) s
5 110 M
(         `\(tombstone) s
5 99 M
(           \(object ,hash\)) s
5 88 M
(           \(deleted-at ,\(current-seconds\)\)) s
5 77 M
(           \(deleted-by ,actor\)) s
5 66 M
(           \(reason ,reason\)\)\)\)) s
5 55 M
(    \(audit-append action: `\(tombstone ,hash\) motivation: reason\)) s
5 44 M
(    \(cas-put \(serialize tombstone\)\)\)\)) s
5 22 M
(Tombstone Properties) s
_R
S
%%Page: (9) 9
%%BeginPageSetup
_S
24 24 translate
/pagenum 9 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(\(soup-object) s
5 770 M
(  \(name "sha256:deadbeef..."\)) s
5 759 M
(  \(type tombstone\)) s
5 748 M
(  \(size "0B"\)  ; Logical size is zero) s
5 737 M
(  \(status deleted\)) s
5 726 M
(  \(reason "Superseded by sha256:newversion..."\)) s
5 715 M
(  \(recoverable #t\)\)) s
5 693 M
(Recovery) s
5 671 M
(\(define \(cas-resurrect hash\)) s
5 660 M
(  "Remove tombstone, restore object visibility") s
5 649 M
(  \(let \(\(tombstone \(find-tombstone hash\)\)\)) s
5 638 M
(    \(when tombstone) s
5 627 M
(      \(audit-append action: `\(resurrect ,hash\)\)) s
5 616 M
(      \(cas-delete \(tombstone-hash tombstone\)\)\)\)\)) s
5 594 M
(Garbage Collection with Tombstones) s
5 572 M
(\(define \(cas-gc roots #!key preserve-tombstones\)) s
5 561 M
(  "GC respects tombstones by default") s
5 550 M
(  \(let \(\(reachable \(trace-reachable roots\)\)) s
5 539 M
(        \(tombstoned \(all-tombstoned-hashes\)\)\)) s
5 528 M
(    \(for-each) s
5 517 M
(      \(lambda \(hash\)) s
5 506 M
(        \(unless \(or \(set-member? reachable hash\)) s
5 495 M
(                    \(and preserve-tombstones) s
5 484 M
(                         \(set-member? tombstoned hash\)\)\)) s
5 473 M
(          \(delete-file \(hash->path hash\)\)\)\)) s
5 462 M
(      \(all-objects\)\)\)\)) s
5 440 M
(------------------------------------------------------------------------------) s
5 418 M
(Pinning) s
5 396 M
(Pinned objects are protected from garbage collection.) s
5 374 M
(Pin Operations) s
5 352 M
(\(define \(cas-pin hash #!key recursive reason\)) s
5 341 M
(  "Pin object \(and optionally its references\)") s
5 330 M
(  \(let \(\(pin `\(pin) s
5 319 M
(               \(object ,hash\)) s
5 308 M
(               \(pinned-at ,\(current-seconds\)\)) s
5 297 M
(               \(recursive ,recursive\)) s
5 286 M
(               \(reason ,reason\)\)\)\)) s
5 275 M
(    \(write-file \(pin-path hash\) \(serialize pin\)\)) s
5 264 M
(    \(when recursive) s
5 253 M
(      \(for-each \(lambda \(ref\) \(cas-pin ref recursive: #t\)\)) s
5 242 M
(                \(object-references hash\)\)\)\)\)) s
5 220 M
(\(define \(cas-unpin hash\)) s
5 209 M
(  "Remove pin, allow GC") s
5 198 M
(  \(delete-file \(pin-path hash\)\)\)) s
5 176 M
(\(define \(cas-pinned? hash\)) s
5 165 M
(  "Check if object is pinned") s
5 154 M
(  \(file-exists? \(pin-path hash\)\)\)) s
5 132 M
(Pin Manifest) s
5 110 M
(;; All pins as soup objects) s
5 99 M
(\(soup-query type: 'pin\)) s
5 77 M
(;; Pin statistics) s
5 66 M
(\(soup-pin-count\)      ; => 142 objects pinned) s
5 55 M
(\(soup-pinned-size\)    ; => 23.4MB) s
5 33 M
(Root Pins) s
5 11 M
(Certain objects are implicitly pinned:) s
_R
S
%%Page: (10) 10
%%BeginPageSetup
_S
24 24 translate
/pagenum 10 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(\(define implicit-roots) s
5 759 M
(  '\("HEAD"           ; Current commit) s
5 748 M
(    "refs/tags/*"    ; All tags) s
5 737 M
(    "bootstrap"      ; System bootstrap) s
5 726 M
(    "schema/*"\)\)     ; All schemas) s
5 704 M
(------------------------------------------------------------------------------) s
5 682 M
(Bloom Filters) s
5 660 M
(Compact probabilistic set membership for efficient replication.) s
5 638 M
(Multi-Level Existence Check) s
5 616 M
(For the distributed soup, existence checks dominate replication overhead. A tiered approa) s
5 605 M
(ch minimizes latency:) s
5 583 M
(+---------------------------------------------------------+) s
5 572 M
(| L1: Hot Set Cache \(1000 items, O\(1\), microseconds\)     |) s
5 561 M
(+---------------------------------------------------------+) s
5 550 M
(| L2: Blocked Bloom Filter \(100K items, O\(k\), cache-     |) s
5 539 M
(|     friendly memory layout\)                             |) s
5 528 M
(+---------------------------------------------------------+) s
5 517 M
(| L3: Quotient Filter \(1M items, supports deletion\)      |) s
5 506 M
(+---------------------------------------------------------+) s
5 495 M
(| L4: Disk/Network \(authoritative, milliseconds\)         |) s
5 484 M
(+---------------------------------------------------------+) s
5 462 M
(Blocked Bloom Filters) s
5 440 M
(Cache-line aligned blocks for 10x faster lookups:) s
5 418 M
(;; Blocked Bloom: each block fits in CPU cache line \(64 bytes = 512 bits\)) s
5 407 M
(\(define block-bits 512\)) s
5 396 M
(\(define cache-line 64\)) s
5 374 M
(\(define \(make-blocked-bloom capacity error-rate\)) s
5 363 M
(  "Cache-friendly blocked Bloom filter") s
5 352 M
(  \(let* \(\(bits \(bloom-optimal-bits capacity error-rate\)\)) s
5 341 M
(         \(num-blocks \(ceiling \(/ bits block-bits\)\)\)) s
5 330 M
(         \(hashes \(bloom-optimal-hashes capacity bits\)\)\)) s
5 319 M
(    \(blocked-bloom) s
5 308 M
(      \(blocks \(make-vector num-blocks \(make-u8vector cache-line 0\)\)\)) s
5 297 M
(      \(hash-count hashes\)) s
5 286 M
(      \(block-selector \(lambda \(hash\) \(modulo \(hash-part-1 hash\) num-blocks\)\)\)\)\)\)) s
5 264 M
(\(define \(blocked-bloom-add! filter hash\)) s
5 253 M
(  "Add to block - all bits within same cache line") s
5 242 M
(  \(let* \(\(block-idx \(block-select filter hash\)\)) s
5 231 M
(         \(block \(vector-ref \(bloom-blocks filter\) block-idx\)\)\)) s
5 220 M
(    \(for-each) s
5 209 M
(      \(lambda \(i\)) s
5 198 M
(        \(let \(\(bit-idx \(modulo \(bloom-hash filter hash i\) block-bits\)\)\)) s
5 187 M
(          \(u8vector-bit-set! block bit-idx 1\)\)\)) s
5 176 M
(      \(iota \(bloom-hash-count filter\)\)\)\)\)) s
5 154 M
(\(define \(blocked-bloom-contains? filter hash\)) s
5 143 M
(  "Check within single cache line - no cache misses") s
5 132 M
(  \(let* \(\(block-idx \(block-select filter hash\)\)) s
5 121 M
(         \(block \(vector-ref \(bloom-blocks filter\) block-idx\)\)\)) s
5 110 M
(    \(every) s
5 99 M
(      \(lambda \(i\)) s
5 88 M
(        \(let \(\(bit-idx \(modulo \(bloom-hash filter hash i\) block-bits\)\)\)) s
5 77 M
(          \(= 1 \(u8vector-bit-ref block bit-idx\)\)\)\)) s
5 66 M
(      \(iota \(bloom-hash-count filter\)\)\)\)\)) s
5 44 M
(Counting Bloom Filters) s
5 22 M
(For the soup, objects can be tombstoned \(soft-deleted\). Counting filters support removal:) s
_R
S
%%Page: (11) 11
%%BeginPageSetup
_S
24 24 translate
/pagenum 11 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(;; Counting Bloom: 4-bit counters instead of single bits) s
5 770 M
(\(define \(make-counting-bloom capacity error-rate\)) s
5 759 M
(  "Counting Bloom filter supporting deletions") s
5 748 M
(  \(let* \(\(slots \(bloom-optimal-bits capacity error-rate\)\)) s
5 737 M
(         \(nibbles \(make-u8vector \(ceiling \(/ slots 2\)\) 0\)\)) s
5 726 M
(         \(hashes \(bloom-optimal-hashes capacity slots\)\)\)) s
5 715 M
(    \(counting-bloom nibbles hashes slots\)\)\)) s
5 693 M
(\(define \(counting-bloom-add! filter hash\)) s
5 682 M
(  "Increment counters \(saturate at 15\)") s
5 671 M
(  \(for-each) s
5 660 M
(    \(lambda \(i\)) s
5 649 M
(      \(let \(\(slot \(bloom-slot filter hash i\)\)\)) s
5 638 M
(        \(nibble-increment! \(bloom-nibbles filter\) slot\)\)\)) s
5 627 M
(    \(iota \(bloom-hash-count filter\)\)\)\)) s
5 605 M
(\(define \(counting-bloom-remove! filter hash\)) s
5 594 M
(  "Decrement counters \(only if present\)") s
5 583 M
(  \(when \(counting-bloom-contains? filter hash\)) s
5 572 M
(    \(for-each) s
5 561 M
(      \(lambda \(i\)) s
5 550 M
(        \(let \(\(slot \(bloom-slot filter hash i\)\)\)) s
5 539 M
(          \(nibble-decrement! \(bloom-nibbles filter\) slot\)\)\)) s
5 528 M
(      \(iota \(bloom-hash-count filter\)\)\)\)\)) s
5 506 M
(;; Integration with tombstones) s
5 495 M
(\(define \(cas-tombstone/bloom hash reason\)) s
5 484 M
(  "Tombstone with Bloom filter update") s
5 473 M
(  \(counting-bloom-remove! existence-filter hash\)) s
5 462 M
(  \(cas-tombstone hash reason: reason\)\)) s
5 440 M
(Quotient Filters) s
5 418 M
(Better space efficiency than Bloom, supports deletion, and can be resized:) s
5 396 M
(;; Quotient filter: fingerprint stored in quotient/remainder form) s
5 385 M
(\(define \(make-quotient-filter capacity\)) s
5 374 M
(  "Space-efficient filter with deletion support") s
5 363 M
(  \(let* \(\(slots \(next-power-of-2 capacity\)\)) s
5 352 M
(         \(q-bits \(integer-log2 slots\)\)) s
5 341 M
(         \(r-bits \(- 64 q-bits\)\)\)  ; 64-bit fingerprints) s
5 330 M
(    \(quotient-filter) s
5 319 M
(      \(table \(make-vector slots #f\)\)) s
5 308 M
(      \(q-bits q-bits\)) s
5 297 M
(      \(r-bits r-bits\)) s
5 286 M
(      \(count 0\)\)\)\)) s
5 264 M
(\(define \(qf-fingerprint hash q-bits r-bits\)) s
5 253 M
(  "Split hash into quotient and remainder") s
5 242 M
(  \(let \(\(fp \(hash->u64 hash\)\)\)) s
5 231 M
(    \(values \(arithmetic-shift fp \(- r-bits\)\)  ; quotient) s
5 220 M
(            \(bitwise-and fp \(- \(arithmetic-shift 1 r-bits\) 1\)\)\)\)\)  ; remainder) s
5 198 M
(\(define \(qf-insert! qf hash\)) s
5 187 M
(  "Insert with Robin Hood linear probing") s
5 176 M
(  \(let-values \(\(\(q r\) \(qf-fingerprint hash \(qf-q-bits qf\) \(qf-r-bits qf\)\)\)\)) s
5 165 M
(    \(qf-insert-slot! qf q r\)\)\)) s
5 143 M
(\(define \(qf-delete! qf hash\)) s
5 132 M
(  "Delete fingerprint") s
5 121 M
(  \(let-values \(\(\(q r\) \(qf-fingerprint hash \(qf-q-bits qf\) \(qf-r-bits qf\)\)\)\)) s
5 110 M
(    \(qf-delete-slot! qf q r\)\)\)) s
5 88 M
(Replication Protocol) s
5 66 M
(;; Sender: "Here's what I have" \(compressed Bloom\)) s
5 55 M
(\(define \(bloom-inventory\)) s
5 44 M
(  \(let \(\(filter \(make-blocked-bloom 100000 0.01\)\)\)) s
5 33 M
(    \(for-each \(lambda \(hash\) \(blocked-bloom-add! filter hash\)\)) s
5 22 M
(              \(all-object-hashes\)\)) s
5 11 M
(    filter\)\)) s
_R
S
%%Page: (12) 12
%%BeginPageSetup
_S
24 24 translate
/pagenum 12 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(;; Receiver: "Send me what I'm missing") s
5 759 M
(\(define \(bloom-diff local-filter remote-filter\)) s
5 748 M
(  \(filter \(lambda \(hash\)) s
5 737 M
(            \(and \(blocked-bloom-contains? remote-filter hash\)) s
5 726 M
(                 \(not \(cas-exists? hash\)\)\)\)) s
5 715 M
(          \(all-object-hashes\)\)\)) s
5 693 M
(;; Exchange is O\(bloom-size\) not O\(object-count\)) s
5 682 M
(;; Blocked Bloom: 10-100x faster due to cache locality) s
5 660 M
(Hierarchical Existence Check) s
5 638 M
(\(define \(cas-exists?/fast hash\)) s
5 627 M
(  "Tiered existence check - fast path for common case") s
5 616 M
(  \(or \(lru-get hot-set hash\)              ; L1: O\(1\) in-memory) s
5 605 M
(      \(and \(blocked-bloom-contains? l2-bloom hash\)  ; L2: O\(k\) cache-friendly) s
5 594 M
(           \(or \(qf-contains? l3-qf hash\)  ; L3: O\(1\) amortized) s
5 583 M
(               \(cas-exists? hash\)\)\)\)\)      ; L4: authoritative) s
5 561 M
(;; 99% of checks hit L1/L2, avoiding disk/network entirely) s
5 539 M
(Soup Integration) s
5 517 M
(;; Bloom filter itself is a soup object) s
5 506 M
(\(soup-object) s
5 495 M
(  \(name "bloom/2026-01-09"\)) s
5 484 M
(  \(type bloom-filter\)) s
5 473 M
(  \(variant blocked\)           ; blocked, counting, or quotient) s
5 462 M
(  \(size "12KB"\)) s
5 451 M
(  \(crypto \(sha256 "bloom-hash..."\)\)) s
5 440 M
(  \(capacity 100000\)) s
5 429 M
(  \(error-rate 0.01\)) s
5 418 M
(  \(population 47230\)) s
5 407 M
(  \(load-factor 0.47\)\)) s
5 385 M
(------------------------------------------------------------------------------) s
5 363 M
(Content Types) s
5 341 M
(Typed objects with schema validation.) s
5 319 M
(Type Registry) s
5 297 M
(\(define content-types) s
5 286 M
(  '\(\(blob        . "application/octet-stream"\)) s
5 275 M
(    \(text        . "text/plain"\)) s
5 264 M
(    \(markdown    . "text/markdown"\)) s
5 253 M
(    \(scheme      . "text/x-scheme"\)) s
5 242 M
(    \(sexp        . "application/x-sexp"\)) s
5 231 M
(    \(json        . "application/json"\)) s
5 220 M
(    \(pdf         . "application/pdf"\)) s
5 209 M
(    \(archive     . "application/x-sealed-archive"\)) s
5 198 M
(    \(key         . "application/x-spki-key"\)) s
5 187 M
(    \(certificate . "application/x-spki-cert"\)\)\)) s
5 165 M
(Typed Storage) s
5 143 M
(\(define \(cas-put/typed content type #!key schema\)) s
5 132 M
(  "Store with type metadata") s
5 121 M
(  \(let* \(\(hash \(sha256 content\)\)) s
5 110 M
(         \(meta `\(typed-object) s
5 99 M
(                 \(hash ,hash\)) s
5 88 M
(                 \(type ,type\)) s
5 77 M
(                 \(size ,\(blob-length content\)\)) s
5 66 M
(                 \(schema ,schema\)\)\)\)) s
5 55 M
(    \(cas-put content\)) s
5 44 M
(    \(cas-put \(serialize meta\)\)) s
5 33 M
(    hash\)\)) s
5 11 M
(Schema Validation) s
_R
S
%%Page: (13) 13
%%BeginPageSetup
_S
24 24 translate
/pagenum 13 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(\(define \(cas-validate hash\)) s
5 759 M
(  "Validate object against its schema") s
5 748 M
(  \(let* \(\(meta \(cas-get-meta hash\)\)) s
5 737 M
(         \(schema-hash \(typed-object-schema meta\)\)) s
5 726 M
(         \(schema \(cas-get schema-hash\)\)) s
5 715 M
(         \(content \(cas-get hash\)\)\)) s
5 704 M
(    \(schema-validate schema content\)\)\)) s
5 682 M
(;; Schema is itself content-addressed) s
5 671 M
(\(soup-object) s
5 660 M
(  \(name "schema/soup-object"\)) s
5 649 M
(  \(type schema\)) s
5 638 M
(  \(validates soup-object\)) s
5 627 M
(  \(crypto \(sha256 "schema-hash..."\)\)\)) s
5 605 M
(MIME Detection) s
5 583 M
(\(define \(cas-detect-type content\)) s
5 572 M
(  "Detect content type from magic bytes") s
5 561 M
(  \(cond) s
5 550 M
(    \(\(pdf-magic? content\) 'pdf\)) s
5 539 M
(    \(\(gzip-magic? content\) 'archive\)) s
5 528 M
(    \(\(utf8-text? content\)) s
5 517 M
(     \(cond) s
5 506 M
(       \(\(sexp-syntax? content\) 'sexp\)) s
5 495 M
(       \(\(markdown-syntax? content\) 'markdown\)) s
5 484 M
(       \(else 'text\)\)\)) s
5 473 M
(    \(else 'blob\)\)\)) s
5 451 M
(------------------------------------------------------------------------------) s
5 429 M
(Object Capabilities) s
5 407 M
(Content addresses as capabilities: if you know the hash, you can retrieve it.) s
5 385 M
(Hash as Capability) s
5 363 M
(;; Knowledge of hash grants read access) s
5 352 M
(\(define \(cas-get-if-known hash\)) s
5 341 M
(  "Capability-based retrieval") s
5 330 M
(  \(if \(valid-hash? hash\)) s
5 319 M
(      \(cas-get hash\)) s
5 308 M
(      \(error "Invalid capability"\)\)\)) s
5 286 M
(;; Hashes are unguessable \(256-bit entropy\)) s
5 275 M
(;; Sharing a hash = sharing read access) s
5 253 M
(Capability Attenuation) s
5 231 M
(;; SPKI certificate granting access to specific content) s
5 220 M
(\(spki-cert) s
5 209 M
(  \(issuer vault-key\)) s
5 198 M
(  \(subject reader-key\)) s
5 187 M
(  \(permission \(read \(hash sha256 "specific-content..."\)\)\)) s
5 176 M
(  \(validity \(not-after "2027-01-01"\)\)\)) s
5 154 M
(;; Grant access to a subtree) s
5 143 M
(\(spki-cert) s
5 132 M
(  \(issuer vault-key\)) s
5 121 M
(  \(subject reader-key\)) s
5 110 M
(  \(permission \(read \(tree sha256 "subtree-root..."\)\)\)) s
5 99 M
(  \(propagate #t\)\)  ; Access to all referenced objects) s
5 77 M
(Sealed Capabilities) s
5 55 M
(;; Encrypted capability - only holder of key can use) s
5 44 M
(\(define \(seal-capability hash recipient-key\)) s
5 33 M
(  \(let \(\(cap `\(capability) s
5 22 M
(               \(object ,hash\)) s
5 11 M
(               \(granted-at ,\(current-seconds\)\)\)\)\)) s
_R
S
%%Page: (14) 14
%%BeginPageSetup
_S
24 24 translate
/pagenum 14 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(    \(age-encrypt \(serialize cap\) recipient-key\)\)\)) s
5 759 M
(;; Recipient decrypts to obtain hash) s
5 748 M
(\(define \(unseal-capability sealed-cap identity\)) s
5 737 M
(  \(let \(\(cap \(deserialize \(age-decrypt sealed-cap identity\)\)\)\)) s
5 726 M
(    \(capability-object cap\)\)\)) s
5 704 M
(Capability Revocation) s
5 682 M
(;; Revocation via tombstone) s
5 671 M
(\(define \(revoke-capability hash\)) s
5 660 M
(  \(cas-tombstone hash reason: "Capability revoked"\)\)) s
5 638 M
(;; Or via SPKI CRL) s
5 627 M
(\(spki-crl) s
5 616 M
(  \(issuer vault-key\)) s
5 605 M
(  \(revoked) s
5 594 M
(    \(\(hash sha256 "revoked-content..."\)) s
5 583 M
(     \(reason "Superseded"\)) s
5 572 M
(     \(revoked-at 1767700000\)\)\)\)) s
5 550 M
(------------------------------------------------------------------------------) s
5 528 M
(Hash Migration) s
5 506 M
(When cryptographic algorithms weaken, the system must migrate.) s
5 484 M
(Multihash) s
5 462 M
(;; Self-describing hash format) s
5 451 M
(\(define \(multihash algo data\)) s
5 440 M
(  \(let \(\(hash \(case algo) s
5 429 M
(                \(\(sha256\) \(sha256 data\)\)) s
5 418 M
(                \(\(sha384\) \(sha384 data\)\)) s
5 407 M
(                \(\(sha512\) \(sha512 data\)\)) s
5 396 M
(                \(\(blake3\) \(blake3 data\)\)\)\)\)) s
5 385 M
(    \(list algo \(blob-length hash\) hash\)\)\)) s
5 363 M
(;; Parse multihash) s
5 352 M
(\(define \(multihash-algorithm mh\) \(car mh\)\)) s
5 341 M
(\(define \(multihash-digest mh\) \(caddr mh\)\)) s
5 319 M
(Dual-Hash Period) s
5 297 M
(;; During migration, store under both hashes) s
5 286 M
(\(define \(cas-put/migrate content old-algo new-algo\)) s
5 275 M
(  \(let \(\(old-hash \(hash-with old-algo content\)\)) s
5 264 M
(        \(new-hash \(hash-with new-algo content\)\)\)) s
5 253 M
(    \(cas-put-raw old-hash content\)) s
5 242 M
(    \(cas-put-raw new-hash content\)) s
5 231 M
(    ;; Link old to new) s
5 220 M
(    \(ref-set \(string-append "migrate/" old-hash\) new-hash\)) s
5 209 M
(    new-hash\)\)) s
5 187 M
(;; Lookup follows migration links) s
5 176 M
(\(define \(cas-get/migrate hash\)) s
5 165 M
(  \(let \(\(migrated \(ref-get \(string-append "migrate/" hash\)\)\)\)) s
5 154 M
(    \(cas-get \(or migrated hash\)\)\)\)) s
5 132 M
(Migration Manifest) s
5 110 M
(\(migration-manifest) s
5 99 M
(  \(from-algorithm sha256\)) s
5 88 M
(  \(to-algorithm sha384\)) s
5 77 M
(  \(started-at 1767700000\)) s
5 66 M
(  \(status in-progress\)) s
5 55 M
(  \(migrated 4723\)) s
5 44 M
(  \(remaining 1892\)) s
5 33 M
(  \(mappings) s
5 22 M
(    \(\("sha256:abc..." . "sha384:def..."\)) s
5 11 M
(     \("sha256:123..." . "sha384:456..."\)) s
_R
S
%%Page: (15) 15
%%BeginPageSetup
_S
24 24 translate
/pagenum 15 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(     ...\)\)\)) s
5 759 M
(Verification During Migration) s
5 737 M
(\(define \(verify-migration hash\)) s
5 726 M
(  "Verify object under both old and new hash") s
5 715 M
(  \(let* \(\(content \(cas-get hash\)\)) s
5 704 M
(         \(old-hash \(sha256 content\)\)) s
5 693 M
(         \(new-hash \(sha384 content\)\)\)) s
5 682 M
(    \(and \(or \(equal? hash old-hash\)) s
5 671 M
(             \(equal? hash new-hash\)\)) s
5 660 M
(         \(equal? \(ref-get \(string-append "migrate/" old-hash\)\)) s
5 649 M
(                 new-hash\)\)\)\)) s
5 627 M
(------------------------------------------------------------------------------) s
5 605 M
(Comparison with Related Systems) s
5 583 M
(| System | Hash | Chunking | Naming |) s
5 572 M
(|--------|------|----------|--------|) s
5 561 M
(| Git | SHA-1 | Pack files | refs/branches |) s
5 550 M
(| IPFS | SHA-256/multihash | Rabin | IPNS, DNSLink |) s
5 539 M
(| Perkeep | SHA-224 | Rolling hash | Permanodes |) s
5 528 M
(| Library CAS | SHA-256 | Configurable | Vault refs |) s
5 506 M
(------------------------------------------------------------------------------) s
5 484 M
(Security Considerations) s
5 462 M
(Hash Collision Attacks) s
5 440 M
(SHA-256 provides 128-bit collision resistance. No practical attacks known.) s
5 418 M
(If SHA-256 is ever broken:) s
5 396 M
(;; Multihash for algorithm agility) s
5 385 M
(\(define \(multihash algo data\)) s
5 374 M
(  \(case algo) s
5 363 M
(    \(\(sha256\) \(cons 'sha256 \(sha256 data\)\)\)) s
5 352 M
(    \(\(sha384\) \(cons 'sha384 \(sha384 data\)\)\)) s
5 341 M
(    \(\(blake3\) \(cons 'blake3 \(blake3 data\)\)\)\)\)) s
5 319 M
(Length Extension Attacks) s
5 297 M
(SHA-256 is vulnerable to length extension. For authentication, use HMAC:) s
5 275 M
(\(define \(cas-mac key hash\)) s
5 264 M
(  \(hmac-sha256 key hash\)\)) s
5 242 M
(Timing Attacks) s
5 220 M
(Hash comparison MUST be constant-time:) s
5 198 M
(\(define \(hash-equal? a b\)) s
5 187 M
(  \(let \(\(result 0\)\)) s
5 176 M
(    \(do \(\(i 0 \(+ i 1\)\)\)) s
5 165 M
(        \(\(= i 32\) \(zero? result\)\)) s
5 154 M
(      \(set! result \(bitwise-ior result) s
5 143 M
(                    \(bitwise-xor \(blob-ref a i\) \(blob-ref b i\)\)\)\)\)\)\)) s
5 121 M
(------------------------------------------------------------------------------) s
5 99 M
(Performance Considerations) s
5 77 M
(Caching) s
5 55 M
(;; LRU cache for hot objects) s
5 44 M
(\(define cas-cache \(make-lru-cache 1000\)\)) s
5 22 M
(\(define \(cas-get/cached hash\)) s
5 11 M
(  \(or \(lru-get cas-cache hash\)) s
_R
S
%%Page: (16) 16
%%BeginPageSetup
_S
24 24 translate
/pagenum 16 def
/fname (rfc-020-content-addressed-storage.txt) def
/fdir (.) def
/ftail (rfc-020-content-addressed-storage.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(      \(let \(\(content \(cas-get hash\)\)\)) s
5 770 M
(        \(lru-put! cas-cache hash content\)) s
5 759 M
(        content\)\)\)) s
5 737 M
(Parallel Hashing) s
5 715 M
(Large files benefit from parallel hashing of chunks.) s
5 693 M
(SSD Optimization) s
5 671 M
(Random access pattern. Use write-ahead log for durability:) s
5 649 M
(\(define \(cas-put/durable content\)) s
5 638 M
(  \(let \(\(hash \(sha256 content\)\)\)) s
5 627 M
(    \(wal-append hash content\)) s
5 616 M
(    \(write-blob \(hash->path hash\) content\)) s
5 605 M
(    \(wal-commit hash\)) s
5 594 M
(    hash\)\)) s
5 572 M
(------------------------------------------------------------------------------) s
5 550 M
(Implementation Notes) s
5 528 M
(Dependencies) s
5 506 M
(| Component | Library |) s
5 495 M
(|-----------|---------|) s
5 484 M
(| SHA-256 | message-digest, sha2 |) s
5 473 M
(| Blob I/O | CHICKEN I/O |) s
5 462 M
(| Chunking | Custom |) s
5 440 M
(Error Handling) s
5 418 M
(\(define-condition-type &cas-error &error) s
5 407 M
(  cas-error?) s
5 396 M
(  \(hash cas-error-hash\)\)) s
5 374 M
(\(define-condition-type &cas-not-found &cas-error) s
5 363 M
(  cas-not-found?\)) s
5 341 M
(\(define-condition-type &cas-corrupt &cas-error) s
5 330 M
(  cas-corrupt?\)) s
5 308 M
(------------------------------------------------------------------------------) s
5 286 M
(References) s
5 264 M
(1. Merkle, R. \(1987\), "A Digital Signature Based on a Conventional Encryption Function") s
5 253 M
(2. Git Internals - Git Objects) s
5 242 M
(3. IPFS Content Addressing) s
5 231 M
(4. Putze, Sanders, Singler \(2007\), "Cache-, Hash-, and Space-Efficient Bloom Filters") s
5 220 M
(5. Bender et al. \(2012\), "Don't Thrash: How to Cache Your Hash on Flash") s
5 209 M
(6. RFC-006: Vault System Architecture) s
5 198 M
(7. RFC-018: Sealed Archive Format) s
5 176 M
(------------------------------------------------------------------------------) s
5 154 M
(Changelog) s
5 132 M
(- 2026-01-09 - Advanced probabilistic data structures: blocked Bloom filters, counting Bl) s
5 121 M
(oom filters, quotient filters, hierarchical existence checking) s
5 110 M
(- 2026-01-07 - Initial draft) s
5 88 M
(------------------------------------------------------------------------------) s
5 66 M
(Implementation Status: Draft) s
5 55 M
(Dependencies: sha2, message-digest) s
5 44 M
(Integration: Vault, Replication, SPKI) s
_R
S
%%Trailer
%%Pages: 16
%%DocumentNeededResources: font Courier-Bold Courier 
%%EOF
