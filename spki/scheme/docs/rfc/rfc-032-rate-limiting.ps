%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Thu Jan  8 15:17:54 2026
%%DocumentNeededResources: font Times-Roman
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 7
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(RFC-032: Rate Limiting and Quotas)72 12 Q(Statu\
s: Draft Date: January 2026 Author: Derrell Piper ddp@eludom.net Implem\
entation: Proposed)72 36 Q(--------------------------------------------\
----------------------------------)72 60 Q(Abstract)72 84 Q .05(This RF\
C speci\214es rate limiting and quotas for the Library of Cyberspace: h\
o)72 108 R 2.55(wv)-.25 G .05(aults protect themselv)-2.8 F .05
(es from ab)-.15 F(use)-.2 E(while ensuring f)72 120 Q
(air access for le)-.1 E(gitimate users. Limits are capability-a)-.15 E
-.1(wa)-.15 G(re and auditable.).1 E(----------------------------------\
--------------------------------------------)72 144 Q(Moti)72 168 Q -.25
(va)-.25 G(tion).25 E(Shared resources require protection:)72 192 Q
3.213(-D)72 216 S .714(enial of Service - Malicious o)-3.213 F -.15(ve)
-.15 G .714(rload - Resource e).15 F .714(xhaustion - Runa)-.15 F -.1
(wa)-.15 G 3.214(yp).1 G .714(rocesses - F)-3.214 F .714
(air sharing - Equal access)-.15 F(for all users - Cost control - Pre)72
228 Q -.15(ve)-.25 G(nt unbounded consumption).15 E(Limits must be:)72
252 Q 3.383(-C)72 276 S .883(on\214gurable - Dif)-3.383 F .883
(ferent limits for dif)-.25 F .883(ferent principals - Graceful - De)
-.25 F .883(grade smoothly)-.15 F 3.383(,d)-.65 G .883(on\342t clif)
-3.383 F 3.383(f-T)-.25 G .882(ransparent -)-3.733 F(Users kno)72 288 Q
2.5(wt)-.25 G(heir limits - Auditable - All limiting decisions logged)
-2.5 E(----------------------------------------------------------------\
--------------)72 312 Q(Rate Limiting)72 336 Q -.8(To)72 360 S -.1(ke).8
G 2.5(nB).1 G(uck)-2.5 E(et Algorithm)-.1 E(\(de\214ne \(mak)82 384 Q
(e-tok)-.1 E(en-b)-.1 E(uck)-.2 E(et capacity \214ll-rate\))-.1 E
("Create tok)87 396 Q(en b)-.1 E(uck)-.2 E(et rate limiter")-.1 E
(\(let \(\(tok)87 408 Q(ens capacity\))-.1 E
(\(last-\214ll \(current-time-ms\)\)\))102 420 Q(\(lambda \(cost\))92
444 Q(;; Re\214ll tok)97 456 Q(ens based on elapsed time)-.1 E
(\(let* \(\(no)97 468 Q 2.5(w\()-.25 G(current-time-ms\)\))-2.5 E
(\(elapsed \(- no)114.5 480 Q 2.5(wl)-.25 G(ast-\214ll\)\))-2.5 E(\(ne)
114.5 492 Q(w-tok)-.25 E(ens \(+ tok)-.1 E
(ens \(* \214ll-rate \(/ elapsed 1000\)\)\)\)\))-.1 E(\(set! tok)102 504
Q(ens \(min capacity ne)-.1 E(w-tok)-.25 E(ens\)\))-.1 E
(\(set! last-\214ll no)102 516 Q(w\))-.25 E(;; T)102 540 Q
(ry to consume tok)-.35 E(ens)-.1 E(\(if \(>= tok)102 552 Q(ens cost\))
-.1 E(\(be)112 564 Q(gin)-.15 E(\(set! tok)117 576 Q(ens \(- tok)-.1 E
(ens cost\)\))-.1 E 2.5(#t\) ;)117 588 R(Allo)2.5 E(wed)-.25 E
(#f\)\)\)\)\) ; Denied)112 600 Q(;; Example: 100 requests per second, b)
82 624 Q(urst of 200)-.2 E(\(de\214ne request-limiter \(mak)82 636 Q
(e-tok)-.1 E(en-b)-.1 E(uck)-.2 E(et 200 100\)\))-.1 E(Sliding W)72 660
Q(indo)-.4 E(w)-.25 E(\(de\214ne \(mak)82 684 Q(e-sliding-windo)-.1 E
2.5(ws)-.25 G(ize interv)-2.5 E(al\))-.25 E("Sliding windo)87 696 Q 2.5
(wr)-.25 G(ate limiter")-2.5 E(\(let \(\(e)87 708 Q -.15(ve)-.25 G
(nts \(mak).15 E(e-deque\)\)\))-.1 E(\(lambda \(\))92 732 Q(;; Remo)97
744 Q .3 -.15(ve o)-.15 H(ld e).15 E -.15(ve)-.25 G(nts).15 E
(\(let \(\(cutof)97 756 Q 2.5(f\()-.25 G 2.5(-\()-2.5 G
(current-time-ms\) interv)-2.5 E(al\)\)\))-.25 E
(\(while \(and \(not \(deque-empty? e)102 768 Q -.15(ve)-.25 G(nts\)\))
.15 E(\(< \(deque-front e)132 780 Q -.15(ve)-.25 G(nts\) cutof).15 E
(f\)\))-.25 E(\(deque-pop-front! e)107 792 Q -.15(ve)-.25 G(nts\)\)\))
.15 E 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(;; Check if under limit)97 24 Q
(\(if \(< \(deque-length e)97 36 Q -.15(ve)-.25 G(nts\) size\)).15 E
(\(be)107 48 Q(gin)-.15 E(\(deque-push-back! e)112 60 Q -.15(ve)-.25 G
(nts \(current-time-ms\)\)).15 E(#t\))112 72 Q(#f\)\)\)\))107 84 Q(Leak)
72 108 Q 2.5(yB)-.15 G(uck)-2.5 E(et)-.1 E(\(de\214ne \(mak)82 132 Q
(e-leak)-.1 E(y-b)-.15 E(uck)-.2 E(et capacity leak-rate\))-.1 E("Leak)
87 144 Q 2.5(yb)-.15 G(uck)-2.7 E(et for smoothing b)-.1 E(ursts")-.2 E
(\(let \(\(le)87 156 Q -.15(ve)-.25 G 2.5(l0).15 G(\))-2.5 E
(\(last-leak \(current-time-ms\)\)\))102 168 Q(\(lambda \(amount\))92
192 Q(;; Leak based on elapsed time)97 204 Q(\(let* \(\(no)97 216 Q 2.5
(w\()-.25 G(current-time-ms\)\))-2.5 E(\(elapsed \(- no)114.5 228 Q 2.5
(wl)-.25 G(ast-leak\)\))-2.5 E(\(leak)114.5 240 Q
(ed \(* leak-rate \(/ elapsed 1000\)\)\)\))-.1 E(\(set! le)102 252 Q
-.15(ve)-.25 G 2.5(l\().15 G(max 0 \(- le)-2.5 E -.15(ve)-.25 G 2.5(ll)
.15 G(eak)-2.5 E(ed\)\)\))-.1 E(\(set! last-leak no)102 264 Q(w\))-.25 E
(;; T)102 288 Q(ry to add to b)-.35 E(uck)-.2 E(et)-.1 E
(\(if \(<= \(+ le)102 300 Q -.15(ve)-.25 G 2.5(la).15 G
(mount\) capacity\))-2.5 E(\(be)112 312 Q(gin)-.15 E(\(set! le)117 324 Q
-.15(ve)-.25 G 2.5(l\().15 G 2.5(+l)-2.5 G -2.15 -.25(ev e)-2.5 H 2.5
(la).25 G(mount\)\))-2.5 E(#t\))117 336 Q(#f\)\)\)\)\))112 348 Q(------\
-----------------------------------------------------------------------\
-)72 372 Q(Quota System)72 396 Q(Quota T)72 420 Q(ypes)-.8 E
(\(de\214ne quota-types)82 444 Q('\(\(storage . \(\(unit . bytes\))87
456 Q(\(period . #f\))122 468 Q 2.5(;N)25 G 2.5(or)-2.5 G(eset)-2.5 E
(\(def)122 480 Q(ault . 10737418240\)\)\) ; 10GB)-.1 E
(\(bandwidth . \(\(unit . bytes\))92 504 Q(\(period . monthly\))127 516
Q(\(def)127 528 Q(ault . 107374182400\)\)\) ; 100GB/month)-.1 E
(\(requests . \(\(unit . count\))92 552 Q(\(period . daily\))124.5 564 Q
(\(def)124.5 576 Q(ault . 100000\)\)\))-.1 E 2.5(;1)10 G(00k/day)-2.5 E
(\(objects . \(\(unit . count\))92 600 Q(\(period . #f\))122 612 Q
(\(def)122 624 Q(ault . 1000000\)\)\)\)\))-.1 E 2.5(;1)5 G 2.5(Mo)-2.5 G
(bjects)-2.5 E(Quota T)72 648 Q(racking)-.35 E
(\(de\214ne principal-quotas \(mak)82 672 Q(e-hash-table\)\))-.1 E
(\(de\214ne \(get-quota principal quota-type\))82 696 Q("Get principal')
87 708 Q 2.5(sq)-.55 G(uota for type")-2.5 E(\(let \(\(quotas \(hash-ta\
ble-ref principal-quotas principal '\(\)\)\)\))87 720 Q
(\(or \(assoc-ref quotas quota-type\))92 732 Q
(\(assoc-ref quota-types quota-type ')102 744 Q(def)-.5 E(ault\)\)\)\))
-.1 E(\(de\214ne \(get-usage principal quota-type\))82 768 Q
("Get principal')87 780 Q 2.5(sc)-.55 G(urrent usage")-2.5 E
(\(let \(\(period \(quota-period quota-type\)\)\))87 792 Q 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(soup-aggre)92 12 Q -.05(ga)-.15 G(te).05 E
(where: \(and \(type: 'usage-record\))97 24 Q(\(principal: principal\))
127 36 Q(\(quota-type: quota-type\))127 48 Q(\(if period)127 60 Q
(\(timestamp: \(> \(period-start period\)\)\))137 72 Q(#t\)\))137 84 Q
(aggre)97 96 Q -.05(ga)-.15 G(te: \(sum 'amount\)\)\)\)).05 E
(\(de\214ne \(check-quota principal quota-type amount\))82 120 Q
("Check if operation w)87 132 Q(ould e)-.1 E(xceed quota")-.15 E
(\(let \(\(quota \(get-quota principal quota-type\)\))87 144 Q
(\(usage \(get-usage principal quota-type\)\)\))102 156 Q
(\(<= \(+ usage amount\) quota\)\)\))92 168 Q(Quota Enforcement)72 192 Q
(\(de\214ne \(enforce-quota principal quota-type amount\))82 216 Q
("Enforce quota, raise error if e)87 228 Q(xceeded")-.15 E
(\(unless \(check-quota principal quota-type amount\))87 240 Q
(\(let \(\(quota \(get-quota principal quota-type\)\))92 252 Q
(\(usage \(get-usage principal quota-type\)\)\))107 264 Q
(\(audit-append action: 'quota-e)97 276 Q(xceeded)-.15 E
(principal: principal)132 288 Q(quota-type: quota-type)132 300 Q
(quota: quota)132 312 Q(usage: usage)132 324 Q(requested: amount\))132
336 Q(\(error 'quota-e)97 348 Q(xceeded)-.15 E
(`\(\(type . ,quota-type\))114.5 360 Q(\(quota . ,quota\))119.5 372 Q
(\(usage . ,usage\))119.5 384 Q(\(requested . ,amount\)\)\)\)\)\))119.5
396 Q(\(de\214ne \(record-usage principal quota-type amount\))82 420 Q
("Record quota usage")87 432 Q(\(soup-put)87 444 Q
(`\(\(type . usage-record\))92 456 Q(\(principal . ,principal\))97 468 Q
(\(quota-type . ,quota-type\))97 480 Q(\(amount . ,amount\))97 492 Q
(\(timestamp . ,\(current-time\)\)\)\)\))97 504 Q(---------------------\
---------------------------------------------------------)72 528 Q
(Principal-Based Limits)72 552 Q(Limit T)72 576 Q(iers)-.35 E
(\(de\214ne limit-tiers)82 600 Q('\(\(anon)87 612 Q
(ymous . \(\(requests-per)-.15 E(-second . 10\))-.2 E
(\(storage-bytes . 0\))127 624 Q(\(bandwidth-bytes . 1073741824\)\)\))
127 636 Q(\(authenticated . \(\(requests-per)92 660 Q(-second . 100\))
-.2 E(\(storage-bytes . 10737418240\))137 672 Q
(\(bandwidth-bytes . 107374182400\)\)\))137 684 Q
(\(premium . \(\(requests-per)92 708 Q(-second . 1000\))-.2 E
(\(storage-bytes . 1099511627776\))122 720 Q
(\(bandwidth-bytes . 10995116277760\)\)\))122 732 Q
(\(admin . \(\(requests-per)92 756 Q(-second . #f\))-.2 E 2.5(;U)5 G
(nlimited)-2.5 E(\(storage-bytes . #f\))117 768 Q
(\(bandwidth-bytes . #f\)\)\)\)\))117 780 Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(de\214ne \(principal-tier principal\))82 12 Q
("Determine principal')87 24 Q 2.5(sl)-.55 G(imit tier")-2.5 E(\(cond)87
36 Q(\(\(admin-principal? principal\) 'admin\))92 48 Q
(\(\(premium-principal? principal\) 'premium\))92 60 Q
(\(\(authenticated? principal\) 'authenticated\))92 72 Q(\(else 'anon)92
84 Q(ymous\)\)\))-.15 E(Per)72 108 Q(-Principal Limiters)-.2 E
(\(de\214ne principal-limiters \(mak)82 132 Q(e-hash-table\)\))-.1 E
(\(de\214ne \(get-limiter principal\))82 156 Q
("Get or create rate limiter for principal")87 168 Q
(\(or \(hash-table-ref principal-limiters principal #f\))87 180 Q
(\(let* \(\(tier \(principal-tier principal\)\))97 192 Q
(\(rps \(assoc-ref \(assoc-ref limit-tiers tier\))114.5 204 Q -.5('r)152
216 S(equests-per).5 E(-second\)\)\))-.2 E(\(if rps)102 228 Q
(\(let \(\(limiter \(mak)112 240 Q(e-tok)-.1 E(en-b)-.1 E(uck)-.2 E
(et \(* rps 2\) rps\)\)\))-.1 E
(\(hash-table-set! principal-limiters principal limiter\))117 252 Q
(limiter\))117 264 Q(\(lambda \(_\) #t\)\)\)\)\))112 276 Q 2.5(;U)5 G
(nlimited)-2.5 E(\(de\214ne \(rate-limit-principal principal\))82 300 Q
("Apply rate limit to principal")87 312 Q
(\(let \(\(limiter \(get-limiter principal\)\)\))87 324 Q
(\(unless \(limiter 1\))92 336 Q(\(audit-append action: ')97 348 Q
(rate-limited principal: principal\))-.5 E(\(error ')97 360 Q
(rate-limited\)\)\)\))-.5 E(Capability-Based Limits)72 384 Q
(;; Capabilities can include rate limits)82 408 Q(\(spki-cert)82 420 Q
(\(issuer v)87 432 Q(ault-admin\))-.25 E(\(subject api-client\))87 444 Q
(\(capability)87 456 Q(\(action read\))92 468 Q(\(object v)92 480 Q
(ault-content\))-.25 E(\(rate-limit)92 492 Q(\(requests-per)97 504 Q
(-second 50\))-.2 E(\(b)97 516 Q(urst 100\)\)\))-.2 E(\(v)87 528 Q
(alidity \(not-after "2027-01-01"\)\)\))-.25 E
(\(de\214ne \(capability-rate-limit cap\))82 552 Q
("Extract rate limit from capability")87 564 Q(\(assoc-ref cap ')87 576
Q(rate-limit\)\))-.5 E(------------------------------------------------\
------------------------------)72 600 Q(Resource-Speci\214c Limits)72
624 Q(Storage Limits)72 648 Q
(\(de\214ne \(enforce-storage-limit principal size\))82 672 Q
("Enforce storage quota before write")87 684 Q
(\(let* \(\(quota \(get-quota principal ')87 696 Q(storage\)\))-.55 E
(\(used \(principal-storage-used principal\)\)\))104.5 708 Q
(\(when \(and quota \(> \(+ used size\) quota\)\))92 720 Q(\(error ')97
732 Q(storage-quota-e)-.55 E(xceeded)-.15 E(`\(\(quota . ,quota\))114.5
744 Q(\(used . ,used\))119.5 756 Q(\(requested . ,size\)\)\)\)\)\))119.5
768 Q(\(de\214ne \(principal-storage-used principal\))82 792 Q 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF("Calculate principal')87 12 Q 2.5(ss)-.55 G
(torage usage")-2.5 E(\(soup-aggre)87 24 Q -.05(ga)-.15 G(te).05 E
(where: \(o)92 36 Q(wner: principal\))-.25 E(aggre)92 48 Q -.05(ga)-.15
G(te: \(sum ').05 E(size\)\)\))-.55 E(Bandwidth Limits)72 72 Q
(\(de\214ne \(enforce-bandwidth-limit principal bytes direction\))82 96
Q("Enforce bandwidth quota")87 108 Q
(\(let* \(\(quota \(get-quota principal 'bandwidth\)\))87 120 Q
(\(used \(principal-bandwidth-used principal\)\)\))104.5 132 Q
(\(when \(and quota \(> \(+ used bytes\) quota\)\))92 144 Q
(\(error 'bandwidth-quota-e)97 156 Q(xceeded)-.15 E
(`\(\(quota . ,quota\))114.5 168 Q(\(used . ,used\))119.5 180 Q
(\(requested . ,bytes\))119.5 192 Q
(\(direction . ,direction\)\)\)\)\)\))119.5 204 Q(Connection Limits)72
228 Q(\(de\214ne max-connections-per)82 252 Q(-principal 100\))-.2 E
(\(de\214ne principal-connections \(mak)82 264 Q(e-hash-table\)\))-.1 E
(\(de\214ne \(enforce-connection-limit principal\))82 288 Q
("Limit concurrent connections")87 300 Q(\(let \(\(count \(hash-table-r\
ef principal-connections principal 0\)\)\))87 312 Q
(\(when \(>= count max-connections-per)92 324 Q(-principal\))-.2 E
(\(error 'connection-limit-e)97 336 Q(xceeded)-.15 E
(`\(\(limit . ,max-connections-per)114.5 348 Q(-principal\))-.2 E
(\(current . ,count\)\)\)\)\)\))119.5 360 Q
(\(de\214ne \(track-connection principal direction\))82 384 Q(\(let \(\
\(count \(hash-table-ref principal-connections principal 0\)\)\))87 396
Q(\(hash-table-set! principal-connections principal)92 408 Q
(\(case direction)97 420 Q(\(\(open\) \(+ count 1\)\))102 432 Q
(\(\(close\) \(max 0 \(- count 1\)\)\)\)\)\)\))102 444 Q(--------------\
----------------------------------------------------------------)72 468
Q(Backpressure)72 492 Q(Request Queuing)72 516 Q
(\(de\214ne request-queue \(mak)82 540 Q(e-bounded-queue 1000\)\))-.1 E
(\(de\214ne \(queue-request request\))82 564 Q
("Queue request with backpressure")87 576 Q
(\(if \(queue-full? request-queue\))87 588 Q(\(be)97 600 Q(gin)-.15 E
(\(audit-append action: ')102 612 Q
(request-rejected reason: 'queue-full\))-.5 E(\(error ')102 624 Q
(service-una)-.55 E -.25(va)-.2 G(ilable\)\)).25 E
(\(queue-push! request-queue request\)\)\))97 636 Q(Load Shedding)72 660
Q(\(de\214ne \(should-shed-load?\))82 684 Q
("Determine if load shedding needed")87 696 Q
(\(or \(> \(cpu-usage\) 0.9\))87 708 Q(\(> \(memory-usage\) 0.9\))97 720
Q(\(> \(queue-length request-queue\) 800\)\)\))97 732 Q
(\(de\214ne \(shed-load request\))82 756 Q("Selecti)87 768 Q -.15(ve)
-.25 G(ly reject requests under load").15 E(\(cond)87 780 Q(;; Al)92 792
Q -.1(wa)-.1 G(ys allo).1 E 2.5(wa)-.25 G(dmin requests)-2.5 E 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF
(\(\(admin-principal? \(request-principal request\)\))92 12 Q
(\(process-request request\)\))94.5 24 Q(;; Shed lo)92 36 Q
(w-priority requests)-.25 E(\(\(and \(should-shed-load?\))92 48 Q(\(lo)
107 60 Q(w-priority-request? request\)\))-.25 E
(\(audit-append action: ')94.5 72 Q
(load-shed request: \(request-id request\)\))-.1 E(\(error ')94.5 84 Q
(service-una)-.55 E -.25(va)-.2 G(ilable\)\)).25 E(\(else)92 96 Q
(\(process-request request\)\)\)\))94.5 108 Q(Retry-After)72 132 Q
(\(de\214ne \(rate-limit-response retry-after\))82 156 Q
("Generate rate limit response")87 168 Q(`\(\(status . 429\))87 180 Q
(\(headers . \(\(Retry-After . ,retry-after\))92 192 Q
(\(X-RateLimit-Limit . ,\(current-limit\)\))122 204 Q
(\(X-RateLimit-Remaining . ,\(remaining-tok)122 216 Q(ens\)\))-.1 E
(\(X-RateLimit-Reset . ,\(reset-time\)\)\)\)\)\))122 228 Q(------------\
------------------------------------------------------------------)72
252 Q(Monitoring)72 276 Q(Limit Metrics)72 300 Q
(\(de\214ne \(record-limit-metrics\))82 324 Q
("Record rate limiting metrics")87 336 Q(\(metric-set! ')87 348 Q
(ratelimit.requests.allo)-.5 E(wed allo)-.25 E(wed-count\))-.25 E
(\(metric-set! ')87 360 Q(ratelimit.requests.denied denied-count\))-.5 E
(\(metric-set! ')87 372 Q
(ratelimit.requests.queued \(queue-length request-queue\)\))-.5 E
(\(metric-set! 'quota.storage.used total-storage-used\))87 384 Q
(\(metric-set! 'quota.storage.a)87 396 Q -.25(va)-.2 G
(ilable total-storage-a).25 E -.25(va)-.2 G(ilable\)\)).25 E
(Limit Alerts)72 420 Q(\(de\214ne limit-alerts)82 444 Q
('\(\(high-rejection-rate)87 456 Q
(\(condition \(> \(/ denied-count \(+ allo)94.5 468 Q
(wed-count denied-count\)\) 0.1\)\))-.25 E(\(se)94.5 480 Q -.15(ve)-.25
G(rity w).15 E(arning\))-.1 E
(\(message "High rate limit rejection rate"\)\))94.5 492 Q(\(quota-near)
92 516 Q(-limit)-.2 E(\(condition \(> \(/ used quota\) 0.9\)\))94.5 528
Q(\(se)94.5 540 Q -.15(ve)-.25 G(rity w).15 E(arning\))-.1 E
(\(message "Principal approaching quota limit"\)\)\)\))94.5 552 Q(-----\
-----------------------------------------------------------------------\
--)72 576 Q(Con\214guration)72 600 Q(Dynamic Limits)72 624 Q
(;; Limits can be adjusted at runtime)82 648 Q
(\(de\214ne \(set-limit principal limit-type v)82 660 Q(alue\))-.25 E
("Set custom limit for principal")87 672 Q(\(soup-put)87 684 Q
(`\(\(type . principal-limit\))92 696 Q(\(principal . ,principal\))97
708 Q(\(limit-type . ,limit-type\))97 720 Q(\(v)97 732 Q(alue . ,v)-.25
E(alue\))-.25 E(\(set-by . ,\(current-principal\)\))97 744 Q
(\(set-at . ,\(current-time\)\)\))97 756 Q(type: 'con\214guration\)\))92
768 Q(\(de\214ne \(get-ef)82 792 Q(fecti)-.25 E -.15(ve)-.25 G
(-limit principal limit-type\)).15 E 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF("Get principal')87 12 Q 2.5(se)-.55 G -.25(ff)
-2.5 G(ecti).25 E .3 -.15(ve l)-.25 H(imit").15 E
(\(or \(soup-query-one type: 'principal-limit)87 24 Q
(principal: principal)137 36 Q(limit-type: limit-type\))137 48 Q(\(tier)
97 60 Q(-limit \(principal-tier principal\) limit-type\)\)\))-.2 E
(Limit Inheritance)72 84 Q(;; Groups can ha)82 108 Q .3 -.15(ve l)-.2 H
(imits that members inherit).15 E
(\(de\214ne \(group-limit group limit-type\))82 120 Q
(\(soup-query-one type: 'group-limit)87 132 Q(group: group)127 144 Q
(limit-type: limit-type\)\))127 156 Q(\(de\214ne \(ef)82 180 Q(fecti)
-.25 E -.15(ve)-.25 G(-limit principal limit-type\)).15 E("Resolv)87 192
Q 2.5(el)-.15 G(imit with inheritance")-2.5 E(\(or \(get-ef)87 204 Q
(fecti)-.25 E -.15(ve)-.25 G(-limit principal limit-type\)).15 E
(\(let \(\(groups \(principal-groups principal\)\)\))97 216 Q
(\(\214nd \(lambda \(g\) \(group-limit g limit-type\)\) groups\)\))102
228 Q(\(def)97 240 Q(ault-limit limit-type\)\)\))-.1 E(----------------\
--------------------------------------------------------------)72 264 Q
(Security)72 288 Q(Limit Bypass Pre)72 312 Q -.15(ve)-.25 G(ntion).15 E
(;; Pre)82 336 Q -.15(ve)-.25 G(nt limit bypass via identity rotation)
.15 E(\(de\214ne \(track-ip-limits ip\))82 348 Q("T)87 360 Q
(rack limits by IP in addition to principal")-.35 E
(\(let \(\(limiter \(get-ip-limiter ip\)\)\))87 372 Q
(\(unless \(limiter 1\))92 384 Q(\(error 'ip-rate-limited\)\)\)\))97 396
Q(;; Combine principal and IP limits)82 420 Q
(\(de\214ne \(combined-rate-limit principal ip\))82 432 Q
(\(and \(rate-limit-principal principal\))87 444 Q
(\(track-ip-limits ip\)\)\))99.5 456 Q(Audit T)72 480 Q(rail)-.35 E
(\(de\214ne \(audit-limit-e)82 504 Q -.15(ve)-.25 G(nt e).15 E -.15(ve)
-.25 G(nt-type principal details\)).15 E(\(audit-append)87 516 Q
(action: e)92 528 Q -.15(ve)-.25 G(nt-type).15 E(principal: principal)92
540 Q(details: details)92 552 Q(timestamp: \(current-time\)\)\))92 564 Q
(----------------------------------------------------------------------\
--------)72 588 Q(References)72 612 Q 2.673(1. T)72 636 R(ok)-.8 E .173
(en Buck)-.1 F .173(et Algorithm 2.)-.1 F(Leak)5.173 E 2.673(yB)-.15 G
(uck)-2.673 E .174(et Algorithm 3.)-.1 F .174(RFC-021: Capability Dele)
5.174 F -.05(ga)-.15 G .174(tion 4.).05 F .174(RFC-031: Monitor)5.174 F
(-)-.2 E(ing)72 648 Q(-------------------------------------------------\
-----------------------------)72 672 Q(Changelog)72 696 Q 2.5(-2)72 720
S(026-01-07 - Initial draft)-2.5 E(------------------------------------\
------------------------------------------)72 744 Q 1.513
(Implementation Status: Draft Dependencies: soup, spki, monitoring Inte)
72 768 R 1.512(gration: API layer)-.15 F 4.012(,n)-.4 G(etw)-4.012 E
1.512(ork protocol, re-)-.1 F(source management)72 780 Q 0 Cg EP
%%Trailer
end
%%EOF
