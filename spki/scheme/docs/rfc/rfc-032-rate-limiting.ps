%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Sun Jan 11 10:41:55 2026
%%DocumentNeededResources: font Times-Bold
%%+ font Times-Italic
%%+ font Times-Roman
%%+ font Courier
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 9
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Italic
%%IncludeResource: font Times-Roman
%%IncludeResource: font Courier
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Courier@0 ENC0/Courier RE/Times-Roman@0 ENC0/Times-Roman RE
/Times-Italic@0 ENC0/Times-Italic RE/Times-Bold@0 ENC0/Times-Bold RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF(RFC-032: Rate Limiting and Quotas)212.334 123 Q
/F1 10/Times-Italic@0 SF(Libr)260.85 159 Q(ary of Cyber)-.15 E(space)-.1
E/F2 10/Times-Roman@0 SF(2026)296 177 Q F1(ABSTRA)282.535 213 Q(CT)-.3 E
/F3 10/Times-Bold@0 SF 2.5(1. Abstract)72 261 R F2 .05(This RFC speci\
\214es rate limiting and quotas for the Library of Cyberspace: ho)72
276.6 R 2.55(wv)-.25 G .05(aults protect themselv)-2.8 F .05(es from ab)
-.15 F(use)-.2 E(while ensuring f)72 288.6 Q(air access for le)-.1 E
(gitimate users. Limits are capability-a)-.15 E -.1(wa)-.15 G
(re and auditable.).1 E F3 2.5(2. Moti)72 312.6 R -.1(va)-.1 G(tion).1 E
F2(Shared resources require protection:)72 328.2 Q 3.213(-D)72 343.8 S
.714(enial of Service - Malicious o)-3.213 F -.15(ve)-.15 G .714
(rload - Resource e).15 F .714(xhaustion - Runa)-.15 F -.1(wa)-.15 G
3.214(yp).1 G .714(rocesses - F)-3.214 F .714
(air sharing - Equal access)-.15 F(for all users - Cost control - Pre)72
355.8 Q -.15(ve)-.25 G(nt unbounded consumption).15 E(Limits must be:)72
371.4 Q 3.459(-C)72 387 S .959(on\214gurable - Dif)-3.459 F .959
(ferent limits for dif)-.25 F .959(ferent principals - Graceful - De)
-.25 F .959(grade smoothly)-.15 F 3.459(,d)-.65 G(on')-3.459 E 3.459(tc)
-.18 G(lif)-3.459 E 3.458(f-T)-.25 G .958(ransparent -)-3.808 F
(Users kno)72 399 Q 2.5(wt)-.25 G
(heir limits - Auditable - All limiting decisions logged)-2.5 E F3 2.5
(3. Rate)72 423 R(Limiting)2.5 E 2.5(3.1. T)72 447 R(ok)-.92 E(en Buck)
-.1 E(et Algorithm)-.1 E/F4 8/Courier@0 SF
(\(define \(make-token-bucket capacity fill-rate\))108 465 Q
("Create token bucket rate limiter")117.6 477 Q
(\(let \(\(tokens capacity\))117.6 489 Q
(\(last-fill \(current-time-ms\)\)\))146.4 501 Q(\(lambda \(cost\))127.2
525 Q(;; Refill tokens based on elapsed time)136.8 537 Q
(\(let \(\(now \(current-time-ms\)\))136.8 549 Q
(\(elapsed \(- now last-fill\)\))170.4 561 Q
(\(new-tokens \(+ tokens \( fill-rate \(/ elapsed 1000\)\)\)\)\))170.4
573 Q(\(set! tokens \(min capacity new-tokens\)\))146.4 585 Q
(\(set! last-fill now\))146.4 597 Q(;; Try to consume tokens)146.4 621 Q
(\(if \(>= tokens cost\))146.4 633 Q(\(begin)165.6 645 Q
(\(set! tokens \(- tokens cost\)\))175.2 657 Q 4.8(#t\) ;)175.2 669 R
(Allowed)4.8 E(#f\)\)\)\)\) ; Denied)165.6 681 Q
(;; Example: 100 requests per second, burst of 200)108 705 Q
(\(define request-limiter \(make-token-bucket 200 100\)\))108 717 Q 0 Cg
EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(3.2. Sliding)72 84 R -.18(Wi)2.5 G(ndo).18 E(w)-.1 E/F2 8/Courier@0
SF(\(define \(make-sliding-window size interval\))108 102 Q
("Sliding window rate limiter")117.6 114 Q
(\(let \(\(events \(make-deque\)\)\))117.6 126 Q(\(lambda \(\))127.2 150
Q(;; Remove old events)136.8 162 Q
(\(let \(\(cutoff \(- \(current-time-ms\) interval\)\)\))136.8 174 Q
(\(while \(and \(not \(deque-empty? events\)\))146.4 186 Q
(\(< \(deque-front events\) cutoff\)\))204 198 Q
(\(deque-pop-front! events\)\)\))156 210 Q(;; Check if under limit)136.8
234 Q(\(if \(< \(deque-length events\) size\))136.8 246 Q(\(begin)156
258 Q(\(deque-push-back! events \(current-time-ms\)\))165.6 270 Q(#t\))
165.6 282 Q(#f\)\)\)\))156 294 Q F1 2.5(3.3. Leak)72 312 R 2.5(yB)-.15 G
(uck)-2.5 E(et)-.1 E F2
(\(define \(make-leaky-bucket capacity leak-rate\))108 330 Q
("Leaky bucket for smoothing bursts")117.6 342 Q(\(let \(\(level 0\))
117.6 354 Q(\(last-leak \(current-time-ms\)\)\))146.4 366 Q
(\(lambda \(amount\))127.2 390 Q(;; Leak based on elapsed time)136.8 402
Q(\(let \(\(now \(current-time-ms\)\))136.8 414 Q
(\(elapsed \(- now last-leak\)\))170.4 426 Q
(\(leaked \( leak-rate \(/ elapsed 1000\)\)\)\))170.4 438 Q
(\(set! level \(max 0 \(- level leaked\)\)\))146.4 450 Q
(\(set! last-leak now\))146.4 462 Q(;; Try to add to bucket)146.4 486 Q
(\(if \(<= \(+ level amount\) capacity\))146.4 498 Q(\(begin)165.6 510 Q
(\(set! level \(+ level amount\)\))175.2 522 Q(#t\))175.2 534 Q
(#f\)\)\)\)\))165.6 546 Q F1 2.5(4. Quota)72 564 R(System)2.5 E 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(4.1. Quota)72 84 R -.34(Ty)2.5 G(pes).34 E/F2 8/Courier@0 SF
(\(define quota-types)108 102 Q('\(\(storage . \(\(unit . bytes\))117.6
114 Q(\(period . #f\))184.8 126 Q 4.8(;N)48 G 4.8(or)-4.8 G(eset)-4.8 E
(\(default . 10737418240\)\)\) ; 10GB)184.8 138 Q
(\(bandwidth . \(\(unit . bytes\))127.2 162 Q(\(period . monthly\))194.4
174 Q(\(default . 107374182400\)\)\) ; 100GB/month)194.4 186 Q
(\(requests . \(\(unit . count\))127.2 210 Q(\(period . daily\))189.6
222 Q(\(default . 100000\)\)\))189.6 234 Q 4.8(;1)19.2 G(00k/day)-4.8 E
(\(objects . \(\(unit . count\))127.2 258 Q(\(period . #f\))184.8 270 Q
(\(default . 1000000\)\)\)\)\))184.8 282 Q 4.8(;1)9.6 G 4.8(Mo)-4.8 G
(bjects)-4.8 E F1 2.5(4.2. Quota)72 300 R -.74(Tr)2.5 G(acking).74 E F2
(\(define principal-quotas \(make-hash-table\)\))108 318 Q
(\(define \(get-quota principal quota-type\))108 342 Q
("Get principal's quota for type")117.6 354 Q(\(let \(\(quotas \(hash-t\
able-ref principal-quotas principal '\(\)\)\)\))117.6 366 Q
(\(or \(assoc-ref quotas quota-type\))127.2 378 Q
(\(assoc-ref quota-types quota-type 'default\)\)\)\))146.4 390 Q
(\(define \(get-usage principal quota-type\))108 414 Q
("Get principal's current usage")117.6 426 Q
(\(let \(\(period \(quota-period quota-type\)\)\))117.6 438 Q
(\(soup-aggregate)127.2 450 Q(where: \(and \(type: 'usage-record\))136.8
462 Q(\(principal: principal\))194.4 474 Q(\(quota-type: quota-type\))
194.4 486 Q(\(if period)194.4 498 Q
(\(timestamp: \(> \(period-start period\)\)\))213.6 510 Q(#t\)\))213.6
522 Q(aggregate: \(sum 'amount\)\)\)\))136.8 534 Q
(\(define \(check-quota principal quota-type amount\))108 558 Q
("Check if operation would exceed quota")117.6 570 Q
(\(let \(\(quota \(get-quota principal quota-type\)\))117.6 582 Q
(\(usage \(get-usage principal quota-type\)\)\))146.4 594 Q
(\(<= \(+ usage amount\) quota\)\)\))127.2 606 Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(4.3. Quota)72 84 R(Enf)2.5 E(or)-.25 E(cement)-.18 E/F2 8/Courier@0
SF(\(define \(enforce-quota principal quota-type amount\))108 102 Q
("Enforce quota, raise error if exceeded")117.6 114 Q
(\(unless \(check-quota principal quota-type amount\))117.6 126 Q
(\(let \(\(quota \(get-quota principal quota-type\)\))127.2 138 Q
(\(usage \(get-usage principal quota-type\)\)\))156 150 Q
(\(audit-append action: 'quota-exceeded)136.8 162 Q
(principal: principal)204 174 Q(quota-type: quota-type)204 186 Q
(quota: quota)204 198 Q(usage: usage)204 210 Q(requested: amount\))204
222 Q(\(error 'quota-exceeded)136.8 234 Q(\(\(type . ,quota-type\))170.4
246 Q(\(quota . ,quota\))180 258 Q(\(usage . ,usage\))180 270 Q
(\(requested . ,amount\)\)\)\)\)\))180 282 Q
(\(define \(record-usage principal quota-type amount\))108 306 Q
("Record quota usage")117.6 318 Q(\(soup-put)117.6 330 Q
(\(\(type . usage-record\))127.2 342 Q(\(principal . ,principal\))136.8
354 Q(\(quota-type . ,quota-type\))136.8 366 Q(\(amount . ,amount\))
136.8 378 Q(\(timestamp . ,\(current-time\)\)\)\)\))136.8 390 Q F1 2.5
(5. Principal-Based)72 408 R(Limits)2.5 E 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.1. Limit)72 84 R -.18(Ti)2.5 G(ers).18 E/F2 8/Courier@0 SF
(\(define limit-tiers)108 102 Q
('\(\(anonymous . \(\(requests-per-second . 10\))117.6 114 Q
(\(storage-bytes . 0\))194.4 126 Q(\(bandwidth-bytes . 1073741824\)\)\))
194.4 138 Q(\(authenticated . \(\(requests-per-second . 100\))127.2 162
Q(\(storage-bytes . 10737418240\))213.6 174 Q
(\(bandwidth-bytes . 107374182400\)\)\))213.6 186 Q
(\(premium . \(\(requests-per-second . 1000\))127.2 210 Q
(\(storage-bytes . 1099511627776\))184.8 222 Q
(\(bandwidth-bytes . 10995116277760\)\)\))184.8 234 Q
(\(admin . \(\(requests-per-second . #f\))127.2 258 Q 4.8(;U)9.6 G
(nlimited)-4.8 E(\(storage-bytes . #f\))175.2 270 Q
(\(bandwidth-bytes . #f\)\)\)\)\))175.2 282 Q
(\(define \(principal-tier principal\))108 306 Q
("Determine principal's limit tier")117.6 318 Q(\(cond)117.6 330 Q
(\(\(admin-principal? principal\) 'admin\))127.2 342 Q
(\(\(premium-principal? principal\) 'premium\))127.2 354 Q
(\(\(authenticated? principal\) 'authenticated\))127.2 366 Q
(\(else 'anonymous\)\)\))127.2 378 Q F1 2.5(5.2. P)72 396 R(er)-.2 E
(-Principal Limiters)-.37 E F2
(\(define principal-limiters \(make-hash-table\)\))108 414 Q
(\(define \(get-limiter principal\))108 438 Q
("Get or create rate limiter for principal")117.6 450 Q
(\(or \(hash-table-ref principal-limiters principal #f\))117.6 462 Q
(\(let \(\(tier \(principal-tier principal\)\))136.8 474 Q
(\(rps \(assoc-ref \(assoc-ref limit-tiers tier\))170.4 486 Q
('requests-per-second\)\)\))242.4 498 Q(\(if rps)146.4 510 Q
(\(let \(\(limiter \(make-token-bucket \( rps 2\) rps\)\)\))165.6 522 Q
(\(hash-table-set! principal-limiters principal limiter\))175.2 534 Q
(limiter\))175.2 546 Q(\(lambda \(_\) #t\)\)\)\)\))165.6 558 Q 4.8(;U)
9.6 G(nlimited)-4.8 E(\(define \(rate-limit-principal principal\))108
582 Q("Apply rate limit to principal")117.6 594 Q
(\(let \(\(limiter \(get-limiter principal\)\)\))117.6 606 Q
(\(unless \(limiter 1\))127.2 618 Q
(\(audit-append action: 'rate-limited principal: principal\))136.8 630 Q
(\(error 'rate-limited\)\)\)\))136.8 642 Q 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.3. Capability-Based)72 84 R(Limits)2.5 E/F2 8/Courier@0 SF
(;; Capabilities can include rate limits)108 102 Q(\(spki-cert)108 114 Q
(\(issuer vault-admin\))117.6 126 Q(\(subject api-client\))117.6 138 Q
(\(capability)117.6 150 Q(\(action read\))127.2 162 Q
(\(object vault-content\))127.2 174 Q(\(rate-limit)127.2 186 Q
(\(requests-per-second 50\))136.8 198 Q(\(burst 100\)\)\))136.8 210 Q
(\(validity \(not-after "2027-01-01"\)\)\))117.6 222 Q
(\(define \(capability-rate-limit cap\))108 246 Q
("Extract rate limit from capability")117.6 258 Q
(\(assoc-ref cap 'rate-limit\)\))117.6 270 Q F1 2.5(6. Resour)72 288 R
(ce-Speci\214c Limits)-.18 E 2.5(6.1. Storage)72 312 R(Limits)2.5 E F2
(\(define \(enforce-storage-limit principal size\))108 330 Q
("Enforce storage quota before write")117.6 342 Q
(\(let* \(\(quota \(get-quota principal 'storage\)\))117.6 354 Q
(\(used \(principal-storage-used principal\)\)\))151.2 366 Q
(\(when \(and quota \(> \(+ used size\) quota\)\))127.2 378 Q
(\(error 'storage-quota-exceeded)136.8 390 Q(`\(\(quota . ,quota\))170.4
402 Q(\(used . ,used\))180 414 Q(\(requested . ,size\)\)\)\)\)\))180 426
Q(\(define \(principal-storage-used principal\))108 450 Q
("Calculate principal's storage usage")117.6 462 Q(\(soup-aggregate)
117.6 474 Q(where: \(owner: principal\))127.2 486 Q
(aggregate: \(sum 'size\)\)\))127.2 498 Q F1 2.5(6.2. Band)72 516 R
(width Limits)-.15 E F2
(\(define \(enforce-bandwidth-limit principal bytes direction\))108 534
Q("Enforce bandwidth quota")117.6 546 Q
(\(let* \(\(quota \(get-quota principal 'bandwidth\)\))117.6 558 Q
(\(used \(principal-bandwidth-used principal\)\)\))151.2 570 Q
(\(when \(and quota \(> \(+ used bytes\) quota\)\))127.2 582 Q
(\(error 'bandwidth-quota-exceeded)136.8 594 Q(`\(\(quota . ,quota\))
170.4 606 Q(\(used . ,used\))180 618 Q(\(requested . ,bytes\))180 630 Q
(\(direction . ,direction\)\)\)\)\)\))180 642 Q 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.3. Connection)72 84 R(Limits)2.5 E/F2 8/Courier@0 SF
(\(define max-connections-per-principal 100\))108 102 Q
(\(define principal-connections \(make-hash-table\)\))108 114 Q
(\(define \(enforce-connection-limit principal\))108 138 Q
("Limit concurrent connections")117.6 150 Q(\(let \(\(count \(hash-tabl\
e-ref principal-connections principal 0\)\)\))117.6 162 Q
(\(when \(>= count max-connections-per-principal\))127.2 174 Q
(\(error 'connection-limit-exceeded)136.8 186 Q
(`\(\(limit . ,max-connections-per-principal\))170.4 198 Q
(\(current . ,count\)\)\)\)\)\))180 210 Q
(\(define \(track-connection principal direction\))108 234 Q(\(let \(\(\
count \(hash-table-ref principal-connections principal 0\)\)\))117.6 246
Q(\(hash-table-set! principal-connections principal)127.2 258 Q
(\(case direction)136.8 270 Q(\(\(open\) \(+ count 1\)\))146.4 282 Q
(\(\(close\) \(max 0 \(- count 1\)\)\)\)\)\)\))146.4 294 Q F1 2.5
(7. Backpr)72 312 R(essur)-.18 E(e)-.18 E 2.5(7.1. Request)72 336 R
(Queuing)2.5 E F2(\(define request-queue \(make-bounded-queue 1000\)\))
108 354 Q(\(define \(queue-request request\))108 378 Q
("Queue request with backpressure")117.6 390 Q
(\(if \(queue-full? request-queue\))117.6 402 Q(\(begin)136.8 414 Q
(\(audit-append action: 'request-rejected reason: 'queue-full\))146.4
426 Q(\(error 'service-unavailable\)\))146.4 438 Q
(\(queue-push! request-queue request\)\)\))136.8 450 Q F1 2.5(7.2. Load)
72 468 R(Shedding)2.5 E F2(\(define \(should-shed-load?\))108 486 Q
("Determine if load shedding needed")117.6 498 Q
(\(or \(> \(cpu-usage\) 0.9\))117.6 510 Q(\(> \(memory-usage\) 0.9\))
136.8 522 Q(\(> \(queue-length request-queue\) 800\)\)\))136.8 534 Q
(\(define \(shed-load request\))108 558 Q
("Selectively reject requests under load")117.6 570 Q(\(cond)117.6 582 Q
(;; Always allow admin requests)127.2 594 Q
(\(\(admin-principal? \(request-principal request\)\))127.2 606 Q
(\(process-request request\)\))132 618 Q(;; Shed low-priority requests)
127.2 630 Q(\(\(and \(should-shed-load?\))127.2 642 Q
(\(low-priority-request? request\)\))156 654 Q
(\(audit-append action: 'load-shed request: \(request-id request\)\))132
666 Q(\(error 'service-unavailable\)\))132 678 Q(\(else)127.2 690 Q
(\(process-request request\)\)\)\))132 702 Q 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(7.3. Retry-After)72 84 R/F2 8/Courier@0 SF
(\(define \(rate-limit-response retry-after\))108 102 Q
("Generate rate limit response")117.6 114 Q(`\(\(status . 429\))117.6
126 Q(\(headers . \(\(Retry-After . ,retry-after\))127.2 138 Q
(\(X-RateLimit-Limit . ,\(current-limit\)\))184.8 150 Q
(\(X-RateLimit-Remaining . ,\(remaining-tokens\)\))184.8 162 Q
(\(X-RateLimit-Reset . ,\(reset-time\)\)\)\)\)\))184.8 174 Q F1 2.5
(8. Monitoring)72 192 R 2.5(8.1. Limit)72 216 R(Metrics)2.5 E F2
(\(define \(record-limit-metrics\))108 234 Q
("Record rate limiting metrics")117.6 246 Q
(\(metric-set! 'ratelimit.requests.allowed allowed-count\))117.6 258 Q
(\(metric-set! 'ratelimit.requests.denied denied-count\))117.6 270 Q(\(\
metric-set! 'ratelimit.requests.queued \(queue-length request-queue\)\))
117.6 282 Q(\(metric-set! 'quota.storage.used total-storage-used\))117.6
294 Q
(\(metric-set! 'quota.storage.available total-storage-available\)\))
117.6 306 Q F1 2.5(8.2. Limit)72 324 R(Alerts)2.5 E F2
(\(define limit-alerts)108 342 Q('\(\(high-rejection-rate)117.6 354 Q(\
\(condition \(> \(/ denied-count \(+ allowed-count denied-count\)\) 0.1\
\)\))132 366 Q(\(severity warning\))132 378 Q
(\(message "High rate limit rejection rate"\)\))132 390 Q
(\(quota-near-limit)127.2 414 Q
(\(condition \(> \(/ used quota\) 0.9\)\))132 426 Q
(\(severity warning\))132 438 Q
(\(message "Principal approaching quota limit"\)\)\)\))132 450 Q F1 2.5
(9. Con\214guration)72 468 R 2.5(9.1. Dynamic)72 492 R(Limits)2.5 E F2
(;; Limits can be adjusted at runtime)108 510 Q
(\(define \(set-limit principal limit-type value\))108 522 Q
("Set custom limit for principal")117.6 534 Q(\(soup-put)117.6 546 Q
(`\(\(type . principal-limit\))127.2 558 Q(\(principal . ,principal\))
136.8 570 Q(\(limit-type . ,limit-type\))136.8 582 Q(\(value . ,value\))
136.8 594 Q(\(set-by . ,\(current-principal\)\))136.8 606 Q
(\(set-at . ,\(current-time\)\)\))136.8 618 Q(type: 'configuration\)\))
127.2 630 Q(\(define \(get-effective-limit principal limit-type\))108
654 Q("Get principal's effective limit")117.6 666 Q
(\(or \(soup-query-one type: 'principal-limit)117.6 678 Q
(principal: principal)213.6 690 Q(limit-type: limit-type\))213.6 702 Q
(\(tier-limit \(principal-tier principal\) limit-type\)\)\))136.8 714 Q
0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-032 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(9.2. Limit)72 84 R(Inheritance)2.5 E/F2 8/Courier@0 SF
(;; Groups can have limits that members inherit)108 102 Q
(\(define \(group-limit group limit-type\))108 114 Q
(\(soup-query-one type: 'group-limit)117.6 126 Q(group: group)194.4 138
Q(limit-type: limit-type\)\))194.4 150 Q
(\(define \(effective-limit principal limit-type\))108 174 Q
("Resolve limit with inheritance")117.6 186 Q
(\(or \(get-effective-limit principal limit-type\))117.6 198 Q
(\(let \(\(groups \(principal-groups principal\)\)\))136.8 210 Q
(\(find \(lambda \(g\) \(group-limit g limit-type\)\) groups\)\))146.4
222 Q(\(default-limit limit-type\)\)\))136.8 234 Q F1 2.5(10. Security)
72 252 R 2.5(10.1. Limit)72 276 R(Bypass Pr)2.5 E -2.3 -.15(ev e)-.18 H
(ntion).15 E F2(;; Prevent limit bypass via identity rotation)108 294 Q
(\(define \(track-ip-limits ip\))108 306 Q
("Track limits by IP in addition to principal")117.6 318 Q
(\(let \(\(limiter \(get-ip-limiter ip\)\)\))117.6 330 Q
(\(unless \(limiter 1\))127.2 342 Q(\(error 'ip-rate-limited\)\)\)\))
136.8 354 Q(;; Combine principal and IP limits)108 378 Q
(\(define \(combined-rate-limit principal ip\))108 390 Q
(\(and \(rate-limit-principal principal\))117.6 402 Q
(\(track-ip-limits ip\)\)\))141.6 414 Q F1 2.5(10.2. A)72 432 R(udit T)
-.5 E(rail)-.74 E F2
(\(define \(audit-limit-event event-type principal details\))108 450 Q
(\(audit-append)117.6 462 Q(action: event-type)127.2 474 Q
(principal: principal)127.2 486 Q(details: details)127.2 498 Q
(timestamp: \(current-time\)\)\))127.2 510 Q F1 2.5(11. Refer)72 528 R
(ences)-.18 E F0 11.247(1. [T)72 543.6 R(ok)-.8 E 11.247(en Buck)-.1 F
11.247(et Algorithm]\(https://en.wikipedia.or)-.1 F(g/wiki/T)-.18 E(ok)
-.8 E(enb)-.1 E(uck)-.2 E 11.247(et\) 2. [Leak)-.1 F 13.747(yB)-.15 G
(uck)-13.747 E 11.248(et Algo-)-.1 F(rithm]\(https://en.wikipedia.or)72
555.6 Q(g/wiki/Leak)-.18 E(yb)-.15 E(uck)-.2 E 2.343
(et\) 3. [RFC-021: Capability Dele)-.1 F -.05(ga)-.15 G
(tion]\(rfc-021-capability-dele).05 E -.05(ga)-.15 G(-).05 E
(tion.html\) 4. [RFC-031: Monitoring]\(rfc-031-monitoring.html\))72
567.6 Q F1 2.5(12. Changelog)72 591.6 R F0 2.5(-2)72 607.2 S
(026-01-07 - Initial draft)-2.5 E 0 Cg EP
%%Trailer
end
%%EOF
