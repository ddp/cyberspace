%!PS-Adobe-3.0
%%BoundingBox: 24 24 571 818
%%Title: Enscript Output
%%For: Derrell Piper
%%Creator: GNU Enscript 1.6.6
%%CreationDate: Fri Jan  9 12:12:49 2026
%%Orientation: Portrait
%%Pages: (atend)
%%DocumentMedia: A4 595 842 0 () ()
%%DocumentNeededResources: (atend)
%%EndComments
%%BeginProlog
%%BeginResource: procset Enscript-Prolog 1.6 6
%
% Procedures.
%

/_S {	% save current state
  /_s save def
} def
/_R {	% restore from saved state
  _s restore
} def

/S {	% showpage protecting gstate
  gsave
  showpage
  grestore
} bind def

/MF {	% fontname newfontname -> -	make a new encoded font
  /newfontname exch def
  /fontname exch def

  /fontdict fontname findfont def
  /newfont fontdict maxlength dict def

  fontdict {
    exch
    dup /FID eq {
      % skip FID pair
      pop pop
    } {
      % copy to the new font dictionary
      exch newfont 3 1 roll put
    } ifelse
  } forall

  newfont /FontName newfontname put

  % insert only valid encoding vectors
  encoding_vector length 256 eq {
    newfont /Encoding encoding_vector put
  } if

  newfontname newfont definefont pop
} def

/MF_PS { % fontname newfontname -> -	make a new font preserving its enc
  /newfontname exch def
  /fontname exch def

  /fontdict fontname findfont def
  /newfont fontdict maxlength dict def

  fontdict {
    exch
    dup /FID eq {
      % skip FID pair
      pop pop
    } {
      % copy to the new font dictionary
      exch newfont 3 1 roll put
    } ifelse
  } forall

  newfont /FontName newfontname put

  newfontname newfont definefont pop
} def

/SF { % fontname width height -> -	set a new font
  /height exch def
  /width exch def

  findfont
  [width 0 0 height 0 0] makefont setfont
} def

/SUF { % fontname width height -> -	set a new user font
  /height exch def
  /width exch def

  /F-gs-user-font MF
  /F-gs-user-font width height SF
} def

/SUF_PS { % fontname width height -> -	set a new user font preserving its enc
  /height exch def
  /width exch def

  /F-gs-user-font MF_PS
  /F-gs-user-font width height SF
} def

/M {moveto} bind def
/s {show} bind def

/Box {	% x y w h -> -			define box path
  /d_h exch def /d_w exch def /d_y exch def /d_x exch def
  d_x d_y  moveto
  d_w 0 rlineto
  0 d_h rlineto
  d_w neg 0 rlineto
  closepath
} def

/bgs {	% x y height blskip gray str -> -	show string with bg color
  /str exch def
  /gray exch def
  /blskip exch def
  /height exch def
  /y exch def
  /x exch def

  gsave
    x y blskip sub str stringwidth pop height Box
    gray setgray
    fill
  grestore
  x y M str s
} def

/bgcs { % x y height blskip red green blue str -> -  show string with bg color
  /str exch def
  /blue exch def
  /green exch def
  /red exch def
  /blskip exch def
  /height exch def
  /y exch def
  /x exch def

  gsave
    x y blskip sub str stringwidth pop height Box
    red green blue setrgbcolor
    fill
  grestore
  x y M str s
} def

% Highlight bars.
/highlight_bars {	% nlines lineheight output_y_margin gray -> -
  gsave
    setgray
    /ymarg exch def
    /lineheight exch def
    /nlines exch def

    % This 2 is just a magic number to sync highlight lines to text.
    0 d_header_y ymarg sub 2 sub translate

    /cw d_output_w cols div def
    /nrows d_output_h ymarg 2 mul sub lineheight div cvi def

    % for each column
    0 1 cols 1 sub {
      cw mul /xp exch def

      % for each rows
      0 1 nrows 1 sub {
        /rn exch def
        rn lineheight mul neg /yp exch def
        rn nlines idiv 2 mod 0 eq {
	  % Draw highlight bar.  4 is just a magic indentation.
	  xp 4 add yp cw 8 sub lineheight neg Box fill
	} if
      } for
    } for

  grestore
} def

% Line highlight bar.
/line_highlight {	% x y width height gray -> -
  gsave
    /gray exch def
    Box gray setgray fill
  grestore
} def

% Column separator lines.
/column_lines {
  gsave
    .1 setlinewidth
    0 d_footer_h translate
    /cw d_output_w cols div def
    1 1 cols 1 sub {
      cw mul 0 moveto
      0 d_output_h rlineto stroke
    } for
  grestore
} def

% Column borders.
/column_borders {
  gsave
    .1 setlinewidth
    0 d_footer_h moveto
    0 d_output_h rlineto
    d_output_w 0 rlineto
    0 d_output_h neg rlineto
    closepath stroke
  grestore
} def

% Do the actual underlay drawing
/draw_underlay {
  ul_style 0 eq {
    ul_str true charpath stroke
  } {
    ul_str show
  } ifelse
} def

% Underlay
/underlay {	% - -> -
  gsave
    0 d_page_h translate
    d_page_h neg d_page_w atan rotate

    ul_gray setgray
    ul_font setfont
    /dw d_page_h dup mul d_page_w dup mul add sqrt def
    ul_str stringwidth pop dw exch sub 2 div ul_h_ptsize -2 div moveto
    draw_underlay
  grestore
} def

/user_underlay {	% - -> -
  gsave
    ul_x ul_y translate
    ul_angle rotate
    ul_gray setgray
    ul_font setfont
    0 0 ul_h_ptsize 2 div sub moveto
    draw_underlay
  grestore
} def

% Page prefeed
/page_prefeed {		% bool -> -
  statusdict /prefeed known {
    statusdict exch /prefeed exch put
  } {
    pop
  } ifelse
} def

% Wrapped line markers
/wrapped_line_mark {	% x y charwith charheight type -> -
  /type exch def
  /h exch def
  /w exch def
  /y exch def
  /x exch def

  type 2 eq {
    % Black boxes (like TeX does)
    gsave
      0 setlinewidth
      x w 4 div add y M
      0 h rlineto w 2 div 0 rlineto 0 h neg rlineto
      closepath fill
    grestore
  } {
    type 3 eq {
      % Small arrows
      gsave
        .2 setlinewidth
        x w 2 div add y h 2 div add M
        w 4 div 0 rlineto
        x w 4 div add y lineto stroke

        x w 4 div add w 8 div add y h 4 div add M
        x w 4 div add y lineto
	w 4 div h 8 div rlineto stroke
      grestore
    } {
      % do nothing
    } ifelse
  } ifelse
} def

% EPSF import.

/BeginEPSF {
  /b4_Inc_state save def    		% Save state for cleanup
  /dict_count countdictstack def	% Count objects on dict stack
  /op_count count 1 sub def		% Count objects on operand stack
  userdict begin
  /showpage { } def
  0 setgray 0 setlinecap
  1 setlinewidth 0 setlinejoin
  10 setmiterlimit [ ] 0 setdash newpath
  /languagelevel where {
    pop languagelevel
    1 ne {
      false setstrokeadjust false setoverprint
    } if
  } if
} bind def

/EndEPSF {
  count op_count sub { pos } repeat	% Clean up stacks
  countdictstack dict_count sub { end } repeat
  b4_Inc_state restore
} bind def

% Check PostScript language level.
/languagelevel where {
  pop /gs_languagelevel languagelevel def
} {
  /gs_languagelevel 1 def
} ifelse
%%EndResource
%%BeginResource: procset Enscript-Encoding-88591 1.6 6
/encoding_vector [
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/space        	/exclam       	/quotedbl     	/numbersign   	
/dollar       	/percent      	/ampersand    	/quoteright   	
/parenleft    	/parenright   	/asterisk     	/plus         	
/comma        	/hyphen       	/period       	/slash        	
/zero         	/one          	/two          	/three        	
/four         	/five         	/six          	/seven        	
/eight        	/nine         	/colon        	/semicolon    	
/less         	/equal        	/greater      	/question     	
/at           	/A            	/B            	/C            	
/D            	/E            	/F            	/G            	
/H            	/I            	/J            	/K            	
/L            	/M            	/N            	/O            	
/P            	/Q            	/R            	/S            	
/T            	/U            	/V            	/W            	
/X            	/Y            	/Z            	/bracketleft  	
/backslash    	/bracketright 	/asciicircum  	/underscore   	
/quoteleft    	/a            	/b            	/c            	
/d            	/e            	/f            	/g            	
/h            	/i            	/j            	/k            	
/l            	/m            	/n            	/o            	
/p            	/q            	/r            	/s            	
/t            	/u            	/v            	/w            	
/x            	/y            	/z            	/braceleft    	
/bar          	/braceright   	/tilde        	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/.notdef      	/.notdef      	/.notdef      	/.notdef      	
/space        	/exclamdown   	/cent         	/sterling     	
/currency     	/yen          	/brokenbar    	/section      	
/dieresis     	/copyright    	/ordfeminine  	/guillemotleft	
/logicalnot   	/hyphen       	/registered   	/macron       	
/degree       	/plusminus    	/twosuperior  	/threesuperior	
/acute        	/mu           	/paragraph    	/bullet       	
/cedilla      	/onesuperior  	/ordmasculine 	/guillemotright	
/onequarter   	/onehalf      	/threequarters	/questiondown 	
/Agrave       	/Aacute       	/Acircumflex  	/Atilde       	
/Adieresis    	/Aring        	/AE           	/Ccedilla     	
/Egrave       	/Eacute       	/Ecircumflex  	/Edieresis    	
/Igrave       	/Iacute       	/Icircumflex  	/Idieresis    	
/Eth          	/Ntilde       	/Ograve       	/Oacute       	
/Ocircumflex  	/Otilde       	/Odieresis    	/multiply     	
/Oslash       	/Ugrave       	/Uacute       	/Ucircumflex  	
/Udieresis    	/Yacute       	/Thorn        	/germandbls   	
/agrave       	/aacute       	/acircumflex  	/atilde       	
/adieresis    	/aring        	/ae           	/ccedilla     	
/egrave       	/eacute       	/ecircumflex  	/edieresis    	
/igrave       	/iacute       	/icircumflex  	/idieresis    	
/eth          	/ntilde       	/ograve       	/oacute       	
/ocircumflex  	/otilde       	/odieresis    	/divide       	
/oslash       	/ugrave       	/uacute       	/ucircumflex  	
/udieresis    	/yacute       	/thorn        	/ydieresis    	
] def
%%EndResource
%%EndProlog
%%BeginSetup
%%IncludeResource: font Courier-Bold
%%IncludeResource: font Courier
/HFpt_w 10 def
/HFpt_h 10 def
/Courier-Bold /HF-gs-font MF
/HF /HF-gs-font findfont [HFpt_w 0 0 HFpt_h 0 0] makefont def
/Courier /F-gs-font MF
/F-gs-font 10 10 SF
/#copies 1 def
% Pagedevice definitions:
gs_languagelevel 1 gt {
  <<
    /PageSize [595 842] 
  >> setpagedevice
} if
/d_page_w 547 def
/d_page_h 794 def
/d_header_x 0 def
/d_header_y 794 def
/d_header_w 547 def
/d_header_h 0 def
/d_footer_x 0 def
/d_footer_y 0 def
/d_footer_w 547 def
/d_footer_h 0 def
/d_output_w 547 def
/d_output_h 794 def
/cols 1 def
%%EndSetup
%%Page: (1) 1
%%BeginPageSetup
_S
24 24 translate
/pagenum 1 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(RFC-024: Network Protocol) s
5 759 M
(Status: Draft) s
5 748 M
(Date: January 2026) s
5 737 M
(Author: Derrell Piper <ddp@eludom.net>) s
5 726 M
(Implementation: Proposed) s
5 704 M
(------------------------------------------------------------------------------) s
5 682 M
(Abstract) s
5 660 M
(This RFC specifies the network protocol for the Library of Cyberspace: how vaults discove) s
5 649 M
(r each other, authenticate, exchange objects, and synchronize state. The protocol is tran) s
5 638 M
(sport-agnostic, capability-authenticated, and optimized for content-addressed data.) s
5 616 M
(------------------------------------------------------------------------------) s
5 594 M
(Motivation) s
5 572 M
(Vaults must communicate to:) s
5 550 M
(- Replicate - Distribute objects across vaults) s
5 539 M
(- Federate - Link independent vaults into networks) s
5 528 M
(- Subscribe - Receive updates from publishers) s
5 517 M
(- Query - Search the distributed soup) s
5 495 M
(The protocol must handle:) s
5 473 M
(- Intermittent connectivity - Vaults may be offline) s
5 462 M
(- Untrusted networks - All communication authenticated) s
5 451 M
(- Large objects - Efficient chunked transfer) s
5 440 M
(- Partial sync - Resume interrupted transfers) s
5 418 M
(------------------------------------------------------------------------------) s
5 396 M
(Protocol Layers) s
5 374 M
(+-----------------------------------------+) s
5 363 M
(|           APPLICATION LAYER             |) s
5 352 M
(|  \(vault operations, soup queries\)       |) s
5 341 M
(+-----------------------------------------+) s
5 330 M
(|           MESSAGE LAYER                 |) s
5 319 M
(|  \(request/response, streaming\)          |) s
5 308 M
(+-----------------------------------------+) s
5 297 M
(|           SECURITY LAYER                |) s
5 286 M
(|  \(authentication, encryption\)           |) s
5 275 M
(+-----------------------------------------+) s
5 264 M
(|           TRANSPORT LAYER               |) s
5 253 M
(|  \(TCP, QUIC, Unix socket, etc.\)         |) s
5 242 M
(+-----------------------------------------+) s
5 220 M
(------------------------------------------------------------------------------) s
5 198 M
(Transport Layer) s
5 176 M
(Supported Transports) s
5 154 M
(\(define transports) s
5 143 M
(  '\(\(tcp "Traditional TCP/IP"\)) s
5 132 M
(    \(quic "UDP-based, multiplexed"\)) s
5 121 M
(    \(unix "Local Unix domain socket"\)) s
5 110 M
(    \(tor "Onion-routed TCP"\)) s
5 99 M
(    \(i2p "Garlic-routed"\)) s
5 88 M
(    \(bluetooth "Local mesh"\)) s
5 77 M
(    \(sneakernet "Physical media exchange"\)\)\)) s
5 55 M
(Connection Establishment) s
5 33 M
(\(define \(connect-vault address transport\)) s
5 22 M
(  "Establish connection to remote vault") s
5 11 M
(  \(let* \(\(socket \(transport-connect transport address\)\)) s
_R
S
%%Page: (2) 2
%%BeginPageSetup
_S
24 24 translate
/pagenum 2 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(         \(connection \(make-connection socket transport\)\)\)) s
5 759 M
(    ;; Perform handshake) s
5 748 M
(    \(connection-handshake connection\)) s
5 726 M
(    ;; Return authenticated connection) s
5 715 M
(    connection\)\)) s
5 693 M
(Multiplexing) s
5 671 M
(Multiple streams over single connection:) s
5 649 M
(\(define \(open-stream connection stream-type\)) s
5 638 M
(  "Open multiplexed stream within connection") s
5 627 M
(  \(let \(\(stream-id \(allocate-stream-id connection\)\)\)) s
5 616 M
(    \(send-frame connection) s
5 605 M
(      \(frame type: 'stream-open) s
5 594 M
(             stream-id: stream-id) s
5 583 M
(             stream-type: stream-type\)\)) s
5 572 M
(    \(make-stream connection stream-id stream-type\)\)\)) s
5 550 M
(------------------------------------------------------------------------------) s
5 528 M
(Security Layer) s
5 506 M
(Handshake Protocol) s
5 484 M
(Mutual authentication using SPKI certificates:) s
5 462 M
(Client                                   Server) s
5 451 M
(  |                                        |) s
5 440 M
(  |---- ClientHello ----------------------\342\\226\266|) s
5 429 M
(  |     \(protocol version, capabilities\)   |) s
5 418 M
(  |                                        |) s
5 407 M
(  |\342\\227\\200---- ServerHello ---------------------|) s
5 396 M
(  |      \(protocol version, certificate\)   |) s
5 385 M
(  |                                        |) s
5 374 M
(  |---- ClientAuth -----------------------\342\\226\266|) s
5 363 M
(  |     \(certificate, challenge-response\)  |) s
5 352 M
(  |                                        |) s
5 341 M
(  |\342\\227\\200---- ServerAuth ----------------------|) s
5 330 M
(  |      \(challenge-response\)              |) s
5 319 M
(  |                                        |) s
5 308 M
(  |\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220 Encrypted Channel \342\\225\\220\342) s
5 297 M
(\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220\342\\225\\220) s
5 286 M
(\342\\225\\220\342\\225\\220\342\\225\\220|) s
5 264 M
(Handshake Implementation) s
5 242 M
(\(define \(connection-handshake connection\)) s
5 231 M
(  "Perform mutual authentication handshake") s
5 209 M
(  ;; Send ClientHello) s
5 198 M
(  \(send-message connection) s
5 187 M
(    `\(client-hello) s
5 176 M
(      \(version ,protocol-version\)) s
5 165 M
(      \(capabilities ,\(local-capabilities\)\)\)\)) s
5 143 M
(  ;; Receive ServerHello) s
5 132 M
(  \(let \(\(server-hello \(receive-message connection\)\)\)) s
5 121 M
(    \(verify-protocol-version \(server-hello-version server-hello\)\)) s
5 99 M
(    ;; Verify server certificate) s
5 88 M
(    \(let \(\(server-cert \(server-hello-certificate server-hello\)\)\)) s
5 77 M
(      \(unless \(verify-certificate server-cert\)) s
5 66 M
(        \(error "Server certificate invalid"\)\)) s
5 44 M
(      ;; Generate session key using X25519) s
5 33 M
(      \(let* \(\(ephemeral-keypair \(x25519-keypair\)\)) s
5 22 M
(             \(shared-secret \(x25519-shared \(keypair-secret ephemeral-keypair\)) s
5 11 M
(                                          \(cert-public-key server-cert\)\)\)\)) s
_R
S
%%Page: (3) 3
%%BeginPageSetup
_S
24 24 translate
/pagenum 3 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(        ;; Send ClientAuth) s
5 759 M
(        \(send-message connection) s
5 748 M
(          `\(client-auth) s
5 737 M
(            \(certificate ,\(local-certificate\)\)) s
5 726 M
(            \(ephemeral-public ,\(keypair-public ephemeral-keypair\)\)) s
5 715 M
(            \(signature ,\(sign-challenge server-hello\)\)\)\)) s
5 693 M
(        ;; Receive ServerAuth) s
5 682 M
(        \(let \(\(server-auth \(receive-message connection\)\)\)) s
5 671 M
(          \(unless \(verify-server-signature server-auth server-cert\)) s
5 660 M
(            \(error "Server authentication failed"\)\)) s
5 638 M
(          ;; Derive session keys) s
5 627 M
(          \(derive-session-keys connection shared-secret\)\)\)\)\)\)) s
5 605 M
(Session Encryption) s
5 583 M
(\(define \(derive-session-keys connection shared-secret\)) s
5 572 M
(  "Derive symmetric keys for session") s
5 561 M
(  \(let* \(\(key-material \(hkdf shared-secret) s
5 550 M
(                             info: "library-session") s
5 539 M
(                             length: 64\)\)) s
5 528 M
(         \(client-key \(subbytes key-material 0 32\)\)) s
5 517 M
(         \(server-key \(subbytes key-material 32 64\)\)\)) s
5 495 M
(    \(set-connection-keys! connection) s
5 484 M
(      \(if \(connection-is-client? connection\)) s
5 473 M
(          \(keys send: client-key receive: server-key\)) s
5 462 M
(          \(keys send: server-key receive: client-key\)\)\)\)\)) s
5 440 M
(\(define \(encrypt-message connection message\)) s
5 429 M
(  "Encrypt message with session key") s
5 418 M
(  \(let \(\(nonce \(connection-next-nonce connection\)\)\)) s
5 407 M
(    \(chacha20-poly1305-encrypt) s
5 396 M
(      \(connection-send-key connection\)) s
5 385 M
(      nonce) s
5 374 M
(      \(serialize message\)\)\)\)) s
5 352 M
(\(define \(decrypt-message connection ciphertext\)) s
5 341 M
(  "Decrypt message with session key") s
5 330 M
(  \(let \(\(nonce \(connection-next-nonce connection\)\)\)) s
5 319 M
(    \(deserialize) s
5 308 M
(      \(chacha20-poly1305-decrypt) s
5 297 M
(        \(connection-receive-key connection\)) s
5 286 M
(        nonce) s
5 275 M
(        ciphertext\)\)\)\)) s
5 253 M
(------------------------------------------------------------------------------) s
5 231 M
(Message Layer) s
5 209 M
(Message Format) s
5 187 M
(\(library-message) s
5 176 M
(  \(version 1\)) s
5 165 M
(  \(type request|response|stream|error\)) s
5 154 M
(  \(id <message-id>\)) s
5 143 M
(  \(in-reply-to <message-id>|#f\)) s
5 132 M
(  \(capability <spki-cert>|#f\)) s
5 121 M
(  \(body <payload>\)\)) s
5 99 M
(Request Types) s
5 77 M
(\(define request-types) s
5 66 M
(  '\(;; Object operations) s
5 55 M
(    \(get-object hash\)) s
5 44 M
(    \(put-object hash data\)) s
5 33 M
(    \(has-object hash\)) s
5 11 M
(    ;; Bulk operations) s
_R
S
%%Page: (4) 4
%%BeginPageSetup
_S
24 24 translate
/pagenum 4 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(    \(get-objects hashes\)) s
5 770 M
(    \(get-tree root-hash\)) s
5 759 M
(    \(sync-objects bloom-filter\)) s
5 737 M
(    ;; Soup queries) s
5 726 M
(    \(soup-query query\)) s
5 715 M
(    \(soup-subscribe query\)) s
5 693 M
(    ;; Vault operations) s
5 682 M
(    \(get-refs pattern\)) s
5 671 M
(    \(get-head\)) s
5 660 M
(    \(get-releases\)) s
5 638 M
(    ;; Discovery) s
5 627 M
(    \(get-capabilities\)) s
5 616 M
(    \(get-peers\)\)\)) s
5 594 M
(Request/Response) s
5 572 M
(\(define \(vault-request connection request #!key capability timeout\)) s
5 561 M
(  "Send request, wait for response") s
5 550 M
(  \(let \(\(message-id \(generate-message-id\)\)\)) s
5 528 M
(    ;; Send request) s
5 517 M
(    \(send-message connection) s
5 506 M
(      \(library-message) s
5 495 M
(        version: 1) s
5 484 M
(        type: 'request) s
5 473 M
(        id: message-id) s
5 462 M
(        capability: capability) s
5 451 M
(        body: request\)\)) s
5 429 M
(    ;; Wait for response) s
5 418 M
(    \(let \(\(response \(receive-response connection message-id timeout\)\)\)) s
5 407 M
(      \(if \(eq? \(message-type response\) 'error\)) s
5 396 M
(          \(error \(message-body response\)\)) s
5 385 M
(          \(message-body response\)\)\)\)\)) s
5 363 M
(Streaming) s
5 341 M
(For large transfers:) s
5 319 M
(\(define \(stream-object connection hash\)) s
5 308 M
(  "Stream large object in chunks") s
5 297 M
(  \(let \(\(stream \(open-stream connection 'object-transfer\)\)\)) s
5 275 M
(    ;; Send chunks) s
5 264 M
(    \(let \(\(data \(cas-get hash\)\)\)) s
5 253 M
(      \(let loop \(\(offset 0\)\)) s
5 242 M
(        \(when \(< offset \(blob-length data\)\)) s
5 231 M
(          \(let \(\(chunk \(blob-copy data offset chunk-size\)\)\)) s
5 220 M
(            \(stream-send stream chunk\)) s
5 209 M
(            \(loop \(+ offset chunk-size\)\)\)\)\)) s
5 187 M
(      ;; End stream) s
5 176 M
(      \(stream-close stream\)\)\)\)) s
5 154 M
(\(define \(receive-stream connection stream callback\)) s
5 143 M
(  "Receive streamed data") s
5 132 M
(  \(let loop \(\(chunks '\(\)\)\)) s
5 121 M
(    \(let \(\(chunk \(stream-receive stream\)\)\)) s
5 110 M
(      \(if \(stream-ended? stream\)) s
5 99 M
(          \(apply bytes-append \(reverse chunks\)\)) s
5 88 M
(          \(begin) s
5 77 M
(            \(callback chunk\)) s
5 66 M
(            \(loop \(cons chunk chunks\)\)\)\)\)\)\)) s
5 44 M
(------------------------------------------------------------------------------) s
5 22 M
(Object Exchange) s
_R
S
%%Page: (5) 5
%%BeginPageSetup
_S
24 24 translate
/pagenum 5 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(Get Object) s
5 759 M
(;; Request) s
5 748 M
(\(get-object) s
5 737 M
(  \(hash "sha256:abc123..."\)\)) s
5 715 M
(;; Response \(small object\)) s
5 704 M
(\(object-data) s
5 693 M
(  \(hash "sha256:abc123..."\)) s
5 682 M
(  \(size 1024\)) s
5 671 M
(  \(data #${...}\)\)) s
5 649 M
(;; Response \(large object - streaming\)) s
5 638 M
(\(object-stream) s
5 627 M
(  \(hash "sha256:abc123..."\)) s
5 616 M
(  \(size 10485760\)) s
5 605 M
(  \(stream-id 42\)\)) s
5 583 M
(Put Object) s
5 561 M
(;; Request) s
5 550 M
(\(put-object) s
5 539 M
(  \(hash "sha256:abc123..."\)) s
5 528 M
(  \(data #${...}\)\)) s
5 506 M
(;; Response) s
5 495 M
(\(put-result) s
5 484 M
(  \(hash "sha256:abc123..."\)) s
5 473 M
(  \(status stored|duplicate|rejected\)) s
5 462 M
(  \(reason #f|"quota exceeded"\)\)) s
5 440 M
(Batch Operations) s
5 418 M
(;; Request multiple objects) s
5 407 M
(\(get-objects) s
5 396 M
(  \(hashes \("sha256:aaa..." "sha256:bbb..." "sha256:ccc..."\)\)\)) s
5 374 M
(;; Response) s
5 363 M
(\(objects-batch) s
5 352 M
(  \(objects) s
5 341 M
(    \(\(hash "sha256:aaa..." data #${...}\)) s
5 330 M
(     \(hash "sha256:bbb..." data #${...}\)) s
5 319 M
(     \(hash "sha256:ccc..." status: missing\)\)\)\)) s
5 297 M
(Tree Transfer) s
5 275 M
(Efficient Merkle tree sync:) s
5 253 M
(;; Request tree) s
5 242 M
(\(get-tree) s
5 231 M
(  \(root "sha256:root..."\)) s
5 220 M
(  \(depth 3\)  ; How deep to fetch) s
5 209 M
(  \(exclude \("sha256:already-have..."\)\)\)) s
5 187 M
(;; Response) s
5 176 M
(\(tree-data) s
5 165 M
(  \(root "sha256:root..."\)) s
5 154 M
(  \(objects) s
5 143 M
(    \(\(hash "sha256:root..." data #${...}\)) s
5 132 M
(     \(hash "sha256:child1..." data #${...}\)) s
5 121 M
(     \(hash "sha256:child2..." data #${...}\)\)\)\)) s
5 99 M
(------------------------------------------------------------------------------) s
5 77 M
(Synchronization) s
5 55 M
(Bloom Filter Exchange) s
5 33 M
(Efficient "what do you have?" queries:) s
5 11 M
(;; Step 1: Exchange bloom filters) s
_R
S
%%Page: (6) 6
%%BeginPageSetup
_S
24 24 translate
/pagenum 6 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(\(define \(sync-init local-vault remote-connection\)) s
5 770 M
(  \(let \(\(local-bloom \(vault-bloom-filter local-vault\)\)\)) s
5 748 M
(    ;; Send our bloom filter) s
5 737 M
(    \(send-message remote-connection) s
5 726 M
(      `\(sync-bloom) s
5 715 M
(        \(filter ,local-bloom\)) s
5 704 M
(        \(population ,\(bloom-population local-bloom\)\)\)\)) s
5 682 M
(    ;; Receive their bloom filter) s
5 671 M
(    \(let \(\(remote-bloom \(receive-bloom remote-connection\)\)\)) s
5 649 M
(      ;; Compute what they might want) s
5 638 M
(      \(let \(\(to-send \(filter \(lambda \(hash\)) s
5 627 M
(                               \(not \(bloom-contains? remote-bloom hash\)\)\)) s
5 616 M
(                             \(vault-all-hashes local-vault\)\)\)\)) s
5 605 M
(        to-send\)\)\)\)) s
5 583 M
(;; Step 2: Exchange missing objects) s
5 572 M
(\(define \(sync-exchange to-send to-receive connection\)) s
5 561 M
(  \(parallel) s
5 550 M
(    ;; Send what they need) s
5 539 M
(    \(for-each \(lambda \(hash\)) s
5 528 M
(                \(stream-object connection hash\)\)) s
5 517 M
(              to-send\)) s
5 506 M
(    ;; Receive what we need) s
5 495 M
(    \(for-each \(lambda \(hash\)) s
5 484 M
(                \(receive-object connection hash\)\)) s
5 473 M
(              to-receive\)\)\)) s
5 451 M
(Incremental Sync) s
5 429 M
(\(define \(incremental-sync local-vault remote-connection since\)) s
5 418 M
(  "Sync changes since timestamp or commit") s
5 396 M
(  ;; Get remote changes) s
5 385 M
(  \(let \(\(remote-changes \(vault-request remote-connection) s
5 374 M
(                          `\(changes-since ,since\)\)\)\)) s
5 352 M
(    ;; Get local changes) s
5 341 M
(    \(let \(\(local-changes \(vault-changes-since local-vault since\)\)\)) s
5 319 M
(      ;; Bidirectional merge) s
5 308 M
(      \(sync-merge local-vault remote-connection) s
5 297 M
(                  local-changes remote-changes\)\)\)\)) s
5 275 M
(Conflict Resolution) s
5 253 M
(\(define \(sync-merge local-vault remote changes-local changes-remote\)) s
5 242 M
(  "Merge changes with conflict resolution") s
5 220 M
(  \(for-each) s
5 209 M
(    \(lambda \(hash\)) s
5 198 M
(      \(cond) s
5 187 M
(        ;; Only local has it - push) s
5 176 M
(        \(\(and \(member hash changes-local\)) s
5 165 M
(              \(not \(member hash changes-remote\)\)\)) s
5 154 M
(         \(push-object local-vault remote hash\)\)) s
5 132 M
(        ;; Only remote has it - pull) s
5 121 M
(        \(\(and \(member hash changes-remote\)) s
5 110 M
(              \(not \(member hash changes-local\)\)\)) s
5 99 M
(         \(pull-object local-vault remote hash\)\)) s
5 77 M
(        ;; Both have it - verify same) s
5 66 M
(        \(\(and \(member hash changes-local\)) s
5 55 M
(              \(member hash changes-remote\)\)) s
5 44 M
(         ;; Content-addressed, so same hash = same content) s
5 33 M
(         #t\)\)\)) s
5 22 M
(    \(union changes-local changes-remote\)\)\)) s
_R
S
%%Page: (7) 7
%%BeginPageSetup
_S
24 24 translate
/pagenum 7 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(------------------------------------------------------------------------------) s
5 759 M
(Discovery) s
5 737 M
(Peer Discovery) s
5 715 M
(;; Well-known peers \(bootstrap\)) s
5 704 M
(\(define \(discover-bootstrap\)) s
5 693 M
(  \(map parse-address) s
5 682 M
(       \(read-file "/etc/library/bootstrap-peers"\)\)\)) s
5 660 M
(;; mDNS/DNS-SD for local network) s
5 649 M
(\(define \(discover-local\)) s
5 638 M
(  \(mdns-browse "library.tcp.local"\)\)) s
5 616 M
(;; DHT for global discovery) s
5 605 M
(\(define \(discover-dht target-hash\)) s
5 594 M
(  \(dht-find-providers target-hash\)\)) s
5 572 M
(;; Peer exchange) s
5 561 M
(\(define \(discover-pex connection\)) s
5 550 M
(  \(vault-request connection '\(get-peers\)\)\)) s
5 528 M
(Capability Advertisement) s
5 506 M
(;; Query vault capabilities) s
5 495 M
(\(get-capabilities\)) s
5 473 M
(;; Response) s
5 462 M
(\(vault-capabilities) s
5 451 M
(  \(protocol-version 1\)) s
5 440 M
(  \(features \(bloom-sync tree-transfer streaming soup-query\)\)) s
5 429 M
(  \(max-object-size 104857600\)  ; 100MB) s
5 418 M
(  \(storage-available 10737418240\)  ; 10GB) s
5 407 M
(  \(public-key "ed25519:abc..."\)) s
5 396 M
(  \(services) s
5 385 M
(    \(\(soup-query rate-limit: 100/minute\)) s
5 374 M
(     \(object-transfer rate-limit: 10MB/second\)\)\)\)) s
5 352 M
(------------------------------------------------------------------------------) s
5 330 M
(Soup Queries) s
5 308 M
(Remote Query) s
5 286 M
(;; Query remote soup) s
5 275 M
(\(soup-query) s
5 264 M
(  \(type certificate\)) s
5 253 M
(  \(issuer "vault-admin"\)) s
5 242 M
(  \(limit 100\)\)) s
5 220 M
(;; Response) s
5 209 M
(\(soup-results) s
5 198 M
(  \(count 47\)) s
5 187 M
(  \(objects) s
5 176 M
(    \(\(name "cert/alice" type certificate ...\)) s
5 165 M
(     \(name "cert/bob" type certificate ...\)) s
5 154 M
(     ...\)\)\)) s
5 132 M
(Subscription) s
5 110 M
(;; Subscribe to soup changes) s
5 99 M
(\(soup-subscribe) s
5 88 M
(  \(query \(type release\)\)) s
5 77 M
(  \(callback-url "library://my-vault/callbacks/releases"\)\)) s
5 55 M
(;; Subscription confirmation) s
5 44 M
(\(subscription) s
5 33 M
(  \(id "sub-123"\)) s
5 22 M
(  \(query \(type release\)\)) s
5 11 M
(  \(expires "2026-02-07T00:00:00Z"\)\)) s
_R
S
%%Page: (8) 8
%%BeginPageSetup
_S
24 24 translate
/pagenum 8 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 770 M
(;; Push notification \(when matching object appears\)) s
5 759 M
(\(soup-notification) s
5 748 M
(  \(subscription-id "sub-123"\)) s
5 737 M
(  \(object \(name "release/1.2.0" type release ...\)\)\)) s
5 715 M
(------------------------------------------------------------------------------) s
5 693 M
(Error Handling) s
5 671 M
(Error Types) s
5 649 M
(\(define error-types) s
5 638 M
(  '\(\(not-found "Object not found"\)) s
5 627 M
(    \(unauthorized "Capability required"\)) s
5 616 M
(    \(forbidden "Capability insufficient"\)) s
5 605 M
(    \(quota-exceeded "Storage quota exceeded"\)) s
5 594 M
(    \(rate-limited "Too many requests"\)) s
5 583 M
(    \(timeout "Operation timed out"\)) s
5 572 M
(    \(invalid-request "Malformed request"\)) s
5 561 M
(    \(internal-error "Server error"\)) s
5 550 M
(    \(unavailable "Service temporarily unavailable"\)\)\)) s
5 528 M
(Error Response) s
5 506 M
(\(library-message) s
5 495 M
(  \(type error\)) s
5 484 M
(  \(id <message-id>\)) s
5 473 M
(  \(in-reply-to <request-id>\)) s
5 462 M
(  \(body) s
5 451 M
(    \(error-response) s
5 440 M
(      \(code not-found\)) s
5 429 M
(      \(message "Object sha256:abc... not found"\)) s
5 418 M
(      \(retry-after #f\)\)\)\)) s
5 396 M
(Retry Logic) s
5 374 M
(\(define \(vault-request-with-retry connection request #!key max-retries\)) s
5 363 M
(  "Request with exponential backoff retry") s
5 352 M
(  \(let loop \(\(attempt 0\) \(delay 1000\)\)) s
5 341 M
(    \(let \(\(result \(vault-request connection request\)\)\)) s
5 330 M
(      \(if \(and \(error-response? result\)) s
5 319 M
(               \(retryable-error? result\)) s
5 308 M
(               \(< attempt max-retries\)\)) s
5 297 M
(          \(begin) s
5 286 M
(            \(sleep delay\)) s
5 275 M
(            \(loop \(+ attempt 1\) \(* delay 2\)\)\)) s
5 264 M
(          result\)\)\)\)) s
5 242 M
(------------------------------------------------------------------------------) s
5 220 M
(Security Considerations) s
5 198 M
(Capability Verification) s
5 176 M
(\(define \(verify-request-capability request connection\)) s
5 165 M
(  "Verify request has sufficient capability") s
5 154 M
(  \(let \(\(required-cap \(request->capability request\)\)) s
5 143 M
(        \(presented-cap \(message-capability request\)\)\)) s
5 121 M
(    \(unless presented-cap) s
5 110 M
(      \(error 'unauthorized "Capability required"\)\)) s
5 88 M
(    \(unless \(valid-certificate? presented-cap\)) s
5 77 M
(      \(error 'unauthorized "Invalid capability certificate"\)\)) s
5 55 M
(    \(unless \(capability-grants? presented-cap required-cap\)) s
5 44 M
(      \(error 'forbidden "Insufficient capability"\)\)) s
5 22 M
(    ;; Verify capability chain back to trusted root) s
5 11 M
(    \(unless \(verify-capability-chain presented-cap\)) s
_R
S
%%Page: (9) 9
%%BeginPageSetup
_S
24 24 translate
/pagenum 9 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(      \(error 'forbidden "Capability chain invalid"\)\)\)\)) s
5 759 M
(Denial of Service Protection) s
5 737 M
(\(define \(rate-limit connection request-type\)) s
5 726 M
(  "Apply rate limiting") s
5 715 M
(  \(let \(\(limit \(get-rate-limit request-type\)\)) s
5 704 M
(        \(current \(connection-request-count connection request-type\)\)\)) s
5 693 M
(    \(when \(> current limit\)) s
5 682 M
(      \(error 'rate-limited) s
5 671 M
(             \(format "Rate limit exceeded: ~a/~a" current limit\)\)\)\)\)) s
5 649 M
(\(define \(size-limit request\)) s
5 638 M
(  "Enforce size limits") s
5 627 M
(  \(when \(> \(request-size request\) max-request-size\)) s
5 616 M
(    \(error 'invalid-request "Request too large"\)\)\)) s
5 594 M
(Replay Prevention) s
5 572 M
(\(define \(verify-nonce connection message\)) s
5 561 M
(  "Prevent replay attacks") s
5 550 M
(  \(let \(\(nonce \(message-nonce message\)\)\)) s
5 539 M
(    \(when \(nonce-seen? connection nonce\)) s
5 528 M
(      \(error 'invalid-request "Replay detected"\)\)) s
5 517 M
(    \(record-nonce connection nonce\)\)\)) s
5 495 M
(------------------------------------------------------------------------------) s
5 473 M
(Implementation Notes) s
5 451 M
(Wire Format) s
5 429 M
(Messages serialized as canonical S-expressions:) s
5 407 M
(\(define \(serialize-message message\)) s
5 396 M
(  "Canonical S-expression serialization") s
5 385 M
(  \(canonical-sexp->bytes message\)\)) s
5 363 M
(\(define \(deserialize-message bytes\)) s
5 352 M
(  "Parse S-expression") s
5 341 M
(  \(bytes->canonical-sexp bytes\)\)) s
5 319 M
(Compression) s
5 297 M
(Optional compression for large payloads:) s
5 275 M
(\(define \(maybe-compress data\)) s
5 264 M
(  \(if \(> \(blob-length data\) compression-threshold\)) s
5 253 M
(      \(values \(zstd-compress data\) 'zstd\)) s
5 242 M
(      \(values data 'none\)\)\)) s
5 220 M
(Connection Pooling) s
5 198 M
(\(define connection-pool \(make-hash-table\)\)) s
5 176 M
(\(define \(get-connection address\)) s
5 165 M
(  "Get pooled connection or create new") s
5 154 M
(  \(or \(hash-table-ref connection-pool address #f\)) s
5 143 M
(      \(let \(\(conn \(connect-vault address\)\)\)) s
5 132 M
(        \(hash-table-set! connection-pool address conn\)) s
5 121 M
(        conn\)\)\)) s
5 99 M
(------------------------------------------------------------------------------) s
5 77 M
(References) s
5 55 M
(1. QUIC Protocol - RFC 9000) s
5 44 M
(2. Noise Protocol Framework) s
5 33 M
(3. RFC-020: Content-Addressed Storage) s
5 22 M
(4. RFC-021: Capability Delegation) s
5 11 M
(5. IPFS Bitswap Protocol) s
_R
S
%%Page: (10) 10
%%BeginPageSetup
_S
24 24 translate
/pagenum 10 def
/fname (rfc-024-network-protocol.txt) def
/fdir (.) def
/ftail (rfc-024-network-protocol.txt) def
/user_header_p false def
/user_footer_p false def
%%EndPageSetup
5 781 M
(6. libp2p Specifications) s
5 759 M
(------------------------------------------------------------------------------) s
5 737 M
(Changelog) s
5 715 M
(- 2026-01-07 - Initial draft) s
5 693 M
(------------------------------------------------------------------------------) s
5 671 M
(Implementation Status: Draft) s
5 660 M
(Dependencies: transport, crypto, cas) s
5 649 M
(Integration: Replication, federation, distributed soup) s
_R
S
%%Trailer
%%Pages: 10
%%DocumentNeededResources: font Courier-Bold Courier 
%%EOF
