%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Mon Jan 12 10:28:48 2026
%%DocumentNeededResources: font Times-Bold
%%+ font Times-Italic
%%+ font Times-Roman
%%+ font Courier
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 14
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Italic
%%IncludeResource: font Times-Roman
%%IncludeResource: font Courier
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Courier@0 ENC0/Courier RE/Times-Roman@0 ENC0/Times-Roman RE
/Times-Italic@0 ENC0/Times-Italic RE/Times-Bold@0 ENC0/Times-Bold RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF(RFC-024: Netw)233.856 123 Q(ork Pr)-.12 E(otocol)
-.216 E/F1 10/Times-Italic@0 SF(Libr)260.85 159 Q(ary of Cyber)-.15 E
(space)-.1 E/F2 10/Times-Roman@0 SF(2026)296 177 Q F1(ABSTRA)282.535 213
Q(CT)-.3 E/F3 10/Times-Bold@0 SF 2.5(1. Abstract)72 261 R F2 .066
(This RFC speci\214es the netw)72 276.6 R .066
(ork protocol for the Library of Cyberspace: ho)-.1 F 2.565(wv)-.25 G
.065(aults disco)-2.815 F -.15(ve)-.15 G 2.565(re).15 G .065(ach other)
-2.565 F 2.565(,a)-.4 G(uthenticate,)-2.565 E -.15(ex)72 288.6 S .471(c\
hange objects, and synchronize state. The protocol is transport-agnosti\
c, capability-authenticated, and optimized).15 F
(for content-addressed data.)72 300.6 Q F3 2.5(2. Moti)72 324.6 R -.1
(va)-.1 G(tion).1 E F2 -1.11(Va)72 340.2 S(ults must communicate to:)
1.11 E 6.5<8352>72 355.8 S(eplicate)-6.5 E 6.5<8344>72 371.4 S(istrib)
-6.5 E(ute objects across v)-.2 E(aults)-.25 E 6.5<8346>72 387 S
(ederate)-6.5 E 6.5<834c>72 402.6 S(ink independent v)-6.5 E
(aults into netw)-.25 E(orks)-.1 E 6.5<8353>72 418.2 S(ubscribe)-6.5 E
6.5<8352>72 433.8 S(ecei)-6.5 E .3 -.15(ve u)-.25 H
(pdates from publishers).15 E 6.5<8351>72 449.4 S(uery)-6.5 E 6.5<8353>
72 465 S(earch the distrib)-6.5 E(uted soup)-.2 E
(The protocol must handle:)72 484.2 Q 6.5<8349>72 499.8 S
(ntermittent connecti)-6.5 E(vity)-.25 E 6.5<8356>72 515.4 S
(aults may be of)-7.61 E(\215ine)-.25 E 6.5<8355>72 531 S(ntrusted netw)
-6.5 E(orks)-.1 E 6.5<8341>72 546.6 S(ll communication authenticated)
-6.5 E 6.5<834c>72 562.2 S(ar)-6.5 E(ge objects)-.18 E 6.5<8345>72 577.8
S -.25<668c>-6.5 G(cient chunk).25 E(ed transfer)-.1 E 6.5<8350>72 593.4
S(artial sync)-6.65 E 6.5<8352>72 609 S(esume interrupted transfers)-6.5
E 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(3. Pr)72 84 R(otocol Lay)-.18 E(ers)-.1 E/F2 8/Courier@0 SF
(+-----------------------------------------+)108 102 Q 52.8(|A)108 114 S
(PPLICATION LAYER)-52.8 E(|)62.4 E 9.6(|\()108 126 S
(vault operations, soup queries\))-9.6 E(|)33.6 E
(+-----------------------------------------+)108 138 Q 52.8(|M)108 150 S
(ESSAGE LAYER)-52.8 E(|)81.6 E 9.6(|\()108 162 S
(request/response, streaming\))-9.6 E(|)48 E
(+-----------------------------------------+)108 174 Q 52.8(|S)108 186 S
(ECURITY LAYER)-52.8 E(|)76.8 E 9.6(|\()108 198 S
(authentication, encryption\))-9.6 E(|)52.8 E
(+-----------------------------------------+)108 210 Q 52.8(|T)108 222 S
(RANSPORT LAYER)-52.8 E(|)72 E 9.6(|\()108 234 S
(TCP, QUIC, Unix socket, etc.\))-9.6 E(|)43.2 E
(+-----------------------------------------+)108 246 Q F1 2.5(4. T)72
264 R(ransport Lay)-.74 E(er)-.1 E 2.5(4.1. Supported)72 288 R -.74(Tr)
2.5 G(ansports).74 E F2(\(define transports)108 306 Q
('\(\(tcp "Traditional TCP/IP"\))117.6 318 Q
(\(quic "UDP-based, multiplexed"\))127.2 330 Q
(\(unix "Local Unix domain socket"\))127.2 342 Q
(\(tor "Onion-routed TCP"\))127.2 354 Q(\(i2p "Garlic-routed"\))127.2
366 Q(\(bluetooth "Local mesh"\))127.2 378 Q
(\(sneakernet "Physical media exchange"\)\)\))127.2 390 Q F1 2.5
(4.2. Connection)72 408 R(Establishment)2.5 E F2
(\(define \(connect-vault address transport\))108 426 Q
("Establish connection to remote vault")117.6 438 Q
(\(let* \(\(socket \(transport-connect transport address\)\))117.6 450 Q
(\(connection \(make-connection socket transport\)\)\))151.2 462 Q
(;; Perform handshake)127.2 486 Q(\(connection-handshake connection\))
127.2 498 Q(;; Return authenticated connection)127.2 522 Q
(connection\)\))127.2 534 Q F1 2.5(4.3. Multiplexing)72 552 R F0
(Multiple streams o)72 567.6 Q -.15(ve)-.15 G 2.5(rs).15 G
(ingle connection:)-2.5 E F2
(\(define \(open-stream connection stream-type\))108 585.6 Q
("Open multiplexed stream within connection")117.6 597.6 Q
(\(let \(\(stream-id \(allocate-stream-id connection\)\)\))117.6 609.6 Q
(\(send-frame connection)127.2 621.6 Q(\(frame type: 'stream-open)136.8
633.6 Q(stream-id: stream-id)170.4 645.6 Q(stream-type: stream-type\)\))
170.4 657.6 Q(\(make-stream connection stream-id stream-type\)\)\))127.2
669.6 Q F1 2.5(5. Security)72 687.6 R(Lay)2.5 E(er)-.1 E 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.1. Handshak)72 84 R 2.5(eP)-.1 G -.18(ro)-2.5 G(tocol).18 E F0
(Mutual authentication using SPKI certi\214cates:)72 99.6 Q/F2 8
/Courier@0 SF 163.2(Client Server)108 117.6 R 192(||)117.6 129.6 S
(|---- ClientHello ---------------------->|)117.6 141.6 Q 24(|\()117.6
153.6 S(protocol version, capabilities\))-24 E(|)14.4 E 192(||)117.6
165.6 S(|<---- ServerHello ---------------------|)117.6 177.6 Q 28.8
(|\()117.6 189.6 S(protocol version, certificate\))-28.8 E(|)14.4 E 192
(||)117.6 201.6 S(|---- ClientAuth ----------------------->|)117.6 213.6
Q 24(|\()117.6 225.6 S(certificate, challenge-response\))-24 E(|)9.6 E
192(||)117.6 237.6 S(|<---- ServerAuth ----------------------|)117.6
249.6 Q 28.8(|\()117.6 261.6 S 62.4(challenge-response\) |)-28.8 F 192
(||)117.6 273.6 S(|------ Encrypted Channel --------------|)117.6 285.6
Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.2. Handshak)72 84 R 2.5(eI)-.1 G(mplementation)-2.5 E/F2 8
/Courier@0 SF(\(define \(connection-handshake connection\))108 102 Q
("Perform mutual authentication handshake")117.6 114 Q
(;; Send ClientHello)117.6 138 Q(\(send-message connection)117.6 150 Q
(\(client-hello)127.2 162 Q(\(version ,protocol-version\))136.8 174 Q
(\(capabilities ,\(local-capabilities\)\)\)\))136.8 186 Q
(;; Receive ServerHello)117.6 210 Q
(\(let \(\(server-hello \(receive-message connection\)\)\))117.6 222 Q
(\(verify-protocol-version \(server-hello-version server-hello\)\))127.2
234 Q(;; Verify server certificate)127.2 258 Q
(\(let \(\(server-cert \(server-hello-certificate server-hello\)\)\))
127.2 270 Q(\(unless \(verify-certificate server-cert\))136.8 282 Q
(\(error "Server certificate invalid"\)\))146.4 294 Q
(;; Generate session key using X25519)136.8 318 Q
(\(let* \(\(ephemeral-keypair \(x25519-keypair\)\))136.8 330 Q
(\(shared-secret \(x25519-shared \(keypair-secret ephemeral-keypair\))
170.4 342 Q(\(cert-public-key server-cert\)\)\)\))309.6 354 Q
(;; Send ClientAuth)146.4 378 Q(\(send-message connection)146.4 390 Q
(\(client-auth)156 402 Q(\(certificate ,\(local-certificate\)\))165.6
414 Q(\(ephemeral-public ,\(keypair-public ephemeral-keypair\)\))165.6
426 Q(\(signature ,\(sign-challenge server-hello\)\)\)\))165.6 438 Q
(;; Receive ServerAuth)146.4 462 Q
(\(let \(\(server-auth \(receive-message connection\)\)\))146.4 474 Q
(\(unless \(verify-server-signature server-auth server-cert\))156 486 Q
(\(error "Server authentication failed"\)\))165.6 498 Q
(;; Derive session keys)156 522 Q
(\(derive-session-keys connection shared-secret\)\)\)\)\)\))156 534 Q 0
Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.3. Session)72 84 R(Encryption)2.5 E/F2 8/Courier@0 SF
(\(define \(derive-session-keys connection shared-secret\))108 102 Q
("Derive symmetric keys for session")117.6 114 Q
(\(let* \(\(key-material \(hkdf shared-secret)117.6 126 Q
(info: "library-session")247.2 138 Q(length: 64\)\))247.2 150 Q
(\(client-key \(subbytes key-material 0 32\)\))151.2 162 Q
(\(server-key \(subbytes key-material 32 64\)\)\))151.2 174 Q
(\(set-connection-keys! connection)127.2 198 Q
(\(if \(connection-is-client? connection\))136.8 210 Q
(\(keys send: client-key receive: server-key\))156 222 Q
(\(keys send: server-key receive: client-key\)\)\)\)\))156 234 Q
(\(define \(encrypt-message connection message\))108 258 Q
("Encrypt message with session key")117.6 270 Q
(\(let \(\(nonce \(connection-next-nonce connection\)\)\))117.6 282 Q
(\(chacha20-poly1305-encrypt)127.2 294 Q
(\(connection-send-key connection\))136.8 306 Q(nonce)136.8 318 Q
(\(serialize message\)\)\)\))136.8 330 Q
(\(define \(decrypt-message connection ciphertext\))108 354 Q
("Decrypt message with session key")117.6 366 Q
(\(let \(\(nonce \(connection-next-nonce connection\)\)\))117.6 378 Q
(\(deserialize)127.2 390 Q(\(chacha20-poly1305-decrypt)136.8 402 Q
(\(connection-receive-key connection\))146.4 414 Q(nonce)146.4 426 Q
(ciphertext\)\)\)\))146.4 438 Q F1 2.5(6. Message)72 456 R(Lay)2.5 E(er)
-.1 E 2.5(6.1. Message)72 480 R -.25(Fo)2.5 G(rmat).25 E F2
(\(library-message)108 498 Q(\(version 1\))117.6 510 Q
(\(type request|response|stream|error\))117.6 522 Q(\(id <message-id>\))
117.6 534 Q(\(in-reply-to <message-id>|#f\))117.6 546 Q
(\(capability <spki-cert>|#f\))117.6 558 Q(\(body <payload>\)\))117.6
570 Q 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.2. Request)72 84 R -.34(Ty)2.5 G(pes).34 E/F2 8/Courier@0 SF
(\(define request-types)108 102 Q('\(;; Object operations)117.6 114 Q
(\(get-object hash\))127.2 126 Q(\(put-object hash data\))127.2 138 Q
(\(has-object hash\))127.2 150 Q(;; Bulk operations)127.2 174 Q
(\(get-objects hashes\))127.2 186 Q(\(get-tree root-hash\))127.2 198 Q
(\(sync-objects bloom-filter\))127.2 210 Q(;; Soup queries)127.2 234 Q
(\(soup-query query\))127.2 246 Q(\(soup-subscribe query\))127.2 258 Q
(;; Vault operations)127.2 282 Q(\(get-refs pattern\))127.2 294 Q
(\(get-head\))127.2 306 Q(\(get-releases\))127.2 318 Q(;; Discovery)
127.2 342 Q(\(get-capabilities\))127.2 354 Q(\(get-peers\)\)\))127.2 366
Q F1 2.5(6.3. Request/Response)72 384 R F2
(\(define \(vault-request connection request #!key capability timeout\))
108 402 Q("Send request, wait for response")117.6 414 Q
(\(let \(\(message-id \(generate-message-id\)\)\))117.6 426 Q
(;; Send request)127.2 450 Q(\(send-message connection)127.2 462 Q
(\(library-message)136.8 474 Q(version: 1)146.4 486 Q(type: 'request)
146.4 498 Q(id: message-id)146.4 510 Q(capability: capability)146.4 522
Q(body: request\)\))146.4 534 Q(;; Wait for response)127.2 558 Q(\(let \
\(\(response \(receive-response connection message-id timeout\)\)\))
127.2 570 Q(\(if \(eq? \(message-type response\) 'error\))136.8 582 Q
(\(error \(message-body response\)\))156 594 Q
(\(message-body response\)\)\)\)\))156 606 Q F1 2.5(6.4. Str)72 624 R
(eaming)-.18 E 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R -.15(Fo)72 84 S 2.5(rl)
.15 G(ar)-2.5 E(ge transfers:)-.18 E/F1 8/Courier@0 SF
(\(define \(stream-object connection hash\))108 102 Q
("Stream large object in chunks")117.6 114 Q
(\(let \(\(stream \(open-stream connection 'object-transfer\)\)\))117.6
126 Q(;; Send chunks)127.2 150 Q(\(let \(\(data \(cas-get hash\)\)\))
127.2 162 Q(\(let loop \(\(offset 0\)\))136.8 174 Q
(\(when \(< offset \(blob-length data\)\))146.4 186 Q
(\(let \(\(chunk \(blob-copy data offset chunk-size\)\)\))156 198 Q
(\(stream-send stream chunk\))165.6 210 Q
(\(loop \(+ offset chunk-size\)\)\)\)\))165.6 222 Q(;; End stream)136.8
246 Q(\(stream-close stream\)\)\)\))136.8 258 Q
(\(define \(receive-stream connection stream callback\))108 282 Q
("Receive streamed data")117.6 294 Q(\(let loop \(\(chunks '\(\)\)\))
117.6 306 Q(\(let \(\(chunk \(stream-receive stream\)\)\))127.2 318 Q
(\(if \(stream-ended? stream\))136.8 330 Q
(\(apply bytes-append \(reverse chunks\)\))156 342 Q(\(begin)156 354 Q
(\(callback chunk\))165.6 366 Q
(\(loop \(cons chunk chunks\)\)\)\)\)\)\))165.6 378 Q/F2 10/Times-Bold@0
SF 2.5(7. Object)72 396 R(Exchange)2.5 E 2.5(7.1. Get)72 420 R(Object)
2.5 E F1(;; Request)108 438 Q(\(get-object)108 450 Q
(\(hash "sha256:abc123..."\)\))117.6 462 Q(;; Response \(small object\))
108 486 Q(\(object-data)108 498 Q(\(hash "sha256:abc123..."\))117.6 510
Q(\(size 1024\))117.6 522 Q(\(data #${...}\)\))117.6 534 Q
(;; Response \(large object - streaming\))108 558 Q(\(object-stream)108
570 Q(\(hash "sha256:abc123..."\))117.6 582 Q(\(size 10485760\))117.6
594 Q(\(stream-id 42\)\))117.6 606 Q 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(7.2. Put)72 84 R(Object)2.5 E/F2 8/Courier@0 SF(;; Request)108 102 Q
(\(put-object)108 114 Q(\(hash "sha256:abc123..."\))117.6 126 Q
(\(data #${...}\)\))117.6 138 Q(;; Response)108 162 Q(\(put-result)108
174 Q(\(hash "sha256:abc123..."\))117.6 186 Q
(\(status stored|duplicate|rejected\))117.6 198 Q
(\(reason #f|"quota exceeded"\)\))117.6 210 Q F1 2.5(7.3. Batch)72 228 R
(Operations)2.5 E F2(;; Request multiple objects)108 246 Q
(\(get-objects)108 258 Q
(\(hashes \("sha256:aaa..." "sha256:bbb..." "sha256:ccc..."\)\)\))117.6
270 Q(;; Response)108 294 Q(\(objects-batch)108 306 Q(\(objects)117.6
318 Q(\(\(hash "sha256:aaa..." data #${...}\))127.2 330 Q
(\(hash "sha256:bbb..." data #${...}\))132 342 Q
(\(hash "sha256:ccc..." status: missing\)\)\)\))132 354 Q F1 2.5(7.4. T)
72 372 R -.18(re)-.74 G 2.5(eT).18 G(ransfer)-3.24 E F0(Ef)72 387.6 Q
(\214cient Merkle tree sync:)-.25 E F2(;; Request tree)108 405.6 Q
(\(get-tree)108 417.6 Q(\(root "sha256:root..."\))117.6 429.6 Q
(\(depth 3\))117.6 441.6 Q 4.8(;H)9.6 G(ow deep to fetch)-4.8 E
(\(exclude \("sha256:already-have..."\)\)\))117.6 453.6 Q(;; Response)
108 477.6 Q(\(tree-data)108 489.6 Q(\(root "sha256:root..."\))117.6
501.6 Q(\(objects)117.6 513.6 Q
(\(\(hash "sha256:root..." data #${...}\))127.2 525.6 Q
(\(hash "sha256:child1..." data #${...}\))132 537.6 Q
(\(hash "sha256:child2..." data #${...}\)\)\)\))132 549.6 Q F1 2.5
(8. Synchr)72 567.6 R(onization)-.18 E 2.5(8.1. Bloom)72 591.6 R
(Filter Exchange)2.5 E 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R(Ef)72 84 Q
(\214cient "what do you ha)-.25 E -.15(ve)-.2 G(?" queries:).15 E/F1 8
/Courier@0 SF(;; Step 1: Exchange bloom filters)108 102 Q
(\(define \(sync-init local-vault remote-connection\))108 114 Q
(\(let \(\(local-bloom \(vault-bloom-filter local-vault\)\)\))117.6 126
Q(;; Send our bloom filter)127.2 150 Q(\(send-message remote-connection)
127.2 162 Q(`\(sync-bloom)136.8 174 Q(\(filter ,local-bloom\))146.4 186
Q(\(population ,\(bloom-population local-bloom\)\)\)\))146.4 198 Q
(;; Receive their bloom filter)127.2 222 Q
(\(let \(\(remote-bloom \(receive-bloom remote-connection\)\)\))127.2
234 Q(;; Compute what they might want)136.8 258 Q
(\(let \(\(to-send \(filter \(lambda \(hash\))136.8 270 Q
(\(not \(bloom-contains? remote-bloom hash\)\)\))256.8 282 Q
(\(vault-all-hashes local-vault\)\)\)\))247.2 294 Q(to-send\)\)\)\))
146.4 306 Q(;; Step 2: Exchange missing objects)108 330 Q
(\(define \(sync-exchange to-send to-receive connection\))108 342 Q
(\(parallel)117.6 354 Q(;; Send what they need)127.2 366 Q
(\(for-each \(lambda \(hash\))127.2 378 Q
(\(stream-object connection hash\)\))184.8 390 Q(to-send\))175.2 402 Q
(;; Receive what we need)127.2 414 Q(\(for-each \(lambda \(hash\))127.2
426 Q(\(receive-object connection hash\)\))184.8 438 Q(to-receive\)\)\))
175.2 450 Q/F2 10/Times-Bold@0 SF 2.5(8.2. Incr)72 468 R(emental Sync)
-.18 E F1
(\(define \(incremental-sync local-vault remote-connection since\))108
486 Q("Sync changes since timestamp or commit")117.6 498 Q
(;; Get remote changes)117.6 522 Q
(\(let \(\(remote-changes \(vault-request remote-connection)117.6 534 Q
(`\(changes-since ,since\)\)\)\))232.8 546 Q(;; Get local changes)127.2
570 Q
(\(let \(\(local-changes \(vault-changes-since local-vault since\)\)\))
127.2 582 Q(;; Bidirectional merge)136.8 606 Q
(\(sync-merge local-vault remote-connection)136.8 618 Q
(local-changes remote-changes\)\)\)\))194.4 630 Q 0 Cg EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(8.3. Con\215ict)72 84 R(Resolution)2.5 E/F2 8/Courier@0 SF(\(define\
 \(sync-merge local-vault remote changes-local changes-remote\))108 102
Q("Merge changes with conflict resolution")117.6 114 Q(\(for-each)117.6
138 Q(\(lambda \(hash\))127.2 150 Q(\(cond)136.8 162 Q
(;; Only local has it - push)146.4 174 Q
(\(\(and \(member hash changes-local\))146.4 186 Q
(\(not \(member hash changes-remote\)\)\))175.2 198 Q
(\(push-object local-vault remote hash\)\))151.2 210 Q
(;; Only remote has it - pull)146.4 234 Q
(\(\(and \(member hash changes-remote\))146.4 246 Q
(\(not \(member hash changes-local\)\)\))175.2 258 Q
(\(pull-object local-vault remote hash\)\))151.2 270 Q
(;; Both have it - verify same)146.4 294 Q
(\(\(and \(member hash changes-local\))146.4 306 Q
(\(member hash changes-remote\)\))175.2 318 Q
(;; Content-addressed, so same hash = same content)151.2 330 Q(#t\)\)\))
151.2 342 Q(\(union changes-local changes-remote\)\)\))127.2 354 Q F1
2.5(9. Disco)72 372 R -.1(ve)-.1 G(ry).1 E 2.5(9.1. P)72 396 R
(eer Disco)-.2 E -.1(ve)-.1 G(ry).1 E F2
(;; Well-known peers \(bootstrap\))108 414 Q
(\(define \(discover-bootstrap\))108 426 Q(\(map parse-address)117.6 438
Q(\(read-file "/etc/library/bootstrap-peers"\)\)\))141.6 450 Q
(;; mDNS/DNS-SD for local network)108 474 Q(\(define \(discover-local\))
108 486 Q(\(mdns-browse "library.tcp.local"\)\))117.6 498 Q
(;; DHT for global discovery)108 522 Q
(\(define \(discover-dht target-hash\))108 534 Q
(\(dht-find-providers target-hash\)\))117.6 546 Q(;; Peer exchange)108
570 Q(\(define \(discover-pex connection\))108 582 Q
(\(vault-request connection '\(get-peers\)\)\))117.6 594 Q 0 Cg EP
%%Page: 11 11
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(9.2. Capability)72 84 R(Adv)2.5 E(ertisement)-.1 E/F2 8/Courier@0 SF
(;; Query vault capabilities)108 102 Q(\(get-capabilities\))108 114 Q
(;; Response)108 138 Q(\(vault-capabilities)108 150 Q
(\(protocol-version 1\))117.6 162 Q
(\(features \(bloom-sync tree-transfer streaming soup-query\)\))117.6
174 Q(\(max-object-size 104857600\))117.6 186 Q 4.8(;1)9.6 G(00MB)-4.8 E
(\(storage-available 10737418240\))117.6 198 Q 4.8(;1)9.6 G(0GB)-4.8 E
(\(public-key "ed25519:abc..."\))117.6 210 Q(\(services)117.6 222 Q
(\(\(soup-query rate-limit: 100/minute\))127.2 234 Q
(\(object-transfer rate-limit: 10MB/second\)\)\)\))132 246 Q F1 2.5
(10. Soup)72 264 R(Queries)2.5 E 2.5(10.1. Remote)72 288 R(Query)2.5 E
F2(;; Query remote soup)108 306 Q(\(soup-query)108 318 Q
(\(type certificate\))117.6 330 Q(\(issuer "vault-admin"\))117.6 342 Q
(\(limit 100\)\))117.6 354 Q(;; Response)108 378 Q(\(soup-results)108
390 Q(\(count 47\))117.6 402 Q(\(objects)117.6 414 Q
(\(\(name "cert/alice" type certificate ...\))127.2 426 Q
(\(name "cert/bob" type certificate ...\))132 438 Q(...\)\)\))132 450 Q
F1 2.5(10.2. Subscription)72 468 R F2(;; Subscribe to soup changes)108
486 Q(\(soup-subscribe)108 498 Q(\(query \(type release\)\))117.6 510 Q
(\(callback-url "library://my-vault/callbacks/releases"\)\))117.6 522 Q
(;; Subscription confirmation)108 546 Q(\(subscription)108 558 Q
(\(id "sub-123"\))117.6 570 Q(\(query \(type release\)\))117.6 582 Q
(\(expires "2026-02-07T00:00:00Z"\)\))117.6 594 Q
(;; Push notification \(when matching object appears\))108 618 Q
(\(soup-notification)108 630 Q(\(subscription-id "sub-123"\))117.6 642 Q
(\(object \(name "release/1.2.0" type release ...\)\)\))117.6 654 Q F1
2.5(11. Err)72 672 R(or Handling)-.18 E 0 Cg EP
%%Page: 12 12
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(11.1. Err)72 84 R(or T)-.18 E(ypes)-.34 E/F2 8/Courier@0 SF
(\(define error-types)108 102 Q('\(\(not-found "Object not found"\))
117.6 114 Q(\(unauthorized "Capability required"\))127.2 126 Q
(\(forbidden "Capability insufficient"\))127.2 138 Q
(\(quota-exceeded "Storage quota exceeded"\))127.2 150 Q
(\(rate-limited "Too many requests"\))127.2 162 Q
(\(timeout "Operation timed out"\))127.2 174 Q
(\(invalid-request "Malformed request"\))127.2 186 Q
(\(internal-error "Server error"\))127.2 198 Q
(\(unavailable "Service temporarily unavailable"\)\)\))127.2 210 Q F1
2.5(11.2. Err)72 228 R(or Response)-.18 E F2(\(library-message)108 246 Q
(\(type error\))117.6 258 Q(\(id <message-id>\))117.6 270 Q
(\(in-reply-to <request-id>\))117.6 282 Q(\(body)117.6 294 Q
(\(error-response)127.2 306 Q(\(code not-found\))136.8 318 Q
(\(message "Object sha256:abc... not found"\))136.8 330 Q
(\(retry-after #f\)\)\)\))136.8 342 Q F1 2.5(11.3. Retry)72 360 R(Logic)
2.5 E F2(\(define \(vault-request-with-retry connection request #!key m\
ax-retries\))108 378 Q("Request with exponential backoff retry")117.6
390 Q(\(let loop \(\(attempt 0\) \(delay 1000\)\))117.6 402 Q
(\(let \(\(result \(vault-request connection request\)\)\))127.2 414 Q
(\(if \(and \(error-response? result\))136.8 426 Q
(\(retryable-error? result\))180 438 Q(\(< attempt max-retries\)\))180
450 Q(\(begin)156 462 Q(\(sleep delay\))165.6 474 Q
(\(loop \(+ attempt 1\) \(* delay 2\)\)\))165.6 486 Q(result\)\)\)\))156
498 Q F1 2.5(12. Security)72 516 R(Considerations)2.5 E 0 Cg EP
%%Page: 13 13
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(12.1. Capability)72 84 R -1(Ve)2.5 G(ri\214cation)1 E/F2 8/Courier@0
SF(\(define \(verify-request-capability request connection\))108 102 Q
("Verify request has sufficient capability")117.6 114 Q
(\(let \(\(required-cap \(request->capability request\)\))117.6 126 Q
(\(presented-cap \(message-capability request\)\)\))146.4 138 Q
(\(unless presented-cap)127.2 162 Q
(\(error 'unauthorized "Capability required"\)\))136.8 174 Q
(\(unless \(valid-certificate? presented-cap\))127.2 198 Q
(\(error 'unauthorized "Invalid capability certificate"\)\))136.8 210 Q
(\(unless \(capability-grants? presented-cap required-cap\))127.2 234 Q
(\(error 'forbidden "Insufficient capability"\)\))136.8 246 Q
(;; Verify capability chain back to trusted root)127.2 270 Q
(\(unless \(verify-capability-chain presented-cap\))127.2 282 Q
(\(error 'forbidden "Capability chain invalid"\)\)\)\))136.8 294 Q F1
2.5(12.2. Denial)72 312 R(of Ser)2.5 E(vice Pr)-.1 E(otection)-.18 E F2
(\(define \(rate-limit connection request-type\))108 330 Q
("Apply rate limiting")117.6 342 Q
(\(let \(\(limit \(get-rate-limit request-type\)\))117.6 354 Q
(\(current \(connection-request-count connection request-type\)\)\))
146.4 366 Q(\(when \(> current limit\))127.2 378 Q
(\(error 'rate-limited)136.8 390 Q
(\(format "Rate limit exceeded: ~a/~a" current limit\)\)\)\)\))170.4 402
Q(\(define \(size-limit request\))108 426 Q("Enforce size limits")117.6
438 Q(\(when \(> \(request-size request\) max-request-size\))117.6 450 Q
(\(error 'invalid-request "Request too large"\)\)\))127.2 462 Q F1 2.5
(12.3. Replay)72 480 R(Pr)2.5 E -2.3 -.15(ev e)-.18 H(ntion).15 E F2
(\(define \(verify-nonce connection message\))108 498 Q
("Prevent replay attacks")117.6 510 Q
(\(let \(\(nonce \(message-nonce message\)\)\))117.6 522 Q
(\(when \(nonce-seen? connection nonce\))127.2 534 Q
(\(error 'invalid-request "Replay detected"\)\))136.8 546 Q
(\(record-nonce connection nonce\)\)\))127.2 558 Q F1 2.5
(13. Implementation)72 576 R(Notes)2.5 E 2.5(13.1. W)72 600 R(ir)-.18 E
2.5(eF)-.18 G(ormat)-2.75 E F0(Messages serialized as canonical S-e)72
615.6 Q(xpressions:)-.15 E F2(\(define \(serialize-message message\))108
633.6 Q("Canonical S-expression serialization")117.6 645.6 Q
(\(canonical-sexp->bytes message\)\))117.6 657.6 Q
(\(define \(deserialize-message bytes\))108 681.6 Q
("Parse S-expression")117.6 693.6 Q(\(bytes->canonical-sexp bytes\)\))
117.6 705.6 Q 0 Cg EP
%%Page: 14 14
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-024 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(13.2. Compr)72 84 R(ession)-.18 E F0(Optional compression for lar)72
99.6 Q(ge payloads:)-.18 E/F2 8/Courier@0 SF
(\(define \(maybe-compress data\))108 117.6 Q
(\(if \(> \(blob-length data\) compression-threshold\))117.6 129.6 Q
(\(values \(zstd-compress data\) 'zstd\))136.8 141.6 Q
(\(values data 'none\)\)\))136.8 153.6 Q F1 2.5(13.3. Connection)72
171.6 R -.2(Po)2.5 G(oling).2 E F2
(\(define connection-pool \(make-hash-table\)\))108 189.6 Q
(\(define \(get-connection address\))108 213.6 Q
("Get pooled connection or create new")117.6 225.6 Q
(\(or \(hash-table-ref connection-pool address #f\))117.6 237.6 Q
(\(let \(\(conn \(connect-vault address\)\)\))136.8 249.6 Q
(\(hash-table-set! connection-pool address conn\))146.4 261.6 Q
(conn\)\)\))146.4 273.6 Q F1 2.5(14. Refer)72 291.6 R(ences)-.18 E F0
.066(1. [Q)72 307.2 R .066
(UIC Protocol - RFC 9000]\(https://tools.ietf.or)-.1 F .065
(g/html/rfc9000\) 2. [Noise Protocol Frame)-.18 F -.1(wo)-.25 G
(rk]\(http://noiseproto-).1 E(col.or)72 319.2 Q .663(g/\) 3. [RFC-020: \
Content-Addressed Storage]\(rfc-020-content-addressed-storage.html\) 4.\
 [RFC-021: Capabil-)-.18 F 9.208(ity Dele)72 331.2 R -.05(ga)-.15 G
(tion]\(rfc-021-capability-dele).05 E -.05(ga)-.15 G 9.208
(tion.html\) 5. [IPFS Bitsw).05 F 9.208
(ap Protocol]\(https://docs.ipfs.tech/con-)-.1 F(cepts/bitsw)72 343.2 Q
(ap/\) 6. [libp2p Speci\214cations]\(https://github.com/libp2p/specs\))
-.1 E F1 2.5(15. Changelog)72 367.2 R F0 6.5<8332>72 382.8 S(026-01-07)
-6.5 E 6.5<8349>72 398.4 S(nitial draft)-6.5 E 0 Cg EP
%%Trailer
end
%%EOF
