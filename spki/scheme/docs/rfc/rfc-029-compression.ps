%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Sun Jan 11 13:27:09 2026
%%DocumentNeededResources: font Times-Bold
%%+ font Times-Italic
%%+ font Times-Roman
%%+ font Courier
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 10
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Italic
%%IncludeResource: font Times-Roman
%%IncludeResource: font Courier
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Courier@0 ENC0/Courier RE/Times-Roman@0 ENC0/Times-Roman RE
/Times-Italic@0 ENC0/Times-Italic RE/Times-Bold@0 ENC0/Times-Bold RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF(RFC-029: Compr)196.938 123 Q
(ession and Deduplication)-.216 E/F1 10/Times-Italic@0 SF(Libr)260.85
159 Q(ary of Cyber)-.15 E(space)-.1 E/F2 10/Times-Roman@0 SF(2026)296
177 Q F1(ABSTRA)282.535 213 Q(CT)-.3 E/F3 10/Times-Bold@0 SF 2.5
(1. Abstract)72 261 R F2 .035(This RFC speci\214es compression and dedu\
plication for the Library of Cyberspace: ho)72 276.6 R 2.535(wv)-.25 G
.035(aults reduce storage require-)-2.785 F .936
(ments while maintaining content-addressability)72 288.6 R 3.436(,i)-.65
G(nte)-3.436 E .936(grity v)-.15 F .936(eri\214cation, and ef)-.15 F
.937(\214cient retrie)-.25 F -.25(va)-.25 G .937
(l. Compression is trans-).25 F(parent to the content-addressing layer.)
72 300.6 Q F3 2.5(2. Moti)72 324.6 R -.1(va)-.1 G(tion).1 E F2
(Storage ef)72 340.2 Q(\214cienc)-.25 E 2.5(ym)-.15 G
(atters for preserv)-2.5 E(ation:)-.25 E 6.5<8343>72 355.8 S(ost)-6.5 E
6.5<834c>72 371.4 S(ess storage means more preserv)-6.5 E
(ation per dollar)-.25 E 6.5<8342>72 387 S(andwidth)-6.5 E 6.5<8343>72
402.6 S(ompressed transfers are f)-6.5 E(aster)-.1 E 6.5<8352>72 418.2 S
(edundanc)-6.5 E(y)-.15 E 6.5<834d>72 433.8 S
(ore copies \214t in same space)-6.5 E 6.5<834c>72 449.4 S(onge)-6.5 E
(vity)-.25 E 6.5<8353>72 465 S(maller archi)-6.5 E -.15(ve)-.25 G 2.5
(ss).15 G(urvi)-2.5 E .3 -.15(ve l)-.25 H(onger).15 E
(But compression must not compromise:)72 484.2 Q 6.5<8349>72 499.8 S
(nte)-6.5 E(grity)-.15 E 6.5<8348>72 515.4 S(ashes must remain v)-6.5 E
(alid)-.25 E 6.5<8341>72 531 S(ddressability)-6.5 E 6.5<8343>72 546.6 S
(ontent addressing still w)-6.5 E(orks)-.1 E 6.5<8344>72 562.2 S
(eduplication)-6.5 E 6.5<8349>72 577.8 S(dentical content stored once)
-6.5 E 6.5<8341>72 593.4 S(ccessibility)-6.5 E 6.5<8344>72 609 S
(ata remains retrie)-6.5 E -.25(va)-.25 G(ble).25 E F3 2.5(3. Compr)72
636.6 R(ession Model)-.18 E 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(3.1. Lay)72 84 R(er)-.1 E(ed Ar)-.18 E(chitectur)-.18 E(e)-.18 E/F2
8/Courier@0 SF<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2>108 102 Q 43.2<e241>108 114 S(pplication Layer)
-43.2 E<e2>52.8 E 24<e228>108 126 S(sees uncompressed data\))-24 E<e2>
38.4 E<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2a4>108 138 Q 38.4<e243>108 150 S 48
(ontent-Addressing \342)-38.4 F 19.2<e228>108 162 S
(hash of uncompressed data\))-19.2 E<e2>28.8 E<e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a4>108 174 Q 38.4
<e243>108 186 S(ompression Layer)-38.4 E<e2>57.6 E 28.8<e228>108 198 S
(transparent compression\))-28.8 E<e2>28.8 E<e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a4>108 210 Q 43.2
<e253>108 222 S(torage Layer)-43.2 E<e2>72 E 24<e228>108 234 S
(stores compressed data\))-24 E<e2>38.4 E<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2>108 246 Q F1 2.5
(3.2. Compr)72 264 R(ession Metadata)-.18 E F2
(\(define \(compress-object data algorithm\))108 282 Q
(\(let* \(\(compressed \(compress algorithm data\)\))117.6 294 Q
(\(ratio \(/ \(bytevector-length compressed\))151.2 306 Q
(\(bytevector-length data\)\)\)\))199.2 318 Q(`\(compressed-object)127.2
330 Q(\(algorithm ,algorithm\))136.8 342 Q
(\(original-size ,\(bytevector-length data\)\))136.8 354 Q
(\(compressed-size ,\(bytevector-length compressed\)\))136.8 366 Q
(\(ratio ,ratio\))136.8 378 Q(\(data ,compressed\)\)\)\))136.8 390 Q
(;; Stored in soup)108 414 Q(\(soup-object)108 426 Q
(\(hash "sha256:original-content-hash..."\))117.6 438 Q(\(compression)
117.6 450 Q(\(algorithm zstd\))127.2 462 Q(\(level 3\))127.2 474 Q
(\(original-size 1048576\))127.2 486 Q(\(compressed-size 524288\))127.2
498 Q(\(ratio 0.5\)\)\))127.2 510 Q F1 2.5(4. Compr)72 528 R
(ession Algorithms)-.18 E 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(4.1. Supported)72 84 R(Algorithms)2.5 E/F2 8/Courier@0 SF
(\(define compression-algorithms)108 102 Q
(`\(\(zstd . \(\(extension . "zst"\))117.6 114 Q
(\(levels . \(1 3 9 19\)\))170.4 126 Q(\(default-level . 3\))170.4 138 Q
(\(dictionary . #t\)\)\))170.4 150 Q(\(lz4 . \(\(extension . "lz4"\))
127.2 162 Q(\(levels . \(1 9\)\))165.6 174 Q(\(default-level . 1\))165.6
186 Q(\(dictionary . #f\)\)\))165.6 198 Q
(\(gzip . \(\(extension . "gz"\))127.2 210 Q(\(levels . \(1 6 9\)\))
170.4 222 Q(\(default-level . 6\))170.4 234 Q(\(dictionary . #f\)\)\))
170.4 246 Q(\(none . \(\(extension . #f\))127.2 258 Q(\(levels . \(\)\))
170.4 270 Q(\(default-level . #f\))170.4 282 Q
(\(dictionary . #f\)\)\)\)\))170.4 294 Q F1 2.5(4.2. Algorithm)72 312 R
(Selection)2.5 E F2
(\(define \(select-compression-algorithm content-type size\))108 330 Q
("Select best algorithm for content")117.6 342 Q(\(cond)117.6 354 Q
(;; Already compressed formats)127.2 366 Q
(\(\(member content-type '\("image/jpeg" "image/png" "video/mp4")127.2
378 Q("application/zip" "application/gzip"\)\))237.6 390 Q('none\))132
402 Q(;; Small objects - overhead not worth it)127.2 414 Q
(\(\(< size 1024\))127.2 426 Q('none\))132 438 Q
(;; Text and code - zstd with dictionary)127.2 450 Q
(\(\(member content-type '\("text/plain" "text/html" "application/json")
127.2 462 Q("application/javascript" "text/x-scheme"\)\))237.6 474 Q
('zstd\))132 486 Q(;; Binary data - lz4 for speed)127.2 498 Q
(\(\(string-prefix? "application/" content-type\))127.2 510 Q('lz4\))132
522 Q(;; Default)127.2 534 Q(\(else 'zstd\)\)\))127.2 546 Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(4.3. Zstd)72 84 R(Dictionaries)2.5 E/F2 8/Courier@0 SF
(;; Train dictionary on sample data)108 102 Q
(\(define \(train-dictionary samples dict-size\))108 114 Q
("Train zstd dictionary from sample data")117.6 126 Q
(\(zstd-train-dictionary samples dict-size\)\))117.6 138 Q
(;; Content-type specific dictionaries)108 162 Q(\(define dictionaries)
108 174 Q(`\(\(scheme . ,\(load-dictionary "scheme.dict"\)\))117.6 186 Q
(\(json . ,\(load-dictionary "json.dict"\)\))127.2 198 Q
(\(markdown . ,\(load-dictionary "markdown.dict"\)\)\)\))127.2 210 Q
(\(define \(compress-with-dictionary data content-type\))108 234 Q
(\(let \(\(dict \(assoc-ref dictionaries content-type\)\)\))117.6 246 Q
(\(if dict)127.2 258 Q(\(zstd-compress-with-dict data dict\))146.4 270 Q
(\(zstd-compress data\)\)\)\))146.4 282 Q F1 2.5(5. Compr)72 300 R
(ession Operations)-.18 E 2.5(5.1. T)72 324 R(ranspar)-.74 E(ent Compr)
-.18 E(ession)-.18 E F2(\(define \(cas-put-compressed data\))108 342 Q
("Store data with transparent compression")117.6 354 Q
(\(let \(\(hash \(content-hash data\)\))117.6 366 Q 4.8(;H)9.6 G
(ash uncompressed)-4.8 E(\(algorithm \(select-compression-algorithm)
151.2 378 Q(\(detect-content-type data\))208.8 390 Q
(\(bytevector-length data\)\)\))208.8 402 Q
(\(stored \(if \(eq? algorithm 'none\))151.2 414 Q(data)208.8 426 Q
(\(compress algorithm data\)\)\)\))208.8 438 Q
(;; Store compressed, index by uncompressed hash)127.2 450 Q
(\(storage-put hash stored\))127.2 462 Q(;; Record compression metadata)
127.2 474 Q(\(soup-put hash)127.2 486 Q
(compression: `\(\(algorithm . ,algorithm\))136.8 498 Q
(\(original-size . ,\(bytevector-length data\)\))208.8 510 Q
(\(compressed-size . ,\(bytevector-length stored\)\)\)\))208.8 522 Q
(hash\)\))127.2 534 Q(\(define \(cas-get-decompressed hash\))108 558 Q
("Retrieve and decompress data")117.6 570 Q
(\(let \(\(stored \(storage-get hash\)\))117.6 582 Q
(\(meta \(soup-get hash\)\))151.2 594 Q(\(algorithm \(assoc-ref \(assoc\
-ref meta 'compression\) 'algorithm\)\)\))151.2 606 Q
(\(if \(or \(not algorithm\) \(eq? algorithm 'none\)\))127.2 618 Q
(stored)146.4 630 Q(\(decompress algorithm stored\)\)\)\))146.4 642 Q 0
Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.2. Batch)72 84 R(Compr)2.5 E(ession)-.18 E/F2 8/Courier@0 SF
(\(define \(compress-batch objects\))108 102 Q
("Compress multiple objects efficiently")117.6 114 Q
(;; Group by content type for dictionary efficiency)117.6 126 Q
(\(let \(\(groups \(group-by detect-content-type objects\)\)\))117.6 138
Q(\(append-map)127.2 150 Q(\(lambda \(group\))136.8 162 Q
(\(let \(\(content-type \(car group\)\))146.4 174 Q
(\(items \(cdr group\)\)\))175.2 186 Q(\(map \(lambda \(obj\))156 198 Q
(\(compress-with-dictionary obj content-type\)\))189.6 210 Q
(items\)\)\))180 222 Q(groups\)\)\))136.8 234 Q F1 2.5(5.3. Recompr)72
252 R(ession)-.18 E F2
(\(define \(recompress-object hash new-algorithm new-level\))108 270 Q
("Recompress object with different settings")117.6 282 Q
(\(let* \(\(data \(cas-get-decompressed hash\)\))117.6 294 Q
(\(new-compressed \(compress new-algorithm data new-level\)\)\))151.2
306 Q(\(storage-put hash new-compressed\))127.2 318 Q
(\(soup-update hash)127.2 330 Q
(compression: `\(\(algorithm . ,new-algorithm\))136.8 342 Q
(\(level . ,new-level\))208.8 354 Q
(\(original-size . ,\(bytevector-length data\)\))208.8 366 Q
(\(compressed-size . ,\(bytevector-length new-compressed\)\)\)\))208.8
378 Q(\(audit-append action: 'recompressed)127.2 390 Q(hash: hash)194.4
402 Q(algorithm: new-algorithm\)\)\))194.4 414 Q F1 2.5
(6. Deduplication)72 432 R 2.5(6.1. Content-Based)72 456 R
(Deduplication)2.5 E F2
(;; Content addressing provides automatic deduplication)108 474 Q
(\(define \(store-deduplicated data\))108 486 Q
(\(let \(\(hash \(content-hash data\)\)\))117.6 498 Q
(\(if \(cas-exists? hash\))127.2 510 Q(\(begin)146.4 522 Q
(;; Increment reference count)156 534 Q
(\(soup-update hash ref-count: \(+ 1 \(soup-ref-count hash\)\)\))156 546
Q(\(audit-append action: 'deduplicated hash: hash\))156 558 Q(hash\))156
570 Q(\(cas-put data\)\)\)\))146.4 582 Q 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.2. Block-Le)72 84 R -.1(ve)-.15 G 2.5(lD).1 G(eduplication)-2.5 E
/F2 8/Courier@0 SF(;; Split large objects into blocks)108 102 Q
(\(define block-size 65536\))108 114 Q 4.8(;6)9.6 G(4KB)-4.8 E
(\(define \(chunk-object data\))108 138 Q
("Split object into content-defined chunks")117.6 150 Q
(\(let \(\(chunks '\(\)\))117.6 162 Q(\(pos 0\)\))146.4 174 Q
(\(while \(< pos \(bytevector-length data\)\))127.2 186 Q
(\(let \(\(boundary \(find-chunk-boundary data pos\)\)\))136.8 198 Q
(\(set! chunks \(cons \(subbytevector data pos boundary\) chunks\)\))
146.4 210 Q(\(set! pos boundary\)\)\))146.4 222 Q
(\(reverse chunks\)\)\))127.2 234 Q
(;; Content-defined chunking \(Rabin fingerprint\))108 258 Q
(\(define \(find-chunk-boundary data start\))108 270 Q
("Find chunk boundary using rolling hash")117.6 282 Q
(\(let \(\(min-size 4096\))117.6 294 Q(\(max-size 131072\))146.4 306 Q
(\(mask #x1FFF\)\))146.4 318 Q 4.8(;A)9.6 G(verage 8KB chunks)-4.8 E
(\(let loop \(\(pos \(+ start min-size\)\)\))127.2 330 Q(\(cond)136.8
342 Q
(\(\(>= pos \(min \(+ start max-size\) \(bytevector-length data\)\)\))
146.4 354 Q(pos\))151.2 366 Q
(\(\(= \(bitwise-and \(rabin-hash data pos\) mask\) 0\))146.4 378 Q
(pos\))151.2 390 Q(\(else \(loop \(+ pos 1\)\)\)\)\)\)\))146.4 402 Q F1
2.5(6.3. Chunk)72 420 R(Storage)2.5 E F2
(\(define \(store-chunked data\))108 438 Q
("Store large object as deduplicated chunks")117.6 450 Q
(\(let \(\(chunks \(chunk-object data\)\))117.6 462 Q
(\(chunk-hashes \(map \(lambda \(chunk\))151.2 474 Q
(\(store-deduplicated chunk\)\))252 486 Q(chunks\)\)\))242.4 498 Q
(;; Store manifest)127.2 510 Q(\(let \(\(manifest `\(chunked-object)
127.2 522 Q(\(chunks ,chunk-hashes\))213.6 534 Q
(\(total-size ,\(bytevector-length data\)\))213.6 546 Q
(\(chunk-count ,\(length chunks\)\)\)\)\))213.6 558 Q
(\(cas-put \(serialize manifest\)\)\)\)\))136.8 570 Q
(\(define \(retrieve-chunked manifest-hash\))108 594 Q
("Reassemble chunked object")117.6 606 Q
(\(let \(\(manifest \(deserialize \(cas-get manifest-hash\)\)\))117.6
618 Q(\(chunks \(map cas-get \(assoc-ref manifest 'chunks\)\)\)\))151.2
630 Q(\(bytevector-concatenate chunks\)\)\))127.2 642 Q 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.4. Deduplication)72 84 R(Statistics)2.5 E/F2 8/Courier@0 SF
(\(define \(deduplication-stats\))108 102 Q
("Calculate deduplication effectiveness")117.6 114 Q
(\(let* \(\(objects \(soup-query type: 'any\)\))117.6 126 Q
(\(logical-size \(sum \(map soup-original-size objects\)\)\))151.2 138 Q
(\(physical-size \(sum \(map soup-compressed-size)151.2 150 Q
(\(delete-duplicates objects hash=?\)\)\)\)\))271.2 162 Q
(`\(\(logical-size . ,logical-size\))127.2 174 Q
(\(physical-size . ,physical-size\))136.8 186 Q
(\(dedup-ratio . ,\(/ logical-size physical-size\)\))136.8 198 Q
(\(space-saved . ,\(- logical-size physical-size\)\)\)\)\))136.8 210 Q
F1 2.5(7. Delta)72 228 R(Compr)2.5 E(ession)-.18 E 2.5(7.1. V)72 252 R
(ersion Deltas)-1 E F2(\(define \(store-delta base-hash new-data\))108
270 Q("Store object as delta from base")117.6 282 Q
(\(let \(\(base-data \(cas-get base-hash\)\))117.6 294 Q
(\(delta \(compute-delta base-data new-data\)\))151.2 306 Q
(\(new-hash \(content-hash new-data\)\)\))151.2 318 Q
(\(if \(< \(bytevector-length delta\))127.2 330 Q 4.8(\(0)160.8 342 S
(.5 \(bytevector-length new-data\)\)\))-4.8 E(;; Delta is worthwhile)
146.4 354 Q(\(begin)146.4 366 Q(\(storage-put new-hash delta\))156 378 Q
(\(soup-put new-hash)156 390 Q(delta: `\(\(base . ,base-hash\))165.6 402
Q(\(type . xdelta\)\)\))208.8 414 Q(new-hash\))156 426 Q
(;; Store full object)146.4 438 Q(\(cas-put new-data\)\)\)\))146.4 450 Q
(\(define \(retrieve-delta hash\))108 474 Q
("Reconstruct object from delta")117.6 486 Q
(\(let \(\(meta \(soup-get hash\)\)\))117.6 498 Q
(\(if \(assoc-ref meta 'delta\))127.2 510 Q
(\(let* \(\(base-hash \(assoc-ref \(assoc-ref meta 'delta\) 'base\)\))
146.4 522 Q(\(base-data \(cas-get base-hash\)\))180 534 Q
(\(delta \(storage-get hash\)\)\))180 546 Q
(\(apply-delta base-data delta\)\))156 558 Q(\(storage-get hash\)\)\)\))
146.4 570 Q 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(7.2. Delta)72 84 R(Chains)2.5 E/F2 8/Courier@0 SF
(;; Limit delta chain depth)108 102 Q(\(define max-delta-depth 10)108
114 Q(\(define \(delta-chain-depth hash\))108 138 Q
("Calculate depth of delta chain")117.6 150 Q
(\(let \(\(meta \(soup-get hash\)\)\))117.6 162 Q
(\(if \(assoc-ref meta 'delta\))127.2 174 Q(\(+ 1 \(delta-chain-depth \
\(assoc-ref \(assoc-ref meta 'delta\) 'base\)\)\))146.4 186 Q(0\)\)\))
146.4 198 Q(\(define \(should-store-delta? base-hash\))108 222 Q
("Check if delta storage is appropriate")117.6 234 Q
(\(< \(delta-chain-depth base-hash\) max-delta-depth\)\))117.6 246 Q F1
2.5(8. Ar)72 264 R(chi)-.18 E .2 -.1(ve C)-.1 H(ompr).1 E(ession)-.18 E
2.5(8.1. Sealed)72 288 R(Ar)2.5 E(chi)-.18 E .2 -.1(ve F)-.1 H(ormat)
-.15 E F2(;; RFC-018 integration)108 306 Q
(\(define \(create-compressed-archive objects\))108 318 Q
("Create compressed sealed archive")117.6 330 Q
(\(let* \(\(serialized \(serialize-objects objects\)\))117.6 342 Q
(\(compressed \(zstd-compress serialized 19\)\))151.2 354 Q 4.8(;M)9.6 G
(ax compression)-4.8 E
(\(encrypted \(age-encrypt compressed recipients\)\)\))151.2 366 Q
(\(cas-put encrypted\)\)\))127.2 378 Q F1 2.5(8.2. Str)72 396 R
(eaming Compr)-.18 E(ession)-.18 E F2
(\(define \(stream-compress input-port output-port algorithm\))108 414 Q
("Stream compression for large files")117.6 426 Q
(\(let \(\(ctx \(compression-context-create algorithm\)\)\))117.6 438 Q
(\(let loop \(\))127.2 450 Q
(\(let \(\(chunk \(read-bytevector chunk-size input-port\)\)\))136.8 462
Q(\(unless \(eof-object? chunk\))146.4 474 Q
(\(write-bytevector \(compress-chunk ctx chunk\) output-port\))156 486 Q
(\(loop\)\)\)\))156 498 Q
(\(write-bytevector \(compress-finish ctx\) output-port\)\)\))127.2 510
Q F1 2.5(9. P)72 528 R(erf)-.2 E(ormance Optimization)-.25 E 2.5
(9.1. Compr)72 552 R(ession Cache)-.18 E F2
(\(define compression-cache \(make-lru-cache 1000\)\))108 570 Q
(\(define \(cached-decompress hash\))108 594 Q
("Cache decompressed data for frequent access")117.6 606 Q
(\(or \(lru-get compression-cache hash\))117.6 618 Q
(\(let \(\(data \(cas-get-decompressed hash\)\)\))136.8 630 Q
(\(lru-put! compression-cache hash data\))146.4 642 Q(data\)\)\))146.4
654 Q 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(9.2. P)72 84 R(arallel Compr)-.1 E(ession)-.18 E/F2 8/Courier@0 SF
(\(define \(parallel-compress objects num-threads\))108 102 Q
("Compress multiple objects in parallel")117.6 114 Q
(\(let \(\(work-queue \(make-channel\)\))117.6 126 Q
(\(results \(make-channel\)\)\))146.4 138 Q(;; Start workers)127.2 150 Q
(\(do \(\(i 0 \(+ i 1\)\)\))127.2 162 Q(\(\(= i num-threads\)\))146.4
174 Q(\(thread-start!)136.8 186 Q(\(make-thread)146.4 198 Q
(\(lambda \(\))156 210 Q(\(let loop \(\))165.6 222 Q
(\(let \(\(obj \(channel-get! work-queue\)\)\))175.2 234 Q(\(when obj)
184.8 246 Q(\(channel-put! results \(compress-object obj\)\))194.4 258 Q
(\(loop\)\)\)\)\)\)\)\))194.4 270 Q(;; Queue work)127.2 282 Q(\(for-eac\
h \(lambda \(obj\) \(channel-put! work-queue obj\)\) objects\))127.2 294
Q(;; Collect results)127.2 306 Q
(\(map \(lambda \(_\) \(channel-get! results\)\) objects\)\)\))127.2 318
Q F1 2.5(9.3. Adapti)72 336 R .2 -.1(ve C)-.1 H(ompr).1 E(ession)-.18 E
F2(\(define \(adaptive-compress data\))108 354 Q
("Select compression based on content analysis")117.6 366 Q(\(let* \(\(\
sample \(subbytevector data 0 \(min 4096 \(bytevector-length data\)\)\)\
\))117.6 378 Q(\(entropy \(calculate-entropy sample\)\)\))151.2 390 Q
(\(cond)127.2 402 Q(;; High entropy - already compressed or encrypted)
136.8 414 Q(\(\(> entropy 7.9\) 'none\))136.8 426 Q
(;; Low entropy - highly compressible)136.8 438 Q
(\(\(< entropy 4.0\) \(values 'zstd 19\)\))136.8 450 Q
(;; Medium entropy - balanced)136.8 462 Q
(\(else \(values 'zstd 3\)\)\)\)\))136.8 474 Q F1 2.5(10. Integrity)72
492 R 2.5(10.1. V)72 516 R(eri\214cation)-1 E F2
(\(define \(verify-compressed-object hash\))108 534 Q
("Verify compressed object integrity")117.6 546 Q
(\(let* \(\(stored \(storage-get hash\)\))117.6 558 Q
(\(meta \(soup-get hash\)\))151.2 570 Q
(\(decompressed \(decompress \(assoc-ref meta 'algorithm\) stored\)\))
151.2 582 Q(\(computed-hash \(content-hash decompressed\)\)\))151.2 594
Q(\(equal? hash computed-hash\)\)\))127.2 606 Q 0 Cg EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-029 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(10.2. Corruption)72 84 R(Reco)2.5 E -.1(ve)-.1 G(ry).1 E/F2 8
/Courier@0 SF(\(define \(recover-compressed hash\))108 102 Q
("Attempt to recover corrupted compressed object")117.6 114 Q
(;; Try partial decompression)117.6 126 Q
(\(let \(\(partial \(decompress-partial hash\)\)\))117.6 138 Q
(\(when partial)127.2 150 Q
(\(audit-append action: 'partial-recovery hash: hash\))136.8 162 Q
(partial\)\))136.8 174 Q(;; Fetch from replica)117.6 198 Q
(\(let \(\(replica-data \(fetch-from-replica hash\)\)\))117.6 210 Q
(\(when replica-data)127.2 222 Q(\(storage-put hash replica-data\))136.8
234 Q(replica-data\)\)\))136.8 246 Q F1 2.5(11. Refer)72 264 R(ences)
-.18 E F0 1.28(1. [Zstandard]\(https://github.com/f)72 279.6 R 1.28
(acebook/zstd\) - F)-.1 F(acebook')-.15 E 3.78(sc)-.55 G 1.28
(ompression algorithm 2. [Content-De\214ned Chunk-)-3.78 F 2.835(ing]\(\
https://restic.net/blog/2015-09-12/restic-foundation1-cdc/\) - Restic b\
log 3. [RFC-018: Sealed Archi)72 291.6 R 3.135 -.15(ve Fo)-.25 H -.2(r-)
.15 G(mat]\(rfc-018-sealed-archi)72 303.6 Q -.15(ve)-.25 G 7.595(.html\
\) 4. [RFC-020: Content-Addressed Storage]\(rfc-020-content-addressed-s\
tor).15 F(-)-.2 E(age.html\))72 315.6 Q F1 2.5(12. Changelog)72 339.6 R
F0 6.5<8332>72 355.2 S(026-01-07)-6.5 E 6.5<8349>72 370.8 S
(nitial draft)-6.5 E 0 Cg EP
%%Trailer
end
%%EOF
