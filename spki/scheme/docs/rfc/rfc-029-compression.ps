%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Fri Jan  9 11:29:12 2026
%%DocumentNeededResources: font Times-Roman
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 7
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(RFC-029: Compression and Deduplication)72 12 Q
1.95(**Status:** Draft **Date:** January 2026 **Author:** Derrell Piper\
 <ddp@eludom.net> **Implementation:**)72 36 R(Proposed)72 48 Q(---)72 72
Q(Abstract)72 96 Q .035(This RFC speci\214es compression and deduplicat\
ion for the Library of Cyberspace: ho)72 120 R 2.536(wv)-.25 G .036
(aults reduce storage require-)-2.786 F .937
(ments while maintaining content-addressability)72 132 R 3.437(,i)-.65 G
(nte)-3.437 E .936(grity v)-.15 F .936(eri\214cation, and ef)-.15 F .936
(\214cient retrie)-.25 F -.25(va)-.25 G .936(l. Compression is trans-)
.25 F(parent to the content-addressing layer)72 144 Q(.)-.55 E(---)72
168 Q(Moti)72 192 Q -.25(va)-.25 G(tion).25 E(Storage ef)72 216 Q
(\214cienc)-.25 E 2.5(ym)-.15 G(atters for preserv)-2.5 E(ation:)-.25 E
3.078(-*)72 240 S .579(*Cost** - Less storage means more preserv)-3.078
F .579(ation per dollar - **Bandwidth** - Compressed transfers are f)
-.25 F .579(aster -)-.1 F(**Redundanc)72 252 Q
(y** - More copies \214t in same space - **Longe)-.15 E
(vity** - Smaller archi)-.25 E -.15(ve)-.25 G 2.5(ss).15 G(urvi)-2.5 E
.3 -.15(ve l)-.25 H(onger).15 E(But compression must not compromise:)72
276 Q 3.644(-*)72 300 S(*Inte)-3.644 E 1.144
(grity** - Hashes must remain v)-.15 F 1.144
(alid - **Addressability** - Content addressing still w)-.25 F 1.144
(orks - **Deduplica-)-.1 F(tion** - Identical content stored once - **A\
ccessibility** - Data remains retrie)72 312 Q -.25(va)-.25 G(ble).25 E
(---)72 336 Q(Compression Model)72 360 Q(Layered Architecture)72 384 Q
1.814 -.74(``` \342)72 408 T .334<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e220e2>.74 F .334(Application Layer)
22.834 F 4.666 2.834<e2e22028>27.834 H .334(sees uncompressed data\))
-2.834 F<e2>20.334 E 2.348<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a420e2>72 420 R 27.348
(Content-Addressing \342)22.348 F 12.347<e228>4.848 G 2.347
(hash of uncompressed data\))-12.347 F 4.605<e2e2>72 432 S 2.105<e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a4
20e2>-4.605 F 2.105(Compression Layer)22.105 F 5.395 4.605<e2e22028>
32.105 H 2.105(transparent compression\))-4.605 F 3.741<e2e2>72 444 S
1.241<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2a420e2>-3.741 F 1.241(Storage Layer)23.741 F 3.759 3.741
<e2e22028>38.741 H 1.241(stores compressed data\))-3.741 F<e2>21.241 E<
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e22060>72 456 Q -.74(``)-.74 G(Compression Metadata)72 480 Q -.74
(```)72 504 S(scheme \(de\214ne \(compress-object data algorithm\)).74 E
(\(let* \(\(compressed \(compress algorithm data\)\))77 516 Q
(\(ratio \(/ \(byte)94.5 528 Q -.15(ve)-.25 G(ctor).15 E
(-length compressed\))-.2 E(\(byte)119.5 540 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\)\)\))-.2 E(`\(compressed-object)82 552 Q
(\(algorithm ,algorithm\))87 564 Q(\(original-size ,\(byte)87 576 Q -.15
(ve)-.25 G(ctor).15 E(-length data\)\))-.2 E(\(compressed-size ,\(byte)
87 588 Q -.15(ve)-.25 G(ctor).15 E(-length compressed\)\))-.2 E
(\(ratio ,ratio\))87 600 Q(\(data ,compressed\)\)\)\))87 612 Q
(;; Stored in soup \(soup-object)72 636 Q
(\(hash "sha256:original-content-hash..."\))77 648 Q(\(compression)77
660 Q(\(algorithm zstd\))82 672 Q(\(le)82 684 Q -.15(ve)-.25 G 2.5(l3)
.15 G(\))-2.5 E(\(original-size 1048576\))82 696 Q
(\(compressed-size 524288\))82 708 Q(\(ratio 0.5\)\)\) `)82 720 Q -.74
(``)-.74 G(---)72 744 Q(Compression Algorithms)72 768 Q
(Supported Algorithms)72 792 Q 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF -.74(```)72 24 S
(scheme \(de\214ne compression-algorithms).74 E(`\(\(zstd . \(\(e)77 36
Q(xtension . "zst"\))-.15 E(\(le)104.5 48 Q -.15(ve)-.25 G
(ls . \(1 3 9 19\)\)).15 E(\(def)104.5 60 Q(ault-le)-.1 E -.15(ve)-.25 G
2.5(l.3).15 G(\))-2.5 E(\(dictionary . #t\)\)\))104.5 72 Q
(\(lz4 . \(\(e)82 84 Q(xtension . "lz4"\))-.15 E(\(le)102 96 Q -.15(ve)
-.25 G(ls . \(1 9\)\)).15 E(\(def)102 108 Q(ault-le)-.1 E -.15(ve)-.25 G
2.5(l.1).15 G(\))-2.5 E(\(dictionary . #f\)\)\))102 120 Q
(\(gzip . \(\(e)82 132 Q(xtension . "gz"\))-.15 E(\(le)104.5 144 Q -.15
(ve)-.25 G(ls . \(1 6 9\)\)).15 E(\(def)104.5 156 Q(ault-le)-.1 E -.15
(ve)-.25 G 2.5(l.6).15 G(\))-2.5 E(\(dictionary . #f\)\)\))104.5 168 Q
(\(none . \(\(e)82 180 Q(xtension . #f\))-.15 E(\(le)104.5 192 Q -.15
(ve)-.25 G(ls . \(\)\)).15 E(\(def)104.5 204 Q(ault-le)-.1 E -.15(ve)
-.25 G 2.5(l.#).15 G(f\))-2.5 E(\(dictionary . #f\)\)\)\)\) `)104.5 216
Q -.74(``)-.74 G(Algorithm Selection)72 240 Q -.74(```)72 264 S
(scheme \(de\214ne \(select-compression-algorithm content-type size\))
.74 E("Select best algorithm for content")77 276 Q(\(cond)77 288 Q
(;; Already compressed formats)82 300 Q
(\(\(member content-type '\("image/jpe)82 312 Q
(g" "image/png" "video/mp4")-.15 E
("application/zip" "application/gzip"\)\))139.5 324 Q('none\))84.5 336 Q
(;; Small objects - o)82 348 Q -.15(ve)-.15 G(rhead not w).15 E(orth it)
-.1 E(\(\(< size 1024\))82 360 Q('none\))84.5 372 Q(;; T)82 384 Q -.15
(ex)-.7 G 2.5(ta).15 G(nd code - zstd with dictionary)-2.5 E
(\(\(member content-type '\("te)82 396 Q(xt/plain" "te)-.15 E
(xt/html" "application/json")-.15 E("application/ja)139.5 408 Q -.25(va)
-.2 G(script" "te).25 E(xt/x-scheme"\)\))-.15 E('zstd\))84.5 420 Q
(;; Binary data - lz4 for speed)82 432 Q
(\(\(string-pre\214x? "application/" content-type\))82 444 Q -.1('l)84.5
456 S(z4\)).1 E(;; Def)82 468 Q(ault)-.1 E(\(else 'zstd\)\)\) `)82 480 Q
-.74(``)-.74 G(Zstd Dictionaries)72 504 Q -.74(```)72 528 S(scheme ;; T)
.74 E(rain dictionary on sample data \(de\214ne \(train-dictionary samp\
les dict-size\))-.35 E("T)77 540 Q
(rain zstd dictionary from sample data")-.35 E
(\(zstd-train-dictionary samples dict-size\)\))77 552 Q
(;; Content-type speci\214c dictionaries \(de\214ne dictionaries)72 576
Q(`\(\(scheme . ,\(load-dictionary "scheme.dict"\)\))77 588 Q
(\(json . ,\(load-dictionary "json.dict"\)\))82 600 Q(\(markdo)82 612 Q
(wn . ,\(load-dictionary "markdo)-.25 E(wn.dict"\)\)\)\))-.25 E
(\(de\214ne \(compress-with-dictionary data content-type\))72 636 Q
(\(let \(\(dict \(assoc-ref dictionaries content-type\)\)\))77 648 Q
(\(if dict)82 660 Q(\(zstd-compress-with-dict data dict\))92 672 Q
(\(zstd-compress data\)\)\)\) `)92 684 Q -.74(``)-.74 G(---)72 708 Q
(Compression Operations)72 732 Q -.35(Tr)72 756 S(ansparent Compression)
.35 E -.74(```)72 780 S(scheme \(de\214ne \(cas-put-compressed data\))
.74 E("Store data with transparent compression")77 792 Q 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(let* \(\(hash \(content-hash data\)\))77 12 Q
2.5(;H)5 G(ash uncompressed)-2.5 E
(\(algorithm \(select-compression-algorithm)94.5 24 Q
(\(detect-content-type data\))124.5 36 Q(\(byte)124.5 48 Q -.15(ve)-.25
G(ctor).15 E(-length data\)\)\))-.2 E
(\(stored \(if \(eq? algorithm 'none\))94.5 60 Q(data)124.5 72 Q
(\(compress algorithm data\)\)\)\))124.5 84 Q(;; Store compressed, inde)
82 96 Q 2.5(xb)-.15 G 2.5(yu)-2.5 G(ncompressed hash)-2.5 E
(\(storage-put hash stored\))82 108 Q(;; Record compression metadata)82
120 Q(\(soup-put hash)82 132 Q
(compression: `\(\(algorithm . ,algorithm\))87 144 Q
(\(original-size . ,\(byte)124.5 156 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\))-.2 E(\(compressed-size . ,\(byte)124.5 168 Q -.15(ve)
-.25 G(ctor).15 E(-length stored\)\)\)\))-.2 E(hash\)\))82 180 Q
(\(de\214ne \(cas-get-decompressed hash\))72 204 Q("Retrie)77 216 Q .3
-.15(ve a)-.25 H(nd decompress data").15 E
(\(let* \(\(stored \(storage-get hash\)\))77 228 Q
(\(meta \(soup-get hash\)\))94.5 240 Q(\(algorithm \(assoc-ref \(assoc-\
ref meta 'compression\) 'algorithm\)\)\))94.5 252 Q
(\(if \(or \(not algorithm\) \(eq? algorithm 'none\)\))82 264 Q(stored)
92 276 Q(\(decompress algorithm stored\)\)\)\) `)92 288 Q -.74(``)-.74 G
(Batch Compression)72 312 Q -.74(```)72 336 S
(scheme \(de\214ne \(compress-batch objects\)).74 E
("Compress multiple objects ef)77 348 Q(\214ciently")-.25 E
(;; Group by content type for dictionary ef)77 360 Q(\214cienc)-.25 E(y)
-.15 E(\(let \(\(groups \(group-by detect-content-type objects\)\)\))77
372 Q(\(append-map)82 384 Q(\(lambda \(group\))87 396 Q
(\(let \(\(content-type \(car group\)\))92 408 Q
(\(items \(cdr group\)\)\))107 420 Q(\(map \(lambda \(obj\))97 432 Q
(\(compress-with-dictionary obj content-type\)\))114.5 444 Q
(items\)\)\))109.5 456 Q(groups\)\)\) `)87 468 Q -.74(``)-.74 G
(Recompression)72 492 Q -.74(```)72 516 S
(scheme \(de\214ne \(recompress-object hash ne).74 E(w-algorithm ne)-.25
E(w-le)-.25 E -.15(ve)-.25 G(l\)).15 E("Recompress object with dif)77
528 Q(ferent settings")-.25 E
(\(let* \(\(data \(cas-get-decompressed hash\)\))77 540 Q(\(ne)94.5 552
Q(w-compressed \(compress ne)-.25 E(w-algorithm data ne)-.25 E(w-le)-.25
E -.15(ve)-.25 G(l\)\)\)).15 E(\(storage-put hash ne)82 564 Q
(w-compressed\))-.25 E(\(soup-update hash)82 576 Q
(compression: `\(\(algorithm . ,ne)87 588 Q(w-algorithm\))-.25 E(\(le)
124.5 600 Q -.15(ve)-.25 G 2.5(l.,).15 G(ne)-2.5 E(w-le)-.25 E -.15(ve)
-.25 G(l\)).15 E(\(original-size . ,\(byte)124.5 612 Q -.15(ve)-.25 G
(ctor).15 E(-length data\)\))-.2 E(\(compressed-size . ,\(byte)124.5 624
Q -.15(ve)-.25 G(ctor).15 E(-length ne)-.2 E(w-compressed\)\)\)\))-.25 E
(\(audit-append action: ')82 636 Q(recompressed)-.5 E(hash: hash)117 648
Q(algorithm: ne)117 660 Q(w-algorithm\)\)\) `)-.25 E -.74(``)-.74 G(---)
72 684 Q(Deduplication)72 708 Q(Content-Based Deduplication)72 732 Q
-.74(```)72 756 S(scheme ;; Content addressing pro).74 E
(vides automatic deduplication \(de\214ne \(store-deduplicated data\))
-.15 E(\(let \(\(hash \(content-hash data\)\)\))77 768 Q(\(if \(cas-e)82
780 Q(xists? hash\))-.15 E(\(be)92 792 Q(gin)-.15 E 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(;; Increment reference count)97 12 Q
(\(soup-update hash ref-count: \(+ 1 \(soup-ref-count hash\)\)\))97 24 Q
(\(audit-append action: ')97 36 Q(deduplicated hash: hash\))-.5 E
(hash\))97 48 Q(\(cas-put data\)\)\)\) `)92 60 Q -.74(``)-.74 G
(Block-Le)72 84 Q -.15(ve)-.25 G 2.5(lD).15 G(eduplication)-2.5 E -.74
(```)72 108 S(scheme ;; Split lar).74 E
(ge objects into blocks \(de\214ne *block-size* 65536\))-.18 E 2.5(;6)5
G(4KB)-2.5 E(\(de\214ne \(chunk-object data\))72 132 Q
("Split object into content-de\214ned chunks")77 144 Q
(\(let \(\(chunks '\(\)\))77 156 Q(\(pos 0\)\))92 168 Q
(\(while \(< pos \(byte)82 180 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\))-.2 E
(\(let \(\(boundary \(\214nd-chunk-boundary data pos\)\)\))87 192 Q
(\(set! chunks \(cons \(subbyte)92 204 Q -.15(ve)-.25 G
(ctor data pos boundary\) chunks\)\)).15 E(\(set! pos boundary\)\)\))92
216 Q(\(re)82 228 Q -.15(ve)-.25 G(rse chunks\)\)\)).15 E(;; Content-de\
\214ned chunking \(Rabin \214ngerprint\) \(de\214ne \(\214nd-chunk-boun\
dary data start\))72 252 Q("Find chunk boundary using rolling hash")77
264 Q(\(let \(\(min-size 4096\))77 276 Q(\(max-size 131072\))92 288 Q
(\(mask #x1FFF\)\))92 300 Q 2.5(;A)5 G -.15(ve)-3.24 G(rage 8KB chunks)
.15 E(\(let loop \(\(pos \(+ start min-size\)\)\))82 312 Q(\(cond)87 324
Q(\(\(>= pos \(min \(+ start max-size\) \(byte)92 336 Q -.15(ve)-.25 G
(ctor).15 E(-length data\)\)\))-.2 E(pos\))94.5 348 Q
(\(\(= \(bitwise-and \(rabin-hash data pos\) mask\) 0\))92 360 Q(pos\))
94.5 372 Q(\(else \(loop \(+ pos 1\)\)\)\)\)\)\) `)92 384 Q -.74(``)-.74
G(Chunk Storage)72 408 Q -.74(```)72 432 S
(scheme \(de\214ne \(store-chunk).74 E(ed data\))-.1 E("Store lar)77 444
Q(ge object as deduplicated chunks")-.18 E
(\(let* \(\(chunks \(chunk-object data\)\))77 456 Q
(\(chunk-hashes \(map \(lambda \(chunk\))94.5 468 Q
(\(store-deduplicated chunk\)\))147 480 Q(chunks\)\)\))142 492 Q
(;; Store manifest)82 504 Q(\(let \(\(manifest `\(chunk)82 516 Q
(ed-object)-.1 E(\(chunks ,chunk-hashes\))127 528 Q
(\(total-size ,\(byte)127 540 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\))-.2 E(\(chunk-count ,\(length chunks\)\)\)\)\))127 552
Q(\(cas-put \(serialize manifest\)\)\)\)\))87 564 Q(\(de\214ne \(retrie)
72 588 Q -.15(ve)-.25 G(-chunk).15 E(ed manifest-hash\))-.1 E
("Reassemble chunk)77 600 Q(ed object")-.1 E
(\(let* \(\(manifest \(deserialize \(cas-get manifest-hash\)\)\))77 612
Q(\(chunks \(map cas-get \(assoc-ref manifest 'chunks\)\)\)\))94.5 624 Q
(\(byte)82 636 Q -.15(ve)-.25 G(ctor).15 E(-concatenate chunks\)\)\) `)
-.2 E -.74(``)-.74 G(Deduplication Statistics)72 660 Q -.74(```)72 684 S
(scheme \(de\214ne \(deduplication-stats\)).74 E
("Calculate deduplication ef)77 696 Q(fecti)-.25 E -.15(ve)-.25 G(ness")
.15 E(\(let* \(\(objects \(soup-query type: 'an)77 708 Q(y\)\))-.15 E
(\(logical-size \(sum \(map soup-original-size objects\)\)\))94.5 720 Q
(\(ph)94.5 732 Q(ysical-size \(sum \(map soup-compressed-size)-.05 E
(\(delete-duplicates objects hash=?\)\)\)\)\))157 744 Q
(`\(\(logical-size . ,logical-size\))82 756 Q(\(ph)87 768 Q
(ysical-size . ,ph)-.05 E(ysical-size\))-.05 E
(\(dedup-ratio . ,\(/ logical-size ph)87 780 Q(ysical-size\)\))-.05 E
(\(space-sa)87 792 Q -.15(ve)-.2 G 2.5(d.,).15 G(\(- logical-size ph)
-2.5 E(ysical-size\)\)\)\)\) `)-.05 E -.74(``)-.74 G 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(---)72 24 Q(Delta Compression)72 48 Q -1.11(Ve)
72 72 S(rsion Deltas)1.11 E -.74(```)72 96 S
(scheme \(de\214ne \(store-delta base-hash ne).74 E(w-data\))-.25 E
("Store object as delta from base")77 108 Q
(\(let* \(\(base-data \(cas-get base-hash\)\))77 120 Q
(\(delta \(compute-delta base-data ne)94.5 132 Q(w-data\)\))-.25 E(\(ne)
94.5 144 Q(w-hash \(content-hash ne)-.25 E(w-data\)\)\))-.25 E
(\(if \(< \(byte)82 156 Q -.15(ve)-.25 G(ctor).15 E(-length delta\))-.2
E(\(* 0.5 \(byte)99.5 168 Q -.15(ve)-.25 G(ctor).15 E(-length ne)-.2 E
(w-data\)\)\))-.25 E(;; Delta is w)92 180 Q(orthwhile)-.1 E(\(be)92 192
Q(gin)-.15 E(\(storage-put ne)97 204 Q(w-hash delta\))-.25 E
(\(soup-put ne)97 216 Q(w-hash)-.25 E(delta: `\(\(base . ,base-hash\))
102 228 Q(\(type . xdelta\)\)\))124.5 240 Q(ne)97 252 Q(w-hash\))-.25 E
(;; Store full object)92 264 Q(\(cas-put ne)92 276 Q(w-data\)\)\)\))-.25
E(\(de\214ne \(retrie)72 300 Q -.15(ve)-.25 G(-delta hash\)).15 E
("Reconstruct object from delta")77 312 Q
(\(let \(\(meta \(soup-get hash\)\)\))77 324 Q(\(if \(assoc-ref meta ')
82 336 Q(delta\))-.5 E
(\(let* \(\(base-hash \(assoc-ref \(assoc-ref meta ')92 348 Q
(delta\) 'base\)\))-.5 E(\(base-data \(cas-get base-hash\)\))109.5 360 Q
(\(delta \(storage-get hash\)\)\))109.5 372 Q
(\(apply-delta base-data delta\)\))97 384 Q
(\(storage-get hash\)\)\)\) `)92 396 Q -.74(``)-.74 G(Delta Chains)72
420 Q -.74(```)72 444 S
(scheme ;; Limit delta chain depth \(de\214ne *max-delta-depth* 10).74 E
(\(de\214ne \(delta-chain-depth hash\))72 468 Q
("Calculate depth of delta chain")77 480 Q
(\(let \(\(meta \(soup-get hash\)\)\))77 492 Q(\(if \(assoc-ref meta ')
82 504 Q(delta\))-.5 E
(\(+ 1 \(delta-chain-depth \(assoc-ref \(assoc-ref meta ')92 516 Q
(delta\) 'base\)\)\))-.5 E(0\)\)\))92 528 Q
(\(de\214ne \(should-store-delta? base-hash\))72 552 Q
("Check if delta storage is appropriate")77 564 Q
(\(< \(delta-chain-depth base-hash\) *max-delta-depth*\)\) `)77 576 Q
-.74(``)-.74 G(---)72 600 Q(Archi)72 624 Q .3 -.15(ve C)-.25 H
(ompression).15 E(Sealed Archi)72 648 Q .3 -.15(ve Fo)-.25 H(rmat).15 E
-.74(```)72 672 S(scheme ;; RFC-018 inte).74 E
(gration \(de\214ne \(create-compressed-archi)-.15 E .3 -.15(ve o)-.25 H
(bjects\)).15 E("Create compressed sealed archi)77 684 Q -.15(ve)-.25 G
(").15 E(\(let* \(\(serialized \(serialize-objects objects\)\))77 696 Q
(\(compressed \(zstd-compress serialized 19\)\))94.5 708 Q 2.5(;M)5 G
(ax compression)-2.5 E
(\(encrypted \(age-encrypt compressed recipients\)\)\))94.5 720 Q
(\(cas-put encrypted\)\)\) `)82 732 Q -.74(``)-.74 G
(Streaming Compression)72 756 Q -.74(```)72 780 S
(scheme \(de\214ne \(stream-compress input-port output-port algorithm\))
.74 E("Stream compression for lar)77 792 Q(ge \214les")-.18 E 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(let \(\(ctx \(compression-conte)77 12 Q
(xt-create algorithm\)\)\))-.15 E(\(let loop \(\))82 24 Q
(\(let \(\(chunk \(read-byte)87 36 Q -.15(ve)-.25 G
(ctor *chunk-size* input-port\)\)\)).15 E
(\(unless \(eof-object? chunk\))92 48 Q(\(write-byte)97 60 Q -.15(ve)
-.25 G(ctor \(compress-chunk ctx chunk\) output-port\)).15 E
(\(loop\)\)\)\))97 72 Q(\(write-byte)82 84 Q -.15(ve)-.25 G
(ctor \(compress-\214nish ctx\) output-port\)\)\) `).15 E -.74(``)-.74 G
(---)72 108 Q(Performance Optimization)72 132 Q(Compression Cache)72 156
Q -.74(```)72 180 S(scheme \(de\214ne compression-cache \(mak).74 E
(e-lru-cache 1000\)\))-.1 E(\(de\214ne \(cached-decompress hash\))72 204
Q("Cache decompressed data for frequent access")77 216 Q
(\(or \(lru-get compression-cache hash\))77 228 Q
(\(let \(\(data \(cas-get-decompressed hash\)\)\))87 240 Q
(\(lru-put! compression-cache hash data\))92 252 Q(data\)\)\) `)92 264 Q
-.74(``)-.74 G -.15(Pa)72 288 S(rallel Compression).15 E -.74(```)72 312
S(scheme \(de\214ne \(parallel-compress objects num-threads\)).74 E
("Compress multiple objects in parallel")77 324 Q(\(let \(\(w)77 336 Q
(ork-queue \(mak)-.1 E(e-channel\)\))-.1 E(\(results \(mak)92 348 Q
(e-channel\)\)\))-.1 E(;; Start w)82 360 Q(ork)-.1 E(ers)-.1 E
(\(do \(\(i 0 \(+ i 1\)\)\))82 372 Q(\(\(= i num-threads\)\))92 384 Q
(\(thread-start!)87 396 Q(\(mak)92 408 Q(e-thread)-.1 E(\(lambda \(\))97
420 Q(\(let loop \(\))102 432 Q(\(let \(\(obj \(channel-get! w)107 444 Q
(ork-queue\)\)\))-.1 E(\(when obj)112 456 Q
(\(channel-put! results \(compress-object obj\)\))117 468 Q
(\(loop\)\)\)\)\)\)\)\))117 480 Q(;; Queue w)82 492 Q(ork)-.1 E(\(for)82
504 Q(-each \(lambda \(obj\) \(channel-put! w)-.2 E
(ork-queue obj\)\) objects\))-.1 E(;; Collect results)82 516 Q
(\(map \(lambda \(_\) \(channel-get! results\)\) objects\)\)\) `)82 528
Q -.74(``)-.74 G(Adapti)72 552 Q .3 -.15(ve C)-.25 H(ompression).15 E
-.74(```)72 576 S(scheme \(de\214ne \(adapti).74 E -.15(ve)-.25 G
(-compress data\)).15 E("Select compression based on content analysis")
77 588 Q(\(let* \(\(sample \(subbyte)77 600 Q -.15(ve)-.25 G
(ctor data 0 \(min 4096 \(byte).15 E -.15(ve)-.25 G(ctor).15 E
(-length data\)\)\)\))-.2 E(\(entrop)94.5 612 Q 2.5(y\()-.1 G
(calculate-entrop)-2.5 E 2.5(ys)-.1 G(ample\)\)\))-2.5 E(\(cond)82 624 Q
(;; High entrop)87 636 Q 2.5(y-a)-.1 G(lready compressed or encrypted)
-2.5 E(\(\(> entrop)87 648 Q 2.5(y7)-.1 G(.9\) 'none\))-2.5 E(;; Lo)87
660 Q 2.5(we)-.25 G(ntrop)-2.5 E 2.5(y-h)-.1 G(ighly compressible)-2.5 E
(\(\(< entrop)87 672 Q 2.5(y4)-.1 G(.0\) \(v)-2.5 E(alues 'zstd 19\)\))
-.25 E(;; Medium entrop)87 684 Q 2.5(y-b)-.1 G(alanced)-2.5 E
(\(else \(v)87 696 Q(alues 'zstd 3\)\)\)\)\) `)-.25 E -.74(``)-.74 G
(---)72 720 Q(Inte)72 744 Q(grity)-.15 E -1.11(Ve)72 768 S(ri\214cation)
1.11 E -.74(```)72 792 S(scheme \(de\214ne \(v).74 E
(erify-compressed-object hash\))-.15 E 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF("V)77 12 Q(erify compressed object inte)-1.11 E
(grity")-.15 E(\(let* \(\(stored \(storage-get hash\)\))77 24 Q
(\(meta \(soup-get hash\)\))94.5 36 Q
(\(decompressed \(decompress \(assoc-ref meta 'algorithm\) stored\)\))
94.5 48 Q(\(computed-hash \(content-hash decompressed\)\)\))94.5 60 Q
(\(equal? hash computed-hash\)\)\) `)82 72 Q -.74(``)-.74 G
(Corruption Reco)72 96 Q -.15(ve)-.15 G(ry).15 E -.74(```)72 120 S
(scheme \(de\214ne \(reco).74 E -.15(ve)-.15 G -.2(r-).15 G
(compressed hash\)).2 E("Attempt to reco)77 132 Q -.15(ve)-.15 G 2.5(rc)
.15 G(orrupted compressed object")-2.5 E(;; T)77 144 Q
(ry partial decompression)-.35 E
(\(let \(\(partial \(decompress-partial hash\)\)\))77 156 Q
(\(when partial)82 168 Q(\(audit-append action: 'partial-reco)87 180 Q
-.15(ve)-.15 G(ry hash: hash\)).15 E(partial\)\))87 192 Q
(;; Fetch from replica)77 216 Q
(\(let \(\(replica-data \(fetch-from-replica hash\)\)\))77 228 Q
(\(when replica-data)82 240 Q(\(storage-put hash replica-data\))87 252 Q
(replica-data\)\)\) `)87 264 Q -.74(``)-.74 G(---)72 288 Q(References)72
312 Q 1.33(1. [Zstandard]\(https://github)72 336 R(.com/f)-.4 E 1.33
(acebook/zstd\) - F)-.1 F(acebook')-.15 E 3.83(sc)-.55 G 1.33
(ompression algorithm 2. [Content-De\214ned Chunk-)-3.83 F 2.835(ing]\(\
https://restic.net/blog/2015-09-12/restic-foundation1-cdc/\) - Restic b\
log 3. [RFC-018: Sealed Archi)72 348 R 3.135 -.15(ve Fo)-.25 H -.2(r-)
.15 G(mat]\(rfc-018-sealed-archi)72 360 Q -.15(ve)-.25 G(.md\) 4. [RFC-\
020: Content-Addressed Storage]\(rfc-020-content-addressed-storage.md\))
.15 E(---)72 384 Q(Changelog)72 408 Q 2.5(-*)72 432 S
(*2026-01-07** - Initial draft)-2.5 E(---)72 456 Q 1.225(**Implementati\
on Status:** Draft **Dependencies:** cas, zstd, soup **Inte)72 480 R
1.226(gration:** Storage layer)-.15 F 3.726(,a)-.4 G(rchi)-3.726 E 1.526
-.15(ve c)-.25 H(re-).15 E(ation, replication)72 492 Q 0 Cg EP
%%Trailer
end
%%EOF
