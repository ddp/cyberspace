%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Thu Jan  8 15:17:54 2026
%%DocumentNeededResources: font Times-Roman
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 7
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(RFC-029: Compression and Deduplication)72 12 Q(\
Status: Draft Date: January 2026 Author: Derrell Piper ddp@eludom.net I\
mplementation: Proposed)72 36 Q(---------------------------------------\
---------------------------------------)72 60 Q(Abstract)72 84 Q .035(T\
his RFC speci\214es compression and deduplication for the Library of Cy\
berspace: ho)72 108 R 2.535(wv)-.25 G .035
(aults reduce storage require-)-2.785 F .709
(ments while maintaining content-addressability)72 120 R 3.209(,i)-.65 G
(nte)-3.209 E .709(grity v)-.15 F .709(eri\214cation, and ef)-.15 F .709
(\214cient retrie)-.25 F -.25(va)-.25 G 3.209(l. Compression).25 F .71
(is trans-)3.209 F(parent to the content-addressing layer)72 132 Q(.)
-.55 E(----------------------------------------------------------------\
--------------)72 156 Q(Moti)72 180 Q -.25(va)-.25 G(tion).25 E
(Storage ef)72 204 Q(\214cienc)-.25 E 2.5(ym)-.15 G(atters for preserv)
-2.5 E(ation:)-.25 E 3.495(-C)72 228 S .995
(ost - Less storage means more preserv)-3.495 F .994
(ation per dollar - Bandwidth - Compressed transfers are f)-.25 F .994
(aster - Redun-)-.1 F(danc)72 240 Q 2.5(y-M)-.15 G
(ore copies \214t in same space - Longe)-2.5 E(vity - Smaller archi)-.25
E -.15(ve)-.25 G 2.5(ss).15 G(urvi)-2.5 E .3 -.15(ve l)-.25 H(onger).15
E(But compression must not compromise:)72 264 Q 3.182(-I)72 288 S(nte)
-3.182 E .683(grity - Hashes must remain v)-.15 F .683
(alid - Addressability - Content addressing still w)-.25 F .683
(orks - Deduplication - Identical)-.1 F
(content stored once - Accessibility - Data remains retrie)72 300 Q -.25
(va)-.25 G(ble).25 E(--------------------------------------------------\
----------------------------)72 324 Q(Compression Model)72 348 Q
(Layered Architecture)72 372 Q<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2>82 396 Q 22.5<e241>82 408 S
(pplication Layer)-22.5 E<e2>27.5 E 12.5<e228>82 420 S
(sees uncompressed data\))-12.5 E<e2>20 E<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a4>82 432 Q 20<e243>82
444 S 25(ontent-Addressing \342)-20 F 10<e228>82 456 S
(hash of uncompressed data\))-10 E<e2>15 E<e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a4>82 468 Q 20<e243>82
480 S(ompression Layer)-20 E<e2>30 E 15<e228>82 492 S
(transparent compression\))-15 E<e2>15 E<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2a4>82 504 Q 22.5<e253>82
516 S(torage Layer)-22.5 E<e2>37.5 E 12.5<e228>82 528 S
(stores compressed data\))-12.5 E<e2>20 E<e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2
e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2>82 540 Q
(Compression Metadata)72 564 Q
(\(de\214ne \(compress-object data algorithm\))82 588 Q
(\(let* \(\(compressed \(compress algorithm data\)\))87 600 Q
(\(ratio \(/ \(byte)104.5 612 Q -.15(ve)-.25 G(ctor).15 E
(-length compressed\))-.2 E(\(byte)129.5 624 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\)\)\))-.2 E(`\(compressed-object)92 636 Q
(\(algorithm ,algorithm\))97 648 Q(\(original-size ,\(byte)97 660 Q -.15
(ve)-.25 G(ctor).15 E(-length data\)\))-.2 E(\(compressed-size ,\(byte)
97 672 Q -.15(ve)-.25 G(ctor).15 E(-length compressed\)\))-.2 E
(\(ratio ,ratio\))97 684 Q(\(data ,compressed\)\)\)\))97 696 Q
(;; Stored in soup)82 720 Q(\(soup-object)82 732 Q
(\(hash "sha256:original-content-hash..."\))87 744 Q(\(compression)87
756 Q(\(algorithm zstd\))92 768 Q(\(le)92 780 Q -.15(ve)-.25 G 2.5(l3)
.15 G(\))-2.5 E(\(original-size 1048576\))92 792 Q 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(compressed-size 524288\))92 12 Q
(\(ratio 0.5\)\)\))92 24 Q(--------------------------------------------\
----------------------------------)72 48 Q(Compression Algorithms)72 72
Q(Supported Algorithms)72 96 Q(\(de\214ne compression-algorithms)82 120
Q(`\(\(zstd . \(\(e)87 132 Q(xtension . "zst"\))-.15 E(\(le)114.5 144 Q
-.15(ve)-.25 G(ls . \(1 3 9 19\)\)).15 E(\(def)114.5 156 Q(ault-le)-.1 E
-.15(ve)-.25 G 2.5(l.3).15 G(\))-2.5 E(\(dictionary . #t\)\)\))114.5 168
Q(\(lz4 . \(\(e)92 180 Q(xtension . "lz4"\))-.15 E(\(le)112 192 Q -.15
(ve)-.25 G(ls . \(1 9\)\)).15 E(\(def)112 204 Q(ault-le)-.1 E -.15(ve)
-.25 G 2.5(l.1).15 G(\))-2.5 E(\(dictionary . #f\)\)\))112 216 Q
(\(gzip . \(\(e)92 228 Q(xtension . "gz"\))-.15 E(\(le)114.5 240 Q -.15
(ve)-.25 G(ls . \(1 6 9\)\)).15 E(\(def)114.5 252 Q(ault-le)-.1 E -.15
(ve)-.25 G 2.5(l.6).15 G(\))-2.5 E(\(dictionary . #f\)\)\))114.5 264 Q
(\(none . \(\(e)92 276 Q(xtension . #f\))-.15 E(\(le)114.5 288 Q -.15
(ve)-.25 G(ls . \(\)\)).15 E(\(def)114.5 300 Q(ault-le)-.1 E -.15(ve)
-.25 G 2.5(l.#).15 G(f\))-2.5 E(\(dictionary . #f\)\)\)\)\))114.5 312 Q
(Algorithm Selection)72 336 Q
(\(de\214ne \(select-compression-algorithm content-type size\))82 360 Q
("Select best algorithm for content")87 372 Q(\(cond)87 384 Q
(;; Already compressed formats)92 396 Q
(\(\(member content-type '\("image/jpe)92 408 Q
(g" "image/png" "video/mp4")-.15 E
("application/zip" "application/gzip"\)\))149.5 420 Q('none\))94.5 432 Q
(;; Small objects - o)92 444 Q -.15(ve)-.15 G(rhead not w).15 E(orth it)
-.1 E(\(\(< size 1024\))92 456 Q('none\))94.5 468 Q(;; T)92 480 Q -.15
(ex)-.7 G 2.5(ta).15 G(nd code - zstd with dictionary)-2.5 E
(\(\(member content-type '\("te)92 492 Q(xt/plain" "te)-.15 E
(xt/html" "application/json")-.15 E("application/ja)149.5 504 Q -.25(va)
-.2 G(script" "te).25 E(xt/x-scheme"\)\))-.15 E('zstd\))94.5 516 Q
(;; Binary data - lz4 for speed)92 528 Q
(\(\(string-pre\214x? "application/" content-type\))92 540 Q -.1('l)94.5
552 S(z4\)).1 E(;; Def)92 564 Q(ault)-.1 E(\(else 'zstd\)\)\))92 576 Q
(Zstd Dictionaries)72 600 Q(;; T)82 624 Q
(rain dictionary on sample data)-.35 E
(\(de\214ne \(train-dictionary samples dict-size\))82 636 Q("T)87 648 Q
(rain zstd dictionary from sample data")-.35 E
(\(zstd-train-dictionary samples dict-size\)\))87 660 Q
(;; Content-type speci\214c dictionaries)82 684 Q
(\(de\214ne dictionaries)82 696 Q
(`\(\(scheme . ,\(load-dictionary "scheme.dict"\)\))87 708 Q
(\(json . ,\(load-dictionary "json.dict"\)\))92 720 Q(\(markdo)92 732 Q
(wn . ,\(load-dictionary "markdo)-.25 E(wn.dict"\)\)\)\))-.25 E
(\(de\214ne \(compress-with-dictionary data content-type\))82 756 Q
(\(let \(\(dict \(assoc-ref dictionaries content-type\)\)\))87 768 Q
(\(if dict)92 780 Q(\(zstd-compress-with-dict data dict\))102 792 Q 0 Cg
EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(zstd-compress data\)\)\)\))102 12 Q(---------\
---------------------------------------------------------------------)72
36 Q(Compression Operations)72 60 Q -.35(Tr)72 84 S
(ansparent Compression).35 E(\(de\214ne \(cas-put-compressed data\))82
108 Q("Store data with transparent compression")87 120 Q
(\(let* \(\(hash \(content-hash data\)\))87 132 Q 2.5(;H)5 G
(ash uncompressed)-2.5 E(\(algorithm \(select-compression-algorithm)
104.5 144 Q(\(detect-content-type data\))134.5 156 Q(\(byte)134.5 168 Q
-.15(ve)-.25 G(ctor).15 E(-length data\)\)\))-.2 E
(\(stored \(if \(eq? algorithm 'none\))104.5 180 Q(data)134.5 192 Q
(\(compress algorithm data\)\)\)\))134.5 204 Q
(;; Store compressed, inde)92 216 Q 2.5(xb)-.15 G 2.5(yu)-2.5 G
(ncompressed hash)-2.5 E(\(storage-put hash stored\))92 228 Q
(;; Record compression metadata)92 240 Q(\(soup-put hash)92 252 Q
(compression: `\(\(algorithm . ,algorithm\))97 264 Q
(\(original-size . ,\(byte)134.5 276 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\))-.2 E(\(compressed-size . ,\(byte)134.5 288 Q -.15(ve)
-.25 G(ctor).15 E(-length stored\)\)\)\))-.2 E(hash\)\))92 300 Q
(\(de\214ne \(cas-get-decompressed hash\))82 324 Q("Retrie)87 336 Q .3
-.15(ve a)-.25 H(nd decompress data").15 E
(\(let* \(\(stored \(storage-get hash\)\))87 348 Q
(\(meta \(soup-get hash\)\))104.5 360 Q(\(algorithm \(assoc-ref \(assoc\
-ref meta 'compression\) 'algorithm\)\)\))104.5 372 Q
(\(if \(or \(not algorithm\) \(eq? algorithm 'none\)\))92 384 Q(stored)
102 396 Q(\(decompress algorithm stored\)\)\)\))102 408 Q
(Batch Compression)72 432 Q(\(de\214ne \(compress-batch objects\))82 456
Q("Compress multiple objects ef)87 468 Q(\214ciently")-.25 E
(;; Group by content type for dictionary ef)87 480 Q(\214cienc)-.25 E(y)
-.15 E(\(let \(\(groups \(group-by detect-content-type objects\)\)\))87
492 Q(\(append-map)92 504 Q(\(lambda \(group\))97 516 Q
(\(let \(\(content-type \(car group\)\))102 528 Q
(\(items \(cdr group\)\)\))117 540 Q(\(map \(lambda \(obj\))107 552 Q
(\(compress-with-dictionary obj content-type\)\))124.5 564 Q
(items\)\)\))119.5 576 Q(groups\)\)\))97 588 Q(Recompression)72 612 Q
(\(de\214ne \(recompress-object hash ne)82 636 Q(w-algorithm ne)-.25 E
(w-le)-.25 E -.15(ve)-.25 G(l\)).15 E("Recompress object with dif)87 648
Q(ferent settings")-.25 E
(\(let* \(\(data \(cas-get-decompressed hash\)\))87 660 Q(\(ne)104.5 672
Q(w-compressed \(compress ne)-.25 E(w-algorithm data ne)-.25 E(w-le)-.25
E -.15(ve)-.25 G(l\)\)\)).15 E(\(storage-put hash ne)92 684 Q
(w-compressed\))-.25 E(\(soup-update hash)92 696 Q
(compression: `\(\(algorithm . ,ne)97 708 Q(w-algorithm\))-.25 E(\(le)
134.5 720 Q -.15(ve)-.25 G 2.5(l.,).15 G(ne)-2.5 E(w-le)-.25 E -.15(ve)
-.25 G(l\)).15 E(\(original-size . ,\(byte)134.5 732 Q -.15(ve)-.25 G
(ctor).15 E(-length data\)\))-.2 E(\(compressed-size . ,\(byte)134.5 744
Q -.15(ve)-.25 G(ctor).15 E(-length ne)-.2 E(w-compressed\)\)\)\))-.25 E
(\(audit-append action: ')92 756 Q(recompressed)-.5 E(hash: hash)127 768
Q(algorithm: ne)127 780 Q(w-algorithm\)\)\))-.25 E 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(-----------------------------------------------\
-------------------------------)72 12 Q(Deduplication)72 36 Q
(Content-Based Deduplication)72 60 Q(;; Content addressing pro)82 84 Q
(vides automatic deduplication)-.15 E
(\(de\214ne \(store-deduplicated data\))82 96 Q
(\(let \(\(hash \(content-hash data\)\)\))87 108 Q(\(if \(cas-e)92 120 Q
(xists? hash\))-.15 E(\(be)102 132 Q(gin)-.15 E
(;; Increment reference count)107 144 Q
(\(soup-update hash ref-count: \(+ 1 \(soup-ref-count hash\)\)\))107 156
Q(\(audit-append action: ')107 168 Q(deduplicated hash: hash\))-.5 E
(hash\))107 180 Q(\(cas-put data\)\)\)\))102 192 Q(Block-Le)72 216 Q
-.15(ve)-.25 G 2.5(lD).15 G(eduplication)-2.5 E(;; Split lar)82 240 Q
(ge objects into blocks)-.18 E(\(de\214ne *block-size* 65536\))82 252 Q
2.5(;6)5 G(4KB)-2.5 E(\(de\214ne \(chunk-object data\))82 276 Q
("Split object into content-de\214ned chunks")87 288 Q
(\(let \(\(chunks '\(\)\))87 300 Q(\(pos 0\)\))102 312 Q
(\(while \(< pos \(byte)92 324 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\))-.2 E
(\(let \(\(boundary \(\214nd-chunk-boundary data pos\)\)\))97 336 Q
(\(set! chunks \(cons \(subbyte)102 348 Q -.15(ve)-.25 G
(ctor data pos boundary\) chunks\)\)).15 E(\(set! pos boundary\)\)\))102
360 Q(\(re)92 372 Q -.15(ve)-.25 G(rse chunks\)\)\)).15 E
(;; Content-de\214ned chunking \(Rabin \214ngerprint\))82 396 Q
(\(de\214ne \(\214nd-chunk-boundary data start\))82 408 Q
("Find chunk boundary using rolling hash")87 420 Q
(\(let \(\(min-size 4096\))87 432 Q(\(max-size 131072\))102 444 Q
(\(mask #x1FFF\)\))102 456 Q 2.5(;A)5 G -.15(ve)-3.24 G(rage 8KB chunks)
.15 E(\(let loop \(\(pos \(+ start min-size\)\)\))92 468 Q(\(cond)97 480
Q(\(\(>= pos \(min \(+ start max-size\) \(byte)102 492 Q -.15(ve)-.25 G
(ctor).15 E(-length data\)\)\))-.2 E(pos\))104.5 504 Q
(\(\(= \(bitwise-and \(rabin-hash data pos\) mask\) 0\))102 516 Q(pos\))
104.5 528 Q(\(else \(loop \(+ pos 1\)\)\)\)\)\)\))102 540 Q
(Chunk Storage)72 564 Q(\(de\214ne \(store-chunk)82 588 Q(ed data\))-.1
E("Store lar)87 600 Q(ge object as deduplicated chunks")-.18 E
(\(let* \(\(chunks \(chunk-object data\)\))87 612 Q
(\(chunk-hashes \(map \(lambda \(chunk\))104.5 624 Q
(\(store-deduplicated chunk\)\))157 636 Q(chunks\)\)\))152 648 Q
(;; Store manifest)92 660 Q(\(let \(\(manifest `\(chunk)92 672 Q
(ed-object)-.1 E(\(chunks ,chunk-hashes\))137 684 Q
(\(total-size ,\(byte)137 696 Q -.15(ve)-.25 G(ctor).15 E
(-length data\)\))-.2 E(\(chunk-count ,\(length chunks\)\)\)\)\))137 708
Q(\(cas-put \(serialize manifest\)\)\)\)\))97 720 Q(\(de\214ne \(retrie)
82 744 Q -.15(ve)-.25 G(-chunk).15 E(ed manifest-hash\))-.1 E
("Reassemble chunk)87 756 Q(ed object")-.1 E
(\(let* \(\(manifest \(deserialize \(cas-get manifest-hash\)\)\))87 768
Q(\(chunks \(map cas-get \(assoc-ref manifest 'chunks\)\)\)\))104.5 780
Q(\(byte)92 792 Q -.15(ve)-.25 G(ctor).15 E(-concatenate chunks\)\)\))
-.2 E 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Deduplication Statistics)72 24 Q
(\(de\214ne \(deduplication-stats\))82 48 Q("Calculate deduplication ef)
87 60 Q(fecti)-.25 E -.15(ve)-.25 G(ness").15 E
(\(let* \(\(objects \(soup-query type: 'an)87 72 Q(y\)\))-.15 E
(\(logical-size \(sum \(map soup-original-size objects\)\)\))104.5 84 Q
(\(ph)104.5 96 Q(ysical-size \(sum \(map soup-compressed-size)-.05 E
(\(delete-duplicates objects hash=?\)\)\)\)\))167 108 Q
(`\(\(logical-size . ,logical-size\))92 120 Q(\(ph)97 132 Q
(ysical-size . ,ph)-.05 E(ysical-size\))-.05 E
(\(dedup-ratio . ,\(/ logical-size ph)97 144 Q(ysical-size\)\))-.05 E
(\(space-sa)97 156 Q -.15(ve)-.2 G 2.5(d.,).15 G(\(- logical-size ph)
-2.5 E(ysical-size\)\)\)\)\))-.05 E(-----------------------------------\
-------------------------------------------)72 180 Q(Delta Compression)
72 204 Q -1.11(Ve)72 228 S(rsion Deltas)1.11 E
(\(de\214ne \(store-delta base-hash ne)82 252 Q(w-data\))-.25 E
("Store object as delta from base")87 264 Q
(\(let* \(\(base-data \(cas-get base-hash\)\))87 276 Q
(\(delta \(compute-delta base-data ne)104.5 288 Q(w-data\)\))-.25 E
(\(ne)104.5 300 Q(w-hash \(content-hash ne)-.25 E(w-data\)\)\))-.25 E
(\(if \(< \(byte)92 312 Q -.15(ve)-.25 G(ctor).15 E(-length delta\))-.2
E(\(* 0.5 \(byte)109.5 324 Q -.15(ve)-.25 G(ctor).15 E(-length ne)-.2 E
(w-data\)\)\))-.25 E(;; Delta is w)102 336 Q(orthwhile)-.1 E(\(be)102
348 Q(gin)-.15 E(\(storage-put ne)107 360 Q(w-hash delta\))-.25 E
(\(soup-put ne)107 372 Q(w-hash)-.25 E(delta: `\(\(base . ,base-hash\))
112 384 Q(\(type . xdelta\)\)\))134.5 396 Q(ne)107 408 Q(w-hash\))-.25 E
(;; Store full object)102 420 Q(\(cas-put ne)102 432 Q(w-data\)\)\)\))
-.25 E(\(de\214ne \(retrie)82 456 Q -.15(ve)-.25 G(-delta hash\)).15 E
("Reconstruct object from delta")87 468 Q
(\(let \(\(meta \(soup-get hash\)\)\))87 480 Q(\(if \(assoc-ref meta ')
92 492 Q(delta\))-.5 E
(\(let* \(\(base-hash \(assoc-ref \(assoc-ref meta ')102 504 Q
(delta\) 'base\)\))-.5 E(\(base-data \(cas-get base-hash\)\))119.5 516 Q
(\(delta \(storage-get hash\)\)\))119.5 528 Q
(\(apply-delta base-data delta\)\))107 540 Q(\(storage-get hash\)\)\)\))
102 552 Q(Delta Chains)72 576 Q(;; Limit delta chain depth)82 600 Q
(\(de\214ne *max-delta-depth* 10)82 612 Q
(\(de\214ne \(delta-chain-depth hash\))82 636 Q
("Calculate depth of delta chain")87 648 Q
(\(let \(\(meta \(soup-get hash\)\)\))87 660 Q(\(if \(assoc-ref meta ')
92 672 Q(delta\))-.5 E
(\(+ 1 \(delta-chain-depth \(assoc-ref \(assoc-ref meta ')102 684 Q
(delta\) 'base\)\)\))-.5 E(0\)\)\))102 696 Q
(\(de\214ne \(should-store-delta? base-hash\))82 720 Q
("Check if delta storage is appropriate")87 732 Q
(\(< \(delta-chain-depth base-hash\) *max-delta-depth*\)\))87 744 Q(---\
-----------------------------------------------------------------------\
----)72 768 Q(Archi)72 792 Q .3 -.15(ve C)-.25 H(ompression).15 E 0 Cg
EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Sealed Archi)72 24 Q .3 -.15(ve Fo)-.25 H(rmat)
.15 E(;; RFC-018 inte)82 48 Q(gration)-.15 E
(\(de\214ne \(create-compressed-archi)82 60 Q .3 -.15(ve o)-.25 H
(bjects\)).15 E("Create compressed sealed archi)87 72 Q -.15(ve)-.25 G
(").15 E(\(let* \(\(serialized \(serialize-objects objects\)\))87 84 Q
(\(compressed \(zstd-compress serialized 19\)\))104.5 96 Q 2.5(;M)5 G
(ax compression)-2.5 E
(\(encrypted \(age-encrypt compressed recipients\)\)\))104.5 108 Q
(\(cas-put encrypted\)\)\))92 120 Q(Streaming Compression)72 144 Q
(\(de\214ne \(stream-compress input-port output-port algorithm\))82 168
Q("Stream compression for lar)87 180 Q(ge \214les")-.18 E
(\(let \(\(ctx \(compression-conte)87 192 Q(xt-create algorithm\)\)\))
-.15 E(\(let loop \(\))92 204 Q(\(let \(\(chunk \(read-byte)97 216 Q
-.15(ve)-.25 G(ctor *chunk-size* input-port\)\)\)).15 E
(\(unless \(eof-object? chunk\))102 228 Q(\(write-byte)107 240 Q -.15
(ve)-.25 G(ctor \(compress-chunk ctx chunk\) output-port\)).15 E
(\(loop\)\)\)\))107 252 Q(\(write-byte)92 264 Q -.15(ve)-.25 G
(ctor \(compress-\214nish ctx\) output-port\)\)\)).15 E(---------------\
---------------------------------------------------------------)72 288 Q
(Performance Optimization)72 312 Q(Compression Cache)72 336 Q
(\(de\214ne compression-cache \(mak)82 360 Q(e-lru-cache 1000\)\))-.1 E
(\(de\214ne \(cached-decompress hash\))82 384 Q
("Cache decompressed data for frequent access")87 396 Q
(\(or \(lru-get compression-cache hash\))87 408 Q
(\(let \(\(data \(cas-get-decompressed hash\)\)\))97 420 Q
(\(lru-put! compression-cache hash data\))102 432 Q(data\)\)\))102 444 Q
-.15(Pa)72 468 S(rallel Compression).15 E
(\(de\214ne \(parallel-compress objects num-threads\))82 492 Q
("Compress multiple objects in parallel")87 504 Q(\(let \(\(w)87 516 Q
(ork-queue \(mak)-.1 E(e-channel\)\))-.1 E(\(results \(mak)102 528 Q
(e-channel\)\)\))-.1 E(;; Start w)92 540 Q(ork)-.1 E(ers)-.1 E
(\(do \(\(i 0 \(+ i 1\)\)\))92 552 Q(\(\(= i num-threads\)\))102 564 Q
(\(thread-start!)97 576 Q(\(mak)102 588 Q(e-thread)-.1 E(\(lambda \(\))
107 600 Q(\(let loop \(\))112 612 Q(\(let \(\(obj \(channel-get! w)117
624 Q(ork-queue\)\)\))-.1 E(\(when obj)122 636 Q
(\(channel-put! results \(compress-object obj\)\))127 648 Q
(\(loop\)\)\)\)\)\)\)\))127 660 Q(;; Queue w)92 672 Q(ork)-.1 E(\(for)92
684 Q(-each \(lambda \(obj\) \(channel-put! w)-.2 E
(ork-queue obj\)\) objects\))-.1 E(;; Collect results)92 696 Q
(\(map \(lambda \(_\) \(channel-get! results\)\) objects\)\)\))92 708 Q
(Adapti)72 732 Q .3 -.15(ve C)-.25 H(ompression).15 E
(\(de\214ne \(adapti)82 756 Q -.15(ve)-.25 G(-compress data\)).15 E
("Select compression based on content analysis")87 768 Q
(\(let* \(\(sample \(subbyte)87 780 Q -.15(ve)-.25 G
(ctor data 0 \(min 4096 \(byte).15 E -.15(ve)-.25 G(ctor).15 E
(-length data\)\)\)\))-.2 E(\(entrop)104.5 792 Q 2.5(y\()-.1 G
(calculate-entrop)-2.5 E 2.5(ys)-.1 G(ample\)\)\))-2.5 E 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(cond)92 12 Q(;; High entrop)97 24 Q 2.5(y-a)
-.1 G(lready compressed or encrypted)-2.5 E(\(\(> entrop)97 36 Q 2.5(y7)
-.1 G(.9\) 'none\))-2.5 E(;; Lo)97 48 Q 2.5(we)-.25 G(ntrop)-2.5 E 2.5
(y-h)-.1 G(ighly compressible)-2.5 E(\(\(< entrop)97 60 Q 2.5(y4)-.1 G
(.0\) \(v)-2.5 E(alues 'zstd 19\)\))-.25 E(;; Medium entrop)97 72 Q 2.5
(y-b)-.1 G(alanced)-2.5 E(\(else \(v)97 84 Q(alues 'zstd 3\)\)\)\)\))
-.25 E(----------------------------------------------------------------\
--------------)72 108 Q(Inte)72 132 Q(grity)-.15 E -1.11(Ve)72 156 S
(ri\214cation)1.11 E(\(de\214ne \(v)82 180 Q
(erify-compressed-object hash\))-.15 E("V)87 192 Q
(erify compressed object inte)-1.11 E(grity")-.15 E
(\(let* \(\(stored \(storage-get hash\)\))87 204 Q
(\(meta \(soup-get hash\)\))104.5 216 Q
(\(decompressed \(decompress \(assoc-ref meta 'algorithm\) stored\)\))
104.5 228 Q(\(computed-hash \(content-hash decompressed\)\)\))104.5 240
Q(\(equal? hash computed-hash\)\)\))92 252 Q(Corruption Reco)72 276 Q
-.15(ve)-.15 G(ry).15 E(\(de\214ne \(reco)82 300 Q -.15(ve)-.15 G -.2
(r-).15 G(compressed hash\)).2 E("Attempt to reco)87 312 Q -.15(ve)-.15
G 2.5(rc).15 G(orrupted compressed object")-2.5 E(;; T)87 324 Q
(ry partial decompression)-.35 E
(\(let \(\(partial \(decompress-partial hash\)\)\))87 336 Q
(\(when partial)92 348 Q(\(audit-append action: 'partial-reco)97 360 Q
-.15(ve)-.15 G(ry hash: hash\)).15 E(partial\)\))97 372 Q
(;; Fetch from replica)87 396 Q
(\(let \(\(replica-data \(fetch-from-replica hash\)\)\))87 408 Q
(\(when replica-data)92 420 Q(\(storage-put hash replica-data\))97 432 Q
(replica-data\)\)\))97 444 Q(------------------------------------------\
------------------------------------)72 468 Q(References)72 492 Q 2.807
(1. Zstandard)72 516 R 2.807(-F)2.807 G .307
(acebook\342s compression algorithm 2.)-2.957 F .306
(Content-De\214ned Chunking - Restic blog 3.)5.306 F .306
(RFC-018: Sealed)5.306 F(Archi)72 528 Q .3 -.15(ve Fo)-.25 H(rmat 4.).15
E(RFC-020: Content-Addressed Storage)5 E(------------------------------\
------------------------------------------------)72 552 Q(Changelog)72
576 Q 2.5(-2)72 600 S(026-01-07 - Initial draft)-2.5 E(----------------\
--------------------------------------------------------------)72 624 Q
(Implementation Status: Draft Dependencies: cas, zstd, soup Inte)72 648
Q(gration: Storage layer)-.15 E 2.5(,a)-.4 G(rchi)-2.5 E .3 -.15(ve c)
-.25 H(reation, replication).15 E 0 Cg EP
%%Trailer
end
%%EOF
