%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Thu Jan  8 15:17:54 2026
%%DocumentNeededResources: font Times-Roman
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 9
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(RFC-026: Garbage Collection)72 12 Q(Status: Dra\
ft Date: January 2026 Author: Derrell Piper ddp@eludom.net Implementati\
on: Proposed)72 36 Q(--------------------------------------------------\
----------------------------)72 60 Q(Abstract)72 84 Q .609
(This RFC speci\214es g)72 108 R .609
(arbage collection for the Library of Cyberspace: ho)-.05 F 3.109(wv)
-.25 G .608(aults identify and reclaim storage from)-3.359 F .209(unref\
erenced objects while preserving pinned content, respecting tombstones,\
 and maintaining audit trails.)72 120 R(Content-)5.21 E
(addressed storage requires careful GC to a)72 132 Q -.2(vo)-.2 G
(id data loss.).2 E(---------------------------------------------------\
---------------------------)72 156 Q(Moti)72 180 Q -.25(va)-.25 G(tion)
.25 E(Content-addressed storage accumulates objects fore)72 204 Q -.15
(ve)-.25 G 2.5(ru).15 G(nless acti)-2.5 E -.15(ve)-.25 G(ly pruned:).15
E 3.266(-O)72 228 S .766(rphaned objects - No longer referenced by an)
-3.266 F 3.266(yr)-.15 G .766(oot - Superseded v)-3.266 F .766
(ersions - Old v)-.15 F .765(ersions after updates - F)-.15 F(ailed)-.15
E(uploads - P)72 240 Q(artial or abandoned writes - T)-.15 E
(emporary objects - Intermediate computation results)-.7 E
(But deletion is dangerous:)72 264 Q 3.156(-H)72 288 S .656(ash as capa\
bility - Someone may hold the hash - Lazy replication - Remote v)-3.156
F .657(aults may need it later - Audit re-)-.25 F(quirements - May need\
 historical data - Resurrection - Deleted objects may be re-added)72 300
Q(GC must be conserv)72 324 Q(ati)-.25 E .3 -.15(ve a)-.25 H
(nd auditable.).15 E(--------------------------------------------------\
----------------------------)72 348 Q(Object Lifec)72 372 Q(ycle)-.15 E
(States)72 396 Q<e2e2e2e2e2e2e2e2e2e2e2>132 420 Q 10(write \342)107 432
R<e2>22.5 E 2.5<e2e2e2e2e2e2e2e2e2e2ba20e2204c495645>102 444 R<e2>7.5 E
22.5<e2e2>132 456 S<e2e2e2e2e2e2ace2e2e2e2e2>132 468 Q<e2>144.5 480 Q
<e2e2e2e2e2e2e2e2e2e2e2e2bce2e2e2e2e2e2e2e2e2e2e2>117 492 Q 25<e2e2e2>
117 504 S 22.5<e2bc20e2bc20e2bc>117 516 R
<e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2e2e2e2e2e2>104.5
528 Q 2.5(\342PINNED \342)104.5 540 R<e254>2.5 E(OMBST)-.18 E
(ONE\342 \342ORPHANED\342)-.18 E
<e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2ace2e2e2e2e2>
104.5 552 Q<e2>169.5 564 Q 2.5<e247>169.5 576 S(C)-2.5 E<e2bc>169.5 588
Q<e2e2e2e2e2e2e2e2e2e2>157 600 Q(\342COLLECTED\342)157 612 Q
<e2e2e2e2e2e2e2e2e2e2>157 624 Q(State T)72 648 Q(ransitions)-.35 E
(\(de\214ne \(object-state hash\))82 672 Q(\(cond)87 684 Q
(\(\(pinned? hash\) 'pinned\))92 696 Q(\(\(tombstoned? hash\) ')92 708 Q
(tombstone\))-.18 E(\(\(referenced? hash\) ')92 720 Q(li)-.1 E -.15(ve)
-.25 G(\)).15 E(\(else 'orphaned\)\)\))92 732 Q
(\(de\214ne \(can-collect? hash\))82 756 Q
(\(and \(eq? \(object-state hash\) 'orphaned\))87 768 Q
(\(not \(in-grace-period? hash\)\))99.5 780 Q
(\(not \(pending-replication? hash\)\)\)\))99.5 792 Q 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(-----------------------------------------------\
-------------------------------)72 24 Q(Reference Counting)72 48 Q
(Direct References)72 72 Q(;; T)82 96 Q(rack incoming references)-.35 E
(\(de\214ne ref-counts \(mak)82 108 Q(e-hash-table\)\))-.1 E
(\(de\214ne \(add-reference from-hash to-hash\))82 132 Q
(\(let \(\(count \(hash-table-ref ref-counts to-hash 0\)\)\))87 144 Q
(\(hash-table-set! ref-counts to-hash \(+ count 1\)\))92 156 Q
(\(audit-append action: `\(add-ref ,from-hash ,to-hash\)\)\)\))92 168 Q
(\(de\214ne \(remo)82 192 Q -.15(ve)-.15 G
(-reference from-hash to-hash\)).15 E
(\(let \(\(count \(hash-table-ref ref-counts to-hash 0\)\)\))87 204 Q
(\(hash-table-set! ref-counts to-hash \(max 0 \(- count 1\)\)\))92 216 Q
(\(audit-append action: `\(remo)92 228 Q -.15(ve)-.15 G
(-ref ,from-hash ,to-hash\)\)\)\)).15 E
(\(de\214ne \(reference-count hash\))82 252 Q
(\(hash-table-ref ref-counts hash 0\)\))87 264 Q(Root References)72 288
Q(;; GC roots - objects that are al)82 312 Q -.1(wa)-.1 G(ys reachable)
.1 E(\(de\214ne gc-roots \(mak)82 324 Q(e-hash-set\)\))-.1 E
(\(de\214ne \(add-gc-root hash reason\))82 348 Q
(\(hash-set-add! gc-roots hash\))87 360 Q
(\(audit-append action: `\(add-root ,hash ,reason\)\)\))87 372 Q
(\(de\214ne \(remo)82 396 Q -.15(ve)-.15 G(-gc-root hash\)).15 E
(\(hash-set-remo)87 408 Q -.15(ve)-.15 G 2.5(!g).15 G(c-roots hash\))
-2.5 E(\(audit-append action: `\(remo)87 420 Q -.15(ve)-.15 G
(-root ,hash\)\)\)).15 E(\(de\214ne \(gc-root? hash\))82 444 Q
(\(hash-set-member? gc-roots hash\)\))87 456 Q(Implicit Roots)72 480 Q
(;; Some objects are implicitly rooted)82 504 Q
(\(de\214ne \(implicit-root? hash\))82 516 Q(\(or \(pinned? hash\))87
528 Q(\(soup-object-type? hash 'certi\214cate\))97 540 Q 2.5(;C)5 G
(erts are roots)-2.5 E(\(soup-object-type? hash 'audit-entry\))97 552 Q
2.5(;A)5 G(udit is sacred)-2.5 E(\(recent-write? hash\)\)\))97 564 Q 2.5
(;G)42.5 G(race period)-2.5 E(-----------------------------------------\
-------------------------------------)72 588 Q(Mark and Sweep)72 612 Q
(Mark Phase)72 636 Q(\(de\214ne \(mark-reachable\))82 660 Q
("Mark all objects reachable from roots")87 672 Q(\(let \(\(mark)87 684
Q(ed \(mak)-.1 E(e-hash-set\)\)\))-.1 E(\(de\214ne \(mark hash\))92 696
Q(\(unless \(hash-set-member? mark)97 708 Q(ed hash\))-.1 E
(\(hash-set-add! mark)102 720 Q(ed hash\))-.1 E(\(for)102 732 Q
(-each mark \(object-references hash\)\)\)\))-.2 E(;; Mark from e)92 756
Q(xplicit roots)-.15 E(\(for)92 768 Q
(-each mark \(hash-set->list gc-roots\)\))-.2 E
(;; Mark from implicit roots)92 792 Q 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(for)92 12 Q(-each \(lambda \(hash\))-.2 E
(\(when \(implicit-root? hash\))122 24 Q(\(mark hash\)\)\))127 36 Q
(\(all-object-hashes\)\))117 48 Q(mark)92 72 Q(ed\)\))-.1 E(Sweep Phase)
72 96 Q(\(de\214ne \(sweep mark)82 120 Q(ed\))-.1 E("Collect unmark)87
132 Q(ed objects")-.1 E(\(let \(\(collected '\(\)\)\))87 144 Q(\(for)92
156 Q(-each)-.2 E(\(lambda \(hash\))97 168 Q
(\(unless \(hash-set-member? mark)102 180 Q(ed hash\))-.1 E
(\(when \(can-collect? hash\))107 192 Q
(\(set! collected \(cons hash collected\)\))112 204 Q
(\(collect-object! hash\)\)\)\))112 216 Q(\(all-object-hashes\)\))97 228
Q(collected\)\))92 240 Q(\(de\214ne \(collect-object! hash\))82 264 Q
("Remo)87 276 Q .3 -.15(ve o)-.15 H(bject from storage").15 E
(\(let \(\(obj \(cas-get hash\)\)\))87 288 Q(\(audit-append)92 300 Q
(action: 'gc-collect)97 312 Q(hash: hash)97 324 Q
(size: \(object-size obj\))97 336 Q(age: \(object-age obj\)\))97 348 Q
(\(cas-delete! hash\)\)\))92 360 Q(Full GC)72 384 Q
(\(de\214ne \(gc-full\))82 408 Q("Perform full g)87 420 Q
(arbage collection")-.05 E(\(let \(\(start \(current-time\)\)\))87 432 Q
(\(audit-append action: 'gc-start type: 'full\))92 444 Q
(\(let* \(\(mark)92 468 Q(ed \(mark-reachable\)\))-.1 E
(\(collected \(sweep mark)109.5 480 Q(ed\)\)\))-.1 E(\(audit-append)97
504 Q(action: 'gc-complete)102 516 Q(type: 'full)102 528 Q
(duration: \(- \(current-time\) start\))102 540 Q(mark)102 552 Q
(ed: \(hash-set-size mark)-.1 E(ed\))-.1 E
(collected: \(length collected\))102 564 Q
(bytes-freed: \(sum \(map object-size collected\)\)\))102 576 Q
(collected\)\)\))97 600 Q(---------------------------------------------\
---------------------------------)72 624 Q(Incremental GC)72 648 Q
(Generational Collection)72 672 Q(;; Objects partitioned by age)82 696 Q
(\(de\214ne generations)82 708 Q('\(\(young . 86400\))87 720 Q 2.5(;<1d)
15 G(ay)-2.5 E(\(middle . 2592000\))92 732 Q 2.5(;<3)7.5 G 2.5(0d)-2.5 G
(ays)-2.5 E(\(old . #f\)\)\))92 744 Q 2.5(;>)22.5 G 2.5(=3)-2.5 G 2.5
(0d)-2.5 G(ays)-2.5 E(\(de\214ne \(object-generation hash\))82 768 Q
(\(let \(\(age \(object-age hash\)\)\))87 780 Q(\(cond)92 792 Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(\(< age 86400\) 'young\))97 12 Q
(\(\(< age 2592000\) 'middle\))97 24 Q(\(else 'old\)\)\)\))97 36 Q
(\(de\214ne \(gc-generation gen\))82 60 Q
("Collect only speci\214ed generation")87 72 Q
(\(let \(\(candidates \(\214lter \(lambda \(h\))87 84 Q
(\(eq? \(object-generation h\) gen\)\))157 96 Q
(\(all-object-hashes\)\)\)\))152 108 Q(\(gc-candidates candidates\)\)\))
92 120 Q(Write Barrier)72 144 Q(;; T)82 168 Q
(rack modi\214ed objects for incremental GC)-.35 E
(\(de\214ne modi\214ed-set \(mak)82 180 Q(e-hash-set\)\))-.1 E
(\(de\214ne \(cas-put-with-barrier data\))82 204 Q
(\(let \(\(hash \(cas-put data\)\)\))87 216 Q
(\(hash-set-add! modi\214ed-set hash\))92 228 Q(hash\)\))92 240 Q
(\(de\214ne \(gc-incremental\))82 264 Q
("Collect recently modi\214ed objects if orphaned")87 276 Q
(\(let \(\(candidates \(hash-set->list modi\214ed-set\)\)\))87 288 Q
(\(hash-set-clear! modi\214ed-set\))92 300 Q
(\(gc-candidates candidates\)\)\))92 312 Q(Concurrent GC)72 336 Q
(;; GC runs concurrently with mutations)82 360 Q
(\(de\214ne gc-lock \(mak)82 372 Q(e-mute)-.1 E(x\)\))-.15 E
(\(de\214ne gc-running? #f\))82 384 Q(\(de\214ne \(gc-concurrent\))82
408 Q("Run GC without stopping the w)87 420 Q(orld")-.1 E(\(when \(mute)
87 432 Q(x-try-lock! gc-lock\))-.15 E(\(set! gc-running? #t\))92 444 Q
(\(let \(\(snapshot \(snapshot-roots\)\)\))92 456 Q
(;; Mark phase uses snapshot)97 468 Q(\(let \(\(mark)97 480 Q
(ed \(mark-from-snapshot snapshot\)\)\))-.1 E
(;; Sweep only clearly dead objects)102 492 Q(\(sweep-conserv)102 504 Q
(ati)-.25 E .3 -.15(ve m)-.25 H(ark).15 E(ed\)\)\))-.1 E
(\(set! gc-running? #f\))92 516 Q(\(mute)92 528 Q
(x-unlock! gc-lock\)\)\))-.15 E(---------------------------------------\
---------------------------------------)72 552 Q(Pinning)72 576 Q
(Pin Management)72 600 Q(\(de\214ne pins \(mak)82 624 Q
(e-hash-table\)\))-.1 E(\(de\214ne \(pin! hash reason #!k)82 648 Q .3
-.15(ey d)-.1 H(uration\)).15 E("Protect object from GC")87 660 Q
(\(hash-table-set! pins hash)87 672 Q(`\(\(reason . ,reason\))92 684 Q
(\(pinned-at . ,\(current-time\)\))97 696 Q(\(e)97 708 Q
(xpires . ,\(and duration \(+ \(current-time\) duration\)\)\))-.15 E
(\(pinned-by . ,\(current-principal\)\)\)\))97 720 Q
(\(audit-append action: `\(pin ,hash ,reason\)\)\))87 732 Q
(\(de\214ne \(unpin! hash\))82 756 Q("Allo)87 768 Q 2.5(wo)-.25 G
(bject to be collected")-2.5 E(\(hash-table-delete! pins hash\))87 780 Q
(\(audit-append action: `\(unpin ,hash\)\)\))87 792 Q 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(de\214ne \(pinned? hash\))82 24 Q
(\(let \(\(pin \(hash-table-ref pins hash #f\)\)\))87 36 Q(\(and pin)92
48 Q(\(or \(not \(assoc-ref pin 'e)104.5 60 Q(xpires\)\))-.15 E
(\(> \(assoc-ref pin 'e)114.5 72 Q(xpires\) \(current-time\)\)\)\)\)\))
-.15 E -.35(Tr)72 96 S(ansiti).35 E .3 -.15(ve P)-.25 H(inning).15 E
(\(de\214ne \(pin-tree! root-hash reason\))82 120 Q
("Pin object and all objects it references")87 132 Q
(\(let \(\(visited \(mak)87 144 Q(e-hash-set\)\)\))-.1 E
(\(de\214ne \(pin-recursi)92 156 Q .3 -.15(ve h)-.25 H(ash\)).15 E
(\(unless \(hash-set-member? visited hash\))97 168 Q
(\(hash-set-add! visited hash\))102 180 Q(\(pin! hash reason\))102 192 Q
(\(for)102 204 Q(-each pin-recursi)-.2 E .3 -.15(ve \()-.25 H
(object-references hash\)\)\)\)).15 E(\(pin-recursi)92 216 Q .3 -.15
(ve r)-.25 H(oot-hash\)\)\)).15 E(-------------------------------------\
-----------------------------------------)72 240 Q -.8(To)72 264 S
(mbstones).8 E -.8(To)72 288 S(mbstone Handling).8 E(;; T)82 312 Q
(ombstones are ne)-.8 E -.15(ve)-.25 G 2.5(rc).15 G(ollected)-2.5 E
(\(de\214ne \(tombstoned? hash\))82 324 Q
(\(let \(\(obj \(soup-get hash\)\)\))87 336 Q
(\(and obj \(eq? \(soup-object-type obj\) ')92 348 Q(tombstone\)\)\)\))
-.18 E(;; T)82 372 Q(ombstones pre)-.8 E -.15(ve)-.25 G(nt resurrection)
.15 E(\(de\214ne \(cas-put-check)82 384 Q(ed data\))-.1 E
(\(let \(\(hash \(content-hash data\)\)\))87 396 Q
(\(when \(tombstoned? hash\))92 408 Q
(\(error "Cannot resurrect tombstoned object" hash\)\))97 420 Q
(\(cas-put data\)\)\))92 432 Q -.8(To)72 456 S(mbstone Expiry).8 E
(;; Optional: tombstones can e)82 480 Q(xpire)-.15 E
(\(de\214ne \(tombstone-e)82 492 Q(xpired? hash\))-.15 E
(\(let \(\(tomb \(soup-get hash\)\)\))87 504 Q(\(and tomb)92 516 Q
(\(assoc-ref \(soup-object-metadata tomb\) 'e)104.5 528 Q(xpires\))-.15
E(\(< \(assoc-ref \(soup-object-metadata tomb\) 'e)104.5 540 Q(xpires\))
-.15 E(\(current-time\)\)\)\)\))112 552 Q(\(de\214ne \(gc-e)82 576 Q
(xpired-tombstones\))-.15 E("Remo)87 588 Q .3 -.15(ve ex)-.15 H
(pired tombstones").15 E(\(for)87 600 Q(-each)-.2 E(\(lambda \(hash\))92
612 Q(\(when \(and \(tombstoned? hash\) \(tombstone-e)97 624 Q
(xpired? hash\)\))-.15 E(\(collect-object! hash\)\)\))102 636 Q
(\(all-object-hashes\)\)\))92 648 Q(-----------------------------------\
-------------------------------------------)72 672 Q(Grace Periods)72
696 Q(Write Grace Period)72 720 Q
(;; Recently written objects are protected)82 744 Q
(\(de\214ne *write-grace-period* 86400\))82 756 Q 2.5(;2)5 G 2.5(4h)-2.5
G(ours)-2.5 E(\(de\214ne \(recent-write? hash\))82 780 Q
(\(let \(\(obj \(soup-get hash\)\)\))87 792 Q 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(and obj)92 12 Q
(\(< \(- \(current-time\) \(soup-object-created obj\)\))104.5 24 Q
(*write-grace-period*\)\)\)\))112 36 Q(Replication Grace Period)72 60 Q
(;; Objects pending replication are protected)82 84 Q
(\(de\214ne pending-replication \(mak)82 96 Q(e-hash-set\)\))-.1 E
(\(de\214ne \(mark-pending-replication hash v)82 120 Q(aults\))-.25 E
(\(hash-set-add! pending-replication hash\))87 132 Q
(\(audit-append action: `\(pending-replication ,hash ,v)87 144 Q
(aults\)\)\))-.25 E(\(de\214ne \(clear)82 168 Q
(-pending-replication hash\))-.2 E(\(hash-set-remo)87 180 Q -.15(ve)-.15
G 2.5(!p).15 G(ending-replication hash\)\))-2.5 E
(\(de\214ne \(pending-replication? hash\))82 204 Q
(\(hash-set-member? pending-replication hash\)\))87 216 Q(-------------\
-----------------------------------------------------------------)72 240
Q(Distrib)72 264 Q(uted GC)-.2 E(Coordinated Collection)72 288 Q
(;; Multi-v)82 312 Q(ault GC requires coordination)-.25 E
(\(de\214ne \(distrib)82 324 Q(uted-gc v)-.2 E(aults\))-.25 E
("Coordinate GC across v)87 336 Q(ault federation")-.25 E
(;; Phase 1: Gather root sets)87 348 Q(\(let \(\(root-sets \(map v)87
360 Q(ault-roots v)-.25 E(aults\)\)\))-.25 E
(;; Phase 2: Compute global reachability)92 372 Q(\(let \(\(global-mark)
92 384 Q(ed \(union-all root-sets\)\)\))-.1 E
(;; Phase 3: Local sweep \(conserv)97 396 Q(ati)-.25 E -.15(ve)-.25 G
(\)).15 E(\(for)97 408 Q(-each \(lambda \(v)-.2 E(ault\))-.25 E(\(v)127
420 Q(ault-sweep v)-.25 E(ault global-mark)-.25 E(ed\)\))-.1 E -.25(va)
122 432 S(ults\)\)\)\)).25 E(Remote Reference T)72 456 Q(racking)-.35 E
(;; T)82 480 Q(rack references from remote v)-.35 E(aults)-.25 E
(\(de\214ne remote-refs \(mak)82 492 Q(e-hash-table\)\))-.1 E
(\(de\214ne \(add-remote-reference v)82 516 Q(ault-id hash\))-.25 E
(\(let \(\(refs \(hash-table-ref remote-refs hash '\(\)\)\)\))87 528 Q
(\(hash-table-set! remote-refs hash \(cons v)92 540 Q
(ault-id refs\)\)\)\))-.25 E(\(de\214ne \(remo)82 564 Q -.15(ve)-.15 G
(-remote-reference v).15 E(ault-id hash\))-.25 E
(\(let \(\(refs \(hash-table-ref remote-refs hash '\(\)\)\)\))87 576 Q
(\(hash-table-set! remote-refs hash \(delete v)92 588 Q
(ault-id refs\)\)\)\))-.25 E(\(de\214ne \(has-remote-references? hash\))
82 612 Q(\(not \(null? \(hash-table-ref remote-refs hash '\(\)\)\)\)\))
87 624 Q(Lease-Based Collection)72 648 Q(;; Remote v)82 672 Q
(aults lease objects)-.25 E(\(de\214ne leases \(mak)82 684 Q
(e-hash-table\)\))-.1 E(\(de\214ne \(grant-lease hash v)82 708 Q
(ault-id duration\))-.25 E(\(let \(\(e)87 720 Q
(xpires \(+ \(current-time\) duration\)\)\))-.15 E
(\(hash-table-set! leases hash)92 732 Q(\(cons \(cons v)97 744 Q
(ault-id e)-.25 E(xpires\))-.15 E
(\(hash-table-ref leases hash '\(\)\)\)\)\)\))112 756 Q
(\(de\214ne \(lease-acti)82 780 Q -.15(ve)-.25 G 2.5(?h).15 G(ash\))-2.5
E(\(let \(\(hash-leases \(hash-table-ref leases hash '\(\)\)\)\))87 792
Q 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(an)92 12 Q 2.5(y\()-.15 G(lambda \(lease\))
-2.5 E(\(> \(cdr lease\) \(current-time\)\)\))109.5 24 Q
(hash-leases\)\)\))104.5 36 Q(-----------------------------------------\
-------------------------------------)72 60 Q(GC Scheduling)72 84 Q -.35
(Tr)72 108 S(iggers).35 E(;; GC triggered by v)82 132 Q
(arious conditions)-.25 E(\(de\214ne \(should-gc?\))82 144 Q
(\(or \(> \(storage-usage-percent\) 80\))87 156 Q 2.5(;D)15 G
(isk pressure)-2.5 E(\(> \(orphan-estimate\) 10000\))97 168 Q 2.5(;M)
22.5 G(an)-2.5 E 2.5(yo)-.15 G(rphans)-2.5 E
(\(> \(time-since-last-gc\) 86400\)\)\))97 180 Q 2.5(;D)10 G
(aily minimum)-2.5 E(\(de\214ne \(gc-schedule\))82 204 Q
("Run appropriate GC based on conditions")87 216 Q(\(cond)87 228 Q
(\(\(> \(storage-usage-percent\) 95\))92 240 Q 62.5(\(gc-full\)\) ;)97
252 R(Emer)2.5 E(genc)-.18 E(y: full GC)-.15 E
(\(\(> \(storage-usage-percent\) 80\))92 264 Q
(\(gc-generation 'young\)\))97 276 Q 2.5(;P)32.5 G(ressure: young gen)
-2.5 E(\(else)92 288 Q 40(\(gc-incremental\)\)\)\) ;)97 300 R
(Normal: incremental)2.5 E(Background GC)72 324 Q
(\(de\214ne gc-thread #f\))82 348 Q(\(de\214ne \(start-gc-daemon interv)
82 372 Q(al\))-.25 E(\(set! gc-thread)87 384 Q(\(thread-start!)92 396 Q
(\(mak)97 408 Q(e-thread)-.1 E(\(lambda \(\))102 420 Q(\(let loop \(\))
107 432 Q(\(thread-sleep! interv)112 444 Q(al\))-.25 E
(\(when \(should-gc?\))112 456 Q(\(gc-schedule\)\))117 468 Q
(\(loop\)\)\)\)\)\)\))112 480 Q(---------------------------------------\
---------------------------------------)72 504 Q(Safety Mechanisms)72
528 Q(Dry Run)72 552 Q(\(de\214ne \(gc-dry-run\))82 576 Q
("Report what w)87 588 Q(ould be collected without collecting")-.1 E
(\(let* \(\(mark)87 600 Q(ed \(mark-reachable\)\))-.1 E(\(w)104.5 612 Q
(ould-collect \(\214lter \(lambda \(h\))-.1 E
(\(not \(hash-set-member? mark)167 624 Q(ed h\)\)\))-.1 E
(\(all-object-hashes\)\)\)\))162 636 Q(`\(\(w)92 648 Q
(ould-collect . ,\(length w)-.1 E(ould-collect\)\))-.1 E
(\(bytes . ,\(sum \(map object-size w)97 660 Q(ould-collect\)\)\))-.1 E
(\(samples . ,\(tak)97 672 Q 2.5(ew)-.1 G(ould-collect 10\)\)\)\)\))-2.6
E(Collection Log)72 696 Q(;; Ev)82 720 Q
(ery collection is logged with reco)-.15 E -.15(ve)-.15 G(ry info).15 E
(\(de\214ne \(collect-with-log! hash\))82 732 Q
(\(let \(\(obj \(cas-get hash\)\)\))87 744 Q
(;; Log enough to reconstruct if needed)92 756 Q(\(audit-append)92 768 Q
(action: 'gc-collect)97 780 Q(hash: hash)97 792 Q 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(size: \(object-size obj\))97 12 Q
(type: \(soup-object-type obj\))97 24 Q
(references: \(object-references hash\))97 36 Q
(metadata: \(soup-object-metadata obj\)\))97 48 Q
(\(cas-delete! hash\)\)\))92 60 Q(Reco)72 84 Q -.15(ve)-.15 G(ry).15 E
(;; Reco)82 108 Q -.15(ve)-.15 G 2.5(rr).15 G
(ecently collected object from audit log)-2.5 E(\(de\214ne \(gc-reco)82
120 Q -.15(ve)-.15 G 2.5(rh).15 G(ash\))-2.5 E("Attempt to reco)87 132 Q
-.15(ve)-.15 G 2.5(rc).15 G(ollected object")-2.5 E
(\(let \(\(entry \(\214nd \(lambda \(e\))87 144 Q
(\(and \(eq? \(audit-action e\) 'gc-collect\))139.5 156 Q
(\(equal? \(audit-hash e\) hash\)\)\))152 168 Q
(\(recent-audit-entries\)\)\)\))134.5 180 Q(\(if entry)92 192 Q
(\(error "Object collected, metadata preserv)102 204 Q(ed in audit")-.15
E(\(audit-metadata entry\)\))119.5 216 Q
(\(error "Object not found in recent collections"\)\)\)\))102 228 Q(---\
-----------------------------------------------------------------------\
----)72 252 Q(Metrics)72 276 Q(GC Statistics)72 300 Q
(\(de\214ne gc-stats)82 324 Q(`\(\(collections . 0\))87 336 Q
(\(bytes-freed . 0\))92 348 Q(\(objects-freed . 0\))92 360 Q
(\(total-time . 0\))92 372 Q(\(last-gc . #f\)\)\))92 384 Q
(\(de\214ne \(update-gc-stats collected duration\))82 408 Q
(\(set! gc-stats)87 420 Q
(`\(\(collections . ,\(+ 1 \(assoc-ref gc-stats 'collections\)\)\))92
432 Q(\(bytes-freed . ,\(+ \(sum \(map object-size collected\)\))97 444
Q(\(assoc-ref gc-stats 'bytes-freed\)\)\))144.5 456 Q
(\(objects-freed . ,\(+ \(length collected\))97 468 Q
(\(assoc-ref gc-stats 'objects-freed\)\)\))149.5 480 Q
(\(total-time . ,\(+ duration \(assoc-ref gc-stats ')97 492 Q
(total-time\)\)\))-.18 E(\(last-gc . ,\(current-time\)\)\)\)\))97 504 Q
(Monitoring)72 528 Q(;; Expose GC metrics)82 552 Q
(\(de\214ne \(gc-metrics\))82 564 Q
(`\(\(storage-used . ,\(storage-used\)\))87 576 Q
(\(storage-total . ,\(storage-total\)\))92 588 Q
(\(object-count . ,\(object-count\)\))92 600 Q
(\(orphan-estimate . ,\(orphan-estimate\)\))92 612 Q
(\(pinned-count . ,\(hash-table-size pins\)\))92 624 Q
(\(gc-stats . ,gc-stats\)\)\))92 636 Q(--------------------------------\
----------------------------------------------)72 660 Q
(Security Considerations)72 684 Q(GC as Side Channel)72 708 Q
(;; GC timing can leak information about object references)82 732 Q
(;; Use constant-time operations where possible)82 744 Q
(\(de\214ne \(constant-time-mark hash\))82 756 Q
(\(let \(\(refs \(object-references hash\)\)\))87 768 Q(;; Al)92 780 Q
-.1(wa)-.1 G(ys process same number of refs).1 E(\(for)92 792 Q
(-each mark \(pad-list refs *max-refs*\)\)\)\))-.2 E 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Denial of Service)72 24 Q(;; Pre)82 48 Q -.15
(ve)-.25 G(nt GC starv).15 E(ation attacks)-.25 E
(\(de\214ne *max-pins-per)82 60 Q(-principal* 10000\))-.2 E
(\(de\214ne \(pin-with-limit! hash reason\))82 84 Q
(\(let \(\(count \(principal-pin-count \(current-principal\)\)\)\))87 96
Q(\(when \(> count *max-pins-per)92 108 Q(-principal*\))-.2 E
(\(error "Pin limit e)97 120 Q(xceeded"\)\))-.15 E
(\(pin! hash reason\)\)\))92 132 Q(------------------------------------\
------------------------------------------)72 156 Q(References)72 180 Q
2.746(1. The)72 204 R .245
(Garbage Collection Handbook - Jones, Hosking, Moss 2.)2.746 F .245
(On-the-Fly Garbage Collection - Dijkstra et al.)5.245 F(3.)5.245 E
(RFC-020: Content-Addressed Storage 4.)72 216 Q
(RFC-003: Cryptographic Audit T)5 E(rail)-.35 E(-----------------------\
-------------------------------------------------------)72 240 Q
(Changelog)72 264 Q 2.5(-2)72 288 S(026-01-07 - Initial draft)-2.5 E(--\
-----------------------------------------------------------------------\
-----)72 312 Q 1.603
(Implementation Status: Draft Dependencies: cas, soup, audit Inte)72 336
R 1.603(gration: Storage management, replication, v)-.15 F(ault)-.25 E
(maintenance)72 348 Q 0 Cg EP
%%Trailer
end
%%EOF
