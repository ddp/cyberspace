%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Fri Jan  9 11:49:19 2026
%%DocumentNeededResources: font Times-Roman
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 9
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(RFC-026: Garbage Collection)72 12 Q(Status: Dra\
ft Date: January 2026 Author: Derrell Piper <ddp@eludom.net> Implementa\
tion: Proposed)72 36 Q(------------------------------------------------\
------------------------------)72 60 Q(Abstract)72 84 Q .609
(This RFC speci\214es g)72 108 R .609
(arbage collection for the Library of Cyberspace: ho)-.05 F 3.109(wv)
-.25 G .608(aults identify and reclaim storage from)-3.359 F .417(unref\
erenced objects while preserving pinned content, respecting tombstones,\
 and maintaining audit trails. Content-)72 120 R
(addressed storage requires careful GC to a)72 132 Q -.2(vo)-.2 G
(id data loss.).2 E(---------------------------------------------------\
---------------------------)72 156 Q(Moti)72 180 Q -.25(va)-.25 G(tion)
.25 E(Content-addressed storage accumulates objects fore)72 204 Q -.15
(ve)-.25 G 2.5(ru).15 G(nless acti)-2.5 E -.15(ve)-.25 G(ly pruned:).15
E 3.266(-O)72 228 S .766(rphaned objects - No longer referenced by an)
-3.266 F 3.266(yr)-.15 G .766(oot - Superseded v)-3.266 F .766
(ersions - Old v)-.15 F .765(ersions after updates - F)-.15 F(ailed)-.15
E(uploads - P)72 240 Q(artial or abandoned writes - T)-.15 E
(emporary objects - Intermediate computation results)-.7 E
(But deletion is dangerous:)72 264 Q 3.156(-H)72 288 S .656(ash as capa\
bility - Someone may hold the hash - Lazy replication - Remote v)-3.156
F .657(aults may need it later - Audit re-)-.25 F(quirements - May need\
 historical data - Resurrection - Deleted objects may be re-added)72 300
Q(GC must be conserv)72 324 Q(ati)-.25 E .3 -.15(ve a)-.25 H
(nd auditable.).15 E(--------------------------------------------------\
----------------------------)72 348 Q(Object Lifec)72 372 Q(ycle)-.15 E
(States)72 396 Q(`)72 420 Q<e2e2e2e2e2e2e2e2e2e2e2>122 432 Q 10
(write \342)97 444 R<e2>22.5 E 2.5<e2e2e2e2e2e2e2e2e2e2ba20e2204c495645>
92 456 R<e2>7.5 E 22.5<e2e2>122 468 S<e2e2e2e2e2e2ace2e2e2e2e2>122 480 Q
<e2>134.5 492 Q<e2e2e2e2e2e2e2e2e2e2e2e2bce2e2e2e2e2e2e2e2e2e2e2>107 504
Q 25<e2e2e2>107 516 S 22.5<e2bc20e2bc20e2bc>107 528 R
<e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2e2e2e2e2e2>94.5
540 Q 2.5(\342PINNED \342)94.5 552 R<e254>2.5 E(OMBST)-.18 E
(ONE\342 \342ORPHANED\342)-.18 E
<e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2e2e2e2e2e220e2e2e2e2e2ace2e2e2e2e2>94.5
564 Q<e2>159.5 576 Q 2.5<e247>159.5 588 S(C)-2.5 E<e2bc>159.5 600 Q
<e2e2e2e2e2e2e2e2e2e2>147 612 Q(\342COLLECTED\342)147 624 Q
<e2e2e2e2e2e2e2e2e2e22060>147 636 Q(State T)72 660 Q(ransitions)-.35 E
(`scheme \(de\214ne \(object-state hash\))72 684 Q(\(cond)77 696 Q
(\(\(pinned? hash\) 'pinned\))82 708 Q(\(\(tombstoned? hash\) ')82 720 Q
(tombstone\))-.18 E(\(\(referenced? hash\) ')82 732 Q(li)-.1 E -.15(ve)
-.25 G(\)).15 E(\(else 'orphaned\)\)\))82 744 Q
(\(de\214ne \(can-collect? hash\))72 768 Q
(\(and \(eq? \(object-state hash\) 'orphaned\))77 780 Q
(\(not \(in-grace-period? hash\)\))89.5 792 Q 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(not \(pending-replication? hash\)\)\)\) `)89.5
12 Q(------------------------------------------------------------------\
------------)72 36 Q(Reference Counting)72 60 Q(Direct References)72 84
Q(`scheme ;; T)72 108 Q
(rack incoming references \(de\214ne ref-counts \(mak)-.35 E
(e-hash-table\)\))-.1 E(\(de\214ne \(add-reference from-hash to-hash\))
72 132 Q(\(let \(\(count \(hash-table-ref ref-counts to-hash 0\)\)\))77
144 Q(\(hash-table-set! ref-counts to-hash \(+ count 1\)\))82 156 Q
(\(audit-append action: `\(add-ref ,from-hash ,to-hash\)\)\)\))82 168 Q
(\(de\214ne \(remo)72 192 Q -.15(ve)-.15 G
(-reference from-hash to-hash\)).15 E
(\(let \(\(count \(hash-table-ref ref-counts to-hash 0\)\)\))77 204 Q
(\(hash-table-set! ref-counts to-hash \(max 0 \(- count 1\)\)\))82 216 Q
(\(audit-append action: `\(remo)82 228 Q -.15(ve)-.15 G
(-ref ,from-hash ,to-hash\)\)\)\)).15 E
(\(de\214ne \(reference-count hash\))72 252 Q
(\(hash-table-ref ref-counts hash 0\)\) `)77 264 Q(Root References)72
288 Q(`scheme ;; GC roots - objects that are al)72 312 Q -.1(wa)-.1 G
(ys reachable \(de\214ne gc-roots \(mak).1 E(e-hash-set\)\))-.1 E
(\(de\214ne \(add-gc-root hash reason\))72 336 Q
(\(hash-set-add! gc-roots hash\))77 348 Q
(\(audit-append action: `\(add-root ,hash ,reason\)\)\))77 360 Q
(\(de\214ne \(remo)72 384 Q -.15(ve)-.15 G(-gc-root hash\)).15 E
(\(hash-set-remo)77 396 Q -.15(ve)-.15 G 2.5(!g).15 G(c-roots hash\))
-2.5 E(\(audit-append action: `\(remo)77 408 Q -.15(ve)-.15 G
(-root ,hash\)\)\)).15 E(\(de\214ne \(gc-root? hash\))72 432 Q
(\(hash-set-member? gc-roots hash\)\) `)77 444 Q(Implicit Roots)72 468 Q
(`scheme ;; Some objects are implicitly rooted \(de\214ne \(implicit-ro\
ot? hash\))72 492 Q(\(or \(pinned? hash\))77 504 Q
(\(soup-object-type? hash 'certi\214cate\))87 516 Q 2.5(;C)5 G
(erts are roots)-2.5 E(\(soup-object-type? hash 'audit-entry\))87 528 Q
2.5(;A)5 G(udit is sacred)-2.5 E(\(recent-write? hash\)\)\))87 540 Q 2.5
(;G)42.5 G(race period `)-2.5 E(---------------------------------------\
---------------------------------------)72 564 Q(Mark and Sweep)72 588 Q
(Mark Phase)72 612 Q(`scheme \(de\214ne \(mark-reachable\))72 636 Q
("Mark all objects reachable from roots")77 648 Q(\(let \(\(mark)77 660
Q(ed \(mak)-.1 E(e-hash-set\)\)\))-.1 E(\(de\214ne \(mark hash\))82 672
Q(\(unless \(hash-set-member? mark)87 684 Q(ed hash\))-.1 E
(\(hash-set-add! mark)92 696 Q(ed hash\))-.1 E(\(for)92 708 Q
(-each mark \(object-references hash\)\)\)\))-.2 E(;; Mark from e)82 732
Q(xplicit roots)-.15 E(\(for)82 744 Q
(-each mark \(hash-set->list gc-roots\)\))-.2 E
(;; Mark from implicit roots)82 768 Q(\(for)82 780 Q
(-each \(lambda \(hash\))-.2 E(\(when \(implicit-root? hash\))112 792 Q
0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(mark hash\)\)\))117 12 Q
(\(all-object-hashes\)\))107 24 Q(mark)82 48 Q(ed\)\) `)-.1 E
(Sweep Phase)72 72 Q(`scheme \(de\214ne \(sweep mark)72 96 Q(ed\))-.1 E
("Collect unmark)77 108 Q(ed objects")-.1 E
(\(let \(\(collected '\(\)\)\))77 120 Q(\(for)82 132 Q(-each)-.2 E
(\(lambda \(hash\))87 144 Q(\(unless \(hash-set-member? mark)92 156 Q
(ed hash\))-.1 E(\(when \(can-collect? hash\))97 168 Q
(\(set! collected \(cons hash collected\)\))102 180 Q
(\(collect-object! hash\)\)\)\))102 192 Q(\(all-object-hashes\)\))87 204
Q(collected\)\))82 216 Q(\(de\214ne \(collect-object! hash\))72 240 Q
("Remo)77 252 Q .3 -.15(ve o)-.15 H(bject from storage").15 E
(\(let \(\(obj \(cas-get hash\)\)\))77 264 Q(\(audit-append)82 276 Q
(action: 'gc-collect)87 288 Q(hash: hash)87 300 Q
(size: \(object-size obj\))87 312 Q(age: \(object-age obj\)\))87 324 Q
(\(cas-delete! hash\)\)\) `)82 336 Q(Full GC)72 360 Q
(`scheme \(de\214ne \(gc-full\))72 384 Q("Perform full g)77 396 Q
(arbage collection")-.05 E(\(let \(\(start \(current-time\)\)\))77 408 Q
(\(audit-append action: 'gc-start type: 'full\))82 420 Q
(\(let* \(\(mark)82 444 Q(ed \(mark-reachable\)\))-.1 E
(\(collected \(sweep mark)99.5 456 Q(ed\)\)\))-.1 E(\(audit-append)87
480 Q(action: 'gc-complete)92 492 Q(type: 'full)92 504 Q
(duration: \(- \(current-time\) start\))92 516 Q(mark)92 528 Q
(ed: \(hash-set-size mark)-.1 E(ed\))-.1 E
(collected: \(length collected\))92 540 Q
(bytes-freed: \(sum \(map object-size collected\)\)\))92 552 Q
(collected\)\)\) `)87 576 Q(-------------------------------------------\
-----------------------------------)72 600 Q(Incremental GC)72 624 Q
(Generational Collection)72 648 Q
(`scheme ;; Objects partitioned by age \(de\214ne generations)72 672 Q
('\(\(young . 86400\))77 684 Q 2.5(;<1d)15 G(ay)-2.5 E
(\(middle . 2592000\))82 696 Q 2.5(;<3)7.5 G 2.5(0d)-2.5 G(ays)-2.5 E
(\(old . #f\)\)\))82 708 Q 2.5(;>)22.5 G 2.5(=3)-2.5 G 2.5(0d)-2.5 G
(ays)-2.5 E(\(de\214ne \(object-generation hash\))72 732 Q
(\(let \(\(age \(object-age hash\)\)\))77 744 Q(\(cond)82 756 Q
(\(\(< age 86400\) 'young\))87 768 Q(\(\(< age 2592000\) 'middle\))87
780 Q(\(else 'old\)\)\)\))87 792 Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(de\214ne \(gc-generation gen\))72 24 Q
("Collect only speci\214ed generation")77 36 Q
(\(let \(\(candidates \(\214lter \(lambda \(h\))77 48 Q
(\(eq? \(object-generation h\) gen\)\))147 60 Q
(\(all-object-hashes\)\)\)\))142 72 Q
(\(gc-candidates candidates\)\)\) `)82 84 Q(Write Barrier)72 108 Q
(`scheme ;; T)72 132 Q(rack modi\214ed objects for incremental GC \(de\
\214ne modi\214ed-set \(mak)-.35 E(e-hash-set\)\))-.1 E
(\(de\214ne \(cas-put-with-barrier data\))72 156 Q
(\(let \(\(hash \(cas-put data\)\)\))77 168 Q
(\(hash-set-add! modi\214ed-set hash\))82 180 Q(hash\)\))82 192 Q
(\(de\214ne \(gc-incremental\))72 216 Q
("Collect recently modi\214ed objects if orphaned")77 228 Q
(\(let \(\(candidates \(hash-set->list modi\214ed-set\)\)\))77 240 Q
(\(hash-set-clear! modi\214ed-set\))82 252 Q
(\(gc-candidates candidates\)\)\) `)82 264 Q(Concurrent GC)72 288 Q(`sc\
heme ;; GC runs concurrently with mutations \(de\214ne gc-lock \(mak)72
312 Q(e-mute)-.1 E(x\)\) \(de\214ne gc-running? #f\))-.15 E
(\(de\214ne \(gc-concurrent\))72 336 Q("Run GC without stopping the w)77
348 Q(orld")-.1 E(\(when \(mute)77 360 Q(x-try-lock! gc-lock\))-.15 E
(\(set! gc-running? #t\))82 372 Q
(\(let \(\(snapshot \(snapshot-roots\)\)\))82 384 Q
(;; Mark phase uses snapshot)87 396 Q(\(let \(\(mark)87 408 Q
(ed \(mark-from-snapshot snapshot\)\)\))-.1 E
(;; Sweep only clearly dead objects)92 420 Q(\(sweep-conserv)92 432 Q
(ati)-.25 E .3 -.15(ve m)-.25 H(ark).15 E(ed\)\)\))-.1 E
(\(set! gc-running? #f\))82 444 Q(\(mute)82 456 Q
(x-unlock! gc-lock\)\)\) `)-.15 E(-------------------------------------\
-----------------------------------------)72 480 Q(Pinning)72 504 Q
(Pin Management)72 528 Q(`scheme \(de\214ne pins \(mak)72 552 Q
(e-hash-table\)\))-.1 E(\(de\214ne \(pin! hash reason #!k)72 576 Q .3
-.15(ey d)-.1 H(uration\)).15 E("Protect object from GC")77 588 Q
(\(hash-table-set! pins hash)77 600 Q(`\(\(reason . ,reason\))82 612 Q
(\(pinned-at . ,\(current-time\)\))87 624 Q(\(e)87 636 Q
(xpires . ,\(and duration \(+ \(current-time\) duration\)\)\))-.15 E
(\(pinned-by . ,\(current-principal\)\)\)\))87 648 Q
(\(audit-append action: `\(pin ,hash ,reason\)\)\))77 660 Q
(\(de\214ne \(unpin! hash\))72 684 Q("Allo)77 696 Q 2.5(wo)-.25 G
(bject to be collected")-2.5 E(\(hash-table-delete! pins hash\))77 708 Q
(\(audit-append action: `\(unpin ,hash\)\)\))77 720 Q
(\(de\214ne \(pinned? hash\))72 744 Q
(\(let \(\(pin \(hash-table-ref pins hash #f\)\)\))77 756 Q(\(and pin)82
768 Q(\(or \(not \(assoc-ref pin 'e)94.5 780 Q(xpires\)\))-.15 E
(\(> \(assoc-ref pin 'e)104.5 792 Q
(xpires\) \(current-time\)\)\)\)\)\) `)-.15 E 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF -.35(Tr)72 24 S(ansiti).35 E .3 -.15(ve P)-.25 H
(inning).15 E(`scheme \(de\214ne \(pin-tree! root-hash reason\))72 48 Q
("Pin object and all objects it references")77 60 Q
(\(let \(\(visited \(mak)77 72 Q(e-hash-set\)\)\))-.1 E
(\(de\214ne \(pin-recursi)82 84 Q .3 -.15(ve h)-.25 H(ash\)).15 E
(\(unless \(hash-set-member? visited hash\))87 96 Q
(\(hash-set-add! visited hash\))92 108 Q(\(pin! hash reason\))92 120 Q
(\(for)92 132 Q(-each pin-recursi)-.2 E .3 -.15(ve \()-.25 H
(object-references hash\)\)\)\)).15 E(\(pin-recursi)82 144 Q .3 -.15
(ve r)-.25 H(oot-hash\)\)\) `).15 E(-----------------------------------\
-------------------------------------------)72 168 Q -.8(To)72 192 S
(mbstones).8 E -.8(To)72 216 S(mbstone Handling).8 E(`scheme ;; T)72 240
Q(ombstones are ne)-.8 E -.15(ve)-.25 G 2.5(rc).15 G
(ollected \(de\214ne \(tombstoned? hash\))-2.5 E
(\(let \(\(obj \(soup-get hash\)\)\))77 252 Q
(\(and obj \(eq? \(soup-object-type obj\) ')82 264 Q(tombstone\)\)\)\))
-.18 E(;; T)72 288 Q(ombstones pre)-.8 E -.15(ve)-.25 G
(nt resurrection \(de\214ne \(cas-put-check).15 E(ed data\))-.1 E
(\(let \(\(hash \(content-hash data\)\)\))77 300 Q
(\(when \(tombstoned? hash\))82 312 Q
(\(error "Cannot resurrect tombstoned object" hash\)\))87 324 Q
(\(cas-put data\)\)\) `)82 336 Q -.8(To)72 360 S(mbstone Expiry).8 E
(`scheme ;; Optional: tombstones can e)72 384 Q
(xpire \(de\214ne \(tombstone-e)-.15 E(xpired? hash\))-.15 E
(\(let \(\(tomb \(soup-get hash\)\)\))77 396 Q(\(and tomb)82 408 Q
(\(assoc-ref \(soup-object-metadata tomb\) 'e)94.5 420 Q(xpires\))-.15 E
(\(< \(assoc-ref \(soup-object-metadata tomb\) 'e)94.5 432 Q(xpires\))
-.15 E(\(current-time\)\)\)\)\))102 444 Q(\(de\214ne \(gc-e)72 468 Q
(xpired-tombstones\))-.15 E("Remo)77 480 Q .3 -.15(ve ex)-.15 H
(pired tombstones").15 E(\(for)77 492 Q(-each)-.2 E(\(lambda \(hash\))82
504 Q(\(when \(and \(tombstoned? hash\) \(tombstone-e)87 516 Q
(xpired? hash\)\))-.15 E(\(collect-object! hash\)\)\))92 528 Q
(\(all-object-hashes\)\)\) `)82 540 Q(---------------------------------\
---------------------------------------------)72 564 Q(Grace Periods)72
588 Q(Write Grace Period)72 612 Q(`scheme ;; Recently written objects a\
re protected \(de\214ne write-grace-period 86400\))72 636 Q 2.5(;2)5 G
2.5(4h)-2.5 G(ours)-2.5 E(\(de\214ne \(recent-write? hash\))72 660 Q
(\(let \(\(obj \(soup-get hash\)\)\))77 672 Q(\(and obj)82 684 Q
(\(< \(- \(current-time\) \(soup-object-created obj\)\))94.5 696 Q
(write-grace-period\)\)\)\) `)102 708 Q(Replication Grace Period)72 732
Q(`scheme ;; Objects pending replication are protected \(de\214ne pendi\
ng-replication \(mak)72 756 Q(e-hash-set\)\))-.1 E
(\(de\214ne \(mark-pending-replication hash v)72 780 Q(aults\))-.25 E
(\(hash-set-add! pending-replication hash\))77 792 Q 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF
(\(audit-append action: `\(pending-replication ,hash ,v)77 12 Q
(aults\)\)\))-.25 E(\(de\214ne \(clear)72 36 Q
(-pending-replication hash\))-.2 E(\(hash-set-remo)77 48 Q -.15(ve)-.15
G 2.5(!p).15 G(ending-replication hash\)\))-2.5 E
(\(de\214ne \(pending-replication? hash\))72 72 Q
(\(hash-set-member? pending-replication hash\)\) `)77 84 Q(------------\
------------------------------------------------------------------)72
108 Q(Distrib)72 132 Q(uted GC)-.2 E(Coordinated Collection)72 156 Q
(`scheme ;; Multi-v)72 180 Q
(ault GC requires coordination \(de\214ne \(distrib)-.25 E(uted-gc v)-.2
E(aults\))-.25 E("Coordinate GC across v)77 192 Q(ault federation")-.25
E(;; Phase 1: Gather root sets)77 204 Q(\(let \(\(root-sets \(map v)77
216 Q(ault-roots v)-.25 E(aults\)\)\))-.25 E
(;; Phase 2: Compute global reachability)82 228 Q(\(let \(\(global-mark)
82 240 Q(ed \(union-all root-sets\)\)\))-.1 E
(;; Phase 3: Local sweep \(conserv)87 252 Q(ati)-.25 E -.15(ve)-.25 G
(\)).15 E(\(for)87 264 Q(-each \(lambda \(v)-.2 E(ault\))-.25 E(\(v)117
276 Q(ault-sweep v)-.25 E(ault global-mark)-.25 E(ed\)\))-.1 E -.25(va)
112 288 S(ults\)\)\)\) `).25 E(Remote Reference T)72 312 Q(racking)-.35
E(`scheme ;; T)72 336 Q(rack references from remote v)-.35 E
(aults \(de\214ne remote-refs \(mak)-.25 E(e-hash-table\)\))-.1 E
(\(de\214ne \(add-remote-reference v)72 360 Q(ault-id hash\))-.25 E
(\(let \(\(refs \(hash-table-ref remote-refs hash '\(\)\)\)\))77 372 Q
(\(hash-table-set! remote-refs hash \(cons v)82 384 Q
(ault-id refs\)\)\)\))-.25 E(\(de\214ne \(remo)72 408 Q -.15(ve)-.15 G
(-remote-reference v).15 E(ault-id hash\))-.25 E
(\(let \(\(refs \(hash-table-ref remote-refs hash '\(\)\)\)\))77 420 Q
(\(hash-table-set! remote-refs hash \(delete v)82 432 Q
(ault-id refs\)\)\)\))-.25 E(\(de\214ne \(has-remote-references? hash\))
72 456 Q
(\(not \(null? \(hash-table-ref remote-refs hash '\(\)\)\)\)\) `)77 468
Q(Lease-Based Collection)72 492 Q(`scheme ;; Remote v)72 516 Q
(aults lease objects \(de\214ne leases \(mak)-.25 E(e-hash-table\)\))-.1
E(\(de\214ne \(grant-lease hash v)72 540 Q(ault-id duration\))-.25 E
(\(let \(\(e)77 552 Q(xpires \(+ \(current-time\) duration\)\)\))-.15 E
(\(hash-table-set! leases hash)82 564 Q(\(cons \(cons v)87 576 Q
(ault-id e)-.25 E(xpires\))-.15 E
(\(hash-table-ref leases hash '\(\)\)\)\)\)\))102 588 Q
(\(de\214ne \(lease-acti)72 612 Q -.15(ve)-.25 G 2.5(?h).15 G(ash\))-2.5
E(\(let \(\(hash-leases \(hash-table-ref leases hash '\(\)\)\)\))77 624
Q(\(an)82 636 Q 2.5(y\()-.15 G(lambda \(lease\))-2.5 E
(\(> \(cdr lease\) \(current-time\)\)\))99.5 648 Q(hash-leases\)\)\) `)
94.5 660 Q(------------------------------------------------------------\
------------------)72 684 Q(GC Scheduling)72 708 Q -.35(Tr)72 732 S
(iggers).35 E(`scheme ;; GC triggered by v)72 756 Q
(arious conditions \(de\214ne \(should-gc?\))-.25 E
(\(or \(> \(storage-usage-percent\) 80\))77 768 Q 2.5(;D)15 G
(isk pressure)-2.5 E(\(> \(orphan-estimate\) 10000\))87 780 Q 2.5(;M)
22.5 G(an)-2.5 E 2.5(yo)-.15 G(rphans)-2.5 E
(\(> \(time-since-last-gc\) 86400\)\)\))87 792 Q 2.5(;D)10 G
(aily minimum)-2.5 E 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(de\214ne \(gc-schedule\))72 24 Q
("Run appropriate GC based on conditions")77 36 Q(\(cond)77 48 Q
(\(\(> \(storage-usage-percent\) 95\))82 60 Q 62.5(\(gc-full\)\) ;)87 72
R(Emer)2.5 E(genc)-.18 E(y: full GC)-.15 E
(\(\(> \(storage-usage-percent\) 80\))82 84 Q
(\(gc-generation 'young\)\))87 96 Q 2.5(;P)32.5 G(ressure: young gen)
-2.5 E(\(else)82 108 Q 40(\(gc-incremental\)\)\)\) ;)87 120 R
(Normal: incremental `)2.5 E(Background GC)72 144 Q
(`scheme \(de\214ne gc-thread #f\))72 168 Q
(\(de\214ne \(start-gc-daemon interv)72 192 Q(al\))-.25 E
(\(set! gc-thread)77 204 Q(\(thread-start!)82 216 Q(\(mak)87 228 Q
(e-thread)-.1 E(\(lambda \(\))92 240 Q(\(let loop \(\))97 252 Q
(\(thread-sleep! interv)102 264 Q(al\))-.25 E(\(when \(should-gc?\))102
276 Q(\(gc-schedule\)\))107 288 Q(\(loop\)\)\)\)\)\)\) `)102 300 Q(----\
-----------------------------------------------------------------------\
---)72 324 Q(Safety Mechanisms)72 348 Q(Dry Run)72 372 Q
(`scheme \(de\214ne \(gc-dry-run\))72 396 Q("Report what w)77 408 Q
(ould be collected without collecting")-.1 E(\(let* \(\(mark)77 420 Q
(ed \(mark-reachable\)\))-.1 E(\(w)94.5 432 Q
(ould-collect \(\214lter \(lambda \(h\))-.1 E
(\(not \(hash-set-member? mark)157 444 Q(ed h\)\)\))-.1 E
(\(all-object-hashes\)\)\)\))152 456 Q(`\(\(w)82 468 Q
(ould-collect . ,\(length w)-.1 E(ould-collect\)\))-.1 E
(\(bytes . ,\(sum \(map object-size w)87 480 Q(ould-collect\)\)\))-.1 E
(\(samples . ,\(tak)87 492 Q 2.5(ew)-.1 G(ould-collect 10\)\)\)\)\) `)
-2.6 E(Collection Log)72 516 Q(`scheme ;; Ev)72 540 Q
(ery collection is logged with reco)-.15 E -.15(ve)-.15 G
(ry info \(de\214ne \(collect-with-log! hash\)).15 E
(\(let \(\(obj \(cas-get hash\)\)\))77 552 Q
(;; Log enough to reconstruct if needed)82 564 Q(\(audit-append)82 576 Q
(action: 'gc-collect)87 588 Q(hash: hash)87 600 Q
(size: \(object-size obj\))87 612 Q(type: \(soup-object-type obj\))87
624 Q(references: \(object-references hash\))87 636 Q
(metadata: \(soup-object-metadata obj\)\))87 648 Q
(\(cas-delete! hash\)\)\) `)82 660 Q(Reco)72 684 Q -.15(ve)-.15 G(ry).15
E(`scheme ;; Reco)72 708 Q -.15(ve)-.15 G 2.5(rr).15 G
(ecently collected object from audit log \(de\214ne \(gc-reco)-2.5 E
-.15(ve)-.15 G 2.5(rh).15 G(ash\))-2.5 E("Attempt to reco)77 720 Q -.15
(ve)-.15 G 2.5(rc).15 G(ollected object")-2.5 E
(\(let \(\(entry \(\214nd \(lambda \(e\))77 732 Q
(\(and \(eq? \(audit-action e\) 'gc-collect\))129.5 744 Q
(\(equal? \(audit-hash e\) hash\)\)\))142 756 Q
(\(recent-audit-entries\)\)\)\))124.5 768 Q(\(if entry)82 780 Q
(\(error "Object collected, metadata preserv)92 792 Q(ed in audit")-.15
E 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(audit-metadata entry\)\))109.5 12 Q
(\(error "Object not found in recent collections"\)\)\)\) `)92 24 Q(---\
-----------------------------------------------------------------------\
----)72 48 Q(Metrics)72 72 Q(GC Statistics)72 96 Q
(`scheme \(de\214ne gc-stats)72 120 Q(`\(\(collections . 0\))77 132 Q
(\(bytes-freed . 0\))82 144 Q(\(objects-freed . 0\))82 156 Q
(\(total-time . 0\))82 168 Q(\(last-gc . #f\)\)\))82 180 Q
(\(de\214ne \(update-gc-stats collected duration\))72 204 Q
(\(set! gc-stats)77 216 Q
(`\(\(collections . ,\(+ 1 \(assoc-ref gc-stats 'collections\)\)\))82
228 Q(\(bytes-freed . ,\(+ \(sum \(map object-size collected\)\))87 240
Q(\(assoc-ref gc-stats 'bytes-freed\)\)\))134.5 252 Q
(\(objects-freed . ,\(+ \(length collected\))87 264 Q
(\(assoc-ref gc-stats 'objects-freed\)\)\))139.5 276 Q
(\(total-time . ,\(+ duration \(assoc-ref gc-stats ')87 288 Q
(total-time\)\)\))-.18 E(\(last-gc . ,\(current-time\)\)\)\)\) `)87 300
Q(Monitoring)72 324 Q
(`scheme ;; Expose GC metrics \(de\214ne \(gc-metrics\))72 348 Q
(`\(\(storage-used . ,\(storage-used\)\))77 360 Q
(\(storage-total . ,\(storage-total\)\))82 372 Q
(\(object-count . ,\(object-count\)\))82 384 Q
(\(orphan-estimate . ,\(orphan-estimate\)\))82 396 Q
(\(pinned-count . ,\(hash-table-size pins\)\))82 408 Q
(\(gc-stats . ,gc-stats\)\)\) `)82 420 Q(------------------------------\
------------------------------------------------)72 444 Q
(Security Considerations)72 468 Q(GC as Side Channel)72 492 Q .779(`sch\
eme ;; GC timing can leak information about object references ;; Use co\
nstant-time operations where possible)72 516 R
(\(de\214ne \(constant-time-mark hash\))72 528 Q
(\(let \(\(refs \(object-references hash\)\)\))77 540 Q(;; Al)82 552 Q
-.1(wa)-.1 G(ys process same number of refs).1 E(\(for)82 564 Q
(-each mark \(pad-list refs max-refs\)\)\)\) `)-.2 E(Denial of Service)
72 588 Q(`scheme ;; Pre)72 612 Q -.15(ve)-.25 G(nt GC starv).15 E
(ation attacks \(de\214ne max-pins-per)-.25 E(-principal 10000\))-.2 E
(\(de\214ne \(pin-with-limit! hash reason\))72 636 Q
(\(let \(\(count \(principal-pin-count \(current-principal\)\)\)\))77
648 Q(\(when \(> count max-pins-per)82 660 Q(-principal\))-.2 E
(\(error "Pin limit e)87 672 Q(xceeded"\)\))-.15 E
(\(pin! hash reason\)\)\) `)82 684 Q(----------------------------------\
--------------------------------------------)72 708 Q(References)72 732
Q .539(1. The Garbage Collection Handbook - Jones, Hosking, Moss 2. On-\
the-Fly Garbage Collection - Dijkstra et al.)72 756 R(3.)5.54 E
(RFC-020: Content-Addressed Storage 4. RFC-003: Cryptographic Audit T)72
768 Q(rail)-.35 E(-----------------------------------------------------\
-------------------------)72 792 Q 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Changelog)72 24 Q 2.5(-2)72 48 S
(026-01-07 - Initial draft)-2.5 E(-------------------------------------\
-----------------------------------------)72 72 Q 1.603
(Implementation Status: Draft Dependencies: cas, soup, audit Inte)72 96
R 1.602(gration: Storage management, replication, v)-.15 F(ault)-.25 E
(maintenance)72 108 Q 0 Cg EP
%%Trailer
end
%%EOF
