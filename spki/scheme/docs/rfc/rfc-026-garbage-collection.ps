%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Sun Jan 11 22:47:39 2026
%%DocumentNeededResources: font Times-Bold
%%+ font Times-Italic
%%+ font Times-Roman
%%+ font Courier
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 19
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Italic
%%IncludeResource: font Times-Roman
%%IncludeResource: font Courier
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Courier@0 ENC0/Courier RE/Times-Roman@0 ENC0/Times-Roman RE
/Times-Italic@0 ENC0/Times-Italic RE/Times-Bold@0 ENC0/Times-Bold RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF(RFC-026: Garbage Collection)229.344 123 Q/F1 10
/Times-Italic@0 SF(Libr)260.85 159 Q(ary of Cyber)-.15 E(space)-.1 E/F2
10/Times-Roman@0 SF(2026)296 177 Q F1(ABSTRA)282.535 213 Q(CT)-.3 E/F3
10/Times-Bold@0 SF 2.5(1. Abstract)72 261 R F2 .609
(This RFC speci\214es g)72 276.6 R .609
(arbage collection for the Library of Cyberspace: ho)-.05 F 3.109(wv)
-.25 G .608(aults identify and reclaim storage from)-3.359 F .417(unref\
erenced objects while preserving pinned content, respecting tombstones,\
 and maintaining audit trails. Content-)72 288.6 R
(addressed storage requires careful GC to a)72 300.6 Q -.2(vo)-.2 G
(id data loss.).2 E .4(The Library of Cyberspace is an archi)72 316.2 R
-.25(va)-.25 G 2.899(ls).25 G .399(ystem. The def)-2.899 F .399
(ault is preserv)-.1 F .399(ation, not collection. Objects e)-.25 F -.25
(va)-.25 G .399(porate only).25 F(with e)72 328.2 Q(xplicit consent.)
-.15 E F3 2.5(2. Philosoph)72 352.2 R(y: The Soup Pr)-.15 E(eser)-.18 E
-.1(ve)-.1 G(s).1 E F2(The soup is not a runtime heap. It is a library.)
72 367.8 Q .221(In runtime g)72 383.4 R .222
(arbage collection, the goal is to reclaim memory quickly. Y)-.05 F .222
(oung objects die young. Old objects survi)-1.1 F -.15(ve)-.25 G(.).15 E
(Collect aggressi)72 395.4 Q -.15(ve)-.25 G(ly.).15 E(In archi)72 411 Q
-.25(va)-.25 G 2.5(lg).25 G(arbage collection, the opposite holds:)-2.55
E 6.5<834f>72 426.6 S(ld objects are precious)-6.5 E 6.5<8354>72 442.2 S
(he)-6.5 E 2.5(yh)-.15 G -2.25 -.2(av e)-2.5 H(survi)2.7 E -.15(ve)-.25
G(d, been referenced, replicated).15 E 6.5<8359>72 457.8 S
(oung objects are suspect)-7.6 E 6.5<8354>72 473.4 S(he)-6.5 E 2.5(ym)
-.15 G(ay be transient, f)-2.5 E(ailed, or temporary)-.1 E 6.5<8344>72
489 S(eletion is violence)-6.5 E 6.5<834f>72 504.6 S
(nce collected, an object is gone from this v)-6.5 E(ault fore)-.25 E
-.15(ve)-.25 G(r).15 E 6.5<8350>72 520.2 S(reserv)-6.5 E
(ation is the def)-.25 E(ault)-.1 E 6.5<8357>72 535.8 S(hen in doubt, k)
-6.5 E(eep it)-.1 E(The Library of Ale)72 555 Q(xandria b)-.15 E
(urned once. W)-.2 E 2.5(ew)-.8 G(ill not let it b)-2.5 E(urn ag)-.2 E
(ain.)-.05 E F3 2.5(3. Moti)72 579 R -.1(va)-.1 G(tion).1 E F2
(Content-addressed storage accumulates objects fore)72 594.6 Q -.15(ve)
-.25 G 2.5(ru).15 G(nless acti)-2.5 E -.15(ve)-.25 G(ly pruned:).15 E
6.5<834f>72 610.2 S(rphaned objects)-6.5 E 6.5<834e>72 625.8 S 2.5(ol)
-6.5 G(onger referenced by an)-2.5 E 2.5(yr)-.15 G(oot)-2.5 E 6.5<8353>
72 641.4 S(uperseded v)-6.5 E(ersions)-.15 E 6.5<834f>72 657 S(ld v)-6.5
E(ersions after updates)-.15 E 6.5<8346>72 672.6 S(ailed uploads)-6.65 E
6.5<8350>72 688.2 S(artial or abandoned writes)-6.65 E 6.5<8354>72 703.8
S(emporary objects)-7.2 E 6.5<8349>72 719.4 S
(ntermediate computation results)-6.5 E 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R
(But deletion is dangerous:)72 84 Q 6.5<8348>72 99.6 S
(ash as capability)-6.5 E 6.5<8353>72 115.2 S(omeone may hold the hash)
-6.5 E 6.5<834c>72 130.8 S(azy replication)-6.5 E 6.5<8352>72 146.4 S
(emote v)-6.5 E(aults may need it later)-.25 E 6.5<8341>72 162 S
(udit requirements)-6.5 E 6.5<834d>72 177.6 S(ay need historical data)
-6.5 E 6.5<8352>72 193.2 S(esurrection)-6.5 E 6.5<8344>72 208.8 S
(eleted objects may be re-added)-6.5 E(GC must be conserv)72 228 Q(ati)
-.25 E -.15(ve)-.25 G 2.5(,c).15 G(onsensual, and auditable.)-2.5 E
(The def)72 243.6 Q(ault is: ne)-.1 E -.15(ve)-.25 G 2.5(rc).15 G
(ollect. Collection requires e)-2.5 E(xplicit action.)-.15 E/F1 10
/Times-Bold@0 SF 2.5(4. Object)72 267.6 R(Lifecycle)2.5 E 2.5
(4.1. States)72 291.6 R/F2 8/Courier@0 SF(+---------+)204 309.6 Q 19.2
(write |)156 321.6 R(|)43.2 E 4.8(---------> | LIVE)146.4 333.6 R(|)14.4
E 43.2(||)204 345.6 S(+----+----+)204 357.6 Q(|)228 369.6 Q
(+----------+----------+)175.2 381.6 Q 48(|||)175.2 393.6 S 48(vvv)175.2
405.6 S(+--------+ +--------+ +--------+)151.2 417.6 Q 4.8(|PINNED |)
151.2 429.6 R(|TOMBSTONE| |ORPHANED|)4.8 E
(+--------+ +--------+ +---+----+)151.2 441.6 Q(|)276 453.6 Q 4.8(|G)276
465.6 S(C)-4.8 E(v)276 477.6 Q(+--------+)252 489.6 Q(|COLLECTED|)252
501.6 Q(+--------+)252 513.6 Q F1 2.5(4.2. State)72 531.6 R -.74(Tr)2.5
G(ansitions).74 E F2(\(define \(object-state hash\))108 549.6 Q(\(cond)
117.6 561.6 Q(\(\(pinned? hash\) 'pinned\))127.2 573.6 Q
(\(\(tombstoned? hash\) 'tombstone\))127.2 585.6 Q
(\(\(referenced? hash\) 'live\))127.2 597.6 Q(\(else 'orphaned\)\)\))
127.2 609.6 Q(\(define \(can-collect? hash\))108 633.6 Q
(\(and \(eq? \(object-state hash\) 'orphaned\))117.6 645.6 Q
(\(not \(in-grace-period? hash\)\))141.6 657.6 Q
(\(not \(pending-replication? hash\)\)\)\))141.6 669.6 Q F1 2.5
(5. Refer)72 687.6 R(ence Counting)-.18 E 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.1. Dir)72 84 R(ect Refer)-.18 E(ences)-.18 E/F2 8/Courier@0 SF
(;; Track incoming references)108 102 Q
(\(define ref-counts \(make-hash-table\)\))108 114 Q
(\(define \(add-reference from-hash to-hash\))108 138 Q
(\(let \(\(count \(hash-table-ref ref-counts to-hash 0\)\)\))117.6 150 Q
(\(hash-table-set! ref-counts to-hash \(+ count 1\)\))127.2 162 Q
(\(audit-append action: \(add-ref ,from-hash ,to-hash\)\)\)\))127.2 174
Q(\(define \(remove-reference from-hash to-hash\))108 198 Q
(\(let \(\(count \(hash-table-ref ref-counts to-hash 0\)\)\))117.6 210 Q
(\(hash-table-set! ref-counts to-hash \(max 0 \(- count 1\)\)\))127.2
222 Q(\(audit-append action: \(remove-ref ,from-hash ,to-hash\)\)\)\))
127.2 234 Q(\(define \(reference-count hash\))108 258 Q
(\(hash-table-ref ref-counts hash 0\)\))117.6 270 Q F1 2.5(5.2. Root)72
288 R(Refer)2.5 E(ences)-.18 E F2
(;; GC roots - objects that are always reachable)108 306 Q
(\(define gc-roots \(make-hash-set\)\))108 318 Q
(\(define \(add-gc-root hash reason\))108 342 Q
(\(hash-set-add! gc-roots hash\))117.6 354 Q
(\(audit-append action: \(add-root ,hash ,reason\)\)\))117.6 366 Q
(\(define \(remove-gc-root hash\))108 390 Q
(\(hash-set-remove! gc-roots hash\))117.6 402 Q
(\(audit-append action: \(remove-root ,hash\)\)\))117.6 414 Q
(\(define \(gc-root? hash\))108 438 Q
(\(hash-set-member? gc-roots hash\)\))117.6 450 Q F1 2.5(5.3. Implicit)
72 468 R(Roots)2.5 E F2(;; Some objects are implicitly rooted)108 486 Q
(\(define \(implicit-root? hash\))108 498 Q(\(or \(pinned? hash\))117.6
510 Q(\(soup-object-type? hash 'certificate\))136.8 522 Q 4.8(;C)9.6 G
(erts are roots)-4.8 E(\(soup-object-type? hash 'audit-entry\))136.8 534
Q 4.8(;A)9.6 G(udit is sacred)-4.8 E(\(recent-write? hash\)\)\))136.8
546 Q 4.8(;G)81.6 G(race period)-4.8 E F1 2.5(5.4. Cycle)72 564 R
(Detection)2.5 E F0 1.821(Reference counting alone cannot detect c)72
579.6 R 1.821(ycles \(A\342B\342C\342A\). The soup uses mark-and-sweep \
as the authoritati)-.15 F -.15(ve)-.25 G 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R
(reachability test, with reference counts as a f)72 84 Q
(ast path for common cases.)-.1 E/F1 8/Courier@0 SF
(;; Reference counting is advisory, not authoritative)108 102 Q
(\(define \(fast-unreachable? hash\))108 114 Q
("Quick check - zero refs MIGHT mean unreachable")117.6 126 Q
(\(and \(zero? \(reference-count hash\)\))117.6 138 Q
(\(not \(gc-root? hash\)\))141.6 150 Q
(\(not \(implicit-root? hash\)\)\)\))141.6 162 Q
(;; Mark-and-sweep is authoritative)108 186 Q
(\(define \(truly-unreachable? hash marked-set\))108 198 Q
("Authoritative check - not in marked set means unreachable")117.6 210 Q
(\(not \(hash-set-member? marked-set hash\)\)\))117.6 222 Q
(;; Cycle detection via mark-and-sweep)108 246 Q
(\(define \(detect-cycles\))108 258 Q("Find reference cycles \(objects \
that reference each other but are unreachable\)")117.6 270 Q
(\(let* \(\(marked \(mark-reachable\)\))117.6 282 Q
(\(all-hashes \(all-object-hashes\)\))151.2 294 Q(\(unmarked \(filter \
\(lambda \(h\) \(not \(hash-set-member? marked h\)\)\) all-hashes\)\))
151.2 306 Q(\(with-refs \(filter \(lambda \(h\) \(> \(reference-count h\
\) 0\)\) unmarked\)\)\))151.2 318 Q
(;; These have refs but are unreachable - they're in cycles)127.2 330 Q
(with-refs\)\))127.2 342 Q F0 .31(In archi)72 360 R -.25(va)-.25 G 2.81
(lm).25 G .31(ode, c)-2.81 F .31(ycles are preserv)-.15 F .31(ed \(the)
-.15 F 2.811(ym)-.15 G .311
(ay be intentional - e.g., bidirectional links\). Only e)-2.811 F .311
(xplicit e)-.15 F -.25(va)-.25 G(poration).25 E(remo)72 372 Q -.15(ve)
-.15 G 2.5(st).15 G(hem.)-2.5 E/F2 10/Times-Bold@0 SF 2.5(6. Mark)72 396
R(and Sweep)2.5 E 2.5(6.1. T)72 420 R(ricolor Abstraction)-.74 E F0
(The nai)72 435.6 Q .3 -.15(ve r)-.25 H(ecursi).15 E .3 -.15(ve m)-.25 H
(ark algorithm risks stack o).15 E -.15(ve)-.15 G(r\215o).15 E 2.5(wo)
-.25 G 2.5(nd)-2.5 G(eep object graphs. The tricolor abstraction pro)
-2.5 E(vides:)-.15 E .151(1. White: Un)72 451.2 R .151
(visited, potentially g)-.4 F .151(arbage 2. Gray: V)-.05 F .151
(isited b)-.6 F .15(ut references not yet scanned 3. Black: V)-.2 F .15
(isited and all ref-)-.6 F 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R(erences scanned)72 84 Q
/F1 8/Courier@0 SF
(;; Tricolor sets - explicit worklist avoids stack overflow)108 102 Q
(\(define white-set \(make-hash-set\)\))108 114 Q 4.8(;C)9.6 G
(andidates for collection)-4.8 E(\(define gray-set \(make-hash-set\)\))
108 126 Q 4.8(;W)14.4 G(ork queue)-4.8 E
(\(define black-set \(make-hash-set\)\))108 138 Q 4.8(;P)9.6 G
(roven reachable)-4.8 E(\(define \(tricolor-init\))108 162 Q
("Initialize: all objects are white")117.6 174 Q
(\(hash-set-clear! white-set\))117.6 186 Q(\(hash-set-clear! gray-set\))
117.6 198 Q(\(hash-set-clear! black-set\))117.6 210 Q
(\(for-each \(lambda \(h\) \(hash-set-add! white-set h\)\))117.6 222 Q
(\(all-object-hashes\)\)\))165.6 234 Q(\(define \(shade-gray! hash\))108
258 Q("Move object from white to gray \(discovered\)")117.6 270 Q
(\(when \(hash-set-member? white-set hash\))117.6 282 Q
(\(hash-set-remove! white-set hash\))127.2 294 Q
(\(hash-set-add! gray-set hash\)\)\))127.2 306 Q
(\(define \(shade-black! hash\))108 330 Q
("Move object from gray to black \(fully scanned\)")117.6 342 Q
(\(hash-set-remove! gray-set hash\))117.6 354 Q
(\(hash-set-add! black-set hash\)\))117.6 366 Q/F2 10/Times-Bold@0 SF
2.5(6.2. Mark)72 384 R(Phase \(W)2.5 E(orklist Algorithm\))-.75 E F1
(\(define \(mark-reachable\))108 402 Q
("Mark all objects reachable from roots using worklist")117.6 414 Q
(\(tricolor-init\))117.6 426 Q(;; Shade roots gray)117.6 450 Q
(\(for-each shade-gray! \(hash-set->list gc-roots\)\))117.6 462 Q
(\(for-each \(lambda \(hash\))117.6 474 Q
(\(when \(implicit-root? hash\))175.2 486 Q(\(shade-gray! hash\)\)\))
184.8 498 Q(\(all-object-hashes\)\))165.6 510 Q
(;; Process gray objects until none remain)117.6 534 Q(\(let loop \(\))
117.6 546 Q(\(unless \(hash-set-empty? gray-set\))127.2 558 Q
(\(let \(\(current \(hash-set-pop! gray-set\)\)\))136.8 570 Q
(;; Shade all white references gray)146.4 582 Q
(\(for-each shade-gray! \(object-references current\)\))146.4 594 Q
(;; Current is now fully scanned)146.4 606 Q(\(shade-black! current\))
146.4 618 Q(\(loop\)\)\)\))146.4 630 Q 4.8(black-set\) ;)117.6 654 R
(Return reachable set)4.8 E F2 2.5(6.3. Incr)72 672 R(emental T)-.18 E
(ricolor Marking)-.74 E 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R -.15(Fo)72 84 S 2.5(rl)
.15 G(ar)-2.5 E(ge soups, mark in batches to a)-.18 E -.2(vo)-.2 G
(id long pauses:).2 E/F1 8/Courier@0 SF(\(define mark-batch-size 1000\))
108 102 Q 4.8(;O)9.6 G(bjects per batch)-4.8 E
(\(define \(mark-incremental\))108 126 Q
("Mark in batches, yielding between batches")117.6 138 Q
(\(let \(\(batch 0\)\))117.6 150 Q(\(let loop \(\))127.2 162 Q
(\(unless \(or \(hash-set-empty? gray-set\))136.8 174 Q
(\(>= batch mark-batch-size\)\))194.4 186 Q
(\(let \(\(current \(hash-set-pop! gray-set\)\)\))146.4 198 Q
(\(for-each shade-gray! \(object-references current\)\))156 210 Q
(\(shade-black! current\))156 222 Q(\(set! batch \(+ batch 1\)\))156 234
Q(\(loop\)\)\)\))156 246 Q(;; Return whether more work remains)127.2 258
Q(\(not \(hash-set-empty? gray-set\)\)\)\))127.2 270 Q
(;; Usage: call repeatedly until returns #f)108 294 Q
(\(define \(incremental-gc-step\))108 306 Q(\(if \(mark-incremental\))
117.6 318 Q('more-work)136.8 330 Q(\(begin)136.8 342 Q(\(sweep-white\))
146.4 354 Q('complete\)\)\))146.4 366 Q/F2 10/Times-Bold@0 SF 2.5
(6.4. Concurr)72 384 R(ent Write Barrier)-.18 E F0 -.15(Fo)72 399.6 S
2.5(rc).15 G(oncurrent GC, mutations must maintain the tricolor in)-2.5
E -.25(va)-.4 G(riant: a black object cannot point to a white object.)
.25 E F1(;; Write barrier for concurrent GC)108 417.6 Q
(\(define \(cas-put-concurrent data\))108 429.6 Q
("Store with write barrier for concurrent GC")117.6 441.6 Q
(\(let \(\(hash \(cas-put data\)\)\))117.6 453.6 Q
(;; If GC is running and we create new references)127.2 465.6 Q
(\(when gc-running?)127.2 477.6 Q
(;; Shade new object gray \(conservative\))136.8 489.6 Q
(\(shade-gray! hash\))136.8 501.6 Q
(;; Re-shade any black object referencing new object)136.8 513.6 Q
(\(for-each \(lambda \(referencer\))136.8 525.6 Q
(\(when \(hash-set-member? black-set referencer\))194.4 537.6 Q
(;; Demote to gray - needs re-scanning)204 549.6 Q
(\(hash-set-remove! black-set referencer\))204 561.6 Q
(\(hash-set-add! gray-set referencer\)\)\))204 573.6 Q
(\(incoming-references hash\)\)\))184.8 585.6 Q(hash\)\))127.2 597.6 Q
(;; Snapshot-at-the-beginning \(SATB\) barrier)108 621.6 Q
(\(define \(reference-update! from-hash old-ref new-ref\))108 633.6 Q
("SATB write barrier: preserve old reference for marking")117.6 645.6 Q
(\(when \(and gc-running? old-ref\))117.6 657.6 Q
(;; Keep old reference alive through this GC cycle)127.2 669.6 Q
(\(shade-gray! old-ref\)\))127.2 681.6 Q
(\(update-reference! from-hash new-ref\)\))117.6 693.6 Q 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.5. Original)72 84 R(Mark \(Pr)2.5 E(eser)-.18 E -.1(ve)-.1 G 2.5
(df).1 G(or Refer)-2.75 E(ence\))-.18 E/F2 8/Courier@0 SF
(;; Simple recursive version \(for small object graphs only\))108 102 Q
(\(define \(mark-reachable/simple\))108 114 Q("Mark all objects reachab\
le from roots \(recursive, can stack overflow\)")117.6 126 Q
(\(let \(\(marked \(make-hash-set\)\)\))117.6 138 Q
(\(define \(mark hash\))127.2 150 Q
(\(unless \(hash-set-member? marked hash\))136.8 162 Q
(\(hash-set-add! marked hash\))146.4 174 Q
(\(for-each mark \(object-references hash\)\)\)\))146.4 186 Q
(;; Mark from explicit roots)127.2 210 Q
(\(for-each mark \(hash-set->list gc-roots\)\))127.2 222 Q
(;; Mark from implicit roots)127.2 246 Q(\(for-each \(lambda \(hash\))
127.2 258 Q(\(when \(implicit-root? hash\))184.8 270 Q
(\(mark hash\)\)\))194.4 282 Q(\(all-object-hashes\)\))175.2 294 Q
(marked\)\))127.2 318 Q F1 2.5(6.6. Sweep)72 336 R(Phase)2.5 E F2
(\(define \(sweep marked\))108 354 Q("Collect unmarked objects")117.6
366 Q(\(let \(\(collected '\(\)\)\))117.6 378 Q(\(for-each)127.2 390 Q
(\(lambda \(hash\))136.8 402 Q
(\(unless \(hash-set-member? marked hash\))146.4 414 Q
(\(when \(can-collect? hash\))156 426 Q
(\(set! collected \(cons hash collected\)\))165.6 438 Q
(\(collect-object! hash\)\)\)\))165.6 450 Q(\(all-object-hashes\)\))
136.8 462 Q(collected\)\))127.2 474 Q(\(define \(collect-object! hash\))
108 498 Q("Remove object from storage")117.6 510 Q
(\(let \(\(obj \(cas-get hash\)\)\))117.6 522 Q(\(audit-append)127.2 534
Q(action: 'gc-collect)136.8 546 Q(hash: hash)136.8 558 Q
(size: \(object-size obj\))136.8 570 Q(age: \(object-age obj\)\))136.8
582 Q(\(cas-delete! hash\)\)\))127.2 594 Q 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.7. Full)72 84 R(GC)2.5 E/F2 8/Courier@0 SF(\(define \(gc-full\))
108 102 Q("Perform full garbage collection")117.6 114 Q
(\(let \(\(start \(current-time\)\)\))117.6 126 Q
(\(audit-append action: 'gc-start type: 'full\))127.2 138 Q
(\(let* \(\(marked \(mark-reachable\)\))127.2 162 Q
(\(collected \(sweep marked\)\)\))160.8 174 Q(\(audit-append)136.8 198 Q
(action: 'gc-complete)146.4 210 Q(type: 'full)146.4 222 Q
(duration: \(- \(current-time\) start\))146.4 234 Q
(marked: \(hash-set-size marked\))146.4 246 Q
(collected: \(length collected\))146.4 258 Q
(bytes-freed: \(sum \(map object-size collected\)\)\))146.4 270 Q
(collected\)\)\))136.8 294 Q F1 2.5(7. Incr)72 312 R(emental GC)-.18 E
2.5(7.1. Ar)72 336 R(chi)-.18 E -.1(va)-.1 G 2.5(lG).1 G
(enerational Collection)-2.5 E F0 -.35(Tr)72 351.6 S .756
(aditional generational GC collects young objects \214rst \(the).35 F
3.256(yd)-.15 G .756(ie young\). Archi)-3.256 F -.25(va)-.25 G 3.256(lG)
.25 G 3.256(Ci)-3.256 G -1.85 -.4(nv e)-3.256 H .757
(rts this: old objects are).4 F 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R(precious.)72 84 Q/F1 8
/Courier@0 SF(;; Archival generations - age increases protection)108 102
Q(\(define generations)108 114 Q('\(\(ephemeral . 3600\))117.6 126 Q 4.8
(;<1h)24 G(our: temporary, collect freely)-4.8 E(\(young . 86400\))127.2
138 Q 4.8(;<1d)38.4 G(ay: probably transient)-4.8 E
(\(maturing . 604800\))127.2 150 Q 4.8(;<1w)19.2 G
(eek: gaining stability)-4.8 E(\(stable . 2592000\))127.2 162 Q 4.8(;<3)
24 G 4.8(0d)-4.8 G(ays: likely permanent)-4.8 E(\(archival . #f\)\)\))
127.2 174 Q 4.8(;>)28.8 G 4.8(=3)-4.8 G 4.8(0d)-4.8 G
(ays: NEVER collect automatically)-4.8 E
(\(define \(object-generation hash\))108 198 Q
(\(let \(\(age \(object-age hash\)\)\))117.6 210 Q(\(cond)127.2 222 Q
(\(\(< age 3600\) 'ephemeral\))136.8 234 Q(\(\(< age 86400\) 'young\))
136.8 246 Q(\(\(< age 604800\) 'maturing\))136.8 258 Q
(\(\(< age 2592000\) 'stable\))136.8 270 Q(\(else 'archival\)\)\)\))
136.8 282 Q(;; Collection eligibility by generation)108 306 Q
(\(define \(generation-collectible? gen\))108 318 Q(\(case gen)117.6 330
Q(\(\(ephemeral\) #t\))127.2 342 Q 4.8(;F)33.6 G(reely collectible)-4.8
E(\(\(young\) #t\))127.2 354 Q 4.8(;C)52.8 G
(ollectible with grace period)-4.8 E(\(\(maturing\) 'warning\))127.2 366
Q 4.8(;R)9.6 G(equires explicit approval)-4.8 E(\(\(stable\) 'quorum\))
127.2 378 Q 4.8(;R)24 G(equires federation quorum)-4.8 E
(\(\(archival\) #f\)\)\))127.2 390 Q 4.8(;N)28.8 G
(EVER collect automatically)-4.8 E(\(define \(gc-generation gen\))108
414 Q
("Collect only specified generation \(archival only via evaporation\)")
117.6 426 Q(\(when \(eq? gen 'archival\))117.6 438 Q
(\(error "Archival objects require evaporation certificate"\)\))127.2
450 Q(\(let \(\(candidates \(filter \(lambda \(h\))117.6 462 Q
(\(eq? \(object-generation h\) gen\)\))252 474 Q
(\(all-object-hashes\)\)\)\))242.4 486 Q
(\(gc-candidates candidates\)\)\))127.2 498 Q/F2 10/Times-Bold@0 SF 2.5
(7.2. Write)72 516 R(Barrier)2.5 E F1
(;; Track modified objects for incremental GC)108 534 Q
(\(define modified-set \(make-hash-set\)\))108 546 Q
(\(define \(cas-put-with-barrier data\))108 570 Q
(\(let \(\(hash \(cas-put data\)\)\))117.6 582 Q
(\(hash-set-add! modified-set hash\))127.2 594 Q(hash\)\))127.2 606 Q
(\(define \(gc-incremental\))108 630 Q
("Collect recently modified objects if orphaned")117.6 642 Q
(\(let \(\(candidates \(hash-set->list modified-set\)\)\))117.6 654 Q
(\(hash-set-clear! modified-set\))127.2 666 Q
(\(gc-candidates candidates\)\)\))127.2 678 Q 0 Cg EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(7.3. Concurr)72 84 R(ent GC)-.18 E/F2 8/Courier@0 SF
(;; GC runs concurrently with mutations)108 102 Q
(\(define gc-lock \(make-mutex\)\))108 114 Q(\(define gc-running? #f\))
108 126 Q(\(define \(gc-concurrent\))108 150 Q
("Run GC without stopping the world")117.6 162 Q
(\(when \(mutex-try-lock! gc-lock\))117.6 174 Q(\(set! gc-running? #t\))
127.2 186 Q(\(let \(\(snapshot \(snapshot-roots\)\)\))127.2 198 Q
(;; Mark phase uses snapshot)136.8 210 Q
(\(let \(\(marked \(mark-from-snapshot snapshot\)\)\))136.8 222 Q
(;; Sweep only clearly dead objects)146.4 234 Q
(\(sweep-conservative marked\)\)\))146.4 246 Q(\(set! gc-running? #f\))
127.2 258 Q(\(mutex-unlock! gc-lock\)\)\))127.2 270 Q F1 2.5(8. Pinning)
72 288 R 2.5(8.1. Pin)72 312 R(Management)2.5 E F2
(\(define pins \(make-hash-table\)\))108 330 Q
(\(define \(pin! hash reason #!key duration\))108 354 Q
("Protect object from GC")117.6 366 Q(\(hash-table-set! pins hash)117.6
378 Q(\(\(reason . ,reason\))127.2 390 Q
(\(pinned-at . ,\(current-time\)\))136.8 402 Q
(\(expires . ,\(and duration \(+ \(current-time\) duration\)\)\))136.8
414 Q(\(pinned-by . ,\(current-principal\)\)\)\))136.8 426 Q
(\(audit-append action: \(pin ,hash ,reason\)\)\))117.6 438 Q
(\(define \(unpin! hash\))108 462 Q("Allow object to be collected")117.6
474 Q(\(hash-table-delete! pins hash\))117.6 486 Q
(\(audit-append action: `\(unpin ,hash\)\)\))117.6 498 Q
(\(define \(pinned? hash\))108 522 Q
(\(let \(\(pin \(hash-table-ref pins hash #f\)\)\))117.6 534 Q
(\(and pin)127.2 546 Q(\(or \(not \(assoc-ref pin 'expires\)\))151.2 558
Q(\(> \(assoc-ref pin 'expires\) \(current-time\)\)\)\)\)\))170.4 570 Q
F1 2.5(8.2. T)72 588 R(ransiti)-.74 E .2 -.1(ve P)-.1 H(inning).1 E F2
(\(define \(pin-tree! root-hash reason\))108 606 Q
("Pin object and all objects it references")117.6 618 Q
(\(let \(\(visited \(make-hash-set\)\)\))117.6 630 Q
(\(define \(pin-recursive hash\))127.2 642 Q
(\(unless \(hash-set-member? visited hash\))136.8 654 Q
(\(hash-set-add! visited hash\))146.4 666 Q(\(pin! hash reason\))146.4
678 Q(\(for-each pin-recursive \(object-references hash\)\)\)\))146.4
690 Q(\(pin-recursive root-hash\)\)\))127.2 702 Q 0 Cg EP
%%Page: 11 11
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(9. T)72 84 R(ombstones)-.92 E 2.5(9.1. T)72 108 R(ombstone Handling)
-.92 E/F2 8/Courier@0 SF(;; Tombstones are never collected)108 126 Q
(\(define \(tombstoned? hash\))108 138 Q
(\(let \(\(obj \(soup-get hash\)\)\))117.6 150 Q
(\(and obj \(eq? \(soup-object-type obj\) 'tombstone\)\)\)\))127.2 162 Q
(;; Tombstones prevent resurrection)108 186 Q
(\(define \(cas-put-checked data\))108 198 Q
(\(let \(\(hash \(content-hash data\)\)\))117.6 210 Q
(\(when \(tombstoned? hash\))127.2 222 Q
(\(error "Cannot resurrect tombstoned object" hash\)\))136.8 234 Q
(\(cas-put data\)\)\))127.2 246 Q F1 2.5(9.2. T)72 264 R
(ombstone Expiry)-.92 E F2(;; Optional: tombstones can expire)108 282 Q
(\(define \(tombstone-expired? hash\))108 294 Q
(\(let \(\(tomb \(soup-get hash\)\)\))117.6 306 Q(\(and tomb)127.2 318 Q
(\(assoc-ref \(soup-object-metadata tomb\) 'expires\))151.2 330 Q
(\(< \(assoc-ref \(soup-object-metadata tomb\) 'expires\))151.2 342 Q
(\(current-time\)\)\)\)\))165.6 354 Q
(\(define \(gc-expired-tombstones\))108 378 Q
("Remove expired tombstones")117.6 390 Q(\(for-each)117.6 402 Q
(\(lambda \(hash\))127.2 414 Q
(\(when \(and \(tombstoned? hash\) \(tombstone-expired? hash\)\))136.8
426 Q(\(collect-object! hash\)\)\))146.4 438 Q
(\(all-object-hashes\)\)\))127.2 450 Q F1 2.5(10. Grace)72 468 R -.2(Pe)
2.5 G(riods).2 E 2.5(10.1. Write)72 492 R(Grace P)2.5 E(eriod)-.2 E F2
(;; Recently written objects are protected)108 510 Q
(\(define write-grace-period 86400\))108 522 Q 4.8(;2)9.6 G 4.8(4h)-4.8
G(ours)-4.8 E(\(define \(recent-write? hash\))108 546 Q
(\(let \(\(obj \(soup-get hash\)\)\))117.6 558 Q(\(and obj)127.2 570 Q
(\(< \(- \(current-time\) \(soup-object-created obj\)\))151.2 582 Q
(write-grace-period\)\)\)\))165.6 594 Q 0 Cg EP
%%Page: 12 12
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(10.2. Replication)72 84 R(Grace P)2.5 E(eriod)-.2 E/F2 8/Courier@0
SF(;; Objects pending replication are protected)108 102 Q
(\(define pending-replication \(make-hash-set\)\))108 114 Q
(\(define \(mark-pending-replication hash vaults\))108 138 Q
(\(hash-set-add! pending-replication hash\))117.6 150 Q
(\(audit-append action: `\(pending-replication ,hash ,vaults\)\)\))117.6
162 Q(\(define \(clear-pending-replication hash\))108 186 Q
(\(hash-set-remove! pending-replication hash\)\))117.6 198 Q
(\(define \(pending-replication? hash\))108 222 Q
(\(hash-set-member? pending-replication hash\)\))117.6 234 Q F1 2.5
(11. Ev)72 252 R(aporation \(Ar)-.1 E(chi)-.18 E -.1(va)-.1 G 2.5(lC).1
G(ollection\))-2.5 E F0 .08(Objects don')72 267.6 R 2.58(tg)-.18 G .08
(et "g)-2.58 F .08(arbage collected" in an archi)-.05 F -.15(ve)-.25 G
2.58(.T).15 G(he)-2.58 E 2.58(ye)-.15 G -.25(va)-2.83 G .08
(porate - and only with e).25 F .08(xplicit, signed, multi-party con-)
-.15 F(sent.)72 279.6 Q F1 2.5(11.1. Ev)72 303.6 R
(aporation Certi\214cate)-.1 E F2
(;; An evaporation certificate authorizes deletion)108 321.6 Q
(\(define-record-type evaporation-certificate)108 333.6 Q
(\(make-evaporation-cert hash reason signers timestamp\))117.6 345.6 Q
(evaporation-cert?)117.6 357.6 Q(\(hash evap-hash\))117.6 369.6 Q 4.8
(;O)52.8 G(bject to evaporate)-4.8 E(\(reason evap-reason\))117.6 381.6
Q 4.8(;W)33.6 G(hy \(legal, storage, corruption, etc.\))-4.8 E
(\(signers evap-signers\))117.6 393.6 Q 4.8(;L)24 G
(ist of \(principal . signature\))-4.8 E(\(timestamp evap-timestamp\)\))
117.6 405.6 Q(;; Reasons for evaporation \(enumerated, auditable\))108
429.6 Q(\(define evaporation-reasons)108 441.6 Q 33.6
('\(legal-requirement ;)117.6 453.6 R(Court order, DMCA, etc.)4.8 E 33.6
(storage-emergency ;)127.2 465.6 R(Vault at capacity)4.8 E 43.2
(data-corruption ;)127.2 477.6 R(Object verified corrupt)4.8 E 52.8
(owner-request ;)127.2 489.6 R(Content owner requests removal)4.8 E 9.6
(federation-consensus\)\) ;)127.2 501.6 R(Quorum agrees to remove)4.8 E
(\(define \(create-evaporation-cert hash reason\))108 525.6 Q
("Create unsigned evaporation certificate")117.6 537.6 Q
(\(make-evaporation-cert)117.6 549.6 Q(hash)127.2 561.6 Q(reason)127.2
573.6 Q 4.8('\(\) ;)127.2 585.6 R(No signatures yet)4.8 E
(\(current-time\)\)\))127.2 597.6 Q
(\(define \(sign-evaporation-cert cert private-key\))108 621.6 Q
("Add signature to evaporation certificate")117.6 633.6 Q
(\(let* \(\(principal \(key->principal private-key\)\))117.6 645.6 Q
(\(sig \(sign-data \(evap-hash cert\) private-key\)\)\))151.2 657.6 Q
(\(make-evaporation-cert)127.2 669.6 Q(\(evap-hash cert\))136.8 681.6 Q
(\(evap-reason cert\))136.8 693.6 Q
(\(cons \(cons principal sig\) \(evap-signers cert\)\))136.8 705.6 Q
(\(evap-timestamp cert\)\)\)\))136.8 717.6 Q 0 Cg EP
%%Page: 13 13
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(11.2. Quorum)72 84 R(Requir)2.5 E(ement)-.18 E/F2 8/Courier@0 SF
(;; Evaporation requires M-of-N signatures from federation)108 102 Q
(\(define evaporation-quorum)108 114 Q('\(\(ephemeral . 1\))117.6 126 Q
4.8(;S)24 G(ingle vault can evaporate)-4.8 E(\(young . 1\))127.2 138 Q
4.8(;S)43.2 G(ingle vault can evaporate)-4.8 E(\(maturing . 2\))127.2
150 Q 4.8(;T)28.8 G(wo vaults must agree)-4.8 E(\(stable . 3\))127.2 162
Q 4.8(;T)38.4 G(hree vaults must agree)-4.8 E(\(archival . #f\)\)\))
127.2 174 Q 4.8(;R)14.4 G(equires special process \(see below\))-4.8 E
(\(define \(evaporation-quorum-met? cert generation\))108 198 Q
(\(let \(\(required \(assoc-ref evaporation-quorum generation\)\)\))
117.6 210 Q(\(cond)127.2 222 Q(\(\(not required\) #f\))136.8 234 Q 4.8
(;A)9.6 G(rchival: never automatic)-4.8 E
(\(else \(>= \(length \(evap-signers cert\)\) required\)\)\)\)\))136.8
246 Q(\(define \(evaporate! hash cert\))108 270 Q
("Evaporate object with valid certificate")117.6 282 Q
(\(let \(\(gen \(object-generation hash\)\)\))117.6 294 Q
(\(unless \(evaporation-quorum-met? cert gen\))127.2 306 Q
(\(error "Evaporation quorum not met")136.8 318 Q(`\(generation ,gen re\
quired ,\(assoc-ref evaporation-quorum gen\)\)\)\))170.4 330 Q
(;; Archival objects require special handling)127.2 354 Q
(\(when \(eq? gen 'archival\))127.2 366 Q
(\(unless \(archival-evaporation-authorized? cert\))136.8 378 Q
(\(error "Archival evaporation requires governance approval"\)\)\))146.4
390 Q(;; Log everything before deletion)127.2 414 Q(\(audit-append)127.2
426 Q(action: 'evaporate)136.8 438 Q(hash: hash)136.8 450 Q
(generation: gen)136.8 462 Q(certificate: cert)136.8 474 Q
(reason: \(evap-reason cert\))136.8 486 Q
(signers: \(map car \(evap-signers cert\)\)\))136.8 498 Q
(;; Finally, delete)127.2 522 Q(\(cas-delete! hash\)\)\))127.2 534 Q F1
2.5(11.3. Ar)72 552 R(chi)-.18 E -.1(va)-.1 G 2.5(lO).1 G(bject Ev)-2.5
E(aporation)-.1 E F0(Archi)72 567.6 Q -.25(va)-.25 G 2.5(lo).25 G
(bjects \(>30 days\) recei)-2.5 E .3 -.15(ve m)-.25 H
(aximum protection. The).15 E 2.5(yc)-.15 G(an only e)-2.5 E -.25(va)
-.25 G(porate via:).25 E .146(1. Le)72 583.2 R -.05(ga)-.15 G 2.646(lr)
.05 G .146(equirement - W)-2.646 F .147(ith proof of le)-.4 F -.05(ga)
-.15 G 2.647(lo).05 G .147(rder 2. Data corruption - W)-2.647 F .147
(ith cryptographic proof of corruption 3. Go)-.4 F(v-)-.15 E 0 Cg EP
%%Page: 14 14
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R(ernance v)72 84 Q
(ote - Per RFC-036 quorum protocol)-.2 E/F1 8/Courier@0 SF
(\(define \(archival-evaporation-authorized? cert\))108 102 Q
("Check if archival evaporation is properly authorized")117.6 114 Q
(\(case \(evap-reason cert\))117.6 126 Q(\(\(legal-requirement\))127.2
138 Q(;; Must include legal order reference)132 150 Q
(\(and \(evap-legal-order cert\))132 162 Q
(\(verify-legal-order \(evap-legal-order cert\)\)\)\))156 174 Q
(\(\(data-corruption\))127.2 198 Q(;; Must include corruption proof)132
210 Q(\(and \(evap-corruption-proof cert\))132 222 Q(\(verify-corruptio\
n \(evap-hash cert\) \(evap-corruption-proof cert\)\)\)\))156 234 Q
(\(\(federation-consensus\))127.2 258 Q
(;; Must have governance quorum \(RFC-036\))132 270 Q
(\(governance-quorum-met? cert\)\))132 282 Q(\(else #f\)\)\))127.2 306 Q
4.8(;N)9.6 G 4.8(oo)-4.8 G(ther reasons valid for archival)-4.8 E/F2 10
/Times-Bold@0 SF 2.5(12. Distrib)72 324 R(uted GC)-.2 E 2.5
(12.1. Coordinated)72 348 R(Collection)2.5 E F1
(;; Multi-vault GC requires coordination)108 366 Q
(\(define \(distributed-gc vaults\))108 378 Q
("Coordinate GC across vault federation")117.6 390 Q
(;; Phase 1: Gather root sets)117.6 402 Q
(\(let \(\(root-sets \(map vault-roots vaults\)\)\))117.6 414 Q
(;; Phase 2: Compute global reachability)127.2 426 Q
(\(let \(\(global-marked \(union-all root-sets\)\)\))127.2 438 Q
(;; Phase 3: Propose evaporation \(no unilateral deletion\))136.8 450 Q
(\(for-each \(lambda \(vault\))136.8 462 Q
(\(vault-propose-evaporation vault global-marked\)\))194.4 474 Q
(vaults\)\)\)\))184.8 486 Q F2 2.5(12.2. Remote)72 504 R(Refer)2.5 E
(ence T)-.18 E(racking)-.74 E F1(;; Track references from remote vaults)
108 522 Q(\(define remote-refs \(make-hash-table\)\))108 534 Q
(\(define \(add-remote-reference vault-id hash\))108 558 Q
(\(let \(\(refs \(hash-table-ref remote-refs hash '\(\)\)\)\))117.6 570
Q(\(hash-table-set! remote-refs hash \(cons vault-id refs\)\)\)\))127.2
582 Q(\(define \(remove-remote-reference vault-id hash\))108 606 Q
(\(let \(\(refs \(hash-table-ref remote-refs hash '\(\)\)\)\))117.6 618
Q(\(hash-table-set! remote-refs hash \(delete vault-id refs\)\)\)\))
127.2 630 Q(\(define \(has-remote-references? hash\))108 654 Q
(\(not \(null? \(hash-table-ref remote-refs hash '\(\)\)\)\)\))117.6 666
Q 0 Cg EP
%%Page: 15 15
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(12.3. Lease-Based)72 84 R(Collection)2.5 E/F2 8/Courier@0 SF
(;; Remote vaults lease objects)108 102 Q
(\(define leases \(make-hash-table\)\))108 114 Q
(\(define \(grant-lease hash vault-id duration\))108 138 Q
(\(let \(\(expires \(+ \(current-time\) duration\)\)\))117.6 150 Q
(\(hash-table-set! leases hash)127.2 162 Q
(\(cons \(cons vault-id expires\))136.8 174 Q
(\(hash-table-ref leases hash '\(\)\)\)\)\)\))165.6 186 Q
(\(define \(lease-active? hash\))108 210 Q
(\(let \(\(hash-leases \(hash-table-ref leases hash '\(\)\)\)\))117.6
222 Q(\(any \(lambda \(lease\))127.2 234 Q
(\(> \(cdr lease\) \(current-time\)\)\))160.8 246 Q(hash-leases\)\)\))
151.2 258 Q F1 2.5(13. GC)72 276 R(Scheduling)2.5 E 2.5(13.1. Ar)72 300
R(chi)-.18 E -.1(va)-.1 G 2.5(lD).1 G(efaults)-2.5 E F0 .424
(The soup def)72 315.6 R .424(aults to ne)-.1 F -.15(ve)-.25 G 2.924(rc)
.15 G .424(ollect. GC only runs when e)-2.924 F .423
(xplicitly enabled and only considers ephemeral/young gen-)-.15 F
(erations automatically.)72 327.6 Q F2(;; Archival GC mode)108 345.6 Q
(\(define gc-mode 'archival\))108 357.6 Q 4.8(;')9.6 G
(archival, 'conservative, or 'aggressive)-4.8 E
(\(define \(gc-enabled?\))108 381.6 Q
("Check if automatic GC is enabled")117.6 393.6 Q
(\(not \(eq? gc-mode 'archival\)\)\))117.6 405.6 Q 0 Cg EP
%%Page: 16 16
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(13.2. T)72 84 R(riggers)-.74 E/F2 8/Courier@0 SF
(;; GC triggered only under pressure, and only for young generations)108
102 Q(\(define \(should-gc?\))108 114 Q(\(and \(gc-enabled?\))117.6 126
Q(\(or \(> \(storage-usage-percent\) 95\))141.6 138 Q 4.8(;E)19.2 G
(mergency only)-4.8 E(\(> \(ephemeral-orphan-count\) 1000\)\)\)\) ; Too\
 many ephemeral orphans)160.8 150 Q(\(define \(gc-schedule\))108 174 Q
("Run appropriate GC based on conditions and mode")117.6 186 Q
(\(case gc-mode)117.6 198 Q(\(\(archival\))127.2 210 Q
(;; Never automatic - only explicit evaporation)132 222 Q
(\(audit-append action: 'gc-skipped reason: 'archival-mode\)\))132 234 Q
(\(\(conservative\))127.2 258 Q(;; Only ephemeral objects)132 270 Q
(\(cond)132 282 Q(\(\(> \(storage-usage-percent\) 99\))141.6 294 Q
(\(gc-generation 'ephemeral\))146.4 306 Q(\(gc-generation 'young\)\))
146.4 318 Q 4.8(;E)9.6 G(mergency: young too)-4.8 E
(\(\(> \(storage-usage-percent\) 95\))141.6 330 Q
(\(gc-generation 'ephemeral\)\))146.4 342 Q(\(else)141.6 354 Q
(\(audit-append action: 'gc-skipped reason: 'no-pressure\)\)\)\))146.4
366 Q(\(\(aggressive\))127.2 390 Q
(;; Traditional GC \(NOT RECOMMENDED for archives\))132 402 Q(\(cond)132
414 Q(\(\(> \(storage-usage-percent\) 95\))141.6 426 Q(\(gc-full\)\))
146.4 438 Q(\(\(> \(storage-usage-percent\) 80\))141.6 450 Q
(\(gc-generation 'young\)\))146.4 462 Q(\(else)141.6 474 Q
(\(gc-incremental\)\)\)\)\)\))146.4 486 Q 0 Cg EP
%%Page: 17 17
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(13.3. Backgr)72 84 R(ound GC)-.18 E/F2 8/Courier@0 SF
(\(define gc-thread #f\))108 102 Q
(\(define \(start-gc-daemon interval\))108 126 Q
("Start background GC daemon \(archival mode: monitoring only\)")117.6
138 Q(\(set! gc-thread)117.6 150 Q(\(thread-start!)127.2 162 Q
(\(make-thread)136.8 174 Q(\(lambda \(\))146.4 186 Q(\(let loop \(\))156
198 Q(\(thread-sleep! interval\))165.6 210 Q(;; Always report status)
165.6 222 Q(\(audit-append)165.6 234 Q(action: 'gc-status)175.2 246 Q
(mode: gc-mode)175.2 258 Q(storage-percent: \(storage-usage-percent\))
175.2 270 Q(ephemeral-orphans: \(ephemeral-orphan-count\))175.2 282 Q
(should-gc: \(should-gc?\)\))175.2 294 Q(;; Only act if enabled)165.6
306 Q(\(when \(should-gc?\))165.6 318 Q(\(gc-schedule\)\))175.2 330 Q
(\(loop\)\)\)\)\)\)\))165.6 342 Q F1 2.5(14. Safety)72 360 R(Mechanisms)
2.5 E 2.5(14.1. Dry)72 384 R(Run)2.5 E F2(\(define \(gc-dry-run\))108
402 Q("Report what would be collected without collecting")117.6 414 Q
(\(let* \(\(marked \(mark-reachable\)\))117.6 426 Q
(\(would-collect \(filter \(lambda \(h\))151.2 438 Q
(\(not \(hash-set-member? marked h\)\)\))271.2 450 Q
(\(all-object-hashes\)\)\)\))261.6 462 Q
(`\(\(would-collect . ,\(length would-collect\)\))127.2 474 Q
(\(bytes . ,\(sum \(map object-size would-collect\)\)\))136.8 486 Q
(\(samples . ,\(take would-collect 10\)\)\)\)\))136.8 498 Q F1 2.5
(14.2. Collection)72 516 R(Log)2.5 E F2
(;; Every collection is logged with recovery info)108 534 Q
(\(define \(collect-with-log! hash\))108 546 Q
(\(let \(\(obj \(cas-get hash\)\)\))117.6 558 Q
(;; Log enough to reconstruct if needed)127.2 570 Q(\(audit-append)127.2
582 Q(action: 'gc-collect)136.8 594 Q(hash: hash)136.8 606 Q
(size: \(object-size obj\))136.8 618 Q(type: \(soup-object-type obj\))
136.8 630 Q(references: \(object-references hash\))136.8 642 Q
(metadata: \(soup-object-metadata obj\)\))136.8 654 Q
(\(cas-delete! hash\)\)\))127.2 666 Q 0 Cg EP
%%Page: 18 18
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(14.3. Reco)72 84 R -.1(ve)-.1 G(ry).1 E/F2 8/Courier@0 SF
(;; Recover recently collected object from audit log)108 102 Q
(\(define \(gc-recover hash\))108 114 Q
("Attempt to recover collected object")117.6 126 Q
(\(let \(\(entry \(find \(lambda \(e\))117.6 138 Q
(\(and \(eq? \(audit-action e\) 'gc-collect\))218.4 150 Q
(\(equal? \(audit-hash e\) hash\)\)\))242.4 162 Q
(\(recent-audit-entries\)\)\)\))208.8 174 Q(\(if entry)127.2 186 Q
(\(error "Object collected, metadata preserved in audit")146.4 198 Q
(\(audit-metadata entry\)\))180 210 Q
(\(error "Object not found in recent collections"\)\)\)\))146.4 222 Q F1
2.5(15. Metrics)72 240 R 2.5(15.1. GC)72 264 R(Statistics)2.5 E F2
(\(define gc-stats)108 282 Q(\(\(collections . 0\))117.6 294 Q
(\(bytes-freed . 0\))127.2 306 Q(\(objects-freed . 0\))127.2 318 Q
(\(total-time . 0\))127.2 330 Q(\(last-gc . #f\)\)\))127.2 342 Q
(\(define \(update-gc-stats collected duration\))108 366 Q
(\(set! gc-stats)117.6 378 Q
(\(\(collections . ,\(+ 1 \(assoc-ref gc-stats 'collections\)\)\))127.2
390 Q(\(bytes-freed . ,\(+ \(sum \(map object-size collected\)\))136.8
402 Q(\(assoc-ref gc-stats 'bytes-freed\)\)\))228 414 Q
(\(objects-freed . ,\(+ \(length collected\))136.8 426 Q
(\(assoc-ref gc-stats 'objects-freed\)\)\))237.6 438 Q
(\(total-time . ,\(+ duration \(assoc-ref gc-stats 'total-time\)\)\))
136.8 450 Q(\(last-gc . ,\(current-time\)\)\)\)\))136.8 462 Q F1 2.5
(15.2. Monitoring)72 480 R F2(;; Expose GC metrics)108 498 Q
(\(define \(gc-metrics\))108 510 Q
(`\(\(storage-used . ,\(storage-used\)\))117.6 522 Q
(\(storage-total . ,\(storage-total\)\))127.2 534 Q
(\(object-count . ,\(object-count\)\))127.2 546 Q
(\(orphan-estimate . ,\(orphan-estimate\)\))127.2 558 Q
(\(pinned-count . ,\(hash-table-size pins\)\))127.2 570 Q
(\(gc-stats . ,gc-stats\)\)\))127.2 582 Q F1 2.5(16. Security)72 600 R
(Considerations)2.5 E 2.5(16.1. GC)72 624 R(as Side Channel)2.5 E F2
(;; GC timing can leak information about object references)108 642 Q
(;; Use constant-time operations where possible)108 654 Q
(\(define \(constant-time-mark hash\))108 666 Q
(\(let \(\(refs \(object-references hash\)\)\))117.6 678 Q
(;; Always process same number of refs)127.2 690 Q
(\(for-each mark \(pad-list refs max-refs\)\)\)\))127.2 702 Q 0 Cg EP
%%Page: 19 19
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-026 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(16.2. Denial)72 84 R(of Ser)2.5 E(vice)-.1 E/F2 8/Courier@0 SF
(;; Prevent GC starvation attacks)108 102 Q
(\(define max-pins-per-principal 10000\))108 114 Q
(\(define \(pin-with-limit! hash reason\))108 138 Q
(\(let \(\(count \(principal-pin-count \(current-principal\)\)\)\))117.6
150 Q(\(when \(> count max-pins-per-principal\))127.2 162 Q
(\(error "Pin limit exceeded"\)\))136.8 174 Q(\(pin! hash reason\)\)\))
127.2 186 Q F1 2.5(17. In)72 204 R -.1(va)-.4 G(riants).1 E F2
(G1. Preservation default)108 222 Q
(default-mode = archival > no-automatic-collection)127.2 234 Q
(G2. Age increases protection)108 258 Q(age\(obj\) > age\(obj'\) > prot\
ection\(obj\) \342\245 protection\(obj'\))127.2 270 Q
(G3. Evaporation requires consent)108 294 Q
(evaporate\(hash\) requires signed-certificate\(hash\))127.2 306 Q
(G4. Quorum scales with age)108 330 Q
(generation = archival > quorum = governance-level)127.2 342 Q
(G5. Archival objects are sacred)108 366 Q
(age > 30-days > no-automatic-evaporation)127.2 378 Q
(G6. Audit trail preserved)108 402 Q
(evaporate\(hash\) > audit-append\(hash, certificate, reason, signers\))
127.2 414 Q(G7. Mark-and-sweep authoritative)108 438 Q(truly-unreachabl\
e\(hash\) \342 \302\254member\(hash, mark-reachable\(\)\))127.2 450 Q
(G8. Cycles preserved)108 474 Q
(cycle\(A, B, C\) \342\247 archival-mode > preserve\(A, B, C\))127.2 486
Q F1 2.5(18. Refer)72 504 R(ences)-.18 E F0 .686(1. The Garbage Collect\
ion Handbook - Jones, Hosking, Moss 2. On-the-Fly Garbage Collection - \
Dijkstra et al. 3.)72 519.6 R .881
(RFC-020: Content-Addressed Storage 4. RFC-003: Cryptographic Audit T)72
531.6 R .881(rail 5. RFC-036: Quorum Protocol with)-.35 F(Homomorphic V)
72 543.6 Q(oting 6. RFC-007: Threshold Signature Go)-1.29 E -.15(ve)-.15
G(rnance).15 E F1 2.5(19. Changelog)72 567.6 R F0 6.5<8332>72 583.2 S
(026-01-09)-6.5 E 6.5<8354>72 598.8 S .177(ricolor marking with w)-6.85
F .177(orklist \(eliminates stack o)-.1 F -.15(ve)-.15 G(r\215o).15 E
.178(w\), incremental marking, SA)-.25 F .178
(TB write barriers, concurrent)-1.11 F(GC support - 2026-01-09)82 610.8
Q 6.5<8341>72 626.4 S(rchi)-6.5 E -.25(va)-.25 G 2.569(lG).25 G 2.569
(Ci)-2.569 G(mpro)-2.569 E -.15(ve)-.15 G .068(ments: e).15 F -.25(va)
-.25 G .068(poration certi\214cates, quorum requirements, re).25 F -.15
(ve)-.25 G .068(rsed generational polic).15 F 1.368 -.65(y, c)-.15 H
.068(ycle de-).5 F(tection, preserv)82 638.4 Q(ation-\214rst def)-.25 E
(aults - 2026-01-07)-.1 E 6.5<8349>72 654 S(nitial draft)-6.5 E 0 Cg EP
%%Trailer
end
%%EOF
