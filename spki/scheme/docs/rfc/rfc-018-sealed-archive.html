<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>rfc-018-sealed-archive</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="rfc.css" />
</head>
<body>
<h1 id="rfc-018-sealed-archive-format">RFC-018: Sealed Archive
Format</h1>
<p><strong>Status:</strong> Implemented <strong>Date:</strong> January
2026 <strong>Author:</strong> Derrell Piper <a
href="mailto:ddp@eludom.net" class="email">ddp@eludom.net</a>
<strong>Implementation:</strong> vault.scm</p>
<hr />
<h2 id="abstract">Abstract</h2>
<p>This RFC specifies the Zstd+Age archive format for the Library of
Cyberspace: a modern archive format combining Zstd compression with Age
encryption, replacing gzip for cryptographic archives.</p>
<hr />
<h2 id="motivation">Motivation</h2>
<p>The legacy <code>cryptographic</code> archive format uses gzip
compression without encryption:</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>gzip (legacy)</th>
<th>zstd + age</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compression speed</td>
<td>Slow</td>
<td>Fast (parallel)</td>
</tr>
<tr>
<td>Compression ratio</td>
<td>Good</td>
<td>Better</td>
</tr>
<tr>
<td>Encryption</td>
<td>None</td>
<td>Built-in (age)</td>
</tr>
<tr>
<td>Key compatibility</td>
<td>N/A</td>
<td>X25519/Ed25519 (SPKI aligned)</td>
</tr>
<tr>
<td>Streaming</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Why change?</strong></p>
<ol type="1">
<li><strong>Encryption at rest</strong> - Archives contain potentially
sensitive data</li>
<li><strong>Faster compression</strong> - Zstd is 3-5x faster than
gzip</li>
<li><strong>Better ratios</strong> - Zstd typically achieves 10-20%
better compression</li>
<li><strong>Key alignment</strong> - Age uses X25519/Ed25519, same curve
family as SPKI</li>
<li><strong>Parallel support</strong> - <code>zstd -T0</code> uses all
cores</li>
</ol>
<hr />
<h2 id="specification">Specification</h2>
<h3 id="archive-creation-pipeline">Archive Creation Pipeline</h3>
<pre><code>git archive | tar --zstd | age -r &lt;recipients&gt; &gt; archive.tar.zst.age</code></pre>
<p>Or equivalently:</p>
<pre><code>tar --zstd -cf - &lt;files&gt; | age -r &lt;recipient1&gt; -r &lt;recipient2&gt; &gt; archive.tar.zst.age</code></pre>
<h3 id="archive-restoration-pipeline">Archive Restoration Pipeline</h3>
<pre><code>age -d -i &lt;identity&gt; &lt; archive.tar.zst.age | zstd -d | tar -xf -</code></pre>
<h3 id="manifest-format">Manifest Format</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(sealed-archive</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  (version <span class="st">&quot;1.0.0&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  (format zstd-age)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  (archive <span class="st">&quot;vault-1.0.0.archive.tar.zst.age&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  (compression zstd)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  (encryption age)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  (recipients (<span class="st">&quot;age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p&quot;</span>))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  (hash <span class="st">&quot;sha512:...&quot;</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  (signature <span class="st">&quot;ed25519:...&quot;</span>))</span></code></pre></div>
<h3 id="file-extensions">File Extensions</h3>
<table>
<thead>
<tr>
<th>Extension</th>
<th>Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.archive</code></td>
<td>S-expression manifest</td>
</tr>
<tr>
<td><code>.tar.zst.age</code></td>
<td>Encrypted, compressed tarball</td>
</tr>
</tbody>
</table>
<h3 id="configuration">Configuration</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Set age recipients for encryption</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>(vault-config &#39;age-recipients</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="st">&quot;age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;age1...&quot;</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Set age identity for decryption</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>(vault-config &#39;age-identity <span class="st">&quot;~/.config/age/identity.txt&quot;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Set default archive format</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>(vault-config &#39;archive-format &#39;zstd-age)</span></code></pre></div>
<hr />
<h2 id="performance-characteristics">Performance Characteristics</h2>
<h3 id="compression">Compression</h3>
<pre><code>Zstd default (-3):
  Compression:   ~400 MB/s
  Decompression: ~800 MB/s
  Ratio:         ~3:1 (typical source code)

Zstd parallel (-T0):
  Compression:   ~400 MB/s × cores
  Decompression: ~800 MB/s × cores

Gzip comparison:
  Compression:   ~30 MB/s
  Decompression: ~200 MB/s
  Ratio:         ~2.5:1</code></pre>
<h3 id="encryption">Encryption</h3>
<pre><code>Age X25519:
  Encrypt:  ~1 GB/s (ChaCha20-Poly1305)
  Decrypt:  ~1 GB/s
  Key size: 32 bytes (public), 32 bytes (private)

Age overhead:
  Header:   ~200 bytes per recipient
  MAC:      16 bytes</code></pre>
<h3 id="signature">Signature</h3>
<pre><code>Ed25519:
  Sign:     ~10 μs
  Verify:   ~10 μs
  Signature: 64 bytes</code></pre>
<h3 id="total-pipeline">Total Pipeline</h3>
<pre><code>10 MB archive:
  Compress (zstd -T0): ~25 ms
  Encrypt (age):       ~10 ms
  Hash (SHA-512):      ~1 ms
  Sign (Ed25519):      ~10 μs
  Total:               ~36 ms

vs gzip legacy:
  Compress (gzip):     ~300 ms
  Hash (SHA-512):      ~1 ms
  Sign (Ed25519):      ~10 μs
  Total:               ~301 ms

Speedup: ~8x</code></pre>
<hr />
<h2 id="security-model">Security Model</h2>
<h3 id="encryption-layer-age">Encryption Layer (Age)</h3>
<ul>
<li><strong>Algorithm</strong>: X25519 + ChaCha20-Poly1305</li>
<li><strong>Recipients</strong>: Multiple allowed (each can
decrypt)</li>
<li><strong>Forward secrecy</strong>: Ephemeral key per archive</li>
<li><strong>Authenticity</strong>: Poly1305 MAC</li>
</ul>
<h3 id="signature-layer-spki">Signature Layer (SPKI)</h3>
<ul>
<li><strong>Algorithm</strong>: Ed25519</li>
<li><strong>Scope</strong>: Signs encrypted archive hash</li>
<li><strong>Non-repudiation</strong>: Signer cannot deny creating
archive</li>
</ul>
<h3 id="verification-order">Verification Order</h3>
<ol type="1">
<li><strong>Verify signature</strong> - Before decryption (fail fast on
tampering)</li>
<li><strong>Verify hash</strong> - Encrypted archive integrity</li>
<li><strong>Decrypt</strong> - Only after signature verified</li>
<li><strong>Extract</strong> - Only after successful decryption</li>
</ol>
<h3 id="threat-mitigations">Threat Mitigations</h3>
<table>
<thead>
<tr>
<th>Threat</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Eavesdropping</td>
<td>Age encryption (X25519 + ChaCha20)</td>
</tr>
<tr>
<td>Tampering</td>
<td>SHA-512 hash + Ed25519 signature</td>
</tr>
<tr>
<td>Replay attacks</td>
<td>Version + timestamp in manifest</td>
</tr>
<tr>
<td>Key compromise</td>
<td>Multiple recipients, key rotation</td>
</tr>
<tr>
<td>Chosen ciphertext</td>
<td>Poly1305 authentication</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="compatibility">Compatibility</h2>
<h3 id="age-identity-types">Age Identity Types</h3>
<pre><code># Native age key
age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p

# SSH key (age supports ssh-ed25519 and ssh-rsa)
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...

# GitHub key (via age-plugin-github or ssh)
github:username</code></pre>
<h3 id="platform-support">Platform Support</h3>
<table>
<thead>
<tr>
<th>Platform</th>
<th>zstd</th>
<th>age</th>
</tr>
</thead>
<tbody>
<tr>
<td>macOS</td>
<td>Homebrew</td>
<td>Homebrew</td>
</tr>
<tr>
<td>Linux</td>
<td>apt/yum</td>
<td>apt/yum or binary</td>
</tr>
<tr>
<td>FreeBSD</td>
<td>pkg</td>
<td>pkg</td>
</tr>
<tr>
<td>Windows</td>
<td>winget</td>
<td>winget or binary</td>
</tr>
</tbody>
</table>
<h3 id="fallback">Fallback</h3>
<p>If zstd or age unavailable, fall back to <code>cryptographic</code>
format:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">if</span> (<span class="kw">and</span> (command-exists? <span class="st">&quot;zstd&quot;</span>) (command-exists? <span class="st">&quot;age&quot;</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    (seal-archive version format: &#39;zstd-age)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    (seal-archive version format: &#39;cryptographic))</span></code></pre></div>
<hr />
<h2 id="implementation">Implementation</h2>
<h3 id="seal-archive-zstd-age">seal-archive-zstd-age</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">seal-archive-zstd-age </span>version output)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Create zstd-compressed, age-encrypted archive with SPKI signature&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((recipients (vault-config &#39;age-recipients))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        (signing-key (vault-config &#39;signing-key))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        (encrypted-file (sprintf <span class="st">&quot;~a.tar.zst.age&quot;</span> output)))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Require recipients</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    (unless (<span class="kw">pair?</span> recipients)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;No age recipients configured&quot;</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Build recipient args: -r key1 -r key2 ...</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> ((recipient-args</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>           (string-join (map (<span class="kw">lambda</span> (r) (sprintf <span class="st">&quot;-r ~a&quot;</span> r)) recipients) <span class="st">&quot; &quot;</span>)))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Create archive: git archive | zstd | age</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> ((temp-tar (sprintf <span class="st">&quot;/tmp/vault-~a.tar&quot;</span> version)))</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        (run-command <span class="st">&quot;git&quot;</span> <span class="st">&quot;archive&quot;</span> <span class="st">&quot;--prefix=vault/&quot;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                     (sprintf <span class="st">&quot;--output=~a&quot;</span> temp-tar) version)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        (system (sprintf <span class="st">&quot;zstd -T0 -c ~a | age ~a &gt; ~a&quot;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                        temp-tar recipient-args encrypted-file))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">delete-file</span> temp-tar))</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Sign the encrypted archive</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      (when signing-key</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let*</span> ((archive-bytes (read-file-bytes encrypted-file))</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>               (archive-hash (sha512-hash archive-bytes))</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>               (signature (ed25519-sign signing-key archive-hash)))</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Write manifest</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">with-output-to-file</span> output</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">lambda</span> ()</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">write</span> `(sealed-archive</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>                       (version ,version)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                       (format zstd-age)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                       (archive ,encrypted-file)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                       (compression zstd)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>                       (encryption age)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>                       (recipients ,recipients)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                       (hash ,(blob-&gt;hex archive-hash))</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                       (signature ,(blob-&gt;hex signature)))))))))))</span></code></pre></div>
<h3 id="seal-restore-zstd-age">seal-restore-zstd-age</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(<span class="fu">seal-restore-zstd-age </span>manifest verify-key target-dir identity)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Restore zstd+age encrypted archive&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> ((version (<span class="kw">cadr</span> (<span class="kw">assq</span> &#39;version (<span class="kw">cdr</span> manifest))))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        (archive-file (<span class="kw">cadr</span> (<span class="kw">assq</span> &#39;archive (<span class="kw">cdr</span> manifest))))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        (hash-hex (<span class="kw">cadr</span> (<span class="kw">assq</span> &#39;hash (<span class="kw">cdr</span> manifest))))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        (sig-hex (<span class="kw">cadr</span> (<span class="kw">assq</span> &#39;signature (<span class="kw">cdr</span> manifest))))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        (id-file (<span class="kw">or</span> identity (vault-config &#39;age-identity))))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Require identity</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    (unless id-file</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> <span class="st">&quot;No age identity configured&quot;</span>))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Verify signature first (before decryption)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    (when verify-key</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let*</span> ((archive-bytes (read-file-bytes archive-file))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>             (archive-hash (sha512-hash archive-bytes))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>             (expected-hash (hex-&gt;blob hash-hex))</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>             (signature (hex-&gt;blob sig-hex))</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>             (pubkey (read-key-from-file verify-key)))</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        (unless (<span class="kw">equal?</span> archive-hash expected-hash)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">error</span> <span class="st">&quot;Archive hash mismatch&quot;</span>))</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        (unless (ed25519-verify pubkey archive-hash signature)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">error</span> <span class="st">&quot;Signature verification failed&quot;</span>))))</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Decrypt and extract: age -d | zstd -d | tar -x</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    (system (sprintf <span class="st">&quot;age -d -i ~a &lt; ~a | zstd -d | tar -xf - -C ~a&quot;</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>                    id-file archive-file target-dir))))</span></code></pre></div>
<hr />
<h2 id="usage-examples">Usage Examples</h2>
<h3 id="create-encrypted-archive">Create Encrypted Archive</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Configure recipients</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>(vault-config &#39;age-recipients</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="st">&quot;age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p&quot;</span>))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create archive</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>(seal-archive <span class="st">&quot;1.0.0&quot;</span> format: &#39;zstd-age)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; =&gt; vault-1.0.0.archive</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; =&gt; vault-1.0.0.archive.tar.zst.age</span></span></code></pre></div>
<h3 id="restore-encrypted-archive">Restore Encrypted Archive</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Configure identity</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>(vault-config &#39;age-identity <span class="st">&quot;~/.config/age/identity.txt&quot;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Restore with verification</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>(seal-restore <span class="st">&quot;vault-1.0.0.archive&quot;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>              verify-key: <span class="st">&quot;publisher.public&quot;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>              target: <span class="st">&quot;./restored&quot;</span>)</span></code></pre></div>
<h3 id="command-line-equivalents">Command Line Equivalents</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> archive <span class="at">--prefix</span><span class="op">=</span>vault/ 1.0.0 <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">zstd</span> <span class="at">-T0</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">age</span> <span class="at">-r</span> age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p <span class="dt">\</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;</span> vault-1.0.0.tar.zst.age</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Restore</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ex">age</span> <span class="at">-d</span> <span class="at">-i</span> ~/.config/age/identity.txt <span class="op">&lt;</span> vault-1.0.0.tar.zst.age <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">zstd</span> <span class="at">-d</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar</span> <span class="at">-xf</span> <span class="at">-</span></span></code></pre></div>
<hr />
<h2 id="migration">Migration</h2>
<h3 id="from-cryptographic-to-zstd-age">From Cryptographic to
Zstd-Age</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Re-archive existing releases with new format</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">for-each</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">lambda</span> (version)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    (seal-archive version format: &#39;zstd-age))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  (get-local-releases))</span></code></pre></div>
<h3 id="backward-compatibility">Backward Compatibility</h3>
<p>Both formats can coexist. The manifest <code>format</code> field
determines restoration method: - <code>(format cryptographic)</code> →
<code>seal-restore-cryptographic</code> - <code>(format zstd-age)</code>
→ <code>seal-restore-zstd-age</code></p>
<hr />
<h2 id="references">References</h2>
<ol type="1">
<li><a href="https://github.com/facebook/zstd">Zstd</a> - Facebook’s
compression algorithm</li>
<li><a href="https://age-encryption.org/">Age</a> - Modern encryption
tool</li>
<li><a href="rfc-006-vault-architecture.md">RFC-006</a> - Vault System
Architecture</li>
<li><a href="rfc-004-spki-authorization.md">RFC-004</a> - SPKI
Authorization</li>
</ol>
<hr />
<h2 id="changelog">Changelog</h2>
<ul>
<li><strong>2026-01-06</strong> - Initial specification</li>
</ul>
<hr />
<p><strong>Implementation Status:</strong> Complete
<strong>Compression:</strong> Zstd (parallel)
<strong>Encryption:</strong> Age (X25519 + ChaCha20-Poly1305)
<strong>Signature:</strong> Ed25519 (SPKI)</p>
</body>
</html>
