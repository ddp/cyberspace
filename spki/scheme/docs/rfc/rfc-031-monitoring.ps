%!PS-Adobe-3.0
%%Title: rfc-031-monitoring
%%Creator: Library of Cyberspace RFC Pipeline
%%Pages: (atend)
%%EndComments

/Courier findfont 10 scalefont setfont
/margin 72 def
/pagewidth 612 def
/pageheight 792 def
/leading 12 def
/topmargin pageheight margin sub def
/bottommargin margin def
/linewidth pagewidth margin 2 mul sub def
/ypos topmargin def
/pagenum 1 def

/newline {
  /ypos ypos leading sub def
  ypos bottommargin lt {
    showpage
    /pagenum pagenum 1 add def
    /ypos topmargin def
  } if
  margin ypos moveto
} def

margin topmargin moveto
(RFC-031: Monitoring and Observability) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
() show newline
(------------------------------------------------------------------------) show newline
(ABSTRACT) show newline
(------------------------------------------------------------------------) show newline
() show newline
(This RFC specifies monitoring and observability for the Library of) show newline
(Cyberspace: how vaults expose metrics, traces, and logs for operational) show newline
(visibility while maintaining privacy and security. Observability data is) show newline
(itself content-addressed and auditable.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(MOTIVATION) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Operating distributed systems requires visibility:) show newline
() show newline
(  * Health) show newline
(  * Is the vault functioning correctly?) show newline
(  * Performance) show newline
(  * How fast are operations?) show newline
(  * Capacity) show newline
(  * How much storage remains?) show newline
(  * Errors) show newline
(  * What's failing and why?) show newline
(  * Security) show newline
(  * Who's accessing what?) show newline
() show newline
(But observability must not compromise:) show newline
() show newline
(  * Privacy) show newline
(  * No sensitive data in metrics) show newline
(  * Security) show newline
(  * Metrics don't leak capabilities) show newline
(  * Performance) show newline
(  * Minimal overhead) show newline
(  * Storage) show newline
(  * Observability data is bounded) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(METRICS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Core Metrics) show newline
(------------) show newline
() show newline
() show newline
(    \(define vault-metrics) show newline
(      '\(;; Storage) show newline
(        \(storage.used.bytes gauge "Total bytes used"\)) show newline
(        \(storage.available.bytes gauge "Bytes available"\)) show newline
(        \(storage.objects.count gauge "Number of objects"\)) show newline
(        ;; Operations) show newline
(        \(cas.put.count counter "CAS put operations"\)) show newline
(        \(cas.put.bytes counter "Bytes written"\)) show newline
(        \(cas.put.duration histogram "Put latency"\)) show newline
(        \(cas.get.count counter "CAS get operations"\)) show newline
(        \(cas.get.bytes counter "Bytes read"\)) show newline
(        \(cas.get.duration histogram "Get latency"\)) show newline
(        ;; Soup) show newline
(        \(soup.queries.count counter "Soup queries"\)) show newline
(        \(soup.queries.duration histogram "Query latency"\)) show newline
(        \(soup.index.size.bytes gauge "Index size"\)) show newline
(        ;; Network) show newline
(        \(network.connections.active gauge "Active connections"\)) show newline
(        \(network.bytes.sent counter "Bytes sent"\)) show newline
(        \(network.bytes.received counter "Bytes received"\)) show newline
(        ;; Replication) show newline
(        \(replication.lag.seconds gauge "Replication lag"\)) show newline
(        \(replication.objects.pending gauge "Objects pending sync"\)) show newline
(        ;; Errors) show newline
(        \(errors.total counter "Total errors" labels: \(type\)\)) show newline
(        \(errors.rate gauge "Error rate per second"\)\)\)) show newline
() show newline
() show newline
(Metric Collection) show newline
(-----------------) show newline
() show newline
() show newline
(    \(define metrics-registry \(make-hash-table\)\)) show newline
(    \(define \(register-metric name type help #!key labels\)) show newline
(      \(hash-table-set! metrics-registry name) show newline
(        `\(\(type . ,type\)) show newline
(          \(help . ,help\)) show newline
(          \(labels . ,labels\)) show newline
(          \(value . ,\(case type) show newline
(                      \(\(counter\) 0\)) show newline
(                      \(\(gauge\) 0\)) show newline
(                      \(\(histogram\) \(make-histogram-buckets\)\)\)\)\)\)\)) show newline
(    \(define \(metric-inc! name #!key \(delta 1\) labels\)) show newline
(      \(let \(\(metric \(hash-table-ref metrics-registry name\)\)\)) show newline
(        \(case \(assoc-ref metric 'type\)) show newline
(          \(\(counter gauge\)) show newline
(           \(set! \(assoc-ref metric 'value\)) show newline
(                 \(+ \(assoc-ref metric 'value\) delta\)\)\)\)\)\)) show newline
(    \(define \(metric-set! name value #!key labels\)) show newline
(      \(let \(\(metric \(hash-table-ref metrics-registry name\)\)\)) show newline
(        \(set! \(assoc-ref metric 'value\) value\)\)\)) show newline
(    \(define \(metric-observe! name value #!key labels\)) show newline
(      \(let \(\(metric \(hash-table-ref metrics-registry name\)\)\)) show newline
(        \(histogram-observe! \(assoc-ref metric 'value\) value\)\)\)) show newline
() show newline
() show newline
(Histogram Buckets) show newline
(-----------------) show newline
() show newline
() show newline
(    \(define \(make-histogram-buckets\)) show newline
(      "Default latency buckets in milliseconds") show newline
(      \(let \(\(buckets '\(1 5 10 25 50 100 250 500 1000 2500 5000 10000\)\)\)) show newline
(        \(map \(lambda \(b\) \(cons b 0\)\) buckets\)\)\)) show newline
(    \(define \(histogram-observe! histogram value\)) show newline
(      \(for-each \(lambda \(bucket\)) show newline
(                  \(when \(<= value \(car bucket\)\)) show newline
(                    \(set-cdr! bucket \(+ \(cdr bucket\) 1\)\)\)\)) show newline
(                histogram\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(TRACING) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Trace Structure) show newline
(---------------) show newline
() show newline
() show newline
(    \(define \(make-trace operation\)) show newline
(      `\(trace) show newline
(        \(trace-id ,\(generate-trace-id\)\)) show newline
(        \(span-id ,\(generate-span-id\)\)) show newline
(        \(parent-span-id #f\)) show newline
(        \(operation ,operation\)) show newline
(        \(start-time ,\(current-time-ns\)\)) show newline
(        \(end-time #f\)) show newline
(        \(status pending\)) show newline
(        \(attributes \(\)\)) show newline
(        \(events \(\)\)\)\)) show newline
(    \(define \(trace-start! trace\)) show newline
(      \(set! \(assoc-ref trace 'start-time\) \(current-time-ns\)\)) show newline
(      trace\)) show newline
(    \(define \(trace-end! trace status\)) show newline
(      \(set! \(assoc-ref trace 'end-time\) \(current-time-ns\)\)) show newline
(      \(set! \(assoc-ref trace 'status\) status\)) show newline
(      \(record-trace! trace\)\)) show newline
() show newline
() show newline
(Span Context) show newline
(------------) show newline
() show newline
() show newline
(    \(define current-trace \(make-parameter #f\)\)) show newline
(    \(define current-span \(make-parameter #f\)\)) show newline
(    \(define \(with-span operation proc\)) show newline
(      "Execute proc within a traced span") show newline
(      \(let* \(\(parent \(current-span\)\)) show newline
(             \(span \(make-span operation \(and parent \(span-id parent\)\)\)\)\)) show newline
(        \(parameterize \(\(current-span span\)\)) show newline
(          \(span-start! span\)) show newline
(          \(guard \(ex) show newline
(                  \(else) show newline
(                   \(span-error! span ex\)) show newline
(                   \(span-end! span 'error\)) show newline
(                   \(raise ex\)\)\)) show newline
(            \(let \(\(result \(proc\)\)\)) show newline
(              \(span-end! span 'ok\)) show newline
(              result\)\)\)\)\)) show newline
(    ;; Example usage) show newline
(    \(define \(traced-cas-get hash\)) show newline
(      \(with-span "cas.get") show newline
(        \(lambda \(\)) show newline
(          \(span-set-attribute! "hash" hash\)) show newline
(          \(cas-get hash\)\)\)\)) show newline
() show newline
() show newline
(Distributed Tracing) show newline
(-------------------) show newline
() show newline
() show newline
(    ;; Propagate trace context across vault boundaries) show newline
(    \(define \(inject-trace-context headers\)) show newline
(      "Inject trace context into outgoing request") show newline
(      \(let \(\(span \(current-span\)\)\)) show newline
(        \(when span) show newline
(          \(hash-table-set! headers "X-Trace-Id" \(span-trace-id span\)\)) show newline
(          \(hash-table-set! headers "X-Span-Id" \(span-id span\)\)\)\)\)) show newline
(    \(define \(extract-trace-context headers\)) show newline
(      "Extract trace context from incoming request") show newline
(      \(let \(\(trace-id \(hash-table-ref headers "X-Trace-Id" #f\)\)) show newline
(            \(parent-span-id \(hash-table-ref headers "X-Span-Id" #f\)\)\)) show newline
(        \(when trace-id) show newline
(          \(current-trace trace-id\)) show newline
(          \(make-span-with-parent parent-span-id\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(LOGGING) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Structured Logging) show newline
(------------------) show newline
() show newline
() show newline
(    \(define \(log level message #!rest attributes\)) show newline
(      "Emit structured log entry") show newline
(      \(let \(\(entry `\(\(timestamp . ,\(current-time-iso8601\)\)) show newline
(                     \(level . ,level\)) show newline
(                     \(message . ,message\)) show newline
(                     \(vault . ,\(vault-id\)\)) show newline
(                     \(trace-id . ,\(and \(current-span\) \(span-trace-id \(current-span\)\)\)\)) show newline
(                     ,@\(plist->alist attributes\)\)\)\)) show newline
(        \(emit-log entry\)\)\)) show newline
(    \(define \(log-debug message . attrs\) \(apply log 'debug message attrs\)\)) show newline
(    \(define \(log-info message . attrs\) \(apply log 'info message attrs\)\)) show newline
(    \(define \(log-warn message . attrs\) \(apply log 'warn message attrs\)\)) show newline
(    \(define \(log-error message . attrs\) \(apply log 'error message attrs\)\)) show newline
(    ;; Example) show newline
(    \(log-info "Object stored") show newline
(              'hash hash) show newline
(              'size \(bytevector-length data\)) show newline
(              'duration-ms elapsed\)) show newline
() show newline
() show newline
(Log Levels) show newline
(----------) show newline
() show newline
() show newline
(    \(define log-levels '\(\(trace . 0\) \(debug . 1\) \(info . 2\)) show newline
(                         \(warn . 3\) \(error . 4\) \(fatal . 5\)\)\)) show newline
(    \(define current-log-level \(make-parameter 'info\)\)) show newline
(    \(define \(log-enabled? level\)) show newline
(      \(>= \(assoc-ref log-levels level\)) show newline
(          \(assoc-ref log-levels \(current-log-level\)\)\)\)) show newline
() show newline
() show newline
(Log Sinks) show newline
(---------) show newline
() show newline
() show newline
(    ;; Multiple output destinations) show newline
(    \(define log-sinks '\(\)\)) show newline
(    \(define \(add-log-sink! sink\)) show newline
(      \(set! log-sinks \(cons sink log-sinks\)\)\)) show newline
(    \(define \(emit-log entry\)) show newline
(      \(when \(log-enabled? \(assoc-ref entry 'level\)\)) show newline
(        \(for-each \(lambda \(sink\)) show newline
(                    \(sink-write sink entry\)\)) show newline
(                  log-sinks\)\)\)) show newline
(    ;; Sink implementations) show newline
(    \(define \(make-file-sink path\)) show newline
(      \(lambda \(entry\)) show newline
(        \(with-output-to-file path) show newline
(          \(lambda \(\) \(write-json entry\) \(newline\)\)) show newline
(          'append\)\)\)) show newline
(    \(define \(make-soup-sink\)) show newline
(      \(lambda \(entry\)) show newline
(        \(soup-put entry type: 'log-entry\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(HEALTH CHECKS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Health Endpoints) show newline
(----------------) show newline
() show newline
() show newline
(    \(define \(health-check\)) show newline
(      "Comprehensive health check") show newline
(      \(\(status . ,\(if \(all-healthy?\) 'healthy 'unhealthy\)\)) show newline
(        \(checks . \(\(storage . ,\(check-storage\)\)) show newline
(                   \(network . ,\(check-network\)\)) show newline
(                   \(replication . ,\(check-replication\)\)) show newline
(                   \(keys . ,\(check-keys\)\)\)\)\)\)) show newline
(    \(define \(check-storage\)) show newline
(      \(\(status . ,\(if \(storage-accessible?\) 'healthy 'unhealthy\)\)) show newline
(        \(used . ,\(storage-used\)\)) show newline
(        \(available . ,\(storage-available\)\)) show newline
(        \(percent . ,\(storage-percent-used\)\)\)\)) show newline
(    \(define \(check-network\)) show newline
(      \(\(status . ,\(if \(network-healthy?\) 'healthy 'unhealthy\)\)) show newline
(        \(peers . ,\(connected-peer-count\)\)) show newline
(        \(latency-ms . ,\(average-peer-latency\)\)\)\)) show newline
(    \(define \(check-replication\)) show newline
(      \(\(status . ,\(if \(replication-healthy?\) 'healthy 'unhealthy\)\)) show newline
(        \(lag-seconds . ,\(replication-lag\)\)) show newline
(        \(pending . ,\(pending-replication-count\)\)\)\)) show newline
() show newline
() show newline
(Readiness vs Liveness) show newline
(---------------------) show newline
() show newline
() show newline
(    ;; Liveness: is the process running?) show newline
(    \(define \(liveness-check\)) show newline
(      '\(\(status . alive\)\)\)) show newline
(    ;; Readiness: can we serve requests?) show newline
(    \(define \(readiness-check\)) show newline
(      \(if \(and \(storage-accessible?\)) show newline
(               \(keys-available?\)) show newline
(               \(not \(vault-readonly?\)\)\)) show newline
(          '\(\(status . ready\)\)) show newline
(          '\(\(status . not-ready\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(ALERTING) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Alert Rules) show newline
(-----------) show newline
() show newline
() show newline
(    \(define alert-rules) show newline
(      `\(\(storage-critical) show newline
(         \(condition \(> \(metric-value 'storage.percent.used\) 95\)\)) show newline
(         \(severity critical\)) show newline
(         \(message "Storage critically low"\)\)) show newline
(        \(storage-warning) show newline
(         \(condition \(> \(metric-value 'storage.percent.used\) 80\)\)) show newline
(         \(severity warning\)) show newline
(         \(message "Storage running low"\)\)) show newline
(        \(error-rate-high) show newline
(         \(condition \(> \(metric-value 'errors.rate\) 10\)\)) show newline
(         \(severity warning\)) show newline
(         \(message "High error rate detected"\)\)) show newline
(        \(replication-lag) show newline
(         \(condition \(> \(metric-value 'replication.lag.seconds\) 300\)\)) show newline
(         \(severity warning\)) show newline
(         \(message "Replication lag exceeds 5 minutes"\)\)) show newline
(        \(peer-disconnected) show newline
(         \(condition \(< \(metric-value 'network.peers.connected\) 1\)\)) show newline
(         \(severity critical\)) show newline
(         \(message "No peers connected"\)\)\)\)) show newline
() show newline
() show newline
(Alert Evaluation) show newline
(----------------) show newline
() show newline
() show newline
(    \(define \(evaluate-alerts\)) show newline
(      "Check all alert conditions") show newline
(      \(filter-map) show newline
(        \(lambda \(rule\)) show newline
(          \(when \(eval-condition \(assoc-ref rule 'condition\)\)) show newline
(            \(fire-alert rule\)\)\)) show newline
(        alert-rules\)\)) show newline
(    \(define \(fire-alert rule\)) show newline
(      \(let \(\(alert `\(\(name . ,\(car rule\)\)) show newline
(                     \(severity . ,\(assoc-ref \(cdr rule\) 'severity\)\)) show newline
(                     \(message . ,\(assoc-ref \(cdr rule\) 'message\)\)) show newline
(                     \(timestamp . ,\(current-time\)\)\)\)\)) show newline
(        \(audit-append action: 'alert-fired alert: alert\)) show newline
(        \(notify-alert alert\)) show newline
(        alert\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(DASHBOARDS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Metric Export) show newline
(-------------) show newline
() show newline
() show newline
(    ;; Prometheus format) show newline
(    \(define \(export-prometheus\)) show newline
(      \(with-output-to-string) show newline
(        \(lambda \(\)) show newline
(          \(for-each) show newline
(            \(lambda \(metric\)) show newline
(              \(let \(\(name \(car metric\)\)) show newline
(                    \(data \(cdr metric\)\)\)) show newline
(                \(format #t "# HELP ~a ~a~%" name \(assoc-ref data 'help\)\)) show newline
(                \(format #t "# TYPE ~a ~a~%" name \(assoc-ref data 'type\)\)) show newline
(                \(format #t "~a ~a~%" name \(assoc-ref data 'value\)\)\)\)) show newline
(            \(hash-table->alist metrics-registry\)\)\)\)\)) show newline
() show newline
() show newline
(Status Page) show newline
(-----------) show newline
() show newline
() show newline
(    \(define \(status-page\)) show newline
(      "Generate human-readable status") show newline
(      `\(vault-status) show newline
(        \(health . ,\(health-check\)\)) show newline
(        \(uptime . ,\(vault-uptime\)\)) show newline
(        \(version . ,\(vault-version\)\)) show newline
(        \(metrics . \(\(storage . ,\(storage-metrics\)\)) show newline
(                    \(operations . ,\(operation-metrics\)\)) show newline
(                    \(network . ,\(network-metrics\)\)\)\)) show newline
(        \(recent-errors . ,\(recent-errors 10\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(PRIVACY) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Metric Sanitization) show newline
(-------------------) show newline
() show newline
() show newline
(    ;; Never expose sensitive data in metrics) show newline
(    \(define \(sanitize-metric-labels labels\)) show newline
(      \(map \(lambda \(label\)) show newline
(             \(case \(car label\)) show newline
(               \(\(hash\) \(cons 'hash "[REDACTED]"\)\)) show newline
(               \(\(principal\) \(cons 'principal \(hash-principal \(cdr label\)\)\)\)) show newline
(               \(else label\)\)\)) show newline
(           labels\)\)) show newline
(    \(define \(safe-metric name value #!key labels\)) show newline
(      \(metric-set! name value labels: \(sanitize-metric-labels labels\)\)\)) show newline
() show newline
() show newline
(Aggregate Metrics Only) show newline
(----------------------) show newline
() show newline
() show newline
(    ;; Expose only aggregates, not individual operations) show newline
(    \(define \(operation-metrics\)) show newline
(      `\(\(total-operations . ,\(metric-value 'cas.operations.total\)\)) show newline
(        \(operations-per-second . ,\(metric-value 'cas.operations.rate\)\)) show newline
(        \(average-latency-ms . ,\(metric-value 'cas.latency.average\)\)) show newline
(        \(p99-latency-ms . ,\(metric-value 'cas.latency.p99\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(STORAGE) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Metric Retention) show newline
(----------------) show newline
() show newline
() show newline
(    ;; Metrics stored in soup with TTL) show newline
(    \(define metric-retention \( 30 24 3600\)\)  ; 30 days) show newline
(    \(define \(store-metric-snapshot\)) show newline
(      "Periodic metric snapshot") show newline
(      \(let \(\(snapshot `\(\(timestamp . ,\(current-time\)\)) show newline
(                        \(metrics . ,\(export-all-metrics\)\)\)\)\)) show newline
(        \(soup-put snapshot) show newline
(          type: 'metric-snapshot) show newline
(          ttl: metric-retention\)\)\)) show newline
(    \(define \(gc-old-metrics\)) show newline
(      "Remove expired metric snapshots") show newline
(      \(let \(\(expired \(soup-query type: 'metric-snapshot) show newline
(                                 timestamp: \(< \(- \(current-time\) metric-retention*\)\)\)\)\)) show newline
(        \(for-each soup-delete! expired\)\)\)) show newline
() show newline
() show newline
(Trace Sampling) show newline
(--------------) show newline
() show newline
() show newline
(    ;; Sample traces to control storage) show newline
(    \(define trace-sample-rate 0.1\)  ; 10%) show newline
(    \(define \(should-sample-trace?\)) show newline
(      \(< \(random 1.0\) trace-sample-rate\)\)) show newline
(    \(define \(record-trace! trace\)) show newline
(      \(when \(or \(trace-has-error? trace\)) show newline
(                \(should-sample-trace?\)\)) show newline
(        \(soup-put trace type: 'trace\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(REFERENCES) show newline
(------------------------------------------------------------------------) show newline
() show newline
(1. [OpenTelemetry]\(https://opentelemetry.io/\) - Observability framework) show newline
(2. [Prometheus]\(https://prometheus.io/\) - Monitoring system 3. [RFC-003:) show newline
(Cryptographic Audit Trail]\(rfc-003-audit-trail.html\) 4. [RFC-028: Error) show newline
(Handling]\(rfc-028-error-handling.html\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(CHANGELOG) show newline
(------------------------------------------------------------------------) show newline
() show newline
(  * 2026-01-07) show newline
(  * Initial draft) show newline
() show newline
(------------------------------------------------------------------------) show newline

showpage
%%Trailer
%%Pages: pagenum
%%EOF
