%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Sun Jan 11 10:41:55 2026
%%DocumentNeededResources: font Times-Bold
%%+ font Times-Italic
%%+ font Times-Roman
%%+ font Courier
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 15
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Italic
%%IncludeResource: font Times-Roman
%%IncludeResource: font Courier
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Courier@0 ENC0/Courier RE/Times-Roman@0 ENC0/Times-Roman RE
/Times-Italic@0 ENC0/Times-Italic RE/Times-Bold@0 ENC0/Times-Bold RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF(RFC-025: Soup Query Language)221.496 123 Q/F1 10
/Times-Italic@0 SF(Libr)260.85 159 Q(ary of Cyber)-.15 E(space)-.1 E/F2
10/Times-Roman@0 SF(2026)296 177 Q F1(ABSTRA)282.535 213 Q(CT)-.3 E/F3
10/Times-Bold@0 SF 2.5(1. Abstract)72 261 R F2 .162(This RFC speci\214e\
s the query language for the Library of Cyberspace soup: ho)72 276.6 R
2.662(wp)-.25 G .161(rincipals search, \214lter)-2.662 F 2.661(,a)-.4 G
.161(nd retrie)-2.661 F -.15(ve)-.25 G 1.234(objects from the content-a\
ddressed store using the rich metadata layer. Queries are themselv)72
288.6 R 1.234(es content-addressed)-.15 F(and auditable.)72 300.6 Q F3
2.5(2. Moti)72 324.6 R -.1(va)-.1 G(tion).1 E F2(The soup contains in\
\214nite metadata. Finding needles requires a query language that is:)72
340.2 Q 2.717(-E)72 355.8 S(xpressi)-2.717 E .517 -.15(ve - C)-.25 H
(omple).15 E 2.717(xp)-.15 G .217(redicates, joins across objects - Ef)
-2.717 F .217(\214cient - Inde)-.25 F -.15(xe)-.15 G .216
(s, bloom \214lters, query planning - Secure -).15 F
(Queries respect capability boundaries - Auditable - Query patterns re)
72 367.8 Q -.15(ve)-.25 G(al access patterns).15 E(Ne)72 383.4 Q(wton')
-.25 E 2.5(ss)-.55 G(oup had cursor)-2.5 E(-based queries. W)-.2 E 2.5
(ee)-.8 G(xtend this with content-addressed semantics.)-2.65 E F3 2.5
(3. Query)72 407.4 R(Model)2.5 E 2.5(3.1. Basic)72 431.4 R(Queries)2.5 E
/F4 8/Courier@0 SF(;; Find by type)108 449.4 Q
(\(soup-query type: 'document\))108 461.4 Q(;; Find by attribute)108
485.4 Q(\(soup-query author: "alice@example.com"\))108 497.4 Q
(;; Find by multiple attributes \(AND\))108 521.4 Q
(\(soup-query type: 'document)108 533.4 Q(author: "alice@example.com")
165.6 545.4 Q(created-after: "2026-01-01"\))165.6 557.4 Q
(;; Find by content hash)108 581.4 Q
(\(soup-query hash: "sha256:7f83b1657ff1fc..."\))108 593.4 Q 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(3.2. Query)72 84 R(Results)2.5 E/F2 8/Courier@0 SF
(;; Results are lazy cursors)108 102 Q
(\(define results \(soup-query type: 'document\)\))108 114 Q(;; Iterate)
108 138 Q(\(soup-cursor-next results\))108 150 Q 4.8(;=)19.2 G 4.8(>s)
-4.8 G(oup-object or #f)-4.8 E(\(soup-cursor-peek results\))108 162 Q
4.8(;=)19.2 G 4.8(>n)-4.8 G(ext without advancing)-4.8 E
(\(soup-cursor-reset results\))108 174 Q 4.8(;=)14.4 G 4.8(>b)-4.8 G
(ack to beginning)-4.8 E(;; Collect \(careful with large result sets\))
108 198 Q(\(soup-cursor->list results\))108 210 Q 4.8(;=)14.4 G 4.8(>l)
-4.8 G(ist of soup-objects)-4.8 E(\(soup-cursor-count results\))108 222
Q 4.8(;=)14.4 G 4.8(>t)-4.8 G(otal count)-4.8 E F1 2.5(3.3. Pr)72 240 R
(edicates)-.18 E F2(;; Comparison operators)108 258 Q
(\(soup-query size: \(> 1000000\)\))108 270 Q 4.8(;l)52.8 G
(arger than 1MB)-4.8 E(\(soup-query created: \(< "2025-01-01"\)\))108
282 Q 4.8(;b)14.4 G(efore 2025)-4.8 E
(\(soup-query name: \(like "rfc-*"\)\))108 294 Q 4.8(;g)38.4 G
(lob pattern)-4.8 E(\(soup-query tags: \(contains "urgent"\)\))108 306 Q
4.8(;l)14.4 G(ist membership)-4.8 E(;; Logical operators)108 330 Q
(\(soup-query \(and \(type: 'document\))108 342 Q
(\(or \(author: "alice"\))189.6 354 Q(\(author: "bob"\)\)\)\))208.8 366
Q(;; Negation)108 390 Q(\(soup-query \(not \(type: 'tombstone\)\)\))108
402 Q(;; Existence)108 426 Q(\(soup-query \(exists 'encryption-key\)\))
108 438 Q 4.8(;h)19.2 G(as attribute)-4.8 E
(\(soup-query \(missing 'expires\)\))108 450 Q 4.8(;l)48 G
(acks attribute)-4.8 E F1 2.5(4. Adv)72 468 R(anced Queries)-.1 E 2.5
(4.1. Range)72 492 R(Queries)2.5 E F2(;; Numeric ranges)108 510 Q
(\(soup-query size: \(between 1000 10000\)\))108 522 Q(;; Date ranges)
108 546 Q(\(soup-query created: \(between "2026-01-01" "2026-12-31"\)\))
108 558 Q(;; Lexicographic ranges)108 582 Q
(\(soup-query name: \(between "rfc-010" "rfc-020"\)\))108 594 Q 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(4.2. Full-T)72 84 R(ext Sear)-.92 E(ch)-.18 E/F2 8/Courier@0 SF
(;; Search indexed content)108 102 Q
(\(soup-query \(text-search "capability delegation"\)\))108 114 Q
(;; With highlighting)108 138 Q
(\(soup-query \(text-search "SPKI certificate"\))108 150 Q
(highlight: #t\))165.6 162 Q(;; Phrase search)108 186 Q
(\(soup-query \(text-search "\\"monotonic attenuation\\""\)\))108 198 Q
(;; Fuzzy search)108 222 Q(\(soup-query \(text-search "delgation~"\)\))
108 234 Q 4.8(;t)9.6 G(ypo-tolerant)-4.8 E F1 2.5(4.3. Refer)72 252 R
(ence T)-.18 E(ra)-.74 E -.1(ve)-.25 G(rsal).1 E F2
(;; Objects referencing this hash)108 270 Q
(\(soup-query references: "sha256:target..."\))108 282 Q
(;; Objects referenced by this hash)108 306 Q
(\(soup-query referenced-by: "sha256:source..."\))108 318 Q
(;; Transitive closure \(careful - can be huge\))108 342 Q
(\(soup-query \(transitive-references "sha256:root..."\))108 354 Q
(max-depth: 3\))165.6 366 Q F1 2.5(4.4. T)72 384 R(emporal Queries)-.92
E F2(;; Objects as they existed at a point in time)108 402 Q
(\(soup-query type: 'document)108 414 Q(as-of: "2026-01-01T00:00:00Z"\))
165.6 426 Q(;; Objects modified in time window)108 450 Q
(\(soup-query modified: \(between "2026-01-01" "2026-01-07"\)\))108 462
Q(;; Version history)108 486 Q
(\(soup-query \(versions-of "sha256:current..."\)\))108 498 Q F1 2.5
(5. Query)72 516 R(Composition)2.5 E 2.5(5.1. Subqueries)72 540 R F2
(;; Objects authored by members of a group)108 558 Q
(\(soup-query author: \(soup-query type: 'principal)108 570 Q
(member-of: "engineering"\)\))261.6 582 Q
(;; Documents referencing any RFC)108 606 Q
(\(soup-query type: 'document)108 618 Q
(references: \(soup-query name: \(like "rfc-*"\)\)\))165.6 630 Q 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(5.2. Aggr)72 84 R(egation)-.18 E/F2 8/Courier@0 SF(;; Count by type)
108 102 Q(\(soup-aggregate)108 114 Q(group-by: 'type)117.6 126 Q
(aggregate: \(count\)\))117.6 138 Q(;; Total size by author)108 162 Q
(\(soup-aggregate)108 174 Q(group-by: 'author)117.6 186 Q
(aggregate: \(sum 'size\)\))117.6 198 Q(;; Average document size)108 222
Q(\(soup-aggregate)108 234 Q(where: \(type: 'document\))117.6 246 Q
(aggregate: \(avg 'size\)\))117.6 258 Q(;; Distinct values)108 282 Q
(\(soup-aggregate)108 294 Q(aggregate: \(distinct 'content-type\)\))
117.6 306 Q F1 2.5(5.3. Ordering)72 324 R(and P)2.5 E(agination)-.1 E F2
(;; Sort by creation date, newest first)108 342 Q
(\(soup-query type: 'document)108 354 Q
(order-by: '\(\(created desc\)\)\))165.6 366 Q(;; Multi-column sort)108
390 Q(\(soup-query type: 'document)108 402 Q
(order-by: '\(\(author asc\) \(created desc\)\)\))165.6 414 Q
(;; Pagination)108 438 Q(\(soup-query type: 'document)108 450 Q
(order-by: '\(\(created desc\)\))165.6 462 Q(limit: 20)165.6 474 Q
(offset: 40\))165.6 486 Q(;; Cursor-based pagination \(more efficient\))
108 510 Q(\(soup-query type: 'document)108 522 Q
(order-by: '\(\(created desc\)\))165.6 534 Q
(after: "sha256:last-seen..."\))165.6 546 Q F1 2.5(6. Capability-A)72
564 R(war)-.9 E 2.5(eQ)-.18 G(ueries)-2.5 E 2.5(6.1. Query)72 588 R
(Filtering)2.5 E F0(Queries automatically \214lter results based on the\
 querying principal')72 603.6 Q 2.5(sc)-.55 G(apabilities:)-2.5 E F2
(\(define \(soup-query-with-caps query principal\))108 621.6 Q
("Execute query filtered by principal's capabilities")117.6 633.6 Q
(\(let* \(\(raw-results \(execute-query query\)\))117.6 645.6 Q
(\(caps \(principal-capabilities principal\)\)\))151.2 657.6 Q
(\(filter \(lambda \(obj\))127.2 669.6 Q
(\(can-read? principal obj caps\)\))175.2 681.6 Q(raw-results\)\)\))
165.6 693.6 Q 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(6.2. Capability)72 84 R(Queries)2.5 E/F2 8/Courier@0 SF
(;; What can I access?)108 102 Q
(\(soup-query \(accessible-by \(current-principal\)\)\))108 114 Q
(;; Who can access this?)108 138 Q(\(soup-query type: 'certificate)108
150 Q(grants-access-to: "sha256:target..."\))165.6 162 Q
(;; Find my capabilities)108 186 Q(\(soup-query type: 'certificate)108
198 Q(subject: \(current-principal\)\))165.6 210 Q F1 2.5(6.3. Query)72
228 R -.5(Au)2.5 G(thorization).5 E F2
(;; Some queries require explicit capability)108 246 Q
(\(soup-query type: 'audit-log\))108 258 Q 4.8(;r)9.6 G
(equires audit-read capability)-4.8 E(;; Query capability certificate)
108 282 Q(\(spki-cert)108 294 Q(\(issuer vault-admin\))117.6 306 Q
(\(subject auditor-key\))117.6 318 Q(\(capability)117.6 330 Q
(\(action query\))127.2 342 Q(\(object \(type 'audit-log\)\)\))127.2 354
Q(\(validity \(not-after "2027-01-01"\)\)\))117.6 366 Q F1 2.5
(7. Indexes)72 384 R 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(7.1. Index)72 84 R -.34(Ty)2.5 G(pes).34 E/F2 8/Courier@0 SF
(;; B-tree index \(ordered, range queries\))108 102 Q
(\(define-index 'created-idx)108 114 Q(type: 'btree)117.6 126 Q
(on: 'created\))117.6 138 Q(;; Hash index \(equality only, faster\))108
162 Q(\(define-index 'hash-idx)108 174 Q(type: 'hash)117.6 186 Q
(on: 'content-hash\))117.6 198 Q(;; Full-text index \(search\))108 222 Q
(\(define-index 'content-idx)108 234 Q(type: 'fulltext)117.6 246 Q
(on: 'content)117.6 258 Q(language: 'english\))117.6 270 Q
(;; Composite index)108 294 Q(\(define-index 'author-date-idx)108 306 Q
(type: 'btree)117.6 318 Q(on: '\(author created\)\))117.6 330 Q
(;; Bloom filter index \(membership testing\))108 354 Q
(\(define-index 'tags-bloom)108 366 Q(type: 'bloom)117.6 378 Q
(on: 'tags)117.6 390 Q(false-positive-rate: 0.01\))117.6 402 Q F1 2.5
(7.2. Cost-Based)72 420 R(Index Selection)2.5 E F0
(Query planning uses Selinger)72 435.6 Q
(-style cost estimation to select optimal e)-.2 E -.15(xe)-.15 G
(cution plans. The optimizer considers:).15 E 2.773(-C)72 451.2 S .273
(ardinality estimation: Ho)-2.773 F 2.773(wm)-.25 G(an)-2.773 E 2.773
(yr)-.15 G -.25(ow)-2.773 G 2.773(sw).25 G .273
(ill each predicate return? - Inde)-2.773 F 2.773(xs)-.15 G(electi)
-2.773 E .273(vity: Ho)-.25 F 2.773(wd)-.25 G .274
(iscriminating is each)-2.773 F(inde)72 463.2 Q 1.261(x? - I/O cost: Se\
quential scan vs. random access - Join ordering: Which order minimizes \
intermediate result)-.15 F 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R(sizes?)72 84 Q/F1 8
/Courier@0 SF(;; Cardinality estimation using histograms)108 102 Q
(\(define \(estimate-cardinality predicate index-stats\))108 114 Q
("Estimate result size for predicate")117.6 126 Q
(\(let \(\(histogram \(index-histogram index-stats\)\)\))117.6 138 Q
(\(case \(predicate-type predicate\))127.2 150 Q(\(\(equality\))136.8
162 Q(;; Use histogram bucket counts)141.6 174 Q
(\(histogram-point-estimate histogram \(predicate-value predicate\)\)\))
141.6 186 Q(\(\(range\))136.8 198 Q(;; Sum histogram buckets in range)
141.6 210 Q(\(histogram-range-estimate histogram)141.6 222 Q
(\(predicate-low predicate\))271.2 234 Q
(\(predicate-high predicate\)\)\))271.2 246 Q(\(\(like\))136.8 258 Q
(;; Estimate based on prefix selectivity)141.6 270 Q 4.8(\(\()141.6 282
S(total-rows index-stats\))-4.8 E
(\(prefix-selectivity \(predicate-pattern predicate\)\)\)\))156 294 Q
(\(else)136.8 306 Q(;; Conservative estimate: 10% of total)141.6 318 Q
4.8(\(0)141.6 330 S(.1 \(total-rows index-stats\)\)\)\)\)\))-4.8 E
(;; Cost model for execution plans)108 354 Q
(\(define \(plan-cost plan index-stats\))108 366 Q
("Estimate total cost in I/O operations")117.6 378 Q(\(let \(\(cardinal\
ity \(estimate-cardinality \(plan-predicate plan\) index-stats\)\)\))
117.6 390 Q(\(case \(plan-access-method plan\))127.2 402 Q
(\(\(full-scan\))136.8 414 Q(;; Sequential I/O: count all pages)141.6
426 Q(\(total-pages index-stats\)\))141.6 438 Q(\(\(index-scan\))136.8
450 Q(;; Random I/O: estimated rows + index traversal)141.6 462 Q
(\(+ \(log2 \(total-rows index-stats\)\))141.6 474 Q 4.8(;B)9.6 G
(-tree depth)-4.8 E 96(cardinality\)\) ;)156 486 R(Heap fetches)4.8 E
(\(\(index-only\))136.8 498 Q(;; No heap access needed)141.6 510 Q
(\(log2 \(total-rows index-stats\)\)\))141.6 522 Q(\(\(bloom-filter\))
136.8 534 Q(;; O\(k\) hash operations, negligible I/O)141.6 546 Q 4.8
(\(0)141.6 558 S(.001 cardinality\)\)\)\)\))-4.8 E
(;; Dynamic programming for join ordering)108 582 Q
(\(define \(optimize-join-order predicates indexes\))108 594 Q
("Find optimal join order using Selinger algorithm")117.6 606 Q
(\(let \(\(memo \(make-hash-table\)\)\))117.6 618 Q
(\(define \(best-plan preds\))127.2 630 Q(\(cond)136.8 642 Q
(\(\(null? preds\) \(empty-plan\)\))146.4 654 Q
(\(\(hash-table-exists? memo preds\))146.4 666 Q
(\(hash-table-ref memo preds\)\))151.2 678 Q(\(else)146.4 690 Q
(\(let \(\(candidates)151.2 702 Q(\(map \(lambda \(p\))189.6 714 Q
(\(let \(\(rest \(delete p preds\)\)\))223.2 726 Q 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 8/Courier@0 SF
(\(join-plans \(single-predicate-plan p\))232.8 84 Q
(\(best-plan rest\)\)\)\))290.4 96 Q(preds\)\))213.6 108 Q
(\(best \(minimum-by plan-cost candidates\)\)\))184.8 120 Q
(\(hash-table-set! memo preds best\))160.8 132 Q(best\)\)\)\))160.8 144
Q(\(best-plan predicates\)\)\))127.2 156 Q
(;; Select best index for query)108 180 Q
(\(define \(plan-query query indexes\))108 192 Q
("Generate optimal query plan using cost-based optimization")117.6 204 Q
(\(let \(\(predicates \(query-predicates query\)\))117.6 216 Q
(\(stats \(map index-statistics indexes\)\))151.2 228 Q
(;; Generate candidate plans)151.2 240 Q(\(candidates)151.2 252 Q
(\(append)156 264 Q(;; Try each applicable index)160.8 276 Q
(\(filter-map \(lambda \(idx stat\))160.8 288 Q
(\(and \(index-covers? idx predicates\))223.2 300 Q
(\(make-plan 'index-scan idx)247.2 312 Q
(\(plan-cost-for idx predicates stat\)\)\)\))300 324 Q(indexes stats\))
213.6 336 Q(;; Always consider full scan)160.8 348 Q(\(list \(make-plan\
 'full-scan #f \(full-scan-cost predicates stats\)\)\)\)\))160.8 360 Q
(;; Select minimum cost plan)151.2 372 Q
(\(best \(minimum-by plan-cost candidates\)\)\))151.2 384 Q
(\(when \(> \(plan-cost best\) query-cost-warning-threshold*\))127.2 396
Q(\(log-warning "Expensive query plan" query \(plan-cost best\)\)\))
136.8 408 Q(best\)\))127.2 420 Q 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(7.3. Histogram)72 84 R(Maintenance)2.5 E/F2 8/Courier@0 SF
(;; Equi-depth histograms for cardinality estimation)108 102 Q
(\(define \(build-histogram values num-buckets\))108 114 Q
("Build equi-depth histogram for cardinality estimation")117.6 126 Q
(\(let \(\(sorted \(sort values <\)\))117.6 138 Q
(\(bucket-size \(ceiling \(/ \(length sorted\) num-buckets\)\)\))151.2
150 Q(\(boundaries \(map \(lambda \(i\))151.2 162 Q
(\(list-ref sorted \( i bucket-size\)\)\))237.6 174 Q
(\(iota num-buckets\)\)\)\))228 186 Q
(\(make-histogram boundaries \(/ \(length sorted\) num-buckets\)\)\)\))
127.2 198 Q(;; Update histogram incrementally)108 222 Q
(\(define \(histogram-update! hist value\))108 234 Q
("Incrementally update histogram with new value")117.6 246 Q
(\(let \(\(bucket \(find-bucket hist value\)\)\))117.6 258 Q
(\(bucket-increment! bucket\)\)\))127.2 270 Q(;; Statistics refresh)108
294 Q(\(define \(refresh-index-statistics idx\))108 306 Q
("Rebuild index statistics \(run periodically\)")117.6 318 Q
(\(let* \(\(samples \(index-sample idx 10000\)\))117.6 330 Q 4.8(;S)9.6
G(ample 10K rows)-4.8 E(\(histogram \(build-histogram samples 100\)\)\))
151.2 342 Q(\(set-index-statistics! idx)127.2 354 Q(\(make-stats)136.8
366 Q(\(total-rows \(index-count idx\)\))146.4 378 Q
(\(distinct-values \(length \(delete-duplicates samples\)\)\))146.4 390
Q(\(histogram histogram\))146.4 402 Q
(\(last-analyzed \(current-time\)\)\)\)\)\))146.4 414 Q F1 2.5
(7.4. Index)72 432 R(Maintenance)2.5 E F2
(;; Indexes are updated on soup-put)108 450 Q
(\(define \(soup-put-indexed obj\))108 462 Q
(\(let \(\(hash \(soup-put obj\)\)\))117.6 474 Q
(\(for-each \(lambda \(idx\))127.2 486 Q
(\(index-insert! idx obj hash\)\))184.8 498 Q
(\(applicable-indexes obj\)\))175.2 510 Q(hash\)\))127.2 522 Q
(;; Periodic index optimization)108 546 Q(\(define \(optimize-indexes\))
108 558 Q(\(for-each index-compact! \(all-indexes\)\)\))117.6 570 Q F1
2.5(8. Query)72 588 R(Execution)2.5 E 0 Cg EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(8.1. Query)72 84 R(Planning)2.5 E/F2 8/Courier@0 SF
(\(define \(execute-query query\))108 102 Q("Plan and execute query")
117.6 114 Q(\(let \(\(plan \(plan-query query\)\))117.6 126 Q
(\(cost \(estimate-cost plan\)\)\))151.2 138 Q
(\(when \(> cost query-cost-limit*\))127.2 150 Q
(\(error "Query too expensive" cost\)\))136.8 162 Q
(\(execute-plan plan\)\)\))127.2 174 Q(\(define \(plan-query query\))108
198 Q("Generate query execution plan")117.6 210 Q(`\(query-plan)117.6
222 Q(\(predicates ,\(query-predicates query\)\))127.2 234 Q
(\(index ,\(select-index query\)\))127.2 246 Q
(\(filter ,\(remaining-predicates query\)\))127.2 258 Q
(\(order ,\(query-order query\)\))127.2 270 Q
(\(limit ,\(query-limit query\)\)\)\))127.2 282 Q F1 2.5(8.2. Execution)
72 300 R(Strategies)2.5 E F2(;; Index scan)108 318 Q
(\(define \(index-scan index predicate\))108 330 Q
(\(index-range-query index)117.6 342 Q
(\(predicate-lower-bound predicate\))208.8 354 Q
(\(predicate-upper-bound predicate\)\)\))208.8 366 Q
(;; Full scan \(last resort\))108 390 Q
(\(define \(full-scan predicate\))108 402 Q
(\(filter predicate \(all-soup-objects\)\)\))117.6 414 Q
(;; Index intersection)108 438 Q
(\(define \(index-intersect idx1 idx2 pred1 pred2\))108 450 Q
(\(set-intersection)117.6 462 Q(\(index-scan idx1 pred1\))127.2 474 Q
(\(index-scan idx2 pred2\)\)\))127.2 486 Q F1 2.5(8.3. Query)72 504 R
(Caching)2.5 E 0 Cg EP
%%Page: 11 11
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R(The soup is archi)72 84
Q -.25(va)-.25 G 2.5(l-o).25 G(bjects rarely change, making aggressi)
-2.5 E .3 -.15(ve c)-.25 H(aching safe.).15 E/F1 8/Courier@0 SF
(;; Multi-tier cache: L1 hot results, L2 warm, L3 persistent)108 102 Q
(\(define l1-cache \(make-lru-cache 100\)\))108 114 Q 4.8(;I)19.2 G
(n-memory, microseconds)-4.8 E
(\(define l2-cache \(make-lru-cache 10000\)\))108 126 Q 4.8(;W)9.6 G
(arm, milliseconds)-4.8 E(\(define l3-cache 'persistent-index\))108 138
Q 4.8(;O)38.4 G(n-disk, query index)-4.8 E
(\(define \(cached-query query principal\))108 162 Q
("Multi-tier cached query with capability awareness")117.6 174 Q
(\(let \(\(key \(query-cache-key query principal\)\)\))117.6 186 Q
(\(or \(lru-get l1-cache key\))127.2 198 Q(\(lru-get l2-cache key\))
146.4 210 Q(\(persistent-cache-get l3-cache key\))146.4 222 Q
(\(let \(\(result \(execute-query query\)\)\))146.4 234 Q
(;; Promote to appropriate cache tier based on cost)156 246 Q
(\(let \(\(cost \(query-cost query\)\)\))156 258 Q(\(cond)165.6 270 Q
(\(\(> cost 1000\) \(persistent-cache-put! l3-cache key result\)\))175.2
282 Q(\(\(> cost 100\) \(lru-put! l2-cache key result\)\))175.2 294 Q
(\(else \(lru-put! l1-cache key result\)\)\)\))175.2 306 Q
(result\)\)\)\))156 318 Q F0(#### Dependenc)72 336 Q(y-Based In)-.15 E
-.25(va)-.4 G(lidation).25 E -.35(Tr)72 351.6 S(ack which predicates af)
.35 E(fect which cached queries using Bloom \214lters:)-.25 E F1
(;; Bloom filter tracking which attributes affect cached queries)108
369.6 Q(\(define query-dependencies \(make-counting-bloom-filter 100000\
 0.001\)\))108 381.6 Q(\(define \(cache-with-deps query result\))108
405.6 Q("Cache query and track its dependencies")117.6 417.6 Q
(\(let \(\(key \(query->hash query\)\))117.6 429.6 Q
(\(deps \(query-attribute-deps query\)\)\))146.4 441.6 Q
(\(lru-put! query-cache key result\))127.2 453.6 Q
(;; Track dependencies)127.2 465.6 Q(\(for-each \(lambda \(attr\))127.2
477.6 Q(\(bloom-add! query-dependencies \(cons attr key\)\)\))184.8
489.6 Q(deps\)\)\))175.2 501.6 Q(\(define \(invalidate-on-change obj\))
108 525.6 Q
("Invalidate only queries that MIGHT be affected \(conservative\)")117.6
537.6 Q(\(let \(\(attrs \(soup-object-attributes obj\)\)\))117.6 549.6 Q
(\(for-each \(lambda \(attr\))127.2 561.6 Q
(;; Check if any cached query depends on this attribute)184.8 573.6 Q
(\(when \(bloom-might-contain? query-dependencies attr\))184.8 585.6 Q
(\(invalidate-queries-for-attribute attr\)\)\))194.4 597.6 Q
(attrs\)\)\))175.2 609.6 Q F0(#### Archi)72 627.6 Q -.25(va)-.25 G 2.5
(lC).25 G(ache Semantics)-2.5 E 0 Cg EP
%%Page: 12 12
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R -.15(Fo)72 84 S 2.5(rt)
.15 G(he soup')-2.5 E 2.5(sa)-.55 G(rchi)-2.5 E -.25(va)-.25 G 2.5(ln)
.25 G(ature, implement cop)-2.5 E(y-on-write cache entries:)-.1 E/F1 8
/Courier@0 SF
(;; Immutable cache entries - archival objects never change)108 102 Q
(\(define \(archival-cache-get cache hash\))108 114 Q
("Archival objects can be cached permanently")117.6 126 Q
(\(let \(\(entry \(hash-table-ref cache hash #f\)\)\))117.6 138 Q
(\(if entry)127.2 150 Q(\(if \(archival-generation? \(soup-get hash\)\))
146.4 162 Q 4.8(entry ;)165.6 174 R(Archival: never expires)4.8 E
(\(if \(cache-entry-fresh? entry\))165.6 186 Q
(\(cache-entry-value entry\))184.8 198 Q 4.8(#f\)\) ;)184.8 210 R
(Non-archival: check freshness)4.8 E(#f\)\)\))146.4 222 Q
(;; Generation-aware caching)108 246 Q
(\(define \(cache-ttl-for-generation gen\))108 258 Q(\(case gen)117.6
270 Q(\(\(archival\) +inf.0\))127.2 282 Q 4.8(;N)33.6 G(ever expires)
-4.8 E(\(\(stable\) 86400\))127.2 294 Q 4.8(;1d)48 G(ay)-4.8 E
(\(\(maturing\) 3600\))127.2 306 Q 4.8(;1h)43.2 G(our)-4.8 E
(\(\(young\) 60\))127.2 318 Q 4.8(;1m)67.2 G(inute)-4.8 E
(\(\(ephemeral\) 0\)\)\))127.2 330 Q 4.8(;N)43.2 G 4.8(oc)-4.8 G(aching)
-4.8 E/F2 10/Times-Bold@0 SF 2.5(9. Distrib)72 348 R(uted Queries)-.2 E
2.5(9.1. F)72 372 R(ederated Query)-.25 E F1
(;; Query across multiple vaults)108 390 Q(\(soup-query type: 'document)
108 402 Q(federation: '\(vault-a vault-b vault-c\)\))165.6 414 Q
(;; Query with locality preference)108 438 Q
(\(soup-query type: 'document)108 450 Q(prefer-local: #t\))165.6 462 Q
F2 2.5(9.2. Query)72 480 R(Routing)2.5 E F1
(\(define \(route-query query vaults\))108 498 Q
("Route query to appropriate vaults")117.6 510 Q
(\(let \(\(partitions \(query-partitions query\)\)\))117.6 522 Q
(\(map \(lambda \(vault\))127.2 534 Q
(\(list vault \(subquery-for-vault query vault\)\)\))160.8 546 Q
(\(filter \(lambda \(v\))151.2 558 Q
(\(vault-has-partition? v partitions\)\))199.2 570 Q(vaults\)\)\)\))
189.6 582 Q F2 2.5(9.3. Result)72 600 R(Mer)2.5 E(ging)-.1 E F1
(\(define \(merge-results results order\))108 618 Q
("Merge sorted results from multiple vaults")117.6 630 Q
(\(let \(\(streams \(map result->stream results\)\)\))117.6 642 Q
(\(merge-sorted-streams streams \(order->comparator order\)\)\)\))127.2
654 Q F2 2.5(10. Query)72 672 R -.5(Au)2.5 G(dit).5 E 0 Cg EP
%%Page: 13 13
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(10.1. A)72 84 R(udit T)-.5 E(rail)-.74 E/F2 8/Courier@0 SF
(;; All queries are logged)108 102 Q
(\(define \(audited-query query principal\))108 114 Q
(\(let \(\(start \(current-time\)\))117.6 126 Q
(\(result \(soup-query-with-caps query principal\)\)\))146.4 138 Q
(\(audit-append)127.2 150 Q(action: 'query)136.8 162 Q
(principal: principal)136.8 174 Q(query: \(query->sexp query\))136.8 186
Q(result-count: \(soup-cursor-count result\))136.8 198 Q
(duration: \(- \(current-time\) start\)\))136.8 210 Q(result\)\))127.2
222 Q F1 2.5(10.2. Query)72 240 R(Analysis)2.5 E F2
(;; Analyze query patterns)108 258 Q(\(soup-query type: 'audit-entry)108
270 Q(action: 'query)165.6 282 Q(principal: "alice"\))165.6 294 Q
(;; Find expensive queries)108 318 Q(\(soup-query type: 'audit-entry)108
330 Q(action: 'query)165.6 342 Q(duration: \(> 1000\)\))165.6 354 Q 4.8
(;>1s)9.6 G(econd)-4.8 E(;; Access pattern analysis)108 378 Q
(\(soup-aggregate)108 390 Q
(where: \(and \(type: 'audit-entry\) \(action: 'query\)\))117.6 402 Q
(group-by: 'principal)117.6 414 Q(aggregate: \(count\)\))117.6 426 Q F1
2.5(11. Query)72 444 R(Language Grammar)2.5 E F2 28.8(query ::=)108 462
R(\(soup-query clause\))4.8 E 24(clause ::=)108 474 R
(attribute-clause | predicate-clause | option-clause)4.8 E 9.6
(attribute ::=)108 486 R(symbol ':' value)4.8 E 9.6(predicate ::=)108
498 R('\(' op value '\)')4.8 E 43.2(op ::=)108 510 R
('>' | '<' | '>=' | '<=' | '=' | '!=')4.8 E 4.8(|')175.2 522 S
(like' | 'between' | 'contains')-4.8 E 4.8(|')175.2 534 S
(and' | 'or' | 'not')-4.8 E 4.8(|')175.2 546 S(exists' | 'missing')-4.8
E 4.8(|')175.2 558 S(text-search' | 'references' | 'referenced-by')-4.8
E 24(option ::=)108 570 R('order-by' | 'limit' | 'offset' | 'after')4.8
E 4.8(|')175.2 582 S(as-of' | 'highlight' | 'federation')-4.8 E 28.8
(value ::=)108 594 R(string | number | boolean | hash | query)4.8 E F1
2.5(12. Security)72 612 R(Considerations)2.5 E 0 Cg EP
%%Page: 14 14
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(12.1. Query)72 84 R(Injection)2.5 E/F2 8/Courier@0 SF
(;; Never interpolate user input into queries)108 102 Q(;; BAD:)108 114
Q(\(soup-query name: \(string-append "rfc-" user-input\)\))108 126 Q
(;; GOOD:)108 150 Q
(\(soup-query name: \(like \(sanitize-pattern user-input\)\)\))108 162 Q
(\(define \(sanitize-pattern s\))108 186 Q(\(string-map \(lambda \(c\))
117.6 198 Q(\(if \(member c '\(#\\* #\\? #\\[ #\\]\)\))184.8 210 Q
(#\\\\)204 222 Q(c\)\))204 234 Q(s\)\))175.2 246 Q F1 2.5(12.2. Query)72
264 R(Cost Limits)2.5 E F2
(;; Prevent denial of service via expensive queries)108 282 Q
(\(define query-cost-limit 10000\))108 294 Q
(\(define query-timeout 30\))108 306 Q 4.8(;s)9.6 G(econds)-4.8 E
(\(define \(safe-query query\))108 330 Q(\(with-timeout query-timeout)
117.6 342 Q(\(let \(\(cost \(estimate-cost query\)\)\))127.2 354 Q
(\(when \(> cost query-cost-limit\))136.8 366 Q
(\(error "Query exceeds cost limit"\)\))146.4 378 Q
(\(execute-query query\)\)\)\))136.8 390 Q F1 2.5(12.3. Inf)72 408 R
(ormation Leakage)-.25 E F2(;; Query existence can leak information)108
426 Q(;; Even "not found" reveals something)108 438 Q
(;; Use constant-time responses for sensitive queries)108 462 Q
(\(define \(private-query query\))108 474 Q
(\(let \(\(result \(soup-query query\)\)\))117.6 486 Q
(\(if \(authorized? \(current-principal\) result\))127.2 498 Q(result)
146.4 510 Q(\(constant-time-not-found\)\)\)\))146.4 522 Q F1 2.5
(13. Implementation)72 540 R(Notes)2.5 E 2.5(13.1. P)72 564 R(erf)-.2 E
(ormance)-.25 E F0 2.697(-I)72 579.6 S(nde)-2.697 E 2.697(xs)-.15 G .197
(election is critical for lar)-2.697 F .197
(ge soups - Bloom \214lters for f)-.18 F .197(ast ne)-.1 F -.05(ga)-.15
G(ti).05 E .497 -.15(ve l)-.25 H .197
(ookups - Query result streaming to a).15 F -.2(vo)-.2 G(id).2 E
(memory e)72 591.6 Q
(xhaustion - Connection pooling for federated queries)-.15 E F1 2.5
(13.2. Compatibility)72 615.6 R F0 3.276(-Q)72 631.2 S .776
(uery language inspired by Ne)-3.276 F(wton')-.25 E 3.276(ss)-.55 G .776
(oup cursors - SQL-lik)-3.276 F 3.276(es)-.1 G .776
(emantics where applicable - S-e)-3.276 F .776(xpression syntax)-.15 F
(for Scheme inte)72 643.2 Q(gration)-.15 E F1 2.5(14. Refer)72 667.2 R
(ences)-.18 E F0 .045(1. Ne)72 682.8 R .045(wton Programmer')-.25 F
2.545(sG)-.55 G .045(uide - Soup and cursor APIs 2. SQLite Query Planne\
r - Query optimization 3. Selinger et)-2.545 F 1.809(al., "Access P)72
694.8 R 1.809(ath Selection in a Relational Database Management System"\
 \(1979\) - Cost-based optimization 4.)-.15 F .319
(RFC-020: Content-Addressed Storage 5. RFC-021: Capability Dele)72 706.8
R -.05(ga)-.15 G .319(tion 6. RFC-026: Garbage Collection \(genera-).05
F(tion-a)72 718.8 Q -.1(wa)-.15 G(re caching\)).1 E 0 Cg EP
%%Page: 15 15
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 423.27(RFC-025 0)72 48 R/F1 10/Times-Bold@0 SF
2.5(15. Changelog)72 84 R F0 4.391(-2)72 99.6 S 1.891(026-01-09 - Cost-\
based query optimization: Selinger algorithm, cardinality estimation, h\
istograms, multi-tier)-4.391 F(caching with generation-a)72 111.6 Q -.1
(wa)-.15 G(re TTL - 2026-01-07 - Initial draft).1 E 0 Cg EP
%%Trailer
end
%%EOF
