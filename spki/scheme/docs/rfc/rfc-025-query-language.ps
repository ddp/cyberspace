%!PS-Adobe-3.0
%%Creator: groff version 1.23.0
%%CreationDate: Thu Jan  8 15:17:54 2026
%%DocumentNeededResources: font Times-Roman
%%DocumentSuppliedResources: procset grops 1.23 0
%%Pages: 8
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.23 0
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
% The ASCII code of the space character.
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
% name size font SF -
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
% name a c d font MF -
/MF{
findfont
[5 2 roll
0 3 1 roll % b
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
% Enable manual feed.
% MANUAL -
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
% Guess the page length.
% This assumes that the imageable area is vertically centered on the page.
% PLG - length
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
% BP -
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
DEFS/BPhook known{DEFS begin BPhook end}if
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}def
% centerx centery radius startangle endangle DA -
/DA{
newpath arcn stroke
}bind def
% x y SN - x' y'
% round a position to nearest (pixel + (.25,.25))
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
% endx endy startx starty DL -
% we round the endpoints of the line, so that parallel horizontal
% and vertical lines will appear even
/DL{
SN
moveto
SN
lineto stroke
}bind def
% centerx centery radius DC -
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
%  width height centerx centery DE -
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
% these are for splines
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
% fill the last path
% r g b Fr -
/Fr{
setrgbcolor fill
}bind def
% c m y k Fk -
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
% g Fg -
/Fg{
setgray fill
}bind def
% fill with the "current color"
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
% new_font_name encoding_vector old_font_name RE -
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne
2 index/UniqueID ne
and
{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
% hpos vpos EBEGIN -
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
% llx lly newwid wid newht ht newllx newlly PBEGIN -
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
% set the graphics state to default values
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
%
%  Any included setpagedevice should be ignored.
%  See: http://www.w-beer.de/doc/ps/.
%
/setpagedevice{}def
mark
}bind def
/PEND{
cleartomark
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(RFC-025: Soup Query Language)72 12 Q(Status: Dr\
aft Date: January 2026 Author: Derrell Piper ddp@eludom.net Implementat\
ion: Proposed)72 36 Q(-------------------------------------------------\
-----------------------------)72 60 Q(Abstract)72 84 Q .162(This RFC sp\
eci\214es the query language for the Library of Cyberspace soup: ho)72
108 R 2.662(wp)-.25 G .161(rincipals search, \214lter)-2.662 F 2.661(,a)
-.4 G .161(nd retrie)-2.661 F -.15(ve)-.25 G 1.276
(objects from the content-addressed store using the rich metadata layer)
72 120 R 3.776(.Q)-.55 G 1.276(ueries are themselv)-3.776 F 1.277
(es content-addressed)-.15 F(and auditable.)72 132 Q(------------------\
------------------------------------------------------------)72 156 Q
(Moti)72 180 Q -.25(va)-.25 G(tion).25 E(The soup contains in\214nite m\
etadata. Finding needles requires a query language that is:)72 204 Q
2.717(-E)72 228 S(xpressi)-2.717 E .517 -.15(ve - C)-.25 H(omple).15 E
2.717(xp)-.15 G .217(redicates, joins across objects - Ef)-2.717 F .217
(\214cient - Inde)-.25 F -.15(xe)-.15 G .216
(s, bloom \214lters, query planning - Secure -).15 F
(Queries respect capability boundaries - Auditable - Query patterns re)
72 240 Q -.15(ve)-.25 G(al access patterns).15 E(Ne)72 264 Q
(wton\342s soup had cursor)-.25 E(-based queries. W)-.2 E 2.5(ee)-.8 G
(xtend this with content-addressed semantics.)-2.65 E(-----------------\
-------------------------------------------------------------)72 288 Q
(Query Model)72 312 Q(Basic Queries)72 336 Q(;; Find by type)82 360 Q
(\(soup-query type: ')82 372 Q(document\))-.5 E(;; Find by attrib)82 396
Q(ute)-.2 E(\(soup-query author: "alice@e)82 408 Q(xample.com"\))-.15 E
(;; Find by multiple attrib)82 432 Q(utes \(AND\))-.2 E
(\(soup-query type: ')82 444 Q(document)-.5 E(author: "alice@e)112 456 Q
(xample.com")-.15 E(created-after: "2026-01-01"\))112 468 Q
(;; Find by content hash)82 492 Q(\(soup-query hash: "sha256:7f83b1657f)
82 504 Q(f1fc..."\))-.25 E(Query Results)72 528 Q
(;; Results are lazy cursors)82 552 Q
(\(de\214ne results \(soup-query type: ')82 564 Q(document\)\))-.5 E
(;; Iterate)82 588 Q(\(soup-cursor)82 600 Q(-ne)-.2 E(xt results\))-.15
E 2.5(;=)10 G 2.5(>s)-2.5 G(oup-object or #f)-2.5 E(\(soup-cursor)82 612
Q(-peek results\))-.2 E 2.5(;=)10 G 2.5(>n)-2.5 G -.15(ex)-2.5 G 2.5(tw)
.15 G(ithout adv)-2.5 E(ancing)-.25 E(\(soup-cursor)82 624 Q
(-reset results\))-.2 E 2.5(;=)7.5 G 2.5(>b)-2.5 G(ack to be)-2.5 E
(ginning)-.15 E(;; Collect \(careful with lar)82 648 Q(ge result sets\))
-.18 E(\(soup-cursor)82 660 Q(->list results\))-.2 E 2.5(;=)7.5 G 2.5
(>l)-2.5 G(ist of soup-objects)-2.5 E(\(soup-cursor)82 672 Q
(-count results\))-.2 E 2.5(;=)7.5 G 2.5(>t)-2.5 G(otal count)-2.5 E
(Predicates)72 696 Q(;; Comparison operators)82 720 Q
(\(soup-query size: \(> 1000000\)\))82 732 Q 2.5(;l)27.5 G(ar)-2.5 E
(ger than 1MB)-.18 E(\(soup-query created: \(< "2025-01-01"\)\))82 744 Q
2.5(;b)7.5 G(efore 2025)-2.5 E(\(soup-query name: \(lik)82 756 Q 2.5(e")
-.1 G 17.5(rfc-*"\)\) ;)-2.5 F(glob pattern)2.5 E
(\(soup-query tags: \(contains "ur)82 768 Q 5(gent"\)\) ;)-.18 F
(list membership)2.5 E(;; Logical operators)82 792 Q 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(soup-query \(and \(type: ')82 12 Q(document\))
-.5 E(\(or \(author: "alice"\))124.5 24 Q(\(author: "bob"\)\)\)\))134.5
36 Q(;; Ne)82 60 Q -.05(ga)-.15 G(tion).05 E
(\(soup-query \(not \(type: ')82 72 Q(tombstone\)\)\))-.18 E
(;; Existence)82 96 Q(\(soup-query \(e)82 108 Q(xists 'encryption-k)-.15
E -.15(ey)-.1 G 7.5(\)\) ;).15 F(has attrib)2.5 E(ute)-.2 E
(\(soup-query \(missing 'e)82 120 Q 22.5(xpires\)\) ;)-.15 F
(lacks attrib)2.5 E(ute)-.2 E(-----------------------------------------\
-------------------------------------)72 144 Q(Adv)72 168 Q
(anced Queries)-.25 E(Range Queries)72 192 Q(;; Numeric ranges)82 216 Q
(\(soup-query size: \(between 1000 10000\)\))82 228 Q(;; Date ranges)82
252 Q(\(soup-query created: \(between "2026-01-01" "2026-12-31"\)\))82
264 Q(;; Le)82 288 Q(xicographic ranges)-.15 E
(\(soup-query name: \(between "rfc-010" "rfc-020"\)\))82 300 Q(Full-T)72
324 Q -.15(ex)-.7 G 2.5(tS).15 G(earch)-2.5 E(;; Search inde)82 348 Q
-.15(xe)-.15 G 2.5(dc).15 G(ontent)-2.5 E(\(soup-query \(te)82 360 Q
(xt-search "capability dele)-.15 E -.05(ga)-.15 G(tion"\)\)).05 E(;; W)
82 384 Q(ith highlighting)-.4 E(\(soup-query \(te)82 396 Q
(xt-search "SPKI certi\214cate"\))-.15 E(highlight: #t\))112 408 Q
(;; Phrase search)82 432 Q(\(soup-query \(te)82 444 Q(xt-search ")-.15 E
(;; Fuzzy search)82 468 Q(\(soup-query \(te)82 480 Q(xt-search "delg)
-.15 E 2.5(ation~"\)\) ;)-.05 F(typo-tolerant)2.5 E(Reference T)72 504 Q
(ra)-.35 E -.15(ve)-.2 G(rsal).15 E(;; Objects referencing this hash)82
528 Q(\(soup-query references: "sha256:tar)82 540 Q(get..."\))-.18 E
(;; Objects referenced by this hash)82 564 Q
(\(soup-query referenced-by: "sha256:source..."\))82 576 Q(;; T)82 600 Q
(ransiti)-.35 E .3 -.15(ve c)-.25 H(losure \(careful - can be huge\)).15
E(\(soup-query \(transiti)82 612 Q -.15(ve)-.25 G
(-references "sha256:root..."\)).15 E(max-depth: 3\))112 624 Q -.7(Te)72
648 S(mporal Queries).7 E(;; Objects as the)82 672 Q 2.5(ye)-.15 G
(xisted at a point in time)-2.65 E(\(soup-query type: ')82 684 Q
(document)-.5 E(as-of: "2026-01-01T00:00:00Z"\))112 696 Q
(;; Objects modi\214ed in time windo)82 720 Q(w)-.25 E
(\(soup-query modi\214ed: \(between "2026-01-01" "2026-01-07"\)\))82 732
Q(;; V)82 756 Q(ersion history)-1.11 E(\(soup-query \(v)82 768 Q
(ersions-of "sha256:current..."\)\))-.15 E(----------------------------\
--------------------------------------------------)72 792 Q 0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Query Composition)72 24 Q(Subqueries)72 48 Q
(;; Objects authored by members of a group)82 72 Q
(\(soup-query author: \(soup-query type: 'principal)82 84 Q(member)162
96 Q(-of: "engineering"\)\))-.2 E(;; Documents referencing an)82 120 Q
2.5(yR)-.15 G(FC)-2.5 E(\(soup-query type: ')82 132 Q(document)-.5 E
(references: \(soup-query name: \(lik)112 144 Q 2.5(e")-.1 G
(rfc-*"\)\)\))-2.5 E(Aggre)72 168 Q -.05(ga)-.15 G(tion).05 E
(;; Count by type)82 192 Q(\(soup-aggre)82 204 Q -.05(ga)-.15 G(te).05 E
(group-by: ')87 216 Q(type)-.18 E(aggre)87 228 Q -.05(ga)-.15 G
(te: \(count\)\)).05 E(;; T)82 252 Q(otal size by author)-.8 E
(\(soup-aggre)82 264 Q -.05(ga)-.15 G(te).05 E(group-by: 'author)87 276
Q(aggre)87 288 Q -.05(ga)-.15 G(te: \(sum ').05 E(size\)\))-.55 E(;; A)
82 312 Q -.15(ve)-.74 G(rage document size).15 E(\(soup-aggre)82 324 Q
-.05(ga)-.15 G(te).05 E(where: \(type: ')87 336 Q(document\))-.5 E
(aggre)87 348 Q -.05(ga)-.15 G(te: \(a).05 E(vg ')-.2 E(size\)\))-.55 E
(;; Distinct v)82 372 Q(alues)-.25 E(\(soup-aggre)82 384 Q -.05(ga)-.15
G(te).05 E(aggre)87 396 Q -.05(ga)-.15 G
(te: \(distinct 'content-type\)\)).05 E(Ordering and P)72 420 Q
(agination)-.15 E(;; Sort by creation date, ne)82 444 Q(west \214rst)
-.25 E(\(soup-query type: ')82 456 Q(document)-.5 E(order)112 468 Q
(-by: '\(\(created desc\)\)\))-.2 E(;; Multi-column sort)82 492 Q
(\(soup-query type: ')82 504 Q(document)-.5 E(order)112 516 Q
(-by: '\(\(author asc\) \(created desc\)\)\))-.2 E(;; P)82 540 Q
(agination)-.15 E(\(soup-query type: ')82 552 Q(document)-.5 E(order)112
564 Q(-by: '\(\(created desc\)\))-.2 E(limit: 20)112 576 Q(of)112 588 Q
(fset: 40\))-.25 E(;; Cursor)82 612 Q(-based pagination \(more ef)-.2 E
(\214cient\))-.25 E(\(soup-query type: ')82 624 Q(document)-.5 E(order)
112 636 Q(-by: '\(\(created desc\)\))-.2 E
(after: "sha256:last-seen..."\))112 648 Q(-----------------------------\
-------------------------------------------------)72 672 Q(Capability-A)
72 696 Q -.1(wa)-.92 G(re Queries).1 E(Query Filtering)72 720 Q(Queries\
 automatically \214lter results based on the querying principal\342s ca\
pabilities:)72 744 Q
(\(de\214ne \(soup-query-with-caps query principal\))82 768 Q("Ex)87 780
Q(ecute query \214ltered by principal')-.15 E 2.5(sc)-.55 G
(apabilities")-2.5 E(\(let* \(\(ra)87 792 Q(w-results \(e)-.15 E -.15
(xe)-.15 G(cute-query query\)\)).15 E 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(caps \(principal-capabilities principal\)\)\))
104.5 12 Q(\(\214lter \(lambda \(obj\))92 24 Q
(\(can-read? principal obj caps\)\))117 36 Q(ra)112 48 Q
(w-results\)\)\))-.15 E(Capability Queries)72 72 Q
(;; What can I access?)82 96 Q
(\(soup-query \(accessible-by \(current-principal\)\)\))82 108 Q
(;; Who can access this?)82 132 Q(\(soup-query type: 'certi\214cate)82
144 Q(grants-access-to: "sha256:tar)112 156 Q(get..."\))-.18 E
(;; Find my capabilities)82 180 Q(\(soup-query type: 'certi\214cate)82
192 Q(subject: \(current-principal\)\))112 204 Q(Query Authorization)72
228 Q(;; Some queries require e)82 252 Q(xplicit capability)-.15 E
(\(soup-query type: 'audit-log\))82 264 Q 2.5(;r)5 G
(equires audit-read capability)-2.5 E(;; Query capability certi\214cate)
82 288 Q(\(spki-cert)82 300 Q(\(issuer v)87 312 Q(ault-admin\))-.25 E
(\(subject auditor)87 324 Q(-k)-.2 E -.15(ey)-.1 G(\)).15 E
(\(capability)87 336 Q(\(action query\))92 348 Q
(\(object \(type 'audit-log\)\)\))92 360 Q(\(v)87 372 Q
(alidity \(not-after "2027-01-01"\)\)\))-.25 E(------------------------\
------------------------------------------------------)72 396 Q(Inde)72
420 Q -.15(xe)-.15 G(s).15 E(Inde)72 444 Q 2.5(xT)-.15 G(ypes)-3.3 E
(;; B-tree inde)82 468 Q 2.5(x\()-.15 G(ordered, range queries\))-2.5 E
(\(de\214ne-inde)82 480 Q 2.5(x')-.15 G(created-idx)-2.5 E(type: 'btree)
87 492 Q(on: 'created\))87 504 Q(;; Hash inde)82 528 Q 2.5(x\()-.15 G
(equality only)-2.5 E 2.5(,f)-.65 G(aster\))-2.6 E(\(de\214ne-inde)82
540 Q 2.5(x')-.15 G(hash-idx)-2.5 E(type: 'hash)87 552 Q
(on: 'content-hash\))87 564 Q(;; Full-te)82 588 Q(xt inde)-.15 E 2.5
(x\()-.15 G(search\))-2.5 E(\(de\214ne-inde)82 600 Q 2.5(x')-.15 G
(content-idx)-2.5 E(type: 'fullte)87 612 Q(xt)-.15 E(on: 'content)87 624
Q(language: 'english\))87 636 Q(;; Composite inde)82 660 Q(x)-.15 E
(\(de\214ne-inde)82 672 Q 2.5(x')-.15 G(author)-2.5 E(-date-idx)-.2 E
(type: 'btree)87 684 Q(on: '\(author created\)\))87 696 Q
(;; Bloom \214lter inde)82 720 Q 2.5(x\()-.15 G(membership testing\))
-2.5 E(\(de\214ne-inde)82 732 Q 2.5(x')-.15 G(tags-bloom)-2.68 E
(type: 'bloom)87 744 Q(on: ')87 756 Q(tags)-.18 E -.1(fa)87 768 S
(lse-positi).1 E -.15(ve)-.25 G(-rate: 0.01\)).15 E(Inde)72 792 Q 2.5
(xS)-.15 G(election)-2.5 E 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(de\214ne \(plan-query query inde)82 24 Q -.15
(xe)-.15 G(s\)).15 E("Select best inde)87 36 Q 2.5(xf)-.15 G(or query")
-2.5 E(\(let \(\(predicates \(query-predicates query\)\)\))87 48 Q
(\(\214nd \(lambda \(idx\))92 60 Q(\(inde)112 72 Q(x-co)-.15 E -.15(ve)
-.15 G(rs? idx predicates\)\)).15 E(\(sort inde)107 84 Q -.15(xe)-.15 G
2.5(si).15 G(nde)-2.5 E(x-selecti)-.15 E(vity>\)\)\)\))-.25 E(Inde)72
108 Q 2.5(xM)-.15 G(aintenance)-2.5 E(;; Inde)82 132 Q -.15(xe)-.15 G
2.5(sa).15 G(re updated on soup-put)-2.5 E(\(de\214ne \(soup-put-inde)82
144 Q -.15(xe)-.15 G 2.5(do).15 G(bj\))-2.5 E
(\(let \(\(hash \(soup-put obj\)\)\))87 156 Q(\(for)92 168 Q
(-each \(lambda \(idx\))-.2 E(\(inde)122 180 Q
(x-insert! idx obj hash\)\))-.15 E(\(applicable-inde)117 192 Q -.15(xe)
-.15 G 2.5(so).15 G(bj\)\))-2.5 E(hash\)\))92 204 Q(;; Periodic inde)82
228 Q 2.5(xo)-.15 G(ptimization)-2.5 E(\(de\214ne \(optimize-inde)82 240
Q -.15(xe)-.15 G(s\)).15 E(\(for)87 252 Q(-each inde)-.2 E
(x-compact! \(all-inde)-.15 E -.15(xe)-.15 G(s\)\)\)).15 E(------------\
------------------------------------------------------------------)72
276 Q(Query Ex)72 300 Q(ecution)-.15 E(Query Planning)72 324 Q
(\(de\214ne \(e)82 348 Q -.15(xe)-.15 G(cute-query query\)).15 E
("Plan and e)87 360 Q -.15(xe)-.15 G(cute query").15 E
(\(let* \(\(plan \(plan-query query\)\))87 372 Q
(\(cost \(estimate-cost plan\)\)\))104.5 384 Q
(\(when \(> cost *query-cost-limit*\))92 396 Q(\(error "Query too e)97
408 Q(xpensi)-.15 E -.15(ve)-.25 G 2.5("c).15 G(ost\)\))-2.5 E(\(e)92
420 Q -.15(xe)-.15 G(cute-plan plan\)\)\)).15 E
(\(de\214ne \(plan-query query\))82 444 Q("Generate query e)87 456 Q
-.15(xe)-.15 G(cution plan").15 E(`\(query-plan)87 468 Q
(\(predicates ,\(query-predicates query\)\))92 480 Q(\(inde)92 492 Q 2.5
(x,)-.15 G(\(select-inde)-2.5 E 2.5(xq)-.15 G(uery\)\))-2.5 E
(\(\214lter ,\(remaining-predicates query\)\))92 504 Q
(\(order ,\(query-order query\)\))92 516 Q
(\(limit ,\(query-limit query\)\)\)\))92 528 Q(Ex)72 552 Q
(ecution Strate)-.15 E(gies)-.15 E(;; Inde)82 576 Q 2.5(xs)-.15 G(can)
-2.5 E(\(de\214ne \(inde)82 588 Q(x-scan inde)-.15 E 2.5(xp)-.15 G
(redicate\))-2.5 E(\(inde)87 600 Q(x-range-query inde)-.15 E(x)-.15 E
(\(predicate-lo)134.5 612 Q(wer)-.25 E(-bound predicate\))-.2 E
(\(predicate-upper)134.5 624 Q(-bound predicate\)\)\))-.2 E
(;; Full scan \(last resort\))82 648 Q
(\(de\214ne \(full-scan predicate\))82 660 Q
(\(\214lter predicate \(all-soup-objects\)\)\))87 672 Q(;; Inde)82 696 Q
2.5(xi)-.15 G(ntersection)-2.5 E(\(de\214ne \(inde)82 708 Q
(x-intersect idx1 idx2 pred1 pred2\))-.15 E(\(set-intersection)87 720 Q
(\(inde)92 732 Q(x-scan idx1 pred1\))-.15 E(\(inde)92 744 Q
(x-scan idx2 pred2\)\)\))-.15 E(Query Caching)72 768 Q
(;; Query results can be cached)82 792 Q 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\(de\214ne query-cache \(mak)82 12 Q
(e-lru-cache 1000\)\))-.1 E(\(de\214ne \(cached-query query\))82 36 Q
(\(let \(\(k)87 48 Q .3 -.15(ey \()-.1 H(query->hash query\)\)\)).15 E
(\(or \(lru-get query-cache k)92 60 Q -.15(ey)-.1 G(\)).15 E
(\(let \(\(result \(e)102 72 Q -.15(xe)-.15 G(cute-query query\)\)\)).15
E(\(lru-put! query-cache k)107 84 Q .3 -.15(ey r)-.1 H(esult\)).15 E
(result\)\)\)\))107 96 Q(;; Cache in)82 120 Q -.25(va)-.4 G
(lidation on soup changes).25 E(\(de\214ne \(in)82 132 Q -.25(va)-.4 G
(lidate-query-cache obj\)).25 E(\(let \(\(af)87 144 Q
(fected \(queries-af)-.25 E(fected-by obj\)\)\))-.25 E(\(for)92 156 Q
(-each \(lambda \(q\))-.2 E(\(lru-remo)122 168 Q -.15(ve)-.15 G 2.5(!q)
.15 G(uery-cache \(query->hash q\)\)\))-2.5 E(af)117 180 Q(fected\)\)\))
-.25 E(----------------------------------------------------------------\
--------------)72 204 Q(Distrib)72 228 Q(uted Queries)-.2 E
(Federated Query)72 252 Q(;; Query across multiple v)82 276 Q(aults)-.25
E(\(soup-query type: ')82 288 Q(document)-.5 E(federation: '\(v)112 300
Q(ault-a v)-.25 E(ault-b v)-.25 E(ault-c\)\))-.25 E
(;; Query with locality preference)82 324 Q(\(soup-query type: ')82 336
Q(document)-.5 E(prefer)112 348 Q(-local: #t\))-.2 E(Query Routing)72
372 Q(\(de\214ne \(route-query query v)82 396 Q(aults\))-.25 E
("Route query to appropriate v)87 408 Q(aults")-.25 E
(\(let \(\(partitions \(query-partitions query\)\)\))87 420 Q
(\(map \(lambda \(v)92 432 Q(ault\))-.25 E(\(list v)109.5 444 Q
(ault \(subquery-for)-.25 E(-v)-.2 E(ault query v)-.25 E(ault\)\)\))-.25
E(\(\214lter \(lambda \(v\))104.5 456 Q(\(v)129.5 468 Q
(ault-has-partition? v partitions\)\))-.25 E -.25(va)124.5 480 S
(ults\)\)\)\)).25 E(Result Mer)72 504 Q(ging)-.18 E(\(de\214ne \(mer)82
528 Q(ge-results results order\))-.18 E("Mer)87 540 Q
(ge sorted results from multiple v)-.18 E(aults")-.25 E
(\(let \(\(streams \(map result->stream results\)\)\))87 552 Q(\(mer)92
564 Q(ge-sorted-streams streams \(order)-.18 E
(->comparator order\)\)\)\))-.2 E(-------------------------------------\
-----------------------------------------)72 588 Q(Query Audit)72 612 Q
(Audit T)72 636 Q(rail)-.35 E(;; All queries are logged)82 660 Q
(\(de\214ne \(audited-query query principal\))82 672 Q
(\(let \(\(start \(current-time\)\))87 684 Q
(\(result \(soup-query-with-caps query principal\)\)\))102 696 Q
(\(audit-append)92 708 Q(action: 'query)97 720 Q(principal: principal)97
732 Q(query: \(query->se)97 744 Q(xp query\))-.15 E
(result-count: \(soup-cursor)97 756 Q(-count result\))-.2 E
(duration: \(- \(current-time\) start\)\))97 768 Q(result\)\))92 780 Q 0
Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Query Analysis)72 12 Q
(;; Analyze query patterns)82 36 Q(\(soup-query type: 'audit-entry)82 48
Q(action: 'query)112 60 Q(principal: "alice"\))112 72 Q(;; Find e)82 96
Q(xpensi)-.15 E .3 -.15(ve q)-.25 H(ueries).15 E
(\(soup-query type: 'audit-entry)82 108 Q(action: 'query)112 120 Q
(duration: \(> 1000\)\))112 132 Q 2.5(;>1s)5 G(econd)-2.5 E
(;; Access pattern analysis)82 156 Q(\(soup-aggre)82 168 Q -.05(ga)-.15
G(te).05 E(where: \(and \(type: 'audit-entry\) \(action: 'query\)\))87
180 Q(group-by: 'principal)87 192 Q(aggre)87 204 Q -.05(ga)-.15 G
(te: \(count\)\)).05 E(------------------------------------------------\
------------------------------)72 228 Q(Query Language Grammar)72 252 Q
15(query ::=)82 276 R(\(soup-query clause*\))2.5 E 12.5(clause ::=)82
288 R(attrib)2.5 E(ute-clause | predicate-clause | option-clause)-.2 E
(attrib)82 300 Q 5(ute ::=)-.2 F(symbol ':' v)2.5 E(alue)-.25 E 5
(predicate ::=)82 312 R('\(' op v)2.5 E(alue* '\)')-.25 E 22.5(op ::=)82
324 R('>' | '<' | '>=' | '<=' | '=' | '!=')2.5 E 2.5(|')117 336 S(lik)
-2.6 E(e' | 'between' | 'contains')-.1 E 2.5(|')117 348 S
(and' | 'or' | 'not')-2.5 E 2.5(|')117 360 S -.15(ex)-2.5 G
(ists' | 'missing').15 E 2.5(|')117 372 S(te)-2.68 E(xt-search' | ')-.15
E(references' | ')-.5 E(referenced-by')-.5 E 12.5(option ::=)82 384 R
('order)2.5 E(-by' | ')-.2 E(limit' | 'of)-.1 E(fset' | 'after')-.25 E
2.5(|')117 396 S -1.95(as-of ')-2.5 F 2.5(|')2.5 G
(highlight' | 'federation')-2.5 E -.25(va)82 408 S 15(lue ::=).25 F
(string | number | boolean | hash | query)2.5 E(-----------------------\
-------------------------------------------------------)72 432 Q
(Security Considerations)72 456 Q(Query Injection)72 480 Q(;; Ne)82 504
Q -.15(ve)-.25 G 2.5(ri).15 G(nterpolate user input into queries)-2.5 E
(;; B)82 516 Q(AD:)-.35 E
(\(soup-query name: \(string-append "rfc-" user)82 528 Q(-input\)\))-.2
E(;; GOOD:)82 552 Q(\(soup-query name: \(lik)82 564 Q 2.5(e\()-.1 G
(sanitize-pattern user)-2.5 E(-input\)\)\))-.2 E
(\(de\214ne \(sanitize-pattern s\))82 588 Q(\(string-map \(lambda \(c\))
87 600 Q(\(if \(member c '\(##)122 612 Q(#\\)60 E(c\)\))132 624 Q(s\)\))
117 636 Q(Query Cost Limits)72 660 Q(;; Pre)82 684 Q -.15(ve)-.25 G
(nt denial of service via e).15 E(xpensi)-.15 E .3 -.15(ve q)-.25 H
(ueries).15 E(\(de\214ne *query-cost-limit* 10000\))82 696 Q
(\(de\214ne *query-timeout* 30\))82 708 Q 2.5(;s)5 G(econds)-2.5 E
(\(de\214ne \(safe-query query\))82 732 Q
(\(with-timeout *query-timeout*)87 744 Q
(\(let \(\(cost \(estimate-cost query\)\)\))92 756 Q
(\(when \(> cost *query-cost-limit*\))97 768 Q(\(error "Query e)102 780
Q(xceeds cost limit"\)\))-.15 E(\(e)97 792 Q -.15(xe)-.15 G
(cute-query query\)\)\)\)).15 E 0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(Information Leakage)72 24 Q(;; Query e)82 48 Q
(xistence can leak information)-.15 E(;; Ev)82 60 Q(en "not found" re)
-.15 E -.15(ve)-.25 G(als something).15 E
(;; Use constant-time responses for sensiti)82 84 Q .3 -.15(ve q)-.25 H
(ueries).15 E(\(de\214ne \(pri)82 96 Q -.25(va)-.25 G(te-query query\))
.25 E(\(let \(\(result \(soup-query query\)\)\))87 108 Q
(\(if \(authorized? \(current-principal\) result\))92 120 Q(result)102
132 Q(\(constant-time-not-found\)\)\)\))102 144 Q(---------------------\
---------------------------------------------------------)72 168 Q
(Implementation Notes)72 192 Q(Performance)72 216 Q 2.697(-I)72 240 S
(nde)-2.697 E 2.697(xs)-.15 G .197(election is critical for lar)-2.697 F
.197(ge soups - Bloom \214lters for f)-.18 F .197(ast ne)-.1 F -.05(ga)
-.15 G(ti).05 E .497 -.15(ve l)-.25 H .197
(ookups - Query result streaming to a).15 F -.2(vo)-.2 G(id).2 E
(memory e)72 252 Q(xhaustion - Connection pooling for federated queries)
-.15 E(Compatibility)72 276 Q 3.166(-Q)72 300 S .666
(uery language inspired by Ne)-3.166 F .665
(wton\342s soup cursors - SQL-lik)-.25 F 3.165(es)-.1 G .665
(emantics where applicable - S-e)-3.165 F .665(xpression syntax)-.15 F
(for Scheme inte)72 312 Q(gration)-.15 E(------------------------------\
------------------------------------------------)72 336 Q(References)72
360 Q 4.981(1. Ne)72 384 R 2.481
(wton Programmer\342s Guide - Soup and cursor APIs 2.)-.25 F 2.482
(SQLite Query Planner - Query optimization 3.)7.481 F
(RFC-020: Content-Addressed Storage 4.)72 396 Q
(RFC-021: Capability Dele)5 E -.05(ga)-.15 G(tion).05 E(---------------\
---------------------------------------------------------------)72 420 Q
(Changelog)72 444 Q 2.5(-2)72 468 S(026-01-07 - Initial draft)-2.5 E(--\
-----------------------------------------------------------------------\
-----)72 492 Q
(Implementation Status: Draft Dependencies: soup, cas, spki Inte)72 516
Q(gration: V)-.15 E(ault queries, federation, audit trail)-1.11 E 0 Cg
EP
%%Trailer
end
%%EOF
