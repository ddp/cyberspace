<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <title>Memo 0031: Compression and Deduplication</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27%230f0%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>">
  <script>
(function(){
  var h=new Date().getHours(),c;
  if(h>=4&&h<6)c='%23845EC2';       // brahma muhurta - violet
  else if(h>=6&&h<8)c='%23ffd700';  // dawn - gold
  else if(h>=8&&h<11)c='%2300d4aa'; // morning - teal
  else if(h>=11&&h<14)c='%230f0';   // midday - phosphor
  else if(h>=14&&h<17)c='%2339ff14';// afternoon - neon
  else if(h>=17&&h<19)c='%23ff6600';// sunset - orange
  else if(h>=19&&h<22)c='%23ff3366';// evening - coral
  else c='%2300ffff';               // night - cyan
  document.getElementById('favicon').href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27'+c+'%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>';
})();
</script>
  <link rel="stylesheet" href="memo.css">
</head>
<body>
<span class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark">[theme]</span>
<h1>Memo 0031: Compression and Deduplication</h1>
<dl class="metadata">
</dl>
<hr>
<section>
<h2>Abstract</h2>
<p>This Memo specifies compression and deduplication for the Library of Cyberspace: how vaults reduce storage requirements while maintaining content-addressability, integrity verification, and efficient retrieval. Compression is transparent to the content-addressing layer.</p>
</section>
<section>
<h2>Motivation</h2>
<p>Storage efficiency matters for preservation:</p>
<ul>
<li>Cost</li>
<li>Less storage means more preservation per dollar</li>
<li>Bandwidth</li>
<li>Compressed transfers are faster</li>
<li>Redundancy</li>
<li>More copies fit in same space</li>
<li>Longevity</li>
<li>Smaller archives survive longer</li>
</ul>
<p>But compression must not compromise:</p>
<ul>
<li>Integrity</li>
<li>Hashes must remain valid</li>
<li>Addressability</li>
<li>Content addressing still works</li>
<li>Deduplication</li>
<li>Identical content stored once</li>
<li>Accessibility</li>
<li>Data remains retrievable</li>
</ul>
</section>
<section>
<h2>Compression Model</h2>
<h3>Layered Architecture</h3>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 390 260" width="390" height="260" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<line x1="5" y1="10" x2="10" y2="10"/>
<line x1="5" y1="10" x2="5" y2="20"/>
<line x1="10" y1="10" x2="20" y2="10"/>
<line x1="20" y1="10" x2="30" y2="10"/>
<line x1="30" y1="10" x2="40" y2="10"/>
<line x1="40" y1="10" x2="50" y2="10"/>
<line x1="50" y1="10" x2="60" y2="10"/>
<line x1="60" y1="10" x2="70" y2="10"/>
<line x1="70" y1="10" x2="80" y2="10"/>
<line x1="80" y1="10" x2="90" y2="10"/>
<line x1="90" y1="10" x2="100" y2="10"/>
<line x1="100" y1="10" x2="110" y2="10"/>
<line x1="110" y1="10" x2="120" y2="10"/>
<line x1="120" y1="10" x2="130" y2="10"/>
<line x1="130" y1="10" x2="140" y2="10"/>
<line x1="140" y1="10" x2="150" y2="10"/>
<line x1="150" y1="10" x2="160" y2="10"/>
<line x1="160" y1="10" x2="170" y2="10"/>
<line x1="170" y1="10" x2="180" y2="10"/>
<line x1="180" y1="10" x2="190" y2="10"/>
<line x1="190" y1="10" x2="200" y2="10"/>
<line x1="200" y1="10" x2="210" y2="10"/>
<line x1="210" y1="10" x2="220" y2="10"/>
<line x1="220" y1="10" x2="230" y2="10"/>
<line x1="230" y1="10" x2="240" y2="10"/>
<line x1="240" y1="10" x2="250" y2="10"/>
<line x1="250" y1="10" x2="260" y2="10"/>
<line x1="260" y1="10" x2="270" y2="10"/>
<line x1="270" y1="10" x2="280" y2="10"/>
<line x1="280" y1="10" x2="290" y2="10"/>
<line x1="290" y1="10" x2="300" y2="10"/>
<line x1="300" y1="10" x2="310" y2="10"/>
<line x1="310" y1="10" x2="320" y2="10"/>
<line x1="320" y1="10" x2="330" y2="10"/>
<line x1="330" y1="10" x2="340" y2="10"/>
<line x1="340" y1="10" x2="350" y2="10"/>
<line x1="350" y1="10" x2="360" y2="10"/>
<line x1="360" y1="10" x2="370" y2="10"/>
<line x1="370" y1="10" x2="380" y2="10"/>
<line x1="380" y1="10" x2="385" y2="10"/>
<line x1="385" y1="10" x2="385" y2="20"/>
<line x1="5" y1="20" x2="5" y2="40"/>
<text x="105" y="30">A</text>
<text x="115" y="30">p</text>
<text x="125" y="30">p</text>
<text x="135" y="30">l</text>
<text x="145" y="30">i</text>
<text x="155" y="30">c</text>
<text x="165" y="30">a</text>
<text x="175" y="30">t</text>
<text x="185" y="30">i</text>
<text x="195" y="30">o</text>
<text x="205" y="30">n</text>
<text x="225" y="30">L</text>
<text x="235" y="30">a</text>
<text x="245" y="30">y</text>
<text x="255" y="30">e</text>
<text x="265" y="30">r</text>
<line x1="385" y1="20" x2="385" y2="40"/>
<line x1="5" y1="40" x2="5" y2="60"/>
<text x="65" y="50">(</text>
<text x="75" y="50">s</text>
<text x="85" y="50">e</text>
<text x="95" y="50">e</text>
<text x="105" y="50">s</text>
<text x="125" y="50">u</text>
<text x="135" y="50">n</text>
<text x="145" y="50">c</text>
<text x="155" y="50">o</text>
<text x="165" y="50">m</text>
<text x="175" y="50">p</text>
<text x="185" y="50">r</text>
<text x="195" y="50">e</text>
<text x="205" y="50">s</text>
<text x="215" y="50">s</text>
<text x="225" y="50">e</text>
<text x="235" y="50">d</text>
<text x="255" y="50">d</text>
<text x="265" y="50">a</text>
<text x="275" y="50">t</text>
<text x="285" y="50">a</text>
<text x="295" y="50">)</text>
<line x1="385" y1="40" x2="385" y2="60"/>
<line x1="5" y1="60" x2="5" y2="80"/>
<line x1="5" y1="70" x2="10" y2="70"/>
<line x1="10" y1="70" x2="20" y2="70"/>
<line x1="20" y1="70" x2="30" y2="70"/>
<line x1="30" y1="70" x2="40" y2="70"/>
<line x1="40" y1="70" x2="50" y2="70"/>
<line x1="50" y1="70" x2="60" y2="70"/>
<line x1="60" y1="70" x2="70" y2="70"/>
<line x1="70" y1="70" x2="80" y2="70"/>
<line x1="80" y1="70" x2="90" y2="70"/>
<line x1="90" y1="70" x2="100" y2="70"/>
<line x1="100" y1="70" x2="110" y2="70"/>
<line x1="110" y1="70" x2="120" y2="70"/>
<line x1="120" y1="70" x2="130" y2="70"/>
<line x1="130" y1="70" x2="140" y2="70"/>
<line x1="140" y1="70" x2="150" y2="70"/>
<line x1="150" y1="70" x2="160" y2="70"/>
<line x1="160" y1="70" x2="170" y2="70"/>
<line x1="170" y1="70" x2="180" y2="70"/>
<line x1="180" y1="70" x2="190" y2="70"/>
<line x1="190" y1="70" x2="200" y2="70"/>
<line x1="200" y1="70" x2="210" y2="70"/>
<line x1="210" y1="70" x2="220" y2="70"/>
<line x1="220" y1="70" x2="230" y2="70"/>
<line x1="230" y1="70" x2="240" y2="70"/>
<line x1="240" y1="70" x2="250" y2="70"/>
<line x1="250" y1="70" x2="260" y2="70"/>
<line x1="260" y1="70" x2="270" y2="70"/>
<line x1="270" y1="70" x2="280" y2="70"/>
<line x1="280" y1="70" x2="290" y2="70"/>
<line x1="290" y1="70" x2="300" y2="70"/>
<line x1="300" y1="70" x2="310" y2="70"/>
<line x1="310" y1="70" x2="320" y2="70"/>
<line x1="320" y1="70" x2="330" y2="70"/>
<line x1="330" y1="70" x2="340" y2="70"/>
<line x1="340" y1="70" x2="350" y2="70"/>
<line x1="350" y1="70" x2="360" y2="70"/>
<line x1="360" y1="70" x2="370" y2="70"/>
<line x1="370" y1="70" x2="380" y2="70"/>
<line x1="385" y1="60" x2="385" y2="80"/>
<line x1="380" y1="70" x2="385" y2="70"/>
<line x1="5" y1="80" x2="5" y2="100"/>
<text x="95" y="90">C</text>
<text x="105" y="90">o</text>
<text x="115" y="90">n</text>
<text x="125" y="90">t</text>
<text x="135" y="90">e</text>
<text x="145" y="90">n</text>
<text x="155" y="90">t</text>
<text x="165" y="90">-</text>
<text x="175" y="90">A</text>
<text x="185" y="90">d</text>
<text x="195" y="90">d</text>
<text x="205" y="90">r</text>
<text x="215" y="90">e</text>
<text x="225" y="90">s</text>
<text x="235" y="90">s</text>
<text x="245" y="90">i</text>
<text x="255" y="90">n</text>
<text x="265" y="90">g</text>
<line x1="385" y1="80" x2="385" y2="100"/>
<line x1="5" y1="100" x2="5" y2="120"/>
<text x="55" y="110">(</text>
<text x="65" y="110">h</text>
<text x="75" y="110">a</text>
<text x="85" y="110">s</text>
<text x="95" y="110">h</text>
<text x="115" y="110">o</text>
<text x="125" y="110">f</text>
<text x="145" y="110">u</text>
<text x="155" y="110">n</text>
<text x="165" y="110">c</text>
<text x="175" y="110">o</text>
<text x="185" y="110">m</text>
<text x="195" y="110">p</text>
<text x="205" y="110">r</text>
<text x="215" y="110">e</text>
<text x="225" y="110">s</text>
<text x="235" y="110">s</text>
<text x="245" y="110">e</text>
<text x="255" y="110">d</text>
<text x="275" y="110">d</text>
<text x="285" y="110">a</text>
<text x="295" y="110">t</text>
<text x="305" y="110">a</text>
<text x="315" y="110">)</text>
<line x1="385" y1="100" x2="385" y2="120"/>
<line x1="5" y1="120" x2="5" y2="140"/>
<line x1="5" y1="130" x2="10" y2="130"/>
<line x1="10" y1="130" x2="20" y2="130"/>
<line x1="20" y1="130" x2="30" y2="130"/>
<line x1="30" y1="130" x2="40" y2="130"/>
<line x1="40" y1="130" x2="50" y2="130"/>
<line x1="50" y1="130" x2="60" y2="130"/>
<line x1="60" y1="130" x2="70" y2="130"/>
<line x1="70" y1="130" x2="80" y2="130"/>
<line x1="80" y1="130" x2="90" y2="130"/>
<line x1="90" y1="130" x2="100" y2="130"/>
<line x1="100" y1="130" x2="110" y2="130"/>
<line x1="110" y1="130" x2="120" y2="130"/>
<line x1="120" y1="130" x2="130" y2="130"/>
<line x1="130" y1="130" x2="140" y2="130"/>
<line x1="140" y1="130" x2="150" y2="130"/>
<line x1="150" y1="130" x2="160" y2="130"/>
<line x1="160" y1="130" x2="170" y2="130"/>
<line x1="170" y1="130" x2="180" y2="130"/>
<line x1="180" y1="130" x2="190" y2="130"/>
<line x1="190" y1="130" x2="200" y2="130"/>
<line x1="200" y1="130" x2="210" y2="130"/>
<line x1="210" y1="130" x2="220" y2="130"/>
<line x1="220" y1="130" x2="230" y2="130"/>
<line x1="230" y1="130" x2="240" y2="130"/>
<line x1="240" y1="130" x2="250" y2="130"/>
<line x1="250" y1="130" x2="260" y2="130"/>
<line x1="260" y1="130" x2="270" y2="130"/>
<line x1="270" y1="130" x2="280" y2="130"/>
<line x1="280" y1="130" x2="290" y2="130"/>
<line x1="290" y1="130" x2="300" y2="130"/>
<line x1="300" y1="130" x2="310" y2="130"/>
<line x1="310" y1="130" x2="320" y2="130"/>
<line x1="320" y1="130" x2="330" y2="130"/>
<line x1="330" y1="130" x2="340" y2="130"/>
<line x1="340" y1="130" x2="350" y2="130"/>
<line x1="350" y1="130" x2="360" y2="130"/>
<line x1="360" y1="130" x2="370" y2="130"/>
<line x1="370" y1="130" x2="380" y2="130"/>
<line x1="385" y1="120" x2="385" y2="140"/>
<line x1="380" y1="130" x2="385" y2="130"/>
<line x1="5" y1="140" x2="5" y2="160"/>
<text x="95" y="150">C</text>
<text x="105" y="150">o</text>
<text x="115" y="150">m</text>
<text x="125" y="150">p</text>
<text x="135" y="150">r</text>
<text x="145" y="150">e</text>
<text x="155" y="150">s</text>
<text x="165" y="150">s</text>
<text x="175" y="150">i</text>
<text x="185" y="150">o</text>
<text x="195" y="150">n</text>
<text x="215" y="150">L</text>
<text x="225" y="150">a</text>
<text x="235" y="150">y</text>
<text x="245" y="150">e</text>
<text x="255" y="150">r</text>
<line x1="385" y1="140" x2="385" y2="160"/>
<line x1="5" y1="160" x2="5" y2="180"/>
<text x="75" y="170">(</text>
<text x="85" y="170">t</text>
<text x="95" y="170">r</text>
<text x="105" y="170">a</text>
<text x="115" y="170">n</text>
<text x="125" y="170">s</text>
<text x="135" y="170">p</text>
<text x="145" y="170">a</text>
<text x="155" y="170">r</text>
<text x="165" y="170">e</text>
<text x="175" y="170">n</text>
<text x="185" y="170">t</text>
<text x="205" y="170">c</text>
<text x="215" y="170">o</text>
<text x="225" y="170">m</text>
<text x="235" y="170">p</text>
<text x="245" y="170">r</text>
<text x="255" y="170">e</text>
<text x="265" y="170">s</text>
<text x="275" y="170">s</text>
<text x="285" y="170">i</text>
<text x="295" y="170">o</text>
<text x="305" y="170">n</text>
<text x="315" y="170">)</text>
<line x1="385" y1="160" x2="385" y2="180"/>
<line x1="5" y1="180" x2="5" y2="200"/>
<line x1="5" y1="190" x2="10" y2="190"/>
<line x1="10" y1="190" x2="20" y2="190"/>
<line x1="20" y1="190" x2="30" y2="190"/>
<line x1="30" y1="190" x2="40" y2="190"/>
<line x1="40" y1="190" x2="50" y2="190"/>
<line x1="50" y1="190" x2="60" y2="190"/>
<line x1="60" y1="190" x2="70" y2="190"/>
<line x1="70" y1="190" x2="80" y2="190"/>
<line x1="80" y1="190" x2="90" y2="190"/>
<line x1="90" y1="190" x2="100" y2="190"/>
<line x1="100" y1="190" x2="110" y2="190"/>
<line x1="110" y1="190" x2="120" y2="190"/>
<line x1="120" y1="190" x2="130" y2="190"/>
<line x1="130" y1="190" x2="140" y2="190"/>
<line x1="140" y1="190" x2="150" y2="190"/>
<line x1="150" y1="190" x2="160" y2="190"/>
<line x1="160" y1="190" x2="170" y2="190"/>
<line x1="170" y1="190" x2="180" y2="190"/>
<line x1="180" y1="190" x2="190" y2="190"/>
<line x1="190" y1="190" x2="200" y2="190"/>
<line x1="200" y1="190" x2="210" y2="190"/>
<line x1="210" y1="190" x2="220" y2="190"/>
<line x1="220" y1="190" x2="230" y2="190"/>
<line x1="230" y1="190" x2="240" y2="190"/>
<line x1="240" y1="190" x2="250" y2="190"/>
<line x1="250" y1="190" x2="260" y2="190"/>
<line x1="260" y1="190" x2="270" y2="190"/>
<line x1="270" y1="190" x2="280" y2="190"/>
<line x1="280" y1="190" x2="290" y2="190"/>
<line x1="290" y1="190" x2="300" y2="190"/>
<line x1="300" y1="190" x2="310" y2="190"/>
<line x1="310" y1="190" x2="320" y2="190"/>
<line x1="320" y1="190" x2="330" y2="190"/>
<line x1="330" y1="190" x2="340" y2="190"/>
<line x1="340" y1="190" x2="350" y2="190"/>
<line x1="350" y1="190" x2="360" y2="190"/>
<line x1="360" y1="190" x2="370" y2="190"/>
<line x1="370" y1="190" x2="380" y2="190"/>
<line x1="385" y1="180" x2="385" y2="200"/>
<line x1="380" y1="190" x2="385" y2="190"/>
<line x1="5" y1="200" x2="5" y2="220"/>
<text x="105" y="210">S</text>
<text x="115" y="210">t</text>
<text x="125" y="210">o</text>
<text x="135" y="210">r</text>
<text x="145" y="210">a</text>
<text x="155" y="210">g</text>
<text x="165" y="210">e</text>
<text x="185" y="210">L</text>
<text x="195" y="210">a</text>
<text x="205" y="210">y</text>
<text x="215" y="210">e</text>
<text x="225" y="210">r</text>
<line x1="385" y1="200" x2="385" y2="220"/>
<line x1="5" y1="220" x2="5" y2="240"/>
<text x="65" y="230">(</text>
<text x="75" y="230">s</text>
<text x="85" y="230">t</text>
<text x="95" y="230">o</text>
<text x="105" y="230">r</text>
<text x="115" y="230">e</text>
<text x="125" y="230">s</text>
<text x="145" y="230">c</text>
<text x="155" y="230">o</text>
<text x="165" y="230">m</text>
<text x="175" y="230">p</text>
<text x="185" y="230">r</text>
<text x="195" y="230">e</text>
<text x="205" y="230">s</text>
<text x="215" y="230">s</text>
<text x="225" y="230">e</text>
<text x="235" y="230">d</text>
<text x="255" y="230">d</text>
<text x="265" y="230">a</text>
<text x="275" y="230">t</text>
<text x="285" y="230">a</text>
<text x="295" y="230">)</text>
<line x1="385" y1="220" x2="385" y2="240"/>
<line x1="5" y1="250" x2="10" y2="250"/>
<line x1="5" y1="240" x2="5" y2="250"/>
<line x1="10" y1="250" x2="20" y2="250"/>
<line x1="20" y1="250" x2="30" y2="250"/>
<line x1="30" y1="250" x2="40" y2="250"/>
<line x1="40" y1="250" x2="50" y2="250"/>
<line x1="50" y1="250" x2="60" y2="250"/>
<line x1="60" y1="250" x2="70" y2="250"/>
<line x1="70" y1="250" x2="80" y2="250"/>
<line x1="80" y1="250" x2="90" y2="250"/>
<line x1="90" y1="250" x2="100" y2="250"/>
<line x1="100" y1="250" x2="110" y2="250"/>
<line x1="110" y1="250" x2="120" y2="250"/>
<line x1="120" y1="250" x2="130" y2="250"/>
<line x1="130" y1="250" x2="140" y2="250"/>
<line x1="140" y1="250" x2="150" y2="250"/>
<line x1="150" y1="250" x2="160" y2="250"/>
<line x1="160" y1="250" x2="170" y2="250"/>
<line x1="170" y1="250" x2="180" y2="250"/>
<line x1="180" y1="250" x2="190" y2="250"/>
<line x1="190" y1="250" x2="200" y2="250"/>
<line x1="200" y1="250" x2="210" y2="250"/>
<line x1="210" y1="250" x2="220" y2="250"/>
<line x1="220" y1="250" x2="230" y2="250"/>
<line x1="230" y1="250" x2="240" y2="250"/>
<line x1="240" y1="250" x2="250" y2="250"/>
<line x1="250" y1="250" x2="260" y2="250"/>
<line x1="260" y1="250" x2="270" y2="250"/>
<line x1="270" y1="250" x2="280" y2="250"/>
<line x1="280" y1="250" x2="290" y2="250"/>
<line x1="290" y1="250" x2="300" y2="250"/>
<line x1="300" y1="250" x2="310" y2="250"/>
<line x1="310" y1="250" x2="320" y2="250"/>
<line x1="320" y1="250" x2="330" y2="250"/>
<line x1="330" y1="250" x2="340" y2="250"/>
<line x1="340" y1="250" x2="350" y2="250"/>
<line x1="350" y1="250" x2="360" y2="250"/>
<line x1="360" y1="250" x2="370" y2="250"/>
<line x1="370" y1="250" x2="380" y2="250"/>
<line x1="380" y1="250" x2="385" y2="250"/>
<line x1="385" y1="240" x2="385" y2="250"/>
</svg>
</div>
<h3>Compression Metadata</h3>
<pre class="language-scheme">
(define (compress-object data algorithm)
  (let* ((compressed (compress algorithm data))
         (ratio (/ (bytevector-length compressed)
                   (bytevector-length data))))
    `(compressed-object
      (algorithm ,algorithm)
      (original-size ,(bytevector-length data))
      (compressed-size ,(bytevector-length compressed))
      (ratio ,ratio)
      (data ,compressed))))

;; Stored in soup
(soup-object
  (hash "sha256:original-content-hash...")
  (compression
    (algorithm zstd)
    (level 3)
    (original-size 1048576)
    (compressed-size 524288)
    (ratio 0.5)))
</pre>
</section>
<section>
<h2>Compression Algorithms</h2>
<h3>Supported Algorithms</h3>
<pre class="language-scheme">
(define compression-algorithms
  `((zstd . ((extension . "zst")
             (levels . (1 3 9 19))
             (default-level . 3)
             (dictionary . #t)))
    (lz4 . ((extension . "lz4")
            (levels . (1 9))
            (default-level . 1)
            (dictionary . #f)))
    (gzip . ((extension . "gz")
             (levels . (1 6 9))
             (default-level . 6)
             (dictionary . #f)))
    (none . ((extension . #f)
             (levels . ())
             (default-level . #f)
             (dictionary . #f)))))
</pre>
<h3>Algorithm Selection</h3>
<pre class="language-scheme">
(define (select-compression-algorithm content-type size)
  "Select best algorithm for content"
  (cond
    ;; Already compressed formats
    ((member content-type '("image/jpeg" "image/png" "video/mp4"
                           "application/zip" "application/gzip"))
     'none)
    ;; Small objects - overhead not worth it
    ((&lt; size 1024)
     'none)
    ;; Text and code - zstd with dictionary
    ((member content-type '("text/plain" "text/html" "application/json"
                           "application/javascript" "text/x-scheme"))
     'zstd)
    ;; Binary data - lz4 for speed
    ((string-prefix? "application/" content-type)
     'lz4)
    ;; Default
    (else 'zstd)))
</pre>
<h3>Zstd Dictionaries</h3>
<pre class="language-scheme">
;; Train dictionary on sample data
(define (train-dictionary samples dict-size)
  "Train zstd dictionary from sample data"
  (zstd-train-dictionary samples dict-size))

;; Content-type specific dictionaries
(define dictionaries
  `((scheme . ,(load-dictionary "scheme.dict"))
    (json . ,(load-dictionary "json.dict"))
    (markdown . ,(load-dictionary "markdown.dict"))))

(define (compress-with-dictionary data content-type)
  (let ((dict (assoc-ref dictionaries content-type)))
    (if dict
        (zstd-compress-with-dict data dict)
        (zstd-compress data))))
</pre>
</section>
<section>
<h2>Compression Operations</h2>
<h3>Transparent Compression</h3>
<pre class="language-scheme">
(define (cas-put-compressed data)
  "Store data with transparent compression"
  (let ((hash (content-hash data))  ; Hash uncompressed
         (algorithm (select-compression-algorithm
                     (detect-content-type data)
                     (bytevector-length data)))
         (stored (if (eq? algorithm 'none)
                     data
                     (compress algorithm data))))
    ;; Store compressed, index by uncompressed hash
    (storage-put hash stored)
    ;; Record compression metadata
    (soup-put hash
      compression: `((algorithm . ,algorithm)
                     (original-size . ,(bytevector-length data))
                     (compressed-size . ,(bytevector-length stored))))
    hash))

(define (cas-get-decompressed hash)
  "Retrieve and decompress data"
  (let ((stored (storage-get hash))
         (meta (soup-get hash))
         (algorithm (assoc-ref (assoc-ref meta 'compression) 'algorithm)))
    (if (or (not algorithm) (eq? algorithm 'none))
        stored
        (decompress algorithm stored))))
</pre>
<h3>Batch Compression</h3>
<pre class="language-scheme">
(define (compress-batch objects)
  "Compress multiple objects efficiently"
  ;; Group by content type for dictionary efficiency
  (let ((groups (group-by detect-content-type objects)))
    (append-map
      (lambda (group)
        (let ((content-type (car group))
              (items (cdr group)))
          (map (lambda (obj)
                 (compress-with-dictionary obj content-type))
               items)))
      groups)))
</pre>
<h3>Recompression</h3>
<pre class="language-scheme">
(define (recompress-object hash new-algorithm new-level)
  "Recompress object with different settings"
  (let* ((data (cas-get-decompressed hash))
         (new-compressed (compress new-algorithm data new-level)))
    (storage-put hash new-compressed)
    (soup-update hash
      compression: `((algorithm . ,new-algorithm)
                     (level . ,new-level)
                     (original-size . ,(bytevector-length data))
                     (compressed-size . ,(bytevector-length new-compressed))))
    (audit-append action: 'recompressed
                  hash: hash
                  algorithm: new-algorithm)))
</pre>
</section>
<section>
<h2>Deduplication</h2>
<h3>Content-Based Deduplication</h3>
<pre class="language-scheme">
;; Content addressing provides automatic deduplication
(define (store-deduplicated data)
  (let ((hash (content-hash data)))
    (if (cas-exists? hash)
        (begin
          ;; Increment reference count
          (soup-update hash ref-count: (+ 1 (soup-ref-count hash)))
          (audit-append action: 'deduplicated hash: hash)
          hash)
        (cas-put data))))
</pre>
<h3>Block-Level Deduplication</h3>
<pre class="language-scheme">
;; Split large objects into blocks
(define block-size 65536)  ; 64KB

(define (chunk-object data)
  "Split object into content-defined chunks"
  (let ((chunks '())
        (pos 0))
    (while (&lt; pos (bytevector-length data))
      (let ((boundary (find-chunk-boundary data pos)))
        (set! chunks (cons (subbytevector data pos boundary) chunks))
        (set! pos boundary)))
    (reverse chunks)))

;; Content-defined chunking (Rabin fingerprint)
(define (find-chunk-boundary data start)
  "Find chunk boundary using rolling hash"
  (let ((min-size 4096)
        (max-size 131072)
        (mask #x1FFF))  ; Average 8KB chunks
    (let loop ((pos (+ start min-size)))
      (cond
        ((&gt;= pos (min (+ start max-size) (bytevector-length data)))
         pos)
        ((= (bitwise-and (rabin-hash data pos) mask) 0)
         pos)
        (else (loop (+ pos 1)))))))
</pre>
<h3>Chunk Storage</h3>
<pre class="language-scheme">
(define (store-chunked data)
  "Store large object as deduplicated chunks"
  (let ((chunks (chunk-object data))
         (chunk-hashes (map (lambda (chunk)
                              (store-deduplicated chunk))
                            chunks)))
    ;; Store manifest
    (let ((manifest `(chunked-object
                      (chunks ,chunk-hashes)
                      (total-size ,(bytevector-length data))
                      (chunk-count ,(length chunks)))))
      (cas-put (serialize manifest)))))

(define (retrieve-chunked manifest-hash)
  "Reassemble chunked object"
  (let ((manifest (deserialize (cas-get manifest-hash)))
         (chunks (map cas-get (assoc-ref manifest 'chunks))))
    (bytevector-concatenate chunks)))
</pre>
<h3>Deduplication Statistics</h3>
<pre class="language-scheme">
(define (deduplication-stats)
  "Calculate deduplication effectiveness"
  (let* ((objects (soup-query type: 'any))
         (logical-size (sum (map soup-original-size objects)))
         (physical-size (sum (map soup-compressed-size
                                  (delete-duplicates objects hash=?)))))
    `((logical-size . ,logical-size)
      (physical-size . ,physical-size)
      (dedup-ratio . ,(/ logical-size physical-size))
      (space-saved . ,(- logical-size physical-size)))))
</pre>
</section>
<section>
<h2>Delta Compression</h2>
<h3>Version Deltas</h3>
<pre class="language-scheme">
(define (store-delta base-hash new-data)
  "Store object as delta from base"
  (let ((base-data (cas-get base-hash))
         (delta (compute-delta base-data new-data))
         (new-hash (content-hash new-data)))
    (if (&lt; (bytevector-length delta)
           ( 0.5 (bytevector-length new-data)))
        ;; Delta is worthwhile
        (begin
          (storage-put new-hash delta)
          (soup-put new-hash
            delta: `((base . ,base-hash)
                     (type . xdelta)))
          new-hash)
        ;; Store full object
        (cas-put new-data))))

(define (retrieve-delta hash)
  "Reconstruct object from delta"
  (let ((meta (soup-get hash)))
    (if (assoc-ref meta 'delta)
        (let* ((base-hash (assoc-ref (assoc-ref meta 'delta) 'base))
               (base-data (cas-get base-hash))
               (delta (storage-get hash)))
          (apply-delta base-data delta))
        (storage-get hash))))
</pre>
<h3>Delta Chains</h3>
<pre class="language-scheme">
;; Limit delta chain depth
(define max-delta-depth 10

(define (delta-chain-depth hash)
  "Calculate depth of delta chain"
  (let ((meta (soup-get hash)))
    (if (assoc-ref meta 'delta)
        (+ 1 (delta-chain-depth (assoc-ref (assoc-ref meta 'delta) 'base)))
        0)))

(define (should-store-delta? base-hash)
  "Check if delta storage is appropriate"
  (&lt; (delta-chain-depth base-hash) max-delta-depth))
</pre>
</section>
<section>
<h2>Archive Compression</h2>
<h3>Sealed Archive Format</h3>
<pre class="language-scheme">
;; Memo-018 integration
(define (create-compressed-archive objects)
  "Create compressed sealed archive"
  (let* ((serialized (serialize-objects objects))
         (compressed (zstd-compress serialized 19))  ; Max compression
         (encrypted (age-encrypt compressed recipients)))
    (cas-put encrypted)))
</pre>
<h3>Streaming Compression</h3>
<pre class="language-scheme">
(define (stream-compress input-port output-port algorithm)
  "Stream compression for large files"
  (let ((ctx (compression-context-create algorithm)))
    (let loop ()
      (let ((chunk (read-bytevector chunk-size input-port)))
        (unless (eof-object? chunk)
          (write-bytevector (compress-chunk ctx chunk) output-port)
          (loop))))
    (write-bytevector (compress-finish ctx) output-port)))
</pre>
</section>
<section>
<h2>Performance Optimization</h2>
<h3>Compression Cache</h3>
<pre class="language-scheme">
(define compression-cache (make-lru-cache 1000))

(define (cached-decompress hash)
  "Cache decompressed data for frequent access"
  (or (lru-get compression-cache hash)
      (let ((data (cas-get-decompressed hash)))
        (lru-put! compression-cache hash data)
        data)))
</pre>
<h3>Parallel Compression</h3>
<pre class="language-scheme">
(define (parallel-compress objects num-threads)
  "Compress multiple objects in parallel"
  (let ((work-queue (make-channel))
        (results (make-channel)))
    ;; Start workers
    (do ((i 0 (+ i 1)))
        ((= i num-threads))
      (thread-start!
        (make-thread
          (lambda ()
            (let loop ()
              (let ((obj (channel-get! work-queue)))
                (when obj
                  (channel-put! results (compress-object obj))
                  (loop))))))))
    ;; Queue work
    (for-each (lambda (obj) (channel-put! work-queue obj)) objects)
    ;; Collect results
    (map (lambda (_) (channel-get! results)) objects)))
</pre>
<h3>Adaptive Compression</h3>
<pre class="language-scheme">
(define (adaptive-compress data)
  "Select compression based on content analysis"
  (let* ((sample (subbytevector data 0 (min 4096 (bytevector-length data))))
         (entropy (calculate-entropy sample)))
    (cond
      ;; High entropy - already compressed or encrypted
      ((&gt; entropy 7.9) 'none)
      ;; Low entropy - highly compressible
      ((&lt; entropy 4.0) (values 'zstd 19))
      ;; Medium entropy - balanced
      (else (values 'zstd 3)))))
</pre>
</section>
<section>
<h2>Integrity</h2>
<h3>Verification</h3>
<pre class="language-scheme">
(define (verify-compressed-object hash)
  "Verify compressed object integrity"
  (let* ((stored (storage-get hash))
         (meta (soup-get hash))
         (decompressed (decompress (assoc-ref meta 'algorithm) stored))
         (computed-hash (content-hash decompressed)))
    (equal? hash computed-hash)))
</pre>
<h3>Corruption Recovery</h3>
<pre class="language-scheme">
(define (recover-compressed hash)
  "Attempt to recover corrupted compressed object"
  ;; Try partial decompression
  (let ((partial (decompress-partial hash)))
    (when partial
      (audit-append action: 'partial-recovery hash: hash)
      partial))

  ;; Fetch from replica
  (let ((replica-data (fetch-from-replica hash)))
    (when replica-data
      (storage-put hash replica-data)
      replica-data)))
</pre>
</section>
<section>
<h2>References</h2>
<p>1. [Zstandard](https://github.com/facebook/zstd) - Facebook's compression algorithm 2. [Content-Defined Chunking](https://restic.net/blog/2015-09-12/restic-foundation1-cdc/) - Restic blog 3. [Memo-018: Sealed Archive Format](memo-018-sealed-archive.html) 4. [Memo-020: Content-Addressed Storage](memo-020-content-addressed-storage.html)</p>
</section>
<section>
<h2>Changelog</h2>
<ul>
<li>2026-01-07</li>
<li>Initial draft</li>
</ul>
</section>
<script>
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}
(function() {
  // Query param override (for REPL: ?theme=dark or ?theme=light)
  const params = new URLSearchParams(window.location.search);
  const param = params.get('theme');
  if (param === 'dark' || param === 'light') {
    document.documentElement.setAttribute('data-theme', param);
    localStorage.setItem('theme', param);
    return;
  }
  // localStorage preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</body>
</html>
