<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <title>Memo 0049: Access Control and Audit Co-Design</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27%230f0%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>">
  <script>
(function(){
  var h=new Date().getHours(),c;
  if(h>=4&&h<6)c='%23845EC2';       // brahma muhurta - violet
  else if(h>=6&&h<8)c='%23ffd700';  // dawn - gold
  else if(h>=8&&h<11)c='%2300d4aa'; // morning - teal
  else if(h>=11&&h<14)c='%230f0';   // midday - phosphor
  else if(h>=14&&h<17)c='%2339ff14';// afternoon - neon
  else if(h>=17&&h<19)c='%23ff6600';// sunset - orange
  else if(h>=19&&h<22)c='%23ff3366';// evening - coral
  else c='%2300ffff';               // night - cyan
  document.getElementById('favicon').href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27'+c+'%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>';
})();
</script>
  <link rel="stylesheet" href="memo.css">
</head>
<body>
<span class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark">[theme]</span>
<h1>Memo 0049: Access Control and Audit Co-Design</h1>
<dl class="metadata">
</dl>
<hr>
<section>
<h2>Abstract</h2>
<p>This Memo establishes the principle that access control and auditing must be designed together, not separately. Every access control decision point produces three outputs: a decision, an effect, and a record. Audit policy is per-realm, with lean defaults.</p>
</section>
<section>
<h2>Motivation</h2>
<p>Security systems often treat auditing as an afterthought—bolted on after access control is designed. This leads to:</p>
<ul>
<li>Incomplete coverage: Some decisions are never logged</li>
<li>Inconsistent records: Different formats at different points</li>
<li>Performance surprises: Auditing added late without cost analysis</li>
<li>Policy gaps: No framework for what to log when</li>
</ul>
<p>The solution: co-design access control and auditing from the start.</p>
</section>
<section>
<h2>Design Principle</h2>
<p>Access control and auditing are co-designed, not bolted on.</p>
<p>Every access control point has three outputs:</p>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 390 240" width="390" height="240" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<line x1="5" y1="10" x2="10" y2="10"/>
<line x1="5" y1="10" x2="5" y2="20"/>
<line x1="10" y1="10" x2="20" y2="10"/>
<line x1="20" y1="10" x2="30" y2="10"/>
<line x1="30" y1="10" x2="40" y2="10"/>
<line x1="40" y1="10" x2="50" y2="10"/>
<line x1="50" y1="10" x2="60" y2="10"/>
<line x1="60" y1="10" x2="70" y2="10"/>
<line x1="70" y1="10" x2="80" y2="10"/>
<line x1="80" y1="10" x2="90" y2="10"/>
<line x1="90" y1="10" x2="100" y2="10"/>
<line x1="100" y1="10" x2="110" y2="10"/>
<line x1="110" y1="10" x2="120" y2="10"/>
<line x1="120" y1="10" x2="130" y2="10"/>
<line x1="130" y1="10" x2="140" y2="10"/>
<line x1="140" y1="10" x2="150" y2="10"/>
<line x1="150" y1="10" x2="160" y2="10"/>
<line x1="160" y1="10" x2="170" y2="10"/>
<line x1="170" y1="10" x2="180" y2="10"/>
<line x1="180" y1="10" x2="190" y2="10"/>
<line x1="190" y1="10" x2="200" y2="10"/>
<line x1="200" y1="10" x2="210" y2="10"/>
<line x1="210" y1="10" x2="220" y2="10"/>
<line x1="220" y1="10" x2="230" y2="10"/>
<line x1="230" y1="10" x2="240" y2="10"/>
<line x1="240" y1="10" x2="250" y2="10"/>
<line x1="250" y1="10" x2="260" y2="10"/>
<line x1="260" y1="10" x2="270" y2="10"/>
<line x1="270" y1="10" x2="280" y2="10"/>
<line x1="280" y1="10" x2="290" y2="10"/>
<line x1="290" y1="10" x2="300" y2="10"/>
<line x1="300" y1="10" x2="310" y2="10"/>
<line x1="310" y1="10" x2="320" y2="10"/>
<line x1="320" y1="10" x2="330" y2="10"/>
<line x1="330" y1="10" x2="340" y2="10"/>
<line x1="340" y1="10" x2="350" y2="10"/>
<line x1="350" y1="10" x2="360" y2="10"/>
<line x1="360" y1="10" x2="370" y2="10"/>
<line x1="370" y1="10" x2="380" y2="10"/>
<line x1="380" y1="10" x2="385" y2="10"/>
<line x1="385" y1="10" x2="385" y2="20"/>
<line x1="5" y1="20" x2="5" y2="40"/>
<text x="105" y="30">A</text>
<text x="115" y="30">c</text>
<text x="125" y="30">c</text>
<text x="135" y="30">e</text>
<text x="145" y="30">s</text>
<text x="155" y="30">s</text>
<text x="175" y="30">C</text>
<text x="185" y="30">o</text>
<text x="195" y="30">n</text>
<text x="205" y="30">t</text>
<text x="215" y="30">r</text>
<text x="225" y="30">o</text>
<text x="235" y="30">l</text>
<text x="255" y="30">P</text>
<text x="265" y="30">o</text>
<text x="275" y="30">i</text>
<text x="285" y="30">n</text>
<text x="295" y="30">t</text>
<line x1="385" y1="20" x2="385" y2="40"/>
<line x1="5" y1="40" x2="5" y2="60"/>
<line x1="5" y1="50" x2="10" y2="50"/>
<line x1="10" y1="50" x2="20" y2="50"/>
<line x1="20" y1="50" x2="30" y2="50"/>
<line x1="30" y1="50" x2="40" y2="50"/>
<line x1="40" y1="50" x2="50" y2="50"/>
<line x1="50" y1="50" x2="60" y2="50"/>
<line x1="60" y1="50" x2="70" y2="50"/>
<line x1="70" y1="50" x2="80" y2="50"/>
<line x1="80" y1="50" x2="90" y2="50"/>
<line x1="90" y1="50" x2="100" y2="50"/>
<line x1="100" y1="50" x2="110" y2="50"/>
<line x1="110" y1="50" x2="120" y2="50"/>
<line x1="120" y1="50" x2="130" y2="50"/>
<line x1="130" y1="50" x2="140" y2="50"/>
<line x1="140" y1="50" x2="150" y2="50"/>
<line x1="150" y1="50" x2="160" y2="50"/>
<line x1="160" y1="50" x2="170" y2="50"/>
<line x1="170" y1="50" x2="180" y2="50"/>
<line x1="180" y1="50" x2="190" y2="50"/>
<line x1="190" y1="50" x2="200" y2="50"/>
<line x1="200" y1="50" x2="210" y2="50"/>
<line x1="210" y1="50" x2="220" y2="50"/>
<line x1="220" y1="50" x2="230" y2="50"/>
<line x1="230" y1="50" x2="240" y2="50"/>
<line x1="240" y1="50" x2="250" y2="50"/>
<line x1="250" y1="50" x2="260" y2="50"/>
<line x1="260" y1="50" x2="270" y2="50"/>
<line x1="270" y1="50" x2="280" y2="50"/>
<line x1="280" y1="50" x2="290" y2="50"/>
<line x1="290" y1="50" x2="300" y2="50"/>
<line x1="300" y1="50" x2="310" y2="50"/>
<line x1="310" y1="50" x2="320" y2="50"/>
<line x1="320" y1="50" x2="330" y2="50"/>
<line x1="330" y1="50" x2="340" y2="50"/>
<line x1="340" y1="50" x2="350" y2="50"/>
<line x1="350" y1="50" x2="360" y2="50"/>
<line x1="360" y1="50" x2="370" y2="50"/>
<line x1="370" y1="50" x2="380" y2="50"/>
<line x1="385" y1="40" x2="385" y2="60"/>
<line x1="380" y1="50" x2="385" y2="50"/>
<line x1="5" y1="60" x2="5" y2="80"/>
<text x="25" y="70">I</text>
<text x="35" y="70">n</text>
<text x="45" y="70">p</text>
<text x="55" y="70">u</text>
<text x="65" y="70">t</text>
<text x="75" y="70">:</text>
<text x="105" y="70">p</text>
<text x="115" y="70">r</text>
<text x="125" y="70">i</text>
<text x="135" y="70">n</text>
<text x="145" y="70">c</text>
<text x="155" y="70">i</text>
<text x="165" y="70">p</text>
<text x="175" y="70">a</text>
<text x="185" y="70">l</text>
<text x="195" y="70">,</text>
<text x="215" y="70">a</text>
<text x="225" y="70">c</text>
<text x="235" y="70">t</text>
<text x="245" y="70">i</text>
<text x="255" y="70">o</text>
<text x="265" y="70">n</text>
<text x="275" y="70">,</text>
<text x="295" y="70">c</text>
<text x="305" y="70">o</text>
<text x="315" y="70">n</text>
<text x="325" y="70">t</text>
<text x="335" y="70">e</text>
<text x="345" y="70">x</text>
<text x="355" y="70">t</text>
<line x1="385" y1="60" x2="385" y2="80"/>
<line x1="5" y1="80" x2="5" y2="100"/>
<line x1="5" y1="90" x2="10" y2="90"/>
<line x1="10" y1="90" x2="20" y2="90"/>
<line x1="20" y1="90" x2="30" y2="90"/>
<line x1="30" y1="90" x2="40" y2="90"/>
<line x1="40" y1="90" x2="50" y2="90"/>
<line x1="50" y1="90" x2="60" y2="90"/>
<line x1="60" y1="90" x2="70" y2="90"/>
<line x1="70" y1="90" x2="80" y2="90"/>
<line x1="80" y1="90" x2="90" y2="90"/>
<line x1="90" y1="90" x2="100" y2="90"/>
<line x1="100" y1="90" x2="110" y2="90"/>
<line x1="110" y1="90" x2="120" y2="90"/>
<line x1="120" y1="90" x2="130" y2="90"/>
<line x1="130" y1="90" x2="140" y2="90"/>
<line x1="140" y1="90" x2="150" y2="90"/>
<line x1="150" y1="90" x2="160" y2="90"/>
<line x1="160" y1="90" x2="170" y2="90"/>
<line x1="170" y1="90" x2="180" y2="90"/>
<line x1="180" y1="90" x2="190" y2="90"/>
<line x1="190" y1="90" x2="200" y2="90"/>
<line x1="200" y1="90" x2="210" y2="90"/>
<line x1="210" y1="90" x2="220" y2="90"/>
<line x1="220" y1="90" x2="230" y2="90"/>
<line x1="230" y1="90" x2="240" y2="90"/>
<line x1="240" y1="90" x2="250" y2="90"/>
<line x1="250" y1="90" x2="260" y2="90"/>
<line x1="260" y1="90" x2="270" y2="90"/>
<line x1="270" y1="90" x2="280" y2="90"/>
<line x1="280" y1="90" x2="290" y2="90"/>
<line x1="290" y1="90" x2="300" y2="90"/>
<line x1="300" y1="90" x2="310" y2="90"/>
<line x1="310" y1="90" x2="320" y2="90"/>
<line x1="320" y1="90" x2="330" y2="90"/>
<line x1="330" y1="90" x2="340" y2="90"/>
<line x1="340" y1="90" x2="350" y2="90"/>
<line x1="350" y1="90" x2="360" y2="90"/>
<line x1="360" y1="90" x2="370" y2="90"/>
<line x1="370" y1="90" x2="380" y2="90"/>
<line x1="385" y1="80" x2="385" y2="100"/>
<line x1="380" y1="90" x2="385" y2="90"/>
<line x1="5" y1="100" x2="5" y2="120"/>
<text x="25" y="110">O</text>
<text x="35" y="110">u</text>
<text x="45" y="110">t</text>
<text x="55" y="110">p</text>
<text x="65" y="110">u</text>
<text x="75" y="110">t</text>
<text x="85" y="110">:</text>
<text x="105" y="110">d</text>
<text x="115" y="110">e</text>
<text x="125" y="110">c</text>
<text x="135" y="110">i</text>
<text x="145" y="110">s</text>
<text x="155" y="110">i</text>
<text x="165" y="110">o</text>
<text x="175" y="110">n</text>
<text x="195" y="110">(</text>
<text x="205" y="110">g</text>
<text x="215" y="110">r</text>
<text x="225" y="110">a</text>
<text x="235" y="110">n</text>
<text x="245" y="110">t</text>
<text x="265" y="110">|</text>
<text x="285" y="110">r</text>
<text x="295" y="110">e</text>
<text x="305" y="110">f</text>
<text x="315" y="110">u</text>
<text x="325" y="110">s</text>
<text x="335" y="110">e</text>
<text x="345" y="110">)</text>
<line x1="385" y1="100" x2="385" y2="120"/>
<line x1="5" y1="120" x2="5" y2="140"/>
<text x="105" y="130">e</text>
<text x="115" y="130">f</text>
<text x="125" y="130">f</text>
<text x="135" y="130">e</text>
<text x="145" y="130">c</text>
<text x="155" y="130">t</text>
<text x="195" y="130">(</text>
<text x="205" y="130">w</text>
<text x="215" y="130">h</text>
<text x="225" y="130">a</text>
<text x="235" y="130">t</text>
<text x="255" y="130">h</text>
<text x="265" y="130">a</text>
<text x="275" y="130">p</text>
<text x="285" y="130">p</text>
<text x="295" y="130">e</text>
<text x="305" y="130">n</text>
<text x="315" y="130">s</text>
<text x="325" y="130">)</text>
<line x1="385" y1="120" x2="385" y2="140"/>
<line x1="5" y1="140" x2="5" y2="160"/>
<text x="105" y="150">r</text>
<text x="115" y="150">e</text>
<text x="125" y="150">c</text>
<text x="135" y="150">o</text>
<text x="145" y="150">r</text>
<text x="155" y="150">d</text>
<text x="195" y="150">(</text>
<text x="205" y="150">a</text>
<text x="215" y="150">u</text>
<text x="225" y="150">d</text>
<text x="235" y="150">i</text>
<text x="245" y="150">t</text>
<text x="265" y="150">e</text>
<text x="275" y="150">n</text>
<text x="285" y="150">t</text>
<text x="295" y="150">r</text>
<text x="305" y="150">y</text>
<text x="315" y="150">)</text>
<line x1="385" y1="140" x2="385" y2="160"/>
<line x1="5" y1="160" x2="5" y2="180"/>
<text x="195" y="170">↓</text>
<line x1="385" y1="160" x2="385" y2="180"/>
<line x1="5" y1="180" x2="5" y2="200"/>
<text x="105" y="190">p</text>
<text x="115" y="190">o</text>
<text x="125" y="190">l</text>
<text x="135" y="190">i</text>
<text x="145" y="190">c</text>
<text x="155" y="190">y</text>
<text x="175" y="190">→</text>
<text x="195" y="190">l</text>
<text x="205" y="190">e</text>
<text x="215" y="190">a</text>
<text x="225" y="190">n</text>
<text x="235" y="190">:</text>
<text x="255" y="190">p</text>
<text x="265" y="190">r</text>
<text x="275" y="190">i</text>
<text x="285" y="190">n</text>
<text x="295" y="190">t</text>
<line x1="385" y1="180" x2="385" y2="200"/>
<line x1="5" y1="200" x2="5" y2="220"/>
<text x="195" y="210">p</text>
<text x="205" y="210">a</text>
<text x="215" y="210">r</text>
<text x="225" y="210">a</text>
<text x="235" y="210">n</text>
<text x="245" y="210">o</text>
<text x="255" y="210">i</text>
<text x="265" y="210">d</text>
<text x="275" y="210">:</text>
<text x="295" y="210">a</text>
<text x="305" y="210">p</text>
<text x="315" y="210">p</text>
<text x="325" y="210">e</text>
<text x="335" y="210">n</text>
<text x="345" y="210">d</text>
<line x1="385" y1="200" x2="385" y2="220"/>
<line x1="5" y1="230" x2="10" y2="230"/>
<line x1="5" y1="220" x2="5" y2="230"/>
<line x1="10" y1="230" x2="20" y2="230"/>
<line x1="20" y1="230" x2="30" y2="230"/>
<line x1="30" y1="230" x2="40" y2="230"/>
<line x1="40" y1="230" x2="50" y2="230"/>
<line x1="50" y1="230" x2="60" y2="230"/>
<line x1="60" y1="230" x2="70" y2="230"/>
<line x1="70" y1="230" x2="80" y2="230"/>
<line x1="80" y1="230" x2="90" y2="230"/>
<line x1="90" y1="230" x2="100" y2="230"/>
<line x1="100" y1="230" x2="110" y2="230"/>
<line x1="110" y1="230" x2="120" y2="230"/>
<line x1="120" y1="230" x2="130" y2="230"/>
<line x1="130" y1="230" x2="140" y2="230"/>
<line x1="140" y1="230" x2="150" y2="230"/>
<line x1="150" y1="230" x2="160" y2="230"/>
<line x1="160" y1="230" x2="170" y2="230"/>
<line x1="170" y1="230" x2="180" y2="230"/>
<line x1="180" y1="230" x2="190" y2="230"/>
<line x1="190" y1="230" x2="200" y2="230"/>
<line x1="200" y1="230" x2="210" y2="230"/>
<line x1="210" y1="230" x2="220" y2="230"/>
<line x1="220" y1="230" x2="230" y2="230"/>
<line x1="230" y1="230" x2="240" y2="230"/>
<line x1="240" y1="230" x2="250" y2="230"/>
<line x1="250" y1="230" x2="260" y2="230"/>
<line x1="260" y1="230" x2="270" y2="230"/>
<line x1="270" y1="230" x2="280" y2="230"/>
<line x1="280" y1="230" x2="290" y2="230"/>
<line x1="290" y1="230" x2="300" y2="230"/>
<line x1="300" y1="230" x2="310" y2="230"/>
<line x1="310" y1="230" x2="320" y2="230"/>
<line x1="320" y1="230" x2="330" y2="230"/>
<line x1="330" y1="230" x2="340" y2="230"/>
<line x1="340" y1="230" x2="350" y2="230"/>
<line x1="350" y1="230" x2="360" y2="230"/>
<line x1="360" y1="230" x2="370" y2="230"/>
<line x1="370" y1="230" x2="380" y2="230"/>
<line x1="380" y1="230" x2="385" y2="230"/>
<line x1="385" y1="220" x2="385" y2="230"/>
</svg>
</div>
<h3>The Three Outputs</h3>
<p>1. Decision: Grant or refuse the requested action 2. Effect: The consequence of the decision (action performed, or refusal message) 3. Record: An audit entry capturing what happened</p>
<h3>Auditable vs. Audited</h3>
<ul>
<li>Auditable: The mechanism exists to log the event</li>
<li>Audited: The event is actively being logged</li>
</ul>
<p>All access control decisions are auditable. Whether they are audited depends on realm policy.</p>
</section>
<section>
<h2>Per-Realm Audit Policy</h2>
<p>Each realm configures its own audit policy. The default is lean.</p>
<h3>Policy Levels</h3>
<table>
<tr><th>Level </th><th>Description </th></tr>
<tr><td>lean </td><td>Minimal auditing, low overhead (default) </td></tr>
<tr><td>standard </td><td>Security-relevant events audited </td></tr>
<tr><td>paranoid </td><td>All access decisions audited </td></tr>
</table>
<h3>Event Categories</h3>
<table>
<tr><th>Event </th><th>Lean </th><th>Standard </th><th>Paranoid </th></tr>
<tr><td>Successful joins </td><td>audit </td><td>audit </td><td>audit </td></tr>
<tr><td>Join refusals </td><td>print </td><td>audit </td><td>audit </td></tr>
<tr><td>Delegations </td><td>audit </td><td>audit </td><td>audit </td></tr>
<tr><td>Revocations </td><td>audit </td><td>audit </td><td>audit </td></tr>
<tr><td>Capability grants </td><td>audit </td><td>audit </td><td>audit </td></tr>
<tr><td>Capability refusals </td><td>print </td><td>audit </td><td>audit </td></tr>
<tr><td>Object reads </td><td>— </td><td>— </td><td>audit </td></tr>
<tr><td>Object writes </td><td>print </td><td>audit </td><td>audit </td></tr>
</table>
<h3>Configuration</h3>
<pre class="language-scheme">
(realm-audit-policy 'lean)      ; default
(realm-audit-policy 'standard)
(realm-audit-policy 'paranoid)

;; Or fine-grained:
(realm-audit-policy
  '((joins . audit)
    (refusals . print)
    (delegations . audit)
    (reads . none)))
</pre>
</section>
<section>
<h2>Implementation Pattern</h2>
<p>When implementing an access control point:</p>
<pre class="language-scheme">
(define (access-control-point principal action context)
  "Template for access control with co-designed auditing"

  ;; 1. Make the decision
  (let ((decision (evaluate-policy principal action context)))

    ;; 2. Record based on policy
    (case (realm-audit-policy)
      ((paranoid)
       (audit-append
         actor: principal
         action: `(,action ,@context)
         motivation: (if (eq? decision 'grant)
                         "Access granted"
                         "Access refused")))
      ((standard)
       (when (or (eq? decision 'grant)
                 (security-relevant? action))
         (audit-append ...)))
      ((lean)
       (when (eq? decision 'refuse)
         (print (format "~a Refused: ~a" action (refuse-reason))))))

    ;; 3. Effect
    (if (eq? decision 'grant)
        (perform-action action context)
        (refuse-with-reason action context))))
</pre>
</section>
<section>
<h2>Vocabulary</h2>
<p>Consistent terminology for access control outcomes:</p>
<table>
<tr><th>Outcome </th><th>Verb </th><th>Usage </th></tr>
<tr><td>Execution fails </td><td>Evaporated </td><td>"Execution Evaporated: Signature verification failed" </td></tr>
<tr><td>Join denied </td><td>Refused </td><td>"Join Refused: No valid attestation" </td></tr>
<tr><td>Capability denied </td><td>Refused </td><td>"Capability Refused: Insufficient authority" </td></tr>
<tr><td>Operation blocked </td><td>Refused </td><td>"Operation Refused: Policy violation" </td></tr>
</table>
<p>Avoid: terminated, aborted, ended, failed (where possible).</p>
</section>
<section>
<h2>Security Considerations</h2>
<h3>Refusal Patterns</h3>
<p>A pattern of refusals may indicate: - Misconfiguration (legitimate users being blocked) - Attack probing (malicious principals testing boundaries) - Policy too restrictive (needs adjustment)</p>
<p>Standard and paranoid policies audit refusals to enable pattern detection.</p>
<h3>Audit Cost</h3>
<p>Each audit entry is: - Cryptographically signed (Ed25519) - Hash-chained to previous entry - Persisted to storage</p>
<p>Lean policy minimizes this overhead for high-throughput realms.</p>
<h3>Audit Integrity</h3>
<p>Audit entries themselves are tamper-evident. An attacker cannot: - Delete entries (breaks hash chain) - Modify entries (invalidates signature) - Reorder entries (violates sequence numbers)</p>
</section>
<section>
<h2>References</h2>
<ul>
<li>Memo-003: Cryptographic Audit Trail</li>
<li>Memo-004: SPKI Authorization</li>
<li>Memo-046: Security Architecture</li>
</ul>
</section>
<section>
<h2>Changelog</h2>
<p>- 2026-01-10: Initial draft</p>
</section>
<script>
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}
(function() {
  // Query param override (for REPL: ?theme=dark or ?theme=light)
  const params = new URLSearchParams(window.location.search);
  const param = params.get('theme');
  if (param === 'dark' || param === 'light') {
    document.documentElement.setAttribute('data-theme', param);
    localStorage.setItem('theme', param);
    return;
  }
  // localStorage preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</body>
</html>
