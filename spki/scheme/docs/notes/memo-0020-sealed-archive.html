<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <title>Memo 0020: Sealed Archive Format</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27%230f0%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>">
  <script>
(function(){
  var h=new Date().getHours(),c;
  if(h>=4&&h<6)c='%23845EC2';       // brahma muhurta - violet
  else if(h>=6&&h<8)c='%23ffd700';  // dawn - gold
  else if(h>=8&&h<11)c='%2300d4aa'; // morning - teal
  else if(h>=11&&h<14)c='%230f0';   // midday - phosphor
  else if(h>=14&&h<17)c='%2339ff14';// afternoon - neon
  else if(h>=17&&h<19)c='%23ff6600';// sunset - orange
  else if(h>=19&&h<22)c='%23ff3366';// evening - coral
  else c='%2300ffff';               // night - cyan
  document.getElementById('favicon').href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27'+c+'%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>';
})();
</script>
  <link rel="stylesheet" href="memo.css">
</head>
<body>
<span class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark">[theme]</span>
<p class="format-notice"><em>For pixel-perfect diagrams: <a href="memo-0020-sealed-archive.ps">PostScript</a> or <a href="memo-0020-sealed-archive.pdf">PDF</a></em></p>
<h1>Memo 0020: Sealed Archive Format</h1>
<dl class="metadata">
</dl>
<hr>
<section>
<h2>Abstract</h2>
<p>This Memo specifies the Zstd+Age archive format for the Library of Cyberspace: a modern archive format combining Zstd compression with Age encryption, replacing gzip for cryptographic archives.</p>
</section>
<section>
<h2>Motivation</h2>
<p>The legacy cryptographic archive format uses gzip compression without encryption:</p>
<table>
<tr><th>Aspect </th><th>gzip (legacy) </th><th>zstd + age </th></tr>
<tr><td>Compression speed </td><td>Slow </td><td>Fast (parallel) </td></tr>
<tr><td>Compression ratio </td><td>Good </td><td>Better </td></tr>
<tr><td>Encryption </td><td>None </td><td>Built-in (age) </td></tr>
<tr><td>Key compatibility </td><td>N/A </td><td>X25519/Ed25519 (SPKI aligned) </td></tr>
<tr><td>Streaming </td><td>Yes </td><td>Yes </td></tr>
</table>
<p>Why change?</p>
<ul>
<li>Encryption at rest - Archives contain potentially sensitive data</li>
<li>Faster compression - Zstd is 3-5x faster than gzip</li>
<li>Better ratios - Zstd typically achieves 10-20% better compression</li>
<li>Key alignment - Age uses X25519/Ed25519, same curve family as SPKI</li>
<li>Parallel support - zstd -T0 uses all cores</li>
</ul>
<p>Modern tooling should not leave data unencrypted when encryption is effectively free in CPU time and key management complexity.</p>
</section>
<section>
<h2>Specification</h2>
<h3>Archive Creation Pipeline</h3>
<pre>
git archive | tar --zstd | age -r &lt;recipients&gt; &gt; archive.tar.zst.age
</pre>
<p>Or equivalently:</p>
<pre>
tar --zstd -cf - &lt;files&gt; | age -r &lt;recipient1&gt; -r &lt;recipient2&gt; &gt; archive.tar.zst.age
</pre>
<h3>Archive Restoration Pipeline</h3>
<pre>
age -d -i &lt;identity&gt; &lt; archive.tar.zst.age | zstd -d | tar -xf -
</pre>
<h3>Manifest Format</h3>
<pre class="language-scheme">
(sealed-archive
  (version "1.0.0")
  (format zstd-age)
  (archive "vault-1.0.0.archive.tar.zst.age")
  (compression zstd)
  (encryption age)
  (recipients ("age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"))
  (hash "sha512:...")
  (signature "ed25519:..."))
</pre>
<h3>File Extensions</h3>
<table>
<tr><th>Extension </th><th>Contents </th></tr>
<tr><td>.archive </td><td>S-expression manifest </td></tr>
<tr><td>.tar.zst.age </td><td>Encrypted, compressed tarball </td></tr>
</table>
<h3>Configuration</h3>
<pre class="language-scheme">
;; Set age recipients for encryption
(vault-config 'age-recipients
  '("age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"
    "age1..."))

;; Set age identity for decryption
(vault-config 'age-identity "~/.config/age/identity.txt")

;; Set default archive format
(vault-config 'archive-format 'zstd-age)
</pre>
</section>
<section>
<h2>Performance Characteristics</h2>
<h3>Compression</h3>
<pre class="diagram">
Zstd default (-3):
  Compression:   ~400 MB/s
  Decompression: ~800 MB/s
  Ratio:         ~3:1 (typical source code)

Zstd parallel (-T0):
  Compression:   ~400 MB/s × cores
  Decompression: ~800 MB/s × cores

Gzip comparison:
  Compression:   ~30 MB/s
  Decompression: ~200 MB/s
  Ratio:         ~2.5:1
</pre>
<h3>Encryption</h3>
<pre>
Age X25519:
  Encrypt:  ~1 GB/s (ChaCha20-Poly1305)
  Decrypt:  ~1 GB/s
  Key size: 32 bytes (public), 32 bytes (private)

Age overhead:
  Header:   ~200 bytes per recipient
  MAC:      16 bytes
</pre>
<h3>Signature</h3>
<pre class="diagram">
Ed25519:
  Sign:     ~10 μs
  Verify:   ~10 μs
  Signature: 64 bytes
</pre>
<h3>Total Pipeline</h3>
<pre class="diagram">
10 MB archive:
  Compress (zstd -T0): ~25 ms
  Encrypt (age):       ~10 ms
  Hash (SHA-512):      ~1 ms
  Sign (Ed25519):      ~10 μs
  Total:               ~36 ms

vs gzip legacy:
  Compress (gzip):     ~300 ms
  Hash (SHA-512):      ~1 ms
  Sign (Ed25519):      ~10 μs
  Total:               ~301 ms

Speedup: ~8x
</pre>
</section>
<section>
<h2>Security Model</h2>
<h3>Encryption Layer (Age)</h3>
<ul>
<li>Algorithm: X25519 + ChaCha20-Poly1305</li>
<li>Recipients: Multiple allowed (each can decrypt)</li>
<li>Forward secrecy: Ephemeral key per archive</li>
<li>Authenticity: Poly1305 MAC</li>
</ul>
<h3>Signature Layer (SPKI)</h3>
<ul>
<li>Algorithm: Ed25519</li>
<li>Scope: Signs encrypted archive hash</li>
<li>Non-repudiation: Signer cannot deny creating archive</li>
</ul>
<h3>Verification Order</h3>
<ul>
<li>Verify signature - Before decryption (fail fast on tampering)</li>
<li>Verify hash - Encrypted archive integrity</li>
<li>Decrypt - Only after signature verified</li>
<li>Extract - Only after successful decryption</li>
</ul>
<h3>Threat Mitigations</h3>
<table>
<tr><th>Threat </th><th>Mitigation </th></tr>
<tr><td>Eavesdropping </td><td>Age encryption (X25519 + ChaCha20) </td></tr>
<tr><td>Tampering </td><td>SHA-512 hash + Ed25519 signature </td></tr>
<tr><td>Replay attacks </td><td>Version + timestamp in manifest </td></tr>
<tr><td>Key compromise </td><td>Multiple recipients, key rotation </td></tr>
<tr><td>Chosen ciphertext </td><td>Poly1305 authentication </td></tr>
</table>
</section>
<section>
<h2>Compatibility</h2>
<h3>Age Identity Types</h3>
<pre>
# Native age key
age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p

# SSH key (age supports ssh-ed25519 and ssh-rsa)
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...

# GitHub key (via age-plugin-github or ssh)
github:username
</pre>
<h3>Platform Support</h3>
<table>
<tr><th>Platform </th><th>zstd </th><th>age </th></tr>
<tr><td>macOS </td><td>Homebrew </td><td>Homebrew </td></tr>
<tr><td>Linux </td><td>apt/yum </td><td>apt/yum or binary </td></tr>
<tr><td>FreeBSD </td><td>pkg </td><td>pkg </td></tr>
<tr><td>Windows </td><td>winget </td><td>winget or binary </td></tr>
</table>
<h3>Fallback</h3>
<p>If zstd or age unavailable, fall back to cryptographic format:</p>
<pre class="language-scheme">
(if (and (command-exists? "zstd") (command-exists? "age"))
    (seal-archive version format: 'zstd-age)
    (seal-archive version format: 'cryptographic))
</pre>
</section>
<section>
<h2>Implementation</h2>
<h3>seal-archive-zstd-age</h3>
<pre class="language-scheme">
(define (seal-archive-zstd-age version output)
  "Create zstd-compressed, age-encrypted archive with SPKI signature"

  (let ((recipients (vault-config 'age-recipients))
        (signing-key (vault-config 'signing-key))
        (encrypted-file (sprintf "~a.tar.zst.age" output)))

    ;; Require recipients
    (unless (pair? recipients)
      (error "No age recipients configured"))

    ;; Build recipient args: -r key1 -r key2 ...
    (let ((recipient-args
           (string-join (map (lambda (r) (sprintf "-r ~a" r)) recipients) " ")))

      ;; Create archive: git archive | zstd | age
      (let ((temp-tar (sprintf "/tmp/vault-~a.tar" version)))
        (run-command "git" "archive" "--prefix=vault/"
                     (sprintf "--output=~a" temp-tar) version)
        (system (sprintf "zstd -T0 -c ~a | age ~a &gt; ~a"
                        temp-tar recipient-args encrypted-file))
        (delete-file temp-tar))

      ;; Sign the encrypted archive
      (when signing-key
        (let* ((archive-bytes (read-file-bytes encrypted-file))
               (archive-hash (sha512-hash archive-bytes))
               (signature (ed25519-sign signing-key archive-hash)))

          ;; Write manifest
          (with-output-to-file output
            (lambda ()
              (write `(sealed-archive
                       (version ,version)
                       (format zstd-age)
                       (archive ,encrypted-file)
                       (compression zstd)
                       (encryption age)
                       (recipients ,recipients)
                       (hash ,(blob-&gt;hex archive-hash))
                       (signature ,(blob-&gt;hex signature)))))))))))
</pre>
<h3>seal-restore-zstd-age</h3>
<pre class="language-scheme">
(define (seal-restore-zstd-age manifest verify-key target-dir identity)
  "Restore zstd+age encrypted archive"

  (let ((version (cadr (assq 'version (cdr manifest))))
        (archive-file (cadr (assq 'archive (cdr manifest))))
        (hash-hex (cadr (assq 'hash (cdr manifest))))
        (sig-hex (cadr (assq 'signature (cdr manifest))))
        (id-file (or identity (vault-config 'age-identity))))

    ;; Require identity
    (unless id-file
      (error "No age identity configured"))

    ;; Verify signature first (before decryption)
    (when verify-key
      (let* ((archive-bytes (read-file-bytes archive-file))
             (archive-hash (sha512-hash archive-bytes))
             (expected-hash (hex-&gt;blob hash-hex))
             (signature (hex-&gt;blob sig-hex))
             (pubkey (read-key-from-file verify-key)))

        (unless (equal? archive-hash expected-hash)
          (error "Archive hash mismatch"))

        (unless (ed25519-verify pubkey archive-hash signature)
          (error "Signature verification failed"))))

    ;; Decrypt and extract: age -d | zstd -d | tar -x
    (system (sprintf "age -d -i ~a &lt; ~a | zstd -d | tar -xf - -C ~a"
                    id-file archive-file target-dir))))
</pre>
</section>
<section>
<h2>Usage Examples</h2>
<h3>Create Encrypted Archive</h3>
<pre class="language-scheme">
;; Configure recipients
(vault-config 'age-recipients
  '("age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"))

;; Create archive
(seal-archive "1.0.0" format: 'zstd-age)
;; =&gt; vault-1.0.0.archive
;; =&gt; vault-1.0.0.archive.tar.zst.age
</pre>
<h3>Restore Encrypted Archive</h3>
<pre class="language-scheme">
;; Configure identity
(vault-config 'age-identity "~/.config/age/identity.txt")

;; Restore with verification
(seal-restore "vault-1.0.0.archive"
              verify-key: "publisher.public"
              target: "./restored")
</pre>
<h3>Command Line Equivalents</h3>
<pre class="language-bash">
# Create
git archive --prefix=vault/ 1.0.0 | \
  zstd -T0 | \
  age -r age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p \
  &gt; vault-1.0.0.tar.zst.age

# Restore
age -d -i ~/.config/age/identity.txt &lt; vault-1.0.0.tar.zst.age | \
  zstd -d | \
  tar -xf -
</pre>
</section>
<section>
<h2>Migration</h2>
<h3>From Cryptographic to Zstd-Age</h3>
<pre class="language-scheme">
;; Re-archive existing releases with new format
(for-each
  (lambda (version)
    (seal-archive version format: 'zstd-age))
  (get-local-releases))
</pre>
<h3>Backward Compatibility</h3>
<p>Both formats can coexist. The manifest format field determines restoration method: - (format cryptographic) → seal-restore-cryptographic - (format zstd-age) → seal-restore-zstd-age</p>
</section>
<section>
<h2>References</h2>
<ul>
<li>[Zstd](https://github.com/facebook/zstd) - Facebook's compression algorithm</li>
<li>[Age](https://age-encryption.org/) - Modern encryption tool</li>
<li>[Memo-006](memo-006-vault-architecture.html) - Vault System Architecture</li>
<li>[Memo-004](memo-004-spki-authorization.html) - SPKI Authorization</li>
</ul>
</section>
<section>
<h2>Changelog</h2>
<ul>
<li>2026-01-06</li>
<li>Initial specification</li>
</ul>
</section>
<script>
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}
(function() {
  // Query param override (for REPL: ?theme=dark or ?theme=light)
  const params = new URLSearchParams(window.location.search);
  const param = params.get('theme');
  if (param === 'dark' || param === 'light') {
    document.documentElement.setAttribute('data-theme', param);
    localStorage.setItem('theme', param);
    return;
  }
  // localStorage preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</body>
</html>
