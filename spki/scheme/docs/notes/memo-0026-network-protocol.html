<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <title>Memo 0026: Network Protocol</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27%230f0%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>">
  <script>
(function(){
  var h=new Date().getHours(),c;
  if(h>=4&&h<6)c='%23845EC2';       // brahma muhurta - violet
  else if(h>=6&&h<8)c='%23ffd700';  // dawn - gold
  else if(h>=8&&h<11)c='%2300d4aa'; // morning - teal
  else if(h>=11&&h<14)c='%230f0';   // midday - phosphor
  else if(h>=14&&h<17)c='%2339ff14';// afternoon - neon
  else if(h>=17&&h<19)c='%23ff6600';// sunset - orange
  else if(h>=19&&h<22)c='%23ff3366';// evening - coral
  else c='%2300ffff';               // night - cyan
  document.getElementById('favicon').href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27'+c+'%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>';
})();
</script>
  <link rel="stylesheet" href="memo.css">
</head>
<body>
<span class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark">[theme]</span>
<h1>Memo 0026: Network Protocol</h1>
<dl class="metadata">
</dl>
<hr>
<section>
<h2>Abstract</h2>
<p>This Memo specifies the network protocol for the Library of Cyberspace: how vaults discover each other, authenticate, exchange objects, and synchronize state. The protocol is transport-agnostic, capability-authenticated, and optimized for content-addressed data.</p>
</section>
<section>
<h2>Motivation</h2>
<p>Vaults must communicate to:</p>
<ul>
<li>Replicate</li>
<li>Distribute objects across vaults</li>
<li>Federate</li>
<li>Link independent vaults into networks</li>
<li>Subscribe</li>
<li>Receive updates from publishers</li>
<li>Query</li>
<li>Search the distributed soup</li>
</ul>
<p>The protocol must handle:</p>
<ul>
<li>Intermittent connectivity</li>
<li>Vaults may be offline</li>
<li>Untrusted networks</li>
<li>All communication authenticated</li>
<li>Large objects</li>
<li>Efficient chunked transfer</li>
<li>Partial sync</li>
<li>Resume interrupted transfers</li>
</ul>
</section>
<section>
<h2>Protocol Layers</h2>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 430 260" width="430" height="260" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<line x1="5" y1="10" x2="10" y2="10"/>
<line x1="5" y1="10" x2="5" y2="20"/>
<line x1="10" y1="10" x2="20" y2="10"/>
<line x1="20" y1="10" x2="30" y2="10"/>
<line x1="30" y1="10" x2="40" y2="10"/>
<line x1="40" y1="10" x2="50" y2="10"/>
<line x1="50" y1="10" x2="60" y2="10"/>
<line x1="60" y1="10" x2="70" y2="10"/>
<line x1="70" y1="10" x2="80" y2="10"/>
<line x1="80" y1="10" x2="90" y2="10"/>
<line x1="90" y1="10" x2="100" y2="10"/>
<line x1="100" y1="10" x2="110" y2="10"/>
<line x1="110" y1="10" x2="120" y2="10"/>
<line x1="120" y1="10" x2="130" y2="10"/>
<line x1="130" y1="10" x2="140" y2="10"/>
<line x1="140" y1="10" x2="150" y2="10"/>
<line x1="150" y1="10" x2="160" y2="10"/>
<line x1="160" y1="10" x2="170" y2="10"/>
<line x1="170" y1="10" x2="180" y2="10"/>
<line x1="180" y1="10" x2="190" y2="10"/>
<line x1="190" y1="10" x2="200" y2="10"/>
<line x1="200" y1="10" x2="210" y2="10"/>
<line x1="210" y1="10" x2="220" y2="10"/>
<line x1="220" y1="10" x2="230" y2="10"/>
<line x1="230" y1="10" x2="240" y2="10"/>
<line x1="240" y1="10" x2="250" y2="10"/>
<line x1="250" y1="10" x2="260" y2="10"/>
<line x1="260" y1="10" x2="270" y2="10"/>
<line x1="270" y1="10" x2="280" y2="10"/>
<line x1="280" y1="10" x2="290" y2="10"/>
<line x1="290" y1="10" x2="300" y2="10"/>
<line x1="300" y1="10" x2="310" y2="10"/>
<line x1="310" y1="10" x2="320" y2="10"/>
<line x1="320" y1="10" x2="330" y2="10"/>
<line x1="330" y1="10" x2="340" y2="10"/>
<line x1="340" y1="10" x2="350" y2="10"/>
<line x1="350" y1="10" x2="360" y2="10"/>
<line x1="360" y1="10" x2="370" y2="10"/>
<line x1="370" y1="10" x2="380" y2="10"/>
<line x1="380" y1="10" x2="390" y2="10"/>
<line x1="390" y1="10" x2="400" y2="10"/>
<line x1="400" y1="10" x2="410" y2="10"/>
<line x1="410" y1="10" x2="420" y2="10"/>
<line x1="420" y1="10" x2="425" y2="10"/>
<line x1="425" y1="10" x2="425" y2="20"/>
<line x1="5" y1="20" x2="5" y2="40"/>
<text x="125" y="30">A</text>
<text x="135" y="30">P</text>
<text x="145" y="30">P</text>
<text x="155" y="30">L</text>
<text x="165" y="30">I</text>
<text x="175" y="30">C</text>
<text x="185" y="30">A</text>
<text x="195" y="30">T</text>
<text x="205" y="30">I</text>
<text x="215" y="30">O</text>
<text x="225" y="30">N</text>
<text x="245" y="30">L</text>
<text x="255" y="30">A</text>
<text x="265" y="30">Y</text>
<text x="275" y="30">E</text>
<text x="285" y="30">R</text>
<line x1="425" y1="20" x2="425" y2="40"/>
<line x1="5" y1="40" x2="5" y2="60"/>
<text x="35" y="50">(</text>
<text x="45" y="50">v</text>
<text x="55" y="50">a</text>
<text x="65" y="50">u</text>
<text x="75" y="50">l</text>
<text x="85" y="50">t</text>
<text x="105" y="50">o</text>
<text x="115" y="50">p</text>
<text x="125" y="50">e</text>
<text x="135" y="50">r</text>
<text x="145" y="50">a</text>
<text x="155" y="50">t</text>
<text x="165" y="50">i</text>
<text x="175" y="50">o</text>
<text x="185" y="50">n</text>
<text x="195" y="50">s</text>
<text x="205" y="50">,</text>
<text x="225" y="50">s</text>
<text x="235" y="50">o</text>
<text x="245" y="50">u</text>
<text x="255" y="50">p</text>
<text x="275" y="50">q</text>
<text x="285" y="50">u</text>
<text x="295" y="50">e</text>
<text x="305" y="50">r</text>
<text x="315" y="50">i</text>
<text x="325" y="50">e</text>
<text x="335" y="50">s</text>
<text x="345" y="50">)</text>
<line x1="425" y1="40" x2="425" y2="60"/>
<line x1="5" y1="60" x2="5" y2="80"/>
<line x1="5" y1="70" x2="10" y2="70"/>
<line x1="10" y1="70" x2="20" y2="70"/>
<line x1="20" y1="70" x2="30" y2="70"/>
<line x1="30" y1="70" x2="40" y2="70"/>
<line x1="40" y1="70" x2="50" y2="70"/>
<line x1="50" y1="70" x2="60" y2="70"/>
<line x1="60" y1="70" x2="70" y2="70"/>
<line x1="70" y1="70" x2="80" y2="70"/>
<line x1="80" y1="70" x2="90" y2="70"/>
<line x1="90" y1="70" x2="100" y2="70"/>
<line x1="100" y1="70" x2="110" y2="70"/>
<line x1="110" y1="70" x2="120" y2="70"/>
<line x1="120" y1="70" x2="130" y2="70"/>
<line x1="130" y1="70" x2="140" y2="70"/>
<line x1="140" y1="70" x2="150" y2="70"/>
<line x1="150" y1="70" x2="160" y2="70"/>
<line x1="160" y1="70" x2="170" y2="70"/>
<line x1="170" y1="70" x2="180" y2="70"/>
<line x1="180" y1="70" x2="190" y2="70"/>
<line x1="190" y1="70" x2="200" y2="70"/>
<line x1="200" y1="70" x2="210" y2="70"/>
<line x1="210" y1="70" x2="220" y2="70"/>
<line x1="220" y1="70" x2="230" y2="70"/>
<line x1="230" y1="70" x2="240" y2="70"/>
<line x1="240" y1="70" x2="250" y2="70"/>
<line x1="250" y1="70" x2="260" y2="70"/>
<line x1="260" y1="70" x2="270" y2="70"/>
<line x1="270" y1="70" x2="280" y2="70"/>
<line x1="280" y1="70" x2="290" y2="70"/>
<line x1="290" y1="70" x2="300" y2="70"/>
<line x1="300" y1="70" x2="310" y2="70"/>
<line x1="310" y1="70" x2="320" y2="70"/>
<line x1="320" y1="70" x2="330" y2="70"/>
<line x1="330" y1="70" x2="340" y2="70"/>
<line x1="340" y1="70" x2="350" y2="70"/>
<line x1="350" y1="70" x2="360" y2="70"/>
<line x1="360" y1="70" x2="370" y2="70"/>
<line x1="370" y1="70" x2="380" y2="70"/>
<line x1="380" y1="70" x2="390" y2="70"/>
<line x1="390" y1="70" x2="400" y2="70"/>
<line x1="400" y1="70" x2="410" y2="70"/>
<line x1="410" y1="70" x2="420" y2="70"/>
<line x1="425" y1="60" x2="425" y2="80"/>
<line x1="420" y1="70" x2="425" y2="70"/>
<line x1="5" y1="80" x2="5" y2="100"/>
<text x="125" y="90">M</text>
<text x="135" y="90">E</text>
<text x="145" y="90">S</text>
<text x="155" y="90">S</text>
<text x="165" y="90">A</text>
<text x="175" y="90">G</text>
<text x="185" y="90">E</text>
<text x="205" y="90">L</text>
<text x="215" y="90">A</text>
<text x="225" y="90">Y</text>
<text x="235" y="90">E</text>
<text x="245" y="90">R</text>
<line x1="425" y1="80" x2="425" y2="100"/>
<line x1="5" y1="100" x2="5" y2="120"/>
<text x="35" y="110">(</text>
<text x="45" y="110">r</text>
<text x="55" y="110">e</text>
<text x="65" y="110">q</text>
<text x="75" y="110">u</text>
<text x="85" y="110">e</text>
<text x="95" y="110">s</text>
<text x="105" y="110">t</text>
<text x="115" y="110">/</text>
<text x="125" y="110">r</text>
<text x="135" y="110">e</text>
<text x="145" y="110">s</text>
<text x="155" y="110">p</text>
<text x="165" y="110">o</text>
<text x="175" y="110">n</text>
<text x="185" y="110">s</text>
<text x="195" y="110">e</text>
<text x="205" y="110">,</text>
<text x="225" y="110">s</text>
<text x="235" y="110">t</text>
<text x="245" y="110">r</text>
<text x="255" y="110">e</text>
<text x="265" y="110">a</text>
<text x="275" y="110">m</text>
<text x="285" y="110">i</text>
<text x="295" y="110">n</text>
<text x="305" y="110">g</text>
<text x="315" y="110">)</text>
<line x1="425" y1="100" x2="425" y2="120"/>
<line x1="5" y1="120" x2="5" y2="140"/>
<line x1="5" y1="130" x2="10" y2="130"/>
<line x1="10" y1="130" x2="20" y2="130"/>
<line x1="20" y1="130" x2="30" y2="130"/>
<line x1="30" y1="130" x2="40" y2="130"/>
<line x1="40" y1="130" x2="50" y2="130"/>
<line x1="50" y1="130" x2="60" y2="130"/>
<line x1="60" y1="130" x2="70" y2="130"/>
<line x1="70" y1="130" x2="80" y2="130"/>
<line x1="80" y1="130" x2="90" y2="130"/>
<line x1="90" y1="130" x2="100" y2="130"/>
<line x1="100" y1="130" x2="110" y2="130"/>
<line x1="110" y1="130" x2="120" y2="130"/>
<line x1="120" y1="130" x2="130" y2="130"/>
<line x1="130" y1="130" x2="140" y2="130"/>
<line x1="140" y1="130" x2="150" y2="130"/>
<line x1="150" y1="130" x2="160" y2="130"/>
<line x1="160" y1="130" x2="170" y2="130"/>
<line x1="170" y1="130" x2="180" y2="130"/>
<line x1="180" y1="130" x2="190" y2="130"/>
<line x1="190" y1="130" x2="200" y2="130"/>
<line x1="200" y1="130" x2="210" y2="130"/>
<line x1="210" y1="130" x2="220" y2="130"/>
<line x1="220" y1="130" x2="230" y2="130"/>
<line x1="230" y1="130" x2="240" y2="130"/>
<line x1="240" y1="130" x2="250" y2="130"/>
<line x1="250" y1="130" x2="260" y2="130"/>
<line x1="260" y1="130" x2="270" y2="130"/>
<line x1="270" y1="130" x2="280" y2="130"/>
<line x1="280" y1="130" x2="290" y2="130"/>
<line x1="290" y1="130" x2="300" y2="130"/>
<line x1="300" y1="130" x2="310" y2="130"/>
<line x1="310" y1="130" x2="320" y2="130"/>
<line x1="320" y1="130" x2="330" y2="130"/>
<line x1="330" y1="130" x2="340" y2="130"/>
<line x1="340" y1="130" x2="350" y2="130"/>
<line x1="350" y1="130" x2="360" y2="130"/>
<line x1="360" y1="130" x2="370" y2="130"/>
<line x1="370" y1="130" x2="380" y2="130"/>
<line x1="380" y1="130" x2="390" y2="130"/>
<line x1="390" y1="130" x2="400" y2="130"/>
<line x1="400" y1="130" x2="410" y2="130"/>
<line x1="410" y1="130" x2="420" y2="130"/>
<line x1="425" y1="120" x2="425" y2="140"/>
<line x1="420" y1="130" x2="425" y2="130"/>
<line x1="5" y1="140" x2="5" y2="160"/>
<text x="125" y="150">S</text>
<text x="135" y="150">E</text>
<text x="145" y="150">C</text>
<text x="155" y="150">U</text>
<text x="165" y="150">R</text>
<text x="175" y="150">I</text>
<text x="185" y="150">T</text>
<text x="195" y="150">Y</text>
<text x="215" y="150">L</text>
<text x="225" y="150">A</text>
<text x="235" y="150">Y</text>
<text x="245" y="150">E</text>
<text x="255" y="150">R</text>
<line x1="425" y1="140" x2="425" y2="160"/>
<line x1="5" y1="160" x2="5" y2="180"/>
<text x="35" y="170">(</text>
<text x="45" y="170">a</text>
<text x="55" y="170">u</text>
<text x="65" y="170">t</text>
<text x="75" y="170">h</text>
<text x="85" y="170">e</text>
<text x="95" y="170">n</text>
<text x="105" y="170">t</text>
<text x="115" y="170">i</text>
<text x="125" y="170">c</text>
<text x="135" y="170">a</text>
<text x="145" y="170">t</text>
<text x="155" y="170">i</text>
<text x="165" y="170">o</text>
<text x="175" y="170">n</text>
<text x="185" y="170">,</text>
<text x="205" y="170">e</text>
<text x="215" y="170">n</text>
<text x="225" y="170">c</text>
<text x="235" y="170">r</text>
<text x="245" y="170">y</text>
<text x="255" y="170">p</text>
<text x="265" y="170">t</text>
<text x="275" y="170">i</text>
<text x="285" y="170">o</text>
<text x="295" y="170">n</text>
<text x="305" y="170">)</text>
<line x1="425" y1="160" x2="425" y2="180"/>
<line x1="5" y1="180" x2="5" y2="200"/>
<line x1="5" y1="190" x2="10" y2="190"/>
<line x1="10" y1="190" x2="20" y2="190"/>
<line x1="20" y1="190" x2="30" y2="190"/>
<line x1="30" y1="190" x2="40" y2="190"/>
<line x1="40" y1="190" x2="50" y2="190"/>
<line x1="50" y1="190" x2="60" y2="190"/>
<line x1="60" y1="190" x2="70" y2="190"/>
<line x1="70" y1="190" x2="80" y2="190"/>
<line x1="80" y1="190" x2="90" y2="190"/>
<line x1="90" y1="190" x2="100" y2="190"/>
<line x1="100" y1="190" x2="110" y2="190"/>
<line x1="110" y1="190" x2="120" y2="190"/>
<line x1="120" y1="190" x2="130" y2="190"/>
<line x1="130" y1="190" x2="140" y2="190"/>
<line x1="140" y1="190" x2="150" y2="190"/>
<line x1="150" y1="190" x2="160" y2="190"/>
<line x1="160" y1="190" x2="170" y2="190"/>
<line x1="170" y1="190" x2="180" y2="190"/>
<line x1="180" y1="190" x2="190" y2="190"/>
<line x1="190" y1="190" x2="200" y2="190"/>
<line x1="200" y1="190" x2="210" y2="190"/>
<line x1="210" y1="190" x2="220" y2="190"/>
<line x1="220" y1="190" x2="230" y2="190"/>
<line x1="230" y1="190" x2="240" y2="190"/>
<line x1="240" y1="190" x2="250" y2="190"/>
<line x1="250" y1="190" x2="260" y2="190"/>
<line x1="260" y1="190" x2="270" y2="190"/>
<line x1="270" y1="190" x2="280" y2="190"/>
<line x1="280" y1="190" x2="290" y2="190"/>
<line x1="290" y1="190" x2="300" y2="190"/>
<line x1="300" y1="190" x2="310" y2="190"/>
<line x1="310" y1="190" x2="320" y2="190"/>
<line x1="320" y1="190" x2="330" y2="190"/>
<line x1="330" y1="190" x2="340" y2="190"/>
<line x1="340" y1="190" x2="350" y2="190"/>
<line x1="350" y1="190" x2="360" y2="190"/>
<line x1="360" y1="190" x2="370" y2="190"/>
<line x1="370" y1="190" x2="380" y2="190"/>
<line x1="380" y1="190" x2="390" y2="190"/>
<line x1="390" y1="190" x2="400" y2="190"/>
<line x1="400" y1="190" x2="410" y2="190"/>
<line x1="410" y1="190" x2="420" y2="190"/>
<line x1="425" y1="180" x2="425" y2="200"/>
<line x1="420" y1="190" x2="425" y2="190"/>
<line x1="5" y1="200" x2="5" y2="220"/>
<text x="125" y="210">T</text>
<text x="135" y="210">R</text>
<text x="145" y="210">A</text>
<text x="155" y="210">N</text>
<text x="165" y="210">S</text>
<text x="175" y="210">P</text>
<text x="185" y="210">O</text>
<text x="195" y="210">R</text>
<text x="205" y="210">T</text>
<text x="225" y="210">L</text>
<text x="235" y="210">A</text>
<text x="245" y="210">Y</text>
<text x="255" y="210">E</text>
<text x="265" y="210">R</text>
<line x1="425" y1="200" x2="425" y2="220"/>
<line x1="5" y1="220" x2="5" y2="240"/>
<text x="35" y="230">(</text>
<text x="45" y="230">T</text>
<text x="55" y="230">C</text>
<text x="65" y="230">P</text>
<text x="75" y="230">,</text>
<text x="95" y="230">Q</text>
<text x="105" y="230">U</text>
<text x="115" y="230">I</text>
<text x="125" y="230">C</text>
<text x="135" y="230">,</text>
<text x="155" y="230">U</text>
<text x="165" y="230">n</text>
<text x="175" y="230">i</text>
<text x="185" y="230">x</text>
<text x="205" y="230">s</text>
<text x="215" y="230">o</text>
<text x="225" y="230">c</text>
<text x="235" y="230">k</text>
<text x="245" y="230">e</text>
<text x="255" y="230">t</text>
<text x="265" y="230">,</text>
<text x="285" y="230">e</text>
<text x="295" y="230">t</text>
<text x="305" y="230">c</text>
<text x="315" y="230">.</text>
<text x="325" y="230">)</text>
<line x1="425" y1="220" x2="425" y2="240"/>
<line x1="5" y1="250" x2="10" y2="250"/>
<line x1="5" y1="240" x2="5" y2="250"/>
<line x1="10" y1="250" x2="20" y2="250"/>
<line x1="20" y1="250" x2="30" y2="250"/>
<line x1="30" y1="250" x2="40" y2="250"/>
<line x1="40" y1="250" x2="50" y2="250"/>
<line x1="50" y1="250" x2="60" y2="250"/>
<line x1="60" y1="250" x2="70" y2="250"/>
<line x1="70" y1="250" x2="80" y2="250"/>
<line x1="80" y1="250" x2="90" y2="250"/>
<line x1="90" y1="250" x2="100" y2="250"/>
<line x1="100" y1="250" x2="110" y2="250"/>
<line x1="110" y1="250" x2="120" y2="250"/>
<line x1="120" y1="250" x2="130" y2="250"/>
<line x1="130" y1="250" x2="140" y2="250"/>
<line x1="140" y1="250" x2="150" y2="250"/>
<line x1="150" y1="250" x2="160" y2="250"/>
<line x1="160" y1="250" x2="170" y2="250"/>
<line x1="170" y1="250" x2="180" y2="250"/>
<line x1="180" y1="250" x2="190" y2="250"/>
<line x1="190" y1="250" x2="200" y2="250"/>
<line x1="200" y1="250" x2="210" y2="250"/>
<line x1="210" y1="250" x2="220" y2="250"/>
<line x1="220" y1="250" x2="230" y2="250"/>
<line x1="230" y1="250" x2="240" y2="250"/>
<line x1="240" y1="250" x2="250" y2="250"/>
<line x1="250" y1="250" x2="260" y2="250"/>
<line x1="260" y1="250" x2="270" y2="250"/>
<line x1="270" y1="250" x2="280" y2="250"/>
<line x1="280" y1="250" x2="290" y2="250"/>
<line x1="290" y1="250" x2="300" y2="250"/>
<line x1="300" y1="250" x2="310" y2="250"/>
<line x1="310" y1="250" x2="320" y2="250"/>
<line x1="320" y1="250" x2="330" y2="250"/>
<line x1="330" y1="250" x2="340" y2="250"/>
<line x1="340" y1="250" x2="350" y2="250"/>
<line x1="350" y1="250" x2="360" y2="250"/>
<line x1="360" y1="250" x2="370" y2="250"/>
<line x1="370" y1="250" x2="380" y2="250"/>
<line x1="380" y1="250" x2="390" y2="250"/>
<line x1="390" y1="250" x2="400" y2="250"/>
<line x1="400" y1="250" x2="410" y2="250"/>
<line x1="410" y1="250" x2="420" y2="250"/>
<line x1="420" y1="250" x2="425" y2="250"/>
<line x1="425" y1="240" x2="425" y2="250"/>
</svg>
</div>
</section>
<section>
<h2>Transport Layer</h2>
<h3>Supported Transports</h3>
<pre class="language-scheme">
(define transports
  '((tcp "Traditional TCP/IP")
    (quic "UDP-based, multiplexed")
    (unix "Local Unix domain socket")
    (tor "Onion-routed TCP")
    (i2p "Garlic-routed")
    (bluetooth "Local mesh")
    (sneakernet "Physical media exchange")))
</pre>
<h3>Connection Establishment</h3>
<pre class="language-scheme">
(define (connect-vault address transport)
  "Establish connection to remote vault"
  (let* ((socket (transport-connect transport address))
         (connection (make-connection socket transport)))

    ;; Perform handshake
    (connection-handshake connection)

    ;; Return authenticated connection
    connection))
</pre>
<h3>Multiplexing</h3>
<p>Multiple streams over single connection:</p>
<pre class="language-scheme">
(define (open-stream connection stream-type)
  "Open multiplexed stream within connection"
  (let ((stream-id (allocate-stream-id connection)))
    (send-frame connection
      (frame type: 'stream-open
             stream-id: stream-id
             stream-type: stream-type))
    (make-stream connection stream-id stream-type)))
</pre>
</section>
<section>
<h2>Security Layer</h2>
<h3>Handshake Protocol</h3>
<p>Mutual authentication using Simple Public Key Infrastructure (SPKI) certificates:</p>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 470 300" width="470" height="300" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<text x="5" y="10">C</text>
<text x="15" y="10">l</text>
<text x="25" y="10">i</text>
<text x="35" y="10">e</text>
<text x="45" y="10">n</text>
<text x="55" y="10">t</text>
<text x="415" y="10">S</text>
<text x="425" y="10">e</text>
<text x="435" y="10">r</text>
<text x="445" y="10">v</text>
<text x="455" y="10">e</text>
<text x="465" y="10">r</text>
<line x1="25" y1="20" x2="25" y2="40"/>
<line x1="435" y1="20" x2="435" y2="40"/>
<line x1="25" y1="40" x2="25" y2="60"/>
<line x1="30" y1="50" x2="40" y2="50"/>
<line x1="40" y1="50" x2="50" y2="50"/>
<line x1="50" y1="50" x2="60" y2="50"/>
<line x1="60" y1="50" x2="70" y2="50"/>
<text x="85" y="50">C</text>
<text x="95" y="50">l</text>
<text x="105" y="50">i</text>
<text x="115" y="50">e</text>
<text x="125" y="50">n</text>
<text x="135" y="50">t</text>
<text x="145" y="50">H</text>
<text x="155" y="50">e</text>
<text x="165" y="50">l</text>
<text x="175" y="50">l</text>
<text x="185" y="50">o</text>
<line x1="200" y1="50" x2="210" y2="50"/>
<line x1="210" y1="50" x2="220" y2="50"/>
<line x1="220" y1="50" x2="230" y2="50"/>
<line x1="230" y1="50" x2="240" y2="50"/>
<line x1="240" y1="50" x2="250" y2="50"/>
<line x1="250" y1="50" x2="260" y2="50"/>
<line x1="260" y1="50" x2="270" y2="50"/>
<line x1="270" y1="50" x2="280" y2="50"/>
<line x1="280" y1="50" x2="290" y2="50"/>
<line x1="290" y1="50" x2="300" y2="50"/>
<line x1="300" y1="50" x2="310" y2="50"/>
<line x1="310" y1="50" x2="320" y2="50"/>
<line x1="320" y1="50" x2="330" y2="50"/>
<line x1="330" y1="50" x2="340" y2="50"/>
<line x1="340" y1="50" x2="350" y2="50"/>
<line x1="350" y1="50" x2="360" y2="50"/>
<line x1="360" y1="50" x2="370" y2="50"/>
<line x1="370" y1="50" x2="380" y2="50"/>
<line x1="380" y1="50" x2="390" y2="50"/>
<line x1="390" y1="50" x2="400" y2="50"/>
<line x1="400" y1="50" x2="410" y2="50"/>
<line x1="410" y1="50" x2="420" y2="50"/>
<text x="425" y="50">→</text>
<line x1="435" y1="40" x2="435" y2="60"/>
<line x1="25" y1="60" x2="25" y2="80"/>
<text x="85" y="70">(</text>
<text x="95" y="70">p</text>
<text x="105" y="70">r</text>
<text x="115" y="70">o</text>
<text x="125" y="70">t</text>
<text x="135" y="70">o</text>
<text x="145" y="70">c</text>
<text x="155" y="70">o</text>
<text x="165" y="70">l</text>
<text x="185" y="70">v</text>
<text x="195" y="70">e</text>
<text x="205" y="70">r</text>
<text x="215" y="70">s</text>
<text x="225" y="70">i</text>
<text x="235" y="70">o</text>
<text x="245" y="70">n</text>
<text x="255" y="70">,</text>
<text x="275" y="70">c</text>
<text x="285" y="70">a</text>
<text x="295" y="70">p</text>
<text x="305" y="70">a</text>
<text x="315" y="70">b</text>
<text x="325" y="70">i</text>
<text x="335" y="70">l</text>
<text x="345" y="70">i</text>
<text x="355" y="70">t</text>
<text x="365" y="70">i</text>
<text x="375" y="70">e</text>
<text x="385" y="70">s</text>
<text x="395" y="70">)</text>
<line x1="435" y1="60" x2="435" y2="80"/>
<line x1="25" y1="80" x2="25" y2="100"/>
<line x1="435" y1="80" x2="435" y2="100"/>
<line x1="25" y1="100" x2="25" y2="120"/>
<text x="35" y="110">←</text>
<line x1="40" y1="110" x2="50" y2="110"/>
<line x1="50" y1="110" x2="60" y2="110"/>
<line x1="60" y1="110" x2="70" y2="110"/>
<line x1="70" y1="110" x2="80" y2="110"/>
<text x="95" y="110">S</text>
<text x="105" y="110">e</text>
<text x="115" y="110">r</text>
<text x="125" y="110">v</text>
<text x="135" y="110">e</text>
<text x="145" y="110">r</text>
<text x="155" y="110">H</text>
<text x="165" y="110">e</text>
<text x="175" y="110">l</text>
<text x="185" y="110">l</text>
<text x="195" y="110">o</text>
<line x1="210" y1="110" x2="220" y2="110"/>
<line x1="220" y1="110" x2="230" y2="110"/>
<line x1="230" y1="110" x2="240" y2="110"/>
<line x1="240" y1="110" x2="250" y2="110"/>
<line x1="250" y1="110" x2="260" y2="110"/>
<line x1="260" y1="110" x2="270" y2="110"/>
<line x1="270" y1="110" x2="280" y2="110"/>
<line x1="280" y1="110" x2="290" y2="110"/>
<line x1="290" y1="110" x2="300" y2="110"/>
<line x1="300" y1="110" x2="310" y2="110"/>
<line x1="310" y1="110" x2="320" y2="110"/>
<line x1="320" y1="110" x2="330" y2="110"/>
<line x1="330" y1="110" x2="340" y2="110"/>
<line x1="340" y1="110" x2="350" y2="110"/>
<line x1="350" y1="110" x2="360" y2="110"/>
<line x1="360" y1="110" x2="370" y2="110"/>
<line x1="370" y1="110" x2="380" y2="110"/>
<line x1="380" y1="110" x2="390" y2="110"/>
<line x1="390" y1="110" x2="400" y2="110"/>
<line x1="400" y1="110" x2="410" y2="110"/>
<line x1="410" y1="110" x2="420" y2="110"/>
<line x1="425" y1="100" x2="425" y2="120"/>
<line x1="25" y1="120" x2="25" y2="140"/>
<text x="95" y="130">(</text>
<text x="105" y="130">p</text>
<text x="115" y="130">r</text>
<text x="125" y="130">o</text>
<text x="135" y="130">t</text>
<text x="145" y="130">o</text>
<text x="155" y="130">c</text>
<text x="165" y="130">o</text>
<text x="175" y="130">l</text>
<text x="195" y="130">v</text>
<text x="205" y="130">e</text>
<text x="215" y="130">r</text>
<text x="225" y="130">s</text>
<text x="235" y="130">i</text>
<text x="245" y="130">o</text>
<text x="255" y="130">n</text>
<text x="265" y="130">,</text>
<text x="285" y="130">c</text>
<text x="295" y="130">e</text>
<text x="305" y="130">r</text>
<text x="315" y="130">t</text>
<text x="325" y="130">i</text>
<text x="335" y="130">f</text>
<text x="345" y="130">i</text>
<text x="355" y="130">c</text>
<text x="365" y="130">a</text>
<text x="375" y="130">t</text>
<text x="385" y="130">e</text>
<text x="395" y="130">)</text>
<line x1="435" y1="120" x2="435" y2="140"/>
<line x1="25" y1="140" x2="25" y2="160"/>
<line x1="435" y1="140" x2="435" y2="160"/>
<line x1="25" y1="160" x2="25" y2="180"/>
<line x1="30" y1="170" x2="40" y2="170"/>
<line x1="40" y1="170" x2="50" y2="170"/>
<line x1="50" y1="170" x2="60" y2="170"/>
<line x1="60" y1="170" x2="70" y2="170"/>
<text x="85" y="170">C</text>
<text x="95" y="170">l</text>
<text x="105" y="170">i</text>
<text x="115" y="170">e</text>
<text x="125" y="170">n</text>
<text x="135" y="170">t</text>
<text x="145" y="170">A</text>
<text x="155" y="170">u</text>
<text x="165" y="170">t</text>
<text x="175" y="170">h</text>
<line x1="190" y1="170" x2="200" y2="170"/>
<line x1="200" y1="170" x2="210" y2="170"/>
<line x1="210" y1="170" x2="220" y2="170"/>
<line x1="220" y1="170" x2="230" y2="170"/>
<line x1="230" y1="170" x2="240" y2="170"/>
<line x1="240" y1="170" x2="250" y2="170"/>
<line x1="250" y1="170" x2="260" y2="170"/>
<line x1="260" y1="170" x2="270" y2="170"/>
<line x1="270" y1="170" x2="280" y2="170"/>
<line x1="280" y1="170" x2="290" y2="170"/>
<line x1="290" y1="170" x2="300" y2="170"/>
<line x1="300" y1="170" x2="310" y2="170"/>
<line x1="310" y1="170" x2="320" y2="170"/>
<line x1="320" y1="170" x2="330" y2="170"/>
<line x1="330" y1="170" x2="340" y2="170"/>
<line x1="340" y1="170" x2="350" y2="170"/>
<line x1="350" y1="170" x2="360" y2="170"/>
<line x1="360" y1="170" x2="370" y2="170"/>
<line x1="370" y1="170" x2="380" y2="170"/>
<line x1="380" y1="170" x2="390" y2="170"/>
<line x1="390" y1="170" x2="400" y2="170"/>
<line x1="400" y1="170" x2="410" y2="170"/>
<line x1="410" y1="170" x2="420" y2="170"/>
<text x="425" y="170">→</text>
<line x1="435" y1="160" x2="435" y2="180"/>
<line x1="25" y1="180" x2="25" y2="200"/>
<text x="85" y="190">(</text>
<text x="95" y="190">c</text>
<text x="105" y="190">e</text>
<text x="115" y="190">r</text>
<text x="125" y="190">t</text>
<text x="135" y="190">i</text>
<text x="145" y="190">f</text>
<text x="155" y="190">i</text>
<text x="165" y="190">c</text>
<text x="175" y="190">a</text>
<text x="185" y="190">t</text>
<text x="195" y="190">e</text>
<text x="205" y="190">,</text>
<text x="225" y="190">c</text>
<text x="235" y="190">h</text>
<text x="245" y="190">a</text>
<text x="255" y="190">l</text>
<text x="265" y="190">l</text>
<text x="275" y="190">e</text>
<text x="285" y="190">n</text>
<text x="295" y="190">g</text>
<text x="305" y="190">e</text>
<text x="315" y="190">-</text>
<text x="325" y="190">r</text>
<text x="335" y="190">e</text>
<text x="345" y="190">s</text>
<text x="355" y="190">p</text>
<text x="365" y="190">o</text>
<text x="375" y="190">n</text>
<text x="385" y="190">s</text>
<text x="395" y="190">e</text>
<text x="405" y="190">)</text>
<line x1="435" y1="180" x2="435" y2="200"/>
<line x1="25" y1="200" x2="25" y2="220"/>
<line x1="435" y1="200" x2="435" y2="220"/>
<line x1="25" y1="220" x2="25" y2="240"/>
<text x="35" y="230">←</text>
<line x1="40" y1="230" x2="50" y2="230"/>
<line x1="50" y1="230" x2="60" y2="230"/>
<line x1="60" y1="230" x2="70" y2="230"/>
<line x1="70" y1="230" x2="80" y2="230"/>
<text x="95" y="230">S</text>
<text x="105" y="230">e</text>
<text x="115" y="230">r</text>
<text x="125" y="230">v</text>
<text x="135" y="230">e</text>
<text x="145" y="230">r</text>
<text x="155" y="230">A</text>
<text x="165" y="230">u</text>
<text x="175" y="230">t</text>
<text x="185" y="230">h</text>
<line x1="200" y1="230" x2="210" y2="230"/>
<line x1="210" y1="230" x2="220" y2="230"/>
<line x1="220" y1="230" x2="230" y2="230"/>
<line x1="230" y1="230" x2="240" y2="230"/>
<line x1="240" y1="230" x2="250" y2="230"/>
<line x1="250" y1="230" x2="260" y2="230"/>
<line x1="260" y1="230" x2="270" y2="230"/>
<line x1="270" y1="230" x2="280" y2="230"/>
<line x1="280" y1="230" x2="290" y2="230"/>
<line x1="290" y1="230" x2="300" y2="230"/>
<line x1="300" y1="230" x2="310" y2="230"/>
<line x1="310" y1="230" x2="320" y2="230"/>
<line x1="320" y1="230" x2="330" y2="230"/>
<line x1="330" y1="230" x2="340" y2="230"/>
<line x1="340" y1="230" x2="350" y2="230"/>
<line x1="350" y1="230" x2="360" y2="230"/>
<line x1="360" y1="230" x2="370" y2="230"/>
<line x1="370" y1="230" x2="380" y2="230"/>
<line x1="380" y1="230" x2="390" y2="230"/>
<line x1="390" y1="230" x2="400" y2="230"/>
<line x1="400" y1="230" x2="410" y2="230"/>
<line x1="410" y1="230" x2="420" y2="230"/>
<line x1="425" y1="220" x2="425" y2="240"/>
<line x1="25" y1="240" x2="25" y2="260"/>
<text x="95" y="250">(</text>
<text x="105" y="250">c</text>
<text x="115" y="250">h</text>
<text x="125" y="250">a</text>
<text x="135" y="250">l</text>
<text x="145" y="250">l</text>
<text x="155" y="250">e</text>
<text x="165" y="250">n</text>
<text x="175" y="250">g</text>
<text x="185" y="250">e</text>
<text x="195" y="250">-</text>
<text x="205" y="250">r</text>
<text x="215" y="250">e</text>
<text x="225" y="250">s</text>
<text x="235" y="250">p</text>
<text x="245" y="250">o</text>
<text x="255" y="250">n</text>
<text x="265" y="250">s</text>
<text x="275" y="250">e</text>
<text x="285" y="250">)</text>
<line x1="435" y1="240" x2="435" y2="260"/>
<line x1="25" y1="260" x2="25" y2="280"/>
<line x1="435" y1="260" x2="435" y2="280"/>
<line x1="25" y1="280" x2="25" y2="300"/>
<line x1="30" y1="290" x2="40" y2="290"/>
<line x1="40" y1="290" x2="50" y2="290"/>
<line x1="50" y1="290" x2="60" y2="290"/>
<line x1="60" y1="290" x2="70" y2="290"/>
<line x1="70" y1="290" x2="80" y2="290"/>
<line x1="80" y1="290" x2="90" y2="290"/>
<text x="105" y="290">E</text>
<text x="115" y="290">n</text>
<text x="125" y="290">c</text>
<text x="135" y="290">r</text>
<text x="145" y="290">y</text>
<text x="155" y="290">p</text>
<text x="165" y="290">t</text>
<text x="175" y="290">e</text>
<text x="185" y="290">d</text>
<text x="205" y="290">C</text>
<text x="215" y="290">h</text>
<text x="225" y="290">a</text>
<text x="235" y="290">n</text>
<text x="245" y="290">n</text>
<text x="255" y="290">e</text>
<text x="265" y="290">l</text>
<line x1="280" y1="290" x2="290" y2="290"/>
<line x1="290" y1="290" x2="300" y2="290"/>
<line x1="300" y1="290" x2="310" y2="290"/>
<line x1="310" y1="290" x2="320" y2="290"/>
<line x1="320" y1="290" x2="330" y2="290"/>
<line x1="330" y1="290" x2="340" y2="290"/>
<line x1="340" y1="290" x2="350" y2="290"/>
<line x1="350" y1="290" x2="360" y2="290"/>
<line x1="360" y1="290" x2="370" y2="290"/>
<line x1="370" y1="290" x2="380" y2="290"/>
<line x1="380" y1="290" x2="390" y2="290"/>
<line x1="390" y1="290" x2="400" y2="290"/>
<line x1="400" y1="290" x2="410" y2="290"/>
<line x1="410" y1="290" x2="420" y2="290"/>
<line x1="425" y1="280" x2="425" y2="300"/>
</svg>
</div>
<h3>Handshake Implementation</h3>
<pre class="language-scheme">
(define (connection-handshake connection)
  "Perform mutual authentication handshake"

  ;; Send ClientHello
  (send-message connection
    (client-hello
      (version ,protocol-version)
      (capabilities ,(local-capabilities))))

  ;; Receive ServerHello
  (let ((server-hello (receive-message connection)))
    (verify-protocol-version (server-hello-version server-hello))

    ;; Verify server certificate
    (let ((server-cert (server-hello-certificate server-hello)))
      (unless (verify-certificate server-cert)
        (error "Server certificate invalid"))

      ;; Generate session key using X25519
      (let* ((ephemeral-keypair (x25519-keypair))
             (shared-secret (x25519-shared (keypair-secret ephemeral-keypair)
                                          (cert-public-key server-cert))))

        ;; Send ClientAuth
        (send-message connection
          (client-auth
            (certificate ,(local-certificate))
            (ephemeral-public ,(keypair-public ephemeral-keypair))
            (signature ,(sign-challenge server-hello))))

        ;; Receive ServerAuth
        (let ((server-auth (receive-message connection)))
          (unless (verify-server-signature server-auth server-cert)
            (error "Server authentication failed"))

          ;; Derive session keys
          (derive-session-keys connection shared-secret))))))
</pre>
<h3>Session Encryption</h3>
<pre class="language-scheme">
(define (derive-session-keys connection shared-secret)
  "Derive symmetric keys for session"
  (let* ((key-material (hkdf shared-secret
                             info: "library-session"
                             length: 64))
         (client-key (subbytes key-material 0 32))
         (server-key (subbytes key-material 32 64)))

    (set-connection-keys! connection
      (if (connection-is-client? connection)
          (keys send: client-key receive: server-key)
          (keys send: server-key receive: client-key)))))

(define (encrypt-message connection message)
  "Encrypt message with session key"
  (let ((nonce (connection-next-nonce connection)))
    (chacha20-poly1305-encrypt
      (connection-send-key connection)
      nonce
      (serialize message))))

(define (decrypt-message connection ciphertext)
  "Decrypt message with session key"
  (let ((nonce (connection-next-nonce connection)))
    (deserialize
      (chacha20-poly1305-decrypt
        (connection-receive-key connection)
        nonce
        ciphertext))))
</pre>
</section>
<section>
<h2>Message Layer</h2>
<h3>Message Format</h3>
<pre class="language-scheme">
(library-message
  (version 1)
  (type request|response|stream|error)
  (id &lt;message-id&gt;)
  (in-reply-to &lt;message-id&gt;|#f)
  (capability &lt;spki-cert&gt;|#f)
  (body &lt;payload&gt;))
</pre>
<h3>Request Types</h3>
<pre class="language-scheme">
(define request-types
  '(;; Object operations
    (get-object hash)
    (put-object hash data)
    (has-object hash)

    ;; Bulk operations
    (get-objects hashes)
    (get-tree root-hash)
    (sync-objects bloom-filter)

    ;; Soup queries
    (soup-query query)
    (soup-subscribe query)

    ;; Vault operations
    (get-refs pattern)
    (get-head)
    (get-releases)

    ;; Discovery
    (get-capabilities)
    (get-peers)))
</pre>
<h3>Request/Response</h3>
<pre class="language-scheme">
(define (vault-request connection request #!key capability timeout)
  "Send request, wait for response"
  (let ((message-id (generate-message-id)))

    ;; Send request
    (send-message connection
      (library-message
        version: 1
        type: 'request
        id: message-id
        capability: capability
        body: request))

    ;; Wait for response
    (let ((response (receive-response connection message-id timeout)))
      (if (eq? (message-type response) 'error)
          (error (message-body response))
          (message-body response)))))
</pre>
<h3>Streaming</h3>
<p>For large transfers:</p>
<pre class="language-scheme">
(define (stream-object connection hash)
  "Stream large object in chunks"
  (let ((stream (open-stream connection 'object-transfer)))

    ;; Send chunks
    (let ((data (cas-get hash)))
      (let loop ((offset 0))
        (when (&lt; offset (blob-length data))
          (let ((chunk (blob-copy data offset chunk-size)))
            (stream-send stream chunk)
            (loop (+ offset chunk-size)))))

      ;; End stream
      (stream-close stream))))

(define (receive-stream connection stream callback)
  "Receive streamed data"
  (let loop ((chunks '()))
    (let ((chunk (stream-receive stream)))
      (if (stream-ended? stream)
          (apply bytes-append (reverse chunks))
          (begin
            (callback chunk)
            (loop (cons chunk chunks)))))))
</pre>
</section>
<section>
<h2>Object Exchange</h2>
<h3>Get Object</h3>
<pre class="language-scheme">
;; Request
(get-object
  (hash "sha256:abc123..."))

;; Response (small object)
(object-data
  (hash "sha256:abc123...")
  (size 1024)
  (data #${...}))

;; Response (large object - streaming)
(object-stream
  (hash "sha256:abc123...")
  (size 10485760)
  (stream-id 42))
</pre>
<h3>Put Object</h3>
<pre class="language-scheme">
;; Request
(put-object
  (hash "sha256:abc123...")
  (data #${...}))

;; Response
(put-result
  (hash "sha256:abc123...")
  (status stored|duplicate|rejected)
  (reason #f|"quota exceeded"))
</pre>
<h3>Batch Operations</h3>
<pre class="language-scheme">
;; Request multiple objects
(get-objects
  (hashes ("sha256:aaa..." "sha256:bbb..." "sha256:ccc...")))

;; Response
(objects-batch
  (objects
    ((hash "sha256:aaa..." data #${...})
     (hash "sha256:bbb..." data #${...})
     (hash "sha256:ccc..." status: missing))))
</pre>
<h3>Tree Transfer</h3>
<p>Efficient Merkle tree sync:</p>
<pre class="language-scheme">
;; Request tree
(get-tree
  (root "sha256:root...")
  (depth 3)  ; How deep to fetch
  (exclude ("sha256:already-have...")))

;; Response
(tree-data
  (root "sha256:root...")
  (objects
    ((hash "sha256:root..." data #${...})
     (hash "sha256:child1..." data #${...})
     (hash "sha256:child2..." data #${...}))))
</pre>
</section>
<section>
<h2>Synchronization</h2>
<h3>Bloom Filter Exchange</h3>
<p>Efficient "what do you have?" queries:</p>
<pre class="language-scheme">
;; Step 1: Exchange bloom filters
(define (sync-init local-vault remote-connection)
  (let ((local-bloom (vault-bloom-filter local-vault)))

    ;; Send our bloom filter
    (send-message remote-connection
      `(sync-bloom
        (filter ,local-bloom)
        (population ,(bloom-population local-bloom))))

    ;; Receive their bloom filter
    (let ((remote-bloom (receive-bloom remote-connection)))

      ;; Compute what they might want
      (let ((to-send (filter (lambda (hash)
                               (not (bloom-contains? remote-bloom hash)))
                             (vault-all-hashes local-vault))))
        to-send))))

;; Step 2: Exchange missing objects
(define (sync-exchange to-send to-receive connection)
  (parallel
    ;; Send what they need
    (for-each (lambda (hash)
                (stream-object connection hash))
              to-send)
    ;; Receive what we need
    (for-each (lambda (hash)
                (receive-object connection hash))
              to-receive)))
</pre>
<h3>Incremental Sync</h3>
<pre class="language-scheme">
(define (incremental-sync local-vault remote-connection since)
  "Sync changes since timestamp or commit"

  ;; Get remote changes
  (let ((remote-changes (vault-request remote-connection
                          `(changes-since ,since))))

    ;; Get local changes
    (let ((local-changes (vault-changes-since local-vault since)))

      ;; Bidirectional merge
      (sync-merge local-vault remote-connection
                  local-changes remote-changes))))
</pre>
<h3>Conflict Resolution</h3>
<pre class="language-scheme">
(define (sync-merge local-vault remote changes-local changes-remote)
  "Merge changes with conflict resolution"

  (for-each
    (lambda (hash)
      (cond
        ;; Only local has it - push
        ((and (member hash changes-local)
              (not (member hash changes-remote)))
         (push-object local-vault remote hash))

        ;; Only remote has it - pull
        ((and (member hash changes-remote)
              (not (member hash changes-local)))
         (pull-object local-vault remote hash))

        ;; Both have it - verify same
        ((and (member hash changes-local)
              (member hash changes-remote))
         ;; Content-addressed, so same hash = same content
         #t)))
    (union changes-local changes-remote)))
</pre>
</section>
<section>
<h2>Discovery</h2>
<h3>Peer Discovery</h3>
<pre class="language-scheme">
;; Well-known peers (bootstrap)
(define (discover-bootstrap)
  (map parse-address
       (read-file "/etc/library/bootstrap-peers")))

;; mDNS/DNS-SD for local network
(define (discover-local)
  (mdns-browse "library.tcp.local"))

;; DHT for global discovery
(define (discover-dht target-hash)
  (dht-find-providers target-hash))

;; Peer exchange
(define (discover-pex connection)
  (vault-request connection '(get-peers)))
</pre>
<h3>Capability Advertisement</h3>
<pre class="language-scheme">
;; Query vault capabilities
(get-capabilities)

;; Response
(vault-capabilities
  (protocol-version 1)
  (features (bloom-sync tree-transfer streaming soup-query))
  (max-object-size 104857600)  ; 100MB
  (storage-available 10737418240)  ; 10GB
  (public-key "ed25519:abc...")
  (services
    ((soup-query rate-limit: 100/minute)
     (object-transfer rate-limit: 10MB/second))))
</pre>
</section>
<section>
<h2>Soup Queries</h2>
<h3>Remote Query</h3>
<pre class="language-scheme">
;; Query remote soup
(soup-query
  (type certificate)
  (issuer "vault-admin")
  (limit 100))

;; Response
(soup-results
  (count 47)
  (objects
    ((name "cert/alice" type certificate ...)
     (name "cert/bob" type certificate ...)
     ...)))
</pre>
<h3>Subscription</h3>
<pre class="language-scheme">
;; Subscribe to soup changes
(soup-subscribe
  (query (type release))
  (callback-url "library://my-vault/callbacks/releases"))

;; Subscription confirmation
(subscription
  (id "sub-123")
  (query (type release))
  (expires "2026-02-07T00:00:00Z"))

;; Push notification (when matching object appears)
(soup-notification
  (subscription-id "sub-123")
  (object (name "release/1.2.0" type release ...)))
</pre>
</section>
<section>
<h2>Error Handling</h2>
<h3>Error Types</h3>
<pre class="language-scheme">
(define error-types
  '((not-found "Object not found")
    (unauthorized "Capability required")
    (forbidden "Capability insufficient")
    (quota-exceeded "Storage quota exceeded")
    (rate-limited "Too many requests")
    (timeout "Operation timed out")
    (invalid-request "Malformed request")
    (internal-error "Server error")
    (unavailable "Service temporarily unavailable")))
</pre>
<h3>Error Response</h3>
<pre class="language-scheme">
(library-message
  (type error)
  (id &lt;message-id&gt;)
  (in-reply-to &lt;request-id&gt;)
  (body
    (error-response
      (code not-found)
      (message "Object sha256:abc... not found")
      (retry-after #f))))
</pre>
<h3>Retry Logic</h3>
<pre class="language-scheme">
(define (vault-request-with-retry connection request #!key max-retries)
  "Request with exponential backoff retry"
  (let loop ((attempt 0) (delay 1000))
    (let ((result (vault-request connection request)))
      (if (and (error-response? result)
               (retryable-error? result)
               (&lt; attempt max-retries))
          (begin
            (sleep delay)
            (loop (+ attempt 1) (* delay 2)))
          result))))
</pre>
</section>
<section>
<h2>Security Considerations</h2>
<h3>Capability Verification</h3>
<pre class="language-scheme">
(define (verify-request-capability request connection)
  "Verify request has sufficient capability"
  (let ((required-cap (request-&gt;capability request))
        (presented-cap (message-capability request)))

    (unless presented-cap
      (error 'unauthorized "Capability required"))

    (unless (valid-certificate? presented-cap)
      (error 'unauthorized "Invalid capability certificate"))

    (unless (capability-grants? presented-cap required-cap)
      (error 'forbidden "Insufficient capability"))

    ;; Verify capability chain back to trusted root
    (unless (verify-capability-chain presented-cap)
      (error 'forbidden "Capability chain invalid"))))
</pre>
<h3>Denial of Service Protection</h3>
<pre class="language-scheme">
(define (rate-limit connection request-type)
  "Apply rate limiting"
  (let ((limit (get-rate-limit request-type))
        (current (connection-request-count connection request-type)))
    (when (&gt; current limit)
      (error 'rate-limited
             (format "Rate limit exceeded: ~a/~a" current limit)))))

(define (size-limit request)
  "Enforce size limits"
  (when (&gt; (request-size request) max-request-size)
    (error 'invalid-request "Request too large")))
</pre>
<h3>Replay Prevention</h3>
<pre class="language-scheme">
(define (verify-nonce connection message)
  "Prevent replay attacks"
  (let ((nonce (message-nonce message)))
    (when (nonce-seen? connection nonce)
      (error 'invalid-request "Replay detected"))
    (record-nonce connection nonce)))
</pre>
</section>
<section>
<h2>Implementation Notes</h2>
<h3>Wire Format</h3>
<p>Messages serialized as canonical S-expressions:</p>
<pre class="language-scheme">
(define (serialize-message message)
  "Canonical S-expression serialization"
  (canonical-sexp-&gt;bytes message))

(define (deserialize-message bytes)
  "Parse S-expression"
  (bytes-&gt;canonical-sexp bytes))
</pre>
<h3>Compression</h3>
<p>Optional compression for large payloads:</p>
<pre class="language-scheme">
(define (maybe-compress data)
  (if (&gt; (blob-length data) compression-threshold)
      (values (zstd-compress data) 'zstd)
      (values data 'none)))
</pre>
<h3>Connection Pooling</h3>
<pre class="language-scheme">
(define connection-pool (make-hash-table))

(define (get-connection address)
  "Get pooled connection or create new"
  (or (hash-table-ref connection-pool address #f)
      (let ((conn (connect-vault address)))
        (hash-table-set! connection-pool address conn)
        conn)))
</pre>
</section>
<section>
<h2>References</h2>
<p>1. [QUIC Protocol - RFC 9000](https://tools.ietf.org/html/rfc9000) 2. [Noise Protocol Framework](http://noiseprotocol.org/) 3. [Memo-020: Content-Addressed Storage](memo-020-content-addressed-storage.html) 4. [Memo-021: Capability Delegation](memo-021-capability-delegation.html) 5. [IPFS Bitswap Protocol](https://docs.ipfs.tech/concepts/bitswap/) 6. [libp2p Specifications](https://github.com/libp2p/specs)</p>
</section>
<section>
<h2>Changelog</h2>
<ul>
<li>2026-01-07</li>
<li>Initial draft</li>
</ul>
</section>
<script>
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}
(function() {
  // Query param override (for REPL: ?theme=dark or ?theme=light)
  const params = new URLSearchParams(window.location.search);
  const param = params.get('theme');
  if (param === 'dark' || param === 'light') {
    document.documentElement.setAttribute('data-theme', param);
    localStorage.setItem('theme', param);
    return;
  }
  // localStorage preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</body>
</html>
