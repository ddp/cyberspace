<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <title>Memo 0022: Content-Addressed Storage</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27%230f0%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>">
  <script>
(function(){
  var h=new Date().getHours(),c;
  if(h>=4&&h<6)c='%23845EC2';       // brahma muhurta - violet
  else if(h>=6&&h<8)c='%23ffd700';  // dawn - gold
  else if(h>=8&&h<11)c='%2300d4aa'; // morning - teal
  else if(h>=11&&h<14)c='%230f0';   // midday - phosphor
  else if(h>=14&&h<17)c='%2339ff14';// afternoon - neon
  else if(h>=17&&h<19)c='%23ff6600';// sunset - orange
  else if(h>=19&&h<22)c='%23ff3366';// evening - coral
  else c='%2300ffff';               // night - cyan
  document.getElementById('favicon').href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27'+c+'%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>';
})();
</script>
  <link rel="stylesheet" href="memo.css">
</head>
<body>
<span class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark">[theme]</span>
<h1>Memo 0022: Content-Addressed Storage</h1>
<dl class="metadata">
</dl>
<hr>
<section>
<h2>Abstract</h2>
<p>This Memo specifies content-addressed storage (CAS) for the Library of Cyberspace: a storage model where data is addressed by its cryptographic hash rather than by location. Content addressing provides immutability guarantees, automatic deduplication, and tamper-evident storage.</p>
</section>
<section>
<h2>Motivation</h2>
<p>Traditional storage systems use location-based addressing:</p>
<ul>
<li>DECtape: Physical position on magnetic tape</li>
<li>Filesystems: Path names (/home/ddp/file.txt)</li>
<li>Databases: Row IDs, primary keys</li>
<li>URLs: Server + path (https://example.com/doc.ps)</li>
</ul>
<p>Location-based addressing has fundamental problems:</p>
<ul>
<li>Mutability - Same address can point to different content over time</li>
<li>Link rot - Addresses become invalid when content moves</li>
<li>Duplication - Identical content stored multiple times</li>
<li>No verification - Address doesn't prove content integrity</li>
</ul>
<p>These problems are architectural, not operational; no amount of careful administration can fix a model where names and content are decoupled.</p>
<p>Content-addressed storage inverts this:</p>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 580 40" width="580" height="40" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<text x="5" y="10">L</text>
<text x="15" y="10">o</text>
<text x="25" y="10">c</text>
<text x="35" y="10">a</text>
<text x="45" y="10">t</text>
<text x="55" y="10">i</text>
<text x="65" y="10">o</text>
<text x="75" y="10">n</text>
<text x="85" y="10">-</text>
<text x="95" y="10">b</text>
<text x="105" y="10">a</text>
<text x="115" y="10">s</text>
<text x="125" y="10">e</text>
<text x="135" y="10">d</text>
<text x="145" y="10">:</text>
<text x="175" y="10">a</text>
<text x="185" y="10">d</text>
<text x="195" y="10">d</text>
<text x="205" y="10">r</text>
<text x="215" y="10">e</text>
<text x="225" y="10">s</text>
<text x="235" y="10">s</text>
<text x="255" y="10">→</text>
<text x="275" y="10">c</text>
<text x="285" y="10">o</text>
<text x="295" y="10">n</text>
<text x="305" y="10">t</text>
<text x="315" y="10">e</text>
<text x="325" y="10">n</text>
<text x="335" y="10">t</text>
<text x="355" y="10">(</text>
<text x="365" y="10">m</text>
<text x="375" y="10">a</text>
<text x="385" y="10">n</text>
<text x="395" y="10">y</text>
<text x="405" y="10">-</text>
<text x="415" y="10">t</text>
<text x="425" y="10">o</text>
<text x="435" y="10">-</text>
<text x="445" y="10">o</text>
<text x="455" y="10">n</text>
<text x="465" y="10">e</text>
<text x="475" y="10">,</text>
<text x="495" y="10">m</text>
<text x="505" y="10">u</text>
<text x="515" y="10">t</text>
<text x="525" y="10">a</text>
<text x="535" y="10">b</text>
<text x="545" y="10">l</text>
<text x="555" y="10">e</text>
<text x="565" y="10">)</text>
<text x="5" y="30">C</text>
<text x="15" y="30">o</text>
<text x="25" y="30">n</text>
<text x="35" y="30">t</text>
<text x="45" y="30">e</text>
<text x="55" y="30">n</text>
<text x="65" y="30">t</text>
<text x="75" y="30">-</text>
<text x="85" y="30">b</text>
<text x="95" y="30">a</text>
<text x="105" y="30">s</text>
<text x="115" y="30">e</text>
<text x="125" y="30">d</text>
<text x="135" y="30">:</text>
<text x="175" y="30">c</text>
<text x="185" y="30">o</text>
<text x="195" y="30">n</text>
<text x="205" y="30">t</text>
<text x="215" y="30">e</text>
<text x="225" y="30">n</text>
<text x="235" y="30">t</text>
<text x="255" y="30">→</text>
<text x="275" y="30">a</text>
<text x="285" y="30">d</text>
<text x="295" y="30">d</text>
<text x="305" y="30">r</text>
<text x="315" y="30">e</text>
<text x="325" y="30">s</text>
<text x="335" y="30">s</text>
<text x="355" y="30">(</text>
<text x="365" y="30">o</text>
<text x="375" y="30">n</text>
<text x="385" y="30">e</text>
<text x="395" y="30">-</text>
<text x="405" y="30">t</text>
<text x="415" y="30">o</text>
<text x="425" y="30">-</text>
<text x="435" y="30">o</text>
<text x="445" y="30">n</text>
<text x="455" y="30">e</text>
<text x="465" y="30">,</text>
<text x="485" y="30">i</text>
<text x="495" y="30">m</text>
<text x="505" y="30">m</text>
<text x="515" y="30">u</text>
<text x="525" y="30">t</text>
<text x="535" y="30">a</text>
<text x="545" y="30">b</text>
<text x="555" y="30">l</text>
<text x="565" y="30">e</text>
<text x="575" y="30">)</text>
</svg>
</div>
<p>The address IS the content's cryptographic fingerprint. If the content changes, the address changes. If two files have the same address, they are byte-for-byte identical.</p>
</section>
<section>
<h2>Content Addressing Model</h2>
<h3>Hash as Address</h3>
<pre class="language-scheme">
;; Content determines address
(define (content-address data)
  (sha256 data))

;; Store by hash
(define (cas-store data)
  (let ((hash (content-address data)))
    (write-blob (hash-&gt;path hash) data)
    hash))

;; Retrieve by hash
(define (cas-retrieve hash)
  (let ((data (read-blob (hash-&gt;path hash))))
    (if (equal? hash (content-address data))
        data
        (error "Content tampered"))))
</pre>
<h3>Properties</h3>
<table>
<tr><th>Property </th><th>Location-Based </th><th>Content-Addressed </th></tr>
<tr><td>Address stability </td><td>Unstable </td><td>Permanent </td></tr>
<tr><td>Content verification </td><td>External </td><td>Intrinsic </td></tr>
<tr><td>Deduplication </td><td>Manual </td><td>Automatic </td></tr>
<tr><td>Mutability </td><td>Mutable </td><td>Immutable </td></tr>
<tr><td>Link rot </td><td>Common </td><td>Impossible </td></tr>
</table>
<h3>Hash Function Requirements</h3>
<p>The hash function MUST be:</p>
<ul>
<li>Collision-resistant - Computationally infeasible to find two inputs with same hash</li>
<li>Preimage-resistant - Cannot derive content from hash</li>
<li>Deterministic - Same content always produces same hash</li>
<li>Fast - Practical for large objects</li>
</ul>
<p>The hash function is the foundation of trust; weakening any property undermines the entire addressing model.</p>
<p>Specified hash: SHA-256 (32 bytes, 64 hex characters)</p>
<pre class="language-scheme">
;; Example content address
"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
;; This is the SHA-256 of the empty string
</pre>
</section>
<section>
<h2>Storage Architecture</h2>
<h3>Object Store</h3>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 740 220" width="740" height="220" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<text x="5" y="10">.</text>
<text x="15" y="10">c</text>
<text x="25" y="10">a</text>
<text x="35" y="10">s</text>
<text x="45" y="10">/</text>
<line x1="5" y1="20" x2="5" y2="40"/>
<line x1="5" y1="30" x2="10" y2="30"/>
<line x1="10" y1="30" x2="20" y2="30"/>
<line x1="20" y1="30" x2="30" y2="30"/>
<text x="45" y="30">o</text>
<text x="55" y="30">b</text>
<text x="65" y="30">j</text>
<text x="75" y="30">e</text>
<text x="85" y="30">c</text>
<text x="95" y="30">t</text>
<text x="105" y="30">s</text>
<text x="115" y="30">/</text>
<line x1="5" y1="40" x2="5" y2="60"/>
<line x1="45" y1="40" x2="45" y2="60"/>
<line x1="45" y1="50" x2="50" y2="50"/>
<line x1="50" y1="50" x2="60" y2="50"/>
<line x1="60" y1="50" x2="70" y2="50"/>
<text x="85" y="50">e</text>
<text x="95" y="50">3</text>
<text x="105" y="50">/</text>
<line x1="5" y1="60" x2="5" y2="80"/>
<line x1="45" y1="60" x2="45" y2="80"/>
<line x1="85" y1="70" x2="90" y2="70"/>
<line x1="85" y1="60" x2="85" y2="70"/>
<line x1="90" y1="70" x2="100" y2="70"/>
<line x1="100" y1="70" x2="110" y2="70"/>
<text x="125" y="70">b</text>
<text x="135" y="70">0</text>
<text x="145" y="70">c</text>
<text x="155" y="70">4</text>
<text x="165" y="70">4</text>
<text x="175" y="70">2</text>
<text x="185" y="70">9</text>
<text x="195" y="70">8</text>
<text x="205" y="70">f</text>
<text x="215" y="70">c</text>
<text x="225" y="70">1</text>
<text x="235" y="70">c</text>
<text x="245" y="70">1</text>
<text x="255" y="70">4</text>
<text x="265" y="70">9</text>
<text x="275" y="70">a</text>
<text x="285" y="70">f</text>
<text x="295" y="70">b</text>
<text x="305" y="70">f</text>
<text x="315" y="70">4</text>
<text x="325" y="70">c</text>
<text x="335" y="70">8</text>
<text x="345" y="70">9</text>
<text x="355" y="70">9</text>
<text x="365" y="70">6</text>
<text x="375" y="70">f</text>
<text x="385" y="70">b</text>
<text x="395" y="70">9</text>
<text x="405" y="70">2</text>
<text x="415" y="70">4</text>
<text x="425" y="70">2</text>
<text x="435" y="70">7</text>
<text x="445" y="70">a</text>
<text x="455" y="70">e</text>
<text x="465" y="70">4</text>
<text x="475" y="70">1</text>
<text x="485" y="70">e</text>
<text x="495" y="70">4</text>
<text x="505" y="70">6</text>
<text x="515" y="70">4</text>
<text x="525" y="70">9</text>
<text x="535" y="70">b</text>
<text x="545" y="70">9</text>
<text x="555" y="70">3</text>
<text x="565" y="70">4</text>
<text x="575" y="70">c</text>
<text x="585" y="70">a</text>
<text x="595" y="70">4</text>
<text x="605" y="70">9</text>
<text x="615" y="70">5</text>
<text x="625" y="70">9</text>
<text x="635" y="70">9</text>
<text x="645" y="70">1</text>
<text x="655" y="70">b</text>
<text x="665" y="70">7</text>
<text x="675" y="70">8</text>
<text x="685" y="70">5</text>
<text x="695" y="70">2</text>
<text x="705" y="70">b</text>
<text x="715" y="70">8</text>
<text x="725" y="70">5</text>
<text x="735" y="70">5</text>
<line x1="5" y1="80" x2="5" y2="100"/>
<line x1="45" y1="80" x2="45" y2="100"/>
<line x1="45" y1="90" x2="50" y2="90"/>
<line x1="50" y1="90" x2="60" y2="90"/>
<line x1="60" y1="90" x2="70" y2="90"/>
<text x="85" y="90">a</text>
<text x="95" y="90">7</text>
<text x="105" y="90">/</text>
<line x1="5" y1="100" x2="5" y2="120"/>
<line x1="45" y1="100" x2="45" y2="120"/>
<line x1="85" y1="110" x2="90" y2="110"/>
<line x1="85" y1="100" x2="85" y2="110"/>
<line x1="90" y1="110" x2="100" y2="110"/>
<line x1="100" y1="110" x2="110" y2="110"/>
<text x="125" y="110">f</text>
<text x="135" y="110">f</text>
<text x="145" y="110">c</text>
<text x="155" y="110">6</text>
<text x="165" y="110">f</text>
<text x="175" y="110">8</text>
<text x="185" y="110">b</text>
<text x="195" y="110">f</text>
<text x="205" y="110">1</text>
<text x="215" y="110">e</text>
<text x="225" y="110">d</text>
<text x="235" y="110">7</text>
<text x="245" y="110">6</text>
<text x="255" y="110">6</text>
<text x="265" y="110">5</text>
<text x="275" y="110">1</text>
<text x="285" y="110">c</text>
<text x="295" y="110">1</text>
<text x="305" y="110">4</text>
<text x="315" y="110">7</text>
<text x="325" y="110">5</text>
<text x="335" y="110">6</text>
<text x="345" y="110">a</text>
<text x="355" y="110">0</text>
<text x="365" y="110">6</text>
<text x="375" y="110">1</text>
<text x="385" y="110">d</text>
<text x="395" y="110">6</text>
<text x="405" y="110">6</text>
<text x="415" y="110">2</text>
<text x="425" y="110">f</text>
<text x="435" y="110">5</text>
<text x="445" y="110">8</text>
<text x="455" y="110">0</text>
<text x="465" y="110">f</text>
<text x="475" y="110">f</text>
<text x="485" y="110">4</text>
<text x="495" y="110">d</text>
<text x="505" y="110">e</text>
<text x="515" y="110">4</text>
<text x="525" y="110">3</text>
<text x="535" y="110">b</text>
<text x="545" y="110">4</text>
<text x="555" y="110">9</text>
<text x="565" y="110">f</text>
<text x="575" y="110">a</text>
<text x="585" y="110">8</text>
<text x="595" y="110">2</text>
<text x="605" y="110">d</text>
<text x="615" y="110">8</text>
<text x="625" y="110">0</text>
<text x="635" y="110">a</text>
<text x="645" y="110">4</text>
<text x="655" y="110">b</text>
<text x="665" y="110">8</text>
<text x="675" y="110">0</text>
<text x="685" y="110">f</text>
<text x="695" y="110">8</text>
<text x="705" y="110">4</text>
<text x="715" y="110">3</text>
<text x="725" y="110">4</text>
<text x="735" y="110">a</text>
<line x1="5" y1="120" x2="5" y2="140"/>
<line x1="45" y1="130" x2="50" y2="130"/>
<line x1="45" y1="120" x2="45" y2="130"/>
<line x1="50" y1="130" x2="60" y2="130"/>
<line x1="60" y1="130" x2="70" y2="130"/>
<text x="85" y="130">.</text>
<text x="95" y="130">.</text>
<text x="105" y="130">.</text>
<line x1="5" y1="140" x2="5" y2="160"/>
<line x1="5" y1="150" x2="10" y2="150"/>
<line x1="10" y1="150" x2="20" y2="150"/>
<line x1="20" y1="150" x2="30" y2="150"/>
<text x="45" y="150">r</text>
<text x="55" y="150">e</text>
<text x="65" y="150">f</text>
<text x="75" y="150">s</text>
<text x="85" y="150">/</text>
<line x1="5" y1="160" x2="5" y2="180"/>
<line x1="45" y1="160" x2="45" y2="180"/>
<line x1="45" y1="170" x2="50" y2="170"/>
<line x1="50" y1="170" x2="60" y2="170"/>
<line x1="60" y1="170" x2="70" y2="170"/>
<text x="85" y="170">H</text>
<text x="95" y="170">E</text>
<text x="105" y="170">A</text>
<text x="115" y="170">D</text>
<line x1="5" y1="180" x2="5" y2="200"/>
<line x1="45" y1="190" x2="50" y2="190"/>
<line x1="45" y1="180" x2="45" y2="190"/>
<line x1="50" y1="190" x2="60" y2="190"/>
<line x1="60" y1="190" x2="70" y2="190"/>
<text x="85" y="190">t</text>
<text x="95" y="190">a</text>
<text x="105" y="190">g</text>
<text x="115" y="190">s</text>
<text x="125" y="190">/</text>
<line x1="5" y1="210" x2="10" y2="210"/>
<line x1="5" y1="200" x2="5" y2="210"/>
<line x1="10" y1="210" x2="20" y2="210"/>
<line x1="20" y1="210" x2="30" y2="210"/>
<text x="45" y="210">i</text>
<text x="55" y="210">n</text>
<text x="65" y="210">d</text>
<text x="75" y="210">e</text>
<text x="85" y="210">x</text>
</svg>
</div>
<p>Sharding: First two hex characters of hash form directory name (256 buckets).</p>
<h3>Object Types</h3>
<pre class="language-scheme">
;; Blob - raw data
(cas-blob
  (hash "sha256:...")
  (size 1024)
  (data #${...}))

;; Tree - directory structure
(cas-tree
  (hash "sha256:...")
  (entries
    (("README.md" blob "sha256:abc...")
     ("src" tree "sha256:def...")
     ("lib" tree "sha256:ghi..."))))

;; Commit - snapshot with metadata
(cas-commit
  (hash "sha256:...")
  (tree "sha256:...")
  (parent "sha256:..." | #f)
  (author "ddp@eludom.net")
  (timestamp 1767700000)
  (message "Initial commit"))
</pre>
<h3>Merkle Trees</h3>
<p>Directories are trees of hashes. The root hash commits to all content:</p>
<pre>
                    root: sha256:abc...
                         /          \
              src: sha256:def     lib: sha256:ghi
               /        \              |
        main.scm     test.scm      util.scm
        sha256:111   sha256:222    sha256:333
</pre>
<p>Changing ANY file changes ALL parent hashes up to root.</p>
</section>
<section>
<h2>Operations</h2>
<h3>Store</h3>
<pre class="language-scheme">
(define (cas-put content)
  "Store content, return hash"
  (let* ((hash (sha256 content))
         (path (hash-&gt;path hash)))
    (unless (file-exists? path)
      (write-blob path content))
    hash))
</pre>
<p>Deduplication: If hash already exists, storage is a no-op.</p>
<h3>Retrieve</h3>
<pre class="language-scheme">
(define (cas-get hash)
  "Retrieve content by hash, verify integrity"
  (let* ((path (hash-&gt;path hash))
         (content (read-blob path)))
    (unless (equal? hash (sha256 content))
      (error "Content integrity failure" hash))
    content))
</pre>
<p>Self-verifying: Every retrieval confirms integrity.</p>
<h3>Exists</h3>
<pre class="language-scheme">
(define (cas-exists? hash)
  "Check if content exists"
  (file-exists? (hash-&gt;path hash)))
</pre>
<h3>Delete</h3>
<pre class="language-scheme">
(define (cas-gc roots)
  "Garbage collect unreachable objects"
  (let ((reachable (trace-reachable roots)))
    (for-each
      (lambda (hash)
        (unless (set-member? reachable hash)
          (delete-file (hash-&gt;path hash))))
      (all-objects))))
</pre>
<p>Note: Deletion requires garbage collection from known roots.</p>
</section>
<section>
<h2>Naming Layer</h2>
<p>Content addresses are not human-friendly. A naming layer maps names to hashes:</p>
<h3>References</h3>
<pre class="language-scheme">
;; Mutable reference to immutable content
(define (ref-set name hash)
  (write-file (ref-path name) hash))

(define (ref-get name)
  (read-file (ref-path name)))

;; Example
(ref-set "HEAD" "sha256:abc123...")
(ref-get "HEAD") ; =&gt; "sha256:abc123..."
</pre>
<h3>Tags</h3>
<pre class="language-scheme">
;; Immutable named reference
(define (tag-create name hash #!key message signature)
  (let ((tag-content
         `(tag
           (name ,name)
           (object ,hash)
           (message ,message)
           (signature ,signature))))
    (cas-put (serialize tag-content))))
</pre>
<h3>Directory Entries</h3>
<pre class="language-scheme">
;; Human name -&gt; content hash
(define library-index
  '(("Memo-000" . "sha256:e3b0c44...")
    ("Memo-001" . "sha256:a7ffc6f...")
    ("Memo-002" . "sha256:b94d27b...")))
</pre>
</section>
<section>
<h2>The Soup: Object Directory</h2>
<p>Content-addressed storage provides retrieval by hash, but discovery requires an object directory. The Soup (inspired by NewtonOS) provides a unified view of all objects with rich metadata.</p>
<h3>Philosophy</h3>
<blockquote>
<p>"The soup is infinite." - Objects swim in a queryable sea of metadata.</p>
</blockquote>
<p>The Soup inverts the traditional filesystem model:</p>
<ul>
<li>Filesystem: Navigate hierarchy to find objects</li>
<li>Soup: Query attributes to discover objects</li>
</ul>
<h3>Object Enumeration</h3>
<pre class="language-scheme">
(define (soup)
  "List all objects in the vault with metadata"
  (append
    (soup-releases)      ; Signed releases
    (soup-archives)      ; Sealed archives
    (soup-keys)          ; Cryptographic keys
    (soup-audit-entries) ; Audit trail
    (soup-commits)))     ; Recent commits
</pre>
<h3>Rich Metadata</h3>
<p>Every object carries crypto metadata - the ciphers, hashes, and keys involved:</p>
<pre class="language-scheme">
;; Archive object
(soup-object
  (name "1.0.0")
  (type archive)
  (size "1.2MB")
  (crypto (zstd sha256 "fe378a78...")))

;; Key object
(soup-object
  (name "vault-signing")
  (type key)
  (size "64B")
  (crypto (ed25519/256 public sign
           "sha256:a1b2c3d4..."    ; fingerprint
           "id:ddp@eludom.net"     ; identity
           "2026-01-07")))         ; creation date

;; Release object
(soup-object
  (name "0.1.0")
  (type release)
  (size "313B")
  (crypto (ed25519 sha512 "abc123...")))
</pre>
<h3>Querying the Soup</h3>
<pre class="language-scheme">
;; Find all signed objects
(soup-query type: 'release)

;; Find objects using specific algorithm
(soup-query crypto: 'ed25519)

;; Find objects by size range
(soup-query min-size: 1000 max-size: 100000)

;; Find objects by content hash prefix
(soup-query hash-prefix: "fe378")
</pre>
<h3>Display Format</h3>
<p>The soup displays as a compact, human-readable listing:</p>
<pre>
$ seal-soup
vault-signing, 64B, ed25519/256, public, sign, sha256:a1b2c3d4...
0.1.0, 313B, signed, ed25519, sha512
1.0.0, 1.2MB, zstd, sha256, fe378a78...
audit/1, sealed, 2026-01-07T10:30:00Z
</pre>
<h3>Soup as Index</h3>
<p>The Soup can be serialized as a content-addressed index:</p>
<pre class="language-scheme">
(define (soup-snapshot)
  "Create content-addressed snapshot of current soup"
  (let* ((entries (soup))
         (serialized (serialize entries))
         (hash (cas-put serialized)))
    (ref-set "soup/HEAD" hash)
    hash))
</pre>
<p>This enables: - Time travel: Load historical soup snapshots - Replication: Sync soup indexes between vaults - Verification: Prove soup state at a point in time</p>
</section>
<section>
<h2>Integration with Library of Cyberspace</h2>
<h3>Vault Integration</h3>
<p>The Vault (Memo-006) uses content addressing internally via Git:</p>
<pre class="language-scheme">
;; Git objects ARE content-addressed
(define (git-hash-object content)
  (sha1 (string-append "blob " (number-&gt;string (blob-length content)) "\x00" content)))
</pre>
<p>CAS extends this with SHA-256 and Library-specific semantics.</p>
<h3>Archive Storage</h3>
<p>Sealed archives (Memo-018) can be stored by content address:</p>
<pre class="language-scheme">
(define (archive-to-cas archive-path)
  (let* ((content (read-blob archive-path))
         (hash (cas-put content)))
    (ref-set (string-append "archives/" (archive-version archive-path)) hash)
    hash))
</pre>
<h3>Replication</h3>
<p>Content addressing enables efficient replication (Memo-0002):</p>
<pre class="language-scheme">
;; Only transfer objects receiver doesn't have
(define (replicate-to remote root-hash)
  (for-each
    (lambda (hash)
      (unless (remote-has? remote hash)
        (remote-put remote hash (cas-get hash))))
    (trace-reachable root-hash)))
</pre>
<h3>SPKI Integration</h3>
<p>Content hashes can be Simple Public Key Infrastructure (SPKI) authorization subjects (Memo-004):</p>
<pre class="language-scheme">
;; Grant permission to specific content
(spki-cert
  (issuer publisher-key)
  (subject (hash sha256 "abc123..."))
  (permission read)
  (validity (not-after "2027-01-01")))
</pre>
</section>
<section>
<h2>Chunking for Large Objects</h2>
<p>Large files are split into chunks for:</p>
<ul>
<li>Deduplication at sub-file granularity</li>
<li>Parallel transfer</li>
<li>Incremental updates</li>
</ul>
<p>Chunking trades storage metadata overhead for dramatic improvements in network efficiency and deduplication across related files.</p>
<h3>Fixed-Size Chunking</h3>
<pre class="language-scheme">
(define chunk-size (* 64 1024))  ; 64KB

(define (chunk-fixed data)
  (let loop ((offset 0) (chunks '()))
    (if (&gt;= offset (blob-length data))
        (reverse chunks)
        (loop (+ offset chunk-size)
              (cons (blob-copy data offset (min chunk-size (- (blob-length data) offset)))
                    chunks)))))
</pre>
<h3>Content-Defined Chunking (Rabin fingerprinting)</h3>
<pre class="language-scheme">
;; Chunk boundaries determined by content
;; Survives insertions/deletions better than fixed-size
(define (chunk-rabin data)
  (let ((window-size 48)
        (min-chunk 2048)
        (max-chunk 65536)
        (mask #x0fff))  ; Average 4KB chunks
    ...))
</pre>
<h3>Chunk Tree</h3>
<pre class="language-scheme">
(cas-chunked
  (hash "sha256:...")      ; Root hash
  (size 10485760)          ; 10MB original
  (chunks
    ("sha256:aaa..." 65536)
    ("sha256:bbb..." 65536)
    ("sha256:ccc..." 32768)
    ...))
</pre>
</section>
<section>
<h2>Introspection</h2>
<p>The Library is fully introspective: it stores, addresses, and reasons about itself.</p>
<h3>Self-Hosting</h3>
<p>The system contains its own description:</p>
<pre class="language-scheme">
;; The RFCs are in the CAS
(cas-get (ref-get "rfc/020"))  ; =&gt; This document

;; The code is in the CAS
(cas-get (ref-get "src/vault.scm"))  ; =&gt; Implementation

;; The schema is in the CAS
(cas-get (ref-get "schema/soup-object"))  ; =&gt; Soup object definition
</pre>
<h3>Meta-Objects</h3>
<p>Objects that describe objects:</p>
<pre class="language-scheme">
;; Schema for soup objects (itself a soup object)
(soup-object
  (name "schema/soup-object")
  (type schema)
  (size "412B")
  (crypto (sha256 "def456..."))
  (describes soup-object))

;; The soup can enumerate itself
(soup-query type: 'schema)  ; =&gt; All schemas including this one
</pre>
<h3>Reflexive Queries</h3>
<p>The soup answers questions about itself:</p>
<pre class="language-scheme">
;; What types exist?
(soup-types)  ; =&gt; (archive release key audit commit schema ...)

;; What crypto algorithms are in use?
(soup-algorithms)  ; =&gt; (sha256 ed25519 zstd age ...)

;; What is the total size of the vault?
(soup-total-size)  ; =&gt; 47.3MB

;; How much deduplication?
(soup-dedup-ratio)  ; =&gt; 0.73 (27% space saved)
</pre>
<h3>Provenance</h3>
<p>Every object knows its origin:</p>
<pre class="language-scheme">
(soup-object
  (name "memo-020.ps")
  (type blob)
  (size "89KB")
  (crypto (sha256 "abc123..."))
  (provenance
    (created-by "ddp@eludom.net")
    (created-at 1767700000)
    (derived-from "sha256:fff888...")
    (tool "dvips")))
</pre>
<p>Provenance chains are themselves content-addressed:</p>
<pre class="language-scheme">
;; Trace full history
(define (provenance-chain hash)
  (let ((obj (soup-get hash)))
    (if (soup-object-derived-from obj)
        (cons obj (provenance-chain (soup-object-derived-from obj)))
        (list obj))))
</pre>
<h3>Audit of Audits</h3>
<p>The audit trail audits itself:</p>
<pre class="language-scheme">
;; Audit entry for an audit entry
(audit-entry
  (id 42)
  (actor vault-key)
  (action (audit-append 41))  ; Recorded adding entry 41
  (timestamp 1767700100))

;; The audit trail is in the soup
(soup-query type: 'audit)  ; =&gt; All audit entries as soup objects
</pre>
<h3>Bootstrapping</h3>
<p>The system can describe how to build itself:</p>
<pre class="language-scheme">
;; Bootstrap manifest - everything needed to reconstruct
(bootstrap-manifest
  (hash "sha256:bootstrap...")
  (contents
    (("src/" tree "sha256:src...")
     ("rfcs/" tree "sha256:rfcs...")
     ("keys/" tree "sha256:keys...")
     ("schema/" tree "sha256:schema...")))
  (build-instructions
    "Load src/boot.scm, call (bootstrap)"))

;; Verify bootstrap integrity
(define (verify-bootstrap)
  (let ((manifest (cas-get (ref-get "bootstrap"))))
    (for-each verify-tree (manifest-contents manifest))))
</pre>
<h3>The Library Contains Itself</h3>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 440 220" width="440" height="220" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<line x1="5" y1="10" x2="10" y2="10"/>
<line x1="5" y1="10" x2="5" y2="20"/>
<line x1="10" y1="10" x2="20" y2="10"/>
<line x1="20" y1="10" x2="30" y2="10"/>
<line x1="30" y1="10" x2="40" y2="10"/>
<line x1="40" y1="10" x2="50" y2="10"/>
<line x1="50" y1="10" x2="60" y2="10"/>
<line x1="60" y1="10" x2="70" y2="10"/>
<line x1="70" y1="10" x2="80" y2="10"/>
<line x1="80" y1="10" x2="90" y2="10"/>
<line x1="90" y1="10" x2="100" y2="10"/>
<line x1="100" y1="10" x2="110" y2="10"/>
<line x1="110" y1="10" x2="120" y2="10"/>
<line x1="120" y1="10" x2="130" y2="10"/>
<line x1="130" y1="10" x2="140" y2="10"/>
<line x1="140" y1="10" x2="150" y2="10"/>
<line x1="150" y1="10" x2="160" y2="10"/>
<line x1="160" y1="10" x2="170" y2="10"/>
<line x1="170" y1="10" x2="180" y2="10"/>
<line x1="180" y1="10" x2="190" y2="10"/>
<line x1="190" y1="10" x2="200" y2="10"/>
<line x1="200" y1="10" x2="210" y2="10"/>
<line x1="210" y1="10" x2="220" y2="10"/>
<line x1="220" y1="10" x2="230" y2="10"/>
<line x1="230" y1="10" x2="240" y2="10"/>
<line x1="240" y1="10" x2="250" y2="10"/>
<line x1="250" y1="10" x2="260" y2="10"/>
<line x1="260" y1="10" x2="270" y2="10"/>
<line x1="270" y1="10" x2="280" y2="10"/>
<line x1="280" y1="10" x2="290" y2="10"/>
<line x1="290" y1="10" x2="300" y2="10"/>
<line x1="300" y1="10" x2="310" y2="10"/>
<line x1="310" y1="10" x2="320" y2="10"/>
<line x1="320" y1="10" x2="330" y2="10"/>
<line x1="330" y1="10" x2="340" y2="10"/>
<line x1="340" y1="10" x2="350" y2="10"/>
<line x1="350" y1="10" x2="360" y2="10"/>
<line x1="360" y1="10" x2="370" y2="10"/>
<line x1="370" y1="10" x2="380" y2="10"/>
<line x1="380" y1="10" x2="390" y2="10"/>
<line x1="390" y1="10" x2="400" y2="10"/>
<line x1="400" y1="10" x2="410" y2="10"/>
<line x1="410" y1="10" x2="420" y2="10"/>
<line x1="420" y1="10" x2="425" y2="10"/>
<line x1="425" y1="10" x2="425" y2="20"/>
<line x1="5" y1="20" x2="5" y2="40"/>
<text x="135" y="30">L</text>
<text x="145" y="30">I</text>
<text x="155" y="30">B</text>
<text x="165" y="30">R</text>
<text x="175" y="30">A</text>
<text x="185" y="30">R</text>
<text x="195" y="30">Y</text>
<text x="215" y="30">O</text>
<text x="225" y="30">F</text>
<text x="245" y="30">C</text>
<text x="255" y="30">Y</text>
<text x="265" y="30">B</text>
<text x="275" y="30">E</text>
<text x="285" y="30">R</text>
<text x="295" y="30">S</text>
<text x="305" y="30">P</text>
<text x="315" y="30">A</text>
<text x="325" y="30">C</text>
<text x="335" y="30">E</text>
<line x1="425" y1="20" x2="425" y2="40"/>
<line x1="5" y1="40" x2="5" y2="60"/>
<line x1="35" y1="50" x2="40" y2="50"/>
<line x1="35" y1="50" x2="35" y2="60"/>
<line x1="40" y1="50" x2="50" y2="50"/>
<line x1="50" y1="50" x2="60" y2="50"/>
<line x1="60" y1="50" x2="70" y2="50"/>
<line x1="70" y1="50" x2="80" y2="50"/>
<line x1="80" y1="50" x2="90" y2="50"/>
<line x1="90" y1="50" x2="100" y2="50"/>
<line x1="100" y1="50" x2="110" y2="50"/>
<line x1="110" y1="50" x2="120" y2="50"/>
<line x1="120" y1="50" x2="130" y2="50"/>
<line x1="130" y1="50" x2="140" y2="50"/>
<line x1="140" y1="50" x2="150" y2="50"/>
<line x1="150" y1="50" x2="160" y2="50"/>
<line x1="160" y1="50" x2="170" y2="50"/>
<line x1="170" y1="50" x2="180" y2="50"/>
<line x1="180" y1="50" x2="190" y2="50"/>
<line x1="190" y1="50" x2="200" y2="50"/>
<line x1="200" y1="50" x2="210" y2="50"/>
<line x1="210" y1="50" x2="220" y2="50"/>
<line x1="220" y1="50" x2="230" y2="50"/>
<line x1="230" y1="50" x2="240" y2="50"/>
<line x1="240" y1="50" x2="250" y2="50"/>
<line x1="250" y1="50" x2="260" y2="50"/>
<line x1="260" y1="50" x2="270" y2="50"/>
<line x1="270" y1="50" x2="280" y2="50"/>
<line x1="280" y1="50" x2="290" y2="50"/>
<line x1="290" y1="50" x2="300" y2="50"/>
<line x1="300" y1="50" x2="310" y2="50"/>
<line x1="310" y1="50" x2="320" y2="50"/>
<line x1="320" y1="50" x2="330" y2="50"/>
<line x1="330" y1="50" x2="340" y2="50"/>
<line x1="340" y1="50" x2="350" y2="50"/>
<line x1="350" y1="50" x2="360" y2="50"/>
<line x1="360" y1="50" x2="370" y2="50"/>
<line x1="370" y1="50" x2="380" y2="50"/>
<line x1="380" y1="50" x2="390" y2="50"/>
<line x1="390" y1="50" x2="395" y2="50"/>
<line x1="395" y1="50" x2="395" y2="60"/>
<line x1="425" y1="40" x2="425" y2="60"/>
<line x1="5" y1="60" x2="5" y2="80"/>
<line x1="35" y1="60" x2="35" y2="80"/>
<text x="95" y="70">C</text>
<text x="105" y="70">o</text>
<text x="115" y="70">n</text>
<text x="125" y="70">t</text>
<text x="135" y="70">e</text>
<text x="145" y="70">n</text>
<text x="155" y="70">t</text>
<text x="165" y="70">-</text>
<text x="175" y="70">A</text>
<text x="185" y="70">d</text>
<text x="195" y="70">d</text>
<text x="205" y="70">r</text>
<text x="215" y="70">e</text>
<text x="225" y="70">s</text>
<text x="235" y="70">s</text>
<text x="245" y="70">e</text>
<text x="255" y="70">d</text>
<text x="275" y="70">S</text>
<text x="285" y="70">t</text>
<text x="295" y="70">o</text>
<text x="305" y="70">r</text>
<text x="315" y="70">a</text>
<text x="325" y="70">g</text>
<text x="335" y="70">e</text>
<line x1="395" y1="60" x2="395" y2="80"/>
<line x1="425" y1="60" x2="425" y2="80"/>
<line x1="5" y1="80" x2="5" y2="100"/>
<line x1="35" y1="80" x2="35" y2="100"/>
<line x1="65" y1="90" x2="70" y2="90"/>
<line x1="65" y1="90" x2="65" y2="100"/>
<line x1="70" y1="90" x2="80" y2="90"/>
<line x1="80" y1="90" x2="90" y2="90"/>
<line x1="90" y1="90" x2="100" y2="90"/>
<line x1="100" y1="90" x2="110" y2="90"/>
<line x1="110" y1="90" x2="120" y2="90"/>
<line x1="120" y1="90" x2="130" y2="90"/>
<line x1="130" y1="90" x2="140" y2="90"/>
<line x1="140" y1="90" x2="150" y2="90"/>
<line x1="150" y1="90" x2="160" y2="90"/>
<line x1="160" y1="90" x2="170" y2="90"/>
<line x1="170" y1="90" x2="180" y2="90"/>
<line x1="180" y1="90" x2="190" y2="90"/>
<line x1="190" y1="90" x2="200" y2="90"/>
<line x1="200" y1="90" x2="210" y2="90"/>
<line x1="210" y1="90" x2="220" y2="90"/>
<line x1="220" y1="90" x2="230" y2="90"/>
<line x1="230" y1="90" x2="240" y2="90"/>
<line x1="240" y1="90" x2="250" y2="90"/>
<line x1="250" y1="90" x2="260" y2="90"/>
<line x1="260" y1="90" x2="270" y2="90"/>
<line x1="270" y1="90" x2="280" y2="90"/>
<line x1="280" y1="90" x2="290" y2="90"/>
<line x1="290" y1="90" x2="300" y2="90"/>
<line x1="300" y1="90" x2="310" y2="90"/>
<line x1="310" y1="90" x2="320" y2="90"/>
<line x1="320" y1="90" x2="330" y2="90"/>
<line x1="330" y1="90" x2="340" y2="90"/>
<line x1="340" y1="90" x2="350" y2="90"/>
<line x1="350" y1="90" x2="360" y2="90"/>
<line x1="360" y1="90" x2="365" y2="90"/>
<line x1="365" y1="90" x2="365" y2="100"/>
<line x1="395" y1="80" x2="395" y2="100"/>
<line x1="425" y1="80" x2="425" y2="100"/>
<line x1="5" y1="100" x2="5" y2="120"/>
<line x1="35" y1="100" x2="35" y2="120"/>
<line x1="65" y1="100" x2="65" y2="120"/>
<text x="115" y="110">M</text>
<text x="125" y="110">e</text>
<text x="135" y="110">m</text>
<text x="145" y="110">o</text>
<text x="155" y="110">-</text>
<text x="165" y="110">0</text>
<text x="175" y="110">2</text>
<text x="185" y="110">0</text>
<text x="205" y="110">(</text>
<text x="215" y="110">t</text>
<text x="225" y="110">h</text>
<text x="235" y="110">i</text>
<text x="245" y="110">s</text>
<text x="265" y="110">d</text>
<text x="275" y="110">o</text>
<text x="285" y="110">c</text>
<text x="295" y="110">u</text>
<text x="305" y="110">m</text>
<text x="315" y="110">e</text>
<text x="325" y="110">n</text>
<text x="335" y="110">t</text>
<text x="345" y="110">)</text>
<line x1="375" y1="100" x2="375" y2="120"/>
<line x1="405" y1="100" x2="405" y2="120"/>
<line x1="435" y1="100" x2="435" y2="120"/>
<line x1="5" y1="120" x2="5" y2="140"/>
<line x1="35" y1="120" x2="35" y2="140"/>
<line x1="65" y1="120" x2="65" y2="140"/>
<text x="115" y="130">d</text>
<text x="125" y="130">e</text>
<text x="135" y="130">s</text>
<text x="145" y="130">c</text>
<text x="155" y="130">r</text>
<text x="165" y="130">i</text>
<text x="175" y="130">b</text>
<text x="185" y="130">i</text>
<text x="195" y="130">n</text>
<text x="205" y="130">g</text>
<text x="225" y="130">C</text>
<text x="235" y="130">A</text>
<text x="245" y="130">S</text>
<line x1="365" y1="120" x2="365" y2="140"/>
<line x1="395" y1="120" x2="395" y2="140"/>
<line x1="425" y1="120" x2="425" y2="140"/>
<line x1="5" y1="140" x2="5" y2="160"/>
<line x1="35" y1="140" x2="35" y2="160"/>
<line x1="65" y1="140" x2="65" y2="160"/>
<text x="115" y="150">s</text>
<text x="125" y="150">t</text>
<text x="135" y="150">o</text>
<text x="145" y="150">r</text>
<text x="155" y="150">e</text>
<text x="165" y="150">d</text>
<text x="185" y="150">i</text>
<text x="195" y="150">n</text>
<text x="215" y="150">C</text>
<text x="225" y="150">A</text>
<text x="235" y="150">S</text>
<line x1="365" y1="140" x2="365" y2="160"/>
<line x1="395" y1="140" x2="395" y2="160"/>
<line x1="425" y1="140" x2="425" y2="160"/>
<line x1="5" y1="160" x2="5" y2="180"/>
<line x1="35" y1="160" x2="35" y2="180"/>
<line x1="65" y1="170" x2="70" y2="170"/>
<line x1="65" y1="160" x2="65" y2="170"/>
<line x1="70" y1="170" x2="80" y2="170"/>
<line x1="80" y1="170" x2="90" y2="170"/>
<line x1="90" y1="170" x2="100" y2="170"/>
<line x1="100" y1="170" x2="110" y2="170"/>
<line x1="110" y1="170" x2="120" y2="170"/>
<line x1="120" y1="170" x2="130" y2="170"/>
<line x1="130" y1="170" x2="140" y2="170"/>
<line x1="140" y1="170" x2="150" y2="170"/>
<line x1="150" y1="170" x2="160" y2="170"/>
<line x1="160" y1="170" x2="170" y2="170"/>
<line x1="170" y1="170" x2="180" y2="170"/>
<line x1="180" y1="170" x2="190" y2="170"/>
<line x1="190" y1="170" x2="200" y2="170"/>
<line x1="200" y1="170" x2="210" y2="170"/>
<line x1="210" y1="170" x2="220" y2="170"/>
<line x1="220" y1="170" x2="230" y2="170"/>
<line x1="230" y1="170" x2="240" y2="170"/>
<line x1="240" y1="170" x2="250" y2="170"/>
<line x1="250" y1="170" x2="260" y2="170"/>
<line x1="260" y1="170" x2="270" y2="170"/>
<line x1="270" y1="170" x2="280" y2="170"/>
<line x1="280" y1="170" x2="290" y2="170"/>
<line x1="290" y1="170" x2="300" y2="170"/>
<line x1="300" y1="170" x2="310" y2="170"/>
<line x1="310" y1="170" x2="320" y2="170"/>
<line x1="320" y1="170" x2="330" y2="170"/>
<line x1="330" y1="170" x2="340" y2="170"/>
<line x1="340" y1="170" x2="350" y2="170"/>
<line x1="350" y1="170" x2="360" y2="170"/>
<line x1="360" y1="170" x2="365" y2="170"/>
<line x1="365" y1="160" x2="365" y2="170"/>
<line x1="395" y1="160" x2="395" y2="180"/>
<line x1="425" y1="160" x2="425" y2="180"/>
<line x1="5" y1="180" x2="5" y2="200"/>
<line x1="35" y1="190" x2="40" y2="190"/>
<line x1="35" y1="180" x2="35" y2="190"/>
<line x1="40" y1="190" x2="50" y2="190"/>
<line x1="50" y1="190" x2="60" y2="190"/>
<line x1="60" y1="190" x2="70" y2="190"/>
<line x1="70" y1="190" x2="80" y2="190"/>
<line x1="80" y1="190" x2="90" y2="190"/>
<line x1="90" y1="190" x2="100" y2="190"/>
<line x1="100" y1="190" x2="110" y2="190"/>
<line x1="110" y1="190" x2="120" y2="190"/>
<line x1="120" y1="190" x2="130" y2="190"/>
<line x1="130" y1="190" x2="140" y2="190"/>
<line x1="140" y1="190" x2="150" y2="190"/>
<line x1="150" y1="190" x2="160" y2="190"/>
<line x1="160" y1="190" x2="170" y2="190"/>
<line x1="170" y1="190" x2="180" y2="190"/>
<line x1="180" y1="190" x2="190" y2="190"/>
<line x1="190" y1="190" x2="200" y2="190"/>
<line x1="200" y1="190" x2="210" y2="190"/>
<line x1="210" y1="190" x2="220" y2="190"/>
<line x1="220" y1="190" x2="230" y2="190"/>
<line x1="230" y1="190" x2="240" y2="190"/>
<line x1="240" y1="190" x2="250" y2="190"/>
<line x1="250" y1="190" x2="260" y2="190"/>
<line x1="260" y1="190" x2="270" y2="190"/>
<line x1="270" y1="190" x2="280" y2="190"/>
<line x1="280" y1="190" x2="290" y2="190"/>
<line x1="290" y1="190" x2="300" y2="190"/>
<line x1="300" y1="190" x2="310" y2="190"/>
<line x1="310" y1="190" x2="320" y2="190"/>
<line x1="320" y1="190" x2="330" y2="190"/>
<line x1="330" y1="190" x2="340" y2="190"/>
<line x1="340" y1="190" x2="350" y2="190"/>
<line x1="350" y1="190" x2="360" y2="190"/>
<line x1="360" y1="190" x2="370" y2="190"/>
<line x1="370" y1="190" x2="380" y2="190"/>
<line x1="380" y1="190" x2="390" y2="190"/>
<line x1="390" y1="190" x2="395" y2="190"/>
<line x1="395" y1="180" x2="395" y2="190"/>
<line x1="425" y1="180" x2="425" y2="200"/>
<line x1="5" y1="210" x2="10" y2="210"/>
<line x1="5" y1="200" x2="5" y2="210"/>
<line x1="10" y1="210" x2="20" y2="210"/>
<line x1="20" y1="210" x2="30" y2="210"/>
<line x1="30" y1="210" x2="40" y2="210"/>
<line x1="40" y1="210" x2="50" y2="210"/>
<line x1="50" y1="210" x2="60" y2="210"/>
<line x1="60" y1="210" x2="70" y2="210"/>
<line x1="70" y1="210" x2="80" y2="210"/>
<line x1="80" y1="210" x2="90" y2="210"/>
<line x1="90" y1="210" x2="100" y2="210"/>
<line x1="100" y1="210" x2="110" y2="210"/>
<line x1="110" y1="210" x2="120" y2="210"/>
<line x1="120" y1="210" x2="130" y2="210"/>
<line x1="130" y1="210" x2="140" y2="210"/>
<line x1="140" y1="210" x2="150" y2="210"/>
<line x1="150" y1="210" x2="160" y2="210"/>
<line x1="160" y1="210" x2="170" y2="210"/>
<line x1="170" y1="210" x2="180" y2="210"/>
<line x1="180" y1="210" x2="190" y2="210"/>
<line x1="190" y1="210" x2="200" y2="210"/>
<line x1="200" y1="210" x2="210" y2="210"/>
<line x1="210" y1="210" x2="220" y2="210"/>
<line x1="220" y1="210" x2="230" y2="210"/>
<line x1="230" y1="210" x2="240" y2="210"/>
<line x1="240" y1="210" x2="250" y2="210"/>
<line x1="250" y1="210" x2="260" y2="210"/>
<line x1="260" y1="210" x2="270" y2="210"/>
<line x1="270" y1="210" x2="280" y2="210"/>
<line x1="280" y1="210" x2="290" y2="210"/>
<line x1="290" y1="210" x2="300" y2="210"/>
<line x1="300" y1="210" x2="310" y2="210"/>
<line x1="310" y1="210" x2="320" y2="210"/>
<line x1="320" y1="210" x2="330" y2="210"/>
<line x1="330" y1="210" x2="340" y2="210"/>
<line x1="340" y1="210" x2="350" y2="210"/>
<line x1="350" y1="210" x2="360" y2="210"/>
<line x1="360" y1="210" x2="370" y2="210"/>
<line x1="370" y1="210" x2="380" y2="210"/>
<line x1="380" y1="210" x2="390" y2="210"/>
<line x1="390" y1="210" x2="400" y2="210"/>
<line x1="400" y1="210" x2="410" y2="210"/>
<line x1="410" y1="210" x2="420" y2="210"/>
<line x1="420" y1="210" x2="425" y2="210"/>
<line x1="425" y1="200" x2="425" y2="210"/>
</svg>
</div>
<p>Homoiconic storage: the description is the thing.</p>
</section>
<section>
<h2>Tombstones</h2>
<p>Objects are never truly deleted - they are marked with tombstones.</p>
<h3>Soft Deletion</h3>
<pre class="language-scheme">
(define (cas-tombstone hash #!key reason actor)
  "Mark object as deleted without removing it"
  (let ((tombstone
         (tombstone
           (object ,hash)
           (deleted-at ,(current-seconds))
           (deleted-by ,actor)
           (reason ,reason))))
    (audit-append action: (tombstone ,hash) motivation: reason)
    (cas-put (serialize tombstone))))
</pre>
<h3>Tombstone Properties</h3>
<pre class="language-scheme">
(soup-object
  (name "sha256:deadbeef...")
  (type tombstone)
  (size "0B")  ; Logical size is zero
  (status deleted)
  (reason "Superseded by sha256:newversion...")
  (recoverable #t))
</pre>
<h3>Recovery</h3>
<pre class="language-scheme">
(define (cas-resurrect hash)
  "Remove tombstone, restore object visibility"
  (let ((tombstone (find-tombstone hash)))
    (when tombstone
      (audit-append action: `(resurrect ,hash))
      (cas-delete (tombstone-hash tombstone)))))
</pre>
<h3>Garbage Collection with Tombstones</h3>
<pre class="language-scheme">
(define (cas-gc roots #!key preserve-tombstones)
  "GC respects tombstones by default"
  (let ((reachable (trace-reachable roots))
        (tombstoned (all-tombstoned-hashes)))
    (for-each
      (lambda (hash)
        (unless (or (set-member? reachable hash)
                    (and preserve-tombstones
                         (set-member? tombstoned hash)))
          (delete-file (hash-&gt;path hash))))
      (all-objects))))
</pre>
</section>
<section>
<h2>Pinning</h2>
<p>Pinned objects are protected from garbage collection.</p>
<h3>Pin Operations</h3>
<pre class="language-scheme">
(define (cas-pin hash #!key recursive reason)
  "Pin object (and optionally its references)"
  (let ((pin `(pin
               (object ,hash)
               (pinned-at ,(current-seconds))
               (recursive ,recursive)
               (reason ,reason))))
    (write-file (pin-path hash) (serialize pin))
    (when recursive
      (for-each (lambda (ref) (cas-pin ref recursive: #t))
                (object-references hash)))))

(define (cas-unpin hash)
  "Remove pin, allow GC"
  (delete-file (pin-path hash)))

(define (cas-pinned? hash)
  "Check if object is pinned"
  (file-exists? (pin-path hash)))
</pre>
<h3>Pin Manifest</h3>
<pre class="language-scheme">
;; All pins as soup objects
(soup-query type: 'pin)

;; Pin statistics
(soup-pin-count)      ; =&gt; 142 objects pinned
(soup-pinned-size)    ; =&gt; 23.4MB
</pre>
<h3>Root Pins</h3>
<p>Certain objects are implicitly pinned:</p>
<pre class="language-scheme">
(define implicit-roots
  '("HEAD"           ; Current commit
    "refs/tags/"    ; All tags
    "bootstrap"      ; System bootstrap
    "schema/"))     ; All schemas
</pre>
</section>
<section>
<h2>Bloom Filters</h2>
<p>Compact probabilistic set membership for efficient replication.</p>
<h3>Multi-Level Existence Check</h3>
<p>For the distributed soup, existence checks dominate replication overhead. A tiered approach minimizes latency:</p>
<div class="diagram-container">
<svg class="diagram" viewBox="0 0 590 200" width="590" height="200" xmlns="http://www.w3.org/2000/svg">
<style>
  .diagram line { stroke: currentColor; stroke-width: 1.5; stroke-linecap: square; }
  .diagram rect { fill: currentColor; }
  .diagram text { font-family: monospace; font-size: 14px; fill: currentColor; text-anchor: middle; dominant-baseline: central; }
</style>
<line x1="5" y1="10" x2="10" y2="10"/>
<line x1="5" y1="10" x2="5" y2="20"/>
<line x1="10" y1="10" x2="20" y2="10"/>
<line x1="20" y1="10" x2="30" y2="10"/>
<line x1="30" y1="10" x2="40" y2="10"/>
<line x1="40" y1="10" x2="50" y2="10"/>
<line x1="50" y1="10" x2="60" y2="10"/>
<line x1="60" y1="10" x2="70" y2="10"/>
<line x1="70" y1="10" x2="80" y2="10"/>
<line x1="80" y1="10" x2="90" y2="10"/>
<line x1="90" y1="10" x2="100" y2="10"/>
<line x1="100" y1="10" x2="110" y2="10"/>
<line x1="110" y1="10" x2="120" y2="10"/>
<line x1="120" y1="10" x2="130" y2="10"/>
<line x1="130" y1="10" x2="140" y2="10"/>
<line x1="140" y1="10" x2="150" y2="10"/>
<line x1="150" y1="10" x2="160" y2="10"/>
<line x1="160" y1="10" x2="170" y2="10"/>
<line x1="170" y1="10" x2="180" y2="10"/>
<line x1="180" y1="10" x2="190" y2="10"/>
<line x1="190" y1="10" x2="200" y2="10"/>
<line x1="200" y1="10" x2="210" y2="10"/>
<line x1="210" y1="10" x2="220" y2="10"/>
<line x1="220" y1="10" x2="230" y2="10"/>
<line x1="230" y1="10" x2="240" y2="10"/>
<line x1="240" y1="10" x2="250" y2="10"/>
<line x1="250" y1="10" x2="260" y2="10"/>
<line x1="260" y1="10" x2="270" y2="10"/>
<line x1="270" y1="10" x2="280" y2="10"/>
<line x1="280" y1="10" x2="290" y2="10"/>
<line x1="290" y1="10" x2="300" y2="10"/>
<line x1="300" y1="10" x2="310" y2="10"/>
<line x1="310" y1="10" x2="320" y2="10"/>
<line x1="320" y1="10" x2="330" y2="10"/>
<line x1="330" y1="10" x2="340" y2="10"/>
<line x1="340" y1="10" x2="350" y2="10"/>
<line x1="350" y1="10" x2="360" y2="10"/>
<line x1="360" y1="10" x2="370" y2="10"/>
<line x1="370" y1="10" x2="380" y2="10"/>
<line x1="380" y1="10" x2="390" y2="10"/>
<line x1="390" y1="10" x2="400" y2="10"/>
<line x1="400" y1="10" x2="410" y2="10"/>
<line x1="410" y1="10" x2="420" y2="10"/>
<line x1="420" y1="10" x2="430" y2="10"/>
<line x1="430" y1="10" x2="440" y2="10"/>
<line x1="440" y1="10" x2="450" y2="10"/>
<line x1="450" y1="10" x2="460" y2="10"/>
<line x1="460" y1="10" x2="470" y2="10"/>
<line x1="470" y1="10" x2="480" y2="10"/>
<line x1="480" y1="10" x2="490" y2="10"/>
<line x1="490" y1="10" x2="500" y2="10"/>
<line x1="500" y1="10" x2="510" y2="10"/>
<line x1="510" y1="10" x2="520" y2="10"/>
<line x1="520" y1="10" x2="530" y2="10"/>
<line x1="530" y1="10" x2="540" y2="10"/>
<line x1="540" y1="10" x2="550" y2="10"/>
<line x1="550" y1="10" x2="560" y2="10"/>
<line x1="560" y1="10" x2="570" y2="10"/>
<line x1="570" y1="10" x2="580" y2="10"/>
<line x1="580" y1="10" x2="585" y2="10"/>
<line x1="585" y1="10" x2="585" y2="20"/>
<line x1="5" y1="20" x2="5" y2="40"/>
<text x="25" y="30">L</text>
<text x="35" y="30">1</text>
<text x="45" y="30">:</text>
<text x="65" y="30">H</text>
<text x="75" y="30">o</text>
<text x="85" y="30">t</text>
<text x="105" y="30">S</text>
<text x="115" y="30">e</text>
<text x="125" y="30">t</text>
<text x="145" y="30">C</text>
<text x="155" y="30">a</text>
<text x="165" y="30">c</text>
<text x="175" y="30">h</text>
<text x="185" y="30">e</text>
<text x="205" y="30">(</text>
<text x="215" y="30">1</text>
<text x="225" y="30">0</text>
<text x="235" y="30">0</text>
<text x="245" y="30">0</text>
<text x="265" y="30">i</text>
<text x="275" y="30">t</text>
<text x="285" y="30">e</text>
<text x="295" y="30">m</text>
<text x="305" y="30">s</text>
<text x="315" y="30">,</text>
<text x="335" y="30">O</text>
<text x="345" y="30">(</text>
<text x="355" y="30">1</text>
<text x="365" y="30">)</text>
<text x="375" y="30">,</text>
<text x="395" y="30">m</text>
<text x="405" y="30">i</text>
<text x="415" y="30">c</text>
<text x="425" y="30">r</text>
<text x="435" y="30">o</text>
<text x="445" y="30">s</text>
<text x="455" y="30">e</text>
<text x="465" y="30">c</text>
<text x="475" y="30">o</text>
<text x="485" y="30">n</text>
<text x="495" y="30">d</text>
<text x="505" y="30">s</text>
<text x="515" y="30">)</text>
<line x1="575" y1="20" x2="575" y2="40"/>
<line x1="5" y1="40" x2="5" y2="60"/>
<line x1="5" y1="50" x2="10" y2="50"/>
<line x1="10" y1="50" x2="20" y2="50"/>
<line x1="20" y1="50" x2="30" y2="50"/>
<line x1="30" y1="50" x2="40" y2="50"/>
<line x1="40" y1="50" x2="50" y2="50"/>
<line x1="50" y1="50" x2="60" y2="50"/>
<line x1="60" y1="50" x2="70" y2="50"/>
<line x1="70" y1="50" x2="80" y2="50"/>
<line x1="80" y1="50" x2="90" y2="50"/>
<line x1="90" y1="50" x2="100" y2="50"/>
<line x1="100" y1="50" x2="110" y2="50"/>
<line x1="110" y1="50" x2="120" y2="50"/>
<line x1="120" y1="50" x2="130" y2="50"/>
<line x1="130" y1="50" x2="140" y2="50"/>
<line x1="140" y1="50" x2="150" y2="50"/>
<line x1="150" y1="50" x2="160" y2="50"/>
<line x1="160" y1="50" x2="170" y2="50"/>
<line x1="170" y1="50" x2="180" y2="50"/>
<line x1="180" y1="50" x2="190" y2="50"/>
<line x1="190" y1="50" x2="200" y2="50"/>
<line x1="200" y1="50" x2="210" y2="50"/>
<line x1="210" y1="50" x2="220" y2="50"/>
<line x1="220" y1="50" x2="230" y2="50"/>
<line x1="230" y1="50" x2="240" y2="50"/>
<line x1="240" y1="50" x2="250" y2="50"/>
<line x1="250" y1="50" x2="260" y2="50"/>
<line x1="260" y1="50" x2="270" y2="50"/>
<line x1="270" y1="50" x2="280" y2="50"/>
<line x1="280" y1="50" x2="290" y2="50"/>
<line x1="290" y1="50" x2="300" y2="50"/>
<line x1="300" y1="50" x2="310" y2="50"/>
<line x1="310" y1="50" x2="320" y2="50"/>
<line x1="320" y1="50" x2="330" y2="50"/>
<line x1="330" y1="50" x2="340" y2="50"/>
<line x1="340" y1="50" x2="350" y2="50"/>
<line x1="350" y1="50" x2="360" y2="50"/>
<line x1="360" y1="50" x2="370" y2="50"/>
<line x1="370" y1="50" x2="380" y2="50"/>
<line x1="380" y1="50" x2="390" y2="50"/>
<line x1="390" y1="50" x2="400" y2="50"/>
<line x1="400" y1="50" x2="410" y2="50"/>
<line x1="410" y1="50" x2="420" y2="50"/>
<line x1="420" y1="50" x2="430" y2="50"/>
<line x1="430" y1="50" x2="440" y2="50"/>
<line x1="440" y1="50" x2="450" y2="50"/>
<line x1="450" y1="50" x2="460" y2="50"/>
<line x1="460" y1="50" x2="470" y2="50"/>
<line x1="470" y1="50" x2="480" y2="50"/>
<line x1="480" y1="50" x2="490" y2="50"/>
<line x1="490" y1="50" x2="500" y2="50"/>
<line x1="500" y1="50" x2="510" y2="50"/>
<line x1="510" y1="50" x2="520" y2="50"/>
<line x1="520" y1="50" x2="530" y2="50"/>
<line x1="530" y1="50" x2="540" y2="50"/>
<line x1="540" y1="50" x2="550" y2="50"/>
<line x1="550" y1="50" x2="560" y2="50"/>
<line x1="560" y1="50" x2="570" y2="50"/>
<line x1="570" y1="50" x2="580" y2="50"/>
<line x1="585" y1="40" x2="585" y2="60"/>
<line x1="580" y1="50" x2="585" y2="50"/>
<line x1="5" y1="60" x2="5" y2="80"/>
<text x="25" y="70">L</text>
<text x="35" y="70">2</text>
<text x="45" y="70">:</text>
<text x="65" y="70">B</text>
<text x="75" y="70">l</text>
<text x="85" y="70">o</text>
<text x="95" y="70">c</text>
<text x="105" y="70">k</text>
<text x="115" y="70">e</text>
<text x="125" y="70">d</text>
<text x="145" y="70">B</text>
<text x="155" y="70">l</text>
<text x="165" y="70">o</text>
<text x="175" y="70">o</text>
<text x="185" y="70">m</text>
<text x="205" y="70">F</text>
<text x="215" y="70">i</text>
<text x="225" y="70">l</text>
<text x="235" y="70">t</text>
<text x="245" y="70">e</text>
<text x="255" y="70">r</text>
<text x="275" y="70">(</text>
<text x="285" y="70">1</text>
<text x="295" y="70">0</text>
<text x="305" y="70">0</text>
<text x="315" y="70">K</text>
<text x="335" y="70">i</text>
<text x="345" y="70">t</text>
<text x="355" y="70">e</text>
<text x="365" y="70">m</text>
<text x="375" y="70">s</text>
<text x="385" y="70">,</text>
<text x="405" y="70">O</text>
<text x="415" y="70">(</text>
<text x="425" y="70">k</text>
<text x="435" y="70">)</text>
<text x="445" y="70">,</text>
<text x="465" y="70">c</text>
<text x="475" y="70">a</text>
<text x="485" y="70">c</text>
<text x="495" y="70">h</text>
<text x="505" y="70">e</text>
<text x="515" y="70">-</text>
<line x1="575" y1="60" x2="575" y2="80"/>
<line x1="5" y1="80" x2="5" y2="100"/>
<text x="65" y="90">f</text>
<text x="75" y="90">r</text>
<text x="85" y="90">i</text>
<text x="95" y="90">e</text>
<text x="105" y="90">n</text>
<text x="115" y="90">d</text>
<text x="125" y="90">l</text>
<text x="135" y="90">y</text>
<text x="155" y="90">m</text>
<text x="165" y="90">e</text>
<text x="175" y="90">m</text>
<text x="185" y="90">o</text>
<text x="195" y="90">r</text>
<text x="205" y="90">y</text>
<text x="225" y="90">l</text>
<text x="235" y="90">a</text>
<text x="245" y="90">y</text>
<text x="255" y="90">o</text>
<text x="265" y="90">u</text>
<text x="275" y="90">t</text>
<text x="285" y="90">)</text>
<line x1="585" y1="80" x2="585" y2="100"/>
<line x1="5" y1="100" x2="5" y2="120"/>
<line x1="5" y1="110" x2="10" y2="110"/>
<line x1="10" y1="110" x2="20" y2="110"/>
<line x1="20" y1="110" x2="30" y2="110"/>
<line x1="30" y1="110" x2="40" y2="110"/>
<line x1="40" y1="110" x2="50" y2="110"/>
<line x1="50" y1="110" x2="60" y2="110"/>
<line x1="60" y1="110" x2="70" y2="110"/>
<line x1="70" y1="110" x2="80" y2="110"/>
<line x1="80" y1="110" x2="90" y2="110"/>
<line x1="90" y1="110" x2="100" y2="110"/>
<line x1="100" y1="110" x2="110" y2="110"/>
<line x1="110" y1="110" x2="120" y2="110"/>
<line x1="120" y1="110" x2="130" y2="110"/>
<line x1="130" y1="110" x2="140" y2="110"/>
<line x1="140" y1="110" x2="150" y2="110"/>
<line x1="150" y1="110" x2="160" y2="110"/>
<line x1="160" y1="110" x2="170" y2="110"/>
<line x1="170" y1="110" x2="180" y2="110"/>
<line x1="180" y1="110" x2="190" y2="110"/>
<line x1="190" y1="110" x2="200" y2="110"/>
<line x1="200" y1="110" x2="210" y2="110"/>
<line x1="210" y1="110" x2="220" y2="110"/>
<line x1="220" y1="110" x2="230" y2="110"/>
<line x1="230" y1="110" x2="240" y2="110"/>
<line x1="240" y1="110" x2="250" y2="110"/>
<line x1="250" y1="110" x2="260" y2="110"/>
<line x1="260" y1="110" x2="270" y2="110"/>
<line x1="270" y1="110" x2="280" y2="110"/>
<line x1="280" y1="110" x2="290" y2="110"/>
<line x1="290" y1="110" x2="300" y2="110"/>
<line x1="300" y1="110" x2="310" y2="110"/>
<line x1="310" y1="110" x2="320" y2="110"/>
<line x1="320" y1="110" x2="330" y2="110"/>
<line x1="330" y1="110" x2="340" y2="110"/>
<line x1="340" y1="110" x2="350" y2="110"/>
<line x1="350" y1="110" x2="360" y2="110"/>
<line x1="360" y1="110" x2="370" y2="110"/>
<line x1="370" y1="110" x2="380" y2="110"/>
<line x1="380" y1="110" x2="390" y2="110"/>
<line x1="390" y1="110" x2="400" y2="110"/>
<line x1="400" y1="110" x2="410" y2="110"/>
<line x1="410" y1="110" x2="420" y2="110"/>
<line x1="420" y1="110" x2="430" y2="110"/>
<line x1="430" y1="110" x2="440" y2="110"/>
<line x1="440" y1="110" x2="450" y2="110"/>
<line x1="450" y1="110" x2="460" y2="110"/>
<line x1="460" y1="110" x2="470" y2="110"/>
<line x1="470" y1="110" x2="480" y2="110"/>
<line x1="480" y1="110" x2="490" y2="110"/>
<line x1="490" y1="110" x2="500" y2="110"/>
<line x1="500" y1="110" x2="510" y2="110"/>
<line x1="510" y1="110" x2="520" y2="110"/>
<line x1="520" y1="110" x2="530" y2="110"/>
<line x1="530" y1="110" x2="540" y2="110"/>
<line x1="540" y1="110" x2="550" y2="110"/>
<line x1="550" y1="110" x2="560" y2="110"/>
<line x1="560" y1="110" x2="570" y2="110"/>
<line x1="570" y1="110" x2="580" y2="110"/>
<line x1="585" y1="100" x2="585" y2="120"/>
<line x1="580" y1="110" x2="585" y2="110"/>
<line x1="5" y1="120" x2="5" y2="140"/>
<text x="25" y="130">L</text>
<text x="35" y="130">3</text>
<text x="45" y="130">:</text>
<text x="65" y="130">Q</text>
<text x="75" y="130">u</text>
<text x="85" y="130">o</text>
<text x="95" y="130">t</text>
<text x="105" y="130">i</text>
<text x="115" y="130">e</text>
<text x="125" y="130">n</text>
<text x="135" y="130">t</text>
<text x="155" y="130">F</text>
<text x="165" y="130">i</text>
<text x="175" y="130">l</text>
<text x="185" y="130">t</text>
<text x="195" y="130">e</text>
<text x="205" y="130">r</text>
<text x="225" y="130">(</text>
<text x="235" y="130">1</text>
<text x="245" y="130">M</text>
<text x="265" y="130">i</text>
<text x="275" y="130">t</text>
<text x="285" y="130">e</text>
<text x="295" y="130">m</text>
<text x="305" y="130">s</text>
<text x="315" y="130">,</text>
<text x="335" y="130">s</text>
<text x="345" y="130">u</text>
<text x="355" y="130">p</text>
<text x="365" y="130">p</text>
<text x="375" y="130">o</text>
<text x="385" y="130">r</text>
<text x="395" y="130">t</text>
<text x="405" y="130">s</text>
<text x="425" y="130">d</text>
<text x="435" y="130">e</text>
<text x="445" y="130">l</text>
<text x="455" y="130">e</text>
<text x="465" y="130">t</text>
<text x="475" y="130">i</text>
<text x="485" y="130">o</text>
<text x="495" y="130">n</text>
<text x="505" y="130">)</text>
<line x1="575" y1="120" x2="575" y2="140"/>
<line x1="5" y1="140" x2="5" y2="160"/>
<line x1="5" y1="150" x2="10" y2="150"/>
<line x1="10" y1="150" x2="20" y2="150"/>
<line x1="20" y1="150" x2="30" y2="150"/>
<line x1="30" y1="150" x2="40" y2="150"/>
<line x1="40" y1="150" x2="50" y2="150"/>
<line x1="50" y1="150" x2="60" y2="150"/>
<line x1="60" y1="150" x2="70" y2="150"/>
<line x1="70" y1="150" x2="80" y2="150"/>
<line x1="80" y1="150" x2="90" y2="150"/>
<line x1="90" y1="150" x2="100" y2="150"/>
<line x1="100" y1="150" x2="110" y2="150"/>
<line x1="110" y1="150" x2="120" y2="150"/>
<line x1="120" y1="150" x2="130" y2="150"/>
<line x1="130" y1="150" x2="140" y2="150"/>
<line x1="140" y1="150" x2="150" y2="150"/>
<line x1="150" y1="150" x2="160" y2="150"/>
<line x1="160" y1="150" x2="170" y2="150"/>
<line x1="170" y1="150" x2="180" y2="150"/>
<line x1="180" y1="150" x2="190" y2="150"/>
<line x1="190" y1="150" x2="200" y2="150"/>
<line x1="200" y1="150" x2="210" y2="150"/>
<line x1="210" y1="150" x2="220" y2="150"/>
<line x1="220" y1="150" x2="230" y2="150"/>
<line x1="230" y1="150" x2="240" y2="150"/>
<line x1="240" y1="150" x2="250" y2="150"/>
<line x1="250" y1="150" x2="260" y2="150"/>
<line x1="260" y1="150" x2="270" y2="150"/>
<line x1="270" y1="150" x2="280" y2="150"/>
<line x1="280" y1="150" x2="290" y2="150"/>
<line x1="290" y1="150" x2="300" y2="150"/>
<line x1="300" y1="150" x2="310" y2="150"/>
<line x1="310" y1="150" x2="320" y2="150"/>
<line x1="320" y1="150" x2="330" y2="150"/>
<line x1="330" y1="150" x2="340" y2="150"/>
<line x1="340" y1="150" x2="350" y2="150"/>
<line x1="350" y1="150" x2="360" y2="150"/>
<line x1="360" y1="150" x2="370" y2="150"/>
<line x1="370" y1="150" x2="380" y2="150"/>
<line x1="380" y1="150" x2="390" y2="150"/>
<line x1="390" y1="150" x2="400" y2="150"/>
<line x1="400" y1="150" x2="410" y2="150"/>
<line x1="410" y1="150" x2="420" y2="150"/>
<line x1="420" y1="150" x2="430" y2="150"/>
<line x1="430" y1="150" x2="440" y2="150"/>
<line x1="440" y1="150" x2="450" y2="150"/>
<line x1="450" y1="150" x2="460" y2="150"/>
<line x1="460" y1="150" x2="470" y2="150"/>
<line x1="470" y1="150" x2="480" y2="150"/>
<line x1="480" y1="150" x2="490" y2="150"/>
<line x1="490" y1="150" x2="500" y2="150"/>
<line x1="500" y1="150" x2="510" y2="150"/>
<line x1="510" y1="150" x2="520" y2="150"/>
<line x1="520" y1="150" x2="530" y2="150"/>
<line x1="530" y1="150" x2="540" y2="150"/>
<line x1="540" y1="150" x2="550" y2="150"/>
<line x1="550" y1="150" x2="560" y2="150"/>
<line x1="560" y1="150" x2="570" y2="150"/>
<line x1="570" y1="150" x2="580" y2="150"/>
<line x1="585" y1="140" x2="585" y2="160"/>
<line x1="580" y1="150" x2="585" y2="150"/>
<line x1="5" y1="160" x2="5" y2="180"/>
<text x="25" y="170">L</text>
<text x="35" y="170">4</text>
<text x="45" y="170">:</text>
<text x="65" y="170">D</text>
<text x="75" y="170">i</text>
<text x="85" y="170">s</text>
<text x="95" y="170">k</text>
<text x="105" y="170">/</text>
<text x="115" y="170">N</text>
<text x="125" y="170">e</text>
<text x="135" y="170">t</text>
<text x="145" y="170">w</text>
<text x="155" y="170">o</text>
<text x="165" y="170">r</text>
<text x="175" y="170">k</text>
<text x="195" y="170">(</text>
<text x="205" y="170">a</text>
<text x="215" y="170">u</text>
<text x="225" y="170">t</text>
<text x="235" y="170">h</text>
<text x="245" y="170">o</text>
<text x="255" y="170">r</text>
<text x="265" y="170">i</text>
<text x="275" y="170">t</text>
<text x="285" y="170">a</text>
<text x="295" y="170">t</text>
<text x="305" y="170">i</text>
<text x="315" y="170">v</text>
<text x="325" y="170">e</text>
<text x="335" y="170">,</text>
<text x="355" y="170">m</text>
<text x="365" y="170">i</text>
<text x="375" y="170">l</text>
<text x="385" y="170">l</text>
<text x="395" y="170">i</text>
<text x="405" y="170">s</text>
<text x="415" y="170">e</text>
<text x="425" y="170">c</text>
<text x="435" y="170">o</text>
<text x="445" y="170">n</text>
<text x="455" y="170">d</text>
<text x="465" y="170">s</text>
<text x="475" y="170">)</text>
<line x1="575" y1="160" x2="575" y2="180"/>
<line x1="5" y1="190" x2="10" y2="190"/>
<line x1="5" y1="180" x2="5" y2="190"/>
<line x1="10" y1="190" x2="20" y2="190"/>
<line x1="20" y1="190" x2="30" y2="190"/>
<line x1="30" y1="190" x2="40" y2="190"/>
<line x1="40" y1="190" x2="50" y2="190"/>
<line x1="50" y1="190" x2="60" y2="190"/>
<line x1="60" y1="190" x2="70" y2="190"/>
<line x1="70" y1="190" x2="80" y2="190"/>
<line x1="80" y1="190" x2="90" y2="190"/>
<line x1="90" y1="190" x2="100" y2="190"/>
<line x1="100" y1="190" x2="110" y2="190"/>
<line x1="110" y1="190" x2="120" y2="190"/>
<line x1="120" y1="190" x2="130" y2="190"/>
<line x1="130" y1="190" x2="140" y2="190"/>
<line x1="140" y1="190" x2="150" y2="190"/>
<line x1="150" y1="190" x2="160" y2="190"/>
<line x1="160" y1="190" x2="170" y2="190"/>
<line x1="170" y1="190" x2="180" y2="190"/>
<line x1="180" y1="190" x2="190" y2="190"/>
<line x1="190" y1="190" x2="200" y2="190"/>
<line x1="200" y1="190" x2="210" y2="190"/>
<line x1="210" y1="190" x2="220" y2="190"/>
<line x1="220" y1="190" x2="230" y2="190"/>
<line x1="230" y1="190" x2="240" y2="190"/>
<line x1="240" y1="190" x2="250" y2="190"/>
<line x1="250" y1="190" x2="260" y2="190"/>
<line x1="260" y1="190" x2="270" y2="190"/>
<line x1="270" y1="190" x2="280" y2="190"/>
<line x1="280" y1="190" x2="290" y2="190"/>
<line x1="290" y1="190" x2="300" y2="190"/>
<line x1="300" y1="190" x2="310" y2="190"/>
<line x1="310" y1="190" x2="320" y2="190"/>
<line x1="320" y1="190" x2="330" y2="190"/>
<line x1="330" y1="190" x2="340" y2="190"/>
<line x1="340" y1="190" x2="350" y2="190"/>
<line x1="350" y1="190" x2="360" y2="190"/>
<line x1="360" y1="190" x2="370" y2="190"/>
<line x1="370" y1="190" x2="380" y2="190"/>
<line x1="380" y1="190" x2="390" y2="190"/>
<line x1="390" y1="190" x2="400" y2="190"/>
<line x1="400" y1="190" x2="410" y2="190"/>
<line x1="410" y1="190" x2="420" y2="190"/>
<line x1="420" y1="190" x2="430" y2="190"/>
<line x1="430" y1="190" x2="440" y2="190"/>
<line x1="440" y1="190" x2="450" y2="190"/>
<line x1="450" y1="190" x2="460" y2="190"/>
<line x1="460" y1="190" x2="470" y2="190"/>
<line x1="470" y1="190" x2="480" y2="190"/>
<line x1="480" y1="190" x2="490" y2="190"/>
<line x1="490" y1="190" x2="500" y2="190"/>
<line x1="500" y1="190" x2="510" y2="190"/>
<line x1="510" y1="190" x2="520" y2="190"/>
<line x1="520" y1="190" x2="530" y2="190"/>
<line x1="530" y1="190" x2="540" y2="190"/>
<line x1="540" y1="190" x2="550" y2="190"/>
<line x1="550" y1="190" x2="560" y2="190"/>
<line x1="560" y1="190" x2="570" y2="190"/>
<line x1="570" y1="190" x2="580" y2="190"/>
<line x1="580" y1="190" x2="585" y2="190"/>
<line x1="585" y1="180" x2="585" y2="190"/>
</svg>
</div>
<h3>Blocked Bloom Filters</h3>
<p>Cache-line aligned blocks for 10x faster lookups:</p>
<pre class="language-scheme">
;; Blocked Bloom: each block fits in CPU cache line (64 bytes = 512 bits)
(define block-bits 512)
(define cache-line 64)

(define (make-blocked-bloom capacity error-rate)
  "Cache-friendly blocked Bloom filter"
  (let ((bits (bloom-optimal-bits capacity error-rate))
         (num-blocks (ceiling (/ bits block-bits)))
         (hashes (bloom-optimal-hashes capacity bits)))
    (blocked-bloom
      (blocks (make-vector num-blocks (make-u8vector cache-line 0)))
      (hash-count hashes)
      (block-selector (lambda (hash) (modulo (hash-part-1 hash) num-blocks))))))

(define (blocked-bloom-add! filter hash)
  "Add to block - all bits within same cache line"
  (let ((block-idx (block-select filter hash))
         (block (vector-ref (bloom-blocks filter) block-idx)))
    (for-each
      (lambda (i)
        (let ((bit-idx (modulo (bloom-hash filter hash i) block-bits)))
          (u8vector-bit-set! block bit-idx 1)))
      (iota (bloom-hash-count filter)))))

(define (blocked-bloom-contains? filter hash)
  "Check within single cache line - no cache misses"
  (let ((block-idx (block-select filter hash))
         (block (vector-ref (bloom-blocks filter) block-idx)))
    (every
      (lambda (i)
        (let ((bit-idx (modulo (bloom-hash filter hash i) block-bits*)))
          (= 1 (u8vector-bit-ref block bit-idx))))
      (iota (bloom-hash-count filter)))))
</pre>
<h3>Counting Bloom Filters</h3>
<p>For the soup, objects can be tombstoned (soft-deleted). Counting filters support removal:</p>
<pre class="language-scheme">
;; Counting Bloom: 4-bit counters instead of single bits
(define (make-counting-bloom capacity error-rate)
  "Counting Bloom filter supporting deletions"
  (let* ((slots (bloom-optimal-bits capacity error-rate))
         (nibbles (make-u8vector (ceiling (/ slots 2)) 0))
         (hashes (bloom-optimal-hashes capacity slots)))
    (counting-bloom nibbles hashes slots)))

(define (counting-bloom-add! filter hash)
  "Increment counters (saturate at 15)"
  (for-each
    (lambda (i)
      (let ((slot (bloom-slot filter hash i)))
        (nibble-increment! (bloom-nibbles filter) slot)))
    (iota (bloom-hash-count filter))))

(define (counting-bloom-remove! filter hash)
  "Decrement counters (only if present)"
  (when (counting-bloom-contains? filter hash)
    (for-each
      (lambda (i)
        (let ((slot (bloom-slot filter hash i)))
          (nibble-decrement! (bloom-nibbles filter) slot)))
      (iota (bloom-hash-count filter)))))

;; Integration with tombstones
(define (cas-tombstone/bloom hash reason)
  "Tombstone with Bloom filter update"
  (counting-bloom-remove! existence-filter hash)
  (cas-tombstone hash reason: reason))
</pre>
<h3>Quotient Filters</h3>
<p>Better space efficiency than Bloom, supports deletion, and can be resized:</p>
<pre class="language-scheme">
;; Quotient filter: fingerprint stored in quotient/remainder form
(define (make-quotient-filter capacity)
  "Space-efficient filter with deletion support"
  (let* ((slots (next-power-of-2 capacity))
         (q-bits (integer-log2 slots))
         (r-bits (- 64 q-bits)))  ; 64-bit fingerprints
    (quotient-filter
      (table (make-vector slots #f))
      (q-bits q-bits)
      (r-bits r-bits)
      (count 0))))

(define (qf-fingerprint hash q-bits r-bits)
  "Split hash into quotient and remainder"
  (let ((fp (hash-&gt;u64 hash)))
    (values (arithmetic-shift fp (- r-bits))  ; quotient
            (bitwise-and fp (- (arithmetic-shift 1 r-bits) 1)))))  ; remainder

(define (qf-insert! qf hash)
  "Insert with Robin Hood linear probing"
  (let-values (((q r) (qf-fingerprint hash (qf-q-bits qf) (qf-r-bits qf))))
    (qf-insert-slot! qf q r)))

(define (qf-delete! qf hash)
  "Delete fingerprint"
  (let-values (((q r) (qf-fingerprint hash (qf-q-bits qf) (qf-r-bits qf))))
    (qf-delete-slot! qf q r)))
</pre>
<h3>Replication Protocol</h3>
<pre class="language-scheme">
;; Sender: "Here's what I have" (compressed Bloom)
(define (bloom-inventory)
  (let ((filter (make-blocked-bloom 100000 0.01)))
    (for-each (lambda (hash) (blocked-bloom-add! filter hash))
              (all-object-hashes))
    filter))

;; Receiver: "Send me what I'm missing"
(define (bloom-diff local-filter remote-filter)
  (filter (lambda (hash)
            (and (blocked-bloom-contains? remote-filter hash)
                 (not (cas-exists? hash))))
          (all-object-hashes)))

;; Exchange is O(bloom-size) not O(object-count)
;; Blocked Bloom: 10-100x faster due to cache locality
</pre>
<h3>Hierarchical Existence Check</h3>
<pre class="language-scheme">
(define (cas-exists?/fast hash)
  "Tiered existence check - fast path for common case"
  (or (lru-get hot-set hash)              ; L1: O(1) in-memory
      (and (blocked-bloom-contains? l2-bloom hash)  ; L2: O(k) cache-friendly
           (or (qf-contains? l3-qf hash)  ; L3: O(1) amortized
               (cas-exists? hash)))))      ; L4: authoritative

;; 99% of checks hit L1/L2, avoiding disk/network entirely
</pre>
<h3>Soup Integration</h3>
<pre class="language-scheme">
;; Bloom filter itself is a soup object
(soup-object
  (name "bloom/2026-01-09")
  (type bloom-filter)
  (variant blocked)           ; blocked, counting, or quotient
  (size "12KB")
  (crypto (sha256 "bloom-hash..."))
  (capacity 100000)
  (error-rate 0.01)
  (population 47230)
  (load-factor 0.47))
</pre>
</section>
<section>
<h2>Content Types</h2>
<p>Typed objects with schema validation.</p>
<h3>Type Registry</h3>
<pre class="language-scheme">
(define content-types
  '((blob        . "application/octet-stream")
    (text        . "text/plain")
    (markdown    . "text/markdown")
    (scheme      . "text/x-scheme")
    (sexp        . "application/x-sexp")
    (json        . "application/json")
    (pdf         . "application/pdf")
    (archive     . "application/x-sealed-archive")
    (key         . "application/x-spki-key")
    (certificate . "application/x-spki-cert")))
</pre>
<h3>Typed Storage</h3>
<pre class="language-scheme">
(define (cas-put/typed content type #!key schema)
  "Store with type metadata"
  (let* ((hash (sha256 content))
         (meta `(typed-object
                 (hash ,hash)
                 (type ,type)
                 (size ,(blob-length content))
                 (schema ,schema))))
    (cas-put content)
    (cas-put (serialize meta))
    hash))
</pre>
<h3>Schema Validation</h3>
<pre class="language-scheme">
(define (cas-validate hash)
  "Validate object against its schema"
  (let* ((meta (cas-get-meta hash))
         (schema-hash (typed-object-schema meta))
         (schema (cas-get schema-hash))
         (content (cas-get hash)))
    (schema-validate schema content)))

;; Schema is itself content-addressed
(soup-object
  (name "schema/soup-object")
  (type schema)
  (validates soup-object)
  (crypto (sha256 "schema-hash...")))
</pre>
<h3>MIME Detection</h3>
<pre class="language-scheme">
(define (cas-detect-type content)
  "Detect content type from magic bytes"
  (cond
    ((pdf-magic? content) 'pdf)
    ((gzip-magic? content) 'archive)
    ((utf8-text? content)
     (cond
       ((sexp-syntax? content) 'sexp)
       ((markdown-syntax? content) 'markdown)
       (else 'text)))
    (else 'blob)))
</pre>
</section>
<section>
<h2>Object Capabilities</h2>
<p>Content addresses as capabilities: if you know the hash, you can retrieve it.</p>
<h3>Hash as Capability</h3>
<pre class="language-scheme">
;; Knowledge of hash grants read access
(define (cas-get-if-known hash)
  "Capability-based retrieval"
  (if (valid-hash? hash)
      (cas-get hash)
      (error "Invalid capability")))

;; Hashes are unguessable (256-bit entropy)
;; Sharing a hash = sharing read access
</pre>
<h3>Capability Attenuation</h3>
<pre class="language-scheme">
;; SPKI certificate granting access to specific content
(spki-cert
  (issuer vault-key)
  (subject reader-key)
  (permission (read (hash sha256 "specific-content...")))
  (validity (not-after "2027-01-01")))

;; Grant access to a subtree
(spki-cert
  (issuer vault-key)
  (subject reader-key)
  (permission (read (tree sha256 "subtree-root...")))
  (propagate #t))  ; Access to all referenced objects
</pre>
<h3>Sealed Capabilities</h3>
<pre class="language-scheme">
;; Encrypted capability - only holder of key can use
(define (seal-capability hash recipient-key)
  (let ((cap `(capability
               (object ,hash)
               (granted-at ,(current-seconds)))))
    (age-encrypt (serialize cap) recipient-key)))

;; Recipient decrypts to obtain hash
(define (unseal-capability sealed-cap identity)
  (let ((cap (deserialize (age-decrypt sealed-cap identity))))
    (capability-object cap)))
</pre>
<h3>Capability Revocation</h3>
<pre class="language-scheme">
;; Revocation via tombstone
(define (revoke-capability hash)
  (cas-tombstone hash reason: "Capability revoked"))

;; Or via SPKI CRL
(spki-crl
  (issuer vault-key)
  (revoked
    ((hash sha256 "revoked-content...")
     (reason "Superseded")
     (revoked-at 1767700000))))
</pre>
</section>
<section>
<h2>Hash Migration</h2>
<p>When cryptographic algorithms weaken, the system must migrate.</p>
<h3>Multihash</h3>
<pre class="language-scheme">
;; Self-describing hash format
(define (multihash algo data)
  (let ((hash (case algo
                ((sha256) (sha256 data))
                ((sha384) (sha384 data))
                ((sha512) (sha512 data))
                ((blake3) (blake3 data)))))
    (list algo (blob-length hash) hash)))

;; Parse multihash
(define (multihash-algorithm mh) (car mh))
(define (multihash-digest mh) (caddr mh))
</pre>
<h3>Dual-Hash Period</h3>
<pre class="language-scheme">
;; During migration, store under both hashes
(define (cas-put/migrate content old-algo new-algo)
  (let ((old-hash (hash-with old-algo content))
        (new-hash (hash-with new-algo content)))
    (cas-put-raw old-hash content)
    (cas-put-raw new-hash content)
    ;; Link old to new
    (ref-set (string-append "migrate/" old-hash) new-hash)
    new-hash))

;; Lookup follows migration links
(define (cas-get/migrate hash)
  (let ((migrated (ref-get (string-append "migrate/" hash))))
    (cas-get (or migrated hash))))
</pre>
<h3>Migration Manifest</h3>
<pre class="language-scheme">
(migration-manifest
  (from-algorithm sha256)
  (to-algorithm sha384)
  (started-at 1767700000)
  (status in-progress)
  (migrated 4723)
  (remaining 1892)
  (mappings
    (("sha256:abc..." . "sha384:def...")
     ("sha256:123..." . "sha384:456...")
     ...)))
</pre>
<h3>Verification During Migration</h3>
<pre class="language-scheme">
(define (verify-migration hash)
  "Verify object under both old and new hash"
  (let* ((content (cas-get hash))
         (old-hash (sha256 content))
         (new-hash (sha384 content)))
    (and (or (equal? hash old-hash)
             (equal? hash new-hash))
         (equal? (ref-get (string-append "migrate/" old-hash))
                 new-hash))))
</pre>
</section>
<section>
<h2>Comparison with Related Systems</h2>
<table>
<tr><th>System </th><th>Hash </th><th>Chunking </th><th>Naming </th></tr>
<tr><td>Git </td><td>SHA-1 </td><td>Pack files </td><td>refs/branches </td></tr>
<tr><td>IPFS </td><td>SHA-256/multihash </td><td>Rabin </td><td>IPNS, DNSLink </td></tr>
<tr><td>Perkeep </td><td>SHA-224 </td><td>Rolling hash </td><td>Permanodes </td></tr>
<tr><td>Library CAS </td><td>SHA-256 </td><td>Configurable </td><td>Vault refs </td></tr>
</table>
</section>
<section>
<h2>Security Considerations</h2>
<h3>Hash Collision Attacks</h3>
<p>SHA-256 provides 128-bit collision resistance. No practical attacks known.</p>
<p>If SHA-256 is ever broken:</p>
<pre class="language-scheme">
;; Multihash for algorithm agility
(define (multihash algo data)
  (case algo
    ((sha256) (cons 'sha256 (sha256 data)))
    ((sha384) (cons 'sha384 (sha384 data)))
    ((blake3) (cons 'blake3 (blake3 data)))))
</pre>
<h3>Length Extension Attacks</h3>
<p>SHA-256 is vulnerable to length extension. For authentication, use HMAC:</p>
<pre class="language-scheme">
(define (cas-mac key hash)
  (hmac-sha256 key hash))
</pre>
<h3>Timing Attacks</h3>
<p>Hash comparison MUST be constant-time:</p>
<pre class="language-scheme">
(define (hash-equal? a b)
  (let ((result 0))
    (do ((i 0 (+ i 1)))
        ((= i 32) (zero? result))
      (set! result (bitwise-ior result
                    (bitwise-xor (blob-ref a i) (blob-ref b i)))))))
</pre>
</section>
<section>
<h2>Performance Considerations</h2>
<h3>Caching</h3>
<pre class="language-scheme">
;; LRU cache for hot objects
(define cas-cache (make-lru-cache 1000))

(define (cas-get/cached hash)
  (or (lru-get cas-cache hash)
      (let ((content (cas-get hash)))
        (lru-put! cas-cache hash content)
        content)))
</pre>
<h3>Parallel Hashing</h3>
<p>Large files benefit from parallel hashing of chunks.</p>
<h3>SSD Optimization</h3>
<p>Random access pattern. Use write-ahead log for durability:</p>
<pre class="language-scheme">
(define (cas-put/durable content)
  (let ((hash (sha256 content)))
    (wal-append hash content)
    (write-blob (hash-&gt;path hash) content)
    (wal-commit hash)
    hash))
</pre>
</section>
<section>
<h2>Implementation Notes</h2>
<h3>Dependencies</h3>
<table>
<tr><th>Component </th><th>Library </th></tr>
<tr><td>SHA-256 </td><td>message-digest, sha2 </td></tr>
<tr><td>Blob I/O </td><td>CHICKEN I/O </td></tr>
<tr><td>Chunking </td><td>Custom </td></tr>
</table>
<h3>Error Handling</h3>
<pre class="language-scheme">
(define-condition-type &amp;cas-error &amp;error
  cas-error?
  (hash cas-error-hash))

(define-condition-type &amp;cas-not-found &amp;cas-error
  cas-not-found?)

(define-condition-type &amp;cas-corrupt &amp;cas-error
  cas-corrupt?)
</pre>
</section>
<section>
<h2>References</h2>
<ul>
<li>Merkle, R. (1987), "A Digital Signature Based on a Conventional Encryption Function"</li>
<li>Git Internals - Git Objects</li>
<li>IPFS Content Addressing</li>
<li>Putze, Sanders, Singler (2007), "Cache-, Hash-, and Space-Efficient Bloom Filters"</li>
<li>Bender et al. (2012), "Don't Thrash: How to Cache Your Hash on Flash"</li>
<li>Memo-006: Vault System Architecture</li>
<li>Memo-018: Sealed Archive Format</li>
</ul>
</section>
<section>
<h2>Changelog</h2>
<ul>
<li>2026-01-09</li>
<li>Advanced probabilistic data structures: blocked Bloom filters, counting Bloom filters, quotient filters, hierarchical existence checking - 2026-01-07</li>
<li>Initial draft</li>
</ul>
</section>
<script>
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}
(function() {
  // Query param override (for REPL: ?theme=dark or ?theme=light)
  const params = new URLSearchParams(window.location.search);
  const param = params.get('theme');
  if (param === 'dark' || param === 'light') {
    document.documentElement.setAttribute('data-theme', param);
    localStorage.setItem('theme', param);
    return;
  }
  // localStorage preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</body>
</html>
