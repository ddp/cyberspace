<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <title>Memo 0017: Versioning and Rollback</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27%230f0%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>">
  <script>
(function(){
  var h=new Date().getHours(),c;
  if(h>=4&&h<6)c='%23845EC2';       // brahma muhurta - violet
  else if(h>=6&&h<8)c='%23ffd700';  // dawn - gold
  else if(h>=8&&h<11)c='%2300d4aa'; // morning - teal
  else if(h>=11&&h<14)c='%230f0';   // midday - phosphor
  else if(h>=14&&h<17)c='%2339ff14';// afternoon - neon
  else if(h>=17&&h<19)c='%23ff6600';// sunset - orange
  else if(h>=19&&h<22)c='%23ff3366';// evening - coral
  else c='%2300ffff';               // night - cyan
  document.getElementById('favicon').href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><text x=%2716%27 y=%2725%27 font-family=%27serif%27 font-size=%2728%27 fill=%27'+c+'%27 text-anchor=%27middle%27 font-weight=%27bold%27>λ</text></svg>';
})();
</script>
  <link rel="stylesheet" href="memo.css">
</head>
<body>
<span class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark">[theme]</span>
<h1>Memo 0017: Versioning and Rollback</h1>
<dl class="metadata">
</dl>
<hr>
<section>
<h2>Abstract</h2>
<p>This Memo specifies user-visible versioning and rollback semantics for Cyberspace vaults, providing clear mental models for version management, safe rollback operations, and recovery from mistakes.</p>
</section>
<section>
<h2>Motivation</h2>
<p>Users need simple answers to simple questions:</p>
<ul>
<li>What version am I on?</li>
<li>What versions exist?</li>
<li>How do I go back?</li>
<li>What if I make a mistake?</li>
</ul>
<p>These questions are universal but git answers them with mechanisms rather than semantics, requiring users to understand implementation details.</p>
<p>Git provides mechanisms. Cyberspace provides semantics:</p>
<pre class="diagram">
seal-version         → "2.1.0"
seal-versions        → [1.0.0, 1.1.0, 2.0.0, 2.1.0]
seal-rollback 2.0.0  → Done. Now at 2.0.0.
seal-recover         → Here's what you can recover.
</pre>
</section>
<section>
<h2>Specification</h2>
<h3>Version Model</h3>
<pre class="diagram">
                         HEAD
                          ↓
    1.0.0 ──→ 1.1.0 ──→ 2.0.0 ──→ 2.1.0
      │                   │
      │                   └── seal-rollback target
      │
      └── seal-archive snapshots
</pre>
<p>Versions are semantic (X.Y.Z), immutable, signed.</p>
<p>HEAD is current working state.</p>
<p>Rollback creates forward commit that restores past state.</p>
<h3>Core Operations</h3>
<p>#### seal-version</p>
<p>Report current version.</p>
<pre class="language-scheme">
(seal-version)
;; =&gt; "2.1.0" or "2.1.0+3" (3 commits past release)
</pre>
<p>Output format: - X.Y.Z - Exactly at release - X.Y.Z+N - N commits past release - X.Y.Z-dev - Development branch - unversioned - No releases yet</p>
<p>#### seal-versions</p>
<p>List all versions.</p>
<pre class="language-scheme">
(seal-versions)
;; =&gt; ("1.0.0" "1.1.0" "2.0.0" "2.1.0")

(seal-versions verbose: #t)
;; =&gt;
;; 1.0.0  2026-01-01  "Initial release"
;; 1.1.0  2026-01-05  "Bug fixes"
;; 2.0.0  2026-01-10  "New governance model"
;; 2.1.0  2026-01-15  "Performance improvements"
</pre>
<p>#### seal-rollback</p>
<p>Roll back to specific version.</p>
<pre class="language-scheme">
(seal-rollback "2.0.0")
</pre>
<p>Process:</p>
<ul>
<li>Verify version exists</li>
<li>Check for uncommitted changes (abort or stash)</li>
<li>Create rollback commit with contents of target version</li>
<li>Record in audit trail</li>
<li>Optionally create rollback tag</li>
</ul>
<p>Rollback commit message:</p>
<pre>
Rollback to 2.0.0

Restored vault state to version 2.0.0.
Previous HEAD was 2.1.0+3.

Reason: [user-provided or "Manual rollback"]
</pre>
<p>NOT a git reset. History preserved. Rollback is a forward operation.</p>
<p>#### seal-diff</p>
<p>Compare versions.</p>
<pre class="language-scheme">
(seal-diff "2.0.0" "2.1.0")
;; Shows what changed between versions

(seal-diff "2.0.0")
;; Shows what changed since 2.0.0
</pre>
<p>#### seal-recover</p>
<p>Recovery options for mistakes.</p>
<pre class="language-scheme">
(seal-recover)
;; =&gt;
;; Recovery options:
;;   1. Uncommitted changes (stashed 5 minutes ago)
;;   2. Last commit (seal-undo)
;;   3. Version 2.1.0 (seal-rollback "2.1.0")
;;   4. Archive vault-2.0.0.archive (seal-restore)
</pre>
</section>
<section>
<h2>Rollback Semantics</h2>
<h3>Forward Rollback (Default)</h3>
<pre class="diagram">
Before:  1.0.0 → 1.1.0 → 2.0.0 → 2.1.0 → HEAD
                          ↑
                     rollback target

After:   1.0.0 → 1.1.0 → 2.0.0 → 2.1.0 → [rollback commit]
                          │                      │
                          └──────────────────────┘
                              contents match

</pre>
<p>History preserved. Audit trail shows rollback.</p>
<h3>Hard Rollback (Dangerous)</h3>
<pre class="language-scheme">
(seal-rollback "2.0.0" hard: #t)
</pre>
<p>Actually resets to version. Destroys history.</p>
<p>Requires: - Explicit hard: #t flag - Confirmation prompt - Audit entry before destruction</p>
<h3>Rollback with Stash</h3>
<pre class="language-scheme">
(seal-rollback "2.0.0" stash: #t)
</pre>
<p>Stashes uncommitted changes before rollback. Can recover with:</p>
<pre class="language-scheme">
(seal-stash-pop)
</pre>
</section>
<section>
<h2>Version Tags</h2>
<h3>Automatic Tagging</h3>
<pre class="language-scheme">
(seal-release "2.1.0")
;; Creates:
;;   - Git tag: 2.1.0
;;   - Signature: .vault/releases/2.1.0.sig
;;   - Audit entry
</pre>
<h3>Rollback Tags</h3>
<pre class="language-scheme">
(seal-rollback "2.0.0" tag: "rollback-2026-01-15")
;; Creates additional tag marking rollback point
</pre>
<h3>Tag Listing</h3>
<pre class="language-scheme">
(seal-tags)
;; =&gt;
;; 1.0.0              2026-01-01  release
;; 1.1.0              2026-01-05  release
;; 2.0.0              2026-01-10  release
;; 2.1.0              2026-01-15  release
;; rollback-2026-01-15 2026-01-15  rollback
</pre>
</section>
<section>
<h2>Recovery Scenarios</h2>
<h3>Scenario 1: Bad Commit</h3>
<pre class="language-scheme">
;; Oops, committed broken code
(seal-undo)                    ; Undo last commit
;; or
(seal-rollback "2.1.0")        ; Back to last release
</pre>
<h3>Scenario 2: Bad Release</h3>
<pre class="language-scheme">
;; Released 2.2.0 but it's broken
(seal-rollback "2.1.0")        ; Back to good version
(seal-release "2.2.1")         ; Patch release
</pre>
<h3>Scenario 3: Lost Changes</h3>
<pre class="language-scheme">
;; Accidentally discarded work
(seal-recover)                 ; See options
(seal-stash-pop)               ; If stashed
;; or
(seal-reflog)                  ; Find lost commits
</pre>
<h3>Scenario 4: Corrupted Vault</h3>
<pre class="language-scheme">
;; Something went very wrong
(seal-restore "vault-2.0.0.archive" verify-key: "alice.pub")
</pre>
</section>
<section>
<h2>Audit Integration</h2>
<p>Every version operation recorded:</p>
<pre class="language-scheme">
(audit-entry
  (action
    (verb seal-rollback)
    (object "2.0.0")
    (parameters
      (from "2.1.0+3")
      (method forward)
      (reason "Production incident")))
  (seal ...))
</pre>
<p>Audit trail answers: - Who rolled back? - When? - From what version? - Why? (if reason provided)</p>
</section>
<section>
<h2>CLI Interface</h2>
<pre class="diagram">
# Current version
$ seal version
2.1.0+3

# List versions
$ seal versions
1.0.0   2026-01-01   Initial release
1.1.0   2026-01-05   Bug fixes
2.0.0   2026-01-10   New governance model
2.1.0   2026-01-15   Performance improvements

# Rollback
$ seal rollback 2.0.0
Rolling back to 2.0.0...
✓ Rollback complete. Now at 2.0.0.

# Rollback with reason
$ seal rollback 2.0.0 --reason "Production incident #123"

# Compare versions
$ seal diff 2.0.0 2.1.0
 M config.scm
 A new-feature.scm
 D deprecated.scm

# Recovery options
$ seal recover
Recovery options:
  1. seal undo          - Undo last commit
  2. seal rollback 2.1.0 - Return to last release
  3. seal stash pop     - Recover stashed changes
</pre>
</section>
<section>
<h2>Safety Mechanisms</h2>
<h3>Uncommitted Changes</h3>
<pre class="language-scheme">
(seal-rollback "2.0.0")
;; Error: Uncommitted changes detected.
;; Use --stash to save changes, or --force to discard.
</pre>
<h3>Protected Versions</h3>
<pre class="language-scheme">
(vault-config 'protected-versions '("1.0.0" "2.0.0"))

(seal-rollback "0.9.0")
;; Warning: Rolling back past protected version 1.0.0
;; This may break compatibility. Continue? [y/N]
</pre>
<h3>Rollback Limits</h3>
<pre class="language-scheme">
(vault-config 'max-rollback-distance 10)

(seal-rollback "0.1.0")
;; Error: Rollback distance (20 versions) exceeds limit (10).
;; Use --force to override.
</pre>
</section>
<section>
<h2>Implementation</h2>
<h3>seal-rollback Implementation</h3>
<pre class="diagram">
(define (seal-rollback version #!key hard stash force reason tag)
  "Roll back vault to specified version"

  ;; Validate version exists
  (unless (tag-exists? version)
    (error "Version not found" version))

  ;; Check for uncommitted changes
  (when (uncommitted-changes?)
    (cond
      (stash (seal-stash))
      (force (void))
      (else (error "Uncommitted changes. Use stash: or force:"))))

  ;; Record current state
  (let ((current (seal-version)))

    ;; Perform rollback
    (if hard
        (hard-rollback! version)
        (forward-rollback! version reason))

    ;; Create tag if requested
    (when tag
      (run-command "git" "tag" tag))

    ;; Audit
    (audit-append
      actor: (get-vault-principal (vault-config 'signing-key))
      action: (list 'seal-rollback version)
      motivation: (or reason (sprintf "Rollback from ~a to ~a" current version)))

    (print "✓ Rolled back to " version)))

(define (forward-rollback! version reason)
  "Create rollback commit (preserves history)"
  (run-command "git" "checkout" version "--" ".")
  (run-command "git" "commit" "-m"
    (sprintf "Rollback to ~a\n\n~a" version (or reason ""))))

(define (hard-rollback! version)
  "Reset to version (destroys history)"
  (print "WARNING: Hard rollback destroys history")
  (run-command "git" "reset" "--hard" version))
</pre>
</section>
<section>
<h2>Security Considerations</h2>
<h3>Rollback Attacks</h3>
<p>Attacker forces rollback to vulnerable version.</p>
<p>Mitigation: - Threshold signatures for rollback (Memo-008) - Protected version list - Audit trail detection</p>
<h3>History Manipulation</h3>
<p>Hard rollback can hide evidence.</p>
<p>Mitigation: - Prefer forward rollback - Audit before hard rollback - Federation replication preserves history</p>
</section>
<section>
<h2>References</h2>
<ul>
<li>Semantic Versioning 2.0.0 (semver.org)</li>
<li>Git Reset, Checkout, and Revert (git-scm.com)</li>
<li>Memo-003: Cryptographic Audit Trail</li>
<li>Memo-006: Vault System Architecture</li>
</ul>
</section>
<section>
<h2>Changelog</h2>
<ul>
<li>2026-01-06</li>
<li>Initial specification</li>
</ul>
</section>
<script>
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}
(function() {
  // Query param override (for REPL: ?theme=dark or ?theme=light)
  const params = new URLSearchParams(window.location.search);
  const param = params.get('theme');
  if (param === 'dark' || param === 'light') {
    document.documentElement.setAttribute('data-theme', param);
    localStorage.setItem('theme', param);
    return;
  }
  // localStorage preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</body>
</html>
