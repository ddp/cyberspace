%!PS-Adobe-3.0
%%Title: memo-0024-network-protocol
%%Creator: Library of Cyberspace Memo Pipeline
%%Pages: (atend)
%%EndComments

/Courier findfont 10 scalefont setfont
/margin 72 def
/pagewidth 612 def
/pageheight 792 def
/leading 12 def
/topmargin pageheight margin sub def
/bottommargin margin def
/linewidth pagewidth margin 2 mul sub def
/ypos topmargin def
/pagenum 1 def

/newline {
  /ypos ypos leading sub def
  ypos bottommargin lt {
    showpage
    /pagenum pagenum 1 add def
    /ypos topmargin def
  } if
  margin ypos moveto
} def

margin topmargin moveto
(Memo 0024: Network Protocol) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
() show newline
(------------------------------------------------------------------------) show newline
(ABSTRACT) show newline
(------------------------------------------------------------------------) show newline
() show newline
(This Memo specifies the network protocol for the Library of Cyberspace:) show newline
(how vaults discover each other, authenticate, exchange objects, and) show newline
(synchronize state. The protocol is transport-agnostic,) show newline
(capability-authenticated, and optimized for content-addressed data.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(MOTIVATION) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Vaults must communicate to:) show newline
() show newline
(  * Replicate) show newline
(  * Distribute objects across vaults) show newline
(  * Federate) show newline
(  * Link independent vaults into networks) show newline
(  * Subscribe) show newline
(  * Receive updates from publishers) show newline
(  * Query) show newline
(  * Search the distributed soup) show newline
() show newline
(The protocol must handle:) show newline
() show newline
(  * Intermittent connectivity) show newline
(  * Vaults may be offline) show newline
(  * Untrusted networks) show newline
(  * All communication authenticated) show newline
(  * Large objects) show newline
(  * Efficient chunked transfer) show newline
(  * Partial sync) show newline
(  * Resume interrupted transfers) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(PROTOCOL LAYERS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(    +-----------------------------------------+) show newline
(    |           APPLICATION LAYER             |) show newline
(    |  \(vault operations, soup queries\)       |) show newline
(    +-----------------------------------------+) show newline
(    |           MESSAGE LAYER                 |) show newline
(    |  \(request/response, streaming\)          |) show newline
(    +-----------------------------------------+) show newline
(    |           SECURITY LAYER                |) show newline
(    |  \(authentication, encryption\)           |) show newline
(    +-----------------------------------------+) show newline
(    |           TRANSPORT LAYER               |) show newline
(    |  \(TCP, QUIC, Unix socket, etc.\)         |) show newline
(    +-----------------------------------------+) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(TRANSPORT LAYER) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Supported Transports) show newline
(--------------------) show newline
() show newline
() show newline
(    \(define transports) show newline
(      '\(\(tcp "Traditional TCP/IP"\)) show newline
(        \(quic "UDP-based, multiplexed"\)) show newline
(        \(unix "Local Unix domain socket"\)) show newline
(        \(tor "Onion-routed TCP"\)) show newline
(        \(i2p "Garlic-routed"\)) show newline
(        \(bluetooth "Local mesh"\)) show newline
(        \(sneakernet "Physical media exchange"\)\)\)) show newline
() show newline
() show newline
(Connection Establishment) show newline
(------------------------) show newline
() show newline
() show newline
(    \(define \(connect-vault address transport\)) show newline
(      "Establish connection to remote vault") show newline
(      \(let* \(\(socket \(transport-connect transport address\)\)) show newline
(             \(connection \(make-connection socket transport\)\)\)) show newline
(        ;; Perform handshake) show newline
(        \(connection-handshake connection\)) show newline
(        ;; Return authenticated connection) show newline
(        connection\)\)) show newline
() show newline
() show newline
(Multiplexing) show newline
(------------) show newline
() show newline
(Multiple streams over single connection:) show newline
() show newline
() show newline
(    \(define \(open-stream connection stream-type\)) show newline
(      "Open multiplexed stream within connection") show newline
(      \(let \(\(stream-id \(allocate-stream-id connection\)\)\)) show newline
(        \(send-frame connection) show newline
(          \(frame type: 'stream-open) show newline
(                 stream-id: stream-id) show newline
(                 stream-type: stream-type\)\)) show newline
(        \(make-stream connection stream-id stream-type\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(SECURITY LAYER) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Handshake Protocol) show newline
(------------------) show newline
() show newline
(Mutual authentication using SPKI certificates:) show newline
() show newline
() show newline
(    Client                                   Server) show newline
(      |                                        |) show newline
(      |---- ClientHello ---------------------->|) show newline
(      |     \(protocol version, capabilities\)   |) show newline
(      |                                        |) show newline
(      |<---- ServerHello ---------------------|) show newline
(      |      \(protocol version, certificate\)   |) show newline
(      |                                        |) show newline
(      |---- ClientAuth ----------------------->|) show newline
(      |     \(certificate, challenge-response\)  |) show newline
(      |                                        |) show newline
(      |<---- ServerAuth ----------------------|) show newline
(      |      \(challenge-response\)              |) show newline
(      |                                        |) show newline
(      |------ Encrypted Channel --------------|) show newline
() show newline
() show newline
(Handshake Implementation) show newline
(------------------------) show newline
() show newline
() show newline
(    \(define \(connection-handshake connection\)) show newline
(      "Perform mutual authentication handshake") show newline
(      ;; Send ClientHello) show newline
(      \(send-message connection) show newline
(        \(client-hello) show newline
(          \(version ,protocol-version\)) show newline
(          \(capabilities ,\(local-capabilities\)\)\)\)) show newline
(      ;; Receive ServerHello) show newline
(      \(let \(\(server-hello \(receive-message connection\)\)\)) show newline
(        \(verify-protocol-version \(server-hello-version server-hello\)\)) show newline
(        ;; Verify server certificate) show newline
(        \(let \(\(server-cert \(server-hello-certificate server-hello\)\)\)) show newline
(          \(unless \(verify-certificate server-cert\)) show newline
(            \(error "Server certificate invalid"\)\)) show newline
(          ;; Generate session key using X25519) show newline
(          \(let* \(\(ephemeral-keypair \(x25519-keypair\)\)) show newline
(                 \(shared-secret \(x25519-shared \(keypair-secret ephemeral-keypair\)) show newline
(                                              \(cert-public-key server-cert\)\)\)\)) show newline
(            ;; Send ClientAuth) show newline
(            \(send-message connection) show newline
(              \(client-auth) show newline
(                \(certificate ,\(local-certificate\)\)) show newline
(                \(ephemeral-public ,\(keypair-public ephemeral-keypair\)\)) show newline
(                \(signature ,\(sign-challenge server-hello\)\)\)\)) show newline
(            ;; Receive ServerAuth) show newline
(            \(let \(\(server-auth \(receive-message connection\)\)\)) show newline
(              \(unless \(verify-server-signature server-auth server-cert\)) show newline
(                \(error "Server authentication failed"\)\)) show newline
(              ;; Derive session keys) show newline
(              \(derive-session-keys connection shared-secret\)\)\)\)\)\)) show newline
() show newline
() show newline
(Session Encryption) show newline
(------------------) show newline
() show newline
() show newline
(    \(define \(derive-session-keys connection shared-secret\)) show newline
(      "Derive symmetric keys for session") show newline
(      \(let* \(\(key-material \(hkdf shared-secret) show newline
(                                 info: "library-session") show newline
(                                 length: 64\)\)) show newline
(             \(client-key \(subbytes key-material 0 32\)\)) show newline
(             \(server-key \(subbytes key-material 32 64\)\)\)) show newline
(        \(set-connection-keys! connection) show newline
(          \(if \(connection-is-client? connection\)) show newline
(              \(keys send: client-key receive: server-key\)) show newline
(              \(keys send: server-key receive: client-key\)\)\)\)\)) show newline
(    \(define \(encrypt-message connection message\)) show newline
(      "Encrypt message with session key") show newline
(      \(let \(\(nonce \(connection-next-nonce connection\)\)\)) show newline
(        \(chacha20-poly1305-encrypt) show newline
(          \(connection-send-key connection\)) show newline
(          nonce) show newline
(          \(serialize message\)\)\)\)) show newline
(    \(define \(decrypt-message connection ciphertext\)) show newline
(      "Decrypt message with session key") show newline
(      \(let \(\(nonce \(connection-next-nonce connection\)\)\)) show newline
(        \(deserialize) show newline
(          \(chacha20-poly1305-decrypt) show newline
(            \(connection-receive-key connection\)) show newline
(            nonce) show newline
(            ciphertext\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(MESSAGE LAYER) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Message Format) show newline
(--------------) show newline
() show newline
() show newline
(    \(library-message) show newline
(      \(version 1\)) show newline
(      \(type request|response|stream|error\)) show newline
(      \(id <message-id>\)) show newline
(      \(in-reply-to <message-id>|#f\)) show newline
(      \(capability <spki-cert>|#f\)) show newline
(      \(body <payload>\)\)) show newline
() show newline
() show newline
(Request Types) show newline
(-------------) show newline
() show newline
() show newline
(    \(define request-types) show newline
(      '\(;; Object operations) show newline
(        \(get-object hash\)) show newline
(        \(put-object hash data\)) show newline
(        \(has-object hash\)) show newline
(        ;; Bulk operations) show newline
(        \(get-objects hashes\)) show newline
(        \(get-tree root-hash\)) show newline
(        \(sync-objects bloom-filter\)) show newline
(        ;; Soup queries) show newline
(        \(soup-query query\)) show newline
(        \(soup-subscribe query\)) show newline
(        ;; Vault operations) show newline
(        \(get-refs pattern\)) show newline
(        \(get-head\)) show newline
(        \(get-releases\)) show newline
(        ;; Discovery) show newline
(        \(get-capabilities\)) show newline
(        \(get-peers\)\)\)) show newline
() show newline
() show newline
(Request/Response) show newline
(----------------) show newline
() show newline
() show newline
(    \(define \(vault-request connection request #!key capability timeout\)) show newline
(      "Send request, wait for response") show newline
(      \(let \(\(message-id \(generate-message-id\)\)\)) show newline
(        ;; Send request) show newline
(        \(send-message connection) show newline
(          \(library-message) show newline
(            version: 1) show newline
(            type: 'request) show newline
(            id: message-id) show newline
(            capability: capability) show newline
(            body: request\)\)) show newline
(        ;; Wait for response) show newline
(        \(let \(\(response \(receive-response connection message-id timeout\)\)\)) show newline
(          \(if \(eq? \(message-type response\) 'error\)) show newline
(              \(error \(message-body response\)\)) show newline
(              \(message-body response\)\)\)\)\)) show newline
() show newline
() show newline
(Streaming) show newline
(---------) show newline
() show newline
(For large transfers:) show newline
() show newline
() show newline
(    \(define \(stream-object connection hash\)) show newline
(      "Stream large object in chunks") show newline
(      \(let \(\(stream \(open-stream connection 'object-transfer\)\)\)) show newline
(        ;; Send chunks) show newline
(        \(let \(\(data \(cas-get hash\)\)\)) show newline
(          \(let loop \(\(offset 0\)\)) show newline
(            \(when \(< offset \(blob-length data\)\)) show newline
(              \(let \(\(chunk \(blob-copy data offset chunk-size\)\)\)) show newline
(                \(stream-send stream chunk\)) show newline
(                \(loop \(+ offset chunk-size\)\)\)\)\)) show newline
(          ;; End stream) show newline
(          \(stream-close stream\)\)\)\)) show newline
(    \(define \(receive-stream connection stream callback\)) show newline
(      "Receive streamed data") show newline
(      \(let loop \(\(chunks '\(\)\)\)) show newline
(        \(let \(\(chunk \(stream-receive stream\)\)\)) show newline
(          \(if \(stream-ended? stream\)) show newline
(              \(apply bytes-append \(reverse chunks\)\)) show newline
(              \(begin) show newline
(                \(callback chunk\)) show newline
(                \(loop \(cons chunk chunks\)\)\)\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(OBJECT EXCHANGE) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Get Object) show newline
(----------) show newline
() show newline
() show newline
(    ;; Request) show newline
(    \(get-object) show newline
(      \(hash "sha256:abc123..."\)\)) show newline
(    ;; Response \(small object\)) show newline
(    \(object-data) show newline
(      \(hash "sha256:abc123..."\)) show newline
(      \(size 1024\)) show newline
(      \(data #${...}\)\)) show newline
(    ;; Response \(large object - streaming\)) show newline
(    \(object-stream) show newline
(      \(hash "sha256:abc123..."\)) show newline
(      \(size 10485760\)) show newline
(      \(stream-id 42\)\)) show newline
() show newline
() show newline
(Put Object) show newline
(----------) show newline
() show newline
() show newline
(    ;; Request) show newline
(    \(put-object) show newline
(      \(hash "sha256:abc123..."\)) show newline
(      \(data #${...}\)\)) show newline
(    ;; Response) show newline
(    \(put-result) show newline
(      \(hash "sha256:abc123..."\)) show newline
(      \(status stored|duplicate|rejected\)) show newline
(      \(reason #f|"quota exceeded"\)\)) show newline
() show newline
() show newline
(Batch Operations) show newline
(----------------) show newline
() show newline
() show newline
(    ;; Request multiple objects) show newline
(    \(get-objects) show newline
(      \(hashes \("sha256:aaa..." "sha256:bbb..." "sha256:ccc..."\)\)\)) show newline
(    ;; Response) show newline
(    \(objects-batch) show newline
(      \(objects) show newline
(        \(\(hash "sha256:aaa..." data #${...}\)) show newline
(         \(hash "sha256:bbb..." data #${...}\)) show newline
(         \(hash "sha256:ccc..." status: missing\)\)\)\)) show newline
() show newline
() show newline
(Tree Transfer) show newline
(-------------) show newline
() show newline
(Efficient Merkle tree sync:) show newline
() show newline
() show newline
(    ;; Request tree) show newline
(    \(get-tree) show newline
(      \(root "sha256:root..."\)) show newline
(      \(depth 3\)  ; How deep to fetch) show newline
(      \(exclude \("sha256:already-have..."\)\)\)) show newline
(    ;; Response) show newline
(    \(tree-data) show newline
(      \(root "sha256:root..."\)) show newline
(      \(objects) show newline
(        \(\(hash "sha256:root..." data #${...}\)) show newline
(         \(hash "sha256:child1..." data #${...}\)) show newline
(         \(hash "sha256:child2..." data #${...}\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(SYNCHRONIZATION) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Bloom Filter Exchange) show newline
(---------------------) show newline
() show newline
(Efficient "what do you have?" queries:) show newline
() show newline
() show newline
(    ;; Step 1: Exchange bloom filters) show newline
(    \(define \(sync-init local-vault remote-connection\)) show newline
(      \(let \(\(local-bloom \(vault-bloom-filter local-vault\)\)\)) show newline
(        ;; Send our bloom filter) show newline
(        \(send-message remote-connection) show newline
(          `\(sync-bloom) show newline
(            \(filter ,local-bloom\)) show newline
(            \(population ,\(bloom-population local-bloom\)\)\)\)) show newline
(        ;; Receive their bloom filter) show newline
(        \(let \(\(remote-bloom \(receive-bloom remote-connection\)\)\)) show newline
(          ;; Compute what they might want) show newline
(          \(let \(\(to-send \(filter \(lambda \(hash\)) show newline
(                                   \(not \(bloom-contains? remote-bloom hash\)\)\)) show newline
(                                 \(vault-all-hashes local-vault\)\)\)\)) show newline
(            to-send\)\)\)\)) show newline
(    ;; Step 2: Exchange missing objects) show newline
(    \(define \(sync-exchange to-send to-receive connection\)) show newline
(      \(parallel) show newline
(        ;; Send what they need) show newline
(        \(for-each \(lambda \(hash\)) show newline
(                    \(stream-object connection hash\)\)) show newline
(                  to-send\)) show newline
(        ;; Receive what we need) show newline
(        \(for-each \(lambda \(hash\)) show newline
(                    \(receive-object connection hash\)\)) show newline
(                  to-receive\)\)\)) show newline
() show newline
() show newline
(Incremental Sync) show newline
(----------------) show newline
() show newline
() show newline
(    \(define \(incremental-sync local-vault remote-connection since\)) show newline
(      "Sync changes since timestamp or commit") show newline
(      ;; Get remote changes) show newline
(      \(let \(\(remote-changes \(vault-request remote-connection) show newline
(                              `\(changes-since ,since\)\)\)\)) show newline
(        ;; Get local changes) show newline
(        \(let \(\(local-changes \(vault-changes-since local-vault since\)\)\)) show newline
(          ;; Bidirectional merge) show newline
(          \(sync-merge local-vault remote-connection) show newline
(                      local-changes remote-changes\)\)\)\)) show newline
() show newline
() show newline
(Conflict Resolution) show newline
(-------------------) show newline
() show newline
() show newline
(    \(define \(sync-merge local-vault remote changes-local changes-remote\)) show newline
(      "Merge changes with conflict resolution") show newline
(      \(for-each) show newline
(        \(lambda \(hash\)) show newline
(          \(cond) show newline
(            ;; Only local has it - push) show newline
(            \(\(and \(member hash changes-local\)) show newline
(                  \(not \(member hash changes-remote\)\)\)) show newline
(             \(push-object local-vault remote hash\)\)) show newline
(            ;; Only remote has it - pull) show newline
(            \(\(and \(member hash changes-remote\)) show newline
(                  \(not \(member hash changes-local\)\)\)) show newline
(             \(pull-object local-vault remote hash\)\)) show newline
(            ;; Both have it - verify same) show newline
(            \(\(and \(member hash changes-local\)) show newline
(                  \(member hash changes-remote\)\)) show newline
(             ;; Content-addressed, so same hash = same content) show newline
(             #t\)\)\)) show newline
(        \(union changes-local changes-remote\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(DISCOVERY) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Peer Discovery) show newline
(--------------) show newline
() show newline
() show newline
(    ;; Well-known peers \(bootstrap\)) show newline
(    \(define \(discover-bootstrap\)) show newline
(      \(map parse-address) show newline
(           \(read-file "/etc/library/bootstrap-peers"\)\)\)) show newline
(    ;; mDNS/DNS-SD for local network) show newline
(    \(define \(discover-local\)) show newline
(      \(mdns-browse "library.tcp.local"\)\)) show newline
(    ;; DHT for global discovery) show newline
(    \(define \(discover-dht target-hash\)) show newline
(      \(dht-find-providers target-hash\)\)) show newline
(    ;; Peer exchange) show newline
(    \(define \(discover-pex connection\)) show newline
(      \(vault-request connection '\(get-peers\)\)\)) show newline
() show newline
() show newline
(Capability Advertisement) show newline
(------------------------) show newline
() show newline
() show newline
(    ;; Query vault capabilities) show newline
(    \(get-capabilities\)) show newline
(    ;; Response) show newline
(    \(vault-capabilities) show newline
(      \(protocol-version 1\)) show newline
(      \(features \(bloom-sync tree-transfer streaming soup-query\)\)) show newline
(      \(max-object-size 104857600\)  ; 100MB) show newline
(      \(storage-available 10737418240\)  ; 10GB) show newline
(      \(public-key "ed25519:abc..."\)) show newline
(      \(services) show newline
(        \(\(soup-query rate-limit: 100/minute\)) show newline
(         \(object-transfer rate-limit: 10MB/second\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(SOUP QUERIES) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Remote Query) show newline
(------------) show newline
() show newline
() show newline
(    ;; Query remote soup) show newline
(    \(soup-query) show newline
(      \(type certificate\)) show newline
(      \(issuer "vault-admin"\)) show newline
(      \(limit 100\)\)) show newline
(    ;; Response) show newline
(    \(soup-results) show newline
(      \(count 47\)) show newline
(      \(objects) show newline
(        \(\(name "cert/alice" type certificate ...\)) show newline
(         \(name "cert/bob" type certificate ...\)) show newline
(         ...\)\)\)) show newline
() show newline
() show newline
(Subscription) show newline
(------------) show newline
() show newline
() show newline
(    ;; Subscribe to soup changes) show newline
(    \(soup-subscribe) show newline
(      \(query \(type release\)\)) show newline
(      \(callback-url "library://my-vault/callbacks/releases"\)\)) show newline
(    ;; Subscription confirmation) show newline
(    \(subscription) show newline
(      \(id "sub-123"\)) show newline
(      \(query \(type release\)\)) show newline
(      \(expires "2026-02-07T00:00:00Z"\)\)) show newline
(    ;; Push notification \(when matching object appears\)) show newline
(    \(soup-notification) show newline
(      \(subscription-id "sub-123"\)) show newline
(      \(object \(name "release/1.2.0" type release ...\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(ERROR HANDLING) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Error Types) show newline
(-----------) show newline
() show newline
() show newline
(    \(define error-types) show newline
(      '\(\(not-found "Object not found"\)) show newline
(        \(unauthorized "Capability required"\)) show newline
(        \(forbidden "Capability insufficient"\)) show newline
(        \(quota-exceeded "Storage quota exceeded"\)) show newline
(        \(rate-limited "Too many requests"\)) show newline
(        \(timeout "Operation timed out"\)) show newline
(        \(invalid-request "Malformed request"\)) show newline
(        \(internal-error "Server error"\)) show newline
(        \(unavailable "Service temporarily unavailable"\)\)\)) show newline
() show newline
() show newline
(Error Response) show newline
(--------------) show newline
() show newline
() show newline
(    \(library-message) show newline
(      \(type error\)) show newline
(      \(id <message-id>\)) show newline
(      \(in-reply-to <request-id>\)) show newline
(      \(body) show newline
(        \(error-response) show newline
(          \(code not-found\)) show newline
(          \(message "Object sha256:abc... not found"\)) show newline
(          \(retry-after #f\)\)\)\)) show newline
() show newline
() show newline
(Retry Logic) show newline
(-----------) show newline
() show newline
() show newline
(    \(define \(vault-request-with-retry connection request #!key max-retries\)) show newline
(      "Request with exponential backoff retry") show newline
(      \(let loop \(\(attempt 0\) \(delay 1000\)\)) show newline
(        \(let \(\(result \(vault-request connection request\)\)\)) show newline
(          \(if \(and \(error-response? result\)) show newline
(                   \(retryable-error? result\)) show newline
(                   \(< attempt max-retries\)\)) show newline
(              \(begin) show newline
(                \(sleep delay\)) show newline
(                \(loop \(+ attempt 1\) \(* delay 2\)\)\)) show newline
(              result\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(SECURITY CONSIDERATIONS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Capability Verification) show newline
(-----------------------) show newline
() show newline
() show newline
(    \(define \(verify-request-capability request connection\)) show newline
(      "Verify request has sufficient capability") show newline
(      \(let \(\(required-cap \(request->capability request\)\)) show newline
(            \(presented-cap \(message-capability request\)\)\)) show newline
(        \(unless presented-cap) show newline
(          \(error 'unauthorized "Capability required"\)\)) show newline
(        \(unless \(valid-certificate? presented-cap\)) show newline
(          \(error 'unauthorized "Invalid capability certificate"\)\)) show newline
(        \(unless \(capability-grants? presented-cap required-cap\)) show newline
(          \(error 'forbidden "Insufficient capability"\)\)) show newline
(        ;; Verify capability chain back to trusted root) show newline
(        \(unless \(verify-capability-chain presented-cap\)) show newline
(          \(error 'forbidden "Capability chain invalid"\)\)\)\)) show newline
() show newline
() show newline
(Denial of Service Protection) show newline
(----------------------------) show newline
() show newline
() show newline
(    \(define \(rate-limit connection request-type\)) show newline
(      "Apply rate limiting") show newline
(      \(let \(\(limit \(get-rate-limit request-type\)\)) show newline
(            \(current \(connection-request-count connection request-type\)\)\)) show newline
(        \(when \(> current limit\)) show newline
(          \(error 'rate-limited) show newline
(                 \(format "Rate limit exceeded: ~a/~a" current limit\)\)\)\)\)) show newline
(    \(define \(size-limit request\)) show newline
(      "Enforce size limits") show newline
(      \(when \(> \(request-size request\) max-request-size\)) show newline
(        \(error 'invalid-request "Request too large"\)\)\)) show newline
() show newline
() show newline
(Replay Prevention) show newline
(-----------------) show newline
() show newline
() show newline
(    \(define \(verify-nonce connection message\)) show newline
(      "Prevent replay attacks") show newline
(      \(let \(\(nonce \(message-nonce message\)\)\)) show newline
(        \(when \(nonce-seen? connection nonce\)) show newline
(          \(error 'invalid-request "Replay detected"\)\)) show newline
(        \(record-nonce connection nonce\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(IMPLEMENTATION NOTES) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Wire Format) show newline
(-----------) show newline
() show newline
(Messages serialized as canonical S-expressions:) show newline
() show newline
() show newline
(    \(define \(serialize-message message\)) show newline
(      "Canonical S-expression serialization") show newline
(      \(canonical-sexp->bytes message\)\)) show newline
(    \(define \(deserialize-message bytes\)) show newline
(      "Parse S-expression") show newline
(      \(bytes->canonical-sexp bytes\)\)) show newline
() show newline
() show newline
(Compression) show newline
(-----------) show newline
() show newline
(Optional compression for large payloads:) show newline
() show newline
() show newline
(    \(define \(maybe-compress data\)) show newline
(      \(if \(> \(blob-length data\) compression-threshold\)) show newline
(          \(values \(zstd-compress data\) 'zstd\)) show newline
(          \(values data 'none\)\)\)) show newline
() show newline
() show newline
(Connection Pooling) show newline
(------------------) show newline
() show newline
() show newline
(    \(define connection-pool \(make-hash-table\)\)) show newline
(    \(define \(get-connection address\)) show newline
(      "Get pooled connection or create new") show newline
(      \(or \(hash-table-ref connection-pool address #f\)) show newline
(          \(let \(\(conn \(connect-vault address\)\)\)) show newline
(            \(hash-table-set! connection-pool address conn\)) show newline
(            conn\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(REFERENCES) show newline
(------------------------------------------------------------------------) show newline
() show newline
(1. [QUIC Protocol - RFC 9000]\(https://tools.ietf.org/html/rfc9000\) 2.) show newline
([Noise Protocol Framework]\(http://noiseprotocol.org/\) 3. [Memo-020:) show newline
(Content-Addressed Storage]\(memo-020-content-addressed-storage.html\) 4.) show newline
([Memo-021: Capability Delegation]\(memo-021-capability-delegation.html\)) show newline
(5. [IPFS Bitswap Protocol]\(https://docs.ipfs.tech/concepts/bitswap/\) 6.) show newline
([libp2p Specifications]\(https://github.com/libp2p/specs\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(CHANGELOG) show newline
(------------------------------------------------------------------------) show newline
() show newline
(  * 2026-01-07) show newline
(  * Initial draft) show newline
() show newline
(------------------------------------------------------------------------) show newline

showpage
%%Trailer
%%Pages: pagenum
%%EOF
