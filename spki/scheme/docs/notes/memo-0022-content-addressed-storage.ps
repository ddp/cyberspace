%!PS-Adobe-3.0
%%Title: memo-0022-content-addressed-storage
%%Creator: Library of Cyberspace Memo Pipeline
%%Pages: (atend)
%%EndComments

/Courier findfont 10 scalefont setfont
/margin 72 def
/pagewidth 612 def
/pageheight 792 def
/leading 12 def
/topmargin pageheight margin sub def
/bottommargin margin def
/linewidth pagewidth margin 2 mul sub def
/ypos topmargin def
/pagenum 1 def

/newline {
  /ypos ypos leading sub def
  ypos bottommargin lt {
    showpage
    /pagenum pagenum 1 add def
    /ypos topmargin def
  } if
  margin ypos moveto
} def

margin topmargin moveto
(Memo 0022: Content-Addressed Storage) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
() show newline
(------------------------------------------------------------------------) show newline
(ABSTRACT) show newline
(------------------------------------------------------------------------) show newline
() show newline
(This Memo specifies content-addressed storage \(CAS\) for the Library of) show newline
(Cyberspace: a storage model where data is addressed by its cryptographic) show newline
(hash rather than by location. Content addressing provides immutability) show newline
(guarantees, automatic deduplication, and tamper-evident storage.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(MOTIVATION) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Traditional storage systems use location-based addressing:) show newline
() show newline
(  * DECtape: Physical position on magnetic tape) show newline
(  * Filesystems: Path names \(/home/ddp/file.txt\)) show newline
(  * Databases: Row IDs, primary keys) show newline
(  * URLs: Server + path \(https://example.com/doc.ps\)) show newline
() show newline
(Location-based addressing has fundamental problems:) show newline
() show newline
(  * Mutability - Same address can point to different content over time) show newline
(  * Link rot - Addresses become invalid when content moves) show newline
(  * Duplication - Identical content stored multiple times) show newline
(  * No verification - Address doesn't prove content integrity) show newline
() show newline
(These problems are architectural, not operational; no amount of careful) show newline
(administration can fix a model where names and content are decoupled.) show newline
() show newline
(Content-addressed storage inverts this:) show newline
() show newline
() show newline
(    Location-based:  address → content \(many-to-one, mutable\)) show newline
(    Content-based:   content → address \(one-to-one, immutable\)) show newline
() show newline
(The address IS the content's cryptographic fingerprint. If the content) show newline
(changes, the address changes. If two files have the same address, they) show newline
(are byte-for-byte identical.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(CONTENT ADDRESSING MODEL) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Hash as Address) show newline
(---------------) show newline
() show newline
() show newline
(    ;; Content determines address) show newline
(    \(define \(content-address data\)) show newline
(      \(sha256 data\)\)) show newline
(    ;; Store by hash) show newline
(    \(define \(cas-store data\)) show newline
(      \(let \(\(hash \(content-address data\)\)\)) show newline
(        \(write-blob \(hash->path hash\) data\)) show newline
(        hash\)\)) show newline
(    ;; Retrieve by hash) show newline
(    \(define \(cas-retrieve hash\)) show newline
(      \(let \(\(data \(read-blob \(hash->path hash\)\)\)\)) show newline
(        \(if \(equal? hash \(content-address data\)\)) show newline
(            data) show newline
(            \(error "Content tampered"\)\)\)\)) show newline
() show newline
() show newline
(Properties) show newline
(----------) show newline
() show newline
() show newline
(  Property               Location-Based   Content-Addressed   ) show newline
(  Address stability      Unstable         Permanent           ) show newline
(  Content verification   External         Intrinsic           ) show newline
(  Deduplication          Manual           Automatic           ) show newline
(  Mutability             Mutable          Immutable           ) show newline
(  Link rot               Common           Impossible          ) show newline
() show newline
() show newline
(Hash Function Requirements) show newline
(--------------------------) show newline
() show newline
(The hash function MUST be:) show newline
() show newline
(  * Collision-resistant - Computationally infeasible to find two inputs with same hash) show newline
(  * Preimage-resistant - Cannot derive content from hash) show newline
(  * Deterministic - Same content always produces same hash) show newline
(  * Fast - Practical for large objects) show newline
() show newline
(The hash function is the foundation of trust; weakening any property) show newline
(undermines the entire addressing model.) show newline
() show newline
(Specified hash: SHA-256 \(32 bytes, 64 hex characters\)) show newline
() show newline
() show newline
(    ;; Example content address) show newline
(    "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855") show newline
(    ;; This is the SHA-256 of the empty string) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(STORAGE ARCHITECTURE) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Object Store) show newline
(------------) show newline
() show newline
() show newline
(    .cas/) show newline
(    ├── objects/) show newline
(    │   ├── e3/) show newline
(    │   │   └── b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855) show newline
(    │   ├── a7/) show newline
(    │   │   └── ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a) show newline
(    │   └── ...) show newline
(    ├── refs/) show newline
(    │   ├── HEAD) show newline
(    │   └── tags/) show newline
(    └── index) show newline
() show newline
(Sharding: First two hex characters of hash form directory name \(256) show newline
(buckets\).) show newline
() show newline
() show newline
(Object Types) show newline
(------------) show newline
() show newline
() show newline
(    ;; Blob - raw data) show newline
(    \(cas-blob) show newline
(      \(hash "sha256:..."\)) show newline
(      \(size 1024\)) show newline
(      \(data #${...}\)\)) show newline
(    ;; Tree - directory structure) show newline
(    \(cas-tree) show newline
(      \(hash "sha256:..."\)) show newline
(      \(entries) show newline
(        \(\("README.md" blob "sha256:abc..."\)) show newline
(         \("src" tree "sha256:def..."\)) show newline
(         \("lib" tree "sha256:ghi..."\)\)\)\)) show newline
(    ;; Commit - snapshot with metadata) show newline
(    \(cas-commit) show newline
(      \(hash "sha256:..."\)) show newline
(      \(tree "sha256:..."\)) show newline
(      \(parent "sha256:..." | #f\)) show newline
(      \(author "ddp@eludom.net"\)) show newline
(      \(timestamp 1767700000\)) show newline
(      \(message "Initial commit"\)\)) show newline
() show newline
() show newline
(Merkle Trees) show newline
(------------) show newline
() show newline
(Directories are trees of hashes. The root hash commits to all content:) show newline
() show newline
() show newline
(                        root: sha256:abc...) show newline
(                             /          \\) show newline
(                  src: sha256:def     lib: sha256:ghi) show newline
(                   /        \\              |) show newline
(            main.scm     test.scm      util.scm) show newline
(            sha256:111   sha256:222    sha256:333) show newline
() show newline
(Changing ANY file changes ALL parent hashes up to root.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(OPERATIONS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Store) show newline
(-----) show newline
() show newline
() show newline
(    \(define \(cas-put content\)) show newline
(      "Store content, return hash") show newline
(      \(let* \(\(hash \(sha256 content\)\)) show newline
(             \(path \(hash->path hash\)\)\)) show newline
(        \(unless \(file-exists? path\)) show newline
(          \(write-blob path content\)\)) show newline
(        hash\)\)) show newline
() show newline
(Deduplication: If hash already exists, storage is a no-op.) show newline
() show newline
() show newline
(Retrieve) show newline
(--------) show newline
() show newline
() show newline
(    \(define \(cas-get hash\)) show newline
(      "Retrieve content by hash, verify integrity") show newline
(      \(let* \(\(path \(hash->path hash\)\)) show newline
(             \(content \(read-blob path\)\)\)) show newline
(        \(unless \(equal? hash \(sha256 content\)\)) show newline
(          \(error "Content integrity failure" hash\)\)) show newline
(        content\)\)) show newline
() show newline
(Self-verifying: Every retrieval confirms integrity.) show newline
() show newline
() show newline
(Exists) show newline
(------) show newline
() show newline
() show newline
(    \(define \(cas-exists? hash\)) show newline
(      "Check if content exists") show newline
(      \(file-exists? \(hash->path hash\)\)\)) show newline
() show newline
() show newline
(Delete) show newline
(------) show newline
() show newline
() show newline
(    \(define \(cas-gc roots\)) show newline
(      "Garbage collect unreachable objects") show newline
(      \(let \(\(reachable \(trace-reachable roots\)\)\)) show newline
(        \(for-each) show newline
(          \(lambda \(hash\)) show newline
(            \(unless \(set-member? reachable hash\)) show newline
(              \(delete-file \(hash->path hash\)\)\)\)) show newline
(          \(all-objects\)\)\)\)) show newline
() show newline
(Note: Deletion requires garbage collection from known roots.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(NAMING LAYER) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Content addresses are not human-friendly. A naming layer maps names to) show newline
(hashes:) show newline
() show newline
() show newline
(References) show newline
(----------) show newline
() show newline
() show newline
(    ;; Mutable reference to immutable content) show newline
(    \(define \(ref-set name hash\)) show newline
(      \(write-file \(ref-path name\) hash\)\)) show newline
(    \(define \(ref-get name\)) show newline
(      \(read-file \(ref-path name\)\)\)) show newline
(    ;; Example) show newline
(    \(ref-set "HEAD" "sha256:abc123..."\)) show newline
(    \(ref-get "HEAD"\) ; => "sha256:abc123...") show newline
() show newline
() show newline
(Tags) show newline
(----) show newline
() show newline
() show newline
(    ;; Immutable named reference) show newline
(    \(define \(tag-create name hash #!key message signature\)) show newline
(      \(let \(\(tag-content) show newline
(             `\(tag) show newline
(               \(name ,name\)) show newline
(               \(object ,hash\)) show newline
(               \(message ,message\)) show newline
(               \(signature ,signature\)\)\)\)) show newline
(        \(cas-put \(serialize tag-content\)\)\)\)) show newline
() show newline
() show newline
(Directory Entries) show newline
(-----------------) show newline
() show newline
() show newline
(    ;; Human name -> content hash) show newline
(    \(define library-index) show newline
(      '\(\("Memo-000" . "sha256:e3b0c44..."\)) show newline
(        \("Memo-001" . "sha256:a7ffc6f..."\)) show newline
(        \("Memo-002" . "sha256:b94d27b..."\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(THE SOUP: OBJECT DIRECTORY) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Content-addressed storage provides retrieval by hash, but discovery) show newline
(requires an object directory. The Soup \(inspired by NewtonOS\) provides a) show newline
(unified view of all objects with rich metadata.) show newline
() show newline
() show newline
(Philosophy) show newline
(----------) show newline
() show newline
() show newline
(    "The soup is infinite." - Objects swim in a queryable sea of metadata.) show newline
() show newline
(The Soup inverts the traditional filesystem model:) show newline
() show newline
(  * Filesystem: Navigate hierarchy to find objects) show newline
(  * Soup: Query attributes to discover objects) show newline
() show newline
() show newline
(Object Enumeration) show newline
(------------------) show newline
() show newline
() show newline
(    \(define \(soup\)) show newline
(      "List all objects in the vault with metadata") show newline
(      \(append) show newline
(        \(soup-releases\)      ; Signed releases) show newline
(        \(soup-archives\)      ; Sealed archives) show newline
(        \(soup-keys\)          ; Cryptographic keys) show newline
(        \(soup-audit-entries\) ; Audit trail) show newline
(        \(soup-commits\)\)\)     ; Recent commits) show newline
() show newline
() show newline
(Rich Metadata) show newline
(-------------) show newline
() show newline
(Every object carries crypto metadata - the ciphers, hashes, and keys) show newline
(involved:) show newline
() show newline
() show newline
(    ;; Archive object) show newline
(    \(soup-object) show newline
(      \(name "1.0.0"\)) show newline
(      \(type archive\)) show newline
(      \(size "1.2MB"\)) show newline
(      \(crypto \(zstd sha256 "fe378a78..."\)\)\)) show newline
(    ;; Key object) show newline
(    \(soup-object) show newline
(      \(name "vault-signing"\)) show newline
(      \(type key\)) show newline
(      \(size "64B"\)) show newline
(      \(crypto \(ed25519/256 public sign) show newline
(               "sha256:a1b2c3d4..."    ; fingerprint) show newline
(               "id:ddp@eludom.net"     ; identity) show newline
(               "2026-01-07"\)\)\)         ; creation date) show newline
(    ;; Release object) show newline
(    \(soup-object) show newline
(      \(name "0.1.0"\)) show newline
(      \(type release\)) show newline
(      \(size "313B"\)) show newline
(      \(crypto \(ed25519 sha512 "abc123..."\)\)\)) show newline
() show newline
() show newline
(Querying the Soup) show newline
(-----------------) show newline
() show newline
() show newline
(    ;; Find all signed objects) show newline
(    \(soup-query type: 'release\)) show newline
(    ;; Find objects using specific algorithm) show newline
(    \(soup-query crypto: 'ed25519\)) show newline
(    ;; Find objects by size range) show newline
(    \(soup-query min-size: 1000 max-size: 100000\)) show newline
(    ;; Find objects by content hash prefix) show newline
(    \(soup-query hash-prefix: "fe378"\)) show newline
() show newline
() show newline
(Display Format) show newline
(--------------) show newline
() show newline
(The soup displays as a compact, human-readable listing:) show newline
() show newline
() show newline
(    $ seal-soup) show newline
(    vault-signing, 64B, ed25519/256, public, sign, sha256:a1b2c3d4...) show newline
(    0.1.0, 313B, signed, ed25519, sha512) show newline
(    1.0.0, 1.2MB, zstd, sha256, fe378a78...) show newline
(    audit/1, sealed, 2026-01-07T10:30:00Z) show newline
() show newline
() show newline
(Soup as Index) show newline
(-------------) show newline
() show newline
(The Soup can be serialized as a content-addressed index:) show newline
() show newline
() show newline
(    \(define \(soup-snapshot\)) show newline
(      "Create content-addressed snapshot of current soup") show newline
(      \(let* \(\(entries \(soup\)\)) show newline
(             \(serialized \(serialize entries\)\)) show newline
(             \(hash \(cas-put serialized\)\)\)) show newline
(        \(ref-set "soup/HEAD" hash\)) show newline
(        hash\)\)) show newline
() show newline
(This enables: - Time travel: Load historical soup snapshots -) show newline
(Replication: Sync soup indexes between vaults - Verification: Prove soup) show newline
(state at a point in time) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(INTEGRATION WITH LIBRARY OF CYBERSPACE) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Vault Integration) show newline
(-----------------) show newline
() show newline
(The Vault \(Memo-006\) uses content addressing internally via Git:) show newline
() show newline
() show newline
(    ;; Git objects ARE content-addressed) show newline
(    \(define \(git-hash-object content\)) show newline
(      \(sha1 \(string-append "blob " \(number->string \(blob-length content\)\) "\\x00" content\)\)\)) show newline
() show newline
(CAS extends this with SHA-256 and Library-specific semantics.) show newline
() show newline
() show newline
(Archive Storage) show newline
(---------------) show newline
() show newline
(Sealed archives \(Memo-018\) can be stored by content address:) show newline
() show newline
() show newline
(    \(define \(archive-to-cas archive-path\)) show newline
(      \(let* \(\(content \(read-blob archive-path\)\)) show newline
(             \(hash \(cas-put content\)\)\)) show newline
(        \(ref-set \(string-append "archives/" \(archive-version archive-path\)\) hash\)) show newline
(        hash\)\)) show newline
() show newline
() show newline
(Replication) show newline
(-----------) show newline
() show newline
(Content addressing enables efficient replication \(Memo-0002\):) show newline
() show newline
() show newline
(    ;; Only transfer objects receiver doesn't have) show newline
(    \(define \(replicate-to remote root-hash\)) show newline
(      \(for-each) show newline
(        \(lambda \(hash\)) show newline
(          \(unless \(remote-has? remote hash\)) show newline
(            \(remote-put remote hash \(cas-get hash\)\)\)\)) show newline
(        \(trace-reachable root-hash\)\)\)) show newline
() show newline
() show newline
(SPKI Integration) show newline
(----------------) show newline
() show newline
(Content hashes can be Simple Public Key Infrastructure \(SPKI\)) show newline
(authorization subjects \(Memo-004\):) show newline
() show newline
() show newline
(    ;; Grant permission to specific content) show newline
(    \(spki-cert) show newline
(      \(issuer publisher-key\)) show newline
(      \(subject \(hash sha256 "abc123..."\)\)) show newline
(      \(permission read\)) show newline
(      \(validity \(not-after "2027-01-01"\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(CHUNKING FOR LARGE OBJECTS) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Large files are split into chunks for:) show newline
() show newline
(  * Deduplication at sub-file granularity) show newline
(  * Parallel transfer) show newline
(  * Incremental updates) show newline
() show newline
(Chunking trades storage metadata overhead for dramatic improvements in) show newline
(network efficiency and deduplication across related files.) show newline
() show newline
() show newline
(Fixed-Size Chunking) show newline
(-------------------) show newline
() show newline
() show newline
(    \(define chunk-size \(* 64 1024\)\)  ; 64KB) show newline
(    \(define \(chunk-fixed data\)) show newline
(      \(let loop \(\(offset 0\) \(chunks '\(\)\)\)) show newline
(        \(if \(>= offset \(blob-length data\)\)) show newline
(            \(reverse chunks\)) show newline
(            \(loop \(+ offset chunk-size\)) show newline
(                  \(cons \(blob-copy data offset \(min chunk-size \(- \(blob-length data\) offset\)\)\)) show newline
(                        chunks\)\)\)\)\)) show newline
() show newline
() show newline
(Content-Defined Chunking \(Rabin fingerprinting\)) show newline
(-----------------------------------------------) show newline
() show newline
() show newline
(    ;; Chunk boundaries determined by content) show newline
(    ;; Survives insertions/deletions better than fixed-size) show newline
(    \(define \(chunk-rabin data\)) show newline
(      \(let \(\(window-size 48\)) show newline
(            \(min-chunk 2048\)) show newline
(            \(max-chunk 65536\)) show newline
(            \(mask #x0fff\)\)  ; Average 4KB chunks) show newline
(        ...\)\)) show newline
() show newline
() show newline
(Chunk Tree) show newline
(----------) show newline
() show newline
() show newline
(    \(cas-chunked) show newline
(      \(hash "sha256:..."\)      ; Root hash) show newline
(      \(size 10485760\)          ; 10MB original) show newline
(      \(chunks) show newline
(        \("sha256:aaa..." 65536\)) show newline
(        \("sha256:bbb..." 65536\)) show newline
(        \("sha256:ccc..." 32768\)) show newline
(        ...\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(INTROSPECTION) show newline
(------------------------------------------------------------------------) show newline
() show newline
(The Library is fully introspective: it stores, addresses, and reasons) show newline
(about itself.) show newline
() show newline
() show newline
(Self-Hosting) show newline
(------------) show newline
() show newline
(The system contains its own description:) show newline
() show newline
() show newline
(    ;; The RFCs are in the CAS) show newline
(    \(cas-get \(ref-get "rfc/020"\)\)  ; => This document) show newline
(    ;; The code is in the CAS) show newline
(    \(cas-get \(ref-get "src/vault.scm"\)\)  ; => Implementation) show newline
(    ;; The schema is in the CAS) show newline
(    \(cas-get \(ref-get "schema/soup-object"\)\)  ; => Soup object definition) show newline
() show newline
() show newline
(Meta-Objects) show newline
(------------) show newline
() show newline
(Objects that describe objects:) show newline
() show newline
() show newline
(    ;; Schema for soup objects \(itself a soup object\)) show newline
(    \(soup-object) show newline
(      \(name "schema/soup-object"\)) show newline
(      \(type schema\)) show newline
(      \(size "412B"\)) show newline
(      \(crypto \(sha256 "def456..."\)\)) show newline
(      \(describes soup-object\)\)) show newline
(    ;; The soup can enumerate itself) show newline
(    \(soup-query type: 'schema\)  ; => All schemas including this one) show newline
() show newline
() show newline
(Reflexive Queries) show newline
(-----------------) show newline
() show newline
(The soup answers questions about itself:) show newline
() show newline
() show newline
(    ;; What types exist?) show newline
(    \(soup-types\)  ; => \(archive release key audit commit schema ...\)) show newline
(    ;; What crypto algorithms are in use?) show newline
(    \(soup-algorithms\)  ; => \(sha256 ed25519 zstd age ...\)) show newline
(    ;; What is the total size of the vault?) show newline
(    \(soup-total-size\)  ; => 47.3MB) show newline
(    ;; How much deduplication?) show newline
(    \(soup-dedup-ratio\)  ; => 0.73 \(27% space saved\)) show newline
() show newline
() show newline
(Provenance) show newline
(----------) show newline
() show newline
(Every object knows its origin:) show newline
() show newline
() show newline
(    \(soup-object) show newline
(      \(name "memo-020.ps"\)) show newline
(      \(type blob\)) show newline
(      \(size "89KB"\)) show newline
(      \(crypto \(sha256 "abc123..."\)\)) show newline
(      \(provenance) show newline
(        \(created-by "ddp@eludom.net"\)) show newline
(        \(created-at 1767700000\)) show newline
(        \(derived-from "sha256:fff888..."\)) show newline
(        \(tool "dvips"\)\)\)) show newline
() show newline
(Provenance chains are themselves content-addressed:) show newline
() show newline
() show newline
(    ;; Trace full history) show newline
(    \(define \(provenance-chain hash\)) show newline
(      \(let \(\(obj \(soup-get hash\)\)\)) show newline
(        \(if \(soup-object-derived-from obj\)) show newline
(            \(cons obj \(provenance-chain \(soup-object-derived-from obj\)\)\)) show newline
(            \(list obj\)\)\)\)) show newline
() show newline
() show newline
(Audit of Audits) show newline
(---------------) show newline
() show newline
(The audit trail audits itself:) show newline
() show newline
() show newline
(    ;; Audit entry for an audit entry) show newline
(    \(audit-entry) show newline
(      \(id 42\)) show newline
(      \(actor vault-key\)) show newline
(      \(action \(audit-append 41\)\)  ; Recorded adding entry 41) show newline
(      \(timestamp 1767700100\)\)) show newline
(    ;; The audit trail is in the soup) show newline
(    \(soup-query type: 'audit\)  ; => All audit entries as soup objects) show newline
() show newline
() show newline
(Bootstrapping) show newline
(-------------) show newline
() show newline
(The system can describe how to build itself:) show newline
() show newline
() show newline
(    ;; Bootstrap manifest - everything needed to reconstruct) show newline
(    \(bootstrap-manifest) show newline
(      \(hash "sha256:bootstrap..."\)) show newline
(      \(contents) show newline
(        \(\("src/" tree "sha256:src..."\)) show newline
(         \("rfcs/" tree "sha256:rfcs..."\)) show newline
(         \("keys/" tree "sha256:keys..."\)) show newline
(         \("schema/" tree "sha256:schema..."\)\)\)) show newline
(      \(build-instructions) show newline
(        "Load src/boot.scm, call \(bootstrap\)"\)\)) show newline
(    ;; Verify bootstrap integrity) show newline
(    \(define \(verify-bootstrap\)) show newline
(      \(let \(\(manifest \(cas-get \(ref-get "bootstrap"\)\)\)\)) show newline
(        \(for-each verify-tree \(manifest-contents manifest\)\)\)\)) show newline
() show newline
() show newline
(The Library Contains Itself) show newline
(---------------------------) show newline
() show newline
() show newline
(    ╭─────────────────────────────────────────╮) show newline
(    │            LIBRARY OF CYBERSPACE        │) show newline
(    │  ╭───────────────────────────────────╮  │) show newline
(    │  │     Content-Addressed Storage     │  │) show newline
(    │  │  ╭─────────────────────────────╮  │  │) show newline
(    │  │  │    Memo-020 \(this document\)  │  │  │) show newline
(    │  │  │    describing CAS           │  │  │) show newline
(    │  │  │    stored in CAS            │  │  │) show newline
(    │  │  ╰─────────────────────────────╯  │  │) show newline
(    │  ╰───────────────────────────────────╯  │) show newline
(    ╰─────────────────────────────────────────╯) show newline
() show newline
(Homoiconic storage: the description is the thing.) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(TOMBSTONES) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Objects are never truly deleted - they are marked with tombstones.) show newline
() show newline
() show newline
(Soft Deletion) show newline
(-------------) show newline
() show newline
() show newline
(    \(define \(cas-tombstone hash #!key reason actor\)) show newline
(      "Mark object as deleted without removing it") show newline
(      \(let \(\(tombstone) show newline
(             \(tombstone) show newline
(               \(object ,hash\)) show newline
(               \(deleted-at ,\(current-seconds\)\)) show newline
(               \(deleted-by ,actor\)) show newline
(               \(reason ,reason\)\)\)\)) show newline
(        \(audit-append action: \(tombstone ,hash\) motivation: reason\)) show newline
(        \(cas-put \(serialize tombstone\)\)\)\)) show newline
() show newline
() show newline
(Tombstone Properties) show newline
(--------------------) show newline
() show newline
() show newline
(    \(soup-object) show newline
(      \(name "sha256:deadbeef..."\)) show newline
(      \(type tombstone\)) show newline
(      \(size "0B"\)  ; Logical size is zero) show newline
(      \(status deleted\)) show newline
(      \(reason "Superseded by sha256:newversion..."\)) show newline
(      \(recoverable #t\)\)) show newline
() show newline
() show newline
(Recovery) show newline
(--------) show newline
() show newline
() show newline
(    \(define \(cas-resurrect hash\)) show newline
(      "Remove tombstone, restore object visibility") show newline
(      \(let \(\(tombstone \(find-tombstone hash\)\)\)) show newline
(        \(when tombstone) show newline
(          \(audit-append action: `\(resurrect ,hash\)\)) show newline
(          \(cas-delete \(tombstone-hash tombstone\)\)\)\)\)) show newline
() show newline
() show newline
(Garbage Collection with Tombstones) show newline
(----------------------------------) show newline
() show newline
() show newline
(    \(define \(cas-gc roots #!key preserve-tombstones\)) show newline
(      "GC respects tombstones by default") show newline
(      \(let \(\(reachable \(trace-reachable roots\)\)) show newline
(            \(tombstoned \(all-tombstoned-hashes\)\)\)) show newline
(        \(for-each) show newline
(          \(lambda \(hash\)) show newline
(            \(unless \(or \(set-member? reachable hash\)) show newline
(                        \(and preserve-tombstones) show newline
(                             \(set-member? tombstoned hash\)\)\)) show newline
(              \(delete-file \(hash->path hash\)\)\)\)) show newline
(          \(all-objects\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(PINNING) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Pinned objects are protected from garbage collection.) show newline
() show newline
() show newline
(Pin Operations) show newline
(--------------) show newline
() show newline
() show newline
(    \(define \(cas-pin hash #!key recursive reason\)) show newline
(      "Pin object \(and optionally its references\)") show newline
(      \(let \(\(pin `\(pin) show newline
(                   \(object ,hash\)) show newline
(                   \(pinned-at ,\(current-seconds\)\)) show newline
(                   \(recursive ,recursive\)) show newline
(                   \(reason ,reason\)\)\)\)) show newline
(        \(write-file \(pin-path hash\) \(serialize pin\)\)) show newline
(        \(when recursive) show newline
(          \(for-each \(lambda \(ref\) \(cas-pin ref recursive: #t\)\)) show newline
(                    \(object-references hash\)\)\)\)\)) show newline
(    \(define \(cas-unpin hash\)) show newline
(      "Remove pin, allow GC") show newline
(      \(delete-file \(pin-path hash\)\)\)) show newline
(    \(define \(cas-pinned? hash\)) show newline
(      "Check if object is pinned") show newline
(      \(file-exists? \(pin-path hash\)\)\)) show newline
() show newline
() show newline
(Pin Manifest) show newline
(------------) show newline
() show newline
() show newline
(    ;; All pins as soup objects) show newline
(    \(soup-query type: 'pin\)) show newline
(    ;; Pin statistics) show newline
(    \(soup-pin-count\)      ; => 142 objects pinned) show newline
(    \(soup-pinned-size\)    ; => 23.4MB) show newline
() show newline
() show newline
(Root Pins) show newline
(---------) show newline
() show newline
(Certain objects are implicitly pinned:) show newline
() show newline
() show newline
(    \(define implicit-roots) show newline
(      '\("HEAD"           ; Current commit) show newline
(        "refs/tags/"    ; All tags) show newline
(        "bootstrap"      ; System bootstrap) show newline
(        "schema/"\)\)     ; All schemas) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(BLOOM FILTERS) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Compact probabilistic set membership for efficient replication.) show newline
() show newline
() show newline
(Multi-Level Existence Check) show newline
(---------------------------) show newline
() show newline
(For the distributed soup, existence checks dominate replication) show newline
(overhead. A tiered approach minimizes latency:) show newline
() show newline
() show newline
(    ┌─────────────────────────────────────────────────────────┐) show newline
(    │ L1: Hot Set Cache \(1000 items, O\(1\), microseconds\)     │) show newline
(    ├─────────────────────────────────────────────────────────┤) show newline
(    │ L2: Blocked Bloom Filter \(100K items, O\(k\), cache-     │) show newline
(    │     friendly memory layout\)                             │) show newline
(    ├─────────────────────────────────────────────────────────┤) show newline
(    │ L3: Quotient Filter \(1M items, supports deletion\)      │) show newline
(    ├─────────────────────────────────────────────────────────┤) show newline
(    │ L4: Disk/Network \(authoritative, milliseconds\)         │) show newline
(    └─────────────────────────────────────────────────────────┘) show newline
() show newline
() show newline
(Blocked Bloom Filters) show newline
(---------------------) show newline
() show newline
(Cache-line aligned blocks for 10x faster lookups:) show newline
() show newline
() show newline
(    ;; Blocked Bloom: each block fits in CPU cache line \(64 bytes = 512 bits\)) show newline
(    \(define block-bits 512\)) show newline
(    \(define cache-line 64\)) show newline
(    \(define \(make-blocked-bloom capacity error-rate\)) show newline
(      "Cache-friendly blocked Bloom filter") show newline
(      \(let \(\(bits \(bloom-optimal-bits capacity error-rate\)\)) show newline
(             \(num-blocks \(ceiling \(/ bits block-bits\)\)\)) show newline
(             \(hashes \(bloom-optimal-hashes capacity bits\)\)\)) show newline
(        \(blocked-bloom) show newline
(          \(blocks \(make-vector num-blocks \(make-u8vector cache-line 0\)\)\)) show newline
(          \(hash-count hashes\)) show newline
(          \(block-selector \(lambda \(hash\) \(modulo \(hash-part-1 hash\) num-blocks\)\)\)\)\)\)) show newline
(    \(define \(blocked-bloom-add! filter hash\)) show newline
(      "Add to block - all bits within same cache line") show newline
(      \(let \(\(block-idx \(block-select filter hash\)\)) show newline
(             \(block \(vector-ref \(bloom-blocks filter\) block-idx\)\)\)) show newline
(        \(for-each) show newline
(          \(lambda \(i\)) show newline
(            \(let \(\(bit-idx \(modulo \(bloom-hash filter hash i\) block-bits\)\)\)) show newline
(              \(u8vector-bit-set! block bit-idx 1\)\)\)) show newline
(          \(iota \(bloom-hash-count filter\)\)\)\)\)) show newline
(    \(define \(blocked-bloom-contains? filter hash\)) show newline
(      "Check within single cache line - no cache misses") show newline
(      \(let \(\(block-idx \(block-select filter hash\)\)) show newline
(             \(block \(vector-ref \(bloom-blocks filter\) block-idx\)\)\)) show newline
(        \(every) show newline
(          \(lambda \(i\)) show newline
(            \(let \(\(bit-idx \(modulo \(bloom-hash filter hash i\) block-bits*\)\)\)) show newline
(              \(= 1 \(u8vector-bit-ref block bit-idx\)\)\)\)) show newline
(          \(iota \(bloom-hash-count filter\)\)\)\)\)) show newline
() show newline
() show newline
(Counting Bloom Filters) show newline
(----------------------) show newline
() show newline
(For the soup, objects can be tombstoned \(soft-deleted\). Counting filters) show newline
(support removal:) show newline
() show newline
() show newline
(    ;; Counting Bloom: 4-bit counters instead of single bits) show newline
(    \(define \(make-counting-bloom capacity error-rate\)) show newline
(      "Counting Bloom filter supporting deletions") show newline
(      \(let* \(\(slots \(bloom-optimal-bits capacity error-rate\)\)) show newline
(             \(nibbles \(make-u8vector \(ceiling \(/ slots 2\)\) 0\)\)) show newline
(             \(hashes \(bloom-optimal-hashes capacity slots\)\)\)) show newline
(        \(counting-bloom nibbles hashes slots\)\)\)) show newline
(    \(define \(counting-bloom-add! filter hash\)) show newline
(      "Increment counters \(saturate at 15\)") show newline
(      \(for-each) show newline
(        \(lambda \(i\)) show newline
(          \(let \(\(slot \(bloom-slot filter hash i\)\)\)) show newline
(            \(nibble-increment! \(bloom-nibbles filter\) slot\)\)\)) show newline
(        \(iota \(bloom-hash-count filter\)\)\)\)) show newline
(    \(define \(counting-bloom-remove! filter hash\)) show newline
(      "Decrement counters \(only if present\)") show newline
(      \(when \(counting-bloom-contains? filter hash\)) show newline
(        \(for-each) show newline
(          \(lambda \(i\)) show newline
(            \(let \(\(slot \(bloom-slot filter hash i\)\)\)) show newline
(              \(nibble-decrement! \(bloom-nibbles filter\) slot\)\)\)) show newline
(          \(iota \(bloom-hash-count filter\)\)\)\)\)) show newline
(    ;; Integration with tombstones) show newline
(    \(define \(cas-tombstone/bloom hash reason\)) show newline
(      "Tombstone with Bloom filter update") show newline
(      \(counting-bloom-remove! existence-filter hash\)) show newline
(      \(cas-tombstone hash reason: reason\)\)) show newline
() show newline
() show newline
(Quotient Filters) show newline
(----------------) show newline
() show newline
(Better space efficiency than Bloom, supports deletion, and can be) show newline
(resized:) show newline
() show newline
() show newline
(    ;; Quotient filter: fingerprint stored in quotient/remainder form) show newline
(    \(define \(make-quotient-filter capacity\)) show newline
(      "Space-efficient filter with deletion support") show newline
(      \(let* \(\(slots \(next-power-of-2 capacity\)\)) show newline
(             \(q-bits \(integer-log2 slots\)\)) show newline
(             \(r-bits \(- 64 q-bits\)\)\)  ; 64-bit fingerprints) show newline
(        \(quotient-filter) show newline
(          \(table \(make-vector slots #f\)\)) show newline
(          \(q-bits q-bits\)) show newline
(          \(r-bits r-bits\)) show newline
(          \(count 0\)\)\)\)) show newline
(    \(define \(qf-fingerprint hash q-bits r-bits\)) show newline
(      "Split hash into quotient and remainder") show newline
(      \(let \(\(fp \(hash->u64 hash\)\)\)) show newline
(        \(values \(arithmetic-shift fp \(- r-bits\)\)  ; quotient) show newline
(                \(bitwise-and fp \(- \(arithmetic-shift 1 r-bits\) 1\)\)\)\)\)  ; remainder) show newline
(    \(define \(qf-insert! qf hash\)) show newline
(      "Insert with Robin Hood linear probing") show newline
(      \(let-values \(\(\(q r\) \(qf-fingerprint hash \(qf-q-bits qf\) \(qf-r-bits qf\)\)\)\)) show newline
(        \(qf-insert-slot! qf q r\)\)\)) show newline
(    \(define \(qf-delete! qf hash\)) show newline
(      "Delete fingerprint") show newline
(      \(let-values \(\(\(q r\) \(qf-fingerprint hash \(qf-q-bits qf\) \(qf-r-bits qf\)\)\)\)) show newline
(        \(qf-delete-slot! qf q r\)\)\)) show newline
() show newline
() show newline
(Replication Protocol) show newline
(--------------------) show newline
() show newline
() show newline
(    ;; Sender: "Here's what I have" \(compressed Bloom\)) show newline
(    \(define \(bloom-inventory\)) show newline
(      \(let \(\(filter \(make-blocked-bloom 100000 0.01\)\)\)) show newline
(        \(for-each \(lambda \(hash\) \(blocked-bloom-add! filter hash\)\)) show newline
(                  \(all-object-hashes\)\)) show newline
(        filter\)\)) show newline
(    ;; Receiver: "Send me what I'm missing") show newline
(    \(define \(bloom-diff local-filter remote-filter\)) show newline
(      \(filter \(lambda \(hash\)) show newline
(                \(and \(blocked-bloom-contains? remote-filter hash\)) show newline
(                     \(not \(cas-exists? hash\)\)\)\)) show newline
(              \(all-object-hashes\)\)\)) show newline
(    ;; Exchange is O\(bloom-size\) not O\(object-count\)) show newline
(    ;; Blocked Bloom: 10-100x faster due to cache locality) show newline
() show newline
() show newline
(Hierarchical Existence Check) show newline
(----------------------------) show newline
() show newline
() show newline
(    \(define \(cas-exists?/fast hash\)) show newline
(      "Tiered existence check - fast path for common case") show newline
(      \(or \(lru-get hot-set hash\)              ; L1: O\(1\) in-memory) show newline
(          \(and \(blocked-bloom-contains? l2-bloom hash\)  ; L2: O\(k\) cache-friendly) show newline
(               \(or \(qf-contains? l3-qf hash\)  ; L3: O\(1\) amortized) show newline
(                   \(cas-exists? hash\)\)\)\)\)      ; L4: authoritative) show newline
(    ;; 99% of checks hit L1/L2, avoiding disk/network entirely) show newline
() show newline
() show newline
(Soup Integration) show newline
(----------------) show newline
() show newline
() show newline
(    ;; Bloom filter itself is a soup object) show newline
(    \(soup-object) show newline
(      \(name "bloom/2026-01-09"\)) show newline
(      \(type bloom-filter\)) show newline
(      \(variant blocked\)           ; blocked, counting, or quotient) show newline
(      \(size "12KB"\)) show newline
(      \(crypto \(sha256 "bloom-hash..."\)\)) show newline
(      \(capacity 100000\)) show newline
(      \(error-rate 0.01\)) show newline
(      \(population 47230\)) show newline
(      \(load-factor 0.47\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(CONTENT TYPES) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Typed objects with schema validation.) show newline
() show newline
() show newline
(Type Registry) show newline
(-------------) show newline
() show newline
() show newline
(    \(define content-types) show newline
(      '\(\(blob        . "application/octet-stream"\)) show newline
(        \(text        . "text/plain"\)) show newline
(        \(markdown    . "text/markdown"\)) show newline
(        \(scheme      . "text/x-scheme"\)) show newline
(        \(sexp        . "application/x-sexp"\)) show newline
(        \(json        . "application/json"\)) show newline
(        \(pdf         . "application/pdf"\)) show newline
(        \(archive     . "application/x-sealed-archive"\)) show newline
(        \(key         . "application/x-spki-key"\)) show newline
(        \(certificate . "application/x-spki-cert"\)\)\)) show newline
() show newline
() show newline
(Typed Storage) show newline
(-------------) show newline
() show newline
() show newline
(    \(define \(cas-put/typed content type #!key schema\)) show newline
(      "Store with type metadata") show newline
(      \(let* \(\(hash \(sha256 content\)\)) show newline
(             \(meta `\(typed-object) show newline
(                     \(hash ,hash\)) show newline
(                     \(type ,type\)) show newline
(                     \(size ,\(blob-length content\)\)) show newline
(                     \(schema ,schema\)\)\)\)) show newline
(        \(cas-put content\)) show newline
(        \(cas-put \(serialize meta\)\)) show newline
(        hash\)\)) show newline
() show newline
() show newline
(Schema Validation) show newline
(-----------------) show newline
() show newline
() show newline
(    \(define \(cas-validate hash\)) show newline
(      "Validate object against its schema") show newline
(      \(let* \(\(meta \(cas-get-meta hash\)\)) show newline
(             \(schema-hash \(typed-object-schema meta\)\)) show newline
(             \(schema \(cas-get schema-hash\)\)) show newline
(             \(content \(cas-get hash\)\)\)) show newline
(        \(schema-validate schema content\)\)\)) show newline
(    ;; Schema is itself content-addressed) show newline
(    \(soup-object) show newline
(      \(name "schema/soup-object"\)) show newline
(      \(type schema\)) show newline
(      \(validates soup-object\)) show newline
(      \(crypto \(sha256 "schema-hash..."\)\)\)) show newline
() show newline
() show newline
(MIME Detection) show newline
(--------------) show newline
() show newline
() show newline
(    \(define \(cas-detect-type content\)) show newline
(      "Detect content type from magic bytes") show newline
(      \(cond) show newline
(        \(\(pdf-magic? content\) 'pdf\)) show newline
(        \(\(gzip-magic? content\) 'archive\)) show newline
(        \(\(utf8-text? content\)) show newline
(         \(cond) show newline
(           \(\(sexp-syntax? content\) 'sexp\)) show newline
(           \(\(markdown-syntax? content\) 'markdown\)) show newline
(           \(else 'text\)\)\)) show newline
(        \(else 'blob\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(OBJECT CAPABILITIES) show newline
(------------------------------------------------------------------------) show newline
() show newline
(Content addresses as capabilities: if you know the hash, you can) show newline
(retrieve it.) show newline
() show newline
() show newline
(Hash as Capability) show newline
(------------------) show newline
() show newline
() show newline
(    ;; Knowledge of hash grants read access) show newline
(    \(define \(cas-get-if-known hash\)) show newline
(      "Capability-based retrieval") show newline
(      \(if \(valid-hash? hash\)) show newline
(          \(cas-get hash\)) show newline
(          \(error "Invalid capability"\)\)\)) show newline
(    ;; Hashes are unguessable \(256-bit entropy\)) show newline
(    ;; Sharing a hash = sharing read access) show newline
() show newline
() show newline
(Capability Attenuation) show newline
(----------------------) show newline
() show newline
() show newline
(    ;; SPKI certificate granting access to specific content) show newline
(    \(spki-cert) show newline
(      \(issuer vault-key\)) show newline
(      \(subject reader-key\)) show newline
(      \(permission \(read \(hash sha256 "specific-content..."\)\)\)) show newline
(      \(validity \(not-after "2027-01-01"\)\)\)) show newline
(    ;; Grant access to a subtree) show newline
(    \(spki-cert) show newline
(      \(issuer vault-key\)) show newline
(      \(subject reader-key\)) show newline
(      \(permission \(read \(tree sha256 "subtree-root..."\)\)\)) show newline
(      \(propagate #t\)\)  ; Access to all referenced objects) show newline
() show newline
() show newline
(Sealed Capabilities) show newline
(-------------------) show newline
() show newline
() show newline
(    ;; Encrypted capability - only holder of key can use) show newline
(    \(define \(seal-capability hash recipient-key\)) show newline
(      \(let \(\(cap `\(capability) show newline
(                   \(object ,hash\)) show newline
(                   \(granted-at ,\(current-seconds\)\)\)\)\)) show newline
(        \(age-encrypt \(serialize cap\) recipient-key\)\)\)) show newline
(    ;; Recipient decrypts to obtain hash) show newline
(    \(define \(unseal-capability sealed-cap identity\)) show newline
(      \(let \(\(cap \(deserialize \(age-decrypt sealed-cap identity\)\)\)\)) show newline
(        \(capability-object cap\)\)\)) show newline
() show newline
() show newline
(Capability Revocation) show newline
(---------------------) show newline
() show newline
() show newline
(    ;; Revocation via tombstone) show newline
(    \(define \(revoke-capability hash\)) show newline
(      \(cas-tombstone hash reason: "Capability revoked"\)\)) show newline
(    ;; Or via SPKI CRL) show newline
(    \(spki-crl) show newline
(      \(issuer vault-key\)) show newline
(      \(revoked) show newline
(        \(\(hash sha256 "revoked-content..."\)) show newline
(         \(reason "Superseded"\)) show newline
(         \(revoked-at 1767700000\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(HASH MIGRATION) show newline
(------------------------------------------------------------------------) show newline
() show newline
(When cryptographic algorithms weaken, the system must migrate.) show newline
() show newline
() show newline
(Multihash) show newline
(---------) show newline
() show newline
() show newline
(    ;; Self-describing hash format) show newline
(    \(define \(multihash algo data\)) show newline
(      \(let \(\(hash \(case algo) show newline
(                    \(\(sha256\) \(sha256 data\)\)) show newline
(                    \(\(sha384\) \(sha384 data\)\)) show newline
(                    \(\(sha512\) \(sha512 data\)\)) show newline
(                    \(\(blake3\) \(blake3 data\)\)\)\)\)) show newline
(        \(list algo \(blob-length hash\) hash\)\)\)) show newline
(    ;; Parse multihash) show newline
(    \(define \(multihash-algorithm mh\) \(car mh\)\)) show newline
(    \(define \(multihash-digest mh\) \(caddr mh\)\)) show newline
() show newline
() show newline
(Dual-Hash Period) show newline
(----------------) show newline
() show newline
() show newline
(    ;; During migration, store under both hashes) show newline
(    \(define \(cas-put/migrate content old-algo new-algo\)) show newline
(      \(let \(\(old-hash \(hash-with old-algo content\)\)) show newline
(            \(new-hash \(hash-with new-algo content\)\)\)) show newline
(        \(cas-put-raw old-hash content\)) show newline
(        \(cas-put-raw new-hash content\)) show newline
(        ;; Link old to new) show newline
(        \(ref-set \(string-append "migrate/" old-hash\) new-hash\)) show newline
(        new-hash\)\)) show newline
(    ;; Lookup follows migration links) show newline
(    \(define \(cas-get/migrate hash\)) show newline
(      \(let \(\(migrated \(ref-get \(string-append "migrate/" hash\)\)\)\)) show newline
(        \(cas-get \(or migrated hash\)\)\)\)) show newline
() show newline
() show newline
(Migration Manifest) show newline
(------------------) show newline
() show newline
() show newline
(    \(migration-manifest) show newline
(      \(from-algorithm sha256\)) show newline
(      \(to-algorithm sha384\)) show newline
(      \(started-at 1767700000\)) show newline
(      \(status in-progress\)) show newline
(      \(migrated 4723\)) show newline
(      \(remaining 1892\)) show newline
(      \(mappings) show newline
(        \(\("sha256:abc..." . "sha384:def..."\)) show newline
(         \("sha256:123..." . "sha384:456..."\)) show newline
(         ...\)\)\)) show newline
() show newline
() show newline
(Verification During Migration) show newline
(-----------------------------) show newline
() show newline
() show newline
(    \(define \(verify-migration hash\)) show newline
(      "Verify object under both old and new hash") show newline
(      \(let* \(\(content \(cas-get hash\)\)) show newline
(             \(old-hash \(sha256 content\)\)) show newline
(             \(new-hash \(sha384 content\)\)\)) show newline
(        \(and \(or \(equal? hash old-hash\)) show newline
(                 \(equal? hash new-hash\)\)) show newline
(             \(equal? \(ref-get \(string-append "migrate/" old-hash\)\)) show newline
(                     new-hash\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(COMPARISON WITH RELATED SYSTEMS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(  System        Hash                Chunking       Naming          ) show newline
(  Git           SHA-1               Pack files     refs/branches   ) show newline
(  IPFS          SHA-256/multihash   Rabin          IPNS, DNSLink   ) show newline
(  Perkeep       SHA-224             Rolling hash   Permanodes      ) show newline
(  Library CAS   SHA-256             Configurable   Vault refs      ) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(SECURITY CONSIDERATIONS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Hash Collision Attacks) show newline
(----------------------) show newline
() show newline
(SHA-256 provides 128-bit collision resistance. No practical attacks) show newline
(known.) show newline
() show newline
(If SHA-256 is ever broken:) show newline
() show newline
() show newline
(    ;; Multihash for algorithm agility) show newline
(    \(define \(multihash algo data\)) show newline
(      \(case algo) show newline
(        \(\(sha256\) \(cons 'sha256 \(sha256 data\)\)\)) show newline
(        \(\(sha384\) \(cons 'sha384 \(sha384 data\)\)\)) show newline
(        \(\(blake3\) \(cons 'blake3 \(blake3 data\)\)\)\)\)) show newline
() show newline
() show newline
(Length Extension Attacks) show newline
(------------------------) show newline
() show newline
(SHA-256 is vulnerable to length extension. For authentication, use HMAC:) show newline
() show newline
() show newline
(    \(define \(cas-mac key hash\)) show newline
(      \(hmac-sha256 key hash\)\)) show newline
() show newline
() show newline
(Timing Attacks) show newline
(--------------) show newline
() show newline
(Hash comparison MUST be constant-time:) show newline
() show newline
() show newline
(    \(define \(hash-equal? a b\)) show newline
(      \(let \(\(result 0\)\)) show newline
(        \(do \(\(i 0 \(+ i 1\)\)\)) show newline
(            \(\(= i 32\) \(zero? result\)\)) show newline
(          \(set! result \(bitwise-ior result) show newline
(                        \(bitwise-xor \(blob-ref a i\) \(blob-ref b i\)\)\)\)\)\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(PERFORMANCE CONSIDERATIONS) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Caching) show newline
(-------) show newline
() show newline
() show newline
(    ;; LRU cache for hot objects) show newline
(    \(define cas-cache \(make-lru-cache 1000\)\)) show newline
(    \(define \(cas-get/cached hash\)) show newline
(      \(or \(lru-get cas-cache hash\)) show newline
(          \(let \(\(content \(cas-get hash\)\)\)) show newline
(            \(lru-put! cas-cache hash content\)) show newline
(            content\)\)\)) show newline
() show newline
() show newline
(Parallel Hashing) show newline
(----------------) show newline
() show newline
(Large files benefit from parallel hashing of chunks.) show newline
() show newline
() show newline
(SSD Optimization) show newline
(----------------) show newline
() show newline
(Random access pattern. Use write-ahead log for durability:) show newline
() show newline
() show newline
(    \(define \(cas-put/durable content\)) show newline
(      \(let \(\(hash \(sha256 content\)\)\)) show newline
(        \(wal-append hash content\)) show newline
(        \(write-blob \(hash->path hash\) content\)) show newline
(        \(wal-commit hash\)) show newline
(        hash\)\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(IMPLEMENTATION NOTES) show newline
(------------------------------------------------------------------------) show newline
() show newline
() show newline
(Dependencies) show newline
(------------) show newline
() show newline
() show newline
(  Component   Library                ) show newline
(  SHA-256     message-digest, sha2   ) show newline
(  Blob I/O    CHICKEN I/O            ) show newline
(  Chunking    Custom                 ) show newline
() show newline
() show newline
(Error Handling) show newline
(--------------) show newline
() show newline
() show newline
(    \(define-condition-type &cas-error &error) show newline
(      cas-error?) show newline
(      \(hash cas-error-hash\)\)) show newline
(    \(define-condition-type &cas-not-found &cas-error) show newline
(      cas-not-found?\)) show newline
(    \(define-condition-type &cas-corrupt &cas-error) show newline
(      cas-corrupt?\)) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(REFERENCES) show newline
(------------------------------------------------------------------------) show newline
() show newline
(  * Merkle, R. \(1987\), "A Digital Signature Based on a Conventional Encryption Function") show newline
(  * Git Internals - Git Objects) show newline
(  * IPFS Content Addressing) show newline
(  * Putze, Sanders, Singler \(2007\), "Cache-, Hash-, and Space-Efficient Bloom Filters") show newline
(  * Bender et al. \(2012\), "Don't Thrash: How to Cache Your Hash on Flash") show newline
(  * Memo-006: Vault System Architecture) show newline
(  * Memo-018: Sealed Archive Format) show newline
() show newline
() show newline
(------------------------------------------------------------------------) show newline
(CHANGELOG) show newline
(------------------------------------------------------------------------) show newline
() show newline
(  * 2026-01-09) show newline
(  * Advanced probabilistic data structures: blocked Bloom filters, counting Bloom filters, quotient filters, hierarchical existence checking - 2026-01-07) show newline
(  * Initial draft) show newline
() show newline
(------------------------------------------------------------------------) show newline

showpage
%%Trailer
%%Pages: pagenum
%%EOF
