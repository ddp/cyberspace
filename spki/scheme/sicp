#!/usr/bin/env csi -q -s
;;; sicp - SICP metrics for Cyberspace modules (standalone)

(import scheme (chicken base) (chicken io) (chicken string) (chicken format) (chicken file) srfi-13)

(define *modules*
  '("os" "crypto-ffi" "sexp" "capability" "mdns" "fips" "audit" "wordlist"
    "bloom" "catalog" "keyring" "portal" "cert" "enroll" "gossip" "security"
    "vault" "auto-enroll" "ui" "inspector"))

(define (analyze src)
  (if (not (file-exists? src))
      '(0 0)
      (with-input-from-file src
        (lambda ()
          (let loop ((loc 0) (lambdas 0))
            (let ((line (read-line)))
              (if (eof-object? line)
                  (list loc lambdas)
                  (let* ((trimmed (string-trim-both line))
                         (blank? (string-null? trimmed))
                         (comment? (and (> (string-length trimmed) 0)
                                        (char=? (string-ref trimmed 0) #\;))))
                    (loop (if (or blank? comment?) loc (+ loc 1))
                          (+ lambdas
                             (if (string-contains line "(define ") 1 0)
                             (if (string-contains line "(lambda ") 1 0)))))))))))

(printf "~%SICP Metrics - spki/scheme~%~%")
(let loop ((mods *modules*) (tloc 0) (tlam 0))
  (if (null? mods)
      (begin
        (printf "  ─────────────────────────────────~%")
        (printf "  Σ ~a LOC · ~a λ · ~a LOC/λ~%~%"
                tloc tlam (if (> tlam 0) (quotient tloc tlam) 0)))
      (let* ((m (car mods))
             (r (analyze (string-append m ".scm")))
             (loc (car r))
             (lam (cadr r)))
        (printf "  ~a: ~a LOC · ~a λ · ~a LOC/λ~%"
                (string-pad-right m 12) loc lam
                (if (> lam 0) (quotient loc lam) 0))
        (loop (cdr mods) (+ tloc loc) (+ tlam lam)))))
